/* empty css              */import{C as d,P as me,c as Ne,O as w,d as Qe,b as hn,a as lr,e as cr,f as va,g as ur,h as fr,i as Ue,j as ra,k as pr}from"./bsConstants-CsbWmK8i.js";const Ge=(()=>{/*!
* Copyright (c) 2021-2024 Momo Bassit.
* Licensed under the MIT License (MIT)
* https://github.com/mdbassit/Coloris
* Version: 0.24.0
* NPM: https://github.com/melloware/coloris-npm
*/return((a,e,t,n)=>{const i=e.createElement("canvas").getContext("2d"),s={r:0,g:0,b:0,h:0,s:0,v:0,a:1};let o,l,c,f,g,v,S,O,k,L,R,F,M,z,r,p,u={};const h={el:"[data-coloris]",parent:"body",theme:"default",themeMode:"light",rtl:!1,wrap:!0,margin:2,format:"hex",formatToggle:!1,swatches:[],swatchesOnly:!1,alpha:!0,forceAlpha:!1,focusInput:!0,selectInput:!1,inline:!1,defaultColor:"#000000",clearButton:!1,clearLabel:"Clear",closeButton:!1,closeLabel:"Close",onChange:()=>n,a11y:{open:"Open color picker",close:"Close color picker",clear:"Clear the selected color",marker:"Saturation: {s}. Brightness: {v}.",hueSlider:"Hue slider",alphaSlider:"Opacity slider",input:"Color value field",format:"Color format",swatch:"Color swatch",instruction:"Saturation and brightness selector. Use up, down, left and right arrow keys to select."}},T={};let y="",E={},I=!1;function C(N){if(typeof N=="object")for(const V in N)switch(V){case"el":x(N.el),N.wrap!==!1&&Q(N.el);break;case"parent":o=N.parent instanceof HTMLElement?N.parent:e.querySelector(N.parent),o&&(o.appendChild(l),h.parent=N.parent,o===e.body&&(o=n));break;case"themeMode":h.themeMode=N.themeMode,N.themeMode==="auto"&&a.matchMedia&&a.matchMedia("(prefers-color-scheme: dark)").matches&&(h.themeMode="dark");case"theme":N.theme&&(h.theme=N.theme),l.className="clr-picker clr-"+h.theme+" clr-"+h.themeMode,h.inline&&G();break;case"rtl":h.rtl=!!N.rtl,Array.from(e.getElementsByClassName("clr-field")).forEach(_=>_.classList.toggle("clr-rtl",h.rtl));break;case"margin":N.margin*=1,h.margin=isNaN(N.margin)?h.margin:N.margin;break;case"wrap":N.el&&N.wrap&&Q(N.el);break;case"formatToggle":h.formatToggle=!!N.formatToggle,ge("clr-format").style.display=h.formatToggle?"block":"none",h.formatToggle&&(h.format="auto");break;case"swatches":if(Array.isArray(N.swatches)){const _=ge("clr-swatches"),B=e.createElement("div");_.textContent="",N.swatches.forEach((Y,Z)=>{const K=e.createElement("button");K.setAttribute("type","button"),K.setAttribute("id","clr-swatch-"+Z),K.setAttribute("aria-labelledby","clr-swatch-label clr-swatch-"+Z),K.style.color=Y,K.textContent=Y,B.appendChild(K)}),N.swatches.length&&_.appendChild(B),h.swatches=N.swatches.slice()}break;case"swatchesOnly":h.swatchesOnly=!!N.swatchesOnly,l.setAttribute("data-minimal",h.swatchesOnly);break;case"alpha":h.alpha=!!N.alpha,l.setAttribute("data-alpha",h.alpha);break;case"inline":if(h.inline=!!N.inline,l.setAttribute("data-inline",h.inline),h.inline){const _=N.defaultColor||h.defaultColor;z=ae(_),G(),oe(_)}break;case"clearButton":typeof N.clearButton=="object"&&(N.clearButton.label&&(h.clearLabel=N.clearButton.label,S.innerHTML=h.clearLabel),N.clearButton=N.clearButton.show),h.clearButton=!!N.clearButton,S.style.display=h.clearButton?"block":"none";break;case"clearLabel":h.clearLabel=N.clearLabel,S.innerHTML=h.clearLabel;break;case"closeButton":h.closeButton=!!N.closeButton,h.closeButton?l.insertBefore(O,g):g.appendChild(O);break;case"closeLabel":h.closeLabel=N.closeLabel,O.innerHTML=h.closeLabel;break;case"a11y":const H=N.a11y;let q=!1;if(typeof H=="object")for(const _ in H)H[_]&&h.a11y[_]&&(h.a11y[_]=H[_],q=!0);if(q){const _=ge("clr-open-label"),B=ge("clr-swatch-label");_.innerHTML=h.a11y.open,B.innerHTML=h.a11y.swatch,O.setAttribute("aria-label",h.a11y.close),S.setAttribute("aria-label",h.a11y.clear),k.setAttribute("aria-label",h.a11y.hueSlider),R.setAttribute("aria-label",h.a11y.alphaSlider),v.setAttribute("aria-label",h.a11y.input),c.setAttribute("aria-label",h.a11y.instruction)}break;default:h[V]=N[V]}}function D(N,V){typeof N=="string"&&typeof V=="object"&&(T[N]=V,I=!0)}function A(N){delete T[N],Object.keys(T).length===0&&(I=!1,N===y&&b())}function P(N){if(I){const V=["el","wrap","rtl","inline","defaultColor","a11y"];for(let H in T){const q=T[H];if(N.matches(H)){y=H,E={},V.forEach(_=>delete q[_]);for(let _ in q)E[_]=Array.isArray(h[_])?h[_].slice():h[_];C(q);break}}}}function b(){Object.keys(E).length>0&&(C(E),y="",E={})}function x(N){N instanceof HTMLElement&&(N=[N]),Array.isArray(N)?N.forEach(V=>{de(V,"click",U),de(V,"input",J)}):(de(e,"click",N,U),de(e,"input",N,J))}function U(N){h.inline||(P(N.target),M=N.target,r=M.value,z=ae(r),l.classList.add("clr-open"),G(),oe(r),(h.focusInput||h.selectInput)&&(v.focus({preventScroll:!0}),v.setSelectionRange(M.selectionStart,M.selectionEnd)),h.selectInput&&v.select(),(p||h.swatchesOnly)&&st().shift().focus(),M.dispatchEvent(new Event("open",{bubbles:!0})))}function G(){if(!l||!M&&!h.inline)return;const N=o,V=a.scrollY,H=l.offsetWidth,q=l.offsetHeight,_={left:!1,top:!1};let B,Y,Z,K={x:0,y:0};if(N&&(B=a.getComputedStyle(N),Y=parseFloat(B.marginTop),Z=parseFloat(B.borderTopWidth),K=N.getBoundingClientRect(),K.y+=Z+V),!h.inline){const le=M.getBoundingClientRect();let he=le.x,Se=V+le.y+le.height+h.margin;N?(he-=K.x,Se-=K.y,he+H>N.clientWidth&&(he+=le.width-H,_.left=!0),Se+q>N.clientHeight-Y&&q+h.margin<=le.top-(K.y-V)&&(Se-=le.height+q+h.margin*2,_.top=!0),Se+=N.scrollTop):(he+H>e.documentElement.clientWidth&&(he+=le.width-H,_.left=!0),Se+q-V>e.documentElement.clientHeight&&q+h.margin<=le.top&&(Se=V+le.y-q-h.margin,_.top=!0)),l.classList.toggle("clr-left",_.left),l.classList.toggle("clr-top",_.top),l.style.left=he+"px",l.style.top=Se+"px",K.x+=l.offsetLeft,K.y+=l.offsetTop}u={width:c.offsetWidth,height:c.offsetHeight,x:c.offsetLeft+K.x,y:c.offsetTop+K.y}}function Q(N){N instanceof HTMLElement?W(N):Array.isArray(N)?N.forEach(W):e.querySelectorAll(N).forEach(W)}function W(N){const V=N.parentNode;if(!V.classList.contains("clr-field")){const H=e.createElement("div");let q="clr-field";(h.rtl||N.classList.contains("clr-rtl"))&&(q+=" clr-rtl"),H.innerHTML='<button type="button" aria-labelledby="clr-open-label"></button>',V.insertBefore(H,N),H.className=q,H.style.color=N.value,H.appendChild(N)}}function J(N){const V=N.target.parentNode;V.classList.contains("clr-field")&&(V.style.color=N.target.value)}function re(N){if(M&&!h.inline){const V=M;N&&(M=n,r!==V.value&&(V.value=r,V.dispatchEvent(new Event("input",{bubbles:!0})))),setTimeout(()=>{r!==V.value&&V.dispatchEvent(new Event("change",{bubbles:!0}))}),l.classList.remove("clr-open"),I&&b(),V.dispatchEvent(new Event("close",{bubbles:!0})),h.focusInput&&V.focus({preventScroll:!0}),M=n}}function oe(N){const V=Tt(N),H=bt(V);X(H.s,H.v),ye(V,H),k.value=H.h,l.style.color="hsl("+H.h+", 100%, 50%)",L.style.left=H.h/360*100+"%",f.style.left=u.width*H.s/100+"px",f.style.top=u.height-u.height*H.v/100+"px",R.value=H.a*100,F.style.left=H.a*100+"%"}function ae(N){const V=N.substring(0,3).toLowerCase();return V==="rgb"||V==="hsl"?V:"hex"}function ee(N){N=N!==n?N:v.value,M&&(M.value=N,M.dispatchEvent(new Event("input",{bubbles:!0}))),h.onChange&&h.onChange.call(a,N,M),e.dispatchEvent(new CustomEvent("coloris:pick",{detail:{color:N,currentEl:M}}))}function $(N,V){const H={h:k.value*1,s:N/u.width*100,v:100-V/u.height*100,a:R.value/100},q=ft(H);X(H.s,H.v),ye(q,H),ee()}function X(N,V){let H=h.a11y.marker;N=N.toFixed(1)*1,V=V.toFixed(1)*1,H=H.replace("{s}",N),H=H.replace("{v}",V),f.setAttribute("aria-label",H)}function j(N){return{pageX:N.changedTouches?N.changedTouches[0].pageX:N.pageX,pageY:N.changedTouches?N.changedTouches[0].pageY:N.pageY}}function se(N){const V=j(N);let H=V.pageX-u.x,q=V.pageY-u.y;o&&(q+=o.scrollTop),ce(H,q),N.preventDefault(),N.stopPropagation()}function ie(N,V){let H=f.style.left.replace("px","")*1+N,q=f.style.top.replace("px","")*1+V;ce(H,q)}function ce(N,V){N=N<0?0:N>u.width?u.width:N,V=V<0?0:V>u.height?u.height:V,f.style.left=N+"px",f.style.top=V+"px",$(N,V),f.focus()}function ye(N,V){N===void 0&&(N={}),V===void 0&&(V={});let H=h.format;for(const B in N)s[B]=N[B];for(const B in V)s[B]=V[B];const q=Fe(s),_=q.substring(0,7);switch(f.style.color=_,F.parentNode.style.color=_,F.style.color=q,g.style.color=q,c.style.display="none",c.offsetHeight,c.style.display="",F.nextElementSibling.style.display="none",F.nextElementSibling.offsetHeight,F.nextElementSibling.style.display="",H==="mixed"?H=s.a===1?"hex":"rgb":H==="auto"&&(H=z),H){case"hex":v.value=q;break;case"rgb":v.value=We(s);break;case"hsl":v.value=ht(pt(s));break}e.querySelector('.clr-format [value="'+H+'"]').checked=!0}function rt(){const N=k.value*1,V=f.style.left.replace("px","")*1,H=f.style.top.replace("px","")*1;l.style.color="hsl("+N+", 100%, 50%)",L.style.left=N/360*100+"%",$(V,H)}function wt(){const N=R.value/100;F.style.left=N*100+"%",ye({a:N}),ee()}function ft(N){const V=N.s/100,H=N.v/100;let q=V*H,_=N.h/60,B=q*(1-t.abs(_%2-1)),Y=H-q;q=q+Y,B=B+Y;const Z=t.floor(_)%6,K=[q,B,Y,Y,B,q][Z],le=[B,q,q,B,Y,Y][Z],he=[Y,Y,B,q,q,B][Z];return{r:t.round(K*255),g:t.round(le*255),b:t.round(he*255),a:N.a}}function pt(N){const V=N.v/100,H=V*(1-N.s/100/2);let q;return H>0&&H<1&&(q=t.round((V-H)/t.min(H,1-H)*100)),{h:N.h,s:q||0,l:t.round(H*100),a:N.a}}function bt(N){const V=N.r/255,H=N.g/255,q=N.b/255,_=t.max(V,H,q),B=t.min(V,H,q),Y=_-B,Z=_;let K=0,le=0;return Y&&(_===V&&(K=(H-q)/Y),_===H&&(K=2+(q-V)/Y),_===q&&(K=4+(V-H)/Y),_&&(le=Y/_)),K=t.floor(K*60),{h:K<0?K+360:K,s:t.round(le*100),v:t.round(Z*100),a:N.a}}function Tt(N){const V=/^((rgba)|rgb)[\D]+([\d.]+)[\D]+([\d.]+)[\D]+([\d.]+)[\D]*?([\d.]+|$)/i;let H,q;return i.fillStyle="#000",i.fillStyle=N,H=V.exec(i.fillStyle),H?q={r:H[3]*1,g:H[4]*1,b:H[5]*1,a:H[6]*1}:(H=i.fillStyle.replace("#","").match(/.{2}/g).map(_=>parseInt(_,16)),q={r:H[0],g:H[1],b:H[2],a:1}),q}function Fe(N){let V=N.r.toString(16),H=N.g.toString(16),q=N.b.toString(16),_="";if(N.r<16&&(V="0"+V),N.g<16&&(H="0"+H),N.b<16&&(q="0"+q),h.alpha&&(N.a<1||h.forceAlpha)){const B=N.a*255|0;_=B.toString(16),B<16&&(_="0"+_)}return"#"+V+H+q+_}function We(N){return!h.alpha||N.a===1&&!h.forceAlpha?"rgb("+N.r+", "+N.g+", "+N.b+")":"rgba("+N.r+", "+N.g+", "+N.b+", "+N.a+")"}function ht(N){return!h.alpha||N.a===1&&!h.forceAlpha?"hsl("+N.h+", "+N.s+"%, "+N.l+"%)":"hsla("+N.h+", "+N.s+"%, "+N.l+"%, "+N.a+")"}function tt(){e.getElementById("clr-picker")||(o=n,l=e.createElement("div"),l.setAttribute("id","clr-picker"),l.className="clr-picker",l.innerHTML='<input id="clr-color-value" name="clr-color-value" class="clr-color" type="text" value="" spellcheck="false" aria-label="'+h.a11y.input+'">'+('<div id="clr-color-area" class="clr-gradient" role="application" aria-label="'+h.a11y.instruction+'">')+'<div id="clr-color-marker" class="clr-marker" tabindex="0"></div></div><div class="clr-hue">'+('<input id="clr-hue-slider" name="clr-hue-slider" type="range" min="0" max="360" step="1" aria-label="'+h.a11y.hueSlider+'">')+'<div id="clr-hue-marker"></div></div><div class="clr-alpha">'+('<input id="clr-alpha-slider" name="clr-alpha-slider" type="range" min="0" max="100" step="1" aria-label="'+h.a11y.alphaSlider+'">')+'<div id="clr-alpha-marker"></div><span></span></div><div id="clr-format" class="clr-format"><fieldset class="clr-segmented">'+("<legend>"+h.a11y.format+"</legend>")+'<input id="clr-f1" type="radio" name="clr-format" value="hex"><label for="clr-f1">Hex</label><input id="clr-f2" type="radio" name="clr-format" value="rgb"><label for="clr-f2">RGB</label><input id="clr-f3" type="radio" name="clr-format" value="hsl"><label for="clr-f3">HSL</label><span></span></fieldset></div><div id="clr-swatches" class="clr-swatches"></div>'+('<button type="button" id="clr-clear" class="clr-clear" aria-label="'+h.a11y.clear+'">'+h.clearLabel+"</button>")+'<div id="clr-color-preview" class="clr-preview">'+('<button type="button" id="clr-close" class="clr-close" aria-label="'+h.a11y.close+'">'+h.closeLabel+"</button>")+"</div>"+('<span id="clr-open-label" hidden>'+h.a11y.open+"</span>")+('<span id="clr-swatch-label" hidden>'+h.a11y.swatch+"</span>"),e.body.appendChild(l),c=ge("clr-color-area"),f=ge("clr-color-marker"),S=ge("clr-clear"),O=ge("clr-close"),g=ge("clr-color-preview"),v=ge("clr-color-value"),k=ge("clr-hue-slider"),L=ge("clr-hue-marker"),R=ge("clr-alpha-slider"),F=ge("clr-alpha-marker"),x(h.el),Q(h.el),de(l,"mousedown",N=>{l.classList.remove("clr-keyboard-nav"),N.stopPropagation()}),de(c,"mousedown",N=>{de(e,"mousemove",se)}),de(c,"contextmenu",N=>{N.preventDefault()}),de(c,"touchstart",N=>{e.addEventListener("touchmove",se,{passive:!1})}),de(f,"mousedown",N=>{de(e,"mousemove",se)}),de(f,"touchstart",N=>{e.addEventListener("touchmove",se,{passive:!1})}),de(v,"change",N=>{const V=v.value;if(M||h.inline){const H=V===""?V:oe(V);ee(H)}}),de(S,"click",N=>{ee(""),re()}),de(O,"click",N=>{ee(),re()}),de(ge("clr-format"),"click",".clr-format input",N=>{z=N.target.value,ye(),ee()}),de(l,"click",".clr-swatches button",N=>{oe(N.target.textContent),ee(),h.swatchesOnly&&re()}),de(e,"mouseup",N=>{e.removeEventListener("mousemove",se)}),de(e,"touchend",N=>{e.removeEventListener("touchmove",se)}),de(e,"mousedown",N=>{p=!1,l.classList.remove("clr-keyboard-nav"),re()}),de(e,"keydown",N=>{const V=N.key,H=N.target,q=N.shiftKey;if(V==="Escape"?re(!0):["Tab","ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(V)&&(p=!0,l.classList.add("clr-keyboard-nav")),V==="Tab"&&H.matches(".clr-picker *")){const B=st(),Y=B.shift(),Z=B.pop();q&&H===Y?(Z.focus(),N.preventDefault()):!q&&H===Z&&(Y.focus(),N.preventDefault())}}),de(e,"click",".clr-field button",N=>{I&&b(),N.target.nextElementSibling.dispatchEvent(new Event("click",{bubbles:!0}))}),de(f,"keydown",N=>{const V={ArrowUp:[0,-1],ArrowDown:[0,1],ArrowLeft:[-1,0],ArrowRight:[1,0]};Object.keys(V).includes(N.key)&&(ie(...V[N.key]),N.preventDefault())}),de(c,"click",se),de(k,"input",rt),de(R,"input",wt))}function st(){return Array.from(l.querySelectorAll("input, button")).filter(H=>!!H.offsetWidth)}function ge(N){return e.getElementById(N)}function de(N,V,H,q){const _=Element.prototype.matches||Element.prototype.msMatchesSelector;typeof H=="string"?N.addEventListener(V,B=>{_.call(B.target,H)&&q.call(B.target,B)}):(q=H,N.addEventListener(V,q))}function nt(N,V){V=V!==n?V:[],e.readyState!=="loading"?N(...V):e.addEventListener("DOMContentLoaded",()=>{N(...V)})}NodeList!==n&&NodeList.prototype&&!NodeList.prototype.forEach&&(NodeList.prototype.forEach=Array.prototype.forEach);function St(N,V){M=V,r=M.value,P(V),z=ae(N),G(),oe(N),ee(),r!==N&&M.dispatchEvent(new Event("change",{bubbles:!0}))}const Vt=(()=>{const N={init:tt,set:C,wrap:Q,close:re,setInstance:D,setColor:St,removeInstance:A,updatePosition:G,ready:nt};function V(H){nt(()=>{H&&(typeof H=="string"?x(H):C(H))})}for(const H in N)V[H]=function(){for(var q=arguments.length,_=new Array(q),B=0;B<q;B++)_[B]=arguments[B];nt(N[H],_)};return nt(()=>{a.addEventListener("resize",H=>{V.updatePosition()}),a.addEventListener("scroll",H=>{V.updatePosition()})}),V})();return Vt.coloris=Vt,Vt})(window,document,Math)})();Ge.coloris;Ge.init;Ge.set;Ge.wrap;Ge.close;Ge.setInstance;Ge.removeInstance;Ge.updatePosition;var hr=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function gr(a){return a&&a.__esModule&&Object.prototype.hasOwnProperty.call(a,"default")?a.default:a}var mi={exports:{}};(function(a){(function(){function e(r){var p={omitExtraWLInCodeBlocks:{defaultValue:!1,describe:"Omit the default extra whiteline added to code blocks",type:"boolean"},noHeaderId:{defaultValue:!1,describe:"Turn on/off generated header id",type:"boolean"},prefixHeaderId:{defaultValue:!1,describe:"Add a prefix to the generated header ids. Passing a string will prefix that string to the header id. Setting to true will add a generic 'section-' prefix",type:"string"},rawPrefixHeaderId:{defaultValue:!1,describe:'Setting this option to true will prevent showdown from modifying the prefix. This might result in malformed IDs (if, for instance, the " char is used in the prefix)',type:"boolean"},ghCompatibleHeaderId:{defaultValue:!1,describe:"Generate header ids compatible with github style (spaces are replaced with dashes, a bunch of non alphanumeric chars are removed)",type:"boolean"},rawHeaderId:{defaultValue:!1,describe:`Remove only spaces, ' and " from generated header ids (including prefixes), replacing them with dashes (-). WARNING: This might result in malformed ids`,type:"boolean"},headerLevelStart:{defaultValue:!1,describe:"The header blocks level start",type:"integer"},parseImgDimensions:{defaultValue:!1,describe:"Turn on/off image dimension parsing",type:"boolean"},simplifiedAutoLink:{defaultValue:!1,describe:"Turn on/off GFM autolink style",type:"boolean"},excludeTrailingPunctuationFromURLs:{defaultValue:!1,describe:"Excludes trailing punctuation from links generated with autoLinking",type:"boolean"},literalMidWordUnderscores:{defaultValue:!1,describe:"Parse midword underscores as literal underscores",type:"boolean"},literalMidWordAsterisks:{defaultValue:!1,describe:"Parse midword asterisks as literal asterisks",type:"boolean"},strikethrough:{defaultValue:!1,describe:"Turn on/off strikethrough support",type:"boolean"},tables:{defaultValue:!1,describe:"Turn on/off tables support",type:"boolean"},tablesHeaderId:{defaultValue:!1,describe:"Add an id to table headers",type:"boolean"},ghCodeBlocks:{defaultValue:!0,describe:"Turn on/off GFM fenced code blocks support",type:"boolean"},tasklists:{defaultValue:!1,describe:"Turn on/off GFM tasklist support",type:"boolean"},smoothLivePreview:{defaultValue:!1,describe:"Prevents weird effects in live previews due to incomplete input",type:"boolean"},smartIndentationFix:{defaultValue:!1,describe:"Tries to smartly fix indentation in es6 strings",type:"boolean"},disableForced4SpacesIndentedSublists:{defaultValue:!1,describe:"Disables the requirement of indenting nested sublists by 4 spaces",type:"boolean"},simpleLineBreaks:{defaultValue:!1,describe:"Parses simple line breaks as <br> (GFM Style)",type:"boolean"},requireSpaceBeforeHeadingText:{defaultValue:!1,describe:"Makes adding a space between `#` and the header text mandatory (GFM Style)",type:"boolean"},ghMentions:{defaultValue:!1,describe:"Enables github @mentions",type:"boolean"},ghMentionsLink:{defaultValue:"https://github.com/{u}",describe:"Changes the link generated by @mentions. Only applies if ghMentions option is enabled.",type:"string"},encodeEmails:{defaultValue:!0,describe:"Encode e-mail addresses through the use of Character Entities, transforming ASCII e-mail addresses into its equivalent decimal entities",type:"boolean"},openLinksInNewWindow:{defaultValue:!1,describe:"Open all links in new windows",type:"boolean"},backslashEscapesHTMLTags:{defaultValue:!1,describe:"Support for HTML Tag escaping. ex: <div>foo</div>",type:"boolean"},emoji:{defaultValue:!1,describe:"Enable emoji support. Ex: `this is a :smile: emoji`",type:"boolean"},underline:{defaultValue:!1,describe:"Enable support for underline. Syntax is double or triple underscores: `__underline word__`. With this option enabled, underscores no longer parses into `<em>` and `<strong>`",type:"boolean"},ellipsis:{defaultValue:!0,describe:"Replaces three dots with the ellipsis unicode character",type:"boolean"},completeHTMLDocument:{defaultValue:!1,describe:"Outputs a complete html document, including `<html>`, `<head>` and `<body>` tags",type:"boolean"},metadata:{defaultValue:!1,describe:"Enable support for document metadata (defined at the top of the document between `«««` and `»»»` or between `---` and `---`).",type:"boolean"},splitAdjacentBlockquotes:{defaultValue:!1,describe:"Split adjacent blockquote blocks",type:"boolean"}};if(r===!1)return JSON.parse(JSON.stringify(p));var u={};for(var h in p)p.hasOwnProperty(h)&&(u[h]=p[h].defaultValue);return u}function t(){var r=e(!0),p={};for(var u in r)r.hasOwnProperty(u)&&(p[u]=!0);return p}var n={},i={},s={},o=e(!0),l="vanilla",c={github:{omitExtraWLInCodeBlocks:!0,simplifiedAutoLink:!0,excludeTrailingPunctuationFromURLs:!0,literalMidWordUnderscores:!0,strikethrough:!0,tables:!0,tablesHeaderId:!0,ghCodeBlocks:!0,tasklists:!0,disableForced4SpacesIndentedSublists:!0,simpleLineBreaks:!0,requireSpaceBeforeHeadingText:!0,ghCompatibleHeaderId:!0,ghMentions:!0,backslashEscapesHTMLTags:!0,emoji:!0,splitAdjacentBlockquotes:!0},original:{noHeaderId:!0,ghCodeBlocks:!1},ghost:{omitExtraWLInCodeBlocks:!0,parseImgDimensions:!0,simplifiedAutoLink:!0,excludeTrailingPunctuationFromURLs:!0,literalMidWordUnderscores:!0,strikethrough:!0,tables:!0,tablesHeaderId:!0,ghCodeBlocks:!0,tasklists:!0,smoothLivePreview:!0,simpleLineBreaks:!0,requireSpaceBeforeHeadingText:!0,ghMentions:!1,encodeEmails:!0},vanilla:e(!0),allOn:t()};n.helper={},n.extensions={},n.setOption=function(r,p){return o[r]=p,this},n.getOption=function(r){return o[r]},n.getOptions=function(){return o},n.resetOptions=function(){o=e(!0)},n.setFlavor=function(r){if(!c.hasOwnProperty(r))throw Error(r+" flavor was not found");n.resetOptions();var p=c[r];l=r;for(var u in p)p.hasOwnProperty(u)&&(o[u]=p[u])},n.getFlavor=function(){return l},n.getFlavorOptions=function(r){if(c.hasOwnProperty(r))return c[r]},n.getDefaultOptions=function(r){return e(r)},n.subParser=function(r,p){if(n.helper.isString(r))if(typeof p<"u")i[r]=p;else{if(i.hasOwnProperty(r))return i[r];throw Error("SubParser named "+r+" not registered!")}},n.extension=function(r,p){if(!n.helper.isString(r))throw Error("Extension 'name' must be a string");if(r=n.helper.stdExtName(r),n.helper.isUndefined(p)){if(!s.hasOwnProperty(r))throw Error("Extension named "+r+" is not registered!");return s[r]}else{typeof p=="function"&&(p=p()),n.helper.isArray(p)||(p=[p]);var u=f(p,r);if(u.valid)s[r]=p;else throw Error(u.error)}},n.getAllExtensions=function(){return s},n.removeExtension=function(r){delete s[r]},n.resetExtensions=function(){s={}};function f(r,p){var u=p?"Error in "+p+" extension->":"Error in unnamed extension",h={valid:!0,error:""};n.helper.isArray(r)||(r=[r]);for(var T=0;T<r.length;++T){var y=u+" sub-extension "+T+": ",E=r[T];if(typeof E!="object")return h.valid=!1,h.error=y+"must be an object, but "+typeof E+" given",h;if(!n.helper.isString(E.type))return h.valid=!1,h.error=y+'property "type" must be a string, but '+typeof E.type+" given",h;var I=E.type=E.type.toLowerCase();if(I==="language"&&(I=E.type="lang"),I==="html"&&(I=E.type="output"),I!=="lang"&&I!=="output"&&I!=="listener")return h.valid=!1,h.error=y+"type "+I+' is not recognized. Valid values: "lang/language", "output/html" or "listener"',h;if(I==="listener"){if(n.helper.isUndefined(E.listeners))return h.valid=!1,h.error=y+'. Extensions of type "listener" must have a property called "listeners"',h}else if(n.helper.isUndefined(E.filter)&&n.helper.isUndefined(E.regex))return h.valid=!1,h.error=y+I+' extensions must define either a "regex" property or a "filter" method',h;if(E.listeners){if(typeof E.listeners!="object")return h.valid=!1,h.error=y+'"listeners" property must be an object but '+typeof E.listeners+" given",h;for(var C in E.listeners)if(E.listeners.hasOwnProperty(C)&&typeof E.listeners[C]!="function")return h.valid=!1,h.error=y+'"listeners" property must be an hash of [event name]: [callback]. listeners.'+C+" must be a function but "+typeof E.listeners[C]+" given",h}if(E.filter){if(typeof E.filter!="function")return h.valid=!1,h.error=y+'"filter" must be a function, but '+typeof E.filter+" given",h}else if(E.regex){if(n.helper.isString(E.regex)&&(E.regex=new RegExp(E.regex,"g")),!(E.regex instanceof RegExp))return h.valid=!1,h.error=y+'"regex" property must either be a string or a RegExp object, but '+typeof E.regex+" given",h;if(n.helper.isUndefined(E.replace))return h.valid=!1,h.error=y+'"regex" extensions must implement a replace string or function',h}}return h}n.validateExtension=function(r){var p=f(r,null);return p.valid?!0:(console.warn(p.error),!1)},n.hasOwnProperty("helper")||(n.helper={}),n.helper.isString=function(r){return typeof r=="string"||r instanceof String},n.helper.isFunction=function(r){var p={};return r&&p.toString.call(r)==="[object Function]"},n.helper.isArray=function(r){return Array.isArray(r)},n.helper.isUndefined=function(r){return typeof r>"u"},n.helper.forEach=function(r,p){if(n.helper.isUndefined(r))throw new Error("obj param is required");if(n.helper.isUndefined(p))throw new Error("callback param is required");if(!n.helper.isFunction(p))throw new Error("callback param must be a function/closure");if(typeof r.forEach=="function")r.forEach(p);else if(n.helper.isArray(r))for(var u=0;u<r.length;u++)p(r[u],u,r);else if(typeof r=="object")for(var h in r)r.hasOwnProperty(h)&&p(r[h],h,r);else throw new Error("obj does not seem to be an array or an iterable object")},n.helper.stdExtName=function(r){return r.replace(/[_?*+\/\\.^-]/g,"").replace(/\s/g,"").toLowerCase()};function g(r,p){var u=p.charCodeAt(0);return"¨E"+u+"E"}n.helper.escapeCharactersCallback=g,n.helper.escapeCharacters=function(r,p,u){var h="(["+p.replace(/([\[\]\\])/g,"\\$1")+"])";u&&(h="\\\\"+h);var T=new RegExp(h,"g");return r=r.replace(T,g),r},n.helper.unescapeHTMLEntities=function(r){return r.replace(/&quot;/g,'"').replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&amp;/g,"&")};var v=function(r,p,u,h){var T=h||"",y=T.indexOf("g")>-1,E=new RegExp(p+"|"+u,"g"+T.replace(/g/g,"")),I=new RegExp(p,T.replace(/g/g,"")),C=[],D,A,P,b,x;do for(D=0;P=E.exec(r);)if(I.test(P[0]))D++||(A=E.lastIndex,b=A-P[0].length);else if(D&&!--D){x=P.index+P[0].length;var U={left:{start:b,end:A},match:{start:A,end:P.index},right:{start:P.index,end:x},wholeMatch:{start:b,end:x}};if(C.push(U),!y)return C}while(D&&(E.lastIndex=A));return C};n.helper.matchRecursiveRegExp=function(r,p,u,h){for(var T=v(r,p,u,h),y=[],E=0;E<T.length;++E)y.push([r.slice(T[E].wholeMatch.start,T[E].wholeMatch.end),r.slice(T[E].match.start,T[E].match.end),r.slice(T[E].left.start,T[E].left.end),r.slice(T[E].right.start,T[E].right.end)]);return y},n.helper.replaceRecursiveRegExp=function(r,p,u,h,T){if(!n.helper.isFunction(p)){var y=p;p=function(){return y}}var E=v(r,u,h,T),I=r,C=E.length;if(C>0){var D=[];E[0].wholeMatch.start!==0&&D.push(r.slice(0,E[0].wholeMatch.start));for(var A=0;A<C;++A)D.push(p(r.slice(E[A].wholeMatch.start,E[A].wholeMatch.end),r.slice(E[A].match.start,E[A].match.end),r.slice(E[A].left.start,E[A].left.end),r.slice(E[A].right.start,E[A].right.end))),A<C-1&&D.push(r.slice(E[A].wholeMatch.end,E[A+1].wholeMatch.start));E[C-1].wholeMatch.end<r.length&&D.push(r.slice(E[C-1].wholeMatch.end)),I=D.join("")}return I},n.helper.regexIndexOf=function(r,p,u){if(!n.helper.isString(r))throw"InvalidArgumentError: first parameter of showdown.helper.regexIndexOf function must be a string";if(!(p instanceof RegExp))throw"InvalidArgumentError: second parameter of showdown.helper.regexIndexOf function must be an instance of RegExp";var h=r.substring(u||0).search(p);return h>=0?h+(u||0):h},n.helper.splitAtIndex=function(r,p){if(!n.helper.isString(r))throw"InvalidArgumentError: first parameter of showdown.helper.regexIndexOf function must be a string";return[r.substring(0,p),r.substring(p)]},n.helper.encodeEmailAddress=function(r){var p=[function(u){return"&#"+u.charCodeAt(0)+";"},function(u){return"&#x"+u.charCodeAt(0).toString(16)+";"},function(u){return u}];return r=r.replace(/./g,function(u){if(u==="@")u=p[Math.floor(Math.random()*2)](u);else{var h=Math.random();u=h>.9?p[2](u):h>.45?p[1](u):p[0](u)}return u}),r},n.helper.padEnd=function(p,u,h){return u=u>>0,h=String(h||" "),p.length>u?String(p):(u=u-p.length,u>h.length&&(h+=h.repeat(u/h.length)),String(p)+h.slice(0,u))},typeof console>"u"&&(console={warn:function(r){alert(r)},log:function(r){alert(r)},error:function(r){throw r}}),n.helper.regexes={asteriskDashAndColon:/([*_:~])/g},n.helper.emojis={"+1":"👍","-1":"👎",100:"💯",1234:"🔢","1st_place_medal":"🥇","2nd_place_medal":"🥈","3rd_place_medal":"🥉","8ball":"🎱",a:"🅰️",ab:"🆎",abc:"🔤",abcd:"🔡",accept:"🉑",aerial_tramway:"🚡",airplane:"✈️",alarm_clock:"⏰",alembic:"⚗️",alien:"👽",ambulance:"🚑",amphora:"🏺",anchor:"⚓️",angel:"👼",anger:"💢",angry:"😠",anguished:"😧",ant:"🐜",apple:"🍎",aquarius:"♒️",aries:"♈️",arrow_backward:"◀️",arrow_double_down:"⏬",arrow_double_up:"⏫",arrow_down:"⬇️",arrow_down_small:"🔽",arrow_forward:"▶️",arrow_heading_down:"⤵️",arrow_heading_up:"⤴️",arrow_left:"⬅️",arrow_lower_left:"↙️",arrow_lower_right:"↘️",arrow_right:"➡️",arrow_right_hook:"↪️",arrow_up:"⬆️",arrow_up_down:"↕️",arrow_up_small:"🔼",arrow_upper_left:"↖️",arrow_upper_right:"↗️",arrows_clockwise:"🔃",arrows_counterclockwise:"🔄",art:"🎨",articulated_lorry:"🚛",artificial_satellite:"🛰",astonished:"😲",athletic_shoe:"👟",atm:"🏧",atom_symbol:"⚛️",avocado:"🥑",b:"🅱️",baby:"👶",baby_bottle:"🍼",baby_chick:"🐤",baby_symbol:"🚼",back:"🔙",bacon:"🥓",badminton:"🏸",baggage_claim:"🛄",baguette_bread:"🥖",balance_scale:"⚖️",balloon:"🎈",ballot_box:"🗳",ballot_box_with_check:"☑️",bamboo:"🎍",banana:"🍌",bangbang:"‼️",bank:"🏦",bar_chart:"📊",barber:"💈",baseball:"⚾️",basketball:"🏀",basketball_man:"⛹️",basketball_woman:"⛹️&zwj;♀️",bat:"🦇",bath:"🛀",bathtub:"🛁",battery:"🔋",beach_umbrella:"🏖",bear:"🐻",bed:"🛏",bee:"🐝",beer:"🍺",beers:"🍻",beetle:"🐞",beginner:"🔰",bell:"🔔",bellhop_bell:"🛎",bento:"🍱",biking_man:"🚴",bike:"🚲",biking_woman:"🚴&zwj;♀️",bikini:"👙",biohazard:"☣️",bird:"🐦",birthday:"🎂",black_circle:"⚫️",black_flag:"🏴",black_heart:"🖤",black_joker:"🃏",black_large_square:"⬛️",black_medium_small_square:"◾️",black_medium_square:"◼️",black_nib:"✒️",black_small_square:"▪️",black_square_button:"🔲",blonde_man:"👱",blonde_woman:"👱&zwj;♀️",blossom:"🌼",blowfish:"🐡",blue_book:"📘",blue_car:"🚙",blue_heart:"💙",blush:"😊",boar:"🐗",boat:"⛵️",bomb:"💣",book:"📖",bookmark:"🔖",bookmark_tabs:"📑",books:"📚",boom:"💥",boot:"👢",bouquet:"💐",bowing_man:"🙇",bow_and_arrow:"🏹",bowing_woman:"🙇&zwj;♀️",bowling:"🎳",boxing_glove:"🥊",boy:"👦",bread:"🍞",bride_with_veil:"👰",bridge_at_night:"🌉",briefcase:"💼",broken_heart:"💔",bug:"🐛",building_construction:"🏗",bulb:"💡",bullettrain_front:"🚅",bullettrain_side:"🚄",burrito:"🌯",bus:"🚌",business_suit_levitating:"🕴",busstop:"🚏",bust_in_silhouette:"👤",busts_in_silhouette:"👥",butterfly:"🦋",cactus:"🌵",cake:"🍰",calendar:"📆",call_me_hand:"🤙",calling:"📲",camel:"🐫",camera:"📷",camera_flash:"📸",camping:"🏕",cancer:"♋️",candle:"🕯",candy:"🍬",canoe:"🛶",capital_abcd:"🔠",capricorn:"♑️",car:"🚗",card_file_box:"🗃",card_index:"📇",card_index_dividers:"🗂",carousel_horse:"🎠",carrot:"🥕",cat:"🐱",cat2:"🐈",cd:"💿",chains:"⛓",champagne:"🍾",chart:"💹",chart_with_downwards_trend:"📉",chart_with_upwards_trend:"📈",checkered_flag:"🏁",cheese:"🧀",cherries:"🍒",cherry_blossom:"🌸",chestnut:"🌰",chicken:"🐔",children_crossing:"🚸",chipmunk:"🐿",chocolate_bar:"🍫",christmas_tree:"🎄",church:"⛪️",cinema:"🎦",circus_tent:"🎪",city_sunrise:"🌇",city_sunset:"🌆",cityscape:"🏙",cl:"🆑",clamp:"🗜",clap:"👏",clapper:"🎬",classical_building:"🏛",clinking_glasses:"🥂",clipboard:"📋",clock1:"🕐",clock10:"🕙",clock1030:"🕥",clock11:"🕚",clock1130:"🕦",clock12:"🕛",clock1230:"🕧",clock130:"🕜",clock2:"🕑",clock230:"🕝",clock3:"🕒",clock330:"🕞",clock4:"🕓",clock430:"🕟",clock5:"🕔",clock530:"🕠",clock6:"🕕",clock630:"🕡",clock7:"🕖",clock730:"🕢",clock8:"🕗",clock830:"🕣",clock9:"🕘",clock930:"🕤",closed_book:"📕",closed_lock_with_key:"🔐",closed_umbrella:"🌂",cloud:"☁️",cloud_with_lightning:"🌩",cloud_with_lightning_and_rain:"⛈",cloud_with_rain:"🌧",cloud_with_snow:"🌨",clown_face:"🤡",clubs:"♣️",cocktail:"🍸",coffee:"☕️",coffin:"⚰️",cold_sweat:"😰",comet:"☄️",computer:"💻",computer_mouse:"🖱",confetti_ball:"🎊",confounded:"😖",confused:"😕",congratulations:"㊗️",construction:"🚧",construction_worker_man:"👷",construction_worker_woman:"👷&zwj;♀️",control_knobs:"🎛",convenience_store:"🏪",cookie:"🍪",cool:"🆒",policeman:"👮",copyright:"©️",corn:"🌽",couch_and_lamp:"🛋",couple:"👫",couple_with_heart_woman_man:"💑",couple_with_heart_man_man:"👨&zwj;❤️&zwj;👨",couple_with_heart_woman_woman:"👩&zwj;❤️&zwj;👩",couplekiss_man_man:"👨&zwj;❤️&zwj;💋&zwj;👨",couplekiss_man_woman:"💏",couplekiss_woman_woman:"👩&zwj;❤️&zwj;💋&zwj;👩",cow:"🐮",cow2:"🐄",cowboy_hat_face:"🤠",crab:"🦀",crayon:"🖍",credit_card:"💳",crescent_moon:"🌙",cricket:"🏏",crocodile:"🐊",croissant:"🥐",crossed_fingers:"🤞",crossed_flags:"🎌",crossed_swords:"⚔️",crown:"👑",cry:"😢",crying_cat_face:"😿",crystal_ball:"🔮",cucumber:"🥒",cupid:"💘",curly_loop:"➰",currency_exchange:"💱",curry:"🍛",custard:"🍮",customs:"🛃",cyclone:"🌀",dagger:"🗡",dancer:"💃",dancing_women:"👯",dancing_men:"👯&zwj;♂️",dango:"🍡",dark_sunglasses:"🕶",dart:"🎯",dash:"💨",date:"📅",deciduous_tree:"🌳",deer:"🦌",department_store:"🏬",derelict_house:"🏚",desert:"🏜",desert_island:"🏝",desktop_computer:"🖥",male_detective:"🕵️",diamond_shape_with_a_dot_inside:"💠",diamonds:"♦️",disappointed:"😞",disappointed_relieved:"😥",dizzy:"💫",dizzy_face:"😵",do_not_litter:"🚯",dog:"🐶",dog2:"🐕",dollar:"💵",dolls:"🎎",dolphin:"🐬",door:"🚪",doughnut:"🍩",dove:"🕊",dragon:"🐉",dragon_face:"🐲",dress:"👗",dromedary_camel:"🐪",drooling_face:"🤤",droplet:"💧",drum:"🥁",duck:"🦆",dvd:"📀","e-mail":"📧",eagle:"🦅",ear:"👂",ear_of_rice:"🌾",earth_africa:"🌍",earth_americas:"🌎",earth_asia:"🌏",egg:"🥚",eggplant:"🍆",eight_pointed_black_star:"✴️",eight_spoked_asterisk:"✳️",electric_plug:"🔌",elephant:"🐘",email:"✉️",end:"🔚",envelope_with_arrow:"📩",euro:"💶",european_castle:"🏰",european_post_office:"🏤",evergreen_tree:"🌲",exclamation:"❗️",expressionless:"😑",eye:"👁",eye_speech_bubble:"👁&zwj;🗨",eyeglasses:"👓",eyes:"👀",face_with_head_bandage:"🤕",face_with_thermometer:"🤒",fist_oncoming:"👊",factory:"🏭",fallen_leaf:"🍂",family_man_woman_boy:"👪",family_man_boy:"👨&zwj;👦",family_man_boy_boy:"👨&zwj;👦&zwj;👦",family_man_girl:"👨&zwj;👧",family_man_girl_boy:"👨&zwj;👧&zwj;👦",family_man_girl_girl:"👨&zwj;👧&zwj;👧",family_man_man_boy:"👨&zwj;👨&zwj;👦",family_man_man_boy_boy:"👨&zwj;👨&zwj;👦&zwj;👦",family_man_man_girl:"👨&zwj;👨&zwj;👧",family_man_man_girl_boy:"👨&zwj;👨&zwj;👧&zwj;👦",family_man_man_girl_girl:"👨&zwj;👨&zwj;👧&zwj;👧",family_man_woman_boy_boy:"👨&zwj;👩&zwj;👦&zwj;👦",family_man_woman_girl:"👨&zwj;👩&zwj;👧",family_man_woman_girl_boy:"👨&zwj;👩&zwj;👧&zwj;👦",family_man_woman_girl_girl:"👨&zwj;👩&zwj;👧&zwj;👧",family_woman_boy:"👩&zwj;👦",family_woman_boy_boy:"👩&zwj;👦&zwj;👦",family_woman_girl:"👩&zwj;👧",family_woman_girl_boy:"👩&zwj;👧&zwj;👦",family_woman_girl_girl:"👩&zwj;👧&zwj;👧",family_woman_woman_boy:"👩&zwj;👩&zwj;👦",family_woman_woman_boy_boy:"👩&zwj;👩&zwj;👦&zwj;👦",family_woman_woman_girl:"👩&zwj;👩&zwj;👧",family_woman_woman_girl_boy:"👩&zwj;👩&zwj;👧&zwj;👦",family_woman_woman_girl_girl:"👩&zwj;👩&zwj;👧&zwj;👧",fast_forward:"⏩",fax:"📠",fearful:"😨",feet:"🐾",female_detective:"🕵️&zwj;♀️",ferris_wheel:"🎡",ferry:"⛴",field_hockey:"🏑",file_cabinet:"🗄",file_folder:"📁",film_projector:"📽",film_strip:"🎞",fire:"🔥",fire_engine:"🚒",fireworks:"🎆",first_quarter_moon:"🌓",first_quarter_moon_with_face:"🌛",fish:"🐟",fish_cake:"🍥",fishing_pole_and_fish:"🎣",fist_raised:"✊",fist_left:"🤛",fist_right:"🤜",flags:"🎏",flashlight:"🔦",fleur_de_lis:"⚜️",flight_arrival:"🛬",flight_departure:"🛫",floppy_disk:"💾",flower_playing_cards:"🎴",flushed:"😳",fog:"🌫",foggy:"🌁",football:"🏈",footprints:"👣",fork_and_knife:"🍴",fountain:"⛲️",fountain_pen:"🖋",four_leaf_clover:"🍀",fox_face:"🦊",framed_picture:"🖼",free:"🆓",fried_egg:"🍳",fried_shrimp:"🍤",fries:"🍟",frog:"🐸",frowning:"😦",frowning_face:"☹️",frowning_man:"🙍&zwj;♂️",frowning_woman:"🙍",middle_finger:"🖕",fuelpump:"⛽️",full_moon:"🌕",full_moon_with_face:"🌝",funeral_urn:"⚱️",game_die:"🎲",gear:"⚙️",gem:"💎",gemini:"♊️",ghost:"👻",gift:"🎁",gift_heart:"💝",girl:"👧",globe_with_meridians:"🌐",goal_net:"🥅",goat:"🐐",golf:"⛳️",golfing_man:"🏌️",golfing_woman:"🏌️&zwj;♀️",gorilla:"🦍",grapes:"🍇",green_apple:"🍏",green_book:"📗",green_heart:"💚",green_salad:"🥗",grey_exclamation:"❕",grey_question:"❔",grimacing:"😬",grin:"😁",grinning:"😀",guardsman:"💂",guardswoman:"💂&zwj;♀️",guitar:"🎸",gun:"🔫",haircut_woman:"💇",haircut_man:"💇&zwj;♂️",hamburger:"🍔",hammer:"🔨",hammer_and_pick:"⚒",hammer_and_wrench:"🛠",hamster:"🐹",hand:"✋",handbag:"👜",handshake:"🤝",hankey:"💩",hatched_chick:"🐥",hatching_chick:"🐣",headphones:"🎧",hear_no_evil:"🙉",heart:"❤️",heart_decoration:"💟",heart_eyes:"😍",heart_eyes_cat:"😻",heartbeat:"💓",heartpulse:"💗",hearts:"♥️",heavy_check_mark:"✔️",heavy_division_sign:"➗",heavy_dollar_sign:"💲",heavy_heart_exclamation:"❣️",heavy_minus_sign:"➖",heavy_multiplication_x:"✖️",heavy_plus_sign:"➕",helicopter:"🚁",herb:"🌿",hibiscus:"🌺",high_brightness:"🔆",high_heel:"👠",hocho:"🔪",hole:"🕳",honey_pot:"🍯",horse:"🐴",horse_racing:"🏇",hospital:"🏥",hot_pepper:"🌶",hotdog:"🌭",hotel:"🏨",hotsprings:"♨️",hourglass:"⌛️",hourglass_flowing_sand:"⏳",house:"🏠",house_with_garden:"🏡",houses:"🏘",hugs:"🤗",hushed:"😯",ice_cream:"🍨",ice_hockey:"🏒",ice_skate:"⛸",icecream:"🍦",id:"🆔",ideograph_advantage:"🉐",imp:"👿",inbox_tray:"📥",incoming_envelope:"📨",tipping_hand_woman:"💁",information_source:"ℹ️",innocent:"😇",interrobang:"⁉️",iphone:"📱",izakaya_lantern:"🏮",jack_o_lantern:"🎃",japan:"🗾",japanese_castle:"🏯",japanese_goblin:"👺",japanese_ogre:"👹",jeans:"👖",joy:"😂",joy_cat:"😹",joystick:"🕹",kaaba:"🕋",key:"🔑",keyboard:"⌨️",keycap_ten:"🔟",kick_scooter:"🛴",kimono:"👘",kiss:"💋",kissing:"😗",kissing_cat:"😽",kissing_closed_eyes:"😚",kissing_heart:"😘",kissing_smiling_eyes:"😙",kiwi_fruit:"🥝",koala:"🐨",koko:"🈁",label:"🏷",large_blue_circle:"🔵",large_blue_diamond:"🔷",large_orange_diamond:"🔶",last_quarter_moon:"🌗",last_quarter_moon_with_face:"🌜",latin_cross:"✝️",laughing:"😆",leaves:"🍃",ledger:"📒",left_luggage:"🛅",left_right_arrow:"↔️",leftwards_arrow_with_hook:"↩️",lemon:"🍋",leo:"♌️",leopard:"🐆",level_slider:"🎚",libra:"♎️",light_rail:"🚈",link:"🔗",lion:"🦁",lips:"👄",lipstick:"💄",lizard:"🦎",lock:"🔒",lock_with_ink_pen:"🔏",lollipop:"🍭",loop:"➿",loud_sound:"🔊",loudspeaker:"📢",love_hotel:"🏩",love_letter:"💌",low_brightness:"🔅",lying_face:"🤥",m:"Ⓜ️",mag:"🔍",mag_right:"🔎",mahjong:"🀄️",mailbox:"📫",mailbox_closed:"📪",mailbox_with_mail:"📬",mailbox_with_no_mail:"📭",man:"👨",man_artist:"👨&zwj;🎨",man_astronaut:"👨&zwj;🚀",man_cartwheeling:"🤸&zwj;♂️",man_cook:"👨&zwj;🍳",man_dancing:"🕺",man_facepalming:"🤦&zwj;♂️",man_factory_worker:"👨&zwj;🏭",man_farmer:"👨&zwj;🌾",man_firefighter:"👨&zwj;🚒",man_health_worker:"👨&zwj;⚕️",man_in_tuxedo:"🤵",man_judge:"👨&zwj;⚖️",man_juggling:"🤹&zwj;♂️",man_mechanic:"👨&zwj;🔧",man_office_worker:"👨&zwj;💼",man_pilot:"👨&zwj;✈️",man_playing_handball:"🤾&zwj;♂️",man_playing_water_polo:"🤽&zwj;♂️",man_scientist:"👨&zwj;🔬",man_shrugging:"🤷&zwj;♂️",man_singer:"👨&zwj;🎤",man_student:"👨&zwj;🎓",man_teacher:"👨&zwj;🏫",man_technologist:"👨&zwj;💻",man_with_gua_pi_mao:"👲",man_with_turban:"👳",tangerine:"🍊",mans_shoe:"👞",mantelpiece_clock:"🕰",maple_leaf:"🍁",martial_arts_uniform:"🥋",mask:"😷",massage_woman:"💆",massage_man:"💆&zwj;♂️",meat_on_bone:"🍖",medal_military:"🎖",medal_sports:"🏅",mega:"📣",melon:"🍈",memo:"📝",men_wrestling:"🤼&zwj;♂️",menorah:"🕎",mens:"🚹",metal:"🤘",metro:"🚇",microphone:"🎤",microscope:"🔬",milk_glass:"🥛",milky_way:"🌌",minibus:"🚐",minidisc:"💽",mobile_phone_off:"📴",money_mouth_face:"🤑",money_with_wings:"💸",moneybag:"💰",monkey:"🐒",monkey_face:"🐵",monorail:"🚝",moon:"🌔",mortar_board:"🎓",mosque:"🕌",motor_boat:"🛥",motor_scooter:"🛵",motorcycle:"🏍",motorway:"🛣",mount_fuji:"🗻",mountain:"⛰",mountain_biking_man:"🚵",mountain_biking_woman:"🚵&zwj;♀️",mountain_cableway:"🚠",mountain_railway:"🚞",mountain_snow:"🏔",mouse:"🐭",mouse2:"🐁",movie_camera:"🎥",moyai:"🗿",mrs_claus:"🤶",muscle:"💪",mushroom:"🍄",musical_keyboard:"🎹",musical_note:"🎵",musical_score:"🎼",mute:"🔇",nail_care:"💅",name_badge:"📛",national_park:"🏞",nauseated_face:"🤢",necktie:"👔",negative_squared_cross_mark:"❎",nerd_face:"🤓",neutral_face:"😐",new:"🆕",new_moon:"🌑",new_moon_with_face:"🌚",newspaper:"📰",newspaper_roll:"🗞",next_track_button:"⏭",ng:"🆖",no_good_man:"🙅&zwj;♂️",no_good_woman:"🙅",night_with_stars:"🌃",no_bell:"🔕",no_bicycles:"🚳",no_entry:"⛔️",no_entry_sign:"🚫",no_mobile_phones:"📵",no_mouth:"😶",no_pedestrians:"🚷",no_smoking:"🚭","non-potable_water":"🚱",nose:"👃",notebook:"📓",notebook_with_decorative_cover:"📔",notes:"🎶",nut_and_bolt:"🔩",o:"⭕️",o2:"🅾️",ocean:"🌊",octopus:"🐙",oden:"🍢",office:"🏢",oil_drum:"🛢",ok:"🆗",ok_hand:"👌",ok_man:"🙆&zwj;♂️",ok_woman:"🙆",old_key:"🗝",older_man:"👴",older_woman:"👵",om:"🕉",on:"🔛",oncoming_automobile:"🚘",oncoming_bus:"🚍",oncoming_police_car:"🚔",oncoming_taxi:"🚖",open_file_folder:"📂",open_hands:"👐",open_mouth:"😮",open_umbrella:"☂️",ophiuchus:"⛎",orange_book:"📙",orthodox_cross:"☦️",outbox_tray:"📤",owl:"🦉",ox:"🐂",package:"📦",page_facing_up:"📄",page_with_curl:"📃",pager:"📟",paintbrush:"🖌",palm_tree:"🌴",pancakes:"🥞",panda_face:"🐼",paperclip:"📎",paperclips:"🖇",parasol_on_ground:"⛱",parking:"🅿️",part_alternation_mark:"〽️",partly_sunny:"⛅️",passenger_ship:"🛳",passport_control:"🛂",pause_button:"⏸",peace_symbol:"☮️",peach:"🍑",peanuts:"🥜",pear:"🍐",pen:"🖊",pencil2:"✏️",penguin:"🐧",pensive:"😔",performing_arts:"🎭",persevere:"😣",person_fencing:"🤺",pouting_woman:"🙎",phone:"☎️",pick:"⛏",pig:"🐷",pig2:"🐖",pig_nose:"🐽",pill:"💊",pineapple:"🍍",ping_pong:"🏓",pisces:"♓️",pizza:"🍕",place_of_worship:"🛐",plate_with_cutlery:"🍽",play_or_pause_button:"⏯",point_down:"👇",point_left:"👈",point_right:"👉",point_up:"☝️",point_up_2:"👆",police_car:"🚓",policewoman:"👮&zwj;♀️",poodle:"🐩",popcorn:"🍿",post_office:"🏣",postal_horn:"📯",postbox:"📮",potable_water:"🚰",potato:"🥔",pouch:"👝",poultry_leg:"🍗",pound:"💷",rage:"😡",pouting_cat:"😾",pouting_man:"🙎&zwj;♂️",pray:"🙏",prayer_beads:"📿",pregnant_woman:"🤰",previous_track_button:"⏮",prince:"🤴",princess:"👸",printer:"🖨",purple_heart:"💜",purse:"👛",pushpin:"📌",put_litter_in_its_place:"🚮",question:"❓",rabbit:"🐰",rabbit2:"🐇",racehorse:"🐎",racing_car:"🏎",radio:"📻",radio_button:"🔘",radioactive:"☢️",railway_car:"🚃",railway_track:"🛤",rainbow:"🌈",rainbow_flag:"🏳️&zwj;🌈",raised_back_of_hand:"🤚",raised_hand_with_fingers_splayed:"🖐",raised_hands:"🙌",raising_hand_woman:"🙋",raising_hand_man:"🙋&zwj;♂️",ram:"🐏",ramen:"🍜",rat:"🐀",record_button:"⏺",recycle:"♻️",red_circle:"🔴",registered:"®️",relaxed:"☺️",relieved:"😌",reminder_ribbon:"🎗",repeat:"🔁",repeat_one:"🔂",rescue_worker_helmet:"⛑",restroom:"🚻",revolving_hearts:"💞",rewind:"⏪",rhinoceros:"🦏",ribbon:"🎀",rice:"🍚",rice_ball:"🍙",rice_cracker:"🍘",rice_scene:"🎑",right_anger_bubble:"🗯",ring:"💍",robot:"🤖",rocket:"🚀",rofl:"🤣",roll_eyes:"🙄",roller_coaster:"🎢",rooster:"🐓",rose:"🌹",rosette:"🏵",rotating_light:"🚨",round_pushpin:"📍",rowing_man:"🚣",rowing_woman:"🚣&zwj;♀️",rugby_football:"🏉",running_man:"🏃",running_shirt_with_sash:"🎽",running_woman:"🏃&zwj;♀️",sa:"🈂️",sagittarius:"♐️",sake:"🍶",sandal:"👡",santa:"🎅",satellite:"📡",saxophone:"🎷",school:"🏫",school_satchel:"🎒",scissors:"✂️",scorpion:"🦂",scorpius:"♏️",scream:"😱",scream_cat:"🙀",scroll:"📜",seat:"💺",secret:"㊙️",see_no_evil:"🙈",seedling:"🌱",selfie:"🤳",shallow_pan_of_food:"🥘",shamrock:"☘️",shark:"🦈",shaved_ice:"🍧",sheep:"🐑",shell:"🐚",shield:"🛡",shinto_shrine:"⛩",ship:"🚢",shirt:"👕",shopping:"🛍",shopping_cart:"🛒",shower:"🚿",shrimp:"🦐",signal_strength:"📶",six_pointed_star:"🔯",ski:"🎿",skier:"⛷",skull:"💀",skull_and_crossbones:"☠️",sleeping:"😴",sleeping_bed:"🛌",sleepy:"😪",slightly_frowning_face:"🙁",slightly_smiling_face:"🙂",slot_machine:"🎰",small_airplane:"🛩",small_blue_diamond:"🔹",small_orange_diamond:"🔸",small_red_triangle:"🔺",small_red_triangle_down:"🔻",smile:"😄",smile_cat:"😸",smiley:"😃",smiley_cat:"😺",smiling_imp:"😈",smirk:"😏",smirk_cat:"😼",smoking:"🚬",snail:"🐌",snake:"🐍",sneezing_face:"🤧",snowboarder:"🏂",snowflake:"❄️",snowman:"⛄️",snowman_with_snow:"☃️",sob:"😭",soccer:"⚽️",soon:"🔜",sos:"🆘",sound:"🔉",space_invader:"👾",spades:"♠️",spaghetti:"🍝",sparkle:"❇️",sparkler:"🎇",sparkles:"✨",sparkling_heart:"💖",speak_no_evil:"🙊",speaker:"🔈",speaking_head:"🗣",speech_balloon:"💬",speedboat:"🚤",spider:"🕷",spider_web:"🕸",spiral_calendar:"🗓",spiral_notepad:"🗒",spoon:"🥄",squid:"🦑",stadium:"🏟",star:"⭐️",star2:"🌟",star_and_crescent:"☪️",star_of_david:"✡️",stars:"🌠",station:"🚉",statue_of_liberty:"🗽",steam_locomotive:"🚂",stew:"🍲",stop_button:"⏹",stop_sign:"🛑",stopwatch:"⏱",straight_ruler:"📏",strawberry:"🍓",stuck_out_tongue:"😛",stuck_out_tongue_closed_eyes:"😝",stuck_out_tongue_winking_eye:"😜",studio_microphone:"🎙",stuffed_flatbread:"🥙",sun_behind_large_cloud:"🌥",sun_behind_rain_cloud:"🌦",sun_behind_small_cloud:"🌤",sun_with_face:"🌞",sunflower:"🌻",sunglasses:"😎",sunny:"☀️",sunrise:"🌅",sunrise_over_mountains:"🌄",surfing_man:"🏄",surfing_woman:"🏄&zwj;♀️",sushi:"🍣",suspension_railway:"🚟",sweat:"😓",sweat_drops:"💦",sweat_smile:"😅",sweet_potato:"🍠",swimming_man:"🏊",swimming_woman:"🏊&zwj;♀️",symbols:"🔣",synagogue:"🕍",syringe:"💉",taco:"🌮",tada:"🎉",tanabata_tree:"🎋",taurus:"♉️",taxi:"🚕",tea:"🍵",telephone_receiver:"📞",telescope:"🔭",tennis:"🎾",tent:"⛺️",thermometer:"🌡",thinking:"🤔",thought_balloon:"💭",ticket:"🎫",tickets:"🎟",tiger:"🐯",tiger2:"🐅",timer_clock:"⏲",tipping_hand_man:"💁&zwj;♂️",tired_face:"😫",tm:"™️",toilet:"🚽",tokyo_tower:"🗼",tomato:"🍅",tongue:"👅",top:"🔝",tophat:"🎩",tornado:"🌪",trackball:"🖲",tractor:"🚜",traffic_light:"🚥",train:"🚋",train2:"🚆",tram:"🚊",triangular_flag_on_post:"🚩",triangular_ruler:"📐",trident:"🔱",triumph:"😤",trolleybus:"🚎",trophy:"🏆",tropical_drink:"🍹",tropical_fish:"🐠",truck:"🚚",trumpet:"🎺",tulip:"🌷",tumbler_glass:"🥃",turkey:"🦃",turtle:"🐢",tv:"📺",twisted_rightwards_arrows:"🔀",two_hearts:"💕",two_men_holding_hands:"👬",two_women_holding_hands:"👭",u5272:"🈹",u5408:"🈴",u55b6:"🈺",u6307:"🈯️",u6708:"🈷️",u6709:"🈶",u6e80:"🈵",u7121:"🈚️",u7533:"🈸",u7981:"🈲",u7a7a:"🈳",umbrella:"☔️",unamused:"😒",underage:"🔞",unicorn:"🦄",unlock:"🔓",up:"🆙",upside_down_face:"🙃",v:"✌️",vertical_traffic_light:"🚦",vhs:"📼",vibration_mode:"📳",video_camera:"📹",video_game:"🎮",violin:"🎻",virgo:"♍️",volcano:"🌋",volleyball:"🏐",vs:"🆚",vulcan_salute:"🖖",walking_man:"🚶",walking_woman:"🚶&zwj;♀️",waning_crescent_moon:"🌘",waning_gibbous_moon:"🌖",warning:"⚠️",wastebasket:"🗑",watch:"⌚️",water_buffalo:"🐃",watermelon:"🍉",wave:"👋",wavy_dash:"〰️",waxing_crescent_moon:"🌒",wc:"🚾",weary:"😩",wedding:"💒",weight_lifting_man:"🏋️",weight_lifting_woman:"🏋️&zwj;♀️",whale:"🐳",whale2:"🐋",wheel_of_dharma:"☸️",wheelchair:"♿️",white_check_mark:"✅",white_circle:"⚪️",white_flag:"🏳️",white_flower:"💮",white_large_square:"⬜️",white_medium_small_square:"◽️",white_medium_square:"◻️",white_small_square:"▫️",white_square_button:"🔳",wilted_flower:"🥀",wind_chime:"🎐",wind_face:"🌬",wine_glass:"🍷",wink:"😉",wolf:"🐺",woman:"👩",woman_artist:"👩&zwj;🎨",woman_astronaut:"👩&zwj;🚀",woman_cartwheeling:"🤸&zwj;♀️",woman_cook:"👩&zwj;🍳",woman_facepalming:"🤦&zwj;♀️",woman_factory_worker:"👩&zwj;🏭",woman_farmer:"👩&zwj;🌾",woman_firefighter:"👩&zwj;🚒",woman_health_worker:"👩&zwj;⚕️",woman_judge:"👩&zwj;⚖️",woman_juggling:"🤹&zwj;♀️",woman_mechanic:"👩&zwj;🔧",woman_office_worker:"👩&zwj;💼",woman_pilot:"👩&zwj;✈️",woman_playing_handball:"🤾&zwj;♀️",woman_playing_water_polo:"🤽&zwj;♀️",woman_scientist:"👩&zwj;🔬",woman_shrugging:"🤷&zwj;♀️",woman_singer:"👩&zwj;🎤",woman_student:"👩&zwj;🎓",woman_teacher:"👩&zwj;🏫",woman_technologist:"👩&zwj;💻",woman_with_turban:"👳&zwj;♀️",womans_clothes:"👚",womans_hat:"👒",women_wrestling:"🤼&zwj;♀️",womens:"🚺",world_map:"🗺",worried:"😟",wrench:"🔧",writing_hand:"✍️",x:"❌",yellow_heart:"💛",yen:"💴",yin_yang:"☯️",yum:"😋",zap:"⚡️",zipper_mouth_face:"🤐",zzz:"💤",octocat:'<img alt=":octocat:" height="20" width="20" align="absmiddle" src="https://assets-cdn.github.com/images/icons/emoji/octocat.png">',showdown:`<span style="font-family: 'Anonymous Pro', monospace; text-decoration: underline; text-decoration-style: dashed; text-decoration-color: #3e8b8a;text-underline-position: under;">S</span>`},n.Converter=function(r){var p={},u=[],h=[],T={},y=l,E={parsed:{},raw:"",format:""};I();function I(){r=r||{};for(var b in o)o.hasOwnProperty(b)&&(p[b]=o[b]);if(typeof r=="object")for(var x in r)r.hasOwnProperty(x)&&(p[x]=r[x]);else throw Error("Converter expects the passed parameter to be an object, but "+typeof r+" was passed instead.");p.extensions&&n.helper.forEach(p.extensions,C)}function C(b,x){if(x=x||null,n.helper.isString(b))if(b=n.helper.stdExtName(b),x=b,n.extensions[b]){console.warn("DEPRECATION WARNING: "+b+" is an old extension that uses a deprecated loading method.Please inform the developer that the extension should be updated!"),D(n.extensions[b],b);return}else if(!n.helper.isUndefined(s[b]))b=s[b];else throw Error('Extension "'+b+'" could not be loaded. It was either not found or is not a valid extension.');typeof b=="function"&&(b=b()),n.helper.isArray(b)||(b=[b]);var U=f(b,x);if(!U.valid)throw Error(U.error);for(var G=0;G<b.length;++G){switch(b[G].type){case"lang":u.push(b[G]);break;case"output":h.push(b[G]);break}if(b[G].hasOwnProperty("listeners"))for(var Q in b[G].listeners)b[G].listeners.hasOwnProperty(Q)&&A(Q,b[G].listeners[Q])}}function D(b,x){typeof b=="function"&&(b=b(new n.Converter)),n.helper.isArray(b)||(b=[b]);var U=f(b,x);if(!U.valid)throw Error(U.error);for(var G=0;G<b.length;++G)switch(b[G].type){case"lang":u.push(b[G]);break;case"output":h.push(b[G]);break;default:throw Error("Extension loader error: Type unrecognized!!!")}}function A(b,x){if(!n.helper.isString(b))throw Error("Invalid argument in converter.listen() method: name must be a string, but "+typeof b+" given");if(typeof x!="function")throw Error("Invalid argument in converter.listen() method: callback must be a function, but "+typeof x+" given");T.hasOwnProperty(b)||(T[b]=[]),T[b].push(x)}function P(b){var x=b.match(/^\s*/)[0].length,U=new RegExp("^\\s{0,"+x+"}","gm");return b.replace(U,"")}this._dispatch=function(x,U,G,Q){if(T.hasOwnProperty(x))for(var W=0;W<T[x].length;++W){var J=T[x][W](x,U,this,G,Q);J&&typeof J<"u"&&(U=J)}return U},this.listen=function(b,x){return A(b,x),this},this.makeHtml=function(b){if(!b)return b;var x={gHtmlBlocks:[],gHtmlMdBlocks:[],gHtmlSpans:[],gUrls:{},gTitles:{},gDimensions:{},gListLevel:0,hashLinkCounts:{},langExtensions:u,outputModifiers:h,converter:this,ghCodeBlocks:[],metadata:{parsed:{},raw:"",format:""}};return b=b.replace(/¨/g,"¨T"),b=b.replace(/\$/g,"¨D"),b=b.replace(/\r\n/g,`
`),b=b.replace(/\r/g,`
`),b=b.replace(/\u00A0/g,"&nbsp;"),p.smartIndentationFix&&(b=P(b)),b=`

`+b+`

`,b=n.subParser("detab")(b,p,x),b=b.replace(/^[ \t]+$/mg,""),n.helper.forEach(u,function(U){b=n.subParser("runExtension")(U,b,p,x)}),b=n.subParser("metadata")(b,p,x),b=n.subParser("hashPreCodeTags")(b,p,x),b=n.subParser("githubCodeBlocks")(b,p,x),b=n.subParser("hashHTMLBlocks")(b,p,x),b=n.subParser("hashCodeTags")(b,p,x),b=n.subParser("stripLinkDefinitions")(b,p,x),b=n.subParser("blockGamut")(b,p,x),b=n.subParser("unhashHTMLSpans")(b,p,x),b=n.subParser("unescapeSpecialChars")(b,p,x),b=b.replace(/¨D/g,"$$"),b=b.replace(/¨T/g,"¨"),b=n.subParser("completeHTMLDocument")(b,p,x),n.helper.forEach(h,function(U){b=n.subParser("runExtension")(U,b,p,x)}),E=x.metadata,b},this.makeMarkdown=this.makeMd=function(b,x){if(b=b.replace(/\r\n/g,`
`),b=b.replace(/\r/g,`
`),b=b.replace(/>[ \t]+</,">¨NBSP;<"),!x)if(window&&window.document)x=window.document;else throw new Error("HTMLParser is undefined. If in a webworker or nodejs environment, you need to provide a WHATWG DOM and HTML such as JSDOM");var U=x.createElement("div");U.innerHTML=b;var G={preList:oe(U)};re(U);for(var Q=U.childNodes,W="",J=0;J<Q.length;J++)W+=n.subParser("makeMarkdown.node")(Q[J],G);function re(ae){for(var ee=0;ee<ae.childNodes.length;++ee){var $=ae.childNodes[ee];$.nodeType===3?!/\S/.test($.nodeValue)&&!/^[ ]+$/.test($.nodeValue)?(ae.removeChild($),--ee):($.nodeValue=$.nodeValue.split(`
`).join(" "),$.nodeValue=$.nodeValue.replace(/(\s)+/g,"$1")):$.nodeType===1&&re($)}}function oe(ae){for(var ee=ae.querySelectorAll("pre"),$=[],X=0;X<ee.length;++X)if(ee[X].childElementCount===1&&ee[X].firstChild.tagName.toLowerCase()==="code"){var j=ee[X].firstChild.innerHTML.trim(),se=ee[X].firstChild.getAttribute("data-language")||"";if(se==="")for(var ie=ee[X].firstChild.className.split(" "),ce=0;ce<ie.length;++ce){var ye=ie[ce].match(/^language-(.+)$/);if(ye!==null){se=ye[1];break}}j=n.helper.unescapeHTMLEntities(j),$.push(j),ee[X].outerHTML='<precode language="'+se+'" precodenum="'+X.toString()+'"></precode>'}else $.push(ee[X].innerHTML),ee[X].innerHTML="",ee[X].setAttribute("prenum",X.toString());return $}return W},this.setOption=function(b,x){p[b]=x},this.getOption=function(b){return p[b]},this.getOptions=function(){return p},this.addExtension=function(b,x){x=x||null,C(b,x)},this.useExtension=function(b){C(b)},this.setFlavor=function(b){if(!c.hasOwnProperty(b))throw Error(b+" flavor was not found");var x=c[b];y=b;for(var U in x)x.hasOwnProperty(U)&&(p[U]=x[U])},this.getFlavor=function(){return y},this.removeExtension=function(b){n.helper.isArray(b)||(b=[b]);for(var x=0;x<b.length;++x){for(var U=b[x],G=0;G<u.length;++G)u[G]===U&&u.splice(G,1);for(var Q=0;Q<h.length;++Q)h[Q]===U&&h.splice(Q,1)}},this.getAllExtensions=function(){return{language:u,output:h}},this.getMetadata=function(b){return b?E.raw:E.parsed},this.getMetadataFormat=function(){return E.format},this._setMetadataPair=function(b,x){E.parsed[b]=x},this._setMetadataFormat=function(b){E.format=b},this._setMetadataRaw=function(b){E.raw=b}},n.subParser("anchors",function(r,p,u){r=u.converter._dispatch("anchors.before",r,p,u);var h=function(T,y,E,I,C,D,A){if(n.helper.isUndefined(A)&&(A=""),E=E.toLowerCase(),T.search(/\(<?\s*>? ?(['"].*['"])?\)$/m)>-1)I="";else if(!I)if(E||(E=y.toLowerCase().replace(/ ?\n/g," ")),I="#"+E,!n.helper.isUndefined(u.gUrls[E]))I=u.gUrls[E],n.helper.isUndefined(u.gTitles[E])||(A=u.gTitles[E]);else return T;I=I.replace(n.helper.regexes.asteriskDashAndColon,n.helper.escapeCharactersCallback);var P='<a href="'+I+'"';return A!==""&&A!==null&&(A=A.replace(/"/g,"&quot;"),A=A.replace(n.helper.regexes.asteriskDashAndColon,n.helper.escapeCharactersCallback),P+=' title="'+A+'"'),p.openLinksInNewWindow&&!/^#/.test(I)&&(P+=' rel="noopener noreferrer" target="¨E95Eblank"'),P+=">"+y+"</a>",P};return r=r.replace(/\[((?:\[[^\]]*]|[^\[\]])*)] ?(?:\n *)?\[(.*?)]()()()()/g,h),r=r.replace(/\[((?:\[[^\]]*]|[^\[\]])*)]()[ \t]*\([ \t]?<([^>]*)>(?:[ \t]*((["'])([^"]*?)\5))?[ \t]?\)/g,h),r=r.replace(/\[((?:\[[^\]]*]|[^\[\]])*)]()[ \t]*\([ \t]?<?([\S]+?(?:\([\S]*?\)[\S]*?)?)>?(?:[ \t]*((["'])([^"]*?)\5))?[ \t]?\)/g,h),r=r.replace(/\[([^\[\]]+)]()()()()()/g,h),p.ghMentions&&(r=r.replace(/(^|\s)(\\)?(@([a-z\d]+(?:[a-z\d.-]+?[a-z\d]+)*))/gmi,function(T,y,E,I,C){if(E==="\\")return y+I;if(!n.helper.isString(p.ghMentionsLink))throw new Error("ghMentionsLink option must be a string");var D=p.ghMentionsLink.replace(/\{u}/g,C),A="";return p.openLinksInNewWindow&&(A=' rel="noopener noreferrer" target="¨E95Eblank"'),y+'<a href="'+D+'"'+A+">"+I+"</a>"})),r=u.converter._dispatch("anchors.after",r,p,u),r});var S=/([*~_]+|\b)(((https?|ftp|dict):\/\/|www\.)[^'">\s]+?\.[^'">\s]+?)()(\1)?(?=\s|$)(?!["<>])/gi,O=/([*~_]+|\b)(((https?|ftp|dict):\/\/|www\.)[^'">\s]+\.[^'">\s]+?)([.!?,()\[\]])?(\1)?(?=\s|$)(?!["<>])/gi,k=/()<(((https?|ftp|dict):\/\/|www\.)[^'">\s]+)()>()/gi,L=/(^|\s)(?:mailto:)?([A-Za-z0-9!#$%&'*+-/=?^_`{|}~.]+@[-a-z0-9]+(\.[-a-z0-9]+)*\.[a-z]+)(?=$|\s)/gmi,R=/<()(?:mailto:)?([-.\w]+@[-a-z0-9]+(\.[-a-z0-9]+)*\.[a-z]+)>/gi,F=function(r){return function(p,u,h,T,y,E,I){h=h.replace(n.helper.regexes.asteriskDashAndColon,n.helper.escapeCharactersCallback);var C=h,D="",A="",P=u||"",b=I||"";return/^www\./i.test(h)&&(h=h.replace(/^www\./i,"http://www.")),r.excludeTrailingPunctuationFromURLs&&E&&(D=E),r.openLinksInNewWindow&&(A=' rel="noopener noreferrer" target="¨E95Eblank"'),P+'<a href="'+h+'"'+A+">"+C+"</a>"+D+b}},M=function(r,p){return function(u,h,T){var y="mailto:";return h=h||"",T=n.subParser("unescapeSpecialChars")(T,r,p),r.encodeEmails?(y=n.helper.encodeEmailAddress(y+T),T=n.helper.encodeEmailAddress(T)):y=y+T,h+'<a href="'+y+'">'+T+"</a>"}};n.subParser("autoLinks",function(r,p,u){return r=u.converter._dispatch("autoLinks.before",r,p,u),r=r.replace(k,F(p)),r=r.replace(R,M(p,u)),r=u.converter._dispatch("autoLinks.after",r,p,u),r}),n.subParser("simplifiedAutoLinks",function(r,p,u){return p.simplifiedAutoLink&&(r=u.converter._dispatch("simplifiedAutoLinks.before",r,p,u),p.excludeTrailingPunctuationFromURLs?r=r.replace(O,F(p)):r=r.replace(S,F(p)),r=r.replace(L,M(p,u)),r=u.converter._dispatch("simplifiedAutoLinks.after",r,p,u)),r}),n.subParser("blockGamut",function(r,p,u){return r=u.converter._dispatch("blockGamut.before",r,p,u),r=n.subParser("blockQuotes")(r,p,u),r=n.subParser("headers")(r,p,u),r=n.subParser("horizontalRule")(r,p,u),r=n.subParser("lists")(r,p,u),r=n.subParser("codeBlocks")(r,p,u),r=n.subParser("tables")(r,p,u),r=n.subParser("hashHTMLBlocks")(r,p,u),r=n.subParser("paragraphs")(r,p,u),r=u.converter._dispatch("blockGamut.after",r,p,u),r}),n.subParser("blockQuotes",function(r,p,u){r=u.converter._dispatch("blockQuotes.before",r,p,u),r=r+`

`;var h=/(^ {0,3}>[ \t]?.+\n(.+\n)*\n*)+/gm;return p.splitAdjacentBlockquotes&&(h=/^ {0,3}>[\s\S]*?(?:\n\n)/gm),r=r.replace(h,function(T){return T=T.replace(/^[ \t]*>[ \t]?/gm,""),T=T.replace(/¨0/g,""),T=T.replace(/^[ \t]+$/gm,""),T=n.subParser("githubCodeBlocks")(T,p,u),T=n.subParser("blockGamut")(T,p,u),T=T.replace(/(^|\n)/g,"$1  "),T=T.replace(/(\s*<pre>[^\r]+?<\/pre>)/gm,function(y,E){var I=E;return I=I.replace(/^  /mg,"¨0"),I=I.replace(/¨0/g,""),I}),n.subParser("hashBlock")(`<blockquote>
`+T+`
</blockquote>`,p,u)}),r=u.converter._dispatch("blockQuotes.after",r,p,u),r}),n.subParser("codeBlocks",function(r,p,u){r=u.converter._dispatch("codeBlocks.before",r,p,u),r+="¨0";var h=/(?:\n\n|^)((?:(?:[ ]{4}|\t).*\n+)+)(\n*[ ]{0,3}[^ \t\n]|(?=¨0))/g;return r=r.replace(h,function(T,y,E){var I=y,C=E,D=`
`;return I=n.subParser("outdent")(I,p,u),I=n.subParser("encodeCode")(I,p,u),I=n.subParser("detab")(I,p,u),I=I.replace(/^\n+/g,""),I=I.replace(/\n+$/g,""),p.omitExtraWLInCodeBlocks&&(D=""),I="<pre><code>"+I+D+"</code></pre>",n.subParser("hashBlock")(I,p,u)+C}),r=r.replace(/¨0/,""),r=u.converter._dispatch("codeBlocks.after",r,p,u),r}),n.subParser("codeSpans",function(r,p,u){return r=u.converter._dispatch("codeSpans.before",r,p,u),typeof r>"u"&&(r=""),r=r.replace(/(^|[^\\])(`+)([^\r]*?[^`])\2(?!`)/gm,function(h,T,y,E){var I=E;return I=I.replace(/^([ \t]*)/g,""),I=I.replace(/[ \t]*$/g,""),I=n.subParser("encodeCode")(I,p,u),I=T+"<code>"+I+"</code>",I=n.subParser("hashHTMLSpans")(I,p,u),I}),r=u.converter._dispatch("codeSpans.after",r,p,u),r}),n.subParser("completeHTMLDocument",function(r,p,u){if(!p.completeHTMLDocument)return r;r=u.converter._dispatch("completeHTMLDocument.before",r,p,u);var h="html",T=`<!DOCTYPE HTML>
`,y="",E=`<meta charset="utf-8">
`,I="",C="";typeof u.metadata.parsed.doctype<"u"&&(T="<!DOCTYPE "+u.metadata.parsed.doctype+`>
`,h=u.metadata.parsed.doctype.toString().toLowerCase(),(h==="html"||h==="html5")&&(E='<meta charset="utf-8">'));for(var D in u.metadata.parsed)if(u.metadata.parsed.hasOwnProperty(D))switch(D.toLowerCase()){case"doctype":break;case"title":y="<title>"+u.metadata.parsed.title+`</title>
`;break;case"charset":h==="html"||h==="html5"?E='<meta charset="'+u.metadata.parsed.charset+`">
`:E='<meta name="charset" content="'+u.metadata.parsed.charset+`">
`;break;case"language":case"lang":I=' lang="'+u.metadata.parsed[D]+'"',C+='<meta name="'+D+'" content="'+u.metadata.parsed[D]+`">
`;break;default:C+='<meta name="'+D+'" content="'+u.metadata.parsed[D]+`">
`}return r=T+"<html"+I+`>
<head>
`+y+E+C+`</head>
<body>
`+r.trim()+`
</body>
</html>`,r=u.converter._dispatch("completeHTMLDocument.after",r,p,u),r}),n.subParser("detab",function(r,p,u){return r=u.converter._dispatch("detab.before",r,p,u),r=r.replace(/\t(?=\t)/g,"    "),r=r.replace(/\t/g,"¨A¨B"),r=r.replace(/¨B(.+?)¨A/g,function(h,T){for(var y=T,E=4-y.length%4,I=0;I<E;I++)y+=" ";return y}),r=r.replace(/¨A/g,"    "),r=r.replace(/¨B/g,""),r=u.converter._dispatch("detab.after",r,p,u),r}),n.subParser("ellipsis",function(r,p,u){return p.ellipsis&&(r=u.converter._dispatch("ellipsis.before",r,p,u),r=r.replace(/\.\.\./g,"…"),r=u.converter._dispatch("ellipsis.after",r,p,u)),r}),n.subParser("emoji",function(r,p,u){if(!p.emoji)return r;r=u.converter._dispatch("emoji.before",r,p,u);var h=/:([\S]+?):/g;return r=r.replace(h,function(T,y){return n.helper.emojis.hasOwnProperty(y)?n.helper.emojis[y]:T}),r=u.converter._dispatch("emoji.after",r,p,u),r}),n.subParser("encodeAmpsAndAngles",function(r,p,u){return r=u.converter._dispatch("encodeAmpsAndAngles.before",r,p,u),r=r.replace(/&(?!#?[xX]?(?:[0-9a-fA-F]+|\w+);)/g,"&amp;"),r=r.replace(/<(?![a-z\/?$!])/gi,"&lt;"),r=r.replace(/</g,"&lt;"),r=r.replace(/>/g,"&gt;"),r=u.converter._dispatch("encodeAmpsAndAngles.after",r,p,u),r}),n.subParser("encodeBackslashEscapes",function(r,p,u){return r=u.converter._dispatch("encodeBackslashEscapes.before",r,p,u),r=r.replace(/\\(\\)/g,n.helper.escapeCharactersCallback),r=r.replace(/\\([`*_{}\[\]()>#+.!~=|:-])/g,n.helper.escapeCharactersCallback),r=u.converter._dispatch("encodeBackslashEscapes.after",r,p,u),r}),n.subParser("encodeCode",function(r,p,u){return r=u.converter._dispatch("encodeCode.before",r,p,u),r=r.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/([*_{}\[\]\\=~-])/g,n.helper.escapeCharactersCallback),r=u.converter._dispatch("encodeCode.after",r,p,u),r}),n.subParser("escapeSpecialCharsWithinTagAttributes",function(r,p,u){r=u.converter._dispatch("escapeSpecialCharsWithinTagAttributes.before",r,p,u);var h=/<\/?[a-z\d_:-]+(?:[\s]+[\s\S]+?)?>/gi,T=/<!(--(?:(?:[^>-]|-[^>])(?:[^-]|-[^-])*)--)>/gi;return r=r.replace(h,function(y){return y.replace(/(.)<\/?code>(?=.)/g,"$1`").replace(/([\\`*_~=|])/g,n.helper.escapeCharactersCallback)}),r=r.replace(T,function(y){return y.replace(/([\\`*_~=|])/g,n.helper.escapeCharactersCallback)}),r=u.converter._dispatch("escapeSpecialCharsWithinTagAttributes.after",r,p,u),r}),n.subParser("githubCodeBlocks",function(r,p,u){return p.ghCodeBlocks?(r=u.converter._dispatch("githubCodeBlocks.before",r,p,u),r+="¨0",r=r.replace(/(?:^|\n)(?: {0,3})(```+|~~~+)(?: *)([^\s`~]*)\n([\s\S]*?)\n(?: {0,3})\1/g,function(h,T,y,E){var I=p.omitExtraWLInCodeBlocks?"":`
`;return E=n.subParser("encodeCode")(E,p,u),E=n.subParser("detab")(E,p,u),E=E.replace(/^\n+/g,""),E=E.replace(/\n+$/g,""),E="<pre><code"+(y?' class="'+y+" language-"+y+'"':"")+">"+E+I+"</code></pre>",E=n.subParser("hashBlock")(E,p,u),`

¨G`+(u.ghCodeBlocks.push({text:h,codeblock:E})-1)+`G

`}),r=r.replace(/¨0/,""),u.converter._dispatch("githubCodeBlocks.after",r,p,u)):r}),n.subParser("hashBlock",function(r,p,u){return r=u.converter._dispatch("hashBlock.before",r,p,u),r=r.replace(/(^\n+|\n+$)/g,""),r=`

¨K`+(u.gHtmlBlocks.push(r)-1)+`K

`,r=u.converter._dispatch("hashBlock.after",r,p,u),r}),n.subParser("hashCodeTags",function(r,p,u){r=u.converter._dispatch("hashCodeTags.before",r,p,u);var h=function(T,y,E,I){var C=E+n.subParser("encodeCode")(y,p,u)+I;return"¨C"+(u.gHtmlSpans.push(C)-1)+"C"};return r=n.helper.replaceRecursiveRegExp(r,h,"<code\\b[^>]*>","</code>","gim"),r=u.converter._dispatch("hashCodeTags.after",r,p,u),r}),n.subParser("hashElement",function(r,p,u){return function(h,T){var y=T;return y=y.replace(/\n\n/g,`
`),y=y.replace(/^\n/,""),y=y.replace(/\n+$/g,""),y=`

¨K`+(u.gHtmlBlocks.push(y)-1)+`K

`,y}}),n.subParser("hashHTMLBlocks",function(r,p,u){r=u.converter._dispatch("hashHTMLBlocks.before",r,p,u);var h=["pre","div","h1","h2","h3","h4","h5","h6","blockquote","table","dl","ol","ul","script","noscript","form","fieldset","iframe","math","style","section","header","footer","nav","article","aside","address","audio","canvas","figure","hgroup","output","video","p"],T=function(b,x,U,G){var Q=b;return U.search(/\bmarkdown\b/)!==-1&&(Q=U+u.converter.makeHtml(x)+G),`

¨K`+(u.gHtmlBlocks.push(Q)-1)+`K

`};p.backslashEscapesHTMLTags&&(r=r.replace(/\\<(\/?[^>]+?)>/g,function(b,x){return"&lt;"+x+"&gt;"}));for(var y=0;y<h.length;++y)for(var E,I=new RegExp("^ {0,3}(<"+h[y]+"\\b[^>]*>)","im"),C="<"+h[y]+"\\b[^>]*>",D="</"+h[y]+">";(E=n.helper.regexIndexOf(r,I))!==-1;){var A=n.helper.splitAtIndex(r,E),P=n.helper.replaceRecursiveRegExp(A[1],T,C,D,"im");if(P===A[1])break;r=A[0].concat(P)}return r=r.replace(/(\n {0,3}(<(hr)\b([^<>])*?\/?>)[ \t]*(?=\n{2,}))/g,n.subParser("hashElement")(r,p,u)),r=n.helper.replaceRecursiveRegExp(r,function(b){return`

¨K`+(u.gHtmlBlocks.push(b)-1)+`K

`},"^ {0,3}<!--","-->","gm"),r=r.replace(/(?:\n\n)( {0,3}(?:<([?%])[^\r]*?\2>)[ \t]*(?=\n{2,}))/g,n.subParser("hashElement")(r,p,u)),r=u.converter._dispatch("hashHTMLBlocks.after",r,p,u),r}),n.subParser("hashHTMLSpans",function(r,p,u){r=u.converter._dispatch("hashHTMLSpans.before",r,p,u);function h(T){return"¨C"+(u.gHtmlSpans.push(T)-1)+"C"}return r=r.replace(/<[^>]+?\/>/gi,function(T){return h(T)}),r=r.replace(/<([^>]+?)>[\s\S]*?<\/\1>/g,function(T){return h(T)}),r=r.replace(/<([^>]+?)\s[^>]+?>[\s\S]*?<\/\1>/g,function(T){return h(T)}),r=r.replace(/<[^>]+?>/gi,function(T){return h(T)}),r=u.converter._dispatch("hashHTMLSpans.after",r,p,u),r}),n.subParser("unhashHTMLSpans",function(r,p,u){r=u.converter._dispatch("unhashHTMLSpans.before",r,p,u);for(var h=0;h<u.gHtmlSpans.length;++h){for(var T=u.gHtmlSpans[h],y=0;/¨C(\d+)C/.test(T);){var E=RegExp.$1;if(T=T.replace("¨C"+E+"C",u.gHtmlSpans[E]),y===10){console.error("maximum nesting of 10 spans reached!!!");break}++y}r=r.replace("¨C"+h+"C",T)}return r=u.converter._dispatch("unhashHTMLSpans.after",r,p,u),r}),n.subParser("hashPreCodeTags",function(r,p,u){r=u.converter._dispatch("hashPreCodeTags.before",r,p,u);var h=function(T,y,E,I){var C=E+n.subParser("encodeCode")(y,p,u)+I;return`

¨G`+(u.ghCodeBlocks.push({text:T,codeblock:C})-1)+`G

`};return r=n.helper.replaceRecursiveRegExp(r,h,"^ {0,3}<pre\\b[^>]*>\\s*<code\\b[^>]*>","^ {0,3}</code>\\s*</pre>","gim"),r=u.converter._dispatch("hashPreCodeTags.after",r,p,u),r}),n.subParser("headers",function(r,p,u){r=u.converter._dispatch("headers.before",r,p,u);var h=isNaN(parseInt(p.headerLevelStart))?1:parseInt(p.headerLevelStart),T=p.smoothLivePreview?/^(.+)[ \t]*\n={2,}[ \t]*\n+/gm:/^(.+)[ \t]*\n=+[ \t]*\n+/gm,y=p.smoothLivePreview?/^(.+)[ \t]*\n-{2,}[ \t]*\n+/gm:/^(.+)[ \t]*\n-+[ \t]*\n+/gm;r=r.replace(T,function(C,D){var A=n.subParser("spanGamut")(D,p,u),P=p.noHeaderId?"":' id="'+I(D)+'"',b=h,x="<h"+b+P+">"+A+"</h"+b+">";return n.subParser("hashBlock")(x,p,u)}),r=r.replace(y,function(C,D){var A=n.subParser("spanGamut")(D,p,u),P=p.noHeaderId?"":' id="'+I(D)+'"',b=h+1,x="<h"+b+P+">"+A+"</h"+b+">";return n.subParser("hashBlock")(x,p,u)});var E=p.requireSpaceBeforeHeadingText?/^(#{1,6})[ \t]+(.+?)[ \t]*#*\n+/gm:/^(#{1,6})[ \t]*(.+?)[ \t]*#*\n+/gm;r=r.replace(E,function(C,D,A){var P=A;p.customizedHeaderId&&(P=A.replace(/\s?\{([^{]+?)}\s*$/,""));var b=n.subParser("spanGamut")(P,p,u),x=p.noHeaderId?"":' id="'+I(A)+'"',U=h-1+D.length,G="<h"+U+x+">"+b+"</h"+U+">";return n.subParser("hashBlock")(G,p,u)});function I(C){var D,A;if(p.customizedHeaderId){var P=C.match(/\{([^{]+?)}\s*$/);P&&P[1]&&(C=P[1])}return D=C,n.helper.isString(p.prefixHeaderId)?A=p.prefixHeaderId:p.prefixHeaderId===!0?A="section-":A="",p.rawPrefixHeaderId||(D=A+D),p.ghCompatibleHeaderId?D=D.replace(/ /g,"-").replace(/&amp;/g,"").replace(/¨T/g,"").replace(/¨D/g,"").replace(/[&+$,\/:;=?@"#{}|^¨~\[\]`\\*)(%.!'<>]/g,"").toLowerCase():p.rawHeaderId?D=D.replace(/ /g,"-").replace(/&amp;/g,"&").replace(/¨T/g,"¨").replace(/¨D/g,"$").replace(/["']/g,"-").toLowerCase():D=D.replace(/[^\w]/g,"").toLowerCase(),p.rawPrefixHeaderId&&(D=A+D),u.hashLinkCounts[D]?D=D+"-"+u.hashLinkCounts[D]++:u.hashLinkCounts[D]=1,D}return r=u.converter._dispatch("headers.after",r,p,u),r}),n.subParser("horizontalRule",function(r,p,u){r=u.converter._dispatch("horizontalRule.before",r,p,u);var h=n.subParser("hashBlock")("<hr />",p,u);return r=r.replace(/^ {0,2}( ?-){3,}[ \t]*$/gm,h),r=r.replace(/^ {0,2}( ?\*){3,}[ \t]*$/gm,h),r=r.replace(/^ {0,2}( ?_){3,}[ \t]*$/gm,h),r=u.converter._dispatch("horizontalRule.after",r,p,u),r}),n.subParser("images",function(r,p,u){r=u.converter._dispatch("images.before",r,p,u);var h=/!\[([^\]]*?)][ \t]*()\([ \t]?<?([\S]+?(?:\([\S]*?\)[\S]*?)?)>?(?: =([*\d]+[A-Za-z%]{0,4})x([*\d]+[A-Za-z%]{0,4}))?[ \t]*(?:(["'])([^"]*?)\6)?[ \t]?\)/g,T=/!\[([^\]]*?)][ \t]*()\([ \t]?<([^>]*)>(?: =([*\d]+[A-Za-z%]{0,4})x([*\d]+[A-Za-z%]{0,4}))?[ \t]*(?:(?:(["'])([^"]*?)\6))?[ \t]?\)/g,y=/!\[([^\]]*?)][ \t]*()\([ \t]?<?(data:.+?\/.+?;base64,[A-Za-z0-9+/=\n]+?)>?(?: =([*\d]+[A-Za-z%]{0,4})x([*\d]+[A-Za-z%]{0,4}))?[ \t]*(?:(["'])([^"]*?)\6)?[ \t]?\)/g,E=/!\[([^\]]*?)] ?(?:\n *)?\[([\s\S]*?)]()()()()()/g,I=/!\[([^\[\]]+)]()()()()()/g;function C(A,P,b,x,U,G,Q,W){return x=x.replace(/\s/g,""),D(A,P,b,x,U,G,Q,W)}function D(A,P,b,x,U,G,Q,W){var J=u.gUrls,re=u.gTitles,oe=u.gDimensions;if(b=b.toLowerCase(),W||(W=""),A.search(/\(<?\s*>? ?(['"].*['"])?\)$/m)>-1)x="";else if(x===""||x===null)if((b===""||b===null)&&(b=P.toLowerCase().replace(/ ?\n/g," ")),x="#"+b,!n.helper.isUndefined(J[b]))x=J[b],n.helper.isUndefined(re[b])||(W=re[b]),n.helper.isUndefined(oe[b])||(U=oe[b].width,G=oe[b].height);else return A;P=P.replace(/"/g,"&quot;").replace(n.helper.regexes.asteriskDashAndColon,n.helper.escapeCharactersCallback),x=x.replace(n.helper.regexes.asteriskDashAndColon,n.helper.escapeCharactersCallback);var ae='<img src="'+x+'" alt="'+P+'"';return W&&n.helper.isString(W)&&(W=W.replace(/"/g,"&quot;").replace(n.helper.regexes.asteriskDashAndColon,n.helper.escapeCharactersCallback),ae+=' title="'+W+'"'),U&&G&&(U=U==="*"?"auto":U,G=G==="*"?"auto":G,ae+=' width="'+U+'"',ae+=' height="'+G+'"'),ae+=" />",ae}return r=r.replace(E,D),r=r.replace(y,C),r=r.replace(T,D),r=r.replace(h,D),r=r.replace(I,D),r=u.converter._dispatch("images.after",r,p,u),r}),n.subParser("italicsAndBold",function(r,p,u){r=u.converter._dispatch("italicsAndBold.before",r,p,u);function h(T,y,E){return y+T+E}return p.literalMidWordUnderscores?(r=r.replace(/\b___(\S[\s\S]*?)___\b/g,function(T,y){return h(y,"<strong><em>","</em></strong>")}),r=r.replace(/\b__(\S[\s\S]*?)__\b/g,function(T,y){return h(y,"<strong>","</strong>")}),r=r.replace(/\b_(\S[\s\S]*?)_\b/g,function(T,y){return h(y,"<em>","</em>")})):(r=r.replace(/___(\S[\s\S]*?)___/g,function(T,y){return/\S$/.test(y)?h(y,"<strong><em>","</em></strong>"):T}),r=r.replace(/__(\S[\s\S]*?)__/g,function(T,y){return/\S$/.test(y)?h(y,"<strong>","</strong>"):T}),r=r.replace(/_([^\s_][\s\S]*?)_/g,function(T,y){return/\S$/.test(y)?h(y,"<em>","</em>"):T})),p.literalMidWordAsterisks?(r=r.replace(/([^*]|^)\B\*\*\*(\S[\s\S]*?)\*\*\*\B(?!\*)/g,function(T,y,E){return h(E,y+"<strong><em>","</em></strong>")}),r=r.replace(/([^*]|^)\B\*\*(\S[\s\S]*?)\*\*\B(?!\*)/g,function(T,y,E){return h(E,y+"<strong>","</strong>")}),r=r.replace(/([^*]|^)\B\*(\S[\s\S]*?)\*\B(?!\*)/g,function(T,y,E){return h(E,y+"<em>","</em>")})):(r=r.replace(/\*\*\*(\S[\s\S]*?)\*\*\*/g,function(T,y){return/\S$/.test(y)?h(y,"<strong><em>","</em></strong>"):T}),r=r.replace(/\*\*(\S[\s\S]*?)\*\*/g,function(T,y){return/\S$/.test(y)?h(y,"<strong>","</strong>"):T}),r=r.replace(/\*([^\s*][\s\S]*?)\*/g,function(T,y){return/\S$/.test(y)?h(y,"<em>","</em>"):T})),r=u.converter._dispatch("italicsAndBold.after",r,p,u),r}),n.subParser("lists",function(r,p,u){function h(E,I){u.gListLevel++,E=E.replace(/\n{2,}$/,`
`),E+="¨0";var C=/(\n)?(^ {0,3})([*+-]|\d+[.])[ \t]+((\[(x|X| )?])?[ \t]*[^\r]+?(\n{1,2}))(?=\n*(¨0| {0,3}([*+-]|\d+[.])[ \t]+))/gm,D=/\n[ \t]*\n(?!¨0)/.test(E);return p.disableForced4SpacesIndentedSublists&&(C=/(\n)?(^ {0,3})([*+-]|\d+[.])[ \t]+((\[(x|X| )?])?[ \t]*[^\r]+?(\n{1,2}))(?=\n*(¨0|\2([*+-]|\d+[.])[ \t]+))/gm),E=E.replace(C,function(A,P,b,x,U,G,Q){Q=Q&&Q.trim()!=="";var W=n.subParser("outdent")(U,p,u),J="";return G&&p.tasklists&&(J=' class="task-list-item" style="list-style-type: none;"',W=W.replace(/^[ \t]*\[(x|X| )?]/m,function(){var re='<input type="checkbox" disabled style="margin: 0px 0.35em 0.25em -1.6em; vertical-align: middle;"';return Q&&(re+=" checked"),re+=">",re})),W=W.replace(/^([-*+]|\d\.)[ \t]+[\S\n ]*/g,function(re){return"¨A"+re}),P||W.search(/\n{2,}/)>-1?(W=n.subParser("githubCodeBlocks")(W,p,u),W=n.subParser("blockGamut")(W,p,u)):(W=n.subParser("lists")(W,p,u),W=W.replace(/\n$/,""),W=n.subParser("hashHTMLBlocks")(W,p,u),W=W.replace(/\n\n+/g,`

`),D?W=n.subParser("paragraphs")(W,p,u):W=n.subParser("spanGamut")(W,p,u)),W=W.replace("¨A",""),W="<li"+J+">"+W+`</li>
`,W}),E=E.replace(/¨0/g,""),u.gListLevel--,I&&(E=E.replace(/\s+$/,"")),E}function T(E,I){if(I==="ol"){var C=E.match(/^ *(\d+)\./);if(C&&C[1]!=="1")return' start="'+C[1]+'"'}return""}function y(E,I,C){var D=p.disableForced4SpacesIndentedSublists?/^ ?\d+\.[ \t]/gm:/^ {0,3}\d+\.[ \t]/gm,A=p.disableForced4SpacesIndentedSublists?/^ ?[*+-][ \t]/gm:/^ {0,3}[*+-][ \t]/gm,P=I==="ul"?D:A,b="";if(E.search(P)!==-1)(function U(G){var Q=G.search(P),W=T(E,I);Q!==-1?(b+=`

<`+I+W+`>
`+h(G.slice(0,Q),!!C)+"</"+I+`>
`,I=I==="ul"?"ol":"ul",P=I==="ul"?D:A,U(G.slice(Q))):b+=`

<`+I+W+`>
`+h(G,!!C)+"</"+I+`>
`})(E);else{var x=T(E,I);b=`

<`+I+x+`>
`+h(E,!!C)+"</"+I+`>
`}return b}return r=u.converter._dispatch("lists.before",r,p,u),r+="¨0",u.gListLevel?r=r.replace(/^(( {0,3}([*+-]|\d+[.])[ \t]+)[^\r]+?(¨0|\n{2,}(?=\S)(?![ \t]*(?:[*+-]|\d+[.])[ \t]+)))/gm,function(E,I,C){var D=C.search(/[*+-]/g)>-1?"ul":"ol";return y(I,D,!0)}):r=r.replace(/(\n\n|^\n?)(( {0,3}([*+-]|\d+[.])[ \t]+)[^\r]+?(¨0|\n{2,}(?=\S)(?![ \t]*(?:[*+-]|\d+[.])[ \t]+)))/gm,function(E,I,C,D){var A=D.search(/[*+-]/g)>-1?"ul":"ol";return y(C,A,!1)}),r=r.replace(/¨0/,""),r=u.converter._dispatch("lists.after",r,p,u),r}),n.subParser("metadata",function(r,p,u){if(!p.metadata)return r;r=u.converter._dispatch("metadata.before",r,p,u);function h(T){u.metadata.raw=T,T=T.replace(/&/g,"&amp;").replace(/"/g,"&quot;"),T=T.replace(/\n {4}/g," "),T.replace(/^([\S ]+): +([\s\S]+?)$/gm,function(y,E,I){return u.metadata.parsed[E]=I,""})}return r=r.replace(/^\s*«««+(\S*?)\n([\s\S]+?)\n»»»+\n/,function(T,y,E){return h(E),"¨M"}),r=r.replace(/^\s*---+(\S*?)\n([\s\S]+?)\n---+\n/,function(T,y,E){return y&&(u.metadata.format=y),h(E),"¨M"}),r=r.replace(/¨M/g,""),r=u.converter._dispatch("metadata.after",r,p,u),r}),n.subParser("outdent",function(r,p,u){return r=u.converter._dispatch("outdent.before",r,p,u),r=r.replace(/^(\t|[ ]{1,4})/gm,"¨0"),r=r.replace(/¨0/g,""),r=u.converter._dispatch("outdent.after",r,p,u),r}),n.subParser("paragraphs",function(r,p,u){r=u.converter._dispatch("paragraphs.before",r,p,u),r=r.replace(/^\n+/g,""),r=r.replace(/\n+$/g,"");for(var h=r.split(/\n{2,}/g),T=[],y=h.length,E=0;E<y;E++){var I=h[E];I.search(/¨(K|G)(\d+)\1/g)>=0?T.push(I):I.search(/\S/)>=0&&(I=n.subParser("spanGamut")(I,p,u),I=I.replace(/^([ \t]*)/g,"<p>"),I+="</p>",T.push(I))}for(y=T.length,E=0;E<y;E++){for(var C="",D=T[E],A=!1;/¨(K|G)(\d+)\1/.test(D);){var P=RegExp.$1,b=RegExp.$2;P==="K"?C=u.gHtmlBlocks[b]:A?C=n.subParser("encodeCode")(u.ghCodeBlocks[b].text,p,u):C=u.ghCodeBlocks[b].codeblock,C=C.replace(/\$/g,"$$$$"),D=D.replace(/(\n\n)?¨(K|G)\d+\2(\n\n)?/,C),/^<pre\b[^>]*>\s*<code\b[^>]*>/.test(D)&&(A=!0)}T[E]=D}return r=T.join(`
`),r=r.replace(/^\n+/g,""),r=r.replace(/\n+$/g,""),u.converter._dispatch("paragraphs.after",r,p,u)}),n.subParser("runExtension",function(r,p,u,h){if(r.filter)p=r.filter(p,h.converter,u);else if(r.regex){var T=r.regex;T instanceof RegExp||(T=new RegExp(T,"g")),p=p.replace(T,r.replace)}return p}),n.subParser("spanGamut",function(r,p,u){return r=u.converter._dispatch("spanGamut.before",r,p,u),r=n.subParser("codeSpans")(r,p,u),r=n.subParser("escapeSpecialCharsWithinTagAttributes")(r,p,u),r=n.subParser("encodeBackslashEscapes")(r,p,u),r=n.subParser("images")(r,p,u),r=n.subParser("anchors")(r,p,u),r=n.subParser("autoLinks")(r,p,u),r=n.subParser("simplifiedAutoLinks")(r,p,u),r=n.subParser("emoji")(r,p,u),r=n.subParser("underline")(r,p,u),r=n.subParser("italicsAndBold")(r,p,u),r=n.subParser("strikethrough")(r,p,u),r=n.subParser("ellipsis")(r,p,u),r=n.subParser("hashHTMLSpans")(r,p,u),r=n.subParser("encodeAmpsAndAngles")(r,p,u),p.simpleLineBreaks?/\n\n¨K/.test(r)||(r=r.replace(/\n+/g,`<br />
`)):r=r.replace(/  +\n/g,`<br />
`),r=u.converter._dispatch("spanGamut.after",r,p,u),r}),n.subParser("strikethrough",function(r,p,u){function h(T){return p.simplifiedAutoLink&&(T=n.subParser("simplifiedAutoLinks")(T,p,u)),"<del>"+T+"</del>"}return p.strikethrough&&(r=u.converter._dispatch("strikethrough.before",r,p,u),r=r.replace(/(?:~){2}([\s\S]+?)(?:~){2}/g,function(T,y){return h(y)}),r=u.converter._dispatch("strikethrough.after",r,p,u)),r}),n.subParser("stripLinkDefinitions",function(r,p,u){var h=/^ {0,3}\[([^\]]+)]:[ \t]*\n?[ \t]*<?([^>\s]+)>?(?: =([*\d]+[A-Za-z%]{0,4})x([*\d]+[A-Za-z%]{0,4}))?[ \t]*\n?[ \t]*(?:(\n*)["|'(](.+?)["|')][ \t]*)?(?:\n+|(?=¨0))/gm,T=/^ {0,3}\[([^\]]+)]:[ \t]*\n?[ \t]*<?(data:.+?\/.+?;base64,[A-Za-z0-9+/=\n]+?)>?(?: =([*\d]+[A-Za-z%]{0,4})x([*\d]+[A-Za-z%]{0,4}))?[ \t]*\n?[ \t]*(?:(\n*)["|'(](.+?)["|')][ \t]*)?(?:\n\n|(?=¨0)|(?=\n\[))/gm;r+="¨0";var y=function(E,I,C,D,A,P,b){return I=I.toLowerCase(),r.toLowerCase().split(I).length-1<2?E:(C.match(/^data:.+?\/.+?;base64,/)?u.gUrls[I]=C.replace(/\s/g,""):u.gUrls[I]=n.subParser("encodeAmpsAndAngles")(C,p,u),P?P+b:(b&&(u.gTitles[I]=b.replace(/"|'/g,"&quot;")),p.parseImgDimensions&&D&&A&&(u.gDimensions[I]={width:D,height:A}),""))};return r=r.replace(T,y),r=r.replace(h,y),r=r.replace(/¨0/,""),r}),n.subParser("tables",function(r,p,u){if(!p.tables)return r;var h=/^ {0,3}\|?.+\|.+\n {0,3}\|?[ \t]*:?[ \t]*(?:[-=]){2,}[ \t]*:?[ \t]*\|[ \t]*:?[ \t]*(?:[-=]){2,}[\s\S]+?(?:\n\n|¨0)/gm,T=/^ {0,3}\|.+\|[ \t]*\n {0,3}\|[ \t]*:?[ \t]*(?:[-=]){2,}[ \t]*:?[ \t]*\|[ \t]*\n( {0,3}\|.+\|[ \t]*\n)*(?:\n|¨0)/gm;function y(A){return/^:[ \t]*--*$/.test(A)?' style="text-align:left;"':/^--*[ \t]*:[ \t]*$/.test(A)?' style="text-align:right;"':/^:[ \t]*--*[ \t]*:$/.test(A)?' style="text-align:center;"':""}function E(A,P){var b="";return A=A.trim(),(p.tablesHeaderId||p.tableHeaderId)&&(b=' id="'+A.replace(/ /g,"_").toLowerCase()+'"'),A=n.subParser("spanGamut")(A,p,u),"<th"+b+P+">"+A+`</th>
`}function I(A,P){var b=n.subParser("spanGamut")(A,p,u);return"<td"+P+">"+b+`</td>
`}function C(A,P){for(var b=`<table>
<thead>
<tr>
`,x=A.length,U=0;U<x;++U)b+=A[U];for(b+=`</tr>
</thead>
<tbody>
`,U=0;U<P.length;++U){b+=`<tr>
`;for(var G=0;G<x;++G)b+=P[U][G];b+=`</tr>
`}return b+=`</tbody>
</table>
`,b}function D(A){var P,b=A.split(`
`);for(P=0;P<b.length;++P)/^ {0,3}\|/.test(b[P])&&(b[P]=b[P].replace(/^ {0,3}\|/,"")),/\|[ \t]*$/.test(b[P])&&(b[P]=b[P].replace(/\|[ \t]*$/,"")),b[P]=n.subParser("codeSpans")(b[P],p,u);var x=b[0].split("|").map(function(ae){return ae.trim()}),U=b[1].split("|").map(function(ae){return ae.trim()}),G=[],Q=[],W=[],J=[];for(b.shift(),b.shift(),P=0;P<b.length;++P)b[P].trim()!==""&&G.push(b[P].split("|").map(function(ae){return ae.trim()}));if(x.length<U.length)return A;for(P=0;P<U.length;++P)W.push(y(U[P]));for(P=0;P<x.length;++P)n.helper.isUndefined(W[P])&&(W[P]=""),Q.push(E(x[P],W[P]));for(P=0;P<G.length;++P){for(var re=[],oe=0;oe<Q.length;++oe)n.helper.isUndefined(G[P][oe]),re.push(I(G[P][oe],W[oe]));J.push(re)}return C(Q,J)}return r=u.converter._dispatch("tables.before",r,p,u),r=r.replace(/\\(\|)/g,n.helper.escapeCharactersCallback),r=r.replace(h,D),r=r.replace(T,D),r=u.converter._dispatch("tables.after",r,p,u),r}),n.subParser("underline",function(r,p,u){return p.underline&&(r=u.converter._dispatch("underline.before",r,p,u),p.literalMidWordUnderscores?(r=r.replace(/\b___(\S[\s\S]*?)___\b/g,function(h,T){return"<u>"+T+"</u>"}),r=r.replace(/\b__(\S[\s\S]*?)__\b/g,function(h,T){return"<u>"+T+"</u>"})):(r=r.replace(/___(\S[\s\S]*?)___/g,function(h,T){return/\S$/.test(T)?"<u>"+T+"</u>":h}),r=r.replace(/__(\S[\s\S]*?)__/g,function(h,T){return/\S$/.test(T)?"<u>"+T+"</u>":h})),r=r.replace(/(_)/g,n.helper.escapeCharactersCallback),r=u.converter._dispatch("underline.after",r,p,u)),r}),n.subParser("unescapeSpecialChars",function(r,p,u){return r=u.converter._dispatch("unescapeSpecialChars.before",r,p,u),r=r.replace(/¨E(\d+)E/g,function(h,T){var y=parseInt(T);return String.fromCharCode(y)}),r=u.converter._dispatch("unescapeSpecialChars.after",r,p,u),r}),n.subParser("makeMarkdown.blockquote",function(r,p){var u="";if(r.hasChildNodes())for(var h=r.childNodes,T=h.length,y=0;y<T;++y){var E=n.subParser("makeMarkdown.node")(h[y],p);E!==""&&(u+=E)}return u=u.trim(),u="> "+u.split(`
`).join(`
> `),u}),n.subParser("makeMarkdown.codeBlock",function(r,p){var u=r.getAttribute("language"),h=r.getAttribute("precodenum");return"```"+u+`
`+p.preList[h]+"\n```"}),n.subParser("makeMarkdown.codeSpan",function(r){return"`"+r.innerHTML+"`"}),n.subParser("makeMarkdown.emphasis",function(r,p){var u="";if(r.hasChildNodes()){u+="*";for(var h=r.childNodes,T=h.length,y=0;y<T;++y)u+=n.subParser("makeMarkdown.node")(h[y],p);u+="*"}return u}),n.subParser("makeMarkdown.header",function(r,p,u){var h=new Array(u+1).join("#"),T="";if(r.hasChildNodes()){T=h+" ";for(var y=r.childNodes,E=y.length,I=0;I<E;++I)T+=n.subParser("makeMarkdown.node")(y[I],p)}return T}),n.subParser("makeMarkdown.hr",function(){return"---"}),n.subParser("makeMarkdown.image",function(r){var p="";return r.hasAttribute("src")&&(p+="!["+r.getAttribute("alt")+"](",p+="<"+r.getAttribute("src")+">",r.hasAttribute("width")&&r.hasAttribute("height")&&(p+=" ="+r.getAttribute("width")+"x"+r.getAttribute("height")),r.hasAttribute("title")&&(p+=' "'+r.getAttribute("title")+'"'),p+=")"),p}),n.subParser("makeMarkdown.links",function(r,p){var u="";if(r.hasChildNodes()&&r.hasAttribute("href")){var h=r.childNodes,T=h.length;u="[";for(var y=0;y<T;++y)u+=n.subParser("makeMarkdown.node")(h[y],p);u+="](",u+="<"+r.getAttribute("href")+">",r.hasAttribute("title")&&(u+=' "'+r.getAttribute("title")+'"'),u+=")"}return u}),n.subParser("makeMarkdown.list",function(r,p,u){var h="";if(!r.hasChildNodes())return"";for(var T=r.childNodes,y=T.length,E=r.getAttribute("start")||1,I=0;I<y;++I)if(!(typeof T[I].tagName>"u"||T[I].tagName.toLowerCase()!=="li")){var C="";u==="ol"?C=E.toString()+". ":C="- ",h+=C+n.subParser("makeMarkdown.listItem")(T[I],p),++E}return h+=`
<!-- -->
`,h.trim()}),n.subParser("makeMarkdown.listItem",function(r,p){for(var u="",h=r.childNodes,T=h.length,y=0;y<T;++y)u+=n.subParser("makeMarkdown.node")(h[y],p);return/\n$/.test(u)?u=u.split(`
`).join(`
    `).replace(/^ {4}$/gm,"").replace(/\n\n+/g,`

`):u+=`
`,u}),n.subParser("makeMarkdown.node",function(r,p,u){u=u||!1;var h="";if(r.nodeType===3)return n.subParser("makeMarkdown.txt")(r,p);if(r.nodeType===8)return"<!--"+r.data+`-->

`;if(r.nodeType!==1)return"";var T=r.tagName.toLowerCase();switch(T){case"h1":u||(h=n.subParser("makeMarkdown.header")(r,p,1)+`

`);break;case"h2":u||(h=n.subParser("makeMarkdown.header")(r,p,2)+`

`);break;case"h3":u||(h=n.subParser("makeMarkdown.header")(r,p,3)+`

`);break;case"h4":u||(h=n.subParser("makeMarkdown.header")(r,p,4)+`

`);break;case"h5":u||(h=n.subParser("makeMarkdown.header")(r,p,5)+`

`);break;case"h6":u||(h=n.subParser("makeMarkdown.header")(r,p,6)+`

`);break;case"p":u||(h=n.subParser("makeMarkdown.paragraph")(r,p)+`

`);break;case"blockquote":u||(h=n.subParser("makeMarkdown.blockquote")(r,p)+`

`);break;case"hr":u||(h=n.subParser("makeMarkdown.hr")(r,p)+`

`);break;case"ol":u||(h=n.subParser("makeMarkdown.list")(r,p,"ol")+`

`);break;case"ul":u||(h=n.subParser("makeMarkdown.list")(r,p,"ul")+`

`);break;case"precode":u||(h=n.subParser("makeMarkdown.codeBlock")(r,p)+`

`);break;case"pre":u||(h=n.subParser("makeMarkdown.pre")(r,p)+`

`);break;case"table":u||(h=n.subParser("makeMarkdown.table")(r,p)+`

`);break;case"code":h=n.subParser("makeMarkdown.codeSpan")(r,p);break;case"em":case"i":h=n.subParser("makeMarkdown.emphasis")(r,p);break;case"strong":case"b":h=n.subParser("makeMarkdown.strong")(r,p);break;case"del":h=n.subParser("makeMarkdown.strikethrough")(r,p);break;case"a":h=n.subParser("makeMarkdown.links")(r,p);break;case"img":h=n.subParser("makeMarkdown.image")(r,p);break;default:h=r.outerHTML+`

`}return h}),n.subParser("makeMarkdown.paragraph",function(r,p){var u="";if(r.hasChildNodes())for(var h=r.childNodes,T=h.length,y=0;y<T;++y)u+=n.subParser("makeMarkdown.node")(h[y],p);return u=u.trim(),u}),n.subParser("makeMarkdown.pre",function(r,p){var u=r.getAttribute("prenum");return"<pre>"+p.preList[u]+"</pre>"}),n.subParser("makeMarkdown.strikethrough",function(r,p){var u="";if(r.hasChildNodes()){u+="~~";for(var h=r.childNodes,T=h.length,y=0;y<T;++y)u+=n.subParser("makeMarkdown.node")(h[y],p);u+="~~"}return u}),n.subParser("makeMarkdown.strong",function(r,p){var u="";if(r.hasChildNodes()){u+="**";for(var h=r.childNodes,T=h.length,y=0;y<T;++y)u+=n.subParser("makeMarkdown.node")(h[y],p);u+="**"}return u}),n.subParser("makeMarkdown.table",function(r,p){var u="",h=[[],[]],T=r.querySelectorAll("thead>tr>th"),y=r.querySelectorAll("tbody>tr"),E,I;for(E=0;E<T.length;++E){var C=n.subParser("makeMarkdown.tableCell")(T[E],p),D="---";if(T[E].hasAttribute("style")){var A=T[E].getAttribute("style").toLowerCase().replace(/\s/g,"");switch(A){case"text-align:left;":D=":---";break;case"text-align:right;":D="---:";break;case"text-align:center;":D=":---:";break}}h[0][E]=C.trim(),h[1][E]=D}for(E=0;E<y.length;++E){var P=h.push([])-1,b=y[E].getElementsByTagName("td");for(I=0;I<T.length;++I){var x=" ";typeof b[I]<"u"&&(x=n.subParser("makeMarkdown.tableCell")(b[I],p)),h[P].push(x)}}var U=3;for(E=0;E<h.length;++E)for(I=0;I<h[E].length;++I){var G=h[E][I].length;G>U&&(U=G)}for(E=0;E<h.length;++E){for(I=0;I<h[E].length;++I)E===1?h[E][I].slice(-1)===":"?h[E][I]=n.helper.padEnd(h[E][I].slice(-1),U-1,"-")+":":h[E][I]=n.helper.padEnd(h[E][I],U,"-"):h[E][I]=n.helper.padEnd(h[E][I],U);u+="| "+h[E].join(" | ")+` |
`}return u.trim()}),n.subParser("makeMarkdown.tableCell",function(r,p){var u="";if(!r.hasChildNodes())return"";for(var h=r.childNodes,T=h.length,y=0;y<T;++y)u+=n.subParser("makeMarkdown.node")(h[y],p,!0);return u.trim()}),n.subParser("makeMarkdown.txt",function(r){var p=r.nodeValue;return p=p.replace(/ +/g," "),p=p.replace(/¨NBSP;/g," "),p=n.helper.unescapeHTMLEntities(p),p=p.replace(/([*_~|`])/g,"\\$1"),p=p.replace(/^(\s*)>/g,"\\$1>"),p=p.replace(/^#/gm,"\\#"),p=p.replace(/^(\s*)([-=]{3,})(\s*)$/,"$1\\$2$3"),p=p.replace(/^( {0,3}\d+)\./gm,"$1\\."),p=p.replace(/^( {0,3})([+-])/gm,"$1\\$2"),p=p.replace(/]([\s]*)\(/g,"\\]$1\\("),p=p.replace(/^ {0,3}\[([\S \t]*?)]:/gm,"\\[$1]:"),p});var z=this;a.exports?a.exports=n:z.showdown=n}).call(hr)})(mi);var mr=mi.exports;function vr(a){return a.type==="CURVE"}function yr(a){return a.type==="IMAGE"}function ya(a,e){return Math.round(a/e)*e}function Ea(a,e){return Math.floor(a/e)*e}function Yn(a){return a*(Math.PI/180)}function Er(a){return a*(180/Math.PI)}function Ia(a,e,t){return a*(1-t)+e*t}class dt{static magnitudeSquared(e){return e.x*e.x+e.y*e.y}static magnitude(e){const t=Math.sqrt(this.magnitudeSquared(e));return isNaN(t)?0:t}static normalize(e){const t=this.magnitude(e);return t===0?{x:0,y:0}:this.divide(e,t)}static dot(e,t){return e.x*t.x+e.y*t.y}static subtract(e,t){return typeof t=="number"?{x:e.x-t,y:e.y-t}:{x:e.x-t.x,y:e.y-t.y}}static add(e,t){return typeof t=="number"?{x:e.x+t,y:e.y+t}:{x:e.x+t.x,y:e.y+t.y}}static multiply(e,t){return typeof t=="number"?{x:e.x*t,y:e.y*t}:{x:e.x*t.x,y:e.y*t.y}}static divide(e,t){return typeof t=="number"?{x:e.x/t,y:e.y/t}:{x:e.x/t.x,y:e.y/t.y}}static rotate(e,t,n){const i=Math.cos(Yn(n)),s=Math.sin(Yn(n)),o=this.subtract(e,t);return{x:t.x+i*o.x-s*o.y,y:t.y+s*o.x+i*o.y}}static min(e,t){return typeof t=="number"?{x:Math.min(e.x,t),y:Math.min(e.y,t)}:{x:Math.min(e.x,t.x),y:Math.min(e.y,t.y)}}static componentMin(e){return e.x<e.y?e.x:e.y}static max(e,t){return typeof t=="number"?{x:Math.max(e.x,t),y:Math.max(e.y,t)}:{x:Math.max(e.x,t.x),y:Math.max(e.y,t.y)}}static componentMax(e){return e.x>e.y?e.x:e.y}static roundTo(e,t){return{x:ya(e.x,t.x),y:ya(e.y,t.y)}}static floorTo(e,t){return{x:Ea(e.x,t.x),y:Ea(e.y,t.y)}}static sign(e){return{x:Math.sign(e.x),y:Math.sign(e.y)}}static abs(e){return{x:Math.abs(e.x),y:Math.abs(e.y)}}static pow(e,t){return typeof t=="number"?{x:Math.pow(e.x,t),y:Math.pow(e.y,t)}:{x:Math.pow(e.x,t.x),y:Math.pow(e.y,t.y)}}static clamp(e,t,n){return{x:Math.min(Math.max(e.x,t),n),y:Math.min(Math.max(e.y,t),n)}}static boundingBox(e){let t=Number.MAX_SAFE_INTEGER,n=Number.MIN_SAFE_INTEGER,i=Number.MAX_SAFE_INTEGER,s=Number.MIN_SAFE_INTEGER;for(let f of e)t=f.x<t?f.x:t,n=f.x>n?f.x:n,i=f.y<i?f.y:i,s=f.y>s?f.y:s;let o=n-t,l=s-i,c={x:(t+n)/2,y:(i+s)/2};return{min:{x:t,y:i},max:{x:n,y:s},width:o,height:l,center:c}}static pointInPolygon(e,t){const n=this.boundingBox(t);if(e.x<n.min.x||e.x>n.max.x||e.y<n.min.y||e.y>n.max.y)return!1;let i=!1;for(let s=0,o=t.length-1;s<t.length;o=s++){const l=t[s].y>e.y,c=t[o].y>e.y;l!==c&&e.x<(t[o].x-t[s].x)*(e.y-t[s].y)/(t[o].y-t[s].y)+t[s].x&&(i=!i)}return i}static compare(e,t,n){return this.magnitudeSquared(this.subtract(e,t))<n*n}static distance(e,t){return this.magnitude(this.subtract(e,t))}static lerp(e,t,n){return{x:Ia(e.x,t.x,n),y:Ia(e.y,t.y,n)}}static centroid(e){let t={x:0,y:0};for(let n of e)t.x+=n.x,t.y+=n.y;return e.length>0&&(t={x:t.x/e.length,y:t.y/e.length}),t}}class Ke{static inverse(e){const[t,n,i,s,o,l,c,f,g]=e,v=t*(o*g-f*l)-n*(s*g-l*c)+i*(s*f-o*c);if(Math.abs(v)<1e-14)return e;const S=1/v,O=(o*g-f*l)*S,k=(i*f-n*g)*S,L=(n*l-i*o)*S,R=(l*c-s*g)*S,F=(t*g-i*c)*S,M=(s*i-t*l)*S,z=(s*f-c*o)*S,r=(c*n-t*f)*S,p=(t*o-s*n)*S;return[O,k,L,R,F,M,z,r,p]}static multiply(e,t){return[e[0]*t[0]+e[1]*t[3]+e[2]*t[6],e[0]*t[1]+e[1]*t[4]+e[2]*t[7],e[0]*t[2]+e[1]*t[5]+e[2]*t[8],e[3]*t[0]+e[4]*t[3]+e[5]*t[6],e[3]*t[1]+e[4]*t[4]+e[5]*t[7],e[3]*t[2]+e[4]*t[5]+e[5]*t[8],e[6]*t[0]+e[7]*t[3]+e[8]*t[6],e[6]*t[1]+e[7]*t[4]+e[8]*t[7],e[6]*t[2]+e[7]*t[5]+e[8]*t[8]]}static fromPosition(e){return[1,0,e.x,0,1,e.y,0,0,1]}static fromRotation(e){const t=Yn(e);return[Math.cos(t),-Math.sin(t),0,Math.sin(t),Math.cos(t),0,0,0,1]}static fromScale(e){return[e.x,0,0,0,e.y,0,0,0,1]}static fromItem(e){const t=Ke.fromPosition(e.position),n=Ke.fromScale(e.scale),i=Ke.fromRotation(e.rotation);return Ke.multiply(Ke.multiply(t,i),n)}static decompose(e){const[t,n,i,s,o,l]=e,c=t*o-s*n,f={position:{x:i,y:l},rotation:0,scale:{x:1,y:1}};if(t!=0||s!=0){var g=Math.sqrt(t*t+s*s);f.rotation=s>0?Math.acos(t/g):-Math.acos(t/g),f.scale={x:g,y:c/g}}else if(n!=0||o!=0){var v=Math.sqrt(n*n+o*o);f.rotation=Math.PI/2-(o>0?Math.acos(-n/v):-Math.acos(n/v)),f.scale={x:c/v,y:v}}return f.rotation=Er(f.rotation),f}}var vi={exports:{}};(function(a){(function(){function e(l,c){var f=l.x-c.x,g=l.y-c.y;return f*f+g*g}function t(l,c,f){var g=c.x,v=c.y,S=f.x-g,O=f.y-v;if(S!==0||O!==0){var k=((l.x-g)*S+(l.y-v)*O)/(S*S+O*O);k>1?(g=f.x,v=f.y):k>0&&(g+=S*k,v+=O*k)}return S=l.x-g,O=l.y-v,S*S+O*O}function n(l,c){for(var f=l[0],g=[f],v,S=1,O=l.length;S<O;S++)v=l[S],e(v,f)>c&&(g.push(v),f=v);return f!==v&&g.push(v),g}function i(l,c,f,g,v){for(var S=g,O,k=c+1;k<f;k++){var L=t(l[k],l[c],l[f]);L>S&&(O=k,S=L)}S>g&&(O-c>1&&i(l,c,O,g,v),v.push(l[O]),f-O>1&&i(l,O,f,g,v))}function s(l,c){var f=l.length-1,g=[l[0]];return i(l,0,f,c,g),g.push(l[f]),g}function o(l,c,f){if(l.length<=2)return l;var g=c!==void 0?c*c:1;return l=f?l:n(l,g),l=s(l,g),l}a.exports=o,a.exports.default=o})()})(vi);var Ir=vi.exports;const yi=gr(Ir);function Cn(){return`${d.EXTENSIONID}/Persistence/${m.playerId}/${m.sceneId}`}function wr(){const a=document.createElement("img");return a.id="PatreonButton",a.setAttribute("class","icon"),a.classList.add("patreon-clickable"),a.setAttribute("title",m.USER_REGISTERED?"Thanks for subscribing!":"Get the news on updates on the Battle-System Patreon"),a.setAttribute("src",m.USER_REGISTERED?"/w-thankyou.svg":"/w-patreon-2.png"),a.onclick=async function(e){e.preventDefault(),window.open("https://www.patreon.com/battlesystem","_blank")},a}function Ln(a,e,t={curveSegments:10}){const n=[],{curveSegments:i}=t,s=a.length*i;n.length=s;let o=0;function l(c,f){o<s?(n[o]={x:c+e.x,y:f+e.y},o++):n.push({x:c+e.x,y:f+e.y})}for(const c of a){if(c.length<1)throw new Error("Invalid command array: empty array");const f=c[0],g={[me.MOVE]:3,[me.LINE]:3,[me.QUAD]:5,[me.CONIC]:6,[me.CUBIC]:7,[me.CLOSE]:1}[f];if(g===void 0)throw new Error(`Unknown command type: ${f}`);if(c.length!==g)throw new Error(`Invalid command length for type ${f}: expected ${g}, got ${c.length}`);switch(f){case me.MOVE:{const[v,S,O]=c;l(S,O);break}case me.LINE:{const[v,S,O]=c;l(S,O);break}case me.QUAD:{const[v,S,O,k,L]=c,R=n[o-1];if(!R)throw new Error("No starting point for QUAD command");const F={x:R.x-e.x,y:R.y-e.y},M={x:S,y:O},z={x:k,y:L};for(let r=1;r<=i;r++){const p=r/i,u=br(p,F,M,z);l(u.x,u.y)}break}case me.CONIC:{const[v,S,O,k,L,R]=c,F=n[o-1];if(!F)throw new Error("No starting point for CONIC command");const M={x:F.x-e.x,y:F.y-e.y},z={x:S,y:O},r={x:k,y:L};for(let p=1;p<=i;p++){const u=p/i,h=Tr(u,M,z,r,R);l(h.x,h.y)}break}case me.CUBIC:{const[v,S,O,k,L,R,F]=c,M=n[o-1];if(!M)throw new Error("No starting point for CUBIC command");const z={x:M.x-e.x,y:M.y-e.y},r={x:S,y:O},p={x:k,y:L},u={x:R,y:F};for(let h=1;h<=i;h++){const T=h/i,y=Sr(T,z,r,p,u);l(y.x,y.y)}break}case me.CLOSE:{if(o>0){const v=n[0];l(v.x-e.x,v.y-e.y)}break}}}return n.length=o,yi(n)}const br=(a,e,t,n)=>{const i=1-a,s=a*a,o=i*i;return{x:o*e.x+2*i*a*t.x+s*n.x,y:o*e.y+2*i*a*t.y+s*n.y}},Tr=(a,e,t,n,i)=>{const s=1-a,o=s*s+2*s*a*i+a*a;return{x:(s*s*e.x+2*s*a*i*t.x+a*a*n.x)/o,y:(s*s*e.y+2*s*a*i*t.y+a*a*n.y)/o}},Sr=(a,e,t,n,i)=>{const s=1-a,o=a*a,l=s*s,c=l*s,f=o*a;return{x:c*e.x+3*l*a*t.x+3*s*o*n.x+f*i.x,y:c*e.y+3*l*a*t.y+3*s*o*n.y+f*i.y}};function gn(a,e){const t=a.x-e.x,n=a.y-e.y;return Math.sqrt(t*t+n*n)}function wa(a,e){let t=!1;const n=e.length;let i=e[0];for(let s=1;s<=n;s++){const o=e[s%n];if(a.y>Math.min(i.y,o.y)&&a.y<=Math.max(i.y,o.y)&&a.x<=Math.max(i.x,o.x)&&i.y!=o.y){const l=(a.y-i.y)*(o.x-i.x)/(o.y-i.y)+i.x;(i.x==o.x||a.x<=l)&&(t=!t)}i=o}return t}function Nr(a,e){const t=a.points,n=e.points;if(t.length!==n.length)return!1;for(let i=0;i<t.length;i++)if(t[i].x!==n[i].x||t[i].y!==n[i].y)return!1;return!0}function Mn(a){a=a.replace(/^#/,"");let e=parseInt(a,16),t=e>>16&255,n=e>>8&255,i=e&255;return{x:t/255,y:n/255,z:i/255}}function Or(a,e=!1){if(a.indexOf("#")===0&&(a=a.slice(1)),a.length===3&&(a=a[0]+a[0]+a[1]+a[1]+a[2]+a[2]),a.length!==6)throw new Error("Invalid HEX color.");var t=parseInt(a.slice(0,2),16),n=parseInt(a.slice(2,4),16),i=parseInt(a.slice(4,6),16);return e?t*.299+n*.587+i*.114>186?"#000000":"#FFFFFF":(t=(255-t).toString(16),n=(255-n).toString(16),i=(255-i).toString(16),"#"+$n(t)+$n(n)+$n(i))}function $n(a,e=0){e=e||2;var t=new Array(e).join("0");return(t+a).slice(-e)}function ba(a,e){const t=window.matchMedia("(prefers-color-scheme: dark)"),n=t.matches?"dark":"light",i=t.matches?"light":"dark";for(var s=0;s<e.styleSheets.length;s++)for(var o=0;o<e.styleSheets[s].cssRules.length;o++){let l=e.styleSheets[s].cssRules[o];l&&l.media&&l.media.mediaText.includes("prefers-color-scheme")&&(a.mode=="LIGHT"?(l.media.appendMedium(`(prefers-color-scheme: ${n})`),l.media.mediaText.includes(i)&&l.media.deleteMedium(`(prefers-color-scheme: ${i})`)):a.mode=="DARK"&&(l.media.appendMedium(`(prefers-color-scheme: ${i})`),l.media.mediaText.includes(n)&&l.media.deleteMedium(`(prefers-color-scheme: ${n})`)))}}function be(){const a=m.sceneMetadata[`${d.EXTENSIONID}/toolWidth`],e=a!==void 0?parseInt(a):NaN;return Number.isNaN(e)?d.DEFAULTLINEWIDTH:e}function $e(){const a=m.sceneMetadata[`${d.EXTENSIONID}/visionRangeDefault`];return a||d.ATTENUATIONDEFAULT}function ze(){const a=m.sceneMetadata[`${d.EXTENSIONID}/visionSourceDefault`];return a||d.SOURCEDEFAULT}function at(){const a=m.sceneMetadata[`${d.EXTENSIONID}/visionFallOffDefault`];return a||d.FALLOFFDEFAULT}function mn(){const a=m.sceneMetadata[`${d.EXTENSIONID}/visionDarkDefault`];return a||d.DARKVISIONDEFAULT}function lt(){const a=m.sceneMetadata[`${d.EXTENSIONID}/visionInAngleDefault`];return a||d.INANGLEDEFAULT}function Ze(){const a=m.sceneMetadata[`${d.EXTENSIONID}/visionOutAngleDefault`];return a||d.OUTANGLEDEFAULT}function _r(a,e,t,n,i){const s=[[],[]];let o={x:0,y:0},l={x:0,y:0},c=-1,f=-1,g=1/0,v=1/0;const S=Na(a,n,i);for(let F=0;F<S.length-1;F++){const M=S[F],z=S[F+1],r=Ta(M,z,e),p=Ta(M,z,t),u=gn(e,r),h=gn(t,p);u<g&&(c=F,o=r,g=u),h<v&&(f=F,l=p,v=h)}(c>f||c===f&&Sa(o,S[c],S[c+1])>Sa(l,S[f],S[f+1]))&&([c,f]=[f,c],[o,l]=[l,o]);let k=[...S];c<=f?(k.splice(c+1,0,o),k.splice(f+2,0,l),s[0]=Ht(k,0,c+1),s[1]=Ht(k,f+2,k.length)):(k.splice(f+1,0,l),k.splice(c+2,0,o),s[0]=Ht(k,0,f+1),s[1]=Ht(k,c+2,k.length));const L=Ht(k,c+1,f+2),R=s.map(F=>Na(F,-n,i));return{extracted:L,remaining:R}}function Ht(a,e,t){return a.slice(e,t+1)}function Ta(a,e,t){const n={x:e.x-a.x,y:e.y-a.y},i={x:t.x-a.x,y:t.y-a.y},s=i.x*n.x+i.y*n.y,o=n.x*n.x+n.y*n.y,l=s/o,c=Math.max(0,Math.min(1,l));return{x:a.x+c*n.x,y:a.y+c*n.y}}function Sa(a,e,t){const n={x:a.x-e.x,y:a.y-e.y},i={x:t.x-e.x,y:t.y-e.y};return(n.x*i.x+n.y*i.y)/(i.x*i.x+i.y*i.y)}function kr(a,e,t){const n=e*(Math.PI/180),i=Math.cos(n),s=Math.sin(n),o=a.x-t.x,l=a.y-t.y;return{x:i*o-s*l+t.x,y:s*o+i*l+t.y}}function Na(a,e,t){return a.map(n=>kr(n,e,t))}function Xt(a){if(a.ctrlKey)return a.pointerPosition;const e=Math.round(m.gridDpi/m.gridSnap),t=Math.round(a.pointerPosition.x/m.gridDpi)*m.gridDpi,n=Math.round(a.pointerPosition.y/m.gridDpi)*m.gridDpi,i=Math.abs(t-a.pointerPosition.x),s=Math.abs(n-a.pointerPosition.y);let o,l;return i<=e?o=t:o=a.pointerPosition.x,s<=e?l=n:l=a.pointerPosition.y,{x:o,y:l}}const Dr=100;let Ut=0,Oe=null;async function Ei(){Ut=0,await w.popover.close(d.LINETOOLID)}async function qn(){if(!Oe)return;const[a,e]=Oe;e(),Oe=null,await Ei()}async function vn(){if(!Oe)return;const[a,e]=Oe,t=a(n=>{n.visible=!1,n.layer=d.LINELAYER,n.metadata[`${d.EXTENSIONID}/isVisionLine`]=!0,n.metadata[`${d.EXTENSIONID}/blocking`]=!0,n.metadata[`${d.EXTENSIONID}/doubleSided`]=!0,n.points.pop()});t.points.length>=2&&await w.scene.items.addItems([t]),e(),Oe=null,await Ei()}async function Ii(){if(!Oe)return;const[a]=Oe;a(e=>{e.points.length>2&&(e.points.pop(),Ut--)})}async function wi(a,e){if(!e.transformer)if(Oe){if(Ut>=Dr){await w.notification.show("Maximum line length reached.","ERROR");return}const[t]=Oe;t(n=>{n.points.push(e.pointerPosition),Ut++})}else{const t=Xt(e),n=m.snap?t:e.pointerPosition,i=Ne().tension(0).points([n,n]).strokeColor(m.sceneMetadata[`${d.EXTENSIONID}/toolColor`]??d.DEFAULTLINECOLOR).strokeDash(m.sceneMetadata[`${d.EXTENSIONID}/toolStyle`]??d.DEFAULTLINESTROKE).strokeWidth(be()).fillOpacity(0).fillColor("#000000").layer(d.LINELAYER).name("Vision Line (Line)").closed(!1).locked(!0).build();Oe=await w.interaction.startItemInteraction(i),Ut=i.points.length;const s=await w.viewport.getWidth();await w.popover.open({id:d.LINETOOLID,url:"/pages/line.html",height:75,width:350,disableClickAway:!0,hidePaper:!0,anchorPosition:{top:50,left:s/2},anchorReference:"POSITION",anchorOrigin:{vertical:"CENTER",horizontal:"CENTER"},transformOrigin:{vertical:"TOP",horizontal:"CENTER"}})}}function Cr(a,e){if(!Oe||e.transformer)return;const[t]=Oe,n=Xt(e);t(i=>{i.points[i.points.length-1]=m.snap?n:e.pointerPosition})}async function Lr(a,e){await wi(a,e),await vn()}function Mr(a,e){Oe&&(e.key=="Escape"?qn():e.key=="Enter"?vn():e.key==="z"&&Ii())}const nn={onToolClick:wi,onToolDouble:Lr,onToolMove:Cr,onKeyDown:Mr},$r=100;let zt=0,_e=null;async function bi(){zt=0,await w.popover.close(d.POLYTOOLID)}async function Kn(){if(!_e)return;const[a,e]=_e;e(),_e=null,bi(),await w.player.setMetadata({[`${d.EXTENSIONID}/cancelPoly`]:!1})}async function yn(){if(!_e)return;const[a,e]=_e,t=a(n=>{n.visible=!1,n.layer=d.LINELAYER,n.style.fillOpacity=0,n.metadata[`${d.EXTENSIONID}/isVisionLine`]=!0,n.metadata[`${d.EXTENSIONID}/blocking`]=!0,n.metadata[`${d.EXTENSIONID}/doubleSided`]=!0,n.points.pop(),n.points.push(n.points[0])});t.points.length>=4&&await w.scene.items.addItems([t]),e(),_e=null,bi(),await w.player.setMetadata({[`${d.EXTENSIONID}/finishPoly`]:!1})}async function Ti(){if(!_e)return;const[a]=_e;a(e=>{e.points.length>2&&(e.points.pop(),zt--)})}async function Si(a,e){if(!e.transformer)if(_e){if(zt>=$r){await w.notification.show("Maximum line length reached.","ERROR");return}const[t]=_e;t(n=>{n.points.push(e.pointerPosition),zt++})}else{const t=Xt(e),n=m.snap?t:e.pointerPosition,i=Ne().tension(0).points([n,n]).strokeColor(m.sceneMetadata[`${d.EXTENSIONID}/toolColor`]??d.DEFAULTLINECOLOR).strokeDash(m.sceneMetadata[`${d.EXTENSIONID}/toolStyle`]??d.DEFAULTLINESTROKE).strokeWidth(be()).fillOpacity(.5).fillColor("#000000").layer(d.LINELAYER).name("Vision Line (Polygon)").locked(!0).build();_e=await w.interaction.startItemInteraction(i),zt=i.points.length;const s=await w.viewport.getWidth();await w.popover.open({id:d.POLYTOOLID,url:"/pages/polygon.html",height:75,width:400,disableClickAway:!0,hidePaper:!0,anchorPosition:{top:50,left:s/2},anchorReference:"POSITION",anchorOrigin:{vertical:"CENTER",horizontal:"CENTER"},transformOrigin:{vertical:"TOP",horizontal:"CENTER"}})}}function Ar(a,e){if(!_e||e.transformer)return;const[t]=_e,n=Xt(e);t(i=>{i.points[i.points.length-1]=m.snap?n:e.pointerPosition})}async function xr(a,e){await Si(a,e),await yn()}function Pr(a,e){_e&&(e.key=="Escape"?Kn():e.key=="Enter"?yn():e.key==="z"&&Ti())}const an={onToolClick:Si,onToolDouble:xr,onToolMove:Ar,onKeyDown:Pr};let ke=null;const Ni=[];async function Oi(){await w.popover.close(d.ELEVATIONTOOLID)}async function sa(){if(!ke)return;const[a,e]=ke;e(),ke=null,Oi()}async function _i(){if(!ke)return;const[a,e]=ke,t=a(n=>{n.visible=!1,n.points.pop(),n.points.push(n.points[0])});if(t.points.length>=4){await w.scene.local.addItems([t]);let n=m.sceneMetadata[`${d.EXTENSIONID}/elevationMapping`];n||(n=[]);const i=t.metadata[`${d.EXTENSIONID}/elevation`]??0,s={Points:t.points,Depth:i};n.push(s),await w.scene.setMetadata({[`${d.EXTENSIONID}/elevationMapping`]:n})}e(),ke=null,Oi()}async function ki(){if(!ke)return;const[a]=ke;a(e=>{e.points.length>2&&e.points.pop()})}async function Rr(a,e,t){if(!e.transformer)if(ke){const[n]=ke;n(i=>{i.points.push(e.pointerPosition)})}else{const n=Xt(e),i=m.snap?n:e.pointerPosition,s=Ne().tension(0).points([i,i]).strokeColor(Di(t)).strokeDash(m.sceneMetadata[`${d.EXTENSIONID}/toolStyle`]??Ni).strokeWidth(be()).fillOpacity(.5).fillColor(Ci(t)).layer(d.LINELAYER).metadata({[`${d.EXTENSIONID}/elevation`]:t}).name(`Elevation-${t} Area`).zIndex(t).locked(!0).build();ke=await w.interaction.startItemInteraction(s);const o=await w.viewport.getWidth();await w.popover.open({id:d.ELEVATIONTOOLID,url:"/pages/elevation.html",height:75,width:400,disableClickAway:!0,hidePaper:!0,anchorPosition:{top:60,left:o/2},anchorReference:"POSITION",anchorOrigin:{vertical:"CENTER",horizontal:"CENTER"},transformOrigin:{vertical:"TOP",horizontal:"CENTER"}})}}function Xr(a,e){if(!ke||e.transformer)return;const[t]=ke,n=Xt(e);t(i=>{i.points[i.points.length-1]=m.snap?n:e.pointerPosition})}function Vr(a,e,t){ke&&(e.key=="Escape"?sa():e.key=="Enter"?_i():e.key==="z"&&ki())}async function Hr(a){const e=a.metadata[`${d.EXTENSIONID}/elevationEditor`]??!1;if(await w.tool.setMetadata(`${d.EXTENSIONID}/vision-tool`,{[`${d.EXTENSIONID}/elevationEditor`]:!e}),e)await w.popover.close(d.ELEVATIONWARNID),await Br();else{const t=await w.viewport.getWidth();await w.popover.open({id:d.ELEVATIONWARNID,url:"/pages/ewarning.html",height:45,width:430,disableClickAway:!0,anchorPosition:{top:120,left:t/2},anchorReference:"POSITION",anchorOrigin:{vertical:"CENTER",horizontal:"CENTER"},transformOrigin:{vertical:"TOP",horizontal:"CENTER"}}),await Fr()}}async function Fr(a){const t=(await w.scene.getMetadata())[`${d.EXTENSIONID}/elevationMapping`]??[];if(t&&t.length>0){const n=[];for(const i of t){const s=Ne().tension(0).points(i.Points).strokeColor(Di(i.Depth)).strokeDash(m.sceneMetadata[`${d.EXTENSIONID}/toolStyle`]??Ni).strokeWidth(be()).fillOpacity(.5).fillColor(Ci(i.Depth)).layer(d.LINELAYER).name("Elevation-1 Area").locked(!0).visible(!1).metadata({[`${d.EXTENSIONID}/elevation`]:i.Depth}).zIndex(i.Depth).build();n.push(s)}await w.scene.local.addItems(n)}}async function Br(a){const e=m.sceneLocal.filter(t=>t.metadata[`${d.EXTENSIONID}/elevation`]!==void 0);if(e.length>0){const t=[];for(const n of e){let i=n.points;(n.position.x!==0||n.position.y!==0)&&(i=n.points.map(o=>{const l=o.x+n.position.x,c=o.y+n.position.y;return{x:l,y:c}}));const s={Points:i,Depth:n.metadata[`${d.EXTENSIONID}/elevation`]??0};t.push(s)}await w.scene.setMetadata({[`${d.EXTENSIONID}/elevationMapping`]:t}),await w.scene.local.deleteItems(e.map(n=>n.id))}else await w.scene.setMetadata({[`${d.EXTENSIONID}/elevationMapping`]:[]})}function Di(a){switch(a){case 1:return"#6454ac";case 2:return"#029658";case 3:return"#fcd444";case 4:return"#fc6404";case 5:return"#ff0000";default:return"#000000"}}function Ci(a){switch(a){case 1:return"#6454ac4F";case 2:return"#0296584F";case 3:return"#fcd4444F";case 4:return"#fc64044F";case 5:return"#ff00004F";default:return"#0000004F"}}const Ee={onToolClick:Rr,onToolMove:Xr,onKeyDown:Vr,enterEditMode:Hr,cancelDrawing:sa};function Oa(a){return a.metadata[`${d.EXTENSIONID}/isIndicatorRing`]}function Ft(a){return a.metadata[`${d.EXTENSIONID}/isVisionLine`]}function Ur(a){return a.metadata[`${d.EXTENSIONID}/isVisionLine`]&&!a.metadata[`${d.EXTENSIONID}/disabled`]}function zr(a){return a.metadata[`${d.SPECTREID}/isLocalSpectre`]}function jr(a){return a.metadata[`${d.EXTENSIONID}/isVisionWall`]}function Gr(a){return a.metadata[`${d.EXTENSIONID}/isVisionLight`]}function Wr(a){return a.metadata[`${d.EXTENSIONID}/isPersistentLight`]}function Yr(a){return a.metadata[`${d.EXTENSIONID}/isLocalDecal`]}function qr(a){return a.metadata[`${d.EXTENSIONID}/isDarkVision`]}function Ot(a){return a.metadata[`${d.EXTENSIONID}/isTorch`]}function An(a){return(a.layer==="CHARACTER"||a.layer==="MOUNT"||a.layer==="ATTACHMENT"||a.layer==="PROP")&&a.metadata[`${d.EXTENSIONID}/hasVision`]}function Le(a){return(a.layer==="CHARACTER"||a.layer==="MOUNT"||a.layer==="ATTACHMENT"||a.layer==="PROP")&&a.metadata[`${d.EXTENSIONID}/hasVision`]}function Kr(a){return(a.layer==="CHARACTER"||a.layer==="MOUNT"||a.layer==="ATTACHMENT"||a.layer==="PROP")&&a.createdUserId==m.playerId&&a.metadata[`${d.EXTENSIONID}/hasVision`]}function Qr(a){return a.metadata[`${d.EXTENSIONID}/isBrushSquare`]}async function Li(a,e){const t=await w.scene.local.getItems(n=>n.metadata[`${d.EXTENSIONID}/isFogEffect`]===a.id);t.length>0&&await w.scene.local.deleteItems(t.map(n=>n.id)),e===d.SPOOKYSTYLE?await Jr(a):e===d.FOGGYSTYLE?await es(a):e===d.COSMICSTYLE?await Zr(a):e===d.WEIRDSTYLE?await ts(a):e===d.FLESHSTYLE?await ns(a):e===d.DRIPSTYLE?await as(a):e===d.WATERSTYLE&&await is(a)}async function Zr(a){const e=Qe().scale(a.scale).rotation(a.rotation).attachedTo(a.id).effectType("ATTACHMENT").layer("FOG").metadata({[`${d.EXTENSIONID}/isFogEffect`]:a.id}).sksl(d.COSMICSHADER).disableHit(!0).zIndex(-.5).build();await w.scene.local.addItems([e])}async function Jr(a){const e=Qe().scale(a.scale).rotation(a.rotation).attachedTo(a.id).blendMode("MULTIPLY").effectType("ATTACHMENT").layer("FOG").metadata({[`${d.EXTENSIONID}/isFogEffect`]:a.id}).sksl(d.SPOOKYSHADER).disableHit(!0).zIndex(-.5).build();await w.scene.local.addItems([e])}async function es(a){const e=Qe().scale(a.scale).rotation(a.rotation).attachedTo(a.id).effectType("ATTACHMENT").layer("FOG").metadata({[`${d.EXTENSIONID}/isFogEffect`]:a.id}).sksl(d.FOGGYSHADER).disableHit(!0).zIndex(-.5).build();await w.scene.local.addItems([e])}async function ts(a){const e=Qe().scale(a.scale).rotation(a.rotation).attachedTo(a.id).effectType("ATTACHMENT").layer("FOG").metadata({[`${d.EXTENSIONID}/isFogEffect`]:a.id}).sksl(d.WEIRDSHADER).disableHit(!0).zIndex(-.5).build();await w.scene.local.addItems([e])}async function ns(a){const e=Qe().scale(a.scale).rotation(a.rotation).attachedTo(a.id).effectType("ATTACHMENT").layer("FOG").metadata({[`${d.EXTENSIONID}/isFogEffect`]:a.id}).sksl(d.FLESHSHADER).disableHit(!0).zIndex(-.5).build();await w.scene.local.addItems([e])}async function as(a){const e=Qe().scale(a.scale).rotation(a.rotation).attachedTo(a.id).effectType("ATTACHMENT").layer("FOG").metadata({[`${d.EXTENSIONID}/isFogEffect`]:a.id}).sksl(d.ANNIHILATIONSHADER).disableHit(!0).zIndex(-.5).build();await w.scene.local.addItems([e])}async function is(a){const e=Qe().scale(a.scale).rotation(a.rotation).attachedTo(a.id).effectType("ATTACHMENT").layer("FOG").metadata({[`${d.EXTENSIONID}/isFogEffect`]:a.id}).sksl(d.WATERSHADER).disableHit(!0).zIndex(-.5).build();await w.scene.local.addItems([e])}class rs{cachedWallSegments=[];constructor(){}distanceSquared(e,t){const n=t.x-e.x,i=t.y-e.y;return n*n+i*i}rotatePoint(e,t,n){const i=n*Math.PI/180,s=Math.cos(i),o=Math.sin(i),l=e.x-t.x,c=e.y-t.y;return{x:t.x+(l*s-c*o),y:t.y+(l*o+c*s)}}async UpdateWallSegments(){const e=await w.scene.local.getItems(t=>t.metadata[`${d.EXTENSIONID}/isVisionWall`]===!0);this.cachedWallSegments=[];for(const t of e){const n=new Array(t.points.length);for(let i=0;i<t.points.length;i++){const s=t.points[i];n[i]=this.rotatePoint({x:s.x+t.position.x,y:s.y+t.position.y},t.position,t.rotation)}for(let i=0;i<n.length-1;i++)this.cachedWallSegments.push({start:n[i],end:n[i+1]})}}lineIntersects(e,t,n,i){function s(v,S,O){const k=(S.y-v.y)*(O.x-S.x)-(S.x-v.x)*(O.y-S.y);return k===0?0:k>0?1:2}function o(v,S,O){return S.x<=Math.max(v.x,O.x)&&S.x>=Math.min(v.x,O.x)&&S.y<=Math.max(v.y,O.y)&&S.y>=Math.min(v.y,O.y)}const l=s(e,t,n),c=s(e,t,i),f=s(n,i,e),g=s(n,i,t);return!!(l!==c&&f!==g||l===0&&o(e,n,t)||c===0&&o(e,i,t)||f===0&&o(n,e,i)||g===0&&o(n,t,i))}isLineOfSightBlocked(e,t){const n=Math.min(e.x,t.x),i=Math.max(e.x,t.x),s=Math.min(e.y,t.y),o=Math.max(e.y,t.y);for(const l of this.cachedWallSegments)if(!(Math.max(l.start.x,l.end.x)<n||Math.min(l.start.x,l.end.x)>i||Math.max(l.start.y,l.end.y)<s||Math.min(l.start.y,l.end.y)>o)&&this.lineIntersects(e,t,l.start,l.end))return!0;return!1}async HideEnemies(e,t){const n=[],i=[];for(const s of t)for(const o of e){const l=o.attenuationRadius,c=l*l;if(this.distanceSquared(o.position,s.position)<=c&&!this.isLineOfSightBlocked(o.position,s.position)){i.push(s.id);continue}n.push(s.id)}await w.scene.items.updateItems(t.map(s=>s.id),s=>{for(let o of s)n.includes(o.id)&&!i.includes(o.id)?o.visible&&(o.visible=!1):o.visible||(o.visible=!0)})}}class ss{VisibilityChecker;wallsToCreate=[];wallsToUpdate=[];wallsToDelete=[];wallsToError=[];wallsNotOwner=[];lightsToCreate=[];lightsToUpdate=[];lightsToDelete=[];ringsToCreate=[];ringsToUpdate=[];ringsToDelete=[];decalsToCreate=[];decalsToUpdate=[];decalsToDelete=[];darkVisionToCreate=[];darkVisionToUpdate=[];darkVisionToDelete=[];revealersToCreate=[];revealersToUpdate=[];revealersToDelete=[];persistentLights=[];persistenceCullingDistance=1;persistenceLimit=50;trailingFoggedMaps=[];trailingFogTokens=[];constructor(){this.VisibilityChecker=new rs}async Initialize(){if(m.sceneMetadata[`${d.EXTENSIONID}/persistence`]===!0){const t=localStorage.getItem(Cn());if(t){const n=JSON.parse(t);if(n.length>0)for(let i of n)i.id=i.metadata[`${d.EXTENSIONID}/isPersistentLight`],this.AddPersistentLightToQueue(i,i.zIndex)}}const e=m.sceneItems.filter(t=>t.metadata[`${d.EXTENSIONID}/FogBackgroundId`]!==void 0);for(const t of e){const n=t.metadata[`${d.EXTENSIONID}/FogBackgroundId`],i=t.metadata[`${d.EXTENSIONID}/hasFogBackground`],s=m.sceneItems.filter(o=>o.id===n);if(s.length>0){const o=s[0];await Li(o,i)}}}async Reset(){this.persistentLights=[],this.trailingFogTokens=[],this.trailingFoggedMaps=[]}async Run(e=!1){!m.fogFilled&&e===!1||(await this.UpdateTrailingFogMaps(),await this.UpdateWalls(),await this.UpdateDoors(),await this.UpdateLights(),await this.UpdateOwnershipHighlights(),await this.UpdateTrailingFogTokens(),await this.UpdateAutoHideTokens(),m.sceneMetadata[`${d.EXTENSIONID}/persistence`]===!0&&localStorage.setItem(Cn(),JSON.stringify(this.persistentLights)))}async UpdateAutoHideTokens(){if(m.sceneMetadata[`${d.EXTENSIONID}/autoHide`]===!0&&m.playerRole==="GM"){const e=(await w.scene.local.getItems(n=>n.metadata[`${d.EXTENSIONID}/isVisionLight`]===!0)).filter(n=>n.lightType==="PRIMARY"),t=await w.scene.items.getItems(n=>n.metadata[`${d.EXTENSIONID}/isAutoHidden`]===!0);await this.VisibilityChecker.HideEnemies(e,t)}}async UpdateTrailingFogMaps(){m.sceneMetadata[`${d.EXTENSIONID}/trailingFog`]===!0&&m.fogFilled&&await this.CreateTrailingFogOverlay()}async UpdateTrailingFogTokens(){if(m.sceneMetadata[`${d.EXTENSIONID}/trailingFog`]===!0&&m.fogFilled)this.revealersToCreate.length>0&&(await w.scene.local.addItems(this.revealersToCreate),this.revealersToCreate=[]);else if(this.trailingFogTokens.length>0||this.trailingFoggedMaps.length>0){const e=m.sceneLocal.filter(n=>n.metadata[`${d.EXTENSIONID}/isTrailingFogLight`]!==void 0),t=m.sceneLocal.filter(n=>n.metadata[`${d.EXTENSIONID}/isTrailingFogger`]!==void 0);t.length>0&&await w.scene.local.deleteItems(t.map(n=>n.id)),e.length>0&&await w.scene.local.deleteItems(e.map(n=>n.id)),this.trailingFogTokens=[],this.trailingFoggedMaps=[]}}async UpdateTrailingFogColor(e){const t=m.sceneLocal.filter(i=>i.metadata[`${d.EXTENSIONID}/isTrailingFogLight`]!==void 0);await w.scene.local.updateItems(t.map(i=>i.id),i=>{for(let s of i)s.uniforms=[{name:"darknessLevel",value:.65},{name:"darknessColor",value:Mn(e)},{name:"radiusRatio",value:1}]});const n=m.sceneLocal.filter(i=>i.metadata[`${d.EXTENSIONID}/isTrailingFogger`]!==void 0);await w.scene.local.updateItems(n.map(i=>i.id),i=>{for(let s of i)s.uniforms=[{name:"darknessLevel",value:.65},{name:"darknessColor",value:Mn(e)}]})}CreateTrailingFogRevealer(e){if(m.sceneMetadata[`${d.EXTENSIONID}/trailingFog`]===!0&&!this.trailingFogTokens.includes(e.id)){const t=Qe().position(e.position).attachedTo(e.id).rotation(e.rotation).scale(e.scale).width(200).height(200).effectType("ATTACHMENT").layer("POST_PROCESS").sksl(d.TRAILINGFOGREVEALSHADER).uniforms([{name:"radiusRatio",value:1},{name:"rotation",value:e.rotation}]).metadata({[`${d.EXTENSIONID}/isTrailingFogLight`]:e.id}).disableHit(!0).disableAutoZIndex(!0).zIndex(200).build();this.revealersToCreate.push(t),this.trailingFogTokens.push(e.id)}}async CreateTrailingFogOverlay(){const e=[],t=m.sceneItems.filter(n=>n.layer==="MAP"&&n.type==="IMAGE");for(const n of t)if(!this.trailingFoggedMaps.includes(n.id)){const i=Qe().position(n.position).attachedTo(n.id).scale(n.scale).width(n.image.width).height(n.image.height).effectType("ATTACHMENT").layer("POST_PROCESS").sksl(d.TRAILINGFOGSHADER).uniforms([{name:"darknessLevel",value:.65},{name:"darknessColor",value:Mn(m.fogColor)}]).metadata({[`${d.EXTENSIONID}/isTrailingFogger`]:n.id}).disableHit(!0).disableAutoZIndex(!0).zIndex(100).build();e.push(i),this.trailingFoggedMaps.push(n.id)}e.length>0&&await w.scene.local.addItems(e)}async ClearDoors(){if(m.playerRole!=="PLAYER")return;const e=m.sceneLocal.filter(t=>t.metadata[`${d.EXTENSIONID}/localDoor`]===!0);await w.scene.local.deleteItems(e.map(t=>t.id))}async UpdateDoors(){if(m.playerRole==="PLAYER"&&m.sceneMetadata[`${d.EXTENSIONID}/playerDoors`]!==!0)return;const e=await w.scene.items.getItems(n=>n.type==="CURVE"&&n.metadata[`${d.EXTENSIONID}/isDoor`]===!0),t=m.sceneLocal.filter(n=>n.metadata[`${d.EXTENSIONID}/localDoor`]===!0);if(e.length>0){const n=[];for(const i of e)if(!t.some(s=>s.attachedTo===i.id)){const s=i.metadata[`${d.EXTENSIONID}/doorOpen`]===!0,o=i.metadata[`${d.EXTENSIONID}/isDoorLocked`]===!0,l=Ke.fromItem(i),c=[];for(let S=0;S<i.points.length;S++){const O=Ke.fromPosition(i.points[S]);c.push(Ke.decompose(Ke.multiply(l,O)).position)}let f=d.DOOROPEN,g="Opened Door";m.playerRole==="GM"&&o?(f=d.DOORLOCKED,g="Locked Door"):s||(f=d.DOORCLOSED,g="Closed Door");const v=dt.centroid(c);n.push(hn({height:100,width:100,url:f,mime:"image/svg+xml"},{dpi:150,offset:{x:50,y:50}}).scale({x:.75,y:.75}).attachedTo(i.id).layer(m.playerRole==="GM"?d.LINELAYER:"DRAWING").zIndex(i.zIndex+10).locked(!0).name(g).position({x:v.x,y:v.y}).metadata({[`${d.EXTENSIONID}/localDoor`]:!0}).build())}n.length>0&&await w.scene.local.addItems(n)}else t.length>0&&await w.scene.local.deleteItems(t.map(n=>n.id));if(t.length>0){const n=[],i=[],s=[],o=[];for(const l of t){const c=m.sceneItems.find(f=>f.id===l.attachedTo&&f.metadata[`${d.EXTENSIONID}/isDoor`]===!0);c?m.playerRole==="GM"&&l.image.url!==d.DOORLOCKED&&c.metadata[`${d.EXTENSIONID}/isDoorLocked`]===!0?s.push(l.id):l.image.url!==d.DOOROPEN&&c.metadata[`${d.EXTENSIONID}/doorOpen`]===!0?n.push(l.id):l.image.url!==d.DOORCLOSED&&c.metadata[`${d.EXTENSIONID}/doorOpen`]!==!0&&(m.playerRole==="GM"&&c.metadata[`${d.EXTENSIONID}/isDoorLocked`]!==!0||m.playerRole==="PLAYER")&&i.push(l.id):o.push(l.id)}s.length>0&&await w.scene.local.updateItems(l=>s.includes(l.id),l=>{for(let c of l)c.image.url=d.DOORLOCKED,c.name="Locked Door"}),n.length>0&&await w.scene.local.updateItems(l=>n.includes(l.id),l=>{for(let c of l)c.image.url=d.DOOROPEN,c.name="Opened Door"}),i.length>0&&await w.scene.local.updateItems(l=>i.includes(l.id),l=>{for(let c of l)c.image.url=d.DOORCLOSED,c.name="Closed Door"}),o.length>0&&await w.scene.local.deleteItems(o)}}async ClearPersistence(){const e=await w.scene.local.getItems(t=>t.metadata[`${d.EXTENSIONID}/getPersistentLight`]===!0);await w.scene.local.deleteItems(e.map(t=>t.id)),this.persistentLights=[],localStorage.setItem(Cn(),JSON.stringify(this.persistentLights))}async TogglePersistentLightVisibility(e){await w.scene.local.updateItems(t=>Wr(t)!==void 0,t=>{for(let n of t)n.visible=!e})}async ClearOwnershipHighlights(){const e=m.sceneLocal.filter(t=>Oa(t));await w.scene.local.deleteItems(e.map(t=>t.id))}async InitiateOwnerHighlight(){if(m.playerRole!=="GM"||m.fogFilled===!1)return;const e=m.sceneItems.filter(t=>An(t));for(const t of e){const n=m.sceneItems.find(i=>i.id===t.metadata[`${d.EXTENSIONID}/linkedTo`]);this.CreateOwnerHighlight(t,n,!0)}}CreateOwnerHighlight(e,t,n=!1){const i=t??e;if((m.playerRole!=="GM"||m.sceneMetadata[`${d.EXTENSIONID}/toggleOwnerLines`]!==!0)&&!n)return;const s=parseInt(i.metadata[`${d.EXTENSIONID}/visionDark`])>parseInt(i.metadata[`${d.EXTENSIONID}/visionRange`]),o=this.GetLightRange(i.metadata[`${d.EXTENSIONID}/visionDark`]);if(m.sceneLocal.find(c=>c.metadata[`${d.EXTENSIONID}/isIndicatorRing`]===!0&&c.attachedTo===e.id))this.UpdateOwnerHightlight(e);else{const c=m.sceneMetadata[`${d.EXTENSIONID}/USER-${e.createdUserId}`],f=this.GetLightRange(i.metadata[`${d.EXTENSIONID}/visionRange`]??$e()),g=lr().strokeColor(c.color).fillOpacity(0).position({x:e.position.x,y:e.position.y}).width(s?o*2:f*2).height(s?o*2:f*2).shapeType("CIRCLE").metadata({[`${d.EXTENSIONID}/isIndicatorRing`]:!0}).attachedTo(e.id).locked(!0).layer(d.LINELAYER).disableAttachmentBehavior(["SCALE"]).zIndex(1).build();this.ringsToCreate.push(g)}}UpdateDarkVision(e,t){const n=t??e,i=this.GetLightRange(n.metadata[`${d.EXTENSIONID}/visionRange`])*2,s=this.GetLightRange(n.metadata[`${d.EXTENSIONID}/visionDark`])*2,o=i*.9/s/2,l={x:e.position.x-s/2,y:e.position.y-s/2},c=[{name:"center",value:{x:.5,y:.5}},{name:"radius",value:.5},{name:"clear",value:o},{name:"smoothwidth",value:.075}],f=m.sceneLocal.find(g=>g.attachedTo===e.id&&g.metadata[`${d.EXTENSIONID}/isDarkVision`]===!0);if(f){const g={id:f.id,size:s,position:l,uniforms:c};this.darkVisionToUpdate.push(g)}}UpdateOwnerHightlight(e,t){const n=t??e;if(m.playerRole!=="GM"||m.sceneMetadata[`${d.EXTENSIONID}/toggleOwnerLines`]!==!0)return;const i=parseInt(n.metadata[`${d.EXTENSIONID}/visionDark`])>parseInt(n.metadata[`${d.EXTENSIONID}/visionRange`]),s=this.GetLightRange(n.metadata[`${d.EXTENSIONID}/visionDark`]),o=this.GetLightRange(n.metadata[`${d.EXTENSIONID}/visionRange`]??$e()),l=m.sceneLocal.find(c=>c.attachedTo===e.id&&c.metadata[`${d.EXTENSIONID}/isIndicatorRing`]===!0);if(l){const c={id:l.id,height:i?s*2:o*2,width:i?s*2:o*2};this.ringsToUpdate.push(c)}}async UpdateOwnershipHighlights(){if(m.sceneMetadata[`${d.EXTENSIONID}/toggleOwnerLines`]===!0){if(this.ringsToCreate.length>0&&await w.scene.local.addItems(this.ringsToCreate),this.ringsToDelete.length>0&&await w.scene.local.deleteItems(this.ringsToDelete),this.ringsToUpdate.length>0){const e=m.sceneLocal.filter(t=>Oa(t));await w.scene.local.updateItems(e.filter(t=>!this.ringsToDelete.includes(t.id)),t=>{for(let n of t){const i=this.ringsToUpdate.find(s=>s.id===n.id);i&&(n.height=i.height,n.width=i.width)}})}this.ringsToCreate=[],this.ringsToUpdate=[],this.ringsToDelete=[]}}async UpdateLights(){let e=[];if(m.playerRole==="GM"){const o=document.getElementById("preview_select");o&&o?.value!==m.playerId?e=m.sceneItems.filter(l=>(l.layer==="CHARACTER"||l.layer==="MOUNT"||l.layer==="ATTACHMENT"||l.layer==="PROP")&&l.createdUserId===o.value&&l.metadata[`${d.EXTENSIONID}/hasVision`]):e=m.sceneItems.filter(l=>An(l))}else{const o=m.sceneItems.filter(f=>An(f)),l=[],c=[];for(const f of o)f.createdUserId===m.playerId?l.push(f):m.sceneMetadata[`${d.EXTENSIONID}/USER-${f.createdUserId}`]?.role==="GM"&&c.push(f);e=[...l,...c]}m.sceneMetadata[`${d.EXTENSIONID}/disableVision`]===!0&&(e=[]);const t=m.sceneMetadata[`${d.EXTENSIONID}/elevationMapping`]??[];for(const o of e){let l=-10;const c=m.sceneItems.find(g=>g.id===o.metadata[`${d.EXTENSIONID}/linkedTo`]);for(const g of t){const v=wa(o.position,g.Points),S=o.metadata[`${d.EXTENSIONID}/unitDepth`];S?l=parseInt(S):v&&g.Depth>l&&(l=g.Depth)}const f=m.sceneLocal.find(g=>g.attachedTo===o.id&&g.metadata[`${d.EXTENSIONID}/isVisionLight`]===!0);if(!f)this.CreateLightToQueue(o,l,c);else{const g=c??o;let v=this.GetLightRange(g.metadata[`${d.EXTENSIONID}/visionRange`])===f.attenuationRadius;parseInt(g.metadata[`${d.EXTENSIONID}/visionDark`])>parseInt(g.metadata[`${d.EXTENSIONID}/visionRange`])&&v&&(v=this.GetLightRange(g.metadata[`${d.EXTENSIONID}/visionDark`])===f.attenuationRadius);const S=this.GetLightRange(g.metadata[`${d.EXTENSIONID}/visionSourceRange`])===f.sourceRadius,O=g.metadata[`${d.EXTENSIONID}/visionFallOff`]===f.falloff?.toString(),k=g.metadata[`${d.EXTENSIONID}/visionInAngle`]===f.innerAngle?.toString(),L=g.metadata[`${d.EXTENSIONID}/visionOutAngle`]===f.outerAngle?.toString(),R=g.metadata[`${d.EXTENSIONID}/visionBlind`]===!0===f.metadata[`${d.EXTENSIONID}/visionBlind`],F=this.GetDepth(l,!1)===f.zIndex;let M=!1;(!v||!S||!O||!k||!L||!R||!F)&&(this.UpdateLightToQueue(o,f,l,c),M=!0);const z=m.sceneLocal.find(r=>r.metadata[`${d.EXTENSIONID}/isDarkVision`]===!0&&r.attachedTo===o.id);z?(!(this.GetLightRange(o.metadata[`${d.EXTENSIONID}/visionDark`])*2===z.width)||M)&&this.UpdateDarkVision(o,c):this.CreateDarkVisionToQueue(o,c),f.lightType==="PRIMARY"&&this.CreateTrailingFogRevealer(f)}o.layer==="CHARACTER"&&(o.metadata[`${d.EXTENSIONID}/visionInAngle`]!=="360"||o.metadata[`${d.EXTENSIONID}/visionOutAngle`]!=="360")&&(m.sceneLocal.find(v=>v.metadata[`${d.EXTENSIONID}/isLocalDecal`]===o.id)||this.CreateDecalToQueue(o)),m.sceneMetadata[`${d.EXTENSIONID}/persistence`]===!0&&o.metadata[`${d.EXTENSIONID}/visionBlind`]!==!0&&(this.persistentLights.find(v=>v.position.x===o.position.x&&v.position.y===o.position.y)?(o.metadata[`${d.EXTENSIONID}/visionInAngle`]!==360||o.metadata[`${d.EXTENSIONID}/visionInAngle`]!==360)&&this.IsPositionAndRotationClear(o.rotation,o.position)&&this.AddPersistentLightToQueue(o,l,c):this.IsPositionClear(o.position)&&this.AddPersistentLightToQueue(o,l,c))}const n=m.sceneLocal.filter(o=>Gr(o));for(const o of n)if(!e.find(c=>c.id===o.attachedTo)){this.lightsToDelete.push(o.id);const c=m.sceneLocal.find(f=>f.metadata[`${d.EXTENSIONID}/isIndicatorRing`]===!0&&f.attachedTo===o.attachedTo);c&&this.ringsToDelete.push(c.id)}const i=m.sceneLocal.filter(o=>Yr(o));for(const o of i){const l=e.find(c=>c.id===o.metadata[`${d.EXTENSIONID}/isLocalDecal`]);l?l.metadata[`${d.EXTENSIONID}/visionInAngle`]==="360"||l.metadata[`${d.EXTENSIONID}/visionOutAngle`]==="360"?this.decalsToDelete.push(o.id):l.image.url!==o.image.url&&this.decalsToUpdate.push({id:o.id,imageUrl:l.image.url}):this.decalsToDelete.push(o.id)}const s=m.sceneLocal.filter(o=>qr(o));for(const o of s){const l=e.find(c=>o.metadata[`${d.EXTENSIONID}/isDarkVision`]===!0&&o.attachedTo===c.id);l?parseInt(l.metadata[`${d.EXTENSIONID}/visionDark`])<parseInt(l.metadata[`${d.EXTENSIONID}/visionRange`])&&this.decalsToDelete.push(o.id):this.decalsToDelete.push(o.id)}this.lightsToCreate.length>0&&await w.scene.local.addItems(this.lightsToCreate),this.lightsToDelete.length>0&&await w.scene.local.deleteItems(this.lightsToDelete),this.lightsToUpdate.length>0&&await w.scene.local.updateItems(n.filter(o=>!this.lightsToDelete.includes(o.id)),o=>{for(let l of o){const c=this.lightsToUpdate.find(f=>f.id===l.id);c&&(l.attenuationRadius=c.attenuationRadius,l.sourceRadius=c.sourceRadius,l.falloff=c.falloff,l.innerAngle=c.innerAngle,l.outerAngle=c.outerAngle,l.metadata[`${d.EXTENSIONID}/visionBlind`]=c.blind,l.zIndex=c.zIndex)}}),this.decalsToCreate.length>0&&await w.scene.local.addItems(this.decalsToCreate),this.decalsToDelete.length>0&&await w.scene.local.deleteItems(this.decalsToDelete),this.decalsToUpdate.length>0&&await w.scene.local.updateItems(i.filter(o=>!this.decalsToDelete.includes(o.id)),o=>{for(let l of o){const c=this.decalsToUpdate.find(f=>f.id===l.id);c&&(l.image.url=c.imageUrl)}}),this.darkVisionToCreate.length>0&&await w.scene.local.addItems(this.darkVisionToCreate),this.darkVisionToDelete.length>0&&await w.scene.local.deleteItems(this.darkVisionToDelete),this.darkVisionToUpdate.length>0&&await w.scene.local.updateItems(s.filter(o=>!this.darkVisionToDelete.includes(o.id)),o=>{for(let l of o){const c=this.darkVisionToUpdate.find(f=>f.id===l.id);c&&(l.width=c.size,l.height=c.size,l.position=c.position,l.uniforms=c.uniforms)}}),this.lightsToCreate=[],this.lightsToUpdate=[],this.lightsToDelete=[],this.decalsToCreate=[],this.decalsToDelete=[],this.decalsToUpdate=[],this.darkVisionToCreate=[],this.darkVisionToUpdate=[],this.darkVisionToDelete=[]}async UpdateWalls(){const e=m.sceneMetadata[`${d.EXTENSIONID}/elevationMapping`]??[],t=m.sceneMetadata[`${d.EXTENSIONID}/passWallsGM`]===!0&&m.playerRole==="GM",n=m.sceneItems.filter(o=>Ur(o));for(const o of n){if(o.type!=="CURVE"||o.points===void 0){this.wallsToError.push(o.id);continue}const l=o.metadata[`${d.EXTENSIONID}/wallViewers`];if(!l||l&&l.length>0&&l[0]===m.playerId||m.playerRole==="GM"){let c=-10;for(const g of e){const v={x:o.points[0].x+o.position.x,y:o.points[0].y+o.position.y},S=wa(v,g.Points),O=o.metadata[`${d.EXTENSIONID}/wallDepth`];O?c=parseInt(O):S&&g.Depth>c&&(c=g.Depth)}const f=m.sceneLocal.find(g=>g.attachedTo===o.id&&g.metadata[`${d.EXTENSIONID}/isVisionWall`]===!0);if(!f)this.CreateWallToQueue(o,c);else{const g=Nr(o,f),v=o.rotation===f.rotation,S=o.scale.x===f.scale.x&&o.scale.y===f.scale.y,O=o.position.x===f.position.x&&o.position.y===f.position.y,k=o.metadata[`${d.EXTENSIONID}/doubleSided`]===f.doubleSided,L=this.GetDepth(c,!0)===f.zIndex,R=o.metadata[`${d.EXTENSIONID}/isWindow`]===f.metadata[`${d.EXTENSIONID}/isWindow`];let F=(t?!1:o.metadata[`${d.EXTENSIONID}/blocking`])===f.blocking;(!g||!O||!v||!S||!F||!k||!L||!R)&&this.UpdateWallToQueue(o,f,c)}}else this.wallsNotOwner.push(o.id)}const i=m.sceneLocal.filter(o=>jr(o));for(const o of i){if(!n.find(c=>c.id===o.attachedTo)){this.wallsToDelete.push(o.id);continue}this.wallsNotOwner.includes(o.attachedTo)&&this.wallsToDelete.push(o.id)}let s=!1;this.wallsToCreate.length>0&&(await w.scene.local.addItems(this.wallsToCreate),s=!0),this.wallsToDelete.length>0&&(await w.scene.local.deleteItems(this.wallsToDelete),s=!0),this.wallsToUpdate.length>0&&(await w.scene.local.updateItems(i.filter(o=>!this.wallsToDelete.includes(o.id)),o=>{for(let l of o){const c=this.wallsToUpdate.find(f=>f.id===l.id);c&&(l.points=c.points,l.position=c.position,l.rotation=c.rotation,l.scale=c.scale,l.blocking=c.blocking,l.visible=c.visible,l.doubleSided=c.doubleSided,l.zIndex=c.zIndex)}}),s=!0),this.wallsToError.length>0&&(await w.scene.items.updateItems(this.wallsToError,o=>{for(let l of o)l.style.strokeDash=[10,30],l.style.strokeColor="red",delete l.metadata[`${d.EXTENSIONID}/isDoorLocked`],delete l.metadata[`${d.EXTENSIONID}/doorOpen`],delete l.metadata[`${d.EXTENSIONID}/disabled`],delete l.metadata[`${d.EXTENSIONID}/isDoor`],delete l.metadata[`${d.EXTENSIONID}/doubleSided`],delete l.metadata[`${d.EXTENSIONID}/disabled`],delete l.metadata[`${d.EXTENSIONID}/isVisionLine`],delete l.metadata[`${d.EXTENSIONID}/blocking`]}),s=!0),this.wallsToCreate=[],this.wallsToUpdate=[],this.wallsToDelete=[],this.wallsToError=[],this.wallsNotOwner=[],m.playerRole==="GM"&&s&&(await this.VisibilityChecker.UpdateWallSegments(),s=!1)}CreateWallToQueue(e,t){if(!e.points)return;let n=e.metadata[`${d.EXTENSIONID}/blocking`]===!0;const i=e.metadata[`${d.EXTENSIONID}/isWindow`]===!0,s=e.metadata[`${d.EXTENSIONID}/doubleSided`]===!0;m.playerRole==="GM"&&m.sceneMetadata[`${d.EXTENSIONID}/passWallsGM`]===!0&&(n=!1);const o=cr().points(e.points).attachedTo(e.id).rotation(e.rotation).position(e.position).locked(!0).scale(e.scale).blocking(n).doubleSided(s).visible(!i).disableAttachmentBehavior(["VISIBLE"]).zIndex(this.GetDepth(t,!0)).metadata({[`${d.EXTENSIONID}/isVisionWall`]:!0}).build();this.wallsToCreate.push(o)}AddPersistentLightToQueue(e,t,n){const i=n??e;if((i.metadata[`${d.EXTENSIONID}/isTorch`]===!0?"SECONDARY":"PRIMARY")==="SECONDARY")return;const o=va().position(e.position).lightType("AUXILIARY").rotation(e.rotation).attenuationRadius(this.GetLightRange(i.metadata[`${d.EXTENSIONID}/visionRange`]??$e())).sourceRadius(this.GetLightRange(i.metadata[`${d.EXTENSIONID}/visionSourceRange`]??ze(),!0)).falloff(parseFloat(i.metadata[`${d.EXTENSIONID}/visionFallOff`]??at())).innerAngle(parseInt(i.metadata[`${d.EXTENSIONID}/visionInAngle`]??lt())).outerAngle(parseInt(i.metadata[`${d.EXTENSIONID}/visionOutAngle`]??Ze())).zIndex(this.GetDepth(t,!1)).metadata({[`${d.EXTENSIONID}/isPersistentLight`]:e.id,[`${d.EXTENSIONID}/getPersistentLight`]:!0}).build();if(this.lightsToCreate.push(o),this.persistentLights.push({id:o.id,position:o.position,rotation:o.rotation,zIndex:t,metadata:e.metadata}),this.persistenceLimit===this.persistentLights.length){const l=this.persistentLights.shift();this.lightsToDelete.push(l.id)}}CreateLightToQueue(e,t,n){const i=n??e,s=i.metadata[`${d.EXTENSIONID}/isTorch`]===!0?"SECONDARY":"PRIMARY",o=i.metadata[`${d.EXTENSIONID}/visionBlind`]===!0?0:this.GetLightRange(i.metadata[`${d.EXTENSIONID}/visionRange`]??$e()),l=parseInt(i.metadata[`${d.EXTENSIONID}/visionDark`])>parseInt(i.metadata[`${d.EXTENSIONID}/visionRange`]),c=this.GetLightRange(i.metadata[`${d.EXTENSIONID}/visionDark`]),f=va().position(e.position).rotation(e.rotation).lightType(s).attenuationRadius(l?c:o).sourceRadius(this.GetLightRange(i.metadata[`${d.EXTENSIONID}/visionSourceRange`]??ze(),!0)).falloff(parseFloat(i.metadata[`${d.EXTENSIONID}/visionFallOff`]??at())).innerAngle(parseInt(i.metadata[`${d.EXTENSIONID}/visionInAngle`]??lt())).outerAngle(parseInt(i.metadata[`${d.EXTENSIONID}/visionOutAngle`]??Ze())).zIndex(this.GetDepth(t,!1)).metadata({[`${d.EXTENSIONID}/isVisionLight`]:!0,[`${d.EXTENSIONID}/visionBlind`]:i.metadata[`${d.EXTENSIONID}/visionBlind`]===!0}).attachedTo(e.id).disableAttachmentBehavior(["SCALE","VISIBLE"]).build();this.lightsToCreate.push(f),s==="PRIMARY"&&(this.CreateTrailingFogRevealer(f),this.CreateDarkVisionToQueue(e,n),this.CreateOwnerHighlight(e,n))}CreateDarkVisionToQueue(e,t){const n=t??e,i=parseInt(n.metadata[`${d.EXTENSIONID}/visionDark`]),s=parseInt(n.metadata[`${d.EXTENSIONID}/visionRange`]);if(!i||!s||i<s)return;const o=this.GetLightRange(n.metadata[`${d.EXTENSIONID}/visionRange`])*2,l=this.GetLightRange(n.metadata[`${d.EXTENSIONID}/visionDark`])*2,c=o*.9/l/2,f=Qe().position({x:e.position.x-l/2,y:e.position.y-l/2}).attachedTo(e.id).width(l).height(l).blendMode("SATURATION").effectType("STANDALONE").sksl(d.DARKVISIONSHADER).metadata({[`${d.EXTENSIONID}/isDarkVision`]:!0}).disableHit(!0).disableAttachmentBehavior(["SCALE"]).uniforms([{name:"center",value:{x:.5,y:.5}},{name:"radius",value:.5},{name:"clear",value:c},{name:"smoothwidth",value:.075}]).build();this.darkVisionToCreate.push(f)}CreateDecalToQueue(e){const t=hn({height:e.image.height,width:e.image.width,url:e.image.url,mime:e.image.mime},{dpi:e.grid.dpi,offset:e.grid.offset}).rotation(e.rotation).scale(e.scale).position(e.position).attachedTo(e.id).layer("FOG").locked(!0).visible(!1).metadata({[`${d.EXTENSIONID}/isLocalDecal`]:e.id}).build();this.decalsToCreate.push(t)}UpdateWallToQueue(e,t,n){if(!e.points)return;let i=e.metadata[`${d.EXTENSIONID}/blocking`]===!0;m.playerRole==="GM"&&m.sceneMetadata[`${d.EXTENSIONID}/passWallsGM`]===!0&&(i=!1);const s={id:t.id,points:e.points,rotation:e.rotation,position:e.position,scale:e.scale,blocking:i,visible:!e.metadata[`${d.EXTENSIONID}/isWindow`],doubleSided:e.metadata[`${d.EXTENSIONID}/doubleSided`]===!0,zIndex:this.GetDepth(n,!0)};this.wallsToUpdate.push(s)}UpdateLightToQueue(e,t,n,i){const s=i??e,o=s.metadata[`${d.EXTENSIONID}/isTorch`]===!0?"SECONDARY":"PRIMARY",l=s.metadata[`${d.EXTENSIONID}/visionBlind`]===!0?0:this.GetLightRange(s.metadata[`${d.EXTENSIONID}/visionRange`]??$e()),c=parseInt(s.metadata[`${d.EXTENSIONID}/visionDark`])>parseInt(s.metadata[`${d.EXTENSIONID}/visionRange`]),f=this.GetLightRange(s.metadata[`${d.EXTENSIONID}/visionDark`]),g={id:t.id,attenuationRadius:c?f:l,sourceRadius:this.GetLightRange(s.metadata[`${d.EXTENSIONID}/visionSourceRange`]??ze(),!0),falloff:parseFloat(s.metadata[`${d.EXTENSIONID}/visionFallOff`]??at()),innerAngle:parseInt(s.metadata[`${d.EXTENSIONID}/visionInAngle`]??lt()),outerAngle:parseInt(s.metadata[`${d.EXTENSIONID}/visionOutAngle`]??Ze()),blind:s.metadata[`${d.EXTENSIONID}/visionBlind`]===!0,zIndex:this.GetDepth(n,!1)};this.lightsToUpdate.push(g),o==="PRIMARY"&&this.UpdateOwnerHightlight(e,i)}GetLightRange(e,t=!1){return(t?parseFloat(e):parseInt(e))/m.gridScale*m.gridDpi}GetDepth(e,t){if(e===-10){const i=m.sceneMetadata[`${d.EXTENSIONID}/defaultElevation`];typeof i=="string"&&(e=parseInt(i))}if(m.sceneMetadata[`${d.EXTENSIONID}/elevationComplex`]===!0)switch(e){case 1:return-5;case 2:return-6;case 3:return-7;case 4:return-8;case 5:return-9;case 6:return-10;default:return-1}else switch(e){case 1:return t?-4:-5;case 2:return t?-5:-6;case 3:return t?-6:-7;case 4:return t?-7:-8;case 5:return t?-8:-9;case 6:return t?-9:-10;default:return-1}}IsPositionClear(e){const t=(m.gridDpi-10)*this.persistenceCullingDistance;for(const n of this.persistentLights)if(gn(e,n.position)<=t)return!1;return!0}IsPositionAndRotationClear(e,t){const n=(m.gridDpi-10)*this.persistenceCullingDistance;for(const i of this.persistentLights)if(gn(t,i.position)<=n&&e===i.rotation)return!1;return!0}async ToggleDoor(e){const t=m.sceneLocal.filter(n=>n.id===e&&n.metadata[`${d.EXTENSIONID}/localDoor`]===!0);if(t.length===1){const n=m.sceneItems.filter(i=>i.id===t[0].attachedTo);if(n.length===1){const i=n[0];if(m.playerRole!=="GM"&&i.metadata[`${d.EXTENSIONID}/isDoorLocked`])return;await w.scene.items.updateItems(n,s=>{for(let o of s)o.metadata[`${d.EXTENSIONID}/isVisionLine`]&&o.metadata[`${d.EXTENSIONID}/disabled`]?(delete o.metadata[`${d.EXTENSIONID}/disabled`],delete o.metadata[`${d.EXTENSIONID}/doorOpen`]):o.metadata[`${d.EXTENSIONID}/isVisionLine`]&&(o.metadata[`${d.EXTENSIONID}/disabled`]=!0,o.metadata[`${d.EXTENSIONID}/doorOpen`]=!0,delete o.metadata[`${d.EXTENSIONID}/isDoorLocked`])}),await w.player.deselect([e])}}}}const Ie=new ss;function xn(a,e){a.split(/\s+/).forEach(t=>{e(t)})}class os{constructor(){this._events={}}on(e,t){xn(e,n=>{const i=this._events[n]||[];i.push(t),this._events[n]=i})}off(e,t){var n=arguments.length;if(n===0){this._events={};return}xn(e,i=>{if(n===1){delete this._events[i];return}const s=this._events[i];s!==void 0&&(s.splice(s.indexOf(t),1),this._events[i]=s)})}trigger(e,...t){var n=this;xn(e,i=>{const s=n._events[i];s!==void 0&&s.forEach(o=>{o.apply(n,t)})})}}function ds(a){return a.plugins={},class extends a{constructor(){super(...arguments),this.plugins={names:[],settings:{},requested:{},loaded:{}}}static define(e,t){a.plugins[e]={name:e,fn:t}}initializePlugins(e){var t,n;const i=this,s=[];if(Array.isArray(e))e.forEach(o=>{typeof o=="string"?s.push(o):(i.plugins.settings[o.name]=o.options,s.push(o.name))});else if(e)for(t in e)e.hasOwnProperty(t)&&(i.plugins.settings[t]=e[t],s.push(t));for(;n=s.shift();)i.require(n)}loadPlugin(e){var t=this,n=t.plugins,i=a.plugins[e];if(!a.plugins.hasOwnProperty(e))throw new Error('Unable to find "'+e+'" plugin');n.requested[e]=!0,n.loaded[e]=i.fn.apply(t,[t.plugins.settings[e]||{}]),n.names.push(e)}require(e){var t=this,n=t.plugins;if(!t.plugins.loaded.hasOwnProperty(e)){if(n.requested[e])throw new Error('Plugin has circular dependency ("'+e+'")');t.loadPlugin(e)}return n.loaded[e]}}}const Nn=a=>(a=a.filter(Boolean),a.length<2?a[0]||"":cs(a)==1?"["+a.join("")+"]":"(?:"+a.join("|")+")"),Mi=a=>{if(!ls(a))return a.join("");let e="",t=0;const n=()=>{t>1&&(e+="{"+t+"}")};return a.forEach((i,s)=>{if(i===a[s-1]){t++;return}n(),e+=i,t=1}),n(),e},$i=a=>{let e=Array.from(a);return Nn(e)},ls=a=>new Set(a).size!==a.length,Yt=a=>(a+"").replace(/([\$\(\)\*\+\.\?\[\]\^\{\|\}\\])/gu,"\\$1"),cs=a=>a.reduce((e,t)=>Math.max(e,us(t)),0),us=a=>Array.from(a).length,Ai=a=>{if(a.length===1)return[[a]];let e=[];const t=a.substring(1);return Ai(t).forEach(function(i){let s=i.slice(0);s[0]=a.charAt(0)+s[0],e.push(s),s=i.slice(0),s.unshift(a.charAt(0)),e.push(s)}),e},fs=[[0,65535]],ps="[̀-ͯ·ʾʼ]";let En,xi;const hs=3,oa={},_a={"/":"⁄∕",0:"߀",a:"ⱥɐɑ",aa:"ꜳ",ae:"æǽǣ",ao:"ꜵ",au:"ꜷ",av:"ꜹꜻ",ay:"ꜽ",b:"ƀɓƃ",c:"ꜿƈȼↄ",d:"đɗɖᴅƌꮷԁɦ",e:"ɛǝᴇɇ",f:"ꝼƒ",g:"ǥɠꞡᵹꝿɢ",h:"ħⱨⱶɥ",i:"ɨı",j:"ɉȷ",k:"ƙⱪꝁꝃꝅꞣ",l:"łƚɫⱡꝉꝇꞁɭ",m:"ɱɯϻ",n:"ꞥƞɲꞑᴎлԉ",o:"øǿɔɵꝋꝍᴑ",oe:"œ",oi:"ƣ",oo:"ꝏ",ou:"ȣ",p:"ƥᵽꝑꝓꝕρ",q:"ꝗꝙɋ",r:"ɍɽꝛꞧꞃ",s:"ßȿꞩꞅʂ",t:"ŧƭʈⱦꞇ",th:"þ",tz:"ꜩ",u:"ʉ",v:"ʋꝟʌ",vy:"ꝡ",w:"ⱳ",y:"ƴɏỿ",z:"ƶȥɀⱬꝣ",hv:"ƕ"};for(let a in _a){let e=_a[a]||"";for(let t=0;t<e.length;t++){let n=e.substring(t,t+1);oa[n]=a}}const gs=new RegExp(Object.keys(oa).join("|")+"|"+ps,"gu"),ms=a=>{En===void 0&&(En=Is(fs))},ka=(a,e="NFKD")=>a.normalize(e),In=a=>Array.from(a).reduce((e,t)=>e+vs(t),""),vs=a=>(a=ka(a).toLowerCase().replace(gs,e=>oa[e]||""),ka(a,"NFC"));function*ys(a){for(const[e,t]of a)for(let n=e;n<=t;n++){let i=String.fromCharCode(n),s=In(i);s!=i.toLowerCase()&&(s.length>hs||s.length!=0&&(yield{folded:s,composed:i,code_point:n}))}}const Es=a=>{const e={},t=(n,i)=>{const s=e[n]||new Set,o=new RegExp("^"+$i(s)+"$","iu");i.match(o)||(s.add(Yt(i)),e[n]=s)};for(let n of ys(a))t(n.folded,n.folded),t(n.folded,n.composed);return e},Is=a=>{const e=Es(a),t={};let n=[];for(let s in e){let o=e[s];o&&(t[s]=$i(o)),s.length>1&&n.push(Yt(s))}n.sort((s,o)=>o.length-s.length);const i=Nn(n);return xi=new RegExp("^"+i,"u"),t},ws=(a,e=1)=>{let t=0;return a=a.map(n=>(En[n]&&(t+=n.length),En[n]||n)),t>=e?Mi(a):""},bs=(a,e=1)=>(e=Math.max(e,a.length-1),Nn(Ai(a).map(t=>ws(t,e)))),Da=(a,e=!0)=>{let t=a.length>1?1:0;return Nn(a.map(n=>{let i=[];const s=e?n.length():n.length()-1;for(let o=0;o<s;o++)i.push(bs(n.substrs[o]||"",t));return Mi(i)}))},Ts=(a,e)=>{for(const t of e){if(t.start!=a.start||t.end!=a.end||t.substrs.join("")!==a.substrs.join(""))continue;let n=a.parts;const i=o=>{for(const l of n){if(l.start===o.start&&l.substr===o.substr)return!1;if(!(o.length==1||l.length==1)&&(o.start<l.start&&o.end>l.start||l.start<o.start&&l.end>o.start))return!0}return!1};if(!(t.parts.filter(i).length>0))return!0}return!1};class wn{parts;substrs;start;end;constructor(){this.parts=[],this.substrs=[],this.start=0,this.end=0}add(e){e&&(this.parts.push(e),this.substrs.push(e.substr),this.start=Math.min(e.start,this.start),this.end=Math.max(e.end,this.end))}last(){return this.parts[this.parts.length-1]}length(){return this.parts.length}clone(e,t){let n=new wn,i=JSON.parse(JSON.stringify(this.parts)),s=i.pop();for(const c of i)n.add(c);let o=t.substr.substring(0,e-s.start),l=o.length;return n.add({start:s.start,end:s.start+l,length:l,substr:o}),n}}const Ss=a=>{ms(),a=In(a);let e="",t=[new wn];for(let n=0;n<a.length;n++){let s=a.substring(n).match(xi);const o=a.substring(n,n+1),l=s?s[0]:null;let c=[],f=new Set;for(const g of t){const v=g.last();if(!v||v.length==1||v.end<=n)if(l){const S=l.length;g.add({start:n,end:n+S,length:S,substr:l}),f.add("1")}else g.add({start:n,end:n+1,length:1,substr:o}),f.add("2");else if(l){let S=g.clone(n,v);const O=l.length;S.add({start:n,end:n+O,length:O,substr:l}),c.push(S)}else f.add("3")}if(c.length>0){c=c.sort((g,v)=>g.length()-v.length());for(let g of c)Ts(g,t)||t.push(g);continue}if(n>0&&f.size==1&&!f.has("3")){e+=Da(t,!1);let g=new wn;const v=t[0];v&&g.add(v.last()),t=[g]}}return e+=Da(t,!0),e},Ns=(a,e)=>{if(a)return a[e]},Os=(a,e)=>{if(a){for(var t,n=e.split(".");(t=n.shift())&&(a=a[t]););return a}},Pn=(a,e,t)=>{var n,i;return!a||(a=a+"",e.regex==null)||(i=a.search(e.regex),i===-1)?0:(n=e.string.length/a.length,i===0&&(n+=.5),n*t)},Rn=(a,e)=>{var t=a[e];if(typeof t=="function")return t;t&&!Array.isArray(t)&&(a[e]=[t])},rn=(a,e)=>{if(Array.isArray(a))a.forEach(e);else for(var t in a)a.hasOwnProperty(t)&&e(a[t],t)},_s=(a,e)=>typeof a=="number"&&typeof e=="number"?a>e?1:a<e?-1:0:(a=In(a+"").toLowerCase(),e=In(e+"").toLowerCase(),a>e?1:e>a?-1:0);class ks{items;settings;constructor(e,t){this.items=e,this.settings=t||{diacritics:!0}}tokenize(e,t,n){if(!e||!e.length)return[];const i=[],s=e.split(/\s+/);var o;return n&&(o=new RegExp("^("+Object.keys(n).map(Yt).join("|")+"):(.*)$")),s.forEach(l=>{let c,f=null,g=null;o&&(c=l.match(o))&&(f=c[1],l=c[2]),l.length>0&&(this.settings.diacritics?g=Ss(l)||null:g=Yt(l),g&&t&&(g="\\b"+g)),i.push({string:l,regex:g?new RegExp(g,"iu"):null,field:f})}),i}getScoreFunction(e,t){var n=this.prepareSearch(e,t);return this._getScoreFunction(n)}_getScoreFunction(e){const t=e.tokens,n=t.length;if(!n)return function(){return 0};const i=e.options.fields,s=e.weights,o=i.length,l=e.getAttrFn;if(!o)return function(){return 1};const c=function(){return o===1?function(f,g){const v=i[0].field;return Pn(l(g,v),f,s[v]||1)}:function(f,g){var v=0;if(f.field){const S=l(g,f.field);!f.regex&&S?v+=1/o:v+=Pn(S,f,1)}else rn(s,(S,O)=>{v+=Pn(l(g,O),f,S)});return v/o}}();return n===1?function(f){return c(t[0],f)}:e.options.conjunction==="and"?function(f){var g,v=0;for(let S of t){if(g=c(S,f),g<=0)return 0;v+=g}return v/n}:function(f){var g=0;return rn(t,v=>{g+=c(v,f)}),g/n}}getSortFunction(e,t){var n=this.prepareSearch(e,t);return this._getSortFunction(n)}_getSortFunction(e){var t,n=[];const i=this,s=e.options,o=!e.query&&s.sort_empty?s.sort_empty:s.sort;if(typeof o=="function")return o.bind(this);const l=function(f,g){return f==="$score"?g.score:e.getAttrFn(i.items[g.id],f)};if(o)for(let f of o)(e.query||f.field!=="$score")&&n.push(f);if(e.query){t=!0;for(let f of n)if(f.field==="$score"){t=!1;break}t&&n.unshift({field:"$score",direction:"desc"})}else n=n.filter(f=>f.field!=="$score");return n.length?function(f,g){var v,S;for(let O of n)if(S=O.field,v=(O.direction==="desc"?-1:1)*_s(l(S,f),l(S,g)),v)return v;return 0}:null}prepareSearch(e,t){const n={};var i=Object.assign({},t);if(Rn(i,"sort"),Rn(i,"sort_empty"),i.fields){Rn(i,"fields");const s=[];i.fields.forEach(o=>{typeof o=="string"&&(o={field:o,weight:1}),s.push(o),n[o.field]="weight"in o?o.weight:1}),i.fields=s}return{options:i,query:e.toLowerCase().trim(),tokens:this.tokenize(e,i.respect_word_boundaries,n),total:0,items:[],weights:n,getAttrFn:i.nesting?Os:Ns}}search(e,t){var n=this,i,s;s=this.prepareSearch(e,t),t=s.options,e=s.query;const o=t.score||n._getScoreFunction(s);e.length?rn(n.items,(c,f)=>{i=o(c),(t.filter===!1||i>0)&&s.items.push({score:i,id:f})}):rn(n.items,(c,f)=>{s.items.push({score:1,id:f})});const l=n._getSortFunction(s);return l&&s.items.sort(l),s.total=s.items.length,typeof t.limit=="number"&&(s.items=s.items.slice(0,t.limit)),s}}const Be=a=>typeof a>"u"||a===null?null:fn(a),fn=a=>typeof a=="boolean"?a?"1":"0":a+"",Xn=a=>(a+"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;"),Ds=(a,e)=>e>0?window.setTimeout(a,e):(a.call(null),null),Cs=(a,e)=>{var t;return function(n,i){var s=this;t&&(s.loading=Math.max(s.loading-1,0),clearTimeout(t)),t=setTimeout(function(){t=null,s.loadedSearches[n]=!0,a.call(s,n,i)},e)}},Ca=(a,e,t)=>{var n,i=a.trigger,s={};a.trigger=function(){var o=arguments[0];if(e.indexOf(o)!==-1)s[o]=arguments;else return i.apply(a,arguments)},t.apply(a,[]),a.trigger=i;for(n of e)n in s&&i.apply(a,s[n])},Ls=a=>({start:a.selectionStart||0,length:(a.selectionEnd||0)-(a.selectionStart||0)}),pe=(a,e=!1)=>{a&&(a.preventDefault(),e&&a.stopPropagation())},we=(a,e,t,n)=>{a.addEventListener(e,t,n)},mt=(a,e)=>{if(!e||!e[a])return!1;var t=(e.altKey?1:0)+(e.ctrlKey?1:0)+(e.shiftKey?1:0)+(e.metaKey?1:0);return t===1},Vn=(a,e)=>{const t=a.getAttribute("id");return t||(a.setAttribute("id",e),e)},La=a=>a.replace(/[\\"']/g,"\\$&"),vt=(a,e)=>{e&&a.append(e)},ve=(a,e)=>{if(Array.isArray(a))a.forEach(e);else for(var t in a)a.hasOwnProperty(t)&&e(a[t],t)},Ye=a=>{if(a.jquery)return a[0];if(a instanceof HTMLElement)return a;if(Pi(a)){var e=document.createElement("template");return e.innerHTML=a.trim(),e.content.firstChild}return document.querySelector(a)},Pi=a=>typeof a=="string"&&a.indexOf("<")>-1,Ms=a=>a.replace(/['"\\]/g,"\\$&"),Hn=(a,e)=>{var t=document.createEvent("HTMLEvents");t.initEvent(e,!0,!1),a.dispatchEvent(t)},sn=(a,e)=>{Object.assign(a.style,e)},Me=(a,...e)=>{var t=Ri(e);a=Xi(a),a.map(n=>{t.map(i=>{n.classList.add(i)})})},ot=(a,...e)=>{var t=Ri(e);a=Xi(a),a.map(n=>{t.map(i=>{n.classList.remove(i)})})},Ri=a=>{var e=[];return ve(a,t=>{typeof t=="string"&&(t=t.trim().split(/[\t\n\f\r\s]/)),Array.isArray(t)&&(e=e.concat(t))}),e.filter(Boolean)},Xi=a=>(Array.isArray(a)||(a=[a]),a),Fn=(a,e,t)=>{if(!(t&&!t.contains(a)))for(;a&&a.matches;){if(a.matches(e))return a;a=a.parentNode}},Ma=(a,e=0)=>e>0?a[a.length-1]:a[0],$s=a=>Object.keys(a).length===0,$a=(a,e)=>{if(!a)return-1;e=e||a.nodeName;for(var t=0;a=a.previousElementSibling;)a.matches(e)&&t++;return t},ue=(a,e)=>{ve(e,(t,n)=>{t==null?a.removeAttribute(n):a.setAttribute(n,""+t)})},Qn=(a,e)=>{a.parentNode&&a.parentNode.replaceChild(e,a)},As=(a,e)=>{if(e===null)return;if(typeof e=="string"){if(!e.length)return;e=new RegExp(e,"i")}const t=s=>{var o=s.data.match(e);if(o&&s.data.length>0){var l=document.createElement("span");l.className="highlight";var c=s.splitText(o.index);c.splitText(o[0].length);var f=c.cloneNode(!0);return l.appendChild(f),Qn(c,l),1}return 0},n=s=>{s.nodeType===1&&s.childNodes&&!/(script|style)/i.test(s.tagName)&&(s.className!=="highlight"||s.tagName!=="SPAN")&&Array.from(s.childNodes).forEach(o=>{i(o)})},i=s=>s.nodeType===3?t(s):(n(s),0);i(a)},xs=a=>{var e=a.querySelectorAll("span.highlight");Array.prototype.forEach.call(e,function(t){var n=t.parentNode;n.replaceChild(t.firstChild,t),n.normalize()})},Ps=65,Rs=13,Xs=27,Vs=37,Hs=38,Fs=39,Bs=40,Aa=8,Us=46,xa=9,zs=typeof navigator>"u"?!1:/Mac/.test(navigator.userAgent),on=zs?"metaKey":"ctrlKey",Pa={options:[],optgroups:[],plugins:[],delimiter:",",splitOn:null,persist:!0,diacritics:!0,create:null,createOnBlur:!1,createFilter:null,highlight:!0,openOnFocus:!0,shouldOpen:null,maxOptions:50,maxItems:null,hideSelected:null,duplicates:!1,addPrecedence:!1,selectOnTab:!1,preload:null,allowEmptyOption:!1,refreshThrottle:300,loadThrottle:300,loadingClass:"loading",dataAttr:null,optgroupField:"optgroup",valueField:"value",labelField:"text",disabledField:"disabled",optgroupLabelField:"label",optgroupValueField:"value",lockOptgroupOrder:!1,sortField:"$order",searchField:["text"],searchConjunction:"and",mode:null,wrapperClass:"ts-wrapper",controlClass:"ts-control",dropdownClass:"ts-dropdown",dropdownContentClass:"ts-dropdown-content",itemClass:"item",optionClass:"option",dropdownParent:null,controlInput:'<input type="text" autocomplete="off" size="1" />',copyClassesToDropdown:!1,placeholder:null,hidePlaceholder:null,shouldLoad:function(a){return a.length>0},render:{}};function Ra(a,e){var t=Object.assign({},Pa,e),n=t.dataAttr,i=t.labelField,s=t.valueField,o=t.disabledField,l=t.optgroupField,c=t.optgroupLabelField,f=t.optgroupValueField,g=a.tagName.toLowerCase(),v=a.getAttribute("placeholder")||a.getAttribute("data-placeholder");if(!v&&!t.allowEmptyOption){let L=a.querySelector('option[value=""]');L&&(v=L.textContent)}var S={placeholder:v,options:[],optgroups:[],items:[],maxItems:null},O=()=>{var L,R=S.options,F={},M=1;let z=0;var r=h=>{var T=Object.assign({},h.dataset),y=n&&T[n];return typeof y=="string"&&y.length&&(T=Object.assign(T,JSON.parse(y))),T},p=(h,T)=>{var y=Be(h.value);if(y!=null&&!(!y&&!t.allowEmptyOption)){if(F.hasOwnProperty(y)){if(T){var E=F[y][l];E?Array.isArray(E)?E.push(T):F[y][l]=[E,T]:F[y][l]=T}}else{var I=r(h);I[i]=I[i]||h.textContent,I[s]=I[s]||y,I[o]=I[o]||h.disabled,I[l]=I[l]||T,I.$option=h,I.$order=I.$order||++z,F[y]=I,R.push(I)}h.selected&&S.items.push(y)}},u=h=>{var T,y;y=r(h),y[c]=y[c]||h.getAttribute("label")||"",y[f]=y[f]||M++,y[o]=y[o]||h.disabled,y.$order=y.$order||++z,S.optgroups.push(y),T=y[f],ve(h.children,E=>{p(E,T)})};S.maxItems=a.hasAttribute("multiple")?null:1,ve(a.children,h=>{L=h.tagName.toLowerCase(),L==="optgroup"?u(h):L==="option"&&p(h)})},k=()=>{const L=a.getAttribute(n);if(L)S.options=JSON.parse(L),ve(S.options,F=>{S.items.push(F[s])});else{var R=a.value.trim()||"";if(!t.allowEmptyOption&&!R.length)return;const F=R.split(t.delimiter);ve(F,M=>{const z={};z[i]=M,z[s]=M,S.options.push(z)}),S.items=F}};return g==="select"?O():k(),Object.assign({},Pa,S,e)}var Xa=0;class Te extends ds(os){constructor(e,t){super(),this.order=0,this.isOpen=!1,this.isDisabled=!1,this.isReadOnly=!1,this.isInvalid=!1,this.isValid=!0,this.isLocked=!1,this.isFocused=!1,this.isInputHidden=!1,this.isSetup=!1,this.ignoreFocus=!1,this.ignoreHover=!1,this.hasOptions=!1,this.lastValue="",this.caretPos=0,this.loading=0,this.loadedSearches={},this.activeOption=null,this.activeItems=[],this.optgroups={},this.options={},this.userOptions={},this.items=[],this.refreshTimeout=null,Xa++;var n,i=Ye(e);if(i.tomselect)throw new Error("Tom Select already initialized on this element");i.tomselect=this;var s=window.getComputedStyle&&window.getComputedStyle(i,null);n=s.getPropertyValue("direction");const o=Ra(i,t);this.settings=o,this.input=i,this.tabIndex=i.tabIndex||0,this.is_select_tag=i.tagName.toLowerCase()==="select",this.rtl=/rtl/i.test(n),this.inputId=Vn(i,"tomselect-"+Xa),this.isRequired=i.required,this.sifter=new ks(this.options,{diacritics:o.diacritics}),o.mode=o.mode||(o.maxItems===1?"single":"multi"),typeof o.hideSelected!="boolean"&&(o.hideSelected=o.mode==="multi"),typeof o.hidePlaceholder!="boolean"&&(o.hidePlaceholder=o.mode!=="multi");var l=o.createFilter;typeof l!="function"&&(typeof l=="string"&&(l=new RegExp(l)),l instanceof RegExp?o.createFilter=R=>l.test(R):o.createFilter=R=>this.settings.duplicates||!this.options[R]),this.initializePlugins(o.plugins),this.setupCallbacks(),this.setupTemplates();const c=Ye("<div>"),f=Ye("<div>"),g=this._render("dropdown"),v=Ye('<div role="listbox" tabindex="-1">'),S=this.input.getAttribute("class")||"",O=o.mode;var k;if(Me(c,o.wrapperClass,S,O),Me(f,o.controlClass),vt(c,f),Me(g,o.dropdownClass,O),o.copyClassesToDropdown&&Me(g,S),Me(v,o.dropdownContentClass),vt(g,v),Ye(o.dropdownParent||c).appendChild(g),Pi(o.controlInput)){k=Ye(o.controlInput);var L=["autocorrect","autocapitalize","autocomplete","spellcheck"];ve(L,R=>{i.getAttribute(R)&&ue(k,{[R]:i.getAttribute(R)})}),k.tabIndex=-1,f.appendChild(k),this.focus_node=k}else o.controlInput?(k=Ye(o.controlInput),this.focus_node=k):(k=Ye("<input/>"),this.focus_node=f);this.wrapper=c,this.dropdown=g,this.dropdown_content=v,this.control=f,this.control_input=k,this.setup()}setup(){const e=this,t=e.settings,n=e.control_input,i=e.dropdown,s=e.dropdown_content,o=e.wrapper,l=e.control,c=e.input,f=e.focus_node,g={passive:!0},v=e.inputId+"-ts-dropdown";ue(s,{id:v}),ue(f,{role:"combobox","aria-haspopup":"listbox","aria-expanded":"false","aria-controls":v});const S=Vn(f,e.inputId+"-ts-control"),O="label[for='"+Ms(e.inputId)+"']",k=document.querySelector(O),L=e.focus.bind(e);if(k){we(k,"click",L),ue(k,{for:S});const M=Vn(k,e.inputId+"-ts-label");ue(f,{"aria-labelledby":M}),ue(s,{"aria-labelledby":M})}if(o.style.width=c.style.width,e.plugins.names.length){const M="plugin-"+e.plugins.names.join(" plugin-");Me([o,i],M)}(t.maxItems===null||t.maxItems>1)&&e.is_select_tag&&ue(c,{multiple:"multiple"}),t.placeholder&&ue(n,{placeholder:t.placeholder}),!t.splitOn&&t.delimiter&&(t.splitOn=new RegExp("\\s*"+Yt(t.delimiter)+"+\\s*")),t.load&&t.loadThrottle&&(t.load=Cs(t.load,t.loadThrottle)),we(i,"mousemove",()=>{e.ignoreHover=!1}),we(i,"mouseenter",M=>{var z=Fn(M.target,"[data-selectable]",i);z&&e.onOptionHover(M,z)},{capture:!0}),we(i,"click",M=>{const z=Fn(M.target,"[data-selectable]");z&&(e.onOptionSelect(M,z),pe(M,!0))}),we(l,"click",M=>{var z=Fn(M.target,"[data-ts-item]",l);if(z&&e.onItemSelect(M,z)){pe(M,!0);return}n.value==""&&(e.onClick(),pe(M,!0))}),we(f,"keydown",M=>e.onKeyDown(M)),we(n,"keypress",M=>e.onKeyPress(M)),we(n,"input",M=>e.onInput(M)),we(f,"blur",M=>e.onBlur(M)),we(f,"focus",M=>e.onFocus(M)),we(n,"paste",M=>e.onPaste(M));const R=M=>{const z=M.composedPath()[0];if(!o.contains(z)&&!i.contains(z)){e.isFocused&&e.blur(),e.inputState();return}z==n&&e.isOpen?M.stopPropagation():pe(M,!0)},F=()=>{e.isOpen&&e.positionDropdown()};we(document,"mousedown",R),we(window,"scroll",F,g),we(window,"resize",F,g),this._destroy=()=>{document.removeEventListener("mousedown",R),window.removeEventListener("scroll",F),window.removeEventListener("resize",F),k&&k.removeEventListener("click",L)},this.revertSettings={innerHTML:c.innerHTML,tabIndex:c.tabIndex},c.tabIndex=-1,c.insertAdjacentElement("afterend",e.wrapper),e.sync(!1),t.items=[],delete t.optgroups,delete t.options,we(c,"invalid",()=>{e.isValid&&(e.isValid=!1,e.isInvalid=!0,e.refreshState())}),e.updateOriginalInput(),e.refreshItems(),e.close(!1),e.inputState(),e.isSetup=!0,c.disabled?e.disable():c.readOnly?e.setReadOnly(!0):e.enable(),e.on("change",this.onChange),Me(c,"tomselected","ts-hidden-accessible"),e.trigger("initialize"),t.preload===!0&&e.preload()}setupOptions(e=[],t=[]){this.addOptions(e),ve(t,n=>{this.registerOptionGroup(n)})}setupTemplates(){var e=this,t=e.settings.labelField,n=e.settings.optgroupLabelField,i={optgroup:s=>{let o=document.createElement("div");return o.className="optgroup",o.appendChild(s.options),o},optgroup_header:(s,o)=>'<div class="optgroup-header">'+o(s[n])+"</div>",option:(s,o)=>"<div>"+o(s[t])+"</div>",item:(s,o)=>"<div>"+o(s[t])+"</div>",option_create:(s,o)=>'<div class="create">Add <strong>'+o(s.input)+"</strong>&hellip;</div>",no_results:()=>'<div class="no-results">No results found</div>',loading:()=>'<div class="spinner"></div>',not_loading:()=>{},dropdown:()=>"<div></div>"};e.settings.render=Object.assign({},i,e.settings.render)}setupCallbacks(){var e,t,n={initialize:"onInitialize",change:"onChange",item_add:"onItemAdd",item_remove:"onItemRemove",item_select:"onItemSelect",clear:"onClear",option_add:"onOptionAdd",option_remove:"onOptionRemove",option_clear:"onOptionClear",optgroup_add:"onOptionGroupAdd",optgroup_remove:"onOptionGroupRemove",optgroup_clear:"onOptionGroupClear",dropdown_open:"onDropdownOpen",dropdown_close:"onDropdownClose",type:"onType",load:"onLoad",focus:"onFocus",blur:"onBlur"};for(e in n)t=this.settings[n[e]],t&&this.on(e,t)}sync(e=!0){const t=this,n=e?Ra(t.input,{delimiter:t.settings.delimiter}):t.settings;t.setupOptions(n.options,n.optgroups),t.setValue(n.items||[],!0),t.lastQuery=null}onClick(){var e=this;if(e.activeItems.length>0){e.clearActiveItems(),e.focus();return}e.isFocused&&e.isOpen?e.blur():e.focus()}onMouseDown(){}onChange(){Hn(this.input,"input"),Hn(this.input,"change")}onPaste(e){var t=this;if(t.isInputHidden||t.isLocked){pe(e);return}t.settings.splitOn&&setTimeout(()=>{var n=t.inputValue();if(n.match(t.settings.splitOn)){var i=n.trim().split(t.settings.splitOn);ve(i,s=>{Be(s)&&(this.options[s]?t.addItem(s):t.createItem(s))})}},0)}onKeyPress(e){var t=this;if(t.isLocked){pe(e);return}var n=String.fromCharCode(e.keyCode||e.which);if(t.settings.create&&t.settings.mode==="multi"&&n===t.settings.delimiter){t.createItem(),pe(e);return}}onKeyDown(e){var t=this;if(t.ignoreHover=!0,t.isLocked){e.keyCode!==xa&&pe(e);return}switch(e.keyCode){case Ps:if(mt(on,e)&&t.control_input.value==""){pe(e),t.selectAll();return}break;case Xs:t.isOpen&&(pe(e,!0),t.close()),t.clearActiveItems();return;case Bs:if(!t.isOpen&&t.hasOptions)t.open();else if(t.activeOption){let n=t.getAdjacent(t.activeOption,1);n&&t.setActiveOption(n)}pe(e);return;case Hs:if(t.activeOption){let n=t.getAdjacent(t.activeOption,-1);n&&t.setActiveOption(n)}pe(e);return;case Rs:t.canSelect(t.activeOption)?(t.onOptionSelect(e,t.activeOption),pe(e)):(t.settings.create&&t.createItem()||document.activeElement==t.control_input&&t.isOpen)&&pe(e);return;case Vs:t.advanceSelection(-1,e);return;case Fs:t.advanceSelection(1,e);return;case xa:t.settings.selectOnTab&&(t.canSelect(t.activeOption)&&(t.onOptionSelect(e,t.activeOption),pe(e)),t.settings.create&&t.createItem()&&pe(e));return;case Aa:case Us:t.deleteSelection(e);return}t.isInputHidden&&!mt(on,e)&&pe(e)}onInput(e){if(this.isLocked)return;const t=this.inputValue();if(this.lastValue!==t){if(this.lastValue=t,t==""){this._onInput();return}this.refreshTimeout&&window.clearTimeout(this.refreshTimeout),this.refreshTimeout=Ds(()=>{this.refreshTimeout=null,this._onInput()},this.settings.refreshThrottle)}}_onInput(){const e=this.lastValue;this.settings.shouldLoad.call(this,e)&&this.load(e),this.refreshOptions(),this.trigger("type",e)}onOptionHover(e,t){this.ignoreHover||this.setActiveOption(t,!1)}onFocus(e){var t=this,n=t.isFocused;if(t.isDisabled||t.isReadOnly){t.blur(),pe(e);return}t.ignoreFocus||(t.isFocused=!0,t.settings.preload==="focus"&&t.preload(),n||t.trigger("focus"),t.activeItems.length||(t.inputState(),t.refreshOptions(!!t.settings.openOnFocus)),t.refreshState())}onBlur(e){if(document.hasFocus()!==!1){var t=this;if(t.isFocused){t.isFocused=!1,t.ignoreFocus=!1;var n=()=>{t.close(),t.setActiveItem(),t.setCaret(t.items.length),t.trigger("blur")};t.settings.create&&t.settings.createOnBlur?t.createItem(null,n):n()}}}onOptionSelect(e,t){var n,i=this;t.parentElement&&t.parentElement.matches("[data-disabled]")||(t.classList.contains("create")?i.createItem(null,()=>{i.settings.closeAfterSelect&&i.close()}):(n=t.dataset.value,typeof n<"u"&&(i.lastQuery=null,i.addItem(n),i.settings.closeAfterSelect&&i.close(),!i.settings.hideSelected&&e.type&&/click/.test(e.type)&&i.setActiveOption(t))))}canSelect(e){return!!(this.isOpen&&e&&this.dropdown_content.contains(e))}onItemSelect(e,t){var n=this;return!n.isLocked&&n.settings.mode==="multi"?(pe(e),n.setActiveItem(t,e),!0):!1}canLoad(e){return!(!this.settings.load||this.loadedSearches.hasOwnProperty(e))}load(e){const t=this;if(!t.canLoad(e))return;Me(t.wrapper,t.settings.loadingClass),t.loading++;const n=t.loadCallback.bind(t);t.settings.load.call(t,e,n)}loadCallback(e,t){const n=this;n.loading=Math.max(n.loading-1,0),n.lastQuery=null,n.clearActiveOption(),n.setupOptions(e,t),n.refreshOptions(n.isFocused&&!n.isInputHidden),n.loading||ot(n.wrapper,n.settings.loadingClass),n.trigger("load",e,t)}preload(){var e=this.wrapper.classList;e.contains("preloaded")||(e.add("preloaded"),this.load(""))}setTextboxValue(e=""){var t=this.control_input,n=t.value!==e;n&&(t.value=e,Hn(t,"update"),this.lastValue=e)}getValue(){return this.is_select_tag&&this.input.hasAttribute("multiple")?this.items:this.items.join(this.settings.delimiter)}setValue(e,t){var n=t?[]:["change"];Ca(this,n,()=>{this.clear(t),this.addItems(e,t)})}setMaxItems(e){e===0&&(e=null),this.settings.maxItems=e,this.refreshState()}setActiveItem(e,t){var n=this,i,s,o,l,c,f;if(n.settings.mode!=="single"){if(!e){n.clearActiveItems(),n.isFocused&&n.inputState();return}if(i=t&&t.type.toLowerCase(),i==="click"&&mt("shiftKey",t)&&n.activeItems.length){for(f=n.getLastActive(),o=Array.prototype.indexOf.call(n.control.children,f),l=Array.prototype.indexOf.call(n.control.children,e),o>l&&(c=o,o=l,l=c),s=o;s<=l;s++)e=n.control.children[s],n.activeItems.indexOf(e)===-1&&n.setActiveItemClass(e);pe(t)}else i==="click"&&mt(on,t)||i==="keydown"&&mt("shiftKey",t)?e.classList.contains("active")?n.removeActiveItem(e):n.setActiveItemClass(e):(n.clearActiveItems(),n.setActiveItemClass(e));n.inputState(),n.isFocused||n.focus()}}setActiveItemClass(e){const t=this,n=t.control.querySelector(".last-active");n&&ot(n,"last-active"),Me(e,"active last-active"),t.trigger("item_select",e),t.activeItems.indexOf(e)==-1&&t.activeItems.push(e)}removeActiveItem(e){var t=this.activeItems.indexOf(e);this.activeItems.splice(t,1),ot(e,"active")}clearActiveItems(){ot(this.activeItems,"active"),this.activeItems=[]}setActiveOption(e,t=!0){e!==this.activeOption&&(this.clearActiveOption(),e&&(this.activeOption=e,ue(this.focus_node,{"aria-activedescendant":e.getAttribute("id")}),ue(e,{"aria-selected":"true"}),Me(e,"active"),t&&this.scrollToOption(e)))}scrollToOption(e,t){if(!e)return;const n=this.dropdown_content,i=n.clientHeight,s=n.scrollTop||0,o=e.offsetHeight,l=e.getBoundingClientRect().top-n.getBoundingClientRect().top+s;l+o>i+s?this.scroll(l-i+o,t):l<s&&this.scroll(l,t)}scroll(e,t){const n=this.dropdown_content;t&&(n.style.scrollBehavior=t),n.scrollTop=e,n.style.scrollBehavior=""}clearActiveOption(){this.activeOption&&(ot(this.activeOption,"active"),ue(this.activeOption,{"aria-selected":null})),this.activeOption=null,ue(this.focus_node,{"aria-activedescendant":null})}selectAll(){const e=this;if(e.settings.mode==="single")return;const t=e.controlChildren();t.length&&(e.inputState(),e.close(),e.activeItems=t,ve(t,n=>{e.setActiveItemClass(n)}))}inputState(){var e=this;e.control.contains(e.control_input)&&(ue(e.control_input,{placeholder:e.settings.placeholder}),e.activeItems.length>0||!e.isFocused&&e.settings.hidePlaceholder&&e.items.length>0?(e.setTextboxValue(),e.isInputHidden=!0):(e.settings.hidePlaceholder&&e.items.length>0&&ue(e.control_input,{placeholder:""}),e.isInputHidden=!1),e.wrapper.classList.toggle("input-hidden",e.isInputHidden))}inputValue(){return this.control_input.value.trim()}focus(){var e=this;e.isDisabled||e.isReadOnly||(e.ignoreFocus=!0,e.control_input.offsetWidth?e.control_input.focus():e.focus_node.focus(),setTimeout(()=>{e.ignoreFocus=!1,e.onFocus()},0))}blur(){this.focus_node.blur(),this.onBlur()}getScoreFunction(e){return this.sifter.getScoreFunction(e,this.getSearchOptions())}getSearchOptions(){var e=this.settings,t=e.sortField;return typeof e.sortField=="string"&&(t=[{field:e.sortField}]),{fields:e.searchField,conjunction:e.searchConjunction,sort:t,nesting:e.nesting}}search(e){var t,n,i=this,s=this.getSearchOptions();if(i.settings.score&&(n=i.settings.score.call(i,e),typeof n!="function"))throw new Error('Tom Select "score" setting must be a function that returns a function');return e!==i.lastQuery?(i.lastQuery=e,t=i.sifter.search(e,Object.assign(s,{score:n})),i.currentResults=t):t=Object.assign({},i.currentResults),i.settings.hideSelected&&(t.items=t.items.filter(o=>{let l=Be(o.id);return!(l&&i.items.indexOf(l)!==-1)})),t}refreshOptions(e=!0){var t,n,i,s,o,l,c,f,g,v;const S={},O=[];var k=this,L=k.inputValue();const R=L===k.lastQuery||L==""&&k.lastQuery==null;var F=k.search(L),M=null,z=k.settings.shouldOpen||!1,r=k.dropdown_content;R&&(M=k.activeOption,M&&(g=M.closest("[data-group]"))),s=F.items.length,typeof k.settings.maxOptions=="number"&&(s=Math.min(s,k.settings.maxOptions)),s>0&&(z=!0);const p=(h,T)=>{let y=S[h];if(y!==void 0){let I=O[y];if(I!==void 0)return[y,I.fragment]}let E=document.createDocumentFragment();return y=O.length,O.push({fragment:E,order:T,optgroup:h}),[y,E]};for(t=0;t<s;t++){let h=F.items[t];if(!h)continue;let T=h.id,y=k.options[T];if(y===void 0)continue;let E=fn(T),I=k.getOption(E,!0);for(k.settings.hideSelected||I.classList.toggle("selected",k.items.includes(E)),o=y[k.settings.optgroupField]||"",l=Array.isArray(o)?o:[o],n=0,i=l&&l.length;n<i;n++){o=l[n];let C=y.$order,D=k.optgroups[o];D===void 0?o="":C=D.$order;const[A,P]=p(o,C);n>0&&(I=I.cloneNode(!0),ue(I,{id:y.$id+"-clone-"+n,"aria-selected":null}),I.classList.add("ts-cloned"),ot(I,"active"),k.activeOption&&k.activeOption.dataset.value==T&&g&&g.dataset.group===o.toString()&&(M=I)),P.appendChild(I),o!=""&&(S[o]=A)}}k.settings.lockOptgroupOrder&&O.sort((h,T)=>h.order-T.order),c=document.createDocumentFragment(),ve(O,h=>{let T=h.fragment,y=h.optgroup;if(!T||!T.children.length)return;let E=k.optgroups[y];if(E!==void 0){let I=document.createDocumentFragment(),C=k.render("optgroup_header",E);vt(I,C),vt(I,T);let D=k.render("optgroup",{group:E,options:I});vt(c,D)}else vt(c,T)}),r.innerHTML="",vt(r,c),k.settings.highlight&&(xs(r),F.query.length&&F.tokens.length&&ve(F.tokens,h=>{As(r,h.regex)}));var u=h=>{let T=k.render(h,{input:L});return T&&(z=!0,r.insertBefore(T,r.firstChild)),T};if(k.loading?u("loading"):k.settings.shouldLoad.call(k,L)?F.items.length===0&&u("no_results"):u("not_loading"),f=k.canCreate(L),f&&(v=u("option_create")),k.hasOptions=F.items.length>0||f,z){if(F.items.length>0){if(!M&&k.settings.mode==="single"&&k.items[0]!=null&&(M=k.getOption(k.items[0])),!r.contains(M)){let h=0;v&&!k.settings.addPrecedence&&(h=1),M=k.selectable()[h]}}else v&&(M=v);e&&!k.isOpen&&(k.open(),k.scrollToOption(M,"auto")),k.setActiveOption(M)}else k.clearActiveOption(),e&&k.isOpen&&k.close(!1)}selectable(){return this.dropdown_content.querySelectorAll("[data-selectable]")}addOption(e,t=!1){const n=this;if(Array.isArray(e))return n.addOptions(e,t),!1;const i=Be(e[n.settings.valueField]);return i===null||n.options.hasOwnProperty(i)?!1:(e.$order=e.$order||++n.order,e.$id=n.inputId+"-opt-"+e.$order,n.options[i]=e,n.lastQuery=null,t&&(n.userOptions[i]=t,n.trigger("option_add",i,e)),i)}addOptions(e,t=!1){ve(e,n=>{this.addOption(n,t)})}registerOption(e){return this.addOption(e)}registerOptionGroup(e){var t=Be(e[this.settings.optgroupValueField]);return t===null?!1:(e.$order=e.$order||++this.order,this.optgroups[t]=e,t)}addOptionGroup(e,t){var n;t[this.settings.optgroupValueField]=e,(n=this.registerOptionGroup(t))&&this.trigger("optgroup_add",n,t)}removeOptionGroup(e){this.optgroups.hasOwnProperty(e)&&(delete this.optgroups[e],this.clearCache(),this.trigger("optgroup_remove",e))}clearOptionGroups(){this.optgroups={},this.clearCache(),this.trigger("optgroup_clear")}updateOption(e,t){const n=this;var i,s;const o=Be(e),l=Be(t[n.settings.valueField]);if(o===null)return;const c=n.options[o];if(c==null)return;if(typeof l!="string")throw new Error("Value must be set in option data");const f=n.getOption(o),g=n.getItem(o);if(t.$order=t.$order||c.$order,delete n.options[o],n.uncacheValue(l),n.options[l]=t,f){if(n.dropdown_content.contains(f)){const v=n._render("option",t);Qn(f,v),n.activeOption===f&&n.setActiveOption(v)}f.remove()}g&&(s=n.items.indexOf(o),s!==-1&&n.items.splice(s,1,l),i=n._render("item",t),g.classList.contains("active")&&Me(i,"active"),Qn(g,i)),n.lastQuery=null}removeOption(e,t){const n=this;e=fn(e),n.uncacheValue(e),delete n.userOptions[e],delete n.options[e],n.lastQuery=null,n.trigger("option_remove",e),n.removeItem(e,t)}clearOptions(e){const t=(e||this.clearFilter).bind(this);this.loadedSearches={},this.userOptions={},this.clearCache();const n={};ve(this.options,(i,s)=>{t(i,s)&&(n[s]=i)}),this.options=this.sifter.items=n,this.lastQuery=null,this.trigger("option_clear")}clearFilter(e,t){return this.items.indexOf(t)>=0}getOption(e,t=!1){const n=Be(e);if(n===null)return null;const i=this.options[n];if(i!=null){if(i.$div)return i.$div;if(t)return this._render("option",i)}return null}getAdjacent(e,t,n="option"){var i=this,s;if(!e)return null;n=="item"?s=i.controlChildren():s=i.dropdown_content.querySelectorAll("[data-selectable]");for(let o=0;o<s.length;o++)if(s[o]==e)return t>0?s[o+1]:s[o-1];return null}getItem(e){if(typeof e=="object")return e;var t=Be(e);return t!==null?this.control.querySelector(`[data-value="${La(t)}"]`):null}addItems(e,t){var n=this,i=Array.isArray(e)?e:[e];i=i.filter(o=>n.items.indexOf(o)===-1);const s=i[i.length-1];i.forEach(o=>{n.isPending=o!==s,n.addItem(o,t)})}addItem(e,t){var n=t?[]:["change","dropdown_close"];Ca(this,n,()=>{var i,s;const o=this,l=o.settings.mode,c=Be(e);if(!(c&&o.items.indexOf(c)!==-1&&(l==="single"&&o.close(),l==="single"||!o.settings.duplicates))&&!(c===null||!o.options.hasOwnProperty(c))&&(l==="single"&&o.clear(t),!(l==="multi"&&o.isFull()))){if(i=o._render("item",o.options[c]),o.control.contains(i)&&(i=i.cloneNode(!0)),s=o.isFull(),o.items.splice(o.caretPos,0,c),o.insertAtCaret(i),o.isSetup){if(!o.isPending&&o.settings.hideSelected){let f=o.getOption(c),g=o.getAdjacent(f,1);g&&o.setActiveOption(g)}!o.isPending&&!o.settings.closeAfterSelect&&o.refreshOptions(o.isFocused&&l!=="single"),o.settings.closeAfterSelect!=!1&&o.isFull()?o.close():o.isPending||o.positionDropdown(),o.trigger("item_add",c,i),o.isPending||o.updateOriginalInput({silent:t})}(!o.isPending||!s&&o.isFull())&&(o.inputState(),o.refreshState())}})}removeItem(e=null,t){const n=this;if(e=n.getItem(e),!e)return;var i,s;const o=e.dataset.value;i=$a(e),e.remove(),e.classList.contains("active")&&(s=n.activeItems.indexOf(e),n.activeItems.splice(s,1),ot(e,"active")),n.items.splice(i,1),n.lastQuery=null,!n.settings.persist&&n.userOptions.hasOwnProperty(o)&&n.removeOption(o,t),i<n.caretPos&&n.setCaret(n.caretPos-1),n.updateOriginalInput({silent:t}),n.refreshState(),n.positionDropdown(),n.trigger("item_remove",o,e)}createItem(e=null,t=()=>{}){arguments.length===3&&(t=arguments[2]),typeof t!="function"&&(t=()=>{});var n=this,i=n.caretPos,s;if(e=e||n.inputValue(),!n.canCreate(e))return t(),!1;n.lock();var o=!1,l=c=>{if(n.unlock(),!c||typeof c!="object")return t();var f=Be(c[n.settings.valueField]);if(typeof f!="string")return t();n.setTextboxValue(),n.addOption(c,!0),n.setCaret(i),n.addItem(f),t(c),o=!0};return typeof n.settings.create=="function"?s=n.settings.create.call(this,e,l):s={[n.settings.labelField]:e,[n.settings.valueField]:e},o||l(s),!0}refreshItems(){var e=this;e.lastQuery=null,e.isSetup&&e.addItems(e.items),e.updateOriginalInput(),e.refreshState()}refreshState(){const e=this;e.refreshValidityState();const t=e.isFull(),n=e.isLocked;e.wrapper.classList.toggle("rtl",e.rtl);const i=e.wrapper.classList;i.toggle("focus",e.isFocused),i.toggle("disabled",e.isDisabled),i.toggle("readonly",e.isReadOnly),i.toggle("required",e.isRequired),i.toggle("invalid",!e.isValid),i.toggle("locked",n),i.toggle("full",t),i.toggle("input-active",e.isFocused&&!e.isInputHidden),i.toggle("dropdown-active",e.isOpen),i.toggle("has-options",$s(e.options)),i.toggle("has-items",e.items.length>0)}refreshValidityState(){var e=this;e.input.validity&&(e.isValid=e.input.validity.valid,e.isInvalid=!e.isValid)}isFull(){return this.settings.maxItems!==null&&this.items.length>=this.settings.maxItems}updateOriginalInput(e={}){const t=this;var n,i;const s=t.input.querySelector('option[value=""]');if(t.is_select_tag){let c=function(f,g,v){return f||(f=Ye('<option value="'+Xn(g)+'">'+Xn(v)+"</option>")),f!=s&&t.input.append(f),o.push(f),(f!=s||l>0)&&(f.selected=!0),f};const o=[],l=t.input.querySelectorAll("option:checked").length;t.input.querySelectorAll("option:checked").forEach(f=>{f.selected=!1}),t.items.length==0&&t.settings.mode=="single"?c(s,"",""):t.items.forEach(f=>{if(n=t.options[f],i=n[t.settings.labelField]||"",o.includes(n.$option)){const g=t.input.querySelector(`option[value="${La(f)}"]:not(:checked)`);c(g,f,i)}else n.$option=c(n.$option,f,i)})}else t.input.value=t.getValue();t.isSetup&&(e.silent||t.trigger("change",t.getValue()))}open(){var e=this;e.isLocked||e.isOpen||e.settings.mode==="multi"&&e.isFull()||(e.isOpen=!0,ue(e.focus_node,{"aria-expanded":"true"}),e.refreshState(),sn(e.dropdown,{visibility:"hidden",display:"block"}),e.positionDropdown(),sn(e.dropdown,{visibility:"visible",display:"block"}),e.focus(),e.trigger("dropdown_open",e.dropdown))}close(e=!0){var t=this,n=t.isOpen;e&&(t.setTextboxValue(),t.settings.mode==="single"&&t.items.length&&t.inputState()),t.isOpen=!1,ue(t.focus_node,{"aria-expanded":"false"}),sn(t.dropdown,{display:"none"}),t.settings.hideSelected&&t.clearActiveOption(),t.refreshState(),n&&t.trigger("dropdown_close",t.dropdown)}positionDropdown(){if(this.settings.dropdownParent==="body"){var e=this.control,t=e.getBoundingClientRect(),n=e.offsetHeight+t.top+window.scrollY,i=t.left+window.scrollX;sn(this.dropdown,{width:t.width+"px",top:n+"px",left:i+"px"})}}clear(e){var t=this;if(t.items.length){var n=t.controlChildren();ve(n,i=>{t.removeItem(i,!0)}),t.inputState(),e||t.updateOriginalInput(),t.trigger("clear")}}insertAtCaret(e){const t=this,n=t.caretPos,i=t.control;i.insertBefore(e,i.children[n]||null),t.setCaret(n+1)}deleteSelection(e){var t,n,i,s,o=this;t=e&&e.keyCode===Aa?-1:1,n=Ls(o.control_input);const l=[];if(o.activeItems.length)s=Ma(o.activeItems,t),i=$a(s),t>0&&i++,ve(o.activeItems,c=>l.push(c));else if((o.isFocused||o.settings.mode==="single")&&o.items.length){const c=o.controlChildren();let f;t<0&&n.start===0&&n.length===0?f=c[o.caretPos-1]:t>0&&n.start===o.inputValue().length&&(f=c[o.caretPos]),f!==void 0&&l.push(f)}if(!o.shouldDelete(l,e))return!1;for(pe(e,!0),typeof i<"u"&&o.setCaret(i);l.length;)o.removeItem(l.pop());return o.inputState(),o.positionDropdown(),o.refreshOptions(!1),!0}shouldDelete(e,t){const n=e.map(i=>i.dataset.value);return!(!n.length||typeof this.settings.onDelete=="function"&&this.settings.onDelete(n,t)===!1)}advanceSelection(e,t){var n,i,s=this;s.rtl&&(e*=-1),!s.inputValue().length&&(mt(on,t)||mt("shiftKey",t)?(n=s.getLastActive(e),n?n.classList.contains("active")?i=s.getAdjacent(n,e,"item"):i=n:e>0?i=s.control_input.nextElementSibling:i=s.control_input.previousElementSibling,i&&(i.classList.contains("active")&&s.removeActiveItem(n),s.setActiveItemClass(i))):s.moveCaret(e))}moveCaret(e){}getLastActive(e){let t=this.control.querySelector(".last-active");if(t)return t;var n=this.control.querySelectorAll(".active");if(n)return Ma(n,e)}setCaret(e){this.caretPos=this.items.length}controlChildren(){return Array.from(this.control.querySelectorAll("[data-ts-item]"))}lock(){this.setLocked(!0)}unlock(){this.setLocked(!1)}setLocked(e=this.isReadOnly||this.isDisabled){this.isLocked=e,this.refreshState()}disable(){this.setDisabled(!0),this.close()}enable(){this.setDisabled(!1)}setDisabled(e){this.focus_node.tabIndex=e?-1:this.tabIndex,this.isDisabled=e,this.input.disabled=e,this.control_input.disabled=e,this.setLocked()}setReadOnly(e){this.isReadOnly=e,this.input.readOnly=e,this.control_input.readOnly=e,this.setLocked()}destroy(){var e=this,t=e.revertSettings;e.trigger("destroy"),e.off(),e.wrapper.remove(),e.dropdown.remove(),e.input.innerHTML=t.innerHTML,e.input.tabIndex=t.tabIndex,ot(e.input,"tomselected","ts-hidden-accessible"),e._destroy(),delete e.input.tomselect}render(e,t){var n,i;const s=this;if(typeof this.settings.render[e]!="function"||(i=s.settings.render[e].call(this,t,Xn),!i))return null;if(i=Ye(i),e==="option"||e==="option_create"?t[s.settings.disabledField]?ue(i,{"aria-disabled":"true"}):ue(i,{"data-selectable":""}):e==="optgroup"&&(n=t.group[s.settings.optgroupValueField],ue(i,{"data-group":n}),t.group[s.settings.disabledField]&&ue(i,{"data-disabled":""})),e==="option"||e==="item"){const o=fn(t[s.settings.valueField]);ue(i,{"data-value":o}),e==="item"?(Me(i,s.settings.itemClass),ue(i,{"data-ts-item":""})):(Me(i,s.settings.optionClass),ue(i,{role:"option",id:t.$id}),t.$div=i,s.options[o]=t)}return i}_render(e,t){const n=this.render(e,t);if(n==null)throw"HTMLElement expected";return n}clearCache(){ve(this.options,e=>{e.$div&&(e.$div.remove(),delete e.$div)})}uncacheValue(e){const t=this.getOption(e);t&&t.remove()}canCreate(e){return this.settings.create&&e.length>0&&this.settings.createFilter.call(this,e)}hook(e,t,n){var i=this,s=i[t];i[t]=function(){var o,l;return e==="after"&&(o=s.apply(i,arguments)),l=n.apply(i,arguments),e==="instead"?l:(e==="before"&&(o=s.apply(i,arguments)),o)}}}const js=(a,e,t,n)=>{a.addEventListener(e,t,n)};function Gs(){js(this.input,"change",()=>{this.sync()})}const Ws=a=>typeof a>"u"||a===null?null:Ys(a),Ys=a=>typeof a=="boolean"?a?"1":"0":a+"",Va=(a,e=!1)=>{a&&(a.preventDefault(),e&&a.stopPropagation())},qs=a=>{if(a.jquery)return a[0];if(a instanceof HTMLElement)return a;if(Ks(a)){var e=document.createElement("template");return e.innerHTML=a.trim(),e.content.firstChild}return document.querySelector(a)},Ks=a=>typeof a=="string"&&a.indexOf("<")>-1;function Qs(a){var e=this,t=e.onOptionSelect;e.settings.hideSelected=!1;const n=Object.assign({className:"tomselect-checkbox",checkedClassNames:void 0,uncheckedClassNames:void 0},a);var i=function(l,c){c?(l.checked=!0,n.uncheckedClassNames&&l.classList.remove(...n.uncheckedClassNames),n.checkedClassNames&&l.classList.add(...n.checkedClassNames)):(l.checked=!1,n.checkedClassNames&&l.classList.remove(...n.checkedClassNames),n.uncheckedClassNames&&l.classList.add(...n.uncheckedClassNames))},s=function(l){setTimeout(()=>{var c=l.querySelector("input."+n.className);c instanceof HTMLInputElement&&i(c,l.classList.contains("selected"))},1)};e.hook("after","setupTemplates",()=>{var o=e.settings.render.option;e.settings.render.option=(l,c)=>{var f=qs(o.call(e,l,c)),g=document.createElement("input");n.className&&g.classList.add(n.className),g.addEventListener("click",function(S){Va(S)}),g.type="checkbox";const v=Ws(l[e.settings.valueField]);return i(g,!!(v&&e.items.indexOf(v)>-1)),f.prepend(g),f}}),e.on("item_remove",o=>{var l=e.getOption(o);l&&(l.classList.remove("selected"),s(l))}),e.on("item_add",o=>{var l=e.getOption(o);l&&s(l)}),e.hook("instead","onOptionSelect",(o,l)=>{if(l.classList.contains("selected")){l.classList.remove("selected"),e.removeItem(l.dataset.value),e.refreshOptions(),Va(o,!0);return}t.call(e,o,l),s(l)})}const Zs=a=>{if(a.jquery)return a[0];if(a instanceof HTMLElement)return a;if(Js(a)){var e=document.createElement("template");return e.innerHTML=a.trim(),e.content.firstChild}return document.querySelector(a)},Js=a=>typeof a=="string"&&a.indexOf("<")>-1;function eo(a){const e=this,t=Object.assign({className:"clear-button",title:"Clear All",html:n=>`<div class="${n.className}" title="${n.title}">&#10799;</div>`},a);e.on("initialize",()=>{var n=Zs(t.html(t));n.addEventListener("click",i=>{e.isLocked||(e.clear(),e.settings.mode==="single"&&e.settings.allowEmptyOption&&e.addItem(""),i.preventDefault(),i.stopPropagation())}),e.control.appendChild(n)})}const to=(a,e=!1)=>{a&&(a.preventDefault(),e&&a.stopPropagation())},_t=(a,e,t,n)=>{a.addEventListener(e,t,n)},no=(a,e)=>{if(Array.isArray(a))a.forEach(e);else for(var t in a)a.hasOwnProperty(t)&&e(a[t],t)},ao=a=>{if(a.jquery)return a[0];if(a instanceof HTMLElement)return a;if(io(a)){var e=document.createElement("template");return e.innerHTML=a.trim(),e.content.firstChild}return document.querySelector(a)},io=a=>typeof a=="string"&&a.indexOf("<")>-1,ro=(a,e)=>{no(e,(t,n)=>{t==null?a.removeAttribute(n):a.setAttribute(n,""+t)})},so=(a,e)=>{var t;(t=a.parentNode)==null||t.insertBefore(e,a.nextSibling)},oo=(a,e)=>{var t;(t=a.parentNode)==null||t.insertBefore(e,a)},lo=(a,e)=>{do{var t;if(e=(t=e)==null?void 0:t.previousElementSibling,a==e)return!0}while(e&&e.previousElementSibling);return!1};function co(){var a=this;if(a.settings.mode!=="multi")return;var e=a.lock,t=a.unlock;let n=!0,i;a.hook("after","setupTemplates",()=>{var s=a.settings.render.item;a.settings.render.item=(o,l)=>{const c=ao(s.call(a,o,l));ro(c,{draggable:"true"});const f=L=>{n||to(L),L.stopPropagation()},g=L=>{i=c,setTimeout(()=>{c.classList.add("ts-dragging")},0)},v=L=>{L.preventDefault(),c.classList.add("ts-drag-over"),O(c,i)},S=()=>{c.classList.remove("ts-drag-over")},O=(L,R)=>{R!==void 0&&(lo(R,c)?so(L,R):oo(L,R))},k=()=>{var L;document.querySelectorAll(".ts-drag-over").forEach(F=>F.classList.remove("ts-drag-over")),(L=i)==null||L.classList.remove("ts-dragging"),i=void 0;var R=[];a.control.querySelectorAll("[data-value]").forEach(F=>{if(F.dataset.value){let M=F.dataset.value;M&&R.push(M)}}),a.setValue(R)};return _t(c,"mousedown",f),_t(c,"dragstart",g),_t(c,"dragenter",v),_t(c,"dragover",v),_t(c,"dragleave",S),_t(c,"dragend",k),c}}),a.hook("instead","lock",()=>(n=!1,e.call(a))),a.hook("instead","unlock",()=>(n=!0,t.call(a)))}const uo=(a,e=!1)=>{a&&(a.preventDefault(),e&&a.stopPropagation())},fo=a=>{if(a.jquery)return a[0];if(a instanceof HTMLElement)return a;if(po(a)){var e=document.createElement("template");return e.innerHTML=a.trim(),e.content.firstChild}return document.querySelector(a)},po=a=>typeof a=="string"&&a.indexOf("<")>-1;function ho(a){const e=this,t=Object.assign({title:"Untitled",headerClass:"dropdown-header",titleRowClass:"dropdown-header-title",labelClass:"dropdown-header-label",closeClass:"dropdown-header-close",html:n=>'<div class="'+n.headerClass+'"><div class="'+n.titleRowClass+'"><span class="'+n.labelClass+'">'+n.title+'</span><a class="'+n.closeClass+'">&times;</a></div></div>'},a);e.on("initialize",()=>{var n=fo(t.html(t)),i=n.querySelector("."+t.closeClass);i&&i.addEventListener("click",s=>{uo(s,!0),e.close()}),e.dropdown.insertBefore(n,e.dropdown.firstChild)})}const go=(a,e)=>{if(Array.isArray(a))a.forEach(e);else for(var t in a)a.hasOwnProperty(t)&&e(a[t],t)},mo=(a,...e)=>{var t=vo(e);a=yo(a),a.map(n=>{t.map(i=>{n.classList.remove(i)})})},vo=a=>{var e=[];return go(a,t=>{typeof t=="string"&&(t=t.trim().split(/[\t\n\f\r\s]/)),Array.isArray(t)&&(e=e.concat(t))}),e.filter(Boolean)},yo=a=>(Array.isArray(a)||(a=[a]),a),Eo=(a,e)=>{if(!a)return-1;e=e||a.nodeName;for(var t=0;a=a.previousElementSibling;)a.matches(e)&&t++;return t};function Io(){var a=this;a.hook("instead","setCaret",e=>{a.settings.mode==="single"||!a.control.contains(a.control_input)?e=a.items.length:(e=Math.max(0,Math.min(a.items.length,e)),e!=a.caretPos&&!a.isPending&&a.controlChildren().forEach((t,n)=>{n<e?a.control_input.insertAdjacentElement("beforebegin",t):a.control.appendChild(t)})),a.caretPos=e}),a.hook("instead","moveCaret",e=>{if(!a.isFocused)return;const t=a.getLastActive(e);if(t){const n=Eo(t);a.setCaret(e>0?n+1:n),a.setActiveItem(),mo(t,"last-active")}else a.setCaret(a.caretPos+e)})}const wo=27,bo=9,To=(a,e=!1)=>{a&&(a.preventDefault(),e&&a.stopPropagation())},So=(a,e,t,n)=>{a.addEventListener(e,t,n)},No=(a,e)=>{if(Array.isArray(a))a.forEach(e);else for(var t in a)a.hasOwnProperty(t)&&e(a[t],t)},Ha=a=>{if(a.jquery)return a[0];if(a instanceof HTMLElement)return a;if(Oo(a)){var e=document.createElement("template");return e.innerHTML=a.trim(),e.content.firstChild}return document.querySelector(a)},Oo=a=>typeof a=="string"&&a.indexOf("<")>-1,_o=(a,...e)=>{var t=ko(e);a=Do(a),a.map(n=>{t.map(i=>{n.classList.add(i)})})},ko=a=>{var e=[];return No(a,t=>{typeof t=="string"&&(t=t.trim().split(/[\t\n\f\r\s]/)),Array.isArray(t)&&(e=e.concat(t))}),e.filter(Boolean)},Do=a=>(Array.isArray(a)||(a=[a]),a);function Co(){const a=this;a.settings.shouldOpen=!0,a.hook("before","setup",()=>{a.focus_node=a.control,_o(a.control_input,"dropdown-input");const e=Ha('<div class="dropdown-input-wrap">');e.append(a.control_input),a.dropdown.insertBefore(e,a.dropdown.firstChild);const t=Ha('<input class="items-placeholder" tabindex="-1" />');t.placeholder=a.settings.placeholder||"",a.control.append(t)}),a.on("initialize",()=>{a.control_input.addEventListener("keydown",t=>{switch(t.keyCode){case wo:a.isOpen&&(To(t,!0),a.close()),a.clearActiveItems();return;case bo:a.focus_node.tabIndex=-1;break}return a.onKeyDown.call(a,t)}),a.on("blur",()=>{a.focus_node.tabIndex=a.isDisabled?-1:a.tabIndex}),a.on("dropdown_open",()=>{a.control_input.focus()});const e=a.onBlur;a.hook("instead","onBlur",t=>{if(!(t&&t.relatedTarget==a.control_input))return e.call(a)}),So(a.control_input,"blur",()=>a.onBlur()),a.hook("before","close",()=>{a.isOpen&&a.focus_node.focus({preventScroll:!0})})})}const dn=(a,e,t,n)=>{a.addEventListener(e,t,n)};function Lo(){var a=this;a.on("initialize",()=>{var e=document.createElement("span"),t=a.control_input;e.style.cssText="position:absolute; top:-99999px; left:-99999px; width:auto; padding:0; white-space:pre; ",a.wrapper.appendChild(e);var n=["letterSpacing","fontSize","fontFamily","fontWeight","textTransform"];for(const s of n)e.style[s]=t.style[s];var i=()=>{e.textContent=t.value,t.style.width=e.clientWidth+"px"};i(),a.on("update item_add item_remove",i),dn(t,"input",i),dn(t,"keyup",i),dn(t,"blur",i),dn(t,"update",i)})}function Mo(){var a=this,e=a.deleteSelection;this.hook("instead","deleteSelection",t=>a.activeItems.length?e.call(a,t):!1)}function $o(){this.hook("instead","setActiveItem",()=>{}),this.hook("instead","selectAll",()=>{})}const Fa=37,Ao=39,xo=(a,e,t)=>{for(;a&&a.matches;){if(a.matches(e))return a;a=a.parentNode}},Po=(a,e)=>{if(!a)return-1;e=e||a.nodeName;for(var t=0;a=a.previousElementSibling;)a.matches(e)&&t++;return t};function Ro(){var a=this,e=a.onKeyDown;a.hook("instead","onKeyDown",t=>{var n,i,s,o;if(!a.isOpen||!(t.keyCode===Fa||t.keyCode===Ao))return e.call(a,t);a.ignoreHover=!0,o=xo(a.activeOption,"[data-group]"),n=Po(a.activeOption,"[data-selectable]"),o&&(t.keyCode===Fa?o=o.previousSibling:o=o.nextSibling,o&&(s=o.querySelectorAll("[data-selectable]"),i=s[Math.min(s.length-1,n)],i&&a.setActiveOption(i)))})}const Xo=a=>(a+"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;"),Ba=(a,e=!1)=>{a&&(a.preventDefault(),e&&a.stopPropagation())},Ua=(a,e,t,n)=>{a.addEventListener(e,t,n)},za=a=>{if(a.jquery)return a[0];if(a instanceof HTMLElement)return a;if(Vo(a)){var e=document.createElement("template");return e.innerHTML=a.trim(),e.content.firstChild}return document.querySelector(a)},Vo=a=>typeof a=="string"&&a.indexOf("<")>-1;function Ho(a){const e=Object.assign({label:"&times;",title:"Remove",className:"remove",append:!0},a);var t=this;if(e.append){var n='<a href="javascript:void(0)" class="'+e.className+'" tabindex="-1" title="'+Xo(e.title)+'">'+e.label+"</a>";t.hook("after","setupTemplates",()=>{var i=t.settings.render.item;t.settings.render.item=(s,o)=>{var l=za(i.call(t,s,o)),c=za(n);return l.appendChild(c),Ua(c,"mousedown",f=>{Ba(f,!0)}),Ua(c,"click",f=>{t.isLocked||(Ba(f,!0),!t.isLocked&&t.shouldDelete([l],f)&&(t.removeItem(l),t.refreshOptions(!1),t.inputState()))}),l}})}}function Fo(a){const e=this,t=Object.assign({text:n=>n[e.settings.labelField]},a);e.on("item_remove",function(n){if(e.isFocused&&e.control_input.value.trim()===""){var i=e.options[n];i&&e.setTextboxValue(t.text.call(e,i))}})}const Bo=(a,e)=>{if(Array.isArray(a))a.forEach(e);else for(var t in a)a.hasOwnProperty(t)&&e(a[t],t)},Uo=(a,...e)=>{var t=zo(e);a=jo(a),a.map(n=>{t.map(i=>{n.classList.add(i)})})},zo=a=>{var e=[];return Bo(a,t=>{typeof t=="string"&&(t=t.trim().split(/[\t\n\f\r\s]/)),Array.isArray(t)&&(e=e.concat(t))}),e.filter(Boolean)},jo=a=>(Array.isArray(a)||(a=[a]),a);function Go(){const a=this,e=a.canLoad,t=a.clearActiveOption,n=a.loadCallback;var i={},s,o=!1,l,c=[];if(a.settings.shouldLoadMore||(a.settings.shouldLoadMore=()=>{if(s.clientHeight/(s.scrollHeight-s.scrollTop)>.9)return!0;if(a.activeOption){var S=a.selectable(),O=Array.from(S).indexOf(a.activeOption);if(O>=S.length-2)return!0}return!1}),!a.settings.firstUrl)throw"virtual_scroll plugin requires a firstUrl() method";a.settings.sortField=[{field:"$order"},{field:"$score"}];const f=v=>typeof a.settings.maxOptions=="number"&&s.children.length>=a.settings.maxOptions?!1:!!(v in i&&i[v]),g=(v,S)=>a.items.indexOf(S)>=0||c.indexOf(S)>=0;a.setNextUrl=(v,S)=>{i[v]=S},a.getUrl=v=>{if(v in i){const S=i[v];return i[v]=!1,S}return a.clearPagination(),a.settings.firstUrl.call(a,v)},a.clearPagination=()=>{i={}},a.hook("instead","clearActiveOption",()=>{if(!o)return t.call(a)}),a.hook("instead","canLoad",v=>v in i?f(v):e.call(a,v)),a.hook("instead","loadCallback",(v,S)=>{if(!o)a.clearOptions(g);else if(l){const O=v[0];O!==void 0&&(l.dataset.value=O[a.settings.valueField])}n.call(a,v,S),o=!1}),a.hook("after","refreshOptions",()=>{const v=a.lastValue;var S;f(v)?(S=a.render("loading_more",{query:v}),S&&(S.setAttribute("data-selectable",""),l=S)):v in i&&!s.querySelector(".no-results")&&(S=a.render("no_more_results",{query:v})),S&&(Uo(S,a.settings.optionClass),s.append(S))}),a.on("initialize",()=>{c=Object.keys(a.options),s=a.dropdown_content,a.settings.render=Object.assign({},{loading_more:()=>'<div class="loading-more-results">Loading more results ... </div>',no_more_results:()=>'<div class="no-more-results">No more results</div>'},a.settings.render),s.addEventListener("scroll",()=>{a.settings.shouldLoadMore.call(a)&&f(a.lastValue)&&(o||(o=!0,a.load.call(a,a.lastValue)))})})}Te.define("change_listener",Gs);Te.define("checkbox_options",Qs);Te.define("clear_button",eo);Te.define("drag_drop",co);Te.define("dropdown_header",ho);Te.define("caret_position",Io);Te.define("dropdown_input",Co);Te.define("input_autogrow",Lo);Te.define("no_backspace_delete",Mo);Te.define("no_active_items",$o);Te.define("optgroup_columns",Ro);Te.define("remove_button",Ho);Te.define("restore_on_backspace",Fo);Te.define("virtual_scroll",Go);class Wo{spectresToCreate=[];spectresToDelete=[];spectresToUpdate=[];constructor(){}async Initialize(){const e=m.sceneItems.filter(t=>t.metadata[`${d.SPECTREID}/isSpectre`]===!0);for(const t of e)await this.SetupGhostSelect(t)}async Run(){const t=m.sceneItems.filter(n=>n.metadata[`${d.SPECTREID}/isSpectre`]===!0).filter(n=>n.metadata[`${d.SPECTREID}/spectreViewers`].includes(m.playerId));if(t.length>0){for(const i of t){const s=m.sceneLocal.find(o=>o.metadata[`${d.SPECTREID}/isLocalSpectre`]===i.id);if(!s)this.CreateSpectreToQueue(i);else{const o=i.position.x===s.position.x&&i.position.y===s.position.y,l=i.scale.x===s.scale.x&&i.scale.y===s.scale.y,c=i.rotation===s.rotation,f=i.layer===s.layer;(!c||!l||!f||!o)&&this.UpdateSpectreToQueue(i,s)}}const n=m.sceneLocal.filter(i=>zr(i));for(const i of n)t.find(o=>o.id===i.metadata[`${d.SPECTREID}/isLocalSpectre`])||this.spectresToDelete.push(i.id);this.spectresToCreate.length>0&&await w.scene.local.addItems(this.spectresToCreate),this.spectresToDelete.length>0&&await w.scene.local.deleteItems(this.spectresToDelete),this.spectresToUpdate.length>0&&await w.scene.items.updateItems(n.filter(i=>!this.spectresToDelete.includes(i.id)),i=>{for(let s of i){const o=this.spectresToUpdate.find(l=>l.id===s.id);o&&(s.layer=o.layer,s.scale=o.scale,s.rotation=o.rotation,s.position=o.position)}}),this.spectresToCreate=[],this.spectresToUpdate=[],this.spectresToDelete=[]}else{const n=m.sceneLocal.filter(i=>i.metadata[`${d.SPECTREID}/isLocalSpectre`]!==void 0);n.length>0&&await w.scene.local.deleteItems(n.map(i=>i.id))}}CreateSpectreToQueue(e){const t=hn({height:e.image.height,width:e.image.width,url:e.image.url,mime:e.image.mime},{dpi:e.grid.dpi,offset:e.grid.offset}).id(e.id).position(e.position).scale(e.scale).text(e.text).rotation(e.rotation).attachedTo(e.id).layer(e.layer).metadata({[`${d.SPECTREID}/isLocalSpectre`]:e.id}).disableHit(!1).build();m.playerRole,this.spectresToCreate.push(t)}UpdateSpectreToQueue(e,t){const n={id:t.id,position:e.position,rotation:e.rotation,scale:e.scale,layer:e.layer};this.spectresToUpdate.push(n)}async HandleLocalMovement(e){const t=e.filter(n=>n.metadata[`${d.SPECTREID}/isLocalSpectre`]!==void 0);if(t.length>0){const n=[];for(const i of t){const s=m.sceneLocal.find(f=>f.id===i.id);if(!s)continue;const o=i.position.x===s.position.x&&i.position.y===s.position.y,l=i.scale.x===s.scale.x&&i.scale.y===s.scale.y,c=i.rotation===s.rotation;if(!o||!l||!c){const f=m.sceneItems.find(g=>g.id===s.metadata[`${d.SPECTREID}/isLocalSpectre`]);if(f){const g={id:f.id,position:s.position,scale:s.scale,rotation:s.rotation};n.push(g)}}}n.length>0&&await w.scene.items.updateItems(n.map(i=>i.id),i=>{for(let s of i){const o=n.find(l=>l.id===s.id);o&&(s.position=o.position,s.scale=o.scale,s.rotation=o.rotation)}})}}async SetupGhostSelect(e){const t=e.text?.plainText||e.name,n=document.getElementById("ghostList"),i=document.createElement("tr");i.id=`tr-${e.id}`,i.className="ghost-table-entry",i.innerHTML=`<td class="token-name">${t}</td>
            <td><select id="select-${e.id}" class="tSelects" multiple autocomplete="off" /></td>
            <td><input type="button" class="mysteryButton" id="deleteGhost-${e.id}" value="Delete"/></td>`,n.appendChild(i);const s=document.getElementById(`select-${e.id}`),o=Object.keys(m.sceneMetadata).filter(S=>S.startsWith(`${d.EXTENSIONID}/USER-`));if(o&&o.length>0){const S=o.map(O=>{const k=m.sceneMetadata[O];return k.id=O.replace(`${d.EXTENSIONID}/USER-`,""),k});for(const O of S){if(O.id===m.playerId)continue;const k=document.createElement("option");k.value=O.id,k.text=O.name,s.appendChild(k)}}let l=e.metadata[`${d.SPECTREID}/spectreViewers`];l||(l=[m.playerId]);let c=l.filter(S=>S!==m.playerId);const f={plugins:{remove_button:{title:"Remove this item"}},allowEmptyOption:!0,placeholder:"Choose..",maxItems:null,items:c,create:!1,onDelete:async function(S,O){const k=O.currentTarget.parentElement.parentElement.parentElement.parentElement.parentElement.id.slice(3);await w.scene.items.updateItems([k],L=>{const R=L[0].metadata[`${d.SPECTREID}/spectreViewers`],F=R.findIndex(M=>M===S);R.splice(F,1),L[0].metadata[`${d.SPECTREID}/spectreViewers`]=R})},onItemAdd:async function(S,O){const k=O.parentElement.parentElement.parentElement.parentElement.id.slice(3);await w.scene.items.updateItems([k],L=>{const R=L[0].metadata[`${d.SPECTREID}/spectreViewers`];R.push(S),L[0].metadata[`${d.SPECTREID}/spectreViewers`]=R})}};new Te(`#select-${e.id}`,f);const g=document.getElementById(`deleteGhost-${e.id}`);g.onclick=async()=>{const S=m.sceneLocal.findIndex(O=>O.id===e.id);m.sceneLocal.splice(S,1),i.remove(),await w.scene.items.deleteItems([e.id])};const v=document.getElementsByClassName("ts-control");for(let S of v){const O=S;O.style.backgroundColor=m.theme.mode==="DARK"?"rgb(49, 49, 65)":"rgb(210, 210, 223)",O.style.borderRadius="6px"}}UpdateSpectreTargets(){const e=document.querySelectorAll(".tSelects");for(const t of e)if(t&&t.tomselect){const n=t.tomselect,i=[];for(const s of m.party)i.push({value:s.id,text:s.name});n.addOption(i),n.settings.placeholder="Choose..",n.inputState()}}RemoveGhostSelect(e){document.getElementById(`tr-${e}`)?.remove()}CheckForRemovedTokens(){const e=document.getElementsByClassName("ghost-table-entry"),t=Array.from(e).map(n=>n.id.slice(3));for(const n of t)m.sceneItems.find(s=>s.id===n)||this.RemoveGhostSelect(n)}}const ct=new Wo;class ja{static CreateSkPath(e,t=0,n=!0){if(e.length===0)return[[0]];const i=[];if(i.push([me.MOVE,e[0].x,e[0].y]),t!==0&&e.length>2){const s=this.getTensionPoints(e,t,n),o=s.length;!n&&o>1&&i.push([me.QUAD,s[0].x,s[0].y,s[1].x,s[1].y]);for(let l=n?0:2;l<o-1;l+=3){const c=s[l],f=s[l+1],g=s[l+2];this.bezierCurveTo(i,c.x,c.y,f.x,f.y,g.x,g.y)}!n&&o>0&&i.push([me.QUAD,s[o-1].x,s[o-1].y,e[e.length-1].x,e[e.length-1].y])}else for(let s=1;s<e.length;s++)i.push([me.LINE,e[s].x,e[s].y]);return n&&i.push([me.CLOSE]),i}static allAreFinite(e){for(var t=0;t<e.length;t++)if(e[t]!==void 0&&!Number.isFinite(e[t]))return!1;return!0}static bezierCurveTo(e,t,n,i,s,o,l){this.allAreFinite([t,n,i,s,o,l])&&(e.length===0&&e.push([me.MOVE,t,n]),e.push([me.CUBIC,t,n,i,s,o,l]))}static getTensionPoints(e,t,n){return n?this.getTensionPointsClosed(e,t):this.expandPoints(e,t)}static getTensionPointsClosed(e,t){const n=e.length,i=this.getControlPoints(e[n-1],e[0],e[1],t),s=this.getControlPoints(e[n-2],e[n-1],e[0],t),o=this.expandPoints(e,t);return[i[1]].concat(o).concat([s[0],e[n-1],s[1],i[0],e[0]])}static expandPoints(e,t){const n=[];for(let i=1;i<e.length-1;i++){const[s,o]=this.getControlPoints(e[i-1],e[i],e[i+1],t);isNaN(s.x)||n.push(s,e[i],o)}return n}static getControlPoints(e,t,n,i){const s=dt.distance(e,t),o=dt.distance(t,n),l=s+o;if(l<=0)return[{...e},{...e}];const c=i*s/l,f=i*o/l,g=dt.subtract(n,e),v=dt.subtract(t,dt.multiply(g,c)),S=dt.add(t,dt.multiply(g,f));return[v,S]}}async function Yo(){await w.contextMenu.create({id:`${d.EXTENSIONID}/convert-curve`,icons:[{icon:"/opendoor.svg",label:"Convert to Obstruction",filter:{every:[{key:["metadata",`${d.EXTENSIONID}/elevation`],value:void 0},{key:["metadata",`${d.EXTENSIONID}/isVisionLine`],value:void 0},{key:["metadata",`${d.EXTENSIONID}/isFogEffect`],value:void 0}],some:[{key:"layer",value:"DRAWING",coordinator:"||"},{key:"layer",value:"FOG"}],roles:["GM"]}}],async onClick(a){const e=[],t=[];for(const n of a.items)if(n.type==="CURVE"){const i=n;if(i.points.length>2){const s=i.style.tension??0,o=i.style.closed===!0||i.style.fillOpacity!==0;o&&i.points.push(i.points[0]);const l=ja.CreateSkPath(i.points,s,o),c=Ln(l,{x:0,y:0},{curveSegments:20}),f=Ne().tension(0).points(c).strokeColor(m.sceneMetadata[`${d.EXTENSIONID}/toolColor`]??d.DEFAULTLINECOLOR).strokeDash(m.sceneMetadata[`${d.EXTENSIONID}/toolStyle`]??d.DEFAULTLINESTROKE).strokeWidth(be()).tension(s).fillOpacity(0).fillColor("#000000").layer(d.LINELAYER).name("Vision Line (Line)").closed(o).locked(!0).visible(!1).metadata({[`${d.EXTENSIONID}/isVisionLine`]:!0,[`${d.EXTENSIONID}/blocking`]:!0,[`${d.EXTENSIONID}/doubleSided`]:!0}).build();e.push(f),t.push(i.id)}}else if(n.type==="PATH"){const i=n;if(i.commands.length>2){const s=Ne().tension(0).points(Ln(i.commands,i.position)).strokeColor(m.sceneMetadata[`${d.EXTENSIONID}/toolColor`]??d.DEFAULTLINECOLOR).strokeDash(m.sceneMetadata[`${d.EXTENSIONID}/toolStyle`]??d.DEFAULTLINESTROKE).strokeWidth(be()).fillOpacity(0).fillColor("#000000").layer(d.LINELAYER).name("Vision Line (Line)").closed(!1).locked(!0).visible(!1).metadata({[`${d.EXTENSIONID}/isVisionLine`]:!0,[`${d.EXTENSIONID}/blocking`]:!0,[`${d.EXTENSIONID}/doubleSided`]:!0}).build();e.push(s),t.push(i.id)}}else if(n.type==="LINE"){const i=n,s=Ne().tension(0).points(qo([i.startPosition,i.endPosition],i.position)).strokeColor(m.sceneMetadata[`${d.EXTENSIONID}/toolColor`]??d.DEFAULTLINECOLOR).strokeDash(m.sceneMetadata[`${d.EXTENSIONID}/toolStyle`]??d.DEFAULTLINESTROKE).strokeWidth(be()).fillOpacity(0).fillColor("#000000").layer(d.LINELAYER).name("Vision Line (Line)").closed(!1).locked(!0).visible(!1).metadata({[`${d.EXTENSIONID}/isVisionLine`]:!0,[`${d.EXTENSIONID}/blocking`]:!0,[`${d.EXTENSIONID}/doubleSided`]:!0}).build();e.push(s),t.push(i.id)}else if(n.type==="SHAPE"){const i=n,s=[];if(i.shapeType==="CIRCLE"){const o=Math.min(i.width,i.height)/2,l=2*Math.PI/20;for(let c=0;c<20;c++){const f=c*l,g=o*Math.cos(f),v=o*Math.sin(f);s.push({x:g,y:v})}}else if(i.shapeType==="RECTANGLE"){const c=0+i.width,f=0+i.height;s.push({x:0,y:0}),s.push({x:c,y:0}),s.push({x:c,y:f}),s.push({x:0,y:f})}else if(i.shapeType==="HEXAGON"){const o=i.width/2,l=[Math.PI/2,Math.PI/6,11*Math.PI/6,3*Math.PI/2,7*Math.PI/6,5*Math.PI/6];for(let c=0;c<6;c++){const f=l[c],g=o*Math.cos(f),v=o*Math.sin(f);s.push({x:g,y:v})}}else i.shapeType==="TRIANGLE"&&(s.push({x:0,y:0}),s.push({x:0-i.width/2,y:0+i.height}),s.push({x:0+i.width/2,y:0+i.height}));if(s.length>0){s.push(s[0]);let o=s;if(i.shapeType==="CIRCLE"){const c=ja.CreateSkPath(s,.25,!0);o=Ln(c,{x:0,y:0},{curveSegments:20})}const l=Ne().tension(0).points(o).position(i.position).rotation(i.rotation).strokeColor(m.sceneMetadata[`${d.EXTENSIONID}/toolColor`]??d.DEFAULTLINECOLOR).strokeDash(m.sceneMetadata[`${d.EXTENSIONID}/toolStyle`]??d.DEFAULTLINESTROKE).strokeWidth(be()).fillOpacity(0).fillColor("#000000").layer(d.LINELAYER).name("Vision Line (Line)").closed(!1).locked(!0).visible(!1).metadata({[`${d.EXTENSIONID}/isVisionLine`]:!0,[`${d.EXTENSIONID}/blocking`]:!0,[`${d.EXTENSIONID}/doubleSided`]:!0}).build();e.push(l),t.push(i.id)}}if(e.length>0){for(let i=0;i<e.length;i+=5){const s=e.slice(i,i+5);await w.scene.items.addItems(s)}await w.scene.items.deleteItems(t)}}}),await w.contextMenu.create({id:`${d.EXTENSIONID}/toggle-vision-menu`,icons:[{icon:"/no-vision.svg",label:"Enable Vision",filter:{every:[{key:["metadata",`${d.EXTENSIONID}/hasVision`],operator:"==",value:void 0,coordinator:"&&"},{key:["metadata",`${d.SPECTREID}/isSpectre`],operator:"==",value:void 0}],some:[{key:"layer",value:"CHARACTER",coordinator:"||"},{key:"layer",value:"ATTACHMENT"}]}},{icon:"/icon.svg",label:"Disable Vision",filter:{every:[{key:["metadata",`${d.SPECTREID}/isSpectre`],operator:"==",value:void 0}],some:[{key:"layer",value:"CHARACTER",coordinator:"||"},{key:"layer",value:"ATTACHMENT"}]}}],async onClick(a){const e=a.items.every(t=>t.metadata[`${d.EXTENSIONID}/hasVision`]===void 0);await w.scene.items.updateItems(a.items,t=>{for(const n of t)e?(n.metadata[`${d.EXTENSIONID}/hasVision`]=!0,n.metadata[`${d.EXTENSIONID}/visionRange`]===void 0&&(n.metadata[`${d.EXTENSIONID}/visionRange`]=$e(),n.metadata[`${d.EXTENSIONID}/visionSourceRange`]=ze(),n.metadata[`${d.EXTENSIONID}/visionFallOff`]=at(),n.metadata[`${d.EXTENSIONID}/visionInAngle`]=lt(),n.metadata[`${d.EXTENSIONID}/visionOutAngle`]=Ze(),n.metadata[`${d.EXTENSIONID}/visionDark`]=mn())):delete n.metadata[`${d.EXTENSIONID}/hasVision`]})}}),await w.contextMenu.create({id:`${d.EXTENSIONID}/toggle-vision-line`,icons:[{icon:"/icon.svg",label:"Disable Vision Line",filter:{every:[{key:["metadata",`${d.EXTENSIONID}/isVisionLine`],value:!0,coordinator:"&&"},{key:["metadata",`${d.EXTENSIONID}/disabled`],value:void 0}]}},{icon:"/no-vision.svg",label:"Enable Vision Line",filter:{every:[{key:["metadata",`${d.EXTENSIONID}/isVisionLine`],value:!0}]}}],async onClick(a){await w.scene.items.updateItems(a.items,e=>{for(const t of e)t.metadata[`${d.EXTENSIONID}/isVisionLine`]&&t.metadata[`${d.EXTENSIONID}/disabled`]?delete t.metadata[`${d.EXTENSIONID}/disabled`]:t.metadata[`${d.EXTENSIONID}/isVisionLine`]&&(t.metadata[`${d.EXTENSIONID}/disabled`]=!0)})}}),await w.contextMenu.create({id:`${d.EXTENSIONID}/switch-one-sided-type`,icons:[{icon:"/two-sided.svg",label:"Swap to Double-sided",filter:{every:[{key:["metadata",`${d.EXTENSIONID}/isVisionLine`],value:!0,coordinator:"&&"},{key:["metadata",`${d.EXTENSIONID}/isWindow`],value:void 0},{key:["metadata",`${d.EXTENSIONID}/doubleSided`],value:void 0}]}},{icon:"/left-sided.svg",label:"Swap to One-sided",filter:{every:[{key:["metadata",`${d.EXTENSIONID}/isVisionLine`],value:!0,coordinator:"&&"},{key:["metadata",`${d.EXTENSIONID}/isWindow`],value:void 0},{key:["metadata",`${d.EXTENSIONID}/doubleSided`],value:!0}]}}],async onClick(a){await w.scene.items.updateItems(a.items,e=>{for(const t of e)t.metadata[`${d.EXTENSIONID}/isVisionLine`]&&t.metadata[`${d.EXTENSIONID}/doubleSided`]?delete t.metadata[`${d.EXTENSIONID}/doubleSided`]:t.metadata[`${d.EXTENSIONID}/isVisionLine`]&&(t.metadata[`${d.EXTENSIONID}/doubleSided`]=!0)})}}),await w.contextMenu.create({id:`${d.EXTENSIONID}/switch-obstructing-side`,icons:[{icon:"/flip.svg",label:"Swap Obstructing Side",filter:{every:[{key:["metadata",`${d.EXTENSIONID}/isVisionLine`],value:!0,coordinator:"&&"},{key:"type",value:"CURVE",coordinator:"&&"},{key:["metadata",`${d.EXTENSIONID}/doubleSided`],value:void 0}]}}],async onClick(a){await w.scene.items.updateItems(a.items,e=>{for(const t of e){const n=t.points.reverse();t.points=n}})}}),await w.contextMenu.create({id:`${d.EXTENSIONID}/switch-blockage`,icons:[{icon:"/blocked.svg",label:"Swap to Unpassable",filter:{every:[{key:["metadata",`${d.EXTENSIONID}/isVisionLine`],value:!0,coordinator:"&&"},{key:["metadata",`${d.EXTENSIONID}/isWindow`],value:void 0},{key:["metadata",`${d.EXTENSIONID}/blocking`],value:void 0}]}},{icon:"/unblock.svg",label:"Swap to Passable",filter:{every:[{key:["metadata",`${d.EXTENSIONID}/isVisionLine`],value:!0,coordinator:"&&"},{key:["metadata",`${d.EXTENSIONID}/isWindow`],value:void 0},{key:["metadata",`${d.EXTENSIONID}/blocking`],value:!0}]}}],async onClick(a){await w.scene.items.updateItems(a.items,e=>{for(const t of e)t.metadata[`${d.EXTENSIONID}/isVisionLine`]&&t.metadata[`${d.EXTENSIONID}/blocking`]?delete t.metadata[`${d.EXTENSIONID}/blocking`]:t.metadata[`${d.EXTENSIONID}/isVisionLine`]&&(t.metadata[`${d.EXTENSIONID}/blocking`]=!0)})}}),await w.contextMenu.create({id:`${d.EXTENSIONID}/auto-fog-background`,icons:[{icon:"/fog-background.svg",label:"Auto Fog Map",filter:{every:[{key:"layer",value:"MAP"},{key:"type",value:"IMAGE"}],max:1}}],async onClick(a,e){await w.popover.open({id:d.CONTEXTID,url:"/pages/mapcontextembed.html",height:80,width:200,anchorElementId:e})},embed:{url:"/pages/mapcontextembed.html?contextmenu=true",height:80}}),await w.contextMenu.create({id:`${d.EXTENSIONID}/toggle-fog-map`,icons:[{icon:"/fog-background.svg",label:"Convert To Fog Map",filter:{every:[{key:"layer",value:"MAP"},{key:["metadata",`${d.EXTENSIONID}/isFogMap`],value:void 0}]}},{icon:"/fog-background.svg",label:"Convert To Normal Map",filter:{every:[{key:"layer",value:"FOG"},{key:["metadata",`${d.EXTENSIONID}/isFogMap`],value:!0}]}}],async onClick(a){const e=a.items.every(t=>t.metadata[`${d.EXTENSIONID}/isFogMap`]===void 0);await w.scene.items.updateItems(a.items,t=>{for(const n of t)e?(n.layer="FOG",n.zIndex=-1.00000001,n.disableAutoZIndex=!0,n.metadata[`${d.EXTENSIONID}/isFogMap`]=!0):(n.layer="MAP",n.zIndex=-1.00000001,n.disableAutoZIndex=!1,delete n.metadata[`${d.EXTENSIONID}/isFogMap`])})}}),await w.contextMenu.create({id:`${d.EXTENSIONID}/create-window`,icons:[{icon:"/window.svg",label:"Enable Window",filter:{every:[{key:["metadata",`${d.EXTENSIONID}/isVisionLine`],value:!0},{key:["metadata",`${d.EXTENSIONID}/isWindow`],value:void 0}],some:[{key:"layer",value:d.LINELAYER,coordinator:"||"},{key:"layer",value:"DRAWING"}],roles:["GM"]}},{icon:"/window.svg",label:"Disable Window",filter:{every:[{key:["metadata",`${d.EXTENSIONID}/isVisionLine`],value:!0},{key:["metadata",`${d.EXTENSIONID}/isWindow`],value:!0}],some:[{key:"layer",value:d.LINELAYER,coordinator:"||"},{key:"layer",value:"DRAWING"}],roles:["GM"]}}],async onClick(a){const e=a.items.every(t=>t.metadata[`${d.EXTENSIONID}/isWindow`]===void 0);await w.scene.items.updateItems(a.items,t=>{for(const n of t)e?(n.metadata[`${d.EXTENSIONID}/isWindow`]=!0,n.style.strokeDash=[20,20]):(delete n.metadata[`${d.EXTENSIONID}/isWindow`],n.style.strokeDash=d.DEFAULTLINESTROKE)})}}),await w.contextMenu.create({id:`${d.EXTENSIONID}/create-door`,icons:[{icon:"/opendoor.svg",label:"Enable Door",filter:{every:[{key:["metadata",`${d.EXTENSIONID}/isVisionLine`],value:!0},{key:["metadata",`${d.EXTENSIONID}/isDoor`],value:void 0}],some:[{key:"layer",value:d.LINELAYER,coordinator:"||"},{key:"layer",value:"DRAWING"}],roles:["GM"]}},{icon:"/closedoor.svg",label:"Disable Door",filter:{every:[{key:["metadata",`${d.EXTENSIONID}/isVisionLine`],value:!0},{key:["metadata",`${d.EXTENSIONID}/isDoor`],value:!0}],some:[{key:"layer",value:d.LINELAYER,coordinator:"||"},{key:"layer",value:"DRAWING"}],roles:["GM"]}}],async onClick(a){const e=a.items.every(t=>t.metadata[`${d.EXTENSIONID}/isDoor`]===void 0);await w.scene.items.updateItems(a.items,t=>{for(const n of t)e?(n.metadata[`${d.EXTENSIONID}/isDoor`]=!0,n.style.strokeColor=d.DOORCOLOR):(delete n.metadata[`${d.EXTENSIONID}/isDoorLocked`],delete n.metadata[`${d.EXTENSIONID}/doorOpen`],delete n.metadata[`${d.EXTENSIONID}/disabled`],delete n.metadata[`${d.EXTENSIONID}/isDoor`],n.style.strokeColor=m.sceneMetadata[`${d.EXTENSIONID}/toolColor`]??d.DEFAULTLINECOLOR)})}}),await w.contextMenu.create({id:`${d.EXTENSIONID}/open-door`,icons:[{icon:"/opendoor.svg",label:"Open Door",filter:{every:[{key:["metadata",`${d.EXTENSIONID}/isVisionLine`],value:!0},{key:["metadata",`${d.EXTENSIONID}/isDoor`],value:!0},{key:["metadata",`${d.EXTENSIONID}/doorOpen`],value:void 0},{key:["metadata",`${d.EXTENSIONID}/isDoorLocked`],value:void 0}],some:[{key:"layer",value:d.LINELAYER,coordinator:"||"},{key:"layer",value:"DRAWING"}]}},{icon:"/closedoor.svg",label:"Close Door",filter:{every:[{key:["metadata",`${d.EXTENSIONID}/isVisionLine`],value:!0},{key:["metadata",`${d.EXTENSIONID}/isDoor`],value:!0},{key:["metadata",`${d.EXTENSIONID}/doorOpen`],value:!0},{key:["metadata",`${d.EXTENSIONID}/isDoorLocked`],value:void 0}],some:[{key:"layer",value:d.LINELAYER,coordinator:"||"},{key:"layer",value:"DRAWING"}]}}],async onClick(a){await w.scene.items.updateItems(a.items,e=>{for(let t of e)t.metadata[`${d.EXTENSIONID}/isVisionLine`]&&t.metadata[`${d.EXTENSIONID}/disabled`]?(delete t.metadata[`${d.EXTENSIONID}/disabled`],delete t.metadata[`${d.EXTENSIONID}/doorOpen`]):t.metadata[`${d.EXTENSIONID}/isVisionLine`]&&(t.metadata[`${d.EXTENSIONID}/disabled`]=!0,t.metadata[`${d.EXTENSIONID}/doorOpen`]=!0)})}}),await w.contextMenu.create({id:`${d.EXTENSIONID}/toggle-door-lock`,icons:[{icon:"/locked-door.svg",label:"Lock Door",filter:{every:[{key:["metadata",`${d.EXTENSIONID}/isDoorLocked`],value:void 0},{key:["metadata",`${d.EXTENSIONID}/isDoor`],value:!0},{key:["metadata",`${d.EXTENSIONID}/doorOpen`],value:void 0}],some:[{key:"layer",value:d.LINELAYER,coordinator:"||"},{key:"layer",value:"DRAWING"}],roles:["GM"]}},{icon:"/unlocked-door.svg",label:"Unlock Door",filter:{every:[{key:["metadata",`${d.EXTENSIONID}/isVisionLine`],value:!0},{key:["metadata",`${d.EXTENSIONID}/isDoor`],value:!0},{key:["metadata",`${d.EXTENSIONID}/doorOpen`],value:void 0}],some:[{key:"layer",value:d.LINELAYER,coordinator:"||"},{key:"layer",value:"DRAWING"}],roles:["GM"]}}],async onClick(a){const e=a.items.every(t=>t.metadata[`${d.EXTENSIONID}/isDoorLocked`]===void 0);await w.scene.items.updateItems(a.items,t=>{for(const n of t)e?n.metadata[`${d.EXTENSIONID}/isDoorLocked`]=!0:delete n.metadata[`${d.EXTENSIONID}/isDoorLocked`]})}}),await w.contextMenu.create({id:`${d.EXTENSIONID}/toggle-torch`,icons:[{icon:"/light.svg",label:"Enable Torchlight",filter:{every:[{key:["metadata",`${d.EXTENSIONID}/isTorch`],operator:"==",value:void 0},{key:["metadata",`${d.SPECTREID}/isSpectre`],operator:"==",value:void 0}],some:[{key:"layer",value:"PROP",coordinator:"||"},{key:"layer",value:"ATTACHMENT"}]}},{icon:"/no-light.svg",label:"Disable Torchlight",filter:{every:[{key:["metadata",`${d.EXTENSIONID}/isTorch`],operator:"==",value:!0},{key:["metadata",`${d.SPECTREID}/isSpectre`],operator:"==",value:void 0}],some:[{key:"layer",value:"PROP",coordinator:"||"},{key:"layer",value:"ATTACHMENT"}]}}],async onClick(a){const e=a.items.every(t=>t.metadata[`${d.EXTENSIONID}/isTorch`]===void 0);await w.scene.items.updateItems(a.items,t=>{for(const n of t)e?(n.metadata[`${d.EXTENSIONID}/isTorch`]=!0,n.metadata[`${d.EXTENSIONID}/hasVision`]=!0):(delete n.metadata[`${d.EXTENSIONID}/isTorch`],delete n.metadata[`${d.EXTENSIONID}/hasVision`])})}}),await w.contextMenu.create({id:`${d.SPECTREID}/context-menu`,icons:[{icon:"/ghost.svg",label:"Spectre",filter:{every:[{key:"type",value:"IMAGE"},{key:["metadata",`${d.SPECTREID}/isSpectre`],value:void 0,operator:"==",coordinator:"&&"},{key:["metadata",`${d.EXTENSIONID}/hasVision`],operator:"==",value:void 0}]}},{icon:"/ghost.svg",label:"Un-Spectre",filter:{every:[{key:"type",value:"IMAGE"},{key:["metadata",`${d.SPECTREID}/isSpectre`],value:void 0,operator:"!=",coordinator:"&&"},{key:["metadata",`${d.EXTENSIONID}/hasVision`],operator:"==",value:void 0}]}}],async onClick(a){const e=a.items.every(t=>t.metadata[`${d.SPECTREID}/isSpectre`]===!0);if(await w.scene.items.updateItems(a.items,t=>{for(const n of t)e?(delete n.metadata[`${d.SPECTREID}/isSpectre`],delete n.metadata[`${d.SPECTREID}/spectreViewers`],n.visible=!0):(n.metadata[`${d.SPECTREID}/isSpectre`]=!0,n.metadata[`${d.SPECTREID}/spectreViewers`]=[m.playerId],n.visible=!1)}),e)for(const t of a.items)ct.RemoveGhostSelect(t.id);else for(const t of a.items)await ct.SetupGhostSelect(t)}}),m.sceneMetadata[`${d.EXTENSIONID}/unitContextMenu`]===!0&&await ea(!0),m.sceneMetadata[`${d.EXTENSIONID}/wallContextMenu`]===!0&&await Jn(!0),m.sceneMetadata[`${d.EXTENSIONID}/autoHide`]===!0&&await Zn(!0)}async function Zn(a){a?await w.contextMenu.create({id:`${d.EXTENSIONID}/autohide-toggle`,icons:[{icon:"/autohide-off.svg",label:"Enable Autohide",filter:{every:[{key:["metadata",`${d.EXTENSIONID}/hasVision`],operator:"==",value:void 0,coordinator:"&&"},{key:["metadata",`${d.EXTENSIONID}/isAutoHidden`],operator:"==",value:void 0,coordinator:"&&"},{key:["metadata",`${d.SPECTREID}/isSpectre`],operator:"==",value:void 0}],some:[{key:"layer",value:"CHARACTER",coordinator:"||"},{key:"layer",value:"PROP",coordinator:"||"},{key:"layer",value:"ATTACHMENT"}]}},{icon:"/autohide-on.svg",label:"Disable Autohide",filter:{every:[{key:["metadata",`${d.EXTENSIONID}/isAutoHidden`],operator:"==",value:!0,coordinator:"&&"}],some:[{key:"layer",value:"CHARACTER",coordinator:"||"},{key:"layer",value:"PROP",coordinator:"||"},{key:"layer",value:"ATTACHMENT"}]}}],async onClick(e){const t=e.items.every(n=>n.metadata[`${d.EXTENSIONID}/isAutoHidden`]===void 0);await w.scene.items.updateItems(e.items,n=>{for(const i of n)t?i.metadata[`${d.EXTENSIONID}/isAutoHidden`]=!0:delete i.metadata[`${d.EXTENSIONID}/isAutoHidden`]})}}):await w.contextMenu.remove(`${d.EXTENSIONID}/autohide-toggle`)}async function Jn(a){a?await w.contextMenu.create({id:`${d.EXTENSIONID}/switch-advanced-wall`,icons:[{icon:"/advancedwall.svg",label:"Advanced Settings",filter:{every:[{key:["metadata",`${d.EXTENSIONID}/isVisionLine`],value:!0}]}}],async onClick(e,t){await w.popover.open({id:d.CONTEXTID,url:"/pages/wallcontextembed.html",height:80,width:200,anchorElementId:t})},embed:{url:"/pages/wallcontextembed.html?contextmenu=true",height:80}}):await w.contextMenu.remove(`${d.EXTENSIONID}/switch-advanced-wall`)}async function ea(a){a?await w.contextMenu.create({id:`${d.EXTENSIONID}/context-menu-embed`,icons:[{icon:"/icon.svg",label:"Vision Settings",filter:{every:[{key:["metadata",`${d.EXTENSIONID}/hasVision`],operator:"==",value:!0,coordinator:"&&"},{key:["metadata",`${d.SPECTREID}/isSpectre`],operator:"==",value:void 0}],some:[{key:"layer",value:"CHARACTER",coordinator:"||"},{key:"layer",value:"PROP",coordinator:"||"},{key:"layer",value:"ATTACHMENT"}]}}],async onClick(e,t){await w.popover.open({id:d.CONTEXTID,url:"/pages/unitcontextembed.html",height:170,width:200,anchorElementId:t})},embed:{url:"/pages/unitcontextembed.html?contextmenu=true",height:170}}):await w.contextMenu.remove(`${d.EXTENSIONID}/context-menu-embed`)}function qo(a,e){return a.map(t=>({x:t.x+e.x,y:t.y+e.y}))}class te{static PLAYER="PLAYER";static PARTY="PARTY";static SCENEITEMS="SCENEITEMS";static SCENELOCAL="SCENELOCAL";static SCENEMETA="SCENEMETADATA";static SCENEGRID="SCENEGRID";static SCENEFOG="SCENEFOG";static ROOMMETA="ROOMMETADATA";playerId;playerColor;playerName;playerMetadata;playerRole;party;lastParty;fogFilled;fogColor;fogStroke;gridDpi;gridScale;gridSnap;gridUnit;gridType;storedMetaItems;sceneId;sceneItems;sceneLocal;sceneSelected;sceneMetadata;sceneReady;roomMetadata;theme;caches;snap;torchActive;busy;USER_REGISTERED;toolStarted;expectedFogMapId;expectedFogStyle;expectedFogEffect;sceneMetadataHandler;sceneItemsHandler;sceneLocalHandler;sceneGridHandler;sceneReadyHandler;playerHandler;partyHandler;themeHandler;roomHandler;fogHandler;constructor(e){this.playerId="",this.playerName="",this.playerColor="",this.playerMetadata={},this.playerRole="PLAYER",this.party=[],this.lastParty=[],this.fogFilled=!1,this.fogColor="#000",this.fogStroke=5,this.storedMetaItems=[],this.sceneId="",this.sceneItems=[],this.sceneLocal=[],this.sceneSelected=[],this.sceneMetadata={},this.gridDpi=0,this.gridScale=5,this.gridSnap=10,this.gridUnit="ft",this.gridType="SQUARE",this.sceneReady=!1,this.theme={},this.roomMetadata={},this.snap=!1,this.busy=!1,this.torchActive=!1,this.toolStarted=!1,this.expectedFogMapId="",this.expectedFogStyle="",this.expectedFogEffect="",this.USER_REGISTERED=!1,this.caches=e}async RefreshCache(){if(this.caches.includes(te.PLAYER)&&(this.playerId=await w.player.getId(),this.playerName=await w.player.getName(),this.playerColor=await w.player.getColor(),this.playerMetadata=await w.player.getMetadata(),this.playerRole=await w.player.getRole()),this.caches.includes(te.PARTY)&&(this.party=await w.party.getPlayers()),this.caches.includes(te.SCENEFOG)&&this.sceneReady&&(this.fogColor=await w.scene.fog.getColor(),this.fogFilled=await w.scene.fog.getFilled()),this.caches.includes(te.SCENEITEMS)&&this.sceneReady&&(this.sceneItems=await w.scene.items.getItems(),this.sceneLocal=await w.scene.local.getItems()),this.caches.includes(te.SCENEMETA)&&this.sceneReady){this.sceneMetadata=await w.scene.getMetadata();const e=this.sceneMetadata[`${d.EXTENSIONID}/stored`];e&&(this.storedMetaItems=e),this.sceneId=this.sceneMetadata[`${d.EXTENSIONID}/sceneId`],(this.sceneId===""||this.sceneId===void 0)&&await w.scene.setMetadata({[`${d.EXTENSIONID}/sceneId`]:crypto.randomUUID()})}if(this.caches.includes(te.SCENEGRID)&&this.sceneReady){this.gridDpi=await w.scene.grid.getDpi(),this.gridType=await w.scene.grid.getType();const e=await w.scene.grid.getScale();this.gridScale=e.parsed?.multiplier??5,this.gridUnit=e.parsed.unit}this.caches.includes(te.ROOMMETA)&&this.sceneReady&&(this.roomMetadata=await w.room.getMetadata())}async InitializeCache(){if(this.sceneReady=await w.scene.isReady(),this.theme=await w.theme.getTheme(),ba(this.theme,document),this.caches.includes(te.PLAYER)&&(this.playerId=await w.player.getId(),this.playerName=await w.player.getName(),this.playerColor=await w.player.getColor(),this.playerMetadata=await w.player.getMetadata(),this.playerRole=await w.player.getRole()),this.caches.includes(te.PARTY)&&(this.party=await w.party.getPlayers()),this.caches.includes(te.SCENEFOG)&&this.sceneReady&&(this.fogColor=await w.scene.fog.getColor(),this.fogFilled=await w.scene.fog.getFilled()),this.caches.includes(te.SCENEITEMS)&&this.sceneReady&&(this.sceneItems=await w.scene.items.getItems(),this.sceneLocal=await w.scene.local.getItems()),this.caches.includes(te.SCENEMETA)&&this.sceneReady){this.sceneMetadata=await w.scene.getMetadata();const e=this.sceneMetadata[`${d.EXTENSIONID}/stored`];e&&(this.storedMetaItems=e)}if(this.caches.includes(te.SCENEGRID)&&this.sceneReady){this.gridDpi=await w.scene.grid.getDpi(),this.gridType=await w.scene.grid.getType();const e=await w.scene.grid.getScale();this.gridScale=e.parsed?.multiplier??5,this.gridUnit=e.parsed.unit}this.caches.includes(te.ROOMMETA)&&this.sceneReady&&(this.roomMetadata=await w.room.getMetadata()),w.broadcast.onMessage(`${d.EXTENSIONID}/ELEVATIONEVENT`,e=>{switch(e.data){case"CANCEL":sa();break;case"FINISH":_i();break;case"UNDO":ki();break}}),w.broadcast.onMessage(`${d.EXTENSIONID}/LINEEVENT`,e=>{switch(e.data){case"CANCEL":qn();break;case"FINISH":vn();break;case"UNDO":Ii();break}}),w.broadcast.onMessage(`${d.EXTENSIONID}/POLYGONEVENT`,e=>{switch(e.data){case"CANCEL":Kn();break;case"FINISH":yn();break;case"UNDO":Ti();break}}),w.broadcast.onMessage(d.RESETPERSISTID,async e=>{await Ie.ClearPersistence()}),w.broadcast.onMessage(`${d.EXTENSIONID}/FOGBACKGROUNDEVENT`,async e=>{const t=e.data;this.expectedFogMapId=t.MapId,this.expectedFogStyle=t.FogStyle,this.expectedFogEffect=t.FogEffect}),await this.CheckRegistration(),await this.SaveUserToScene()}async SaveUserToScene(){await w.scene.setMetadata({[`${d.EXTENSIONID}/USER-${this.playerId}`]:{role:this.playerRole,name:this.playerName,color:this.playerColor}})}KillHandlers(){this.caches.includes(te.SCENEMETA)&&this.sceneMetadataHandler!==void 0&&this.sceneMetadataHandler(),this.caches.includes(te.SCENEITEMS)&&this.sceneItemsHandler!==void 0&&this.sceneItemsHandler(),this.caches.includes(te.SCENEITEMS)&&this.sceneLocalHandler!==void 0&&this.sceneLocalHandler(),this.caches.includes(te.SCENEGRID)&&this.sceneGridHandler!==void 0&&this.sceneGridHandler(),this.caches.includes(te.PLAYER)&&this.playerHandler!==void 0&&this.playerHandler(),this.caches.includes(te.PARTY)&&this.partyHandler!==void 0&&this.partyHandler(),this.caches.includes(te.ROOMMETA)&&this.roomHandler!==void 0&&this.roomHandler(),this.caches.includes(te.SCENEFOG)&&this.fogHandler!==void 0&&this.fogHandler(),this.themeHandler!==void 0&&this.themeHandler()}SetupHandlers(){(this.sceneMetadataHandler===void 0||this.sceneMetadataHandler.length===0)&&this.caches.includes(te.SCENEMETA)&&(this.sceneMetadataHandler=w.scene.onMetadataChange(async e=>{this.sceneMetadata[`${d.EXTENSIONID}/playerDoors`]===!0&&e[`${d.EXTENSIONID}/playerDoors`]!==!0&&Ie.ClearDoors(),m.playerRole==="GM"&&(this.sceneMetadata[`${d.EXTENSIONID}/unitContextMenu`]!==!0&&e[`${d.EXTENSIONID}/unitContextMenu`]===!0?await ea(!0):this.sceneMetadata[`${d.EXTENSIONID}/unitContextMenu`]===!0&&e[`${d.EXTENSIONID}/unitContextMenu`]!==!0&&await ea(!1),this.sceneMetadata[`${d.EXTENSIONID}/wallContextMenu`]!==!0&&e[`${d.EXTENSIONID}/wallContextMenu`]===!0?await Jn(!0):this.sceneMetadata[`${d.EXTENSIONID}/wallContextMenu`]===!0&&e[`${d.EXTENSIONID}/wallContextMenu`]!==!0&&await Jn(!1),this.sceneMetadata[`${d.EXTENSIONID}/autoHide`]!==!0&&e[`${d.EXTENSIONID}/autoHide`]===!0?await Zn(!0):this.sceneMetadata[`${d.EXTENSIONID}/autoHide`]===!0&&e[`${d.EXTENSIONID}/autoHide`]!==!0&&await Zn(!1)),this.sceneMetadata[`${d.EXTENSIONID}/persistence`]===!0&&e[`${d.EXTENSIONID}/persistence`]!==!0&&Ie.ClearPersistence(),this.sceneMetadata[`${d.EXTENSIONID}/toggleOwnerLines`]!==!0&&e[`${d.EXTENSIONID}/toggleOwnerLines`]===!0?Ie.InitiateOwnerHighlight():this.sceneMetadata[`${d.EXTENSIONID}/toggleOwnerLines`]===!0&&e[`${d.EXTENSIONID}/toggleOwnerLines`]!==!0&&Ie.ClearOwnershipHighlights();const t=e[`${d.EXTENSIONID}/disableVision`];t!==void 0&&(this.sceneMetadata[`${d.EXTENSIONID}/disableVision`]===!0&&e[`${d.EXTENSIONID}/disableVision`]!==!0||this.sceneMetadata[`${d.EXTENSIONID}/disableVision`]!==!0&&e[`${d.EXTENSIONID}/disableVision`]===!0)&&Ie.TogglePersistentLightVisibility(t),this.sceneMetadata=e,await this.OnSceneMetadataChanges(e)})),(this.sceneItemsHandler===void 0||this.sceneItemsHandler.length===0)&&this.caches.includes(te.SCENEITEMS)&&(this.sceneItemsHandler=w.scene.items.onChange(async e=>{this.sceneItems=e,await this.OnSceneItemsChange(e)}),this.sceneLocalHandler=w.scene.local.onChange(async e=>{const t=[...this.sceneLocal];this.sceneLocal=e,await this.OnSceneLocalChange(t)})),(this.sceneGridHandler===void 0||this.sceneGridHandler.length===0)&&this.caches.includes(te.SCENEGRID)&&(this.sceneGridHandler=w.scene.grid.onChange(async e=>{await this.OnSceneGridChange(e),this.gridDpi=e.dpi,this.gridType=await w.scene.grid.getType(),this.gridScale=parseInt(e.scale)})),(this.playerHandler===void 0||this.playerHandler.length===0)&&this.caches.includes(te.PLAYER)&&(this.playerHandler=w.player.onChange(async e=>{const t=this.playerRole;let n=!1;(this.playerName!==e.name||this.playerColor!==e.color||this.playerRole!==e.role)&&(n=!0),this.playerName=e.name,this.playerColor=e.color,this.playerId=e.id,this.playerRole=e.role,this.playerMetadata=e.metadata,await this.OnPlayerChange(e,t),n&&await this.SaveUserToScene()})),(this.partyHandler===void 0||this.partyHandler.length===0)&&this.caches.includes(te.PARTY)&&(this.partyHandler=w.party.onChange(async e=>{this.party=e.filter(t=>t.id!==""),await this.OnPartyChange(e)})),(this.roomHandler===void 0||this.roomHandler.length===0)&&this.caches.includes(te.ROOMMETA)&&(this.roomHandler=w.room.onMetadataChange(async e=>{await this.OnRoomMetadataChange(e),this.roomMetadata=e})),(this.fogHandler===void 0||this.fogHandler.length===0)&&this.caches.includes(te.SCENEFOG)&&(this.fogHandler=w.scene.fog.onChange(async e=>{this.fogColor=e.style.color,this.fogFilled=e.filled,await this.OnFogChange(e)})),this.themeHandler===void 0&&(this.themeHandler=w.theme.onChange(async e=>{this.theme=e,await this.OnThemeChange(e)})),this.sceneReadyHandler===void 0&&(this.sceneReadyHandler=w.scene.onReadyChange(async e=>{this.sceneReady=e,await this.OnSceneReadyChange(e)}))}async OnSceneMetadataChanges(e){this.playerRole,await ne.OnDataChange()}async OnSceneItemsChange(e){if(this.expectedFogMapId!==""){const t=e.filter(n=>n.id===this.expectedFogMapId);if(t.length>0){const n=t[0];await Li(n,this.expectedFogEffect),this.expectedFogMapId="",this.expectedFogStyle="",this.expectedFogEffect=""}}this.playerRole==="GM"&&ct.CheckForRemovedTokens(),await ne.OnDataChange()}async OnSceneLocalChange(e){await ct.HandleLocalMovement(e)}async OnSceneGridChange(e){await ne.OnDataChange()}async OnSceneReadyChange(e){e?(await this.SaveUserToScene(),await this.RefreshCache(),await Ie.Reset(),await ne.Start(),this.SetupHandlers()):(this.KillHandlers(),await ne.Stop(),this.sceneItems=[],this.sceneMetadata={},this.playerRole==="GM"&&(this.toolStarted=!1),await w.tool.setMetadata(`${d.EXTENSIONID}/vision-tool`,{[`${d.EXTENSIONID}/elevationEditor`]:!1}))}async OnPlayerChange(e,t){if(this.playerRole!==t&&(await ne.Stop(),await Ie.Reset(),await ne.Start()),e.role==="GM"){const n=document.querySelectorAll(".token-table-entry");for(let f of n){let g=f.id.substring(3);e.selection!==void 0&&e.selection.includes(g)?f.classList.add("token-table-selected"):f.classList.remove("token-table-selected")}const i=e.metadata;(i[`${d.EXTENSIONID}/finishLine`]??!1)===!0&&vn(),(i[`${d.EXTENSIONID}/cancelLine`]??!1)===!0&&qn(),(i[`${d.EXTENSIONID}/finishPoly`]??!1)===!0&&yn(),(i[`${d.EXTENSIONID}/cancelPoly`]??!1)===!0&&Kn()}e.selection!==void 0&&e.selection.length===1&&Ie.ToggleDoor(e.selection[0])}async OnPartyChange(e){if(this.playerRole!=="PLAYER"){const t=document.getElementById("playerListing");t.innerHTML="",t.appendChild(ne.GetEmptyContextItem("Self"));const n=document.getElementById("preview_select");n.innerHTML="";const i=document.createElement("option");i.value=m.playerId,i.textContent="View As: Self",n.appendChild(i);for(const s of this.party){const o=document.createElement("li");o.id=s.id,o.textContent=s.name,o.style.color=s.color,t.appendChild(o);const l=document.createElement("option");l.value=s.id,l.textContent=`View As: ${s.name}`,l.style.color=s.color,n.appendChild(l)}ct.UpdateSpectreTargets()}}async OnFogChange(e){const t=document.getElementById("toggle_fogfill");t&&(t.checked=e.filled),this.fogColor!==e.style.color&&await Ie.UpdateTrailingFogColor(e.style.color),await Ie.Run(!0)}async OnRoomMetadataChange(e){}async OnThemeChange(e){ba(e,document)}async ToggleBusy(e){const t=document.getElementById("preview_select");if(t.value!==m.playerId&&!e){const n=m.party.find(i=>i.id===t.value);n&&await w.action.setBadgeText(`Viewing as: ${n.name}`)}else await w.action.setBadgeText(e?"⏱️":void 0),m.busy=e}async CheckRegistration(){try{const e=window.location.origin.includes("localhost")?"eternaldream":"",t={owlbearid:m.playerId},n={method:"POST",headers:new Headers({"Content-Type":"application/json",Authorization:d.ANONAUTH,"x-manuel":e}),body:JSON.stringify(t)},i=await fetch(d.CHECKREGISTRATION,n);if(!i.ok){const o=await i.json();console.error("Error:",o);return}(await i.json()).Data==="OK"?(this.USER_REGISTERED=!0,console.log("Connected")):console.log("Not Registered")}catch(e){console.error("Error:",e)}}}const m=new te([te.SCENEITEMS,te.SCENEMETA,te.SCENEFOG,te.SCENEGRID,te.PLAYER,te.PARTY]),Ga=25;function Wa(){const a=document.getElementById("map_align");if(!a)return;const e=m.sceneItems.filter(i=>i.layer==="MAP"),t={};for(let i=0;i<e.length;i++){const s=e[i];let o=a.querySelector("#map-"+s.id);o===null?(o=document.createElement("option"),o.id="map-"+s.id,o.value=s.id,o.innerText=s.name,a.appendChild(o)):o.innerText!==s.name&&(o.innerText=s.name),t[s.id]=s.name}let n=a.querySelectorAll("option");for(let i=0;i<n.length;i++)t[n[i].value]===void 0&&a.removeChild(n[i])}async function Ko(a,e,t,n,i){if(i.innerText="",Number.isNaN(t)||t<0){i.innerText="Invalid DPI";return}let s=m.gridDpi/t,o,l=[];if(l[0]=0,l[1]=0,n!==""){let c=await w.scene.items.getItems([n]);if(c.length>0)o=c[0],t===0&&(t=o.grid.dpi),s=m.gridDpi/t,l[0]=o.position.x-o.grid.offset.x*s,l[1]=o.position.y-o.grid.offset.y*s;else{i.innerText="Unable to find map";return}}else{i.innerText="No map selected";return}a==="foundry"?ed(e,s,l,i):a==="uvtt"&&Jo(e,s,l,i)}function Ya(a){const e=[];for(const t of a){const n=[];for(const s of t)n.push({x:s.x*m.gridDpi,y:s.y*m.gridDpi});const i=Ne().tension(0).points(n).strokeColor(m.sceneMetadata[`${d.EXTENSIONID}/toolColor`]??d.DEFAULTLINECOLOR).strokeDash(m.sceneMetadata[`${d.EXTENSIONID}/toolStyle`]??d.DEFAULTLINESTROKE).strokeWidth(be()).fillOpacity(0).fillColor("#000000").layer(d.LINELAYER).name("Vision Line (Line)").closed(!1).locked(!0).visible(!1).metadata({[`${d.EXTENSIONID}/isVisionLine`]:!0,[`${d.EXTENSIONID}/blocking`]:!0,[`${d.EXTENSIONID}/doubleSided`]:!0}).build();e.push(i)}return e}function Qo(a){const e=[];for(const t of a){const n=[];for(const s of t.bounds)n.push({x:s.x*m.gridDpi,y:s.y*m.gridDpi});const i=Ne().tension(0).points(n).strokeColor(d.DOORCOLOR).strokeDash(m.sceneMetadata[`${d.EXTENSIONID}/toolStyle`]??d.DEFAULTLINESTROKE).strokeWidth(be()).fillOpacity(0).fillColor("#000000").layer(d.LINELAYER).name("Vision Line (Door)").closed(!1).locked(!0).visible(!1).metadata({[`${d.EXTENSIONID}/isVisionLine`]:!0,[`${d.EXTENSIONID}/blocking`]:!0,[`${d.EXTENSIONID}/doubleSided`]:!0,[`${d.EXTENSIONID}/isDoor`]:!0}).build();t.closed||(i.metadata[`${d.EXTENSIONID}/disabled`]=!0,i.metadata[`${d.EXTENSIONID}/doorOpen`]=!0),e.push(i)}return e}async function Zo(a,e){let t=[];a.objects_line_of_sight?.length>0&&(t=t.concat(Ya(a.objects_line_of_sight))),a.line_of_sight?.length>0&&(t=t.concat(Ya(a.line_of_sight))),a.portals?.length>0&&(t=t.concat(Qo(a.portals)));try{if(a.lights?.length>0){let v=function(O){if(!O)return"0";const k=1,L=5,R=2,F=.1,M=(O-k)/(L-k);return(R+(F-R)*(1-M)).toString()};const S=[];for(const O of a.lights){const k=hn({height:150,width:150,url:"https://upload.wikimedia.org/wikipedia/commons/5/59/Empty.png",mime:"image/png"},{dpi:300,offset:{x:150,y:150}}).position({x:O.position.x*m.gridDpi,y:O.position.y*m.gridDpi}).layer("PROP").metadata({[`${d.EXTENSIONID}/hasVision`]:!0,[`${d.EXTENSIONID}/isTorch`]:!0,[`${d.EXTENSIONID}/visionFallOff`]:v(O.intensity),[`${d.EXTENSIONID}/hiddenToken`]:!0,[`${d.EXTENSIONID}/visionRange`]:O.range.toString()}).name("Imported Light Source").build();S.push(k)}t=t.concat(S)}const n=atob(a.image),i=new Uint8Array(n.length),o=a.resolution.map_size.x*a.resolution.map_size.y*Math.pow(a.resolution.pixels_per_grid,2);for(let v=0;v<n.length;v++)i[v]=n.charCodeAt(v);const l=new Blob([i],{type:"image/png"}),c=o>6e7?await qa(l,.8,!0):await qa(l,.8);if(!c)throw new Error("Unable to convert to WebP");const f=ur(c).grid({dpi:a.resolution.pixels_per_grid,offset:{x:0,y:0}}).build();o>6e7&&(f.scale={x:2,y:2});const g=fr().baseMap(f).fogFilled(!0).name("New UVTT Scene").items(t).build();await w.assets.uploadScenes([g],!0)}catch(n){await w.notification.show("There was an error: "+n.error.message,"ERROR")}}async function Vi(a,e,t,n,i){let s=0,o=0;const l=[];for(let c=0;c<a.length;c++){let f=[],g=!1;for(let S=0;S<a[c].length-1;S++){let O=a[c][S].x*e,k=a[c][S].y*e,L=a[c][S+1].x*e,R=a[c][S+1].y*e;f.push({x:O*t+n[0],y:k*t+n[1]}),f.push({x:L*t+n[0],y:R*t+n[1]}),o++,!g&&a[c][S].door&&(g=!0)}f.length>128&&(f=yi(f,8,!1));const v=Ne().tension(0).points(f).strokeColor(m.sceneMetadata[`${d.EXTENSIONID}/toolColor`]??d.DEFAULTLINECOLOR).strokeDash(m.sceneMetadata[`${d.EXTENSIONID}/toolStyle`]??d.DEFAULTLINESTROKE).strokeWidth(be()).fillOpacity(0).fillColor("#000000").layer(d.LINELAYER).name("Vision Line (Import)").metadata({[`${d.EXTENSIONID}/isVisionLine`]:!0,[`${d.EXTENSIONID}/blocking`]:!0,[`${d.EXTENSIONID}/doubleSided`]:!0}).closed(!1).visible(!1).locked(!0).build();g&&(v.metadata[`${d.EXTENSIONID}/isDoor`]=!0),l.push(v)}for(let c=0;c<l.length;c+=Ga){const f=l.slice(c,c+Ga);await w.scene.items.addItems(f)}i.innerText="Finished importing "+s+" walls, "+o+" points."}function Jo(a,e,t,n){if(a.resolution.map_origin!==void 0&&(t[0]-=a.resolution.map_origin.x*a.resolution.pixels_per_grid,t[1]-=a.resolution.map_origin.y*a.resolution.pixels_per_grid),a.portals&&a.portals.length)for(let s=0;s<a.portals.length;s++){let o=a.portals[s].bounds;o[0].door=!0,o[1].door=!0,a.line_of_sight.push(o)}const i=a.line_of_sight.concat(a.objects_line_of_sight);Vi(i,a.resolution.pixels_per_grid,e,t,n)}function ed(a,e,t,n){if(!a.walls||a.walls.length===0){n.innerText="No walls found";return}const i=[];for(var s=0;s<a.walls.length;s++)i.push([{x:a.walls[s].c[0],y:a.walls[s].c[1],door:!!a.walls[s].door},{x:a.walls[s].c[2],y:a.walls[s].c[3],door:!!a.walls[s].door}]);Vi(i,1,e,t,n)}async function qa(a,e=.8,t=!1){const n=await createImageBitmap(a),i=document.createElement("canvas");return i.width=t?Math.floor(n.width/2):n.width,i.height=t?Math.floor(n.height/2):n.height,i.getContext("2d").drawImage(n,0,0,n.width,n.height,0,0,i.width,i.height),new Promise(o=>{i.toBlob(l=>{o(l)},"image/webp",e)})}function td(a=!1){const e=document.getElementById("hideListToggle");ne.hiddenList=document.getElementById("hidden_list"),ne.tokenList=document.getElementById("token_list"),e.onclick=async()=>{ne.hiddenList.style.display==="none"?(ne.hiddenList&&(ne.hiddenList.style.display="table-row-group"),e&&(e.value=a?"Tap to Hide List":"Out-of-Sight List: Click to Hide")):(ne.hiddenList&&(ne.hiddenList.style.display="none"),e&&(e.value=a?"Tap to Show List":"Out-of-Sight List: Click to Show"))};const t=document.getElementById("snap_checkbox");m.snap=!0,t.checked=!0,t.onclick=async $=>{if(!m.sceneReady){$.preventDefault();return}const X=$.target;m.snap=X.checked};const n=document.getElementById("disable_vision");n.checked=m.sceneMetadata[`${d.EXTENSIONID}/disableVision`]===!0,n.onclick=async $=>{{if(!$||!$.target)return;const X=$.target;await w.scene.setMetadata({[`${d.EXTENSIONID}/disableVision`]:X.checked})}};const i=document.getElementById("toggle_fogfill");i.checked=m.fogFilled,i.onclick=async $=>{if(!$||!$.target)return;const X=$.target;await w.scene.fog.setFilled(X.checked)};const s=document.getElementById("toggle_trailingfog");s.checked=m.sceneMetadata[`${d.EXTENSIONID}/trailingFog`]===!0,s.onclick=async $=>{if(!$||!$.target)return;const X=$.target;await w.scene.setMetadata({[`${d.EXTENSIONID}/trailingFog`]:X.checked})};const o=document.getElementById("toggle_autohide");o.checked=m.sceneMetadata[`${d.EXTENSIONID}/autoHide`]===!0,o.onclick=async $=>{if(!$||!$.target)return;const X=$.target;await w.scene.setMetadata({[`${d.EXTENSIONID}/autoHide`]:X.checked})};const l=document.getElementById("toggle_persistence");l.checked=m.sceneMetadata[`${d.EXTENSIONID}/persistence`]===!0,m.sceneMetadata[`${d.EXTENSIONID}/persistence`]!==!0&&(s.disabled=!0,s.checked=!1),l.onclick=async $=>{if(!$||!$.target)return;const X=$.target;await w.scene.setMetadata({[`${d.EXTENSIONID}/persistence`]:X.checked}),X.checked?s.disabled=!1:(s.disabled=!0,s.checked=!1,await w.scene.setMetadata({[`${d.EXTENSIONID}/trailingFog`]:!1}))};const c=document.getElementById("reset_persistence");c.onclick=async $=>{!$||!$.target||await w.broadcast.sendMessage(d.RESETPERSISTID,!0,{destination:"ALL"})};const f=document.getElementById("toggle_ownerlines");f.checked=m.sceneMetadata[`${d.EXTENSIONID}/toggleOwnerLines`]===!0,f.onclick=async $=>{if(!$||!$.target)return;const X=$.target;await w.scene.setMetadata({[`${d.EXTENSIONID}/toggleOwnerLines`]:X.checked})};const g=document.getElementById("door_checkbox");g.checked=m.sceneMetadata[`${d.EXTENSIONID}/playerDoors`]===!0,g.onclick=async $=>{if(!$||!$.target)return;const X=$.target;await w.scene.setMetadata({[`${d.EXTENSIONID}/playerDoors`]:X.checked})};const v=document.getElementById("toggle_unitcontextmenu");v.checked=m.sceneMetadata[`${d.EXTENSIONID}/unitContextMenu`]===!0,v.onclick=async $=>{if(!$||!$.target)return;const X=$.target;await w.scene.setMetadata({[`${d.EXTENSIONID}/unitContextMenu`]:X.checked})};const S=document.getElementById("toggle_wallcontextmenu");S.checked=m.sceneMetadata[`${d.EXTENSIONID}/wallContextMenu`]===!0,S.onclick=async $=>{if(!$||!$.target)return;const X=$.target;await w.scene.setMetadata({[`${d.EXTENSIONID}/wallContextMenu`]:X.checked})};const O=document.getElementById("default_elevation_select"),k=m.sceneMetadata[`${d.EXTENSIONID}/defaultElevation`];O.value=typeof k=="string"?k:"-10",O.onchange=async $=>{const X=$.currentTarget;await w.scene.setMetadata({[`${d.EXTENSIONID}/defaultElevation`]:X.value})};const L=document.getElementById("elevation_style_select"),R=m.sceneMetadata[`${d.EXTENSIONID}/elevationComplex`];L.value=R==="true"?"true":"false",L.onchange=async $=>{const X=$.currentTarget;await w.scene.setMetadata({[`${d.EXTENSIONID}/elevationComplex`]:X.value==="true"})};const F=document.getElementById("toggle_gmwalls");F.checked=m.sceneMetadata[`${d.EXTENSIONID}/passWallsGM`]===!0,F.onclick=async $=>{if(!$||!$.target)return;const X=$.target;await w.scene.setMetadata({[`${d.EXTENSIONID}/passWallsGM`]:X.checked}),m.fogFilled||await Ie.Run(!0)};const M=document.getElementById("lock_button"),z=document.getElementById("unlock_button");z.onclick=async $=>{if(!$||!$.target)return;const X=m.sceneItems.filter(j=>Ft(j));await m.ToggleBusy(!0);for(let j=0;j<X.length;j+=64){const se=X.slice(j,j+64);await w.scene.items.updateItems(se.map(ie=>ie.id),ie=>{for(let ce of ie)ce.locked=!1})}m.ToggleBusy(!1)},M.onclick=async $=>{if(!$||!$.target)return;const X=m.sceneItems.filter(j=>Ft(j));await m.ToggleBusy(!0);for(let j=0;j<X.length;j+=64){const se=X.slice(j,j+64);await w.scene.items.updateItems(se.map(ie=>ie.id),ie=>{for(let ce of ie)ce.locked=!0})}await m.ToggleBusy(!1)};const r=document.getElementById("doublewall_button");r.onclick=async $=>{if(!$||!$.target)return;const X=m.sceneItems.filter(j=>Ft(j));await m.ToggleBusy(!0);for(let j=0;j<X.length;j+=64){const se=X.slice(j,j+64);await w.scene.items.updateItems(se.map(ie=>ie.id),ie=>{for(let ce of ie)ce.metadata[`${d.EXTENSIONID}/doubleSided`]=!0})}m.ToggleBusy(!1)};const p=document.getElementById("block_button"),u=document.getElementById("unblock_button");u.onclick=async $=>{if(!$||!$.target)return;const X=m.sceneItems.filter(j=>Ft(j));await m.ToggleBusy(!0);for(let j=0;j<X.length;j+=64){const se=X.slice(j,j+64);await w.scene.items.updateItems(se.map(ie=>ie.id),ie=>{for(let ce of ie)ce.metadata[`${d.EXTENSIONID}/blocking`]=void 0})}m.ToggleBusy(!1)},p.onclick=async $=>{if(!$||!$.target)return;const X=m.sceneItems.filter(j=>Ft(j));await m.ToggleBusy(!0);for(let j=0;j<X.length;j+=64){const se=X.slice(j,j+64);await w.scene.items.updateItems(se.map(ie=>ie.id),ie=>{for(let ce of ie)ce.metadata[`${d.EXTENSIONID}/blocking`]=!0})}await m.ToggleBusy(!1)};const h=document.getElementById("visionDefaultInput");h.value=m.sceneMetadata[`${d.EXTENSIONID}/visionRangeDefault`]??$e(),h.onchange=async $=>{if(!$||!$.target)return;const X=$.target,j=parseInt(X.value);j<0&&(X.value="0"),j>999&&(X.value="999"),isNaN(j)&&(X.value=ze()),await w.scene.setMetadata({[`${d.EXTENSIONID}/visionRangeDefault`]:X.value})};const T=document.getElementById("collisionDefaultInput");T.value=m.sceneMetadata[`${d.EXTENSIONID}/visionSourceDefault`]??ze().toString(),T.onchange=async $=>{if(!$||!$.target)return;const X=$.target,j=parseFloat(X.value);j<0&&(X.value="0"),j>999&&(X.value="999"),isNaN(j)&&(X.value=ze()),await w.scene.setMetadata({[`${d.EXTENSIONID}/visionSourceDefault`]:X.value})};const y=document.getElementById("greyscaleDefaultInput");y.value=m.sceneMetadata[`${d.EXTENSIONID}/visionDarkDefault`]??mn().toString(),y.onchange=async $=>{if(!$||!$.target)return;const X=$.target,j=parseInt(X.value);j<0&&(X.value="0"),j>999&&(X.value="999"),isNaN(j)&&(X.value=ze()),await w.scene.setMetadata({[`${d.EXTENSIONID}/visionDarkDefault`]:X.value})};const E=document.getElementById("innerAngleDefaultInput");E.value=m.sceneMetadata[`${d.EXTENSIONID}/visionInAngleDefault`]??lt().toString(),E.onchange=async $=>{if(!$||!$.target)return;const X=$.target,j=parseInt(X.value);j<-360&&(X.value="-360"),j>360&&(X.value="360"),isNaN(j)&&(X.value=Ze()),await w.scene.setMetadata({[`${d.EXTENSIONID}/visionInAngleDefault`]:X.value})};const I=document.getElementById("outerAngleDefaultInput");I.value=m.sceneMetadata[`${d.EXTENSIONID}/visionOutAngleDefault`]??Ze().toString(),I.onchange=async $=>{if(!$||!$.target)return;const X=$.target,j=parseInt(X.value);j<-360&&(X.value="-360"),j>360&&(X.value="360"),isNaN(j)&&(X.value=Ze()),await w.scene.setMetadata({[`${d.EXTENSIONID}/visionOutAngleDefault`]:X.value})};const C=document.getElementById("falloffDefaultInput");C.value=m.sceneMetadata[`${d.EXTENSIONID}/visionFallOffDefault`]??at().toString(),C.onchange=async $=>{if(!$||!$.target)return;const X=$.target,j=parseFloat(X.value);j<0&&(X.value="0"),j>10&&(X.value="10"),isNaN(j)&&(X.value=at()),await w.scene.setMetadata({[`${d.EXTENSIONID}/visionFallOffDefault`]:X.value})};var D;const A=document.getElementById("import_button"),P=document.getElementById("import_file"),b=document.getElementById("import_errors"),x=document.getElementById("import_dpi"),U=document.getElementById("import_format"),G=document.getElementById("dpi_autodetect"),Q=document.getElementById("map_align");P.onchange=$=>{if(A.disabled=!0,!$||!$.target)return;const X=$.target;if(!X.files)return;const j=X.files[0];if(j.type!=="text/javascript"&&j.type,j){const ie=document.getElementById("import_file_name");ie&&(ie.textContent=j.name);var se=new FileReader;se.onload=function(ce){if(!ce||!ce.target){b.innerText="Invalid import event";return}const ye=ce.target;if(!ye.result){b.innerText="Unable to read imported file";return}const rt=ye.result;D=JSON.parse(rt),D&&(D.walls&&D.walls.length||D.line_of_sight&&D.line_of_sight.length||D.objects_line_of_sight&&D.objects_line_of_sight.length)?A.disabled=!1:b.innerText="Imported file has no walls"},se.readAsText(j)}else b.innerText="Failed to load file"},G.onclick=async $=>{!$||!$.target||(x.disabled=G.checked)},A.onclick=async $=>{!$||!$.target||(await m.ToggleBusy(!0),U.value==="scene"?await Zo(D):await Ko(U.value,D,G.checked?0:Number.parseInt(x.value),Q.value,b),await m.ToggleBusy(!1))};const W=document.getElementById("tool_width"),J=document.getElementById("tool_color"),re=document.getElementById("tool_style");let oe;const ae=document.getElementById("preview_select");ae.onchange=async $=>{$.currentTarget,await m.ToggleBusy(!1),await Ie.Run()},J.onclick=async $=>{Ge({el:`#${J.id}`,alpha:!1,forceAlpha:!1})},J.oninput=async $=>{if(!$||!$.target)return;const X=$.target;clearTimeout(oe),oe=setTimeout(async()=>{/#[a-f0-9]{6}/.test(X.value)&&await w.scene.setMetadata({[`${d.EXTENSIONID}/toolColor`]:X.value})},400)},re.onchange=async $=>{const X=$.currentTarget;await w.scene.setMetadata({[`${d.EXTENSIONID}/toolStyle`]:X.value=="solid"?[]:[25,25]})},W.onchange=$=>{const X=$.currentTarget;clearTimeout(oe);try{const j=parseInt(X.value);(j<1||j>100)&&(X.value="8")}catch{console.log("Tool Width value set out of range, swapping to default"),X.value="8"}oe=setTimeout(async()=>{await w.scene.setMetadata({[`${d.EXTENSIONID}/toolWidth`]:X.value})},400)};const ee=m.sceneMetadata[`${d.EXTENSIONID}/toolColor`]??"#000000";J&&(J.value=ee),Ge({themeMode:"dark",alpha:!1,forceAlpha:!1,el:"#tool_color",defaultColor:ee})}class bn{static async GetGridSquare(e,t){if(!t.some(i=>i.x===e.x&&i.y===e.y)){const i={x:e.x*m.gridDpi,y:e.y*m.gridDpi},s={x:(e.x+1)*m.gridDpi,y:e.y*m.gridDpi},o={x:e.x*m.gridDpi,y:(e.y+1)*m.gridDpi},l={x:(e.x+1)*m.gridDpi,y:(e.y+1)*m.gridDpi},c=[[Ue.MOVE,i.x,i.y],[Ue.LINE,s.x,s.y],[Ue.LINE,l.x,l.y],[Ue.LINE,o.x,o.y],[Ue.CLOSE]],f=ra().commands(c).strokeOpacity(0).fillOpacity(.5).fillColor(m.sceneMetadata[`${d.EXTENSIONID}/toolColor`]??d.DEFAULTLINECOLOR).build();f.metadata[`${d.EXTENSIONID}/isBrushSquare`]=!0,f.layer="POINTER",t.push(e),await w.scene.local.addItems([f])}}static GetGridCoords(e){return{x:Math.floor(e.x/m.gridDpi),y:Math.floor(e.y/m.gridDpi)}}}class Pe{static async GetGridHexagon(e,t){if(!t.some(i=>i.x===e.x&&i.y===e.y)){const i=Pe.CreateHexagonPath(e),s=ra().commands(i).strokeOpacity(0).fillOpacity(.5).fillColor(m.sceneMetadata[`${d.EXTENSIONID}/toolColor`]??d.DEFAULTLINECOLOR).build();s.metadata[`${d.EXTENSIONID}/isBrushSquare`]=!0,s.layer="POINTER",t.push(e),await w.scene.local.addItems([s])}}static GetGridCoords(e){if(m.gridType==="HEX_HORIZONTAL"){const t=m.gridDpi*Math.sqrt(3)/2,n=Math.floor(e.x/t);return n%2?{x:n,y:Math.floor((e.y-m.gridDpi/2)/m.gridDpi)}:{x:n,y:Math.floor(e.y/m.gridDpi)}}else{const t=m.gridDpi*Math.sqrt(3)/2,n=Math.floor(e.y/t);return n%2?{x:Math.floor((e.x-m.gridDpi/2)/m.gridDpi),y:n}:{x:Math.floor(e.x/m.gridDpi),y:n}}}static CreateHexagonPath(e){const t=Pe.CalculateHexagonVertices(e),n=[[Ue.MOVE,t[0].x,t[0].y]];for(let i=1;i<t.length;i++)n.push([Ue.LINE,t[i].x,t[i].y]);return n.push([Ue.CLOSE]),n}static CalculateHexagonVertices(e){if(m.gridType==="HEX_HORIZONTAL"){let t=e;t.x%2&&(t={x:t.x,y:t.y+.5});const n=[],i=m.gridDpi*Math.sqrt(3)/2,s=m.gridDpi/1.7315,o={x:t.x*i+s,y:t.y*m.gridDpi+m.gridDpi/2},l=Math.PI*2/6;for(let c=0;c<6;c++){const f=l*c,g=o.x+s*Math.cos(f),v=o.y+s*Math.sin(f);n.push({x:g,y:v})}return n}else{let t=e;t.y%2&&(t={y:t.y,x:t.x+.5});const n=[],i=m.gridDpi*Math.sqrt(3)/2,s=m.gridDpi/1.7315,o={y:t.y*i+s,x:t.x*m.gridDpi+m.gridDpi/2},l=Math.PI*2/6;for(let c=0;c<6;c++){const f=l*c+Math.PI/6,g=o.x+s*Math.cos(f),v=o.y+s*Math.sin(f);n.push({x:g,y:v})}return n}}}class Re{static async GetGridIsometric(e,t){if(!t.some(i=>i.x===e.x&&i.y===e.y)){const i=Re.CreateIsometricPath(e),s=ra().commands(i).strokeOpacity(0).fillOpacity(.5).fillColor(m.sceneMetadata[`${d.EXTENSIONID}/toolColor`]??d.DEFAULTLINECOLOR).build();s.metadata[`${d.EXTENSIONID}/isBrushSquare`]=!0,s.layer="POINTER",t.push(e),await w.scene.local.addItems([s])}}static CreateIsometricPath(e){const t=Re.CalculateIsometricVertices(e),n=[[Ue.MOVE,t[0].x,t[0].y]];for(let i=1;i<t.length;i++)n.push([Ue.LINE,t[i].x,t[i].y]);return n.push([Ue.CLOSE]),n}static CalculateIsometricVertices(e){const t=m.gridDpi/2,n=m.gridType==="ISOMETRIC"?t/Math.tan(Math.PI/6):m.gridDpi,i=e.x*n,s=e.y*t;return[{x:i,y:s},{x:i-n,y:s+t},{x:i,y:s+t*2},{x:i+n,y:s+t}]}static GetGridCoords(e){const t=m.gridDpi/2,n=m.gridType==="ISOMETRIC"?t/Math.tan(Math.PI/6):m.gridDpi,i=e.x+Math.abs(Math.floor(e.x/n))*n,s=e.y+Math.abs(Math.floor(e.y/t))*t,o=Math.floor((e.x+n)/n),l=Math.floor(e.y/t),c=i%n,f=s%t,g=(o+l)%2,v=g?c*(t/n):-c*(t/n)+t;return f>v?g?{x:o-1,y:l}:{x:o,y:l}:g?{x:o,y:l-1}:{x:o-1,y:l-1}}}class fe{static async GenerateSmallLines(e){switch(m.gridType){case"SQUARE":await fe.GenerateSquareSmallLines(e);break;case"HEX_VERTICAL":await fe.GenerateHexagonSmallLines(e);break;case"HEX_HORIZONTAL":await fe.GenerateHexagonSmallLines(e);break;case"DIMETRIC":await fe.GenerateIsometricSmallLines(e);break;case"ISOMETRIC":await fe.GenerateIsometricSmallLines(e);break}}static async GenerateIsometricSmallLines(e){const t=[];for(const f of e){const g=Re.CalculateIsometricVertices(f);for(let v=0;v<g.length;v++){const S=g[v],O=v<g.length-1?g[v+1]:g[0];t.push({Start:S,End:O})}}const n=fe.RemoveCloseLines(t,2),i=fe.CombineContiguousDiagonalLines(n),s=fe.RemoveDuplicateLines(i),o=fe.GetLine(s),l=25,c=o.length;for(let f=0;f<c;f+=l){const g=o.slice(f,f+l);await w.scene.items.addItems(g)}}static async GenerateHexagonSmallLines(e){const t=[];for(const l of e){const c=Pe.CalculateHexagonVertices(l);for(let f=0;f<c.length;f++){const g=c[f],v=f<c.length-1?c[f+1]:c[0];t.push({Start:g,End:v})}}const n=fe.RemoveCloseLines(t,2),i=fe.GetLine(n),s=25,o=i.length;for(let l=0;l<o;l+=s){const c=i.slice(l,l+s);await w.scene.items.addItems(c)}}static async GenerateSquareSmallLines(e){const t=[];for(const c of e){const{x:f,y:g}=c,v={x:f*m.gridDpi,y:g*m.gridDpi},S={x:(f+1)*m.gridDpi,y:g*m.gridDpi},O={x:f*m.gridDpi,y:(g+1)*m.gridDpi},k={x:(f+1)*m.gridDpi,y:(g+1)*m.gridDpi};if(!e.some(L=>L.x===f&&L.y===g-1)){const L=v,R=S;t.push({Start:L,End:R})}if(!e.some(L=>L.x===f&&L.y===g+1)){const L=O,R=k;t.push({Start:L,End:R})}if(!e.some(L=>L.x===f-1&&L.y===g)){const L=v,R=O;t.push({Start:L,End:R})}if(!e.some(L=>L.x===f+1&&L.y===g)){const L=S,R=k;t.push({Start:L,End:R})}}const n=fe.CombineContiguousLines(t),i=fe.CombineOverlappingLines(n),s=fe.GetLine(i),o=25,l=s.length;for(let c=0;c<l;c+=o){const f=s.slice(c,c+o);await w.scene.items.addItems(f)}}static AreLinesIdentical(e,t,n){return Math.abs(e.Start.x-t.Start.x)<n&&Math.abs(e.Start.y-t.Start.y)<n&&Math.abs(e.End.x-t.End.x)<n&&Math.abs(e.End.y-t.End.y)<n||Math.abs(e.Start.x-t.End.x)<n&&Math.abs(e.Start.y-t.End.y)<n&&Math.abs(e.End.x-t.Start.x)<n&&Math.abs(e.End.y-t.Start.y)<n}static RemoveCloseLines(e,t){const n=new Set;for(let i=0;i<e.length;i++)if(!n.has(i))for(let s=i+1;s<e.length;s++)n.has(s)||fe.AreLinesIdentical(e[i],e[s],t)&&(n.add(i),n.add(s));return e.filter((i,s)=>!n.has(s))}static CombineOverlappingLines(e){let t=[],n=[],i=!1;for(const s of e){const o=s.Start.x===s.End.x?e.filter(f=>f.Start.x===f.End.x):e.filter(f=>f.Start.y===f.End.y),l=s.Start.x===s.End.x?o.filter(f=>f.Start.x===s.Start.x&&f.End.x===s.End.x):o.filter(f=>f.Start.y===s.Start.y&&f.End.y===s.End.y),c=s.Start.x!==s.End.x?l.find(f=>f.Start.x>s.Start.x&&f.Start.x<s.End.x):l.find(f=>f.Start.y>s.Start.y&&f.Start.y<s.End.y);if(c){const f=fe.MergePrecision(s,c);n.push(f),t.push(s),t.push(c),n=n.filter(g=>g!==s&&g!==c),i=!0}else t.includes(s)||n.push(s)}return i?fe.CombineOverlappingLines(n):n}static CombineContiguousDiagonalLines(e){let t=[],n=[],i=!1;for(const s of e){const o=e.find(l=>{if(s.Start.x===l.Start.x&&s.Start.y===l.Start.y&&s.End.x===l.End.x&&s.End.y===l.End.y||!(s.End.x===l.Start.x&&s.End.y===l.Start.y||s.End.x===l.End.x&&s.End.y===l.End.y||s.Start.x===l.Start.x&&s.Start.y===l.Start.y||s.Start.x===l.End.x&&s.Start.y===l.End.y))return!1;const f=(s.End.y-s.Start.y)/(s.End.x-s.Start.x),g=(l.End.y-l.Start.y)/(l.End.x-l.Start.x);return f===g});if(!t.includes(s))if(o&&!t.includes(o)){const l=fe.MergeLines(s,o);n.push(l),t.includes(s)||t.push(s),t.includes(o)||t.push(o),n=n.filter(c=>c!==s&&c!==o),i=!0}else t.includes(s)||n.push(s)}return i?fe.CombineContiguousDiagonalLines(n):n}static CombineContiguousLines(e){let t=[],n=[],i=!1;for(const s of e){const l=(s.Start.x===s.End.x?e.filter(c=>c.Start.x===c.End.x):e.filter(c=>c.Start.y===c.End.y)).find(c=>c.Start.x===s.End.x&&c.Start.y===s.End.y);if(l){const c=fe.MergeLines(s,l);n.push(c),t.includes(s)||t.push(s),t.includes(l)||t.push(l),n=n.filter(f=>f!==s&&f!==l),i=!0}else t.includes(s)||n.push(s)}return i?fe.CombineContiguousLines(n):n}static MergeLines(e,t){return e.End.x===t.End.x&&e.End.y===t.End.y?{Start:e.Start,End:t.Start}:e.Start.x===t.Start.x&&e.Start.y===t.Start.y?{Start:e.End,End:t.End}:e.Start.x===t.End.x&&e.Start.y===t.End.y?{Start:t.Start,End:e.End}:{Start:e.Start,End:t.End}}static RemoveDuplicateLines(e){const t=new Set;return e.filter(n=>{const i=n.Start.x<n.End.x||n.Start.x===n.End.x&&n.Start.y<n.End.y?n.Start:n.End,s=i===n.Start?n.End:n.Start,o=JSON.stringify({Start:i,End:s});return t.has(o)?!1:(t.add(o),!0)})}static MergePrecision(e,t){const n=Math.min(e.Start.x,t.Start.x),i=Math.min(e.Start.y,t.Start.y),s=Math.max(e.End.x,t.End.x),o=Math.max(e.End.y,t.End.y);return{Start:{x:n,y:i},End:{x:s,y:o}}}static GetLine(e){const t=[];for(const n of e){const i=Ne().tension(0).points([n.Start,n.End]).strokeColor(m.sceneMetadata[`${d.EXTENSIONID}/toolColor`]??d.DEFAULTLINECOLOR).strokeDash(m.sceneMetadata[`${d.EXTENSIONID}/toolStyle`]??d.DEFAULTLINESTROKE).strokeWidth(be()).fillOpacity(0).fillColor("#000000").layer(d.LINELAYER).name("Vision Line (Brushed)").closed(!1).locked(!0).build();i.visible=!1,i.metadata[`${d.EXTENSIONID}/isVisionLine`]=!0,i.metadata[`${d.EXTENSIONID}/blocking`]=!0,i.metadata[`${d.EXTENSIONID}/doubleSided`]=!0,t.push(i)}return t}}let xe=[];async function Hi(){xe=[];const a=await w.scene.local.getItems(Qr);await w.scene.local.deleteItems(a.map(e=>e.id)),await w.popover.close(d.BRUSHTOOLID)}async function nd(a,e){switch(m.gridType){case"SQUARE":await bn.GetGridSquare(bn.GetGridCoords(e.pointerPosition),xe);break;case"HEX_VERTICAL":await Pe.GetGridHexagon(Pe.GetGridCoords(e.pointerPosition),xe);break;case"HEX_HORIZONTAL":await Pe.GetGridHexagon(Pe.GetGridCoords(e.pointerPosition),xe);break;case"DIMETRIC":await Re.GetGridIsometric(Re.GetGridCoords(e.pointerPosition),xe);break;case"ISOMETRIC":await Re.GetGridIsometric(Re.GetGridCoords(e.pointerPosition),xe);break}}async function ad(){const a=await w.viewport.getWidth();await w.popover.open({id:d.BRUSHTOOLID,url:"/pages/brush.html",height:80,width:350,disableClickAway:!0,anchorPosition:{top:60,left:a/2},anchorReference:"POSITION",anchorOrigin:{vertical:"CENTER",horizontal:"CENTER"},transformOrigin:{vertical:"TOP",horizontal:"CENTER"}})}async function id(){await w.popover.close(d.BRUSHTOOLID)}async function rd(a,e){switch(m.gridType){case"SQUARE":await bn.GetGridSquare(bn.GetGridCoords(e.pointerPosition),xe);break;case"HEX_VERTICAL":await Pe.GetGridHexagon(Pe.GetGridCoords(e.pointerPosition),xe);break;case"HEX_HORIZONTAL":await Pe.GetGridHexagon(Pe.GetGridCoords(e.pointerPosition),xe);break;case"DIMETRIC":await Re.GetGridIsometric(Re.GetGridCoords(e.pointerPosition),xe);break;case"ISOMETRIC":await Re.GetGridIsometric(Re.GetGridCoords(e.pointerPosition),xe);break}}async function sd(a,e){await fe.GenerateSmallLines(xe),await Hi()}async function od(a,e){await Hi()}const kt={onActivate:ad,onDeactivate:id,onDragStart:nd,onDragMove:rd,onDragEnd:sd,onDragCancel:od};let Mt=[],Fi="",$t="",Dt=null,ln=!1,Bn=!1;async function Bi(){Mt=[],$t="",await w.scene.local.deleteItems([Fi])}async function dd(a){const e=a.position.x!==0&&a.position.y!==0,t=e?Ka(a.points,a.position,!0):a.points,n=_r(t,Mt[0],Mt[1],a.rotation,a.position),i=[],s=Ne().tension(0).points(n.extracted).strokeColor(Or(m.sceneMetadata[`${d.EXTENSIONID}/toolColor`]??d.DEFAULTLINECOLOR)).strokeDash(m.sceneMetadata[`${d.EXTENSIONID}/toolStyle`]??d.DEFAULTLINESTROKE).strokeWidth(be()).fillOpacity(0).fillColor("#000000").layer(d.LINELAYER).name("Vision Line (Line)").metadata({[`${d.EXTENSIONID}/isVisionLine`]:!0,[`${d.EXTENSIONID}/doubleSided`]:!0,[`${d.EXTENSIONID}/blocking`]:!0}).closed(!1).visible(!1).locked(!0).build();i.push(s);for(const o of n.remaining){const l=Ne().tension(0).position(a.position).strokeColor(m.sceneMetadata[`${d.EXTENSIONID}/toolColor`]??d.DEFAULTLINECOLOR).strokeDash(m.sceneMetadata[`${d.EXTENSIONID}/toolStyle`]??d.DEFAULTLINESTROKE).strokeWidth(be()).fillOpacity(0).rotation(a.rotation).fillColor("#000000").layer(d.LINELAYER).name("Vision Line (Line)").metadata({[`${d.EXTENSIONID}/isVisionLine`]:!0,[`${d.EXTENSIONID}/doubleSided`]:!0,[`${d.EXTENSIONID}/blocking`]:!0}).closed(!1).visible(!1).locked(!0).build();l.points=e?Ka(o,a.position,!1):o,i.push(l)}await w.scene.items.deleteItems([a.id]),await w.scene.items.addItems(i),Bi()}async function ld(a,e){if(!e.transformer&&!(!e.target||e.target.type!=="CURVE"||$t!==""&&$t!==e.target.id)){if($t=e.target.id,Mt.push(e.pointerPosition),Mt.length===1){const t=Ui();t.position=e.pointerPosition,Fi=t.id,await w.scene.local.addItems([t])}Mt.length===2&&dd(e.target)}}async function cd(a,e){if(e.target&&e.target.type==="CURVE"&&($t===""||$t===e.target.id)){if(!ln&&!Bn){Dt||(Bn=!0,Dt=await w.interaction.startItemInteraction(Ui()));const[t]=Dt;t(n=>{n.position=e.pointerPosition}),Bn=!1}}else if(Dt&&(!e.target||e.target&&e.target.type!=="CURVE")){const[t,n]=Dt;n(),Dt=null,ln||(setTimeout(()=>{ln=!1},50),ln=!0)}}function ud(a,e){e.key=="Escape"&&Bi()}function Ui(){const a=be();return pr().color("red").radius(a+4).disableHit(!0).build()}function Ka(a,e,t){return a.map(n=>({x:t?n.x+e.x:n.x-e.x,y:t?n.y+e.y:n.y-e.y}))}const Un={onToolClick:ld,onToolMove:cd,onKeyDown:ud};async function fd(){await w.tool.create({id:`${d.EXTENSIONID}/vision-tool`,icons:[{icon:"/icon.svg",label:"Setup Vision"}],defaultMetadata:{[`${d.EXTENSIONID}/elevationEditor`]:!1},async onClick(){await w.tool.activateTool(`${d.EXTENSIONID}/vision-tool`),m.toolStarted||(m.toolStarted=!0,await w.tool.setMetadata(`${d.EXTENSIONID}/vision-tool`,{[`${d.EXTENSIONID}/elevationEditor`]:!1}))}}),await w.tool.createMode({id:`${d.EXTENSIONID}/add-vision-line-mode`,icons:[{icon:"/line.svg",label:"Add Obstruction Line",filter:{activeTools:[`${d.EXTENSIONID}/vision-tool`]}}],onToolDown:nn.onToolClick,onToolMove:nn.onToolMove,onToolDoubleClick:nn.onToolDouble,onKeyDown:nn.onKeyDown,preventDrag:{dragging:!1}}),await w.tool.createMode({id:`${d.EXTENSIONID}/add-vision-polygon-mode`,icons:[{icon:"/object.svg",label:"Add Obstruction Object",filter:{activeTools:[`${d.EXTENSIONID}/vision-tool`]}}],onToolDown:an.onToolClick,onToolMove:an.onToolMove,onToolDoubleClick:an.onToolDouble,onKeyDown:an.onKeyDown,preventDrag:{dragging:!1}}),await w.tool.createMode({id:`${d.EXTENSIONID}/add-vision-brush-mode`,icons:[{icon:"/brush.svg",label:"Paint Obstructions by Grid",filter:{activeTools:[`${d.EXTENSIONID}/vision-tool`]}}],onToolDown:kt.onActivate,onToolUp:kt.onDeactivate,onToolDragStart:kt.onDragStart,onToolDragMove:kt.onDragMove,onToolDragEnd:kt.onDragEnd,onToolDragCancel:kt.onDragCancel}),await w.tool.createMode({id:`${d.EXTENSIONID}/add-line-cutter-mode`,icons:[{icon:"/cutter.svg",label:"Trim Line",filter:{activeTools:[`${d.EXTENSIONID}/vision-tool`]}}],onToolDown:Un.onToolClick,onToolMove:Un.onToolMove,onKeyDown:Un.onKeyDown,preventDrag:{dragging:!1},cursors:[{cursor:"crosshair"}]}),await w.tool.createMode({id:`${d.EXTENSIONID}/enter-elevation-mode-1`,icons:[{icon:"/mountain1.svg",label:"Create Map Elevation Layer-1",filter:{activeTools:[`${d.EXTENSIONID}/vision-tool`]}}],disabled:{metadata:[{key:[`${d.EXTENSIONID}/elevationEditor`],value:!1}]},onToolDown:(a,e)=>{Ee.onToolClick(a,e,1)},onToolMove:Ee.onToolMove,onKeyDown:(a,e)=>{Ee.onKeyDown(a,e,1)},preventDrag:{dragging:!0}}),await w.tool.createMode({id:`${d.EXTENSIONID}/enter-elevation-mode-2`,icons:[{icon:"/mountain2.svg",label:"Create Map Elevation Layer-2",filter:{activeTools:[`${d.EXTENSIONID}/vision-tool`]}}],disabled:{metadata:[{key:[`${d.EXTENSIONID}/elevationEditor`],value:!1}]},onToolDown:(a,e)=>{Ee.onToolClick(a,e,2)},onToolMove:Ee.onToolMove,onKeyDown:(a,e)=>{Ee.onKeyDown(a,e,2)},preventDrag:{dragging:!0}}),await w.tool.createMode({id:`${d.EXTENSIONID}/enter-elevation-mode-3`,icons:[{icon:"/mountain3.svg",label:"Create Map Elevation Layer-3",filter:{activeTools:[`${d.EXTENSIONID}/vision-tool`]}}],disabled:{metadata:[{key:[`${d.EXTENSIONID}/elevationEditor`],value:!1}]},onToolDown:(a,e)=>{Ee.onToolClick(a,e,3)},onToolMove:Ee.onToolMove,onKeyDown:(a,e)=>{Ee.onKeyDown(a,e,3)},preventDrag:{dragging:!0}}),await w.tool.createMode({id:`${d.EXTENSIONID}/enter-elevation-mode-4`,icons:[{icon:"/mountain4.svg",label:"Create Map Elevation Layer-4",filter:{activeTools:[`${d.EXTENSIONID}/vision-tool`]}}],disabled:{metadata:[{key:[`${d.EXTENSIONID}/elevationEditor`],value:!1}]},onToolDown:(a,e)=>{Ee.onToolClick(a,e,4)},onToolMove:Ee.onToolMove,onKeyDown:(a,e)=>{Ee.onKeyDown(a,e,4)},preventDrag:{dragging:!0}}),await w.tool.createMode({id:`${d.EXTENSIONID}/enter-elevation-mode-5`,icons:[{icon:"/mountain5.svg",label:"Create Map Elevation Layer-5",filter:{activeTools:[`${d.EXTENSIONID}/vision-tool`]}}],disabled:{metadata:[{key:[`${d.EXTENSIONID}/elevationEditor`],value:!1}]},onToolDown:(a,e)=>{Ee.onToolClick(a,e,5)},onToolMove:Ee.onToolMove,onKeyDown:(a,e)=>{Ee.onKeyDown(a,e,5)},preventDrag:{dragging:!0}}),await w.tool.createMode({id:`${d.EXTENSIONID}/enter-elevation-mode-select`,icons:[{icon:"/mountain-select.svg",label:"Selector",filter:{activeTools:[`${d.EXTENSIONID}/vision-tool`]}}],disabled:{metadata:[{key:[`${d.EXTENSIONID}/elevationEditor`],value:!1}]},onToolDown:(a,e)=>!0,preventDrag:{dragging:!0}}),await w.tool.createAction({id:`${d.EXTENSIONID}/enter-elevation-mode`,icons:[{icon:"/eyeclosed.svg",label:"Activate Elevation Editor",filter:{activeTools:[`${d.EXTENSIONID}/vision-tool`],metadata:[{key:[`${d.EXTENSIONID}/elevationEditor`],value:!0,operator:"!="}]}},{icon:"/eyeopen.svg",label:"De-Activate Elevation Editor",filter:{activeTools:[`${d.EXTENSIONID}/vision-tool`],metadata:[{key:[`${d.EXTENSIONID}/elevationEditor`],value:!0,operator:"=="}]}}],onClick:Ee.enterEditMode})}var De="top",Ve="bottom",He="right",Ce="left",da="auto",Qt=[De,Ve,He,Ce],At="start",qt="end",pd="clippingParents",zi="viewport",Bt="popper",hd="reference",Qa=Qt.reduce(function(a,e){return a.concat([e+"-"+At,e+"-"+qt])},[]),ji=[].concat(Qt,[da]).reduce(function(a,e){return a.concat([e,e+"-"+At,e+"-"+qt])},[]),gd="beforeRead",md="read",vd="afterRead",yd="beforeMain",Ed="main",Id="afterMain",wd="beforeWrite",bd="write",Td="afterWrite",Sd=[gd,md,vd,yd,Ed,Id,wd,bd,Td];function et(a){return a?(a.nodeName||"").toLowerCase():null}function Ae(a){if(a==null)return window;if(a.toString()!=="[object Window]"){var e=a.ownerDocument;return e&&e.defaultView||window}return a}function It(a){var e=Ae(a).Element;return a instanceof e||a instanceof Element}function Xe(a){var e=Ae(a).HTMLElement;return a instanceof e||a instanceof HTMLElement}function la(a){if(typeof ShadowRoot>"u")return!1;var e=Ae(a).ShadowRoot;return a instanceof e||a instanceof ShadowRoot}function Nd(a){var e=a.state;Object.keys(e.elements).forEach(function(t){var n=e.styles[t]||{},i=e.attributes[t]||{},s=e.elements[t];!Xe(s)||!et(s)||(Object.assign(s.style,n),Object.keys(i).forEach(function(o){var l=i[o];l===!1?s.removeAttribute(o):s.setAttribute(o,l===!0?"":l)}))})}function Od(a){var e=a.state,t={popper:{position:e.options.strategy,left:"0",top:"0",margin:"0"},arrow:{position:"absolute"},reference:{}};return Object.assign(e.elements.popper.style,t.popper),e.styles=t,e.elements.arrow&&Object.assign(e.elements.arrow.style,t.arrow),function(){Object.keys(e.elements).forEach(function(n){var i=e.elements[n],s=e.attributes[n]||{},o=Object.keys(e.styles.hasOwnProperty(n)?e.styles[n]:t[n]),l=o.reduce(function(c,f){return c[f]="",c},{});!Xe(i)||!et(i)||(Object.assign(i.style,l),Object.keys(s).forEach(function(c){i.removeAttribute(c)}))})}}const Gi={name:"applyStyles",enabled:!0,phase:"write",fn:Nd,effect:Od,requires:["computeStyles"]};function Je(a){return a.split("-")[0]}var Et=Math.max,Tn=Math.min,xt=Math.round;function ta(){var a=navigator.userAgentData;return a!=null&&a.brands&&Array.isArray(a.brands)?a.brands.map(function(e){return e.brand+"/"+e.version}).join(" "):navigator.userAgent}function Wi(){return!/^((?!chrome|android).)*safari/i.test(ta())}function Pt(a,e,t){e===void 0&&(e=!1),t===void 0&&(t=!1);var n=a.getBoundingClientRect(),i=1,s=1;e&&Xe(a)&&(i=a.offsetWidth>0&&xt(n.width)/a.offsetWidth||1,s=a.offsetHeight>0&&xt(n.height)/a.offsetHeight||1);var o=It(a)?Ae(a):window,l=o.visualViewport,c=!Wi()&&t,f=(n.left+(c&&l?l.offsetLeft:0))/i,g=(n.top+(c&&l?l.offsetTop:0))/s,v=n.width/i,S=n.height/s;return{width:v,height:S,top:g,right:f+v,bottom:g+S,left:f,x:f,y:g}}function ca(a){var e=Pt(a),t=a.offsetWidth,n=a.offsetHeight;return Math.abs(e.width-t)<=1&&(t=e.width),Math.abs(e.height-n)<=1&&(n=e.height),{x:a.offsetLeft,y:a.offsetTop,width:t,height:n}}function Yi(a,e){var t=e.getRootNode&&e.getRootNode();if(a.contains(e))return!0;if(t&&la(t)){var n=e;do{if(n&&a.isSameNode(n))return!0;n=n.parentNode||n.host}while(n)}return!1}function it(a){return Ae(a).getComputedStyle(a)}function _d(a){return["table","td","th"].indexOf(et(a))>=0}function ut(a){return((It(a)?a.ownerDocument:a.document)||window.document).documentElement}function On(a){return et(a)==="html"?a:a.assignedSlot||a.parentNode||(la(a)?a.host:null)||ut(a)}function Za(a){return!Xe(a)||it(a).position==="fixed"?null:a.offsetParent}function kd(a){var e=/firefox/i.test(ta()),t=/Trident/i.test(ta());if(t&&Xe(a)){var n=it(a);if(n.position==="fixed")return null}var i=On(a);for(la(i)&&(i=i.host);Xe(i)&&["html","body"].indexOf(et(i))<0;){var s=it(i);if(s.transform!=="none"||s.perspective!=="none"||s.contain==="paint"||["transform","perspective"].indexOf(s.willChange)!==-1||e&&s.willChange==="filter"||e&&s.filter&&s.filter!=="none")return i;i=i.parentNode}return null}function Zt(a){for(var e=Ae(a),t=Za(a);t&&_d(t)&&it(t).position==="static";)t=Za(t);return t&&(et(t)==="html"||et(t)==="body"&&it(t).position==="static")?e:t||kd(a)||e}function ua(a){return["top","bottom"].indexOf(a)>=0?"x":"y"}function jt(a,e,t){return Et(a,Tn(e,t))}function Dd(a,e,t){var n=jt(a,e,t);return n>t?t:n}function qi(){return{top:0,right:0,bottom:0,left:0}}function Ki(a){return Object.assign({},qi(),a)}function Qi(a,e){return e.reduce(function(t,n){return t[n]=a,t},{})}var Cd=function(e,t){return e=typeof e=="function"?e(Object.assign({},t.rects,{placement:t.placement})):e,Ki(typeof e!="number"?e:Qi(e,Qt))};function Ld(a){var e,t=a.state,n=a.name,i=a.options,s=t.elements.arrow,o=t.modifiersData.popperOffsets,l=Je(t.placement),c=ua(l),f=[Ce,He].indexOf(l)>=0,g=f?"height":"width";if(!(!s||!o)){var v=Cd(i.padding,t),S=ca(s),O=c==="y"?De:Ce,k=c==="y"?Ve:He,L=t.rects.reference[g]+t.rects.reference[c]-o[c]-t.rects.popper[g],R=o[c]-t.rects.reference[c],F=Zt(s),M=F?c==="y"?F.clientHeight||0:F.clientWidth||0:0,z=L/2-R/2,r=v[O],p=M-S[g]-v[k],u=M/2-S[g]/2+z,h=jt(r,u,p),T=c;t.modifiersData[n]=(e={},e[T]=h,e.centerOffset=h-u,e)}}function Md(a){var e=a.state,t=a.options,n=t.element,i=n===void 0?"[data-popper-arrow]":n;i!=null&&(typeof i=="string"&&(i=e.elements.popper.querySelector(i),!i)||Yi(e.elements.popper,i)&&(e.elements.arrow=i))}const $d={name:"arrow",enabled:!0,phase:"main",fn:Ld,effect:Md,requires:["popperOffsets"],requiresIfExists:["preventOverflow"]};function Rt(a){return a.split("-")[1]}var Ad={top:"auto",right:"auto",bottom:"auto",left:"auto"};function xd(a,e){var t=a.x,n=a.y,i=e.devicePixelRatio||1;return{x:xt(t*i)/i||0,y:xt(n*i)/i||0}}function Ja(a){var e,t=a.popper,n=a.popperRect,i=a.placement,s=a.variation,o=a.offsets,l=a.position,c=a.gpuAcceleration,f=a.adaptive,g=a.roundOffsets,v=a.isFixed,S=o.x,O=S===void 0?0:S,k=o.y,L=k===void 0?0:k,R=typeof g=="function"?g({x:O,y:L}):{x:O,y:L};O=R.x,L=R.y;var F=o.hasOwnProperty("x"),M=o.hasOwnProperty("y"),z=Ce,r=De,p=window;if(f){var u=Zt(t),h="clientHeight",T="clientWidth";if(u===Ae(t)&&(u=ut(t),it(u).position!=="static"&&l==="absolute"&&(h="scrollHeight",T="scrollWidth")),u=u,i===De||(i===Ce||i===He)&&s===qt){r=Ve;var y=v&&u===p&&p.visualViewport?p.visualViewport.height:u[h];L-=y-n.height,L*=c?1:-1}if(i===Ce||(i===De||i===Ve)&&s===qt){z=He;var E=v&&u===p&&p.visualViewport?p.visualViewport.width:u[T];O-=E-n.width,O*=c?1:-1}}var I=Object.assign({position:l},f&&Ad),C=g===!0?xd({x:O,y:L},Ae(t)):{x:O,y:L};if(O=C.x,L=C.y,c){var D;return Object.assign({},I,(D={},D[r]=M?"0":"",D[z]=F?"0":"",D.transform=(p.devicePixelRatio||1)<=1?"translate("+O+"px, "+L+"px)":"translate3d("+O+"px, "+L+"px, 0)",D))}return Object.assign({},I,(e={},e[r]=M?L+"px":"",e[z]=F?O+"px":"",e.transform="",e))}function Pd(a){var e=a.state,t=a.options,n=t.gpuAcceleration,i=n===void 0?!0:n,s=t.adaptive,o=s===void 0?!0:s,l=t.roundOffsets,c=l===void 0?!0:l,f={placement:Je(e.placement),variation:Rt(e.placement),popper:e.elements.popper,popperRect:e.rects.popper,gpuAcceleration:i,isFixed:e.options.strategy==="fixed"};e.modifiersData.popperOffsets!=null&&(e.styles.popper=Object.assign({},e.styles.popper,Ja(Object.assign({},f,{offsets:e.modifiersData.popperOffsets,position:e.options.strategy,adaptive:o,roundOffsets:c})))),e.modifiersData.arrow!=null&&(e.styles.arrow=Object.assign({},e.styles.arrow,Ja(Object.assign({},f,{offsets:e.modifiersData.arrow,position:"absolute",adaptive:!1,roundOffsets:c})))),e.attributes.popper=Object.assign({},e.attributes.popper,{"data-popper-placement":e.placement})}const Rd={name:"computeStyles",enabled:!0,phase:"beforeWrite",fn:Pd,data:{}};var cn={passive:!0};function Xd(a){var e=a.state,t=a.instance,n=a.options,i=n.scroll,s=i===void 0?!0:i,o=n.resize,l=o===void 0?!0:o,c=Ae(e.elements.popper),f=[].concat(e.scrollParents.reference,e.scrollParents.popper);return s&&f.forEach(function(g){g.addEventListener("scroll",t.update,cn)}),l&&c.addEventListener("resize",t.update,cn),function(){s&&f.forEach(function(g){g.removeEventListener("scroll",t.update,cn)}),l&&c.removeEventListener("resize",t.update,cn)}}const Vd={name:"eventListeners",enabled:!0,phase:"write",fn:function(){},effect:Xd,data:{}};var Hd={left:"right",right:"left",bottom:"top",top:"bottom"};function pn(a){return a.replace(/left|right|bottom|top/g,function(e){return Hd[e]})}var Fd={start:"end",end:"start"};function ei(a){return a.replace(/start|end/g,function(e){return Fd[e]})}function fa(a){var e=Ae(a),t=e.pageXOffset,n=e.pageYOffset;return{scrollLeft:t,scrollTop:n}}function pa(a){return Pt(ut(a)).left+fa(a).scrollLeft}function Bd(a,e){var t=Ae(a),n=ut(a),i=t.visualViewport,s=n.clientWidth,o=n.clientHeight,l=0,c=0;if(i){s=i.width,o=i.height;var f=Wi();(f||!f&&e==="fixed")&&(l=i.offsetLeft,c=i.offsetTop)}return{width:s,height:o,x:l+pa(a),y:c}}function Ud(a){var e,t=ut(a),n=fa(a),i=(e=a.ownerDocument)==null?void 0:e.body,s=Et(t.scrollWidth,t.clientWidth,i?i.scrollWidth:0,i?i.clientWidth:0),o=Et(t.scrollHeight,t.clientHeight,i?i.scrollHeight:0,i?i.clientHeight:0),l=-n.scrollLeft+pa(a),c=-n.scrollTop;return it(i||t).direction==="rtl"&&(l+=Et(t.clientWidth,i?i.clientWidth:0)-s),{width:s,height:o,x:l,y:c}}function ha(a){var e=it(a),t=e.overflow,n=e.overflowX,i=e.overflowY;return/auto|scroll|overlay|hidden/.test(t+i+n)}function Zi(a){return["html","body","#document"].indexOf(et(a))>=0?a.ownerDocument.body:Xe(a)&&ha(a)?a:Zi(On(a))}function Gt(a,e){var t;e===void 0&&(e=[]);var n=Zi(a),i=n===((t=a.ownerDocument)==null?void 0:t.body),s=Ae(n),o=i?[s].concat(s.visualViewport||[],ha(n)?n:[]):n,l=e.concat(o);return i?l:l.concat(Gt(On(o)))}function na(a){return Object.assign({},a,{left:a.x,top:a.y,right:a.x+a.width,bottom:a.y+a.height})}function zd(a,e){var t=Pt(a,!1,e==="fixed");return t.top=t.top+a.clientTop,t.left=t.left+a.clientLeft,t.bottom=t.top+a.clientHeight,t.right=t.left+a.clientWidth,t.width=a.clientWidth,t.height=a.clientHeight,t.x=t.left,t.y=t.top,t}function ti(a,e,t){return e===zi?na(Bd(a,t)):It(e)?zd(e,t):na(Ud(ut(a)))}function jd(a){var e=Gt(On(a)),t=["absolute","fixed"].indexOf(it(a).position)>=0,n=t&&Xe(a)?Zt(a):a;return It(n)?e.filter(function(i){return It(i)&&Yi(i,n)&&et(i)!=="body"}):[]}function Gd(a,e,t,n){var i=e==="clippingParents"?jd(a):[].concat(e),s=[].concat(i,[t]),o=s[0],l=s.reduce(function(c,f){var g=ti(a,f,n);return c.top=Et(g.top,c.top),c.right=Tn(g.right,c.right),c.bottom=Tn(g.bottom,c.bottom),c.left=Et(g.left,c.left),c},ti(a,o,n));return l.width=l.right-l.left,l.height=l.bottom-l.top,l.x=l.left,l.y=l.top,l}function Ji(a){var e=a.reference,t=a.element,n=a.placement,i=n?Je(n):null,s=n?Rt(n):null,o=e.x+e.width/2-t.width/2,l=e.y+e.height/2-t.height/2,c;switch(i){case De:c={x:o,y:e.y-t.height};break;case Ve:c={x:o,y:e.y+e.height};break;case He:c={x:e.x+e.width,y:l};break;case Ce:c={x:e.x-t.width,y:l};break;default:c={x:e.x,y:e.y}}var f=i?ua(i):null;if(f!=null){var g=f==="y"?"height":"width";switch(s){case At:c[f]=c[f]-(e[g]/2-t[g]/2);break;case qt:c[f]=c[f]+(e[g]/2-t[g]/2);break}}return c}function Kt(a,e){e===void 0&&(e={});var t=e,n=t.placement,i=n===void 0?a.placement:n,s=t.strategy,o=s===void 0?a.strategy:s,l=t.boundary,c=l===void 0?pd:l,f=t.rootBoundary,g=f===void 0?zi:f,v=t.elementContext,S=v===void 0?Bt:v,O=t.altBoundary,k=O===void 0?!1:O,L=t.padding,R=L===void 0?0:L,F=Ki(typeof R!="number"?R:Qi(R,Qt)),M=S===Bt?hd:Bt,z=a.rects.popper,r=a.elements[k?M:S],p=Gd(It(r)?r:r.contextElement||ut(a.elements.popper),c,g,o),u=Pt(a.elements.reference),h=Ji({reference:u,element:z,strategy:"absolute",placement:i}),T=na(Object.assign({},z,h)),y=S===Bt?T:u,E={top:p.top-y.top+F.top,bottom:y.bottom-p.bottom+F.bottom,left:p.left-y.left+F.left,right:y.right-p.right+F.right},I=a.modifiersData.offset;if(S===Bt&&I){var C=I[i];Object.keys(E).forEach(function(D){var A=[He,Ve].indexOf(D)>=0?1:-1,P=[De,Ve].indexOf(D)>=0?"y":"x";E[D]+=C[P]*A})}return E}function Wd(a,e){e===void 0&&(e={});var t=e,n=t.placement,i=t.boundary,s=t.rootBoundary,o=t.padding,l=t.flipVariations,c=t.allowedAutoPlacements,f=c===void 0?ji:c,g=Rt(n),v=g?l?Qa:Qa.filter(function(k){return Rt(k)===g}):Qt,S=v.filter(function(k){return f.indexOf(k)>=0});S.length===0&&(S=v);var O=S.reduce(function(k,L){return k[L]=Kt(a,{placement:L,boundary:i,rootBoundary:s,padding:o})[Je(L)],k},{});return Object.keys(O).sort(function(k,L){return O[k]-O[L]})}function Yd(a){if(Je(a)===da)return[];var e=pn(a);return[ei(a),e,ei(e)]}function qd(a){var e=a.state,t=a.options,n=a.name;if(!e.modifiersData[n]._skip){for(var i=t.mainAxis,s=i===void 0?!0:i,o=t.altAxis,l=o===void 0?!0:o,c=t.fallbackPlacements,f=t.padding,g=t.boundary,v=t.rootBoundary,S=t.altBoundary,O=t.flipVariations,k=O===void 0?!0:O,L=t.allowedAutoPlacements,R=e.options.placement,F=Je(R),M=F===R,z=c||(M||!k?[pn(R)]:Yd(R)),r=[R].concat(z).reduce(function(oe,ae){return oe.concat(Je(ae)===da?Wd(e,{placement:ae,boundary:g,rootBoundary:v,padding:f,flipVariations:k,allowedAutoPlacements:L}):ae)},[]),p=e.rects.reference,u=e.rects.popper,h=new Map,T=!0,y=r[0],E=0;E<r.length;E++){var I=r[E],C=Je(I),D=Rt(I)===At,A=[De,Ve].indexOf(C)>=0,P=A?"width":"height",b=Kt(e,{placement:I,boundary:g,rootBoundary:v,altBoundary:S,padding:f}),x=A?D?He:Ce:D?Ve:De;p[P]>u[P]&&(x=pn(x));var U=pn(x),G=[];if(s&&G.push(b[C]<=0),l&&G.push(b[x]<=0,b[U]<=0),G.every(function(oe){return oe})){y=I,T=!1;break}h.set(I,G)}if(T)for(var Q=k?3:1,W=function(ae){var ee=r.find(function($){var X=h.get($);if(X)return X.slice(0,ae).every(function(j){return j})});if(ee)return y=ee,"break"},J=Q;J>0;J--){var re=W(J);if(re==="break")break}e.placement!==y&&(e.modifiersData[n]._skip=!0,e.placement=y,e.reset=!0)}}const Kd={name:"flip",enabled:!0,phase:"main",fn:qd,requiresIfExists:["offset"],data:{_skip:!1}};function ni(a,e,t){return t===void 0&&(t={x:0,y:0}),{top:a.top-e.height-t.y,right:a.right-e.width+t.x,bottom:a.bottom-e.height+t.y,left:a.left-e.width-t.x}}function ai(a){return[De,He,Ve,Ce].some(function(e){return a[e]>=0})}function Qd(a){var e=a.state,t=a.name,n=e.rects.reference,i=e.rects.popper,s=e.modifiersData.preventOverflow,o=Kt(e,{elementContext:"reference"}),l=Kt(e,{altBoundary:!0}),c=ni(o,n),f=ni(l,i,s),g=ai(c),v=ai(f);e.modifiersData[t]={referenceClippingOffsets:c,popperEscapeOffsets:f,isReferenceHidden:g,hasPopperEscaped:v},e.attributes.popper=Object.assign({},e.attributes.popper,{"data-popper-reference-hidden":g,"data-popper-escaped":v})}const Zd={name:"hide",enabled:!0,phase:"main",requiresIfExists:["preventOverflow"],fn:Qd};function Jd(a,e,t){var n=Je(a),i=[Ce,De].indexOf(n)>=0?-1:1,s=typeof t=="function"?t(Object.assign({},e,{placement:a})):t,o=s[0],l=s[1];return o=o||0,l=(l||0)*i,[Ce,He].indexOf(n)>=0?{x:l,y:o}:{x:o,y:l}}function el(a){var e=a.state,t=a.options,n=a.name,i=t.offset,s=i===void 0?[0,0]:i,o=ji.reduce(function(g,v){return g[v]=Jd(v,e.rects,s),g},{}),l=o[e.placement],c=l.x,f=l.y;e.modifiersData.popperOffsets!=null&&(e.modifiersData.popperOffsets.x+=c,e.modifiersData.popperOffsets.y+=f),e.modifiersData[n]=o}const tl={name:"offset",enabled:!0,phase:"main",requires:["popperOffsets"],fn:el};function nl(a){var e=a.state,t=a.name;e.modifiersData[t]=Ji({reference:e.rects.reference,element:e.rects.popper,strategy:"absolute",placement:e.placement})}const al={name:"popperOffsets",enabled:!0,phase:"read",fn:nl,data:{}};function il(a){return a==="x"?"y":"x"}function rl(a){var e=a.state,t=a.options,n=a.name,i=t.mainAxis,s=i===void 0?!0:i,o=t.altAxis,l=o===void 0?!1:o,c=t.boundary,f=t.rootBoundary,g=t.altBoundary,v=t.padding,S=t.tether,O=S===void 0?!0:S,k=t.tetherOffset,L=k===void 0?0:k,R=Kt(e,{boundary:c,rootBoundary:f,padding:v,altBoundary:g}),F=Je(e.placement),M=Rt(e.placement),z=!M,r=ua(F),p=il(r),u=e.modifiersData.popperOffsets,h=e.rects.reference,T=e.rects.popper,y=typeof L=="function"?L(Object.assign({},e.rects,{placement:e.placement})):L,E=typeof y=="number"?{mainAxis:y,altAxis:y}:Object.assign({mainAxis:0,altAxis:0},y),I=e.modifiersData.offset?e.modifiersData.offset[e.placement]:null,C={x:0,y:0};if(u){if(s){var D,A=r==="y"?De:Ce,P=r==="y"?Ve:He,b=r==="y"?"height":"width",x=u[r],U=x+R[A],G=x-R[P],Q=O?-T[b]/2:0,W=M===At?h[b]:T[b],J=M===At?-T[b]:-h[b],re=e.elements.arrow,oe=O&&re?ca(re):{width:0,height:0},ae=e.modifiersData["arrow#persistent"]?e.modifiersData["arrow#persistent"].padding:qi(),ee=ae[A],$=ae[P],X=jt(0,h[b],oe[b]),j=z?h[b]/2-Q-X-ee-E.mainAxis:W-X-ee-E.mainAxis,se=z?-h[b]/2+Q+X+$+E.mainAxis:J+X+$+E.mainAxis,ie=e.elements.arrow&&Zt(e.elements.arrow),ce=ie?r==="y"?ie.clientTop||0:ie.clientLeft||0:0,ye=(D=I?.[r])!=null?D:0,rt=x+j-ye-ce,wt=x+se-ye,ft=jt(O?Tn(U,rt):U,x,O?Et(G,wt):G);u[r]=ft,C[r]=ft-x}if(l){var pt,bt=r==="x"?De:Ce,Tt=r==="x"?Ve:He,Fe=u[p],We=p==="y"?"height":"width",ht=Fe+R[bt],tt=Fe-R[Tt],st=[De,Ce].indexOf(F)!==-1,ge=(pt=I?.[p])!=null?pt:0,de=st?ht:Fe-h[We]-T[We]-ge+E.altAxis,nt=st?Fe+h[We]+T[We]-ge-E.altAxis:tt,St=O&&st?Dd(de,Fe,nt):jt(O?de:ht,Fe,O?nt:tt);u[p]=St,C[p]=St-Fe}e.modifiersData[n]=C}}const sl={name:"preventOverflow",enabled:!0,phase:"main",fn:rl,requiresIfExists:["offset"]};function ol(a){return{scrollLeft:a.scrollLeft,scrollTop:a.scrollTop}}function dl(a){return a===Ae(a)||!Xe(a)?fa(a):ol(a)}function ll(a){var e=a.getBoundingClientRect(),t=xt(e.width)/a.offsetWidth||1,n=xt(e.height)/a.offsetHeight||1;return t!==1||n!==1}function cl(a,e,t){t===void 0&&(t=!1);var n=Xe(e),i=Xe(e)&&ll(e),s=ut(e),o=Pt(a,i,t),l={scrollLeft:0,scrollTop:0},c={x:0,y:0};return(n||!n&&!t)&&((et(e)!=="body"||ha(s))&&(l=dl(e)),Xe(e)?(c=Pt(e,!0),c.x+=e.clientLeft,c.y+=e.clientTop):s&&(c.x=pa(s))),{x:o.left+l.scrollLeft-c.x,y:o.top+l.scrollTop-c.y,width:o.width,height:o.height}}function ul(a){var e=new Map,t=new Set,n=[];a.forEach(function(s){e.set(s.name,s)});function i(s){t.add(s.name);var o=[].concat(s.requires||[],s.requiresIfExists||[]);o.forEach(function(l){if(!t.has(l)){var c=e.get(l);c&&i(c)}}),n.push(s)}return a.forEach(function(s){t.has(s.name)||i(s)}),n}function fl(a){var e=ul(a);return Sd.reduce(function(t,n){return t.concat(e.filter(function(i){return i.phase===n}))},[])}function pl(a){var e;return function(){return e||(e=new Promise(function(t){Promise.resolve().then(function(){e=void 0,t(a())})})),e}}function hl(a){var e=a.reduce(function(t,n){var i=t[n.name];return t[n.name]=i?Object.assign({},i,n,{options:Object.assign({},i.options,n.options),data:Object.assign({},i.data,n.data)}):n,t},{});return Object.keys(e).map(function(t){return e[t]})}var ii={placement:"bottom",modifiers:[],strategy:"absolute"};function ri(){for(var a=arguments.length,e=new Array(a),t=0;t<a;t++)e[t]=arguments[t];return!e.some(function(n){return!(n&&typeof n.getBoundingClientRect=="function")})}function gl(a){a===void 0&&(a={});var e=a,t=e.defaultModifiers,n=t===void 0?[]:t,i=e.defaultOptions,s=i===void 0?ii:i;return function(l,c,f){f===void 0&&(f=s);var g={placement:"bottom",orderedModifiers:[],options:Object.assign({},ii,s),modifiersData:{},elements:{reference:l,popper:c},attributes:{},styles:{}},v=[],S=!1,O={state:g,setOptions:function(F){var M=typeof F=="function"?F(g.options):F;L(),g.options=Object.assign({},s,g.options,M),g.scrollParents={reference:It(l)?Gt(l):l.contextElement?Gt(l.contextElement):[],popper:Gt(c)};var z=fl(hl([].concat(n,g.options.modifiers)));return g.orderedModifiers=z.filter(function(r){return r.enabled}),k(),O.update()},forceUpdate:function(){if(!S){var F=g.elements,M=F.reference,z=F.popper;if(ri(M,z)){g.rects={reference:cl(M,Zt(z),g.options.strategy==="fixed"),popper:ca(z)},g.reset=!1,g.placement=g.options.placement,g.orderedModifiers.forEach(function(E){return g.modifiersData[E.name]=Object.assign({},E.data)});for(var r=0;r<g.orderedModifiers.length;r++){if(g.reset===!0){g.reset=!1,r=-1;continue}var p=g.orderedModifiers[r],u=p.fn,h=p.options,T=h===void 0?{}:h,y=p.name;typeof u=="function"&&(g=u({state:g,options:T,name:y,instance:O})||g)}}}},update:pl(function(){return new Promise(function(R){O.forceUpdate(),R(g)})}),destroy:function(){L(),S=!0}};if(!ri(l,c))return O;O.setOptions(f).then(function(R){!S&&f.onFirstUpdate&&f.onFirstUpdate(R)});function k(){g.orderedModifiers.forEach(function(R){var F=R.name,M=R.options,z=M===void 0?{}:M,r=R.effect;if(typeof r=="function"){var p=r({state:g,name:F,instance:O,options:z}),u=function(){};v.push(p||u)}})}function L(){v.forEach(function(R){return R()}),v=[]}return O}}var ml=[Vd,al,Rd,Gi,tl,Kd,sl,$d,Zd],vl=gl({defaultModifiers:ml}),yl="tippy-box",er="tippy-content",El="tippy-backdrop",tr="tippy-arrow",nr="tippy-svg-arrow",yt={passive:!0,capture:!0},ar=function(){return document.body};function zn(a,e,t){if(Array.isArray(a)){var n=a[e];return n??(Array.isArray(t)?t[e]:t)}return a}function ga(a,e){var t={}.toString.call(a);return t.indexOf("[object")===0&&t.indexOf(e+"]")>-1}function ir(a,e){return typeof a=="function"?a.apply(void 0,e):a}function si(a,e){if(e===0)return a;var t;return function(n){clearTimeout(t),t=setTimeout(function(){a(n)},e)}}function Il(a){return a.split(/\s+/).filter(Boolean)}function Lt(a){return[].concat(a)}function oi(a,e){a.indexOf(e)===-1&&a.push(e)}function wl(a){return a.filter(function(e,t){return a.indexOf(e)===t})}function bl(a){return a.split("-")[0]}function Sn(a){return[].slice.call(a)}function di(a){return Object.keys(a).reduce(function(e,t){return a[t]!==void 0&&(e[t]=a[t]),e},{})}function Wt(){return document.createElement("div")}function _n(a){return["Element","Fragment"].some(function(e){return ga(a,e)})}function Tl(a){return ga(a,"NodeList")}function Sl(a){return ga(a,"MouseEvent")}function Nl(a){return!!(a&&a._tippy&&a._tippy.reference===a)}function Ol(a){return _n(a)?[a]:Tl(a)?Sn(a):Array.isArray(a)?a:Sn(document.querySelectorAll(a))}function jn(a,e){a.forEach(function(t){t&&(t.style.transitionDuration=e+"ms")})}function li(a,e){a.forEach(function(t){t&&t.setAttribute("data-state",e)})}function _l(a){var e,t=Lt(a),n=t[0];return n!=null&&(e=n.ownerDocument)!=null&&e.body?n.ownerDocument:document}function kl(a,e){var t=e.clientX,n=e.clientY;return a.every(function(i){var s=i.popperRect,o=i.popperState,l=i.props,c=l.interactiveBorder,f=bl(o.placement),g=o.modifiersData.offset;if(!g)return!0;var v=f==="bottom"?g.top.y:0,S=f==="top"?g.bottom.y:0,O=f==="right"?g.left.x:0,k=f==="left"?g.right.x:0,L=s.top-n+v>c,R=n-s.bottom-S>c,F=s.left-t+O>c,M=t-s.right-k>c;return L||R||F||M})}function Gn(a,e,t){var n=e+"EventListener";["transitionend","webkitTransitionEnd"].forEach(function(i){a[n](i,t)})}function ci(a,e){for(var t=e;t;){var n;if(a.contains(t))return!0;t=t.getRootNode==null||(n=t.getRootNode())==null?void 0:n.host}return!1}var qe={isTouch:!1},ui=0;function Dl(){qe.isTouch||(qe.isTouch=!0,window.performance&&document.addEventListener("mousemove",rr))}function rr(){var a=performance.now();a-ui<20&&(qe.isTouch=!1,document.removeEventListener("mousemove",rr)),ui=a}function Cl(){var a=document.activeElement;if(Nl(a)){var e=a._tippy;a.blur&&!e.state.isVisible&&a.blur()}}function Ll(){document.addEventListener("touchstart",Dl,yt),window.addEventListener("blur",Cl)}var Ml=typeof window<"u"&&typeof document<"u",$l=Ml?!!window.msCrypto:!1,Al={animateFill:!1,followCursor:!1,inlinePositioning:!1,sticky:!1},xl={allowHTML:!1,animation:"fade",arrow:!0,content:"",inertia:!1,maxWidth:350,role:"tooltip",theme:"",zIndex:9999},je=Object.assign({appendTo:ar,aria:{content:"auto",expanded:"auto"},delay:0,duration:[300,250],getReferenceClientRect:null,hideOnClick:!0,ignoreAttributes:!1,interactive:!1,interactiveBorder:2,interactiveDebounce:0,moveTransition:"",offset:[0,10],onAfterUpdate:function(){},onBeforeUpdate:function(){},onCreate:function(){},onDestroy:function(){},onHidden:function(){},onHide:function(){},onMount:function(){},onShow:function(){},onShown:function(){},onTrigger:function(){},onUntrigger:function(){},onClickOutside:function(){},placement:"top",plugins:[],popperOptions:{},render:null,showOnCreate:!1,touch:!0,trigger:"mouseenter focus",triggerTarget:null},Al,xl),Pl=Object.keys(je),Rl=function(e){var t=Object.keys(e);t.forEach(function(n){je[n]=e[n]})};function sr(a){var e=a.plugins||[],t=e.reduce(function(n,i){var s=i.name,o=i.defaultValue;if(s){var l;n[s]=a[s]!==void 0?a[s]:(l=je[s])!=null?l:o}return n},{});return Object.assign({},a,t)}function Xl(a,e){var t=e?Object.keys(sr(Object.assign({},je,{plugins:e}))):Pl,n=t.reduce(function(i,s){var o=(a.getAttribute("data-tippy-"+s)||"").trim();if(!o)return i;if(s==="content")i[s]=o;else try{i[s]=JSON.parse(o)}catch{i[s]=o}return i},{});return n}function fi(a,e){var t=Object.assign({},e,{content:ir(e.content,[a])},e.ignoreAttributes?{}:Xl(a,e.plugins));return t.aria=Object.assign({},je.aria,t.aria),t.aria={expanded:t.aria.expanded==="auto"?e.interactive:t.aria.expanded,content:t.aria.content==="auto"?e.interactive?null:"describedby":t.aria.content},t}var Vl=function(){return"innerHTML"};function aa(a,e){a[Vl()]=e}function pi(a){var e=Wt();return a===!0?e.className=tr:(e.className=nr,_n(a)?e.appendChild(a):aa(e,a)),e}function hi(a,e){_n(e.content)?(aa(a,""),a.appendChild(e.content)):typeof e.content!="function"&&(e.allowHTML?aa(a,e.content):a.textContent=e.content)}function ia(a){var e=a.firstElementChild,t=Sn(e.children);return{box:e,content:t.find(function(n){return n.classList.contains(er)}),arrow:t.find(function(n){return n.classList.contains(tr)||n.classList.contains(nr)}),backdrop:t.find(function(n){return n.classList.contains(El)})}}function or(a){var e=Wt(),t=Wt();t.className=yl,t.setAttribute("data-state","hidden"),t.setAttribute("tabindex","-1");var n=Wt();n.className=er,n.setAttribute("data-state","hidden"),hi(n,a.props),e.appendChild(t),t.appendChild(n),i(a.props,a.props);function i(s,o){var l=ia(e),c=l.box,f=l.content,g=l.arrow;o.theme?c.setAttribute("data-theme",o.theme):c.removeAttribute("data-theme"),typeof o.animation=="string"?c.setAttribute("data-animation",o.animation):c.removeAttribute("data-animation"),o.inertia?c.setAttribute("data-inertia",""):c.removeAttribute("data-inertia"),c.style.maxWidth=typeof o.maxWidth=="number"?o.maxWidth+"px":o.maxWidth,o.role?c.setAttribute("role",o.role):c.removeAttribute("role"),(s.content!==o.content||s.allowHTML!==o.allowHTML)&&hi(f,a.props),o.arrow?g?s.arrow!==o.arrow&&(c.removeChild(g),c.appendChild(pi(o.arrow))):c.appendChild(pi(o.arrow)):g&&c.removeChild(g)}return{popper:e,onUpdate:i}}or.$$tippy=!0;var Hl=1,un=[],Wn=[];function Fl(a,e){var t=fi(a,Object.assign({},je,sr(di(e)))),n,i,s,o=!1,l=!1,c=!1,f=!1,g,v,S,O=[],k=si(rt,t.interactiveDebounce),L,R=Hl++,F=null,M=wl(t.plugins),z={isEnabled:!0,isVisible:!1,isDestroyed:!1,isMounted:!1,isShown:!1},r={id:R,reference:a,popper:Wt(),popperInstance:F,props:t,state:z,plugins:M,clearDelayTimeouts:de,setProps:nt,setContent:St,show:Vt,hide:N,hideWithInteractivity:V,enable:st,disable:ge,unmount:H,destroy:q};if(!t.render)return r;var p=t.render(r),u=p.popper,h=p.onUpdate;u.setAttribute("data-tippy-root",""),u.id="tippy-"+r.id,r.popper=u,a._tippy=r,u._tippy=r;var T=M.map(function(_){return _.fn(r)}),y=a.hasAttribute("aria-expanded");return ie(),Q(),x(),U("onCreate",[r]),t.showOnCreate&&ht(),u.addEventListener("mouseenter",function(){r.props.interactive&&r.state.isVisible&&r.clearDelayTimeouts()}),u.addEventListener("mouseleave",function(){r.props.interactive&&r.props.trigger.indexOf("mouseenter")>=0&&A().addEventListener("mousemove",k)}),r;function E(){var _=r.props.touch;return Array.isArray(_)?_:[_,0]}function I(){return E()[0]==="hold"}function C(){var _;return!!((_=r.props.render)!=null&&_.$$tippy)}function D(){return L||a}function A(){var _=D().parentNode;return _?_l(_):document}function P(){return ia(u)}function b(_){return r.state.isMounted&&!r.state.isVisible||qe.isTouch||g&&g.type==="focus"?0:zn(r.props.delay,_?0:1,je.delay)}function x(_){_===void 0&&(_=!1),u.style.pointerEvents=r.props.interactive&&!_?"":"none",u.style.zIndex=""+r.props.zIndex}function U(_,B,Y){if(Y===void 0&&(Y=!0),T.forEach(function(K){K[_]&&K[_].apply(K,B)}),Y){var Z;(Z=r.props)[_].apply(Z,B)}}function G(){var _=r.props.aria;if(_.content){var B="aria-"+_.content,Y=u.id,Z=Lt(r.props.triggerTarget||a);Z.forEach(function(K){var le=K.getAttribute(B);if(r.state.isVisible)K.setAttribute(B,le?le+" "+Y:Y);else{var he=le&&le.replace(Y,"").trim();he?K.setAttribute(B,he):K.removeAttribute(B)}})}}function Q(){if(!(y||!r.props.aria.expanded)){var _=Lt(r.props.triggerTarget||a);_.forEach(function(B){r.props.interactive?B.setAttribute("aria-expanded",r.state.isVisible&&B===D()?"true":"false"):B.removeAttribute("aria-expanded")})}}function W(){A().removeEventListener("mousemove",k),un=un.filter(function(_){return _!==k})}function J(_){if(!(qe.isTouch&&(c||_.type==="mousedown"))){var B=_.composedPath&&_.composedPath()[0]||_.target;if(!(r.props.interactive&&ci(u,B))){if(Lt(r.props.triggerTarget||a).some(function(Y){return ci(Y,B)})){if(qe.isTouch||r.state.isVisible&&r.props.trigger.indexOf("click")>=0)return}else U("onClickOutside",[r,_]);r.props.hideOnClick===!0&&(r.clearDelayTimeouts(),r.hide(),l=!0,setTimeout(function(){l=!1}),r.state.isMounted||ee())}}}function re(){c=!0}function oe(){c=!1}function ae(){var _=A();_.addEventListener("mousedown",J,!0),_.addEventListener("touchend",J,yt),_.addEventListener("touchstart",oe,yt),_.addEventListener("touchmove",re,yt)}function ee(){var _=A();_.removeEventListener("mousedown",J,!0),_.removeEventListener("touchend",J,yt),_.removeEventListener("touchstart",oe,yt),_.removeEventListener("touchmove",re,yt)}function $(_,B){j(_,function(){!r.state.isVisible&&u.parentNode&&u.parentNode.contains(u)&&B()})}function X(_,B){j(_,B)}function j(_,B){var Y=P().box;function Z(K){K.target===Y&&(Gn(Y,"remove",Z),B())}if(_===0)return B();Gn(Y,"remove",v),Gn(Y,"add",Z),v=Z}function se(_,B,Y){Y===void 0&&(Y=!1);var Z=Lt(r.props.triggerTarget||a);Z.forEach(function(K){K.addEventListener(_,B,Y),O.push({node:K,eventType:_,handler:B,options:Y})})}function ie(){I()&&(se("touchstart",ye,{passive:!0}),se("touchend",wt,{passive:!0})),Il(r.props.trigger).forEach(function(_){if(_!=="manual")switch(se(_,ye),_){case"mouseenter":se("mouseleave",wt);break;case"focus":se($l?"focusout":"blur",ft);break;case"focusin":se("focusout",ft);break}})}function ce(){O.forEach(function(_){var B=_.node,Y=_.eventType,Z=_.handler,K=_.options;B.removeEventListener(Y,Z,K)}),O=[]}function ye(_){var B,Y=!1;if(!(!r.state.isEnabled||pt(_)||l)){var Z=((B=g)==null?void 0:B.type)==="focus";g=_,L=_.currentTarget,Q(),!r.state.isVisible&&Sl(_)&&un.forEach(function(K){return K(_)}),_.type==="click"&&(r.props.trigger.indexOf("mouseenter")<0||o)&&r.props.hideOnClick!==!1&&r.state.isVisible?Y=!0:ht(_),_.type==="click"&&(o=!Y),Y&&!Z&&tt(_)}}function rt(_){var B=_.target,Y=D().contains(B)||u.contains(B);if(!(_.type==="mousemove"&&Y)){var Z=We().concat(u).map(function(K){var le,he=K._tippy,Se=(le=he.popperInstance)==null?void 0:le.state;return Se?{popperRect:K.getBoundingClientRect(),popperState:Se,props:t}:null}).filter(Boolean);kl(Z,_)&&(W(),tt(_))}}function wt(_){var B=pt(_)||r.props.trigger.indexOf("click")>=0&&o;if(!B){if(r.props.interactive){r.hideWithInteractivity(_);return}tt(_)}}function ft(_){r.props.trigger.indexOf("focusin")<0&&_.target!==D()||r.props.interactive&&_.relatedTarget&&u.contains(_.relatedTarget)||tt(_)}function pt(_){return qe.isTouch?I()!==_.type.indexOf("touch")>=0:!1}function bt(){Tt();var _=r.props,B=_.popperOptions,Y=_.placement,Z=_.offset,K=_.getReferenceClientRect,le=_.moveTransition,he=C()?ia(u).arrow:null,Se=K?{getBoundingClientRect:K,contextElement:K.contextElement||D()}:a,ma={name:"$$tippy",enabled:!0,phase:"beforeWrite",requires:["computeStyles"],fn:function(en){var Nt=en.state;if(C()){var dr=P(),Dn=dr.box;["placement","reference-hidden","escaped"].forEach(function(tn){tn==="placement"?Dn.setAttribute("data-placement",Nt.placement):Nt.attributes.popper["data-popper-"+tn]?Dn.setAttribute("data-"+tn,""):Dn.removeAttribute("data-"+tn)}),Nt.attributes.popper={}}}},gt=[{name:"offset",options:{offset:Z}},{name:"preventOverflow",options:{padding:{top:2,bottom:2,left:5,right:5}}},{name:"flip",options:{padding:5}},{name:"computeStyles",options:{adaptive:!le}},ma];C()&&he&&gt.push({name:"arrow",options:{element:he,padding:3}}),gt.push.apply(gt,B?.modifiers||[]),r.popperInstance=vl(Se,u,Object.assign({},B,{placement:Y,onFirstUpdate:S,modifiers:gt}))}function Tt(){r.popperInstance&&(r.popperInstance.destroy(),r.popperInstance=null)}function Fe(){var _=r.props.appendTo,B,Y=D();r.props.interactive&&_===ar||_==="parent"?B=Y.parentNode:B=ir(_,[Y]),B.contains(u)||B.appendChild(u),r.state.isMounted=!0,bt()}function We(){return Sn(u.querySelectorAll("[data-tippy-root]"))}function ht(_){r.clearDelayTimeouts(),_&&U("onTrigger",[r,_]),ae();var B=b(!0),Y=E(),Z=Y[0],K=Y[1];qe.isTouch&&Z==="hold"&&K&&(B=K),B?n=setTimeout(function(){r.show()},B):r.show()}function tt(_){if(r.clearDelayTimeouts(),U("onUntrigger",[r,_]),!r.state.isVisible){ee();return}if(!(r.props.trigger.indexOf("mouseenter")>=0&&r.props.trigger.indexOf("click")>=0&&["mouseleave","mousemove"].indexOf(_.type)>=0&&o)){var B=b(!1);B?i=setTimeout(function(){r.state.isVisible&&r.hide()},B):s=requestAnimationFrame(function(){r.hide()})}}function st(){r.state.isEnabled=!0}function ge(){r.hide(),r.state.isEnabled=!1}function de(){clearTimeout(n),clearTimeout(i),cancelAnimationFrame(s)}function nt(_){if(!r.state.isDestroyed){U("onBeforeUpdate",[r,_]),ce();var B=r.props,Y=fi(a,Object.assign({},B,di(_),{ignoreAttributes:!0}));r.props=Y,ie(),B.interactiveDebounce!==Y.interactiveDebounce&&(W(),k=si(rt,Y.interactiveDebounce)),B.triggerTarget&&!Y.triggerTarget?Lt(B.triggerTarget).forEach(function(Z){Z.removeAttribute("aria-expanded")}):Y.triggerTarget&&a.removeAttribute("aria-expanded"),Q(),x(),h&&h(B,Y),r.popperInstance&&(bt(),We().forEach(function(Z){requestAnimationFrame(Z._tippy.popperInstance.forceUpdate)})),U("onAfterUpdate",[r,_])}}function St(_){r.setProps({content:_})}function Vt(){var _=r.state.isVisible,B=r.state.isDestroyed,Y=!r.state.isEnabled,Z=qe.isTouch&&!r.props.touch,K=zn(r.props.duration,0,je.duration);if(!(_||B||Y||Z)&&!D().hasAttribute("disabled")&&(U("onShow",[r],!1),r.props.onShow(r)!==!1)){if(r.state.isVisible=!0,C()&&(u.style.visibility="visible"),x(),ae(),r.state.isMounted||(u.style.transition="none"),C()){var le=P(),he=le.box,Se=le.content;jn([he,Se],0)}S=function(){var gt;if(!(!r.state.isVisible||f)){if(f=!0,u.offsetHeight,u.style.transition=r.props.moveTransition,C()&&r.props.animation){var kn=P(),en=kn.box,Nt=kn.content;jn([en,Nt],K),li([en,Nt],"visible")}G(),Q(),oi(Wn,r),(gt=r.popperInstance)==null||gt.forceUpdate(),U("onMount",[r]),r.props.animation&&C()&&X(K,function(){r.state.isShown=!0,U("onShown",[r])})}},Fe()}}function N(){var _=!r.state.isVisible,B=r.state.isDestroyed,Y=!r.state.isEnabled,Z=zn(r.props.duration,1,je.duration);if(!(_||B||Y)&&(U("onHide",[r],!1),r.props.onHide(r)!==!1)){if(r.state.isVisible=!1,r.state.isShown=!1,f=!1,o=!1,C()&&(u.style.visibility="hidden"),W(),ee(),x(!0),C()){var K=P(),le=K.box,he=K.content;r.props.animation&&(jn([le,he],Z),li([le,he],"hidden"))}G(),Q(),r.props.animation?C()&&$(Z,r.unmount):r.unmount()}}function V(_){A().addEventListener("mousemove",k),oi(un,k),k(_)}function H(){r.state.isVisible&&r.hide(),r.state.isMounted&&(Tt(),We().forEach(function(_){_._tippy.unmount()}),u.parentNode&&u.parentNode.removeChild(u),Wn=Wn.filter(function(_){return _!==r}),r.state.isMounted=!1,U("onHidden",[r]))}function q(){r.state.isDestroyed||(r.clearDelayTimeouts(),r.unmount(),ce(),delete a._tippy,r.state.isDestroyed=!0,U("onDestroy",[r]))}}function Jt(a,e){e===void 0&&(e={});var t=je.plugins.concat(e.plugins||[]);Ll();var n=Object.assign({},e,{plugins:t}),i=Ol(a),s=i.reduce(function(o,l){var c=l&&Fl(l,n);return c&&o.push(c),o},[]);return _n(a)?s[0]:s}Jt.defaultProps=je;Jt.setDefaultProps=Rl;Jt.currentInput=qe;Object.assign({},Gi,{effect:function(e){var t=e.state,n={popper:{position:t.options.strategy,left:"0",top:"0",margin:"0"},arrow:{position:"absolute"},reference:{}};Object.assign(t.elements.popper.style,n.popper),t.styles=n,t.elements.arrow&&Object.assign(t.elements.arrow.style,n.arrow)}});Jt.setDefaultProps({render:or});function Bl(a,e){const t=document.getElementById(`${a}`);t&&Jt(t,{content:e,theme:"battlesystem"})}function Ul(){const a=new Map;a.set("tip_gmtokens","Note: GM-owned tokens give universal vision."),a.set("visionRangeHeader","Range: How far this token can see. Click to Mass Edit"),a.set("visionFalloffHeader","Falloff: The blurred edge of the vision range. Click to Mass Edit"),a.set("visionBlindHeader","Blind: If this token is temporarily without sight."),a.set("visionHideHeader","Move token to the 'Out-of-Sight' list"),a.set("visionBumperHeader","Collision Distance: How close this token can get to an active wall. Click to Mass Edit"),a.set("visionInAngleHeader","Inner Angle: Inner angle of token vision, for hard edge, match with Outer Angle. Click to Mass Edit"),a.set("visionOutAngleHeader","Outer Angle:  Outer angle of token vision, for hard edge, match with Inner Angle. Click to Mass Edit"),a.set("visionDarkHeader","Greyscale: Add an 'outer-ring' of visible greyscale outside of your vision (Darkvision-Esque). Click to Mass Edit"),a.set("tip_spectretokens","Spectre tokens are only visible to specific players. Enable vision here after it has been Spectred."),a.set("tip_fogfill","Toggle to enable/disable fog fill for the scene."),a.set("tip_disablevision","Toggle to enable/disable vision for all tokens in scene."),a.set("tip_persistence","Toggle to enable/disable persistence vision for tokens. This will leave the map revealed as they travel."),a.set("tip_playerdoors","Toggle to enable/disable players being able to see and use doors on their own."),a.set("tip_ownerrings","Toggle to enable/disable the colored rings seen around a player to indicate their vision radius. GM-Only."),a.set("tip_gridsnap","Toggle to enable/disable grid snapping when drawing Obstruction Lines and Objects. This is separate from the default OBR Snap setting."),a.set("tip_unitcontextmenu","Enable to show the Unit Vision Settings on the Context Menu for tokens"),a.set("tip_wallcontextmenu","Enable to show the Advanced Wall Settings on the Context Menu for Obstructions"),a.set("tip_autohide","Enable to show the Autohide Option on tokens as well as enable Autohide functionality"),a.set("tip_trailingfog","Enable to 'fog' areas that have been revealed by Persistence, but a token is not currently in."),a.set("tip_gmwalls","Toggle to enable/disable the blocking of walls for the GM only."),a.set("tip_defaultelevation","Toggle the Default Elevation Layer. This is the layer a token/wall is set at when it's not on a specific mapping."),a.set("tip_elevationstyle","Toggle to change how Elevations treat walls. Mesa will allow tokens to see over walls at elevations above 0. City will have them all behave the same."),a.set("doublewall_button","This will change ALL walls within the scene to be double-sided, so they cannot be passed from either side."),a.set("block_button","This will set all walls to be Blocking walls, so that tokens cannot move past them."),a.set("unblock_button","This will set all walls to be Passable walls, so that tokens can move through them."),a.set("lock_button","This will lock all obstruction lines, so they cannot be accidentally (or purposefully) moved."),a.set("unlock_button","This will unlock all obstruction lines so they can be moved and/or editted."),a.set("reset_persistence","This will reset all persistence on a map, for all players in the room."),a.set("preview_select","This will allow you to view fog as the selected Player would see it."),a.set("tip_visionDefault","Set the default vision distance for new tokens."),a.set("tip_collisionDefault","Set the default collision range for new tokens."),a.set("tip_falloffDefault","Set the default falloff range for new tokens (having this on by default will increase GPU usage)."),a.set("tip_greyscaleDefault","Set the default greyscale vision range (should be higher than token Vision to take effect)."),a.set("tip_innerAngleDefault","Set the default inner angle radius."),a.set("tip_outerAngleDefault","Set the default outer angle radius."),a.forEach((e,t)=>{Bl(t,e)})}class zl{static async CenterViewportOnImage(e){const t=m.sceneItems.find(S=>S.id===e),n=await w.scene.grid.getDpi(),i=await w.viewport.getScale(),s=await w.viewport.getWidth(),o=await w.viewport.getHeight(),l={x:s/2,y:o/2},c={x:l.x/i,y:l.y/i},f=await this.GetImageCenter(t,n),g={x:f.x-c.x,y:f.y-c.y},v={x:g.x*i*-1,y:g.y*i*-1};await w.viewport.animateTo({position:v,scale:i})}static async GetImageCenter(e,t){if(yr(e)){const n=t/e.grid.dpi,i=e.image.width*n,s=e.image.height*n,o=e.grid.offset.x/e.image.width*i,l=e.grid.offset.y/e.image.height*s;return{x:e.position.x-o+i/2,y:e.position.y-l+s/2}}else return vr(e)&&e.points.length>0?{x:e.points[0].x,y:e.points[0].y}:{x:e.position.x,y:e.position.y}}}class Ct{headerName;element;popover;input;checkboxButton;okButton;onSubmitCallback;constructor(e,t,n,i="200px"){const s=document.querySelector(e);if(!s||!(s instanceof HTMLElement))throw new Error(`Element with selector "${e}" not found or is not an HTMLElement`);this.element=s,this.headerName=n,this.onSubmitCallback=t,this.createPopover(i),this.addEventListeners()}createPopover(e){this.popover=document.createElement("div"),this.popover.classList.add("mass-editor-popover"),this.popover.style.width=e,this.input=document.createElement("input"),this.input.type="number",this.input.style.cssText=`
        margin-right: 5px;
        `;const t=document.createElement("div");t.innerText=`Set All ${this.headerName} to`;const n=document.createElement("div");n.style.display="flex",n.style.width="100%",n.style.placeContent="center";const i=document.createElement("div");i.style.display="flex",i.style.width="100%",i.style.placeContent="center",this.okButton=document.createElement("button"),this.okButton.classList.add("popover-button"),this.okButton.textContent="OK",this.okButton.style.width="40px";const s=document.createElement("div");s.style.paddingLeft="4px",s.style.paddingRight="4px",s.textContent="Include Torches:",this.checkboxButton=document.createElement("input"),this.checkboxButton.type="checkbox",this.popover.appendChild(t),this.popover.appendChild(i),this.popover.appendChild(n),i.appendChild(this.input),i.appendChild(this.okButton),n.appendChild(s),n.appendChild(this.checkboxButton),document.body.appendChild(this.popover)}addEventListeners(){this.element.addEventListener("click",this.handleClick.bind(this)),this.okButton.addEventListener("click",this.handleSubmit.bind(this)),document.addEventListener("click",this.handleOutsideClick.bind(this))}handleClick(e){const t=this.element.getBoundingClientRect(),{left:n,top:i}=this.calculatePopoverPosition(t);this.popover.style.display="block",this.popover.style.left="calc(50% - 100px)",this.popover.style.top=`${i}px`,this.input.focus(),e.stopPropagation()}calculatePopoverPosition(e){const t=this.popover.getBoundingClientRect(),n=window.innerWidth;let i=e.left,s=e.top-t.height-5;return i+t.width>n&&(i=n-t.width-50),s<0&&(s=e.bottom+5),{left:i,top:s}}handleSubmit(){const e=Number(this.input.value),t=this.checkboxButton.checked;isNaN(e)||(this.onSubmitCallback(e,t),this.hidePopover())}handleOutsideClick(e){e.target instanceof Node&&!this.popover.contains(e.target)&&e.target!==this.element&&this.hidePopover()}hidePopover(){this.popover.style.display="none",this.input.value=""}}class jl{mainWindow=document.getElementById("app");smokeViewToggle;spectreViewToggle;settingsViewToggle;helpViewToggle;smokeViewPanel;spectreViewPanel;settingsViewPanel;helpViewPanel;patreonContainer;onVisionPanelMain=!0;visionPanelMain;visionPanelSub;smokeUnitTablePrime;smokeUnitTableSub;tokenList;hiddenList;version;draggedRow=null;constructor(e){this.version=`SMOKEANDSPECTRE-${e}`}async Stop(){await w.action.setHeight(100),await w.action.setWidth(300),this.mainWindow.innerHTML=`
        <div id="stopScreen">
            Awaiting Scene...
        </div>
        `}async Start(){function e(){const t="test";try{return localStorage.setItem(t,"1"),localStorage.removeItem(t),!0}catch{return!1}}if(e()?localStorage.getItem("NOTICED")!=="true"&&(await w.modal.open({id:d.EXTENSIONNOTICE,url:`/src/notice/notice.html?subscriber=${m.USER_REGISTERED}`,height:400,width:500}),localStorage.setItem("NOTICED","true")):console.log("localStorage is disabled, not showing the notice. You should definitely check the Patreon."),m.playerRole==="GM"){await w.action.setHeight(530),await w.action.setWidth(420);const n=await w.viewport.getWidth()<400;this.mainWindow.innerHTML=n?d.SMOKEMOBILEMAIN:d.SMOKEMAIN,this.smokeViewToggle=document.getElementById("smokeViewToggle"),this.spectreViewToggle=document.getElementById("spectreViewToggle"),this.settingsViewToggle=document.getElementById("settingsViewToggle"),this.helpViewToggle=document.getElementById("helpViewToggle"),this.smokeViewPanel=document.getElementById("smokeViewPanel"),this.spectreViewPanel=document.getElementById("spectreViewPanel"),this.settingsViewPanel=document.getElementById("settingsViewPanel"),this.helpViewPanel=document.getElementById("helpViewPanel"),this.patreonContainer=document.getElementById("patreonContainer"),this.smokeViewPanel.innerHTML=n?d.SMOKEMOBILEHTML:d.SMOKEHTML,this.spectreViewPanel.innerHTML=d.SPECTREHTML,this.settingsViewPanel.innerHTML=n?d.SETTINGSMOBILEHTML:d.SETTINGSHTML;const i=document.getElementById("playerListing");i.appendChild(this.GetEmptyContextItem("Self"));const s=document.getElementById("preview_select");s.innerHTML="";const o=document.createElement("option");o.value=m.playerId,o.textContent="View As: Self",s.appendChild(o);for(const l of m.party){const c=document.createElement("li");c.id=l.id,c.textContent=l.name,c.style.color=l.color,i.appendChild(c);const f=document.createElement("option");f.value=l.id,f.textContent=`View As: ${l.name}`,f.style.color=l.color,s.appendChild(f)}Ge.init(),await Yo(),this.SetupHelpDocuments(),this.SetupGMPanelHandlers(),await this.UpdateVisionList(),td(n),Wa(),fd(),Ul(),await ct.Initialize()}else await w.action.setHeight(300),await w.action.setWidth(300),this.mainWindow.innerHTML=`
                <div id="titleHolder" style="display: flex; width: 100%;">
                    <div style="width:60%;">Tokens You Own</div>
                    <div style="width:30%;">Vision</div>
                    <div style="width:10%;" id="patreonContainer"></div>
                </div>
                <div id="playerView" class="scrollable-table">
                    <table id="playerViewTable">
                    <thead>
                        <tr id="playerViewTableHeader">
                            <th style="width: 70%;"></th>
                            <th style="width: 20%;"></th>
                            <th style="width: 10%;"></th>
                        </tr>
                    </thead>
                        <tbody id="playerViewTableBody">
                        </tbody>
                    </table>
                </div>
            `,this.UpdatePlayerView(),this.patreonContainer=document.getElementById("patreonContainer");await this.InitializeScene(),this.patreonContainer?.appendChild(wr())}UpdatePlayerView(){const e=m.sceneItems.filter(i=>Kr(i)),t=document.getElementsByClassName("token-table-entry");this.CleanVisionList(e,t);const n=document.getElementById("playerViewTable");for(const i of e){const s=document.getElementById(`pl-${i.id}`);if(s){const o=s.getElementsByClassName("token-name")[0],l=s.getElementsByClassName("token-aradius")[0],c=s.getElementsByClassName("token-distancetype")[0];o&&(o.textContent=i.text?.plainText||i.name),l&&(l.textContent=i.metadata[`${d.EXTENSIONID}/visionRange`]!==void 0?i.metadata[`${d.EXTENSIONID}/visionRange`]:$e()),c&&(c.textContent=m.gridUnit)}else{const o=document.createElement("tr");o.id=`pl-${i.id}`,o.classList.add("token-table-entry");const l=document.createElement("td");l.textContent=i.text?.plainText||i.name,l.classList.add("player-token-name"),o.appendChild(l);const c=document.createElement("td");c.textContent=i.metadata[`${d.EXTENSIONID}/visionRange`]!==void 0?i.metadata[`${d.EXTENSIONID}/visionRange`]:$e(),o.appendChild(c);const f=document.createElement("td");f.textContent=m.gridUnit,o.appendChild(f),n.appendChild(o)}}}GetEmptyContextItem(e){const t=document.createElement("li");return t.id=m.playerId,t.textContent=e,t}SetupGMPanelHandlers(){this.SetupViewPanel(),this.smokeViewToggle.onclick=t=>{t.preventDefault(),e(ne.smokeViewToggle,ne.smokeViewPanel)},this.spectreViewToggle.onclick=t=>{t.preventDefault(),e(ne.spectreViewToggle,ne.spectreViewPanel)},this.settingsViewToggle.onclick=t=>{t.preventDefault(),e(ne.settingsViewToggle,ne.settingsViewPanel)},this.helpViewToggle.onclick=t=>{t.preventDefault(),e(ne.helpViewToggle,ne.helpViewPanel)};function e(t,n){ne.smokeViewToggle?.classList.remove("selected"),ne.spectreViewToggle?.classList.remove("selected"),ne.settingsViewToggle?.classList.remove("selected"),ne.helpViewToggle?.classList.remove("selected"),ne.smokeViewPanel.style.display="none",ne.spectreViewPanel.style.display="none",ne.settingsViewPanel.style.display="none",ne.helpViewPanel.style.display="none",t.classList.add("selected"),n.style.display="block"}}async OnDataChange(){await Ie.Run(),await ct.Run(),m.playerRole==="GM"?(await this.UpdateVisionList(),Wa()):this.UpdatePlayerView()}async InitializeScene(){await Ie.Initialize(),await Ie.Run(!0),await ct.Run()}async UpdateVisionList(){if(!document.getElementById("token_list"))return;const t=m.sceneItems.filter(l=>Le(l)),n=document.getElementsByClassName("token-table-entry");this.CleanVisionList(t,n);const[i,s]=t.reduce(([l,c],f)=>(f.metadata[`${d.EXTENSIONID}/linkedTo`]!==void 0?l.push(f):c.push(f),[l,c]),[[],[]]);for(const l of s){const c=document.getElementById(`tr-${l.id}`);c?this.UpdateTokenOnVisionList(l,c):this.AddTokenToVisionList(l)}const o=[];for(const l of i){const c=document.getElementById(`tr-${l.id}`);c?this.UpdateTokenOnVisionList(l,c,!0):this.AddTokenToVisionList(l,!0),m.sceneItems.find(g=>g.id===l.metadata[`${d.EXTENSIONID}/linkedTo`])||o.push(l.id)}o.length>0&&await w.scene.items.updateItems(o,l=>{for(let c of l)delete c.metadata[`${d.EXTENSIONID}/linkedTo`]})}SetupDragAndDrop(e){e&&(e.ondragstart=t=>{const n=t.target;if(n.closest("td")?.classList.contains("token-name")){const s=n.closest("tr");if(s&&s.tagName==="TR"){this.draggedRow=s;const o=s.nextElementSibling;if(o&&o.dataset.linkedto&&!this.draggedRow.dataset.linkedto){t.preventDefault();return}s.classList.add("dragging"),t.dataTransfer?.setData("text/plain",s.outerHTML)}}else t.preventDefault()},e.ondragend=()=>{this.draggedRow&&(this.draggedRow.classList.remove("dragging"),this.draggedRow=null)},e.ondragover=t=>{t.preventDefault();const n=t.target;if(n.tagName==="TD"||n.tagName==="TR"){const i=n.closest("tr");i&&this.draggedRow!==i&&i.classList.add("drop-target")}},e.ondragleave=t=>{const i=t.target.closest("tr");i&&i.classList.remove("drop-target")},e.ondrop=async t=>{if(t.preventDefault(),!e)return;const i=t.target.closest("tr");if(i&&this.draggedRow!==i){const s=i.id.slice(3);let o=m.sceneItems.find(l=>l.id===s);if(o&&o.metadata[`${d.EXTENSIONID}/linkedTo`]){const l=o.metadata[`${d.EXTENSIONID}/linkedTo`];o=m.sceneItems.find(c=>c.id===l)}if(this.draggedRow&&o&&i&&this.draggedRow!==i){i.classList.remove("drop-target");const l=e.querySelector("tbody"),c=this.draggedRow.id.slice(3);l.insertBefore(this.draggedRow,i.nextSibling),this.toggleRowVisibility(this.draggedRow,!0),this.draggedRow.dataset.linkedto=o.id,await w.scene.items.updateItems([c],f=>{for(let g of f)g.metadata[`${d.EXTENSIONID}/linkedTo`]=o.id,g.metadata[`${d.EXTENSIONID}/hiddenToken`]=o.metadata[`${d.EXTENSIONID}/hiddenToken`]})}}else if(this.draggedRow){const s=this.draggedRow.id.slice(3);this.toggleRowVisibility(this.draggedRow,!1),delete this.draggedRow.dataset.linkedto,await w.scene.items.updateItems([s],o=>{for(let l of o)delete l.metadata[`${d.EXTENSIONID}/linkedTo`]})}})}SetupMassEditors(){const e=async(l,c)=>{let f=l;l<0&&(f=0),l>999&&(f=999);const g=c?m.sceneItems.filter(v=>Le(v)):m.sceneItems.filter(v=>!Ot(v)&&Le(v));await w.scene.items.updateItems(g.map(v=>v.id),v=>{for(let S of v)S.metadata[`${d.EXTENSIONID}/visionRange`]=f.toString()})},t=async(l,c)=>{let f=l;l<0&&(f=0),l>10&&(f=10);const g=c?m.sceneItems.filter(v=>Le(v)):m.sceneItems.filter(v=>!Ot(v)&&Le(v));await w.scene.items.updateItems(g.map(v=>v.id),v=>{for(let S of v)S.metadata[`${d.EXTENSIONID}/visionFallOff`]=f.toString()})},n=async(l,c)=>{let f=l;l<0&&(f=0),l>999&&(f=999);const g=c?m.sceneItems.filter(v=>Le(v)):m.sceneItems.filter(v=>!Ot(v)&&Le(v));await w.scene.items.updateItems(g.map(v=>v.id),v=>{for(let S of v)S.metadata[`${d.EXTENSIONID}/visionSourceRange`]=f.toString()})},i=async(l,c)=>{let f=l;l<0&&(f=0),l>360&&(f=360);const g=c?m.sceneItems.filter(v=>Le(v)):m.sceneItems.filter(v=>!Ot(v)&&Le(v));await w.scene.items.updateItems(g.map(v=>v.id),v=>{for(let S of v)S.metadata[`${d.EXTENSIONID}/visionInAngle`]=f.toString()})},s=async(l,c)=>{let f=l;l<0&&(f=0),l>360&&(f=360);const g=c?m.sceneItems.filter(v=>Le(v)):m.sceneItems.filter(v=>!Ot(v)&&Le(v));await w.scene.items.updateItems(g.map(v=>v.id),v=>{for(let S of v)S.metadata[`${d.EXTENSIONID}/visionOutAngle`]=f.toString()})},o=async(l,c)=>{let f=l;l<0&&(f=0),l>999&&(f=999);const g=c?m.sceneItems.filter(v=>Le(v)):m.sceneItems.filter(v=>!Ot(v)&&Le(v));await w.scene.items.updateItems(g.map(v=>v.id),v=>{for(let S of v)S.metadata[`${d.EXTENSIONID}/visionDark`]=f.toString()})};new Ct("#visionRangeSvg",e,"Vision Range"),new Ct("#visionFalloffSvg",t,"Falloff Range"),new Ct("#visionBumperSvg",n,"Collision Range"),new Ct("#visionInnerSvg",i,"Inner Angle"),new Ct("#visionOuterSvg",s,"Outer Angle"),new Ct("#visionDarkSvg",o,"Greyscale")}SetupViewPanel(){const e=document.getElementById("visionPanelToggleContainer");this.visionPanelMain=document.getElementById("visionPanelMain"),this.visionPanelSub=document.getElementById("visionPanelSub"),this.smokeUnitTablePrime=document.getElementById("smokeUnitTablePrime"),this.smokeUnitTableSub=document.getElementById("smokeUnitTableSub"),this.SetupMassEditors(),this.SetupDragAndDrop(this.smokeUnitTablePrime),this.SetupDragAndDrop(this.smokeUnitTableSub);const t=document.createElement("input");t.type="button",t.value="Show Advanced",t.classList.add("view-panel-toggle"),t.onclick=()=>{this.visionPanelMain.style.display=this.onVisionPanelMain?"none":"table-row",this.visionPanelSub.style.display=this.onVisionPanelMain?"table-row":"none";const n=document.getElementsByClassName("vision-panel-main-input"),i=document.getElementsByClassName("vision-panel-sub-input");for(let s=0;s<n.length;s++)this.onVisionPanelMain?this.fadeOut(n[s],()=>this.fadeIn(i[s],"inline-block")):this.fadeOut(i[s],()=>this.fadeIn(n[s],"inline-block"));t.value=this.onVisionPanelMain?"Show Basic":"Show Advanced",this.onVisionPanelMain=!this.onVisionPanelMain},e.appendChild(t)}AddTokenToVisionList(e,t=!1){let n=m.sceneMetadata[`${d.EXTENSIONID}/USER-${e.createdUserId}`],i=n?.color,s=n?.name?`This token is owned by ${n.name}.`:"This token is owned by you.";!i&&e.createdUserId!==m.playerId&&(i="#aeb0af",s="This tokens owner is not in the room currently.");const o=document.getElementById("token_list"),l=document.getElementById("hidden_list"),c=e.metadata[`${d.EXTENSIONID}/isTorch`]===!0,f=document.createElement("tr");f.id=`tr-${e.id}`,f.className="token-table-entry",f.classList.add("slide-row"),f.draggable=!0;const g=document.createElement("td");g.id=`name-${e.id}`,c?(g.innerText=`🔦${e.name} `,g.title="This is a torch, which can be seen by other tokens with vision when in range."):(g.innerText=e.name,g.title=s,g.setAttribute("data-color",i),g.style.textShadow=`
                -2px -2px 2px ${i},
                2px -2px 2px ${i},
                -2px 2px 2px ${i},
                2px 2px 2px ${i}`),g.classList.add("token-name"),i==="#aeb0af"&&(g.style.color="black !important",g.style.fontStyle="italic"),g.draggable=!0,g.onclick=async()=>{zl.CenterViewportOnImage(e.id),await w.player.select([e.id])};const v=document.createElement("td"),S=document.createElement("input");S.type="number",S.value=e.metadata[`${d.EXTENSIONID}/visionRange`]!==void 0?e.metadata[`${d.EXTENSIONID}/visionRange`]:$e(),S.classList.add("token-aradius"),S.classList.add("vision-panel-main-input"),S.style.display=this.onVisionPanelMain?"inline-block":"none",S.draggable=!1,S.onchange=async y=>{if(!y||!y.target)return;const E=m.sceneItems.find(D=>D.id===e.id),I=y.target,C=parseInt(I.value);C<0&&(I.value="0"),C>999&&(I.value="999"),isNaN(C)&&(I.value=$e()),await w.scene.items.updateItems([E.id],D=>{D[0].metadata[`${d.EXTENSIONID}/visionRange`]=I.value})};const O=document.createElement("input");O.type="number",O.style.display="none",O.value=e.metadata[`${d.EXTENSIONID}/visionSourceRange`]!==void 0?e.metadata[`${d.EXTENSIONID}/visionSourceRange`]:ze(),O.classList.add("token-sradius"),O.classList.add("vision-panel-sub-input"),O.style.display=this.onVisionPanelMain?"none":"inline-block",O.draggable=!1,O.onchange=async y=>{if(!y||!y.target)return;const E=m.sceneItems.find(D=>D.id===e.id),I=y.target,C=parseFloat(I.value);C<0&&(I.value="0"),C>999&&(I.value="999"),isNaN(C)&&(I.value=ze()),await w.scene.items.updateItems([E.id],D=>{D[0].metadata[`${d.EXTENSIONID}/visionSourceRange`]=I.value})},v.appendChild(S),v.appendChild(O);const k=document.createElement("td"),L=document.createElement("input");L.type="number",L.value=e.metadata[`${d.EXTENSIONID}/visionFallOff`]!==void 0?e.metadata[`${d.EXTENSIONID}/visionFallOff`]:at(),L.classList.add("token-falloff"),L.classList.add("vision-panel-main-input"),L.style.display=this.onVisionPanelMain?"inline-block":"none",L.draggable=!1,L.onchange=async y=>{if(!y||!y.target)return;const E=m.sceneItems.find(D=>D.id===e.id),I=y.target,C=parseFloat(I.value);C<0&&(I.value="0"),C>10&&(I.value="10"),isNaN(C)&&(I.value=at()),await w.scene.items.updateItems([E.id],D=>{D[0].metadata[`${d.EXTENSIONID}/visionFallOff`]=I.value})};const R=document.createElement("input");R.type="number",R.style.display="none",R.value=e.metadata[`${d.EXTENSIONID}/visionInAngle`]!==void 0?e.metadata[`${d.EXTENSIONID}/visionInAngle`]:lt(),R.classList.add("token-innerang"),R.classList.add("vision-panel-sub-input"),R.style.display=this.onVisionPanelMain?"none":"inline-block",R.draggable=!1,R.onchange=async y=>{if(!y||!y.target)return;const E=m.sceneItems.find(D=>D.id===e.id),I=y.target,C=parseInt(I.value);C<0&&(I.value="0"),C>360&&(I.value="360"),isNaN(C)&&(I.value=lt()),await w.scene.items.updateItems([E.id],D=>{D[0].metadata[`${d.EXTENSIONID}/visionInAngle`]=I.value})},k.appendChild(L),k.appendChild(R);const F=document.createElement("td"),M=document.createElement("input");M.type="checkbox",M.checked=e.metadata[`${d.EXTENSIONID}/visionBlind`]!==void 0?e.metadata[`${d.EXTENSIONID}/visionBlind`]:!1,M.classList.add("token-blind"),M.classList.add("vision-panel-main-input"),M.style.display=this.onVisionPanelMain?"inline-block":"none",M.draggable=!1,M.onchange=async y=>{if(!y||!y.target)return;const E=y.target,I=m.sceneItems.find(C=>C.id===e.id);await w.scene.items.updateItems([I.id],C=>{C[0].metadata[`${d.EXTENSIONID}/visionBlind`]=E.checked})};const z=document.createElement("input");z.type="number",z.style.display="none",z.value=e.metadata[`${d.EXTENSIONID}/visionOutAngle`]!==void 0?e.metadata[`${d.EXTENSIONID}/visionOutAngle`]:Ze(),z.classList.add("token-outerang"),z.classList.add("vision-panel-sub-input"),z.style.display=this.onVisionPanelMain?"none":"inline-block",z.draggable=!1,z.onchange=async y=>{if(!y||!y.target)return;const E=m.sceneItems.find(D=>D.id===e.id),I=y.target,C=parseInt(I.value);C<0&&(I.value="0"),C>360&&(I.value="360"),isNaN(C)&&(I.value=Ze()),await w.scene.items.updateItems([E.id],D=>{D[0].metadata[`${d.EXTENSIONID}/visionOutAngle`]=I.value})},F.appendChild(M),F.appendChild(z);const r=document.createElement("td"),p=document.createElement("input");p.type="image",p.src="/swap.svg",p.checked=e.metadata[`${d.EXTENSIONID}/hiddenToken`]!==void 0?e.metadata[`${d.EXTENSIONID}/hiddenToken`]:!1,p.classList.add("token-hide"),p.classList.add("vision-panel-main-input"),p.style.display=this.onVisionPanelMain?"inline-block":"none",p.draggable=!1,p.onclick=async y=>{if(!y||!y.target)return;const E=m.sceneItems.find(D=>D.id===e.id),I=y.target;I.checked=!I.checked;const C=document.getElementById(`tr-${e.id}`);I.checked?(C.classList.add("slide-out"),setTimeout(()=>{C.dataset.linkedto?ne.hiddenList.appendChild(C):ne.hiddenList.prepend(C),C.classList.remove("slide-out"),C.classList.add("slide-in");const D=ne.tokenList.querySelectorAll("tr");if(D.length>0&&!C.dataset.linkedto){const A=Array.from(D).filter(P=>P.dataset.linkedto===e.id);for(const P of A){const b=P.querySelector(".token-hide");b&&b.click()}}setTimeout(async()=>{C.classList.remove("slide-in"),await w.scene.items.updateItems([E.id],A=>{A[0].metadata[`${d.EXTENSIONID}/hiddenToken`]=I.checked})},10)},250)):(C.classList.add("slide-out"),setTimeout(()=>{ne.tokenList.appendChild(C),C.classList.remove("slide-out"),C.classList.add("slide-in");const D=ne.hiddenList.querySelectorAll("tr");if(D.length>0&&!C.dataset.linkedto){const A=Array.from(D).filter(P=>P.dataset.linkedto===e.id);for(const P of A){const b=P.querySelector(".token-hide");b&&b.click()}}setTimeout(async()=>{C.classList.remove("slide-in"),await w.scene.items.updateItems([E.id],A=>{A[0].metadata[`${d.EXTENSIONID}/hiddenToken`]=I.checked})},10)},250))};const u=document.createElement("input");if(u.type="number",u.value=e.metadata[`${d.EXTENSIONID}/visionDark`]!==void 0?e.metadata[`${d.EXTENSIONID}/visionDark`]:mn(),u.classList.add("token-darkvision"),u.classList.add("vision-panel-sub-input"),u.style.display=this.onVisionPanelMain?"none":"inline-block",u.draggable=!1,u.onchange=async y=>{if(!y||!y.target)return;const E=m.sceneItems.find(D=>D.id===e.id),I=y.target,C=parseInt(I.value);C<0&&(I.value="0"),C>999&&(I.value="999"),isNaN(C)&&(I.value=$e()),await w.scene.items.updateItems([E.id],D=>{D[0].metadata[`${d.EXTENSIONID}/visionDark`]=I.value})},r.appendChild(p),r.appendChild(u),f.appendChild(g),f.appendChild(v),f.appendChild(k),f.appendChild(F),f.appendChild(r),t){const y=e.metadata[`${d.EXTENSIONID}/linkedTo`],E=o.querySelector(`#tr-${y}`)?o:l,I=E.querySelector(`#tr-${y}`);f.dataset.linkedto=y,f.classList.add("linked-row"),I&&(E.insertBefore(f,I.nextSibling),this.toggleRowVisibility(f,!0))}else e.metadata[`${d.EXTENSIONID}/hiddenToken`]===!0?l.prepend(f):o.appendChild(f);f.querySelectorAll("input").forEach(y=>{y.addEventListener("dragstart",E=>{E.stopPropagation()})});function T(){document.getElementById("contextMenu").style.display="none"}f.oncontextmenu=async function(y){y.preventDefault();const E=y.currentTarget,I=document.getElementById("contextMenu"),C=P=>{P.preventDefault()},D=async P=>{const b=[...m.party,{id:m.playerId,color:m.playerColor,name:m.playerName}],x=P.target,U=I.getAttribute("currentUnit"),Q=document.getElementById(`tr-${U}`).getElementsByClassName("token-name")[0],W=b.find(J=>x.id===J.id);if(W){const J=W.name!==m.playerName?`This token is owned by ${W.name}.`:"This token is owned by you.";Q.title=J,Q.setAttribute("data-color",i),Q.style.textShadow=`
                    -2px -2px 2px ${W.color},
                    2px -2px 2px ${W.color},
                    -2px 2px 2px ${W.color},
                    2px 2px 2px ${W.color}`}else Q.title="Unable to update owner name",Q.style.textShadow="";await w.scene.items.updateItems([U],J=>{for(const re of J)re.createdUserId=x.id}),I.style.display="none",P.stopPropagation(),window.removeEventListener("click",A),I.removeEventListener("click",D),I.removeEventListener("contextmenu",C)};I.setAttribute("currentUnit",E.id.substring(3));const A=()=>{I.style.display="none",window.removeEventListener("click",A),I.removeEventListener("click",D),I.removeEventListener("contextmenu",C)};if(I.addEventListener("click",D),I.addEventListener("contextmenu",C),window.addEventListener("click",A),I.style.display=="block")T();else{const b=(document.getElementById("playerListing").children.length+1)*34,x=Math.min(y.pageX,window.innerWidth-150);let U=Math.min(y.pageY,(window.innerHeight>300?window.innerHeight-50:window.innerHeight)-120);window.innerHeight<b+U&&(U=window.innerHeight-b),I.style.display="block",I.style.left=x+"px",I.style.top=U+"px"}}}UpdateTokenOnVisionList(e,t,n=!1){this.toggleRowVisibility(t,n),n?(t.dataset.linkedto||(t.dataset.linkedto=e.metadata[`${d.EXTENSIONID}/linkedTo`]),t.classList.contains("linked-row")||t.classList.add("linked-row")):(t.dataset.linkedto&&delete t.dataset.linkedto,t.classList.contains("linked-row")&&t.classList.remove("linked-row"));const i=m.sceneMetadata[`${d.EXTENSIONID}/USER-${e.createdUserId}`];let s=i?.color,o=i?.name?`This token is owned by ${i.name}.`:"This token is owned by you.";const l=e.metadata[`${d.EXTENSIONID}/isTorch`]===!0;!s&&e.createdUserId!==m.playerId&&(s="#aeb0af",o="This tokens owner is not in the room currently.");const c=t.getElementsByClassName("token-name")[0],f=t.getElementsByClassName("token-aradius")[0],g=t.getElementsByClassName("token-sradius")[0],v=t.getElementsByClassName("token-falloff")[0],S=t.getElementsByClassName("token-innerang")[0],O=t.getElementsByClassName("token-outerang")[0],k=t.getElementsByClassName("token-blind")[0],L=t.getElementsByClassName("token-darkvision")[0];c&&(l?(c.innerText=`🔦${e.name} `,c.title="This is a torch, which can be seen by other tokens with vision when in range."):(c.innerText=e.name,c.title=o,c.setAttribute("data-color",s),c.style.textShadow=`
                    -2px -2px 2px ${s},
                    2px -2px 2px ${s},
                    -2px 2px 2px ${s},
                    2px 2px 2px ${s}`)),f&&(f.value=e.metadata[`${d.EXTENSIONID}/visionRange`]!==void 0?e.metadata[`${d.EXTENSIONID}/visionRange`]:$e()),g&&(g.value=e.metadata[`${d.EXTENSIONID}/visionSourceRange`]!==void 0?e.metadata[`${d.EXTENSIONID}/visionSourceRange`]:ze()),v&&(v.value=e.metadata[`${d.EXTENSIONID}/visionFallOff`]!==void 0?e.metadata[`${d.EXTENSIONID}/visionFallOff`]:at()),S&&(S.value=e.metadata[`${d.EXTENSIONID}/visionInAngle`]!==void 0?e.metadata[`${d.EXTENSIONID}/visionInAngle`]:lt()),O&&(O.value=e.metadata[`${d.EXTENSIONID}/visionOutAngle`]!==void 0?e.metadata[`${d.EXTENSIONID}/visionOutAngle`]:Ze()),k&&(k.checked=e.metadata[`${d.EXTENSIONID}/visionBlind`]!==void 0?e.metadata[`${d.EXTENSIONID}/visionBlind`]:!1),L&&(L.value=e.metadata[`${d.EXTENSIONID}/visionDark`]!==void 0?e.metadata[`${d.EXTENSIONID}/visionDark`]:mn())}CleanVisionList(e,t){for(const n of t){const i=n.id.slice(3);e.some(s=>s.id===i)||n.remove()}}SetupHelpDocuments(){const t=new mr.Converter().makeHtml(d.MARKDOWNHELP),n=document.getElementById("markdownHelpContainer");n.innerHTML=t}fadeOut=(e,t)=>{e.style.opacity="0",setTimeout(()=>{e.style.display="none",t()},300)};fadeIn=(e,t)=>{e.style.opacity="0",e.style.display=t,setTimeout(()=>{e.style.opacity="1"},10)};toggleRowVisibility=(e,t)=>{t?e.classList.add("linked-row"):e.classList.remove("linked-row"),e.querySelectorAll("td").forEach(i=>{i.classList.contains("token-name")?i.style.textIndent=t?"20px":"0px":i.style.visibility=t?"hidden":"visible"})}}const ne=new jl("3.60");w.onReady(async()=>{const a=await w.scene.isReady(),e=document.getElementById("papp"),t=document.getElementById("contextmenu");if(!(e||t))if(a===!1){const n=w.scene.onReadyChange(async i=>{i&&(n(),await gi())})}else await gi()});async function gi(){await m.InitializeCache(),m.SetupHandlers(),await ne.Start()}export{m as B};
