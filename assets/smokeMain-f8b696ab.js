import{C as f,b as bi,O as C,a as st,c as Qt,i as hr,d as kt}from"./bsConstants-5cf717a6.js";/* empty css              */var mn=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function $n(i){return i&&i.__esModule&&Object.prototype.hasOwnProperty.call(i,"default")?i.default:i}function gr(i){if(i.__esModule)return i;var e=i.default;if(typeof e=="function"){var t=function n(){return this instanceof n?Reflect.construct(e,arguments,this.constructor):e.apply(this,arguments)};t.prototype=e.prototype}else t={};return Object.defineProperty(t,"__esModule",{value:!0}),Object.keys(i).forEach(function(n){var r=Object.getOwnPropertyDescriptor(i,n);Object.defineProperty(t,n,r.get?r:{enumerable:!0,get:function(){return i[n]}})}),t}function mr(i){return i.type==="CURVE"}function Wt(i){return i.type==="IMAGE"}function ei(i,e){return Math.round(i/e)*e}function ti(i,e){return Math.floor(i/e)*e}function kn(i){return i*(Math.PI/180)}function yr(i){return i*(180/Math.PI)}function ni(i,e,t){return i*(1-t)+e*t}class qe{static magnitudeSquared(e){return e.x*e.x+e.y*e.y}static magnitude(e){const t=Math.sqrt(this.magnitudeSquared(e));return isNaN(t)?0:t}static normalize(e){const t=this.magnitude(e);return t===0?{x:0,y:0}:this.divide(e,t)}static dot(e,t){return e.x*t.x+e.y*t.y}static subtract(e,t){return typeof t=="number"?{x:e.x-t,y:e.y-t}:{x:e.x-t.x,y:e.y-t.y}}static add(e,t){return typeof t=="number"?{x:e.x+t,y:e.y+t}:{x:e.x+t.x,y:e.y+t.y}}static multiply(e,t){return typeof t=="number"?{x:e.x*t,y:e.y*t}:{x:e.x*t.x,y:e.y*t.y}}static divide(e,t){return typeof t=="number"?{x:e.x/t,y:e.y/t}:{x:e.x/t.x,y:e.y/t.y}}static rotate(e,t,n){const r=Math.cos(kn(n)),o=Math.sin(kn(n)),l=this.subtract(e,t);return{x:t.x+r*l.x-o*l.y,y:t.y+o*l.x+r*l.y}}static min(e,t){return typeof t=="number"?{x:Math.min(e.x,t),y:Math.min(e.y,t)}:{x:Math.min(e.x,t.x),y:Math.min(e.y,t.y)}}static componentMin(e){return e.x<e.y?e.x:e.y}static max(e,t){return typeof t=="number"?{x:Math.max(e.x,t),y:Math.max(e.y,t)}:{x:Math.max(e.x,t.x),y:Math.max(e.y,t.y)}}static componentMax(e){return e.x>e.y?e.x:e.y}static roundTo(e,t){return{x:ei(e.x,t.x),y:ei(e.y,t.y)}}static floorTo(e,t){return{x:ti(e.x,t.x),y:ti(e.y,t.y)}}static sign(e){return{x:Math.sign(e.x),y:Math.sign(e.y)}}static abs(e){return{x:Math.abs(e.x),y:Math.abs(e.y)}}static pow(e,t){return typeof t=="number"?{x:Math.pow(e.x,t),y:Math.pow(e.y,t)}:{x:Math.pow(e.x,t.x),y:Math.pow(e.y,t.y)}}static clamp(e,t,n){return{x:Math.min(Math.max(e.x,t),n),y:Math.min(Math.max(e.y,t),n)}}static boundingBox(e){let t=Number.MAX_SAFE_INTEGER,n=Number.MIN_SAFE_INTEGER,r=Number.MAX_SAFE_INTEGER,o=Number.MIN_SAFE_INTEGER;for(let I of e)t=I.x<t?I.x:t,n=I.x>n?I.x:n,r=I.y<r?I.y:r,o=I.y>o?I.y:o;let l=n-t,d=o-r,p={x:(t+n)/2,y:(r+o)/2};return{min:{x:t,y:r},max:{x:n,y:o},width:l,height:d,center:p}}static pointInPolygon(e,t){const n=this.boundingBox(t);if(e.x<n.min.x||e.x>n.max.x||e.y<n.min.y||e.y>n.max.y)return!1;let r=!1;for(let o=0,l=t.length-1;o<t.length;l=o++){const d=t[o].y>e.y,p=t[l].y>e.y;d!==p&&e.x<(t[l].x-t[o].x)*(e.y-t[o].y)/(t[l].y-t[o].y)+t[o].x&&(r=!r)}return r}static compare(e,t,n){return this.magnitudeSquared(this.subtract(e,t))<n*n}static distance(e,t){return this.magnitude(this.subtract(e,t))}static lerp(e,t,n){return{x:ni(e.x,t.x,n),y:ni(e.y,t.y,n)}}static centroid(e){let t={x:0,y:0};for(let n of e)t.x+=n.x,t.y+=n.y;return e.length>0&&(t={x:t.x/e.length,y:t.y/e.length}),t}}class ze{static inverse(e){const[t,n,r,o,l,d,p,I,k]=e,A=t*(l*k-I*d)-n*(o*k-d*p)+r*(o*I-l*p);if(Math.abs(A)<1e-14)return e;const D=1/A,F=(l*k-I*d)*D,w=(r*I-n*k)*D,P=(n*d-r*l)*D,_=(d*p-o*k)*D,B=(t*k-r*p)*D,M=(o*r-t*d)*D,X=(o*I-p*l)*D,V=(p*n-t*I)*D,Z=(t*l-o*n)*D;return[F,w,P,_,B,M,X,V,Z]}static multiply(e,t){return[e[0]*t[0]+e[1]*t[3]+e[2]*t[6],e[0]*t[1]+e[1]*t[4]+e[2]*t[7],e[0]*t[2]+e[1]*t[5]+e[2]*t[8],e[3]*t[0]+e[4]*t[3]+e[5]*t[6],e[3]*t[1]+e[4]*t[4]+e[5]*t[7],e[3]*t[2]+e[4]*t[5]+e[5]*t[8],e[6]*t[0]+e[7]*t[3]+e[8]*t[6],e[6]*t[1]+e[7]*t[4]+e[8]*t[7],e[6]*t[2]+e[7]*t[5]+e[8]*t[8]]}static fromPosition(e){return[1,0,e.x,0,1,e.y,0,0,1]}static fromRotation(e){const t=kn(e);return[Math.cos(t),-Math.sin(t),0,Math.sin(t),Math.cos(t),0,0,0,1]}static fromScale(e){return[e.x,0,0,0,e.y,0,0,0,1]}static fromItem(e){const t=ze.fromPosition(e.position),n=ze.fromScale(e.scale),r=ze.fromRotation(e.rotation);return ze.multiply(ze.multiply(t,r),n)}static decompose(e){const[t,n,r,o,l,d]=e,p=t*l-o*n,I={position:{x:r,y:d},rotation:0,scale:{x:1,y:1}};if(t!=0||o!=0){var k=Math.sqrt(t*t+o*o);I.rotation=o>0?Math.acos(t/k):-Math.acos(t/k),I.scale={x:k,y:p/k}}else if(n!=0||l!=0){var A=Math.sqrt(n*n+l*l);I.rotation=Math.PI/2-(l>0?Math.acos(-n/A):-Math.acos(n/A)),I.scale={x:p/A,y:A}}return I.rotation=yr(I.rotation),I}}function vr(i){for(const e in i)if(i.hasOwnProperty(e))return!1;return!0}function Ir(){try{localStorage.setItem("STORAGECHECK","test")}catch{const e=document.getElementById("localStorageWarning");e.innerText="Local Storage disabled. Some features will not function."}}function ii(i,e){const t=window.matchMedia("(prefers-color-scheme: dark)"),n=t.matches?"dark":"light",r=t.matches?"light":"dark";for(var o=0;o<e.styleSheets.length;o++)for(var l=0;l<e.styleSheets[o].cssRules.length;l++){let d=e.styleSheets[o].cssRules[l];d&&d.media&&d.media.mediaText.includes("prefers-color-scheme")&&(i.mode=="LIGHT"?(d.media.appendMedium(`(prefers-color-scheme: ${n})`),d.media.mediaText.includes(r)&&d.media.deleteMedium(`(prefers-color-scheme: ${r})`)):i.mode=="DARK"&&(d.media.appendMedium(`(prefers-color-scheme: ${r})`),d.media.mediaText.includes(n)&&d.media.deleteMedium(`(prefers-color-scheme: ${n})`)))}}async function _n(){const i=b.sceneItems.filter(zi);if(!b.sceneMetadata[`${f.EXTENSIONID}/autodetectEnabled`]&&i.length==0){let e=bi().width(b.gridDpi*30).height(b.gridDpi*30).visible(!1).shapeType("RECTANGLE").visible(!0).locked(!1).strokeColor("pink").strokeOpacity(.5).fillOpacity(0).strokeDash([200,500]).strokeWidth(50).build();e.metadata[`${f.EXTENSIONID}/isBackgroundImage`]=!0,e.metadata[`${f.EXTENSIONID}/grid`]=!0,e.id=f.GRIDID,await C.scene.items.addItems([e])}b.sceneMetadata[`${f.EXTENSIONID}/autodetectEnabled`]===!0&&i.length>0&&await C.scene.items.deleteItems([f.GRIDID])}function Er(i){function e(){document.getElementById("contextMenu").style.display="none"}const t=document.getElementById(`tr-${i.id}`);if(t){const n=t.getElementsByClassName("token-name")[0],r=t.getElementsByClassName("token-vision-range")[0],o=t.getElementsByClassName("unlimited-vision")[0],l=t.getElementsByClassName("no-vision")[0];n&&(n.innerText=i.name),r&&!o.checked&&!l.checked&&(r.value=i.metadata[`${f.EXTENSIONID}/visionRange`]!==void 0?i.metadata[`${f.EXTENSIONID}/visionRange`]:f.VISIONDEFAULT),o&&(o.checked=i.metadata[`${f.EXTENSIONID}/visionRange`]===0),l&&(l.checked=i.metadata[`${f.EXTENSIONID}/visionBlind`]),o.checked||l.checked?r.setAttribute("disabled","disabled"):r.removeAttribute("disabled")}else{const n=b.sceneMetadata[`${f.EXTENSIONID}/USER-${i.createdUserId}`];let r=n?.color,o=n?.name?`This token is owned by ${n.name}.`:"This token is owned by you.";!r&&i.createdUserId!==b.playerId&&(r="#aeb0af",o="This tokens owner is not in the room currently.");const l=b.sceneItems.find(D=>D.id===i.id),d=document.createElement("tr");d.id=`tr-${l.id}`,d.className="token-table-entry",d.innerHTML=`<td id="contextLocator" title="${o}" ${r==="#aeb0af"?'style="color:black !important; font-style: italic;" ':""}data-color="${r}" class="token-name">${l.name}</td>
                           <td class="token-vision-container" title="The unit of measurement for your grid"><input class="token-vision-range" type="number" value=${f.VISIONDEFAULT}><span class="unit">units</span></td>
                           <td class="token-vision-container-grid">
                            <div class="vision-container-div">
                                <label class="cbutton" title="Unlimited vision range"><input type="checkbox" class="unlimited-vision"><span class="emoji">&infin;</span></label>
                                <label class="cbutton" title="Turn token into a light source"><input type="checkbox" class="torch-vision"><span class="emoji">&#128294;</span></label>
                                <label class="cbutton" title="Disable vision on this token"><input type="checkbox" class="no-vision"><span class="emoji">&#8856;</span></label>
                            </div>
                           </td>`,re.table.appendChild(d);const p=d.getElementsByClassName("token-vision-range")[0],I=d.getElementsByClassName("unlimited-vision")[0],k=d.getElementsByClassName("torch-vision")[0],A=d.getElementsByClassName("no-vision")[0];d.getElementsByClassName("token-name")[0].style.textShadow=`
        -2px -2px 2px ${r},
        2px -2px 2px ${r},
        -2px 2px 2px ${r},
        2px 2px 2px ${r}`,p&&!I.checked&&!A.checked&&(p.value=i.metadata[`${f.EXTENSIONID}/visionRange`]?i.metadata[`${f.EXTENSIONID}/visionRange`]:f.VISIONDEFAULT),I&&(I.checked=i.metadata[`${f.EXTENSIONID}/visionRange`]===0),k&&(k.checked=i.metadata[`${f.EXTENSIONID}/visionTorch`]),A&&(A.checked=i.metadata[`${f.EXTENSIONID}/visionBlind`]),I.checked||A.checked?p.setAttribute("disabled","disabled"):p.removeAttribute("disabled"),p.onchange=async D=>{if(!D||!D.target)return;const F=b.sceneItems.find(_=>_.id===i.id),w=D.target,P=parseInt(w.value);P<0&&(w.value="0"),P>999&&(w.value="999"),await C.scene.items.updateItems([F],_=>{_[0].metadata[`${f.EXTENSIONID}/visionRange`]=P})},I.onclick=async D=>{if(!D||!D.target)return;const F=b.sceneItems.find(_=>_.id===i.id);let w=0;D.target.checked?(p.setAttribute("disabled","disabled"),A.checked=!1):(w=parseInt(p.value),p.removeAttribute("disabled")),await C.scene.items.updateItems([F],_=>{_[0].metadata[`${f.EXTENSIONID}/visionRange`]=w})},A.onclick=async D=>{if(!D||!D.target)return;const F=b.sceneItems.find(P=>P.id===i.id),w=D.target;w.checked?p.setAttribute("disabled","disabled"):p.removeAttribute("disabled"),await C.scene.items.updateItems([F],P=>{P[0].metadata[`${f.EXTENSIONID}/visionBlind`]=w.checked})},k.onclick=async D=>{if(!D||!D.target)return;const F=b.sceneItems.find(P=>P.id===i.id),w=D.target;await C.scene.items.updateItems([F],P=>{P[0].metadata[`${f.EXTENSIONID}/visionTorch`]=w.checked})},p.addEventListener("mousewheel",async()=>{}),d.oncontextmenu=async function(D){D.preventDefault();const F=D.currentTarget,w=document.getElementById("contextMenu"),P=M=>{M.preventDefault()},_=async M=>{const X=M.target,V=w.getAttribute("currentUnit"),Z=b.party.find(h=>X.id===h.id)?.color,E=document.getElementById(`tr-${V}`).getElementsByClassName("token-name")[0];Z?E.style.textShadow=`
                    -2px -2px 2px ${Z},
                    2px -2px 2px ${Z},
                    -2px 2px 2px ${Z},
                    2px 2px 2px ${Z}`:E.style.textShadow="",await C.scene.items.updateItems([V],h=>{for(const y of h)y.createdUserId=X.id}),w.style.display="none",M.stopPropagation(),window.removeEventListener("click",B),w.removeEventListener("click",_),w.removeEventListener("contextmenu",P)};w.setAttribute("currentUnit",F.id.substring(3));const B=()=>{w.style.display="none",window.removeEventListener("click",B),w.removeEventListener("click",_),w.removeEventListener("contextmenu",P)};if(w.addEventListener("click",_),w.addEventListener("contextmenu",P),window.addEventListener("click",B),w.style.display=="block")e();else{const M=Math.min(D.pageX,window.innerWidth-150),X=Math.min(D.pageY,(window.innerHeight>300?window.innerHeight-50:window.innerHeight)-120);w.style.display="block",w.style.left=M+"px",w.style.top=X+"px"}}}}async function wr(i){const e=await C.scene.local.getItems(n=>n.metadata[`${f.EXTENSIONID}/doorId`]!==void 0),t=[];for(let n of e){let r=!1;for(const o of i)n.metadata[`${f.EXTENSIONID}/doorId`]==o.id&&(r=!0);r&&t.push(n.id)}await C.scene.local.deleteItems(t)}async function zt(i){const e=[],t=await C.scene.local.getItems(n=>n.metadata[`${f.EXTENSIONID}/doorId`]!==void 0);for(const n of i){if(!mr(n)||t.some(l=>l.metadata[`${f.EXTENSIONID}/doorId`]===n.id))continue;const r=ze.fromItem(n),o=[];for(let l=0;l<n.points.length;l++){const d=ze.fromPosition(n.points[l]);o.push(ze.decompose(ze.multiply(r,d)).position)}e.push(st().locked(!0).commands(Si(n.metadata[`${f.EXTENSIONID}/disabled`]===!0)).scale({x:.2,y:.2}).name("Door").position(qe.centroid(o)).metadata({[`${f.EXTENSIONID}/doorId`]:n.id}).build())}e.length>0&&await C.scene.local.addItems(e)}async function br(i){const e=await C.scene.local.getItems(t=>t.id===i&&t.metadata[`${f.EXTENSIONID}/doorId`]!==void 0);if(e.length===1){const t=e[0].metadata[`${f.EXTENSIONID}/doorId`],n=b.sceneItems.filter(r=>r.id===t);await C.scene.items.updateItems(n,r=>{const o=r[0];o.metadata[`${f.EXTENSIONID}/isVisionLine`]&&o.metadata[`${f.EXTENSIONID}/disabled`]?(delete o.metadata[`${f.EXTENSIONID}/disabled`],delete o.metadata[`${f.EXTENSIONID}/doorOpen`]):o.metadata[`${f.EXTENSIONID}/isVisionLine`]&&(o.metadata[`${f.EXTENSIONID}/disabled`]=!0,o.metadata[`${f.EXTENSIONID}/doorOpen`]=!0)}),await C.player.deselect([i])}}async function Sr(){const i=b.sceneItems.filter(e=>e.metadata[`${f.EXTENSIONID}/isDoor`]===!0);await zt(i)}function Si(i){return i?f.DOOROPEN:f.DOORCLOSED}var Ti={exports:{}};(function(i){(function(){function e(d,p){var I=d.x-p.x,k=d.y-p.y;return I*I+k*k}function t(d,p,I){var k=p.x,A=p.y,D=I.x-k,F=I.y-A;if(D!==0||F!==0){var w=((d.x-k)*D+(d.y-A)*F)/(D*D+F*F);w>1?(k=I.x,A=I.y):w>0&&(k+=D*w,A+=F*w)}return D=d.x-k,F=d.y-A,D*D+F*F}function n(d,p){for(var I=d[0],k=[I],A,D=1,F=d.length;D<F;D++)A=d[D],e(A,I)>p&&(k.push(A),I=A);return I!==A&&k.push(A),k}function r(d,p,I,k,A){for(var D=k,F,w=p+1;w<I;w++){var P=t(d[w],d[p],d[I]);P>D&&(F=w,D=P)}D>k&&(F-p>1&&r(d,p,F,k,A),A.push(d[F]),I-F>1&&r(d,F,I,k,A))}function o(d,p){var I=d.length-1,k=[d[0]];return r(d,0,I,p,k),k.push(d[I]),k}function l(d,p,I){if(d.length<=2)return d;var k=p!==void 0?p*p:1;return d=I?d:n(d,k),d=o(d,k),d}i.exports=l,i.exports.default=l})()})(Ti);var Tr=Ti.exports;const Nr=$n(Tr);function xn(i){const e=b.sceneItems.filter(r=>r.layer==="MAP"),t={};for(let r=0;r<e.length;r++){let o=i.querySelector("#map-"+e[r].id);o===null&&(o=document.createElement("option"),o.id="map-"+e[r].id,o.value=e[r].id,o.innerText=e[r].name,i.appendChild(o)),t[e[r].id]=e[r].name}let n=i.querySelectorAll("option");for(let r=0;r<n.length;r++)t[n[r].value]===void 0&&i.removeChild(n[r])}async function Or(i,e,t,n,r){if(r.innerText="",Number.isNaN(t)||t<0){r.innerText="Invalid DPI";return}let o=b.gridDpi/t,l,d=[];if(d[0]=0,d[1]=0,n!==""){let p=await C.scene.items.getItems([n]);if(p.length>0)l=p[0],t===0&&(t=l.grid.dpi),o=b.gridDpi/t,d[0]=l.position.x-l.grid.offset.x*o,d[1]=l.position.y-l.grid.offset.y*o;else{r.innerText="Unable to find map";return}}else{r.innerText="No map selected";return}i==="foundry"?_r(e,o,d,r):i==="uvtt"&&kr(e,o,d,r)}function Ni(i,e,t,n,r){let o=0,l=0,d=0;const p=[];for(let I=0;I<i.length;I++){let k=[],A=!1;for(let D=0;D<i[I].length-1;D++){let F=i[I][D].x*e,w=i[I][D].y*e,P=i[I][D+1].x*e,_=i[I][D+1].y*e;k.push({x:F*t+n[0],y:w*t+n[1]}),k.push({x:P*t+n[0],y:_*t+n[1]}),l++,!A&&i[I][D].door&&(A=!0)}k.length>128&&(k.length,k=Nr(k,8,!1));for(let D=0;D<k.length;D+=256){const F=k.slice(D>0?D-1:0,D+256),w=Qt().tension(0).points(F).fillColor("#000000").fillOpacity(0).layer("DRAWING").name("Vision Line (Import)").closed(!1).locked(!0).build();if(w.visible=!1,w.metadata[`${f.EXTENSIONID}/isVisionLine`]=!0,A&&(w.metadata[`${f.EXTENSIONID}/isDoor`]=!0),p.push(w),d+=F.length,d>512||p.length>64){o+=p.length,C.scene.items.addItems(p);const P=p.filter(_=>_.metadata[`${f.EXTENSIONID}/isDoor`]===!0);zt(P),p.length=0,d=0}}}if(p.length>0){o+=p.length,C.scene.items.addItems(p);const I=p.filter(k=>k.metadata[`${f.EXTENSIONID}/isDoor`]===!0);zt(I)}r.innerText="Finished importing "+o+" walls, "+l+" points."}function kr(i,e,t,n){if(!i.line_of_sight||i.line_of_sight.length===0){n.innerText="No walls / los found";return}if(i.resolution.map_origin!==void 0&&(t[0]-=i.resolution.map_origin.x*i.resolution.pixels_per_grid,t[1]-=i.resolution.map_origin.y*i.resolution.pixels_per_grid),i.portals&&i.portals.length)for(let r=0;r<i.portals.length;r++){let o=i.portals[r].bounds;o[0].door=!0,o[1].door=!0,i.line_of_sight.push(o)}Ni(i.line_of_sight,i.resolution.pixels_per_grid,e,t,n)}function _r(i,e,t,n){if(!i.walls||i.walls.length===0){n.innerText="No walls found";return}const r=[];for(var o=0;o<i.walls.length;o++)r.push([{x:i.walls[o].c[0],y:i.walls[o].c[1],door:!!i.walls[o].door},{x:i.walls[o].c[2],y:i.walls[o].c[3],door:!!i.walls[o].door}]);Ni(r,1,e,t,n)}function yn(i,e){i.split(/\s+/).forEach(t=>{e(t)})}class xr{constructor(){this._events=void 0,this._events={}}on(e,t){yn(e,n=>{const r=this._events[n]||[];r.push(t),this._events[n]=r})}off(e,t){var n=arguments.length;if(n===0){this._events={};return}yn(e,r=>{if(n===1){delete this._events[r];return}const o=this._events[r];o!==void 0&&(o.splice(o.indexOf(t),1),this._events[r]=o)})}trigger(e,...t){var n=this;yn(e,r=>{const o=n._events[r];o!==void 0&&o.forEach(l=>{l.apply(n,t)})})}}function Cr(i){return i.plugins={},class extends i{constructor(...e){super(...e),this.plugins={names:[],settings:{},requested:{},loaded:{}}}static define(e,t){i.plugins[e]={name:e,fn:t}}initializePlugins(e){var t,n;const r=this,o=[];if(Array.isArray(e))e.forEach(l=>{typeof l=="string"?o.push(l):(r.plugins.settings[l.name]=l.options,o.push(l.name))});else if(e)for(t in e)e.hasOwnProperty(t)&&(r.plugins.settings[t]=e[t],o.push(t));for(;n=o.shift();)r.require(n)}loadPlugin(e){var t=this,n=t.plugins,r=i.plugins[e];if(!i.plugins.hasOwnProperty(e))throw new Error('Unable to find "'+e+'" plugin');n.requested[e]=!0,n.loaded[e]=r.fn.apply(t,[t.plugins.settings[e]||{}]),n.names.push(e)}require(e){var t=this,n=t.plugins;if(!t.plugins.loaded.hasOwnProperty(e)){if(n.requested[e])throw new Error('Plugin has circular dependency ("'+e+'")');t.loadPlugin(e)}return n.loaded[e]}}}/*! @orchidjs/unicode-variants | https://github.com/orchidjs/unicode-variants | Apache License (v2) */const en=i=>(i=i.filter(Boolean),i.length<2?i[0]||"":Ar(i)==1?"["+i.join("")+"]":"(?:"+i.join("|")+")"),Oi=i=>{if(!Dr(i))return i.join("");let e="",t=0;const n=()=>{t>1&&(e+="{"+t+"}")};return i.forEach((r,o)=>{if(r===i[o-1]){t++;return}n(),e+=r,t=1}),n(),e},ki=i=>{let e=Rn(i);return en(e)},Dr=i=>new Set(i).size!==i.length,_t=i=>(i+"").replace(/([\$\(\)\*\+\.\?\[\]\^\{\|\}\\])/gu,"\\$1"),Ar=i=>i.reduce((e,t)=>Math.max(e,Mr(t)),0),Mr=i=>Rn(i).length,Rn=i=>Array.from(i);/*! @orchidjs/unicode-variants | https://github.com/orchidjs/unicode-variants | Apache License (v2) */const _i=i=>{if(i.length===1)return[[i]];let e=[];const t=i.substring(1);return _i(t).forEach(function(r){let o=r.slice(0);o[0]=i.charAt(0)+o[0],e.push(o),o=r.slice(0),o.unshift(i.charAt(0)),e.push(o)}),e};/*! @orchidjs/unicode-variants | https://github.com/orchidjs/unicode-variants | Apache License (v2) */const Pr=[[0,65535]],$r="[̀-ͯ·ʾʼ]";let qt,xi;const Rr=3,Ln={},ri={"/":"⁄∕",0:"߀",a:"ⱥɐɑ",aa:"ꜳ",ae:"æǽǣ",ao:"ꜵ",au:"ꜷ",av:"ꜹꜻ",ay:"ꜽ",b:"ƀɓƃ",c:"ꜿƈȼↄ",d:"đɗɖᴅƌꮷԁɦ",e:"ɛǝᴇɇ",f:"ꝼƒ",g:"ǥɠꞡᵹꝿɢ",h:"ħⱨⱶɥ",i:"ɨı",j:"ɉȷ",k:"ƙⱪꝁꝃꝅꞣ",l:"łƚɫⱡꝉꝇꞁɭ",m:"ɱɯϻ",n:"ꞥƞɲꞑᴎлԉ",o:"øǿɔɵꝋꝍᴑ",oe:"œ",oi:"ƣ",oo:"ꝏ",ou:"ȣ",p:"ƥᵽꝑꝓꝕρ",q:"ꝗꝙɋ",r:"ɍɽꝛꞧꞃ",s:"ßȿꞩꞅʂ",t:"ŧƭʈⱦꞇ",th:"þ",tz:"ꜩ",u:"ʉ",v:"ʋꝟʌ",vy:"ꝡ",w:"ⱳ",y:"ƴɏỿ",z:"ƶȥɀⱬꝣ",hv:"ƕ"};for(let i in ri){let e=ri[i]||"";for(let t=0;t<e.length;t++){let n=e.substring(t,t+1);Ln[n]=i}}const Lr=new RegExp(Object.keys(Ln).join("|")+"|"+$r,"gu"),Br=i=>{qt===void 0&&(qt=Vr(i||Pr))},oi=(i,e="NFKD")=>i.normalize(e),Yt=i=>Rn(i).reduce((e,t)=>e+Fr(t),""),Fr=i=>(i=oi(i).toLowerCase().replace(Lr,e=>Ln[e]||""),oi(i,"NFC"));function*Xr(i){for(const[e,t]of i)for(let n=e;n<=t;n++){let r=String.fromCharCode(n),o=Yt(r);o!=r.toLowerCase()&&(o.length>Rr||o.length!=0&&(yield{folded:o,composed:r,code_point:n}))}}const Hr=i=>{const e={},t=(n,r)=>{const o=e[n]||new Set,l=new RegExp("^"+ki(o)+"$","iu");r.match(l)||(o.add(_t(r)),e[n]=o)};for(let n of Xr(i))t(n.folded,n.folded),t(n.folded,n.composed);return e},Vr=i=>{const e=Hr(i),t={};let n=[];for(let o in e){let l=e[o];l&&(t[o]=ki(l)),o.length>1&&n.push(_t(o))}n.sort((o,l)=>l.length-o.length);const r=en(n);return xi=new RegExp("^"+r,"u"),t},Ur=(i,e=1)=>{let t=0;return i=i.map(n=>(qt[n]&&(t+=n.length),qt[n]||n)),t>=e?Oi(i):""},jr=(i,e=1)=>(e=Math.max(e,i.length-1),en(_i(i).map(t=>Ur(t,e)))),ai=(i,e=!0)=>{let t=i.length>1?1:0;return en(i.map(n=>{let r=[];const o=e?n.length():n.length()-1;for(let l=0;l<o;l++)r.push(jr(n.substrs[l]||"",t));return Oi(r)}))},Gr=(i,e)=>{for(const t of e){if(t.start!=i.start||t.end!=i.end||t.substrs.join("")!==i.substrs.join(""))continue;let n=i.parts;const r=l=>{for(const d of n){if(d.start===l.start&&d.substr===l.substr)return!1;if(!(l.length==1||d.length==1)&&(l.start<d.start&&l.end>d.start||d.start<l.start&&d.end>l.start))return!0}return!1};if(!(t.parts.filter(r).length>0))return!0}return!1};class Kt{constructor(){this.parts=[],this.substrs=[],this.start=0,this.end=0}add(e){e&&(this.parts.push(e),this.substrs.push(e.substr),this.start=Math.min(e.start,this.start),this.end=Math.max(e.end,this.end))}last(){return this.parts[this.parts.length-1]}length(){return this.parts.length}clone(e,t){let n=new Kt,r=JSON.parse(JSON.stringify(this.parts)),o=r.pop();for(const p of r)n.add(p);let l=t.substr.substring(0,e-o.start),d=l.length;return n.add({start:o.start,end:o.start+d,length:d,substr:l}),n}}const Wr=i=>{Br(),i=Yt(i);let e="",t=[new Kt];for(let n=0;n<i.length;n++){let o=i.substring(n).match(xi);const l=i.substring(n,n+1),d=o?o[0]:null;let p=[],I=new Set;for(const k of t){const A=k.last();if(!A||A.length==1||A.end<=n)if(d){const D=d.length;k.add({start:n,end:n+D,length:D,substr:d}),I.add("1")}else k.add({start:n,end:n+1,length:1,substr:l}),I.add("2");else if(d){let D=k.clone(n,A);const F=d.length;D.add({start:n,end:n+F,length:F,substr:d}),p.push(D)}else I.add("3")}if(p.length>0){p=p.sort((k,A)=>k.length()-A.length());for(let k of p)Gr(k,t)||t.push(k);continue}if(n>0&&I.size==1&&!I.has("3")){e+=ai(t,!1);let k=new Kt;const A=t[0];A&&k.add(A.last()),t=[k]}}return e+=ai(t,!0),e};/*! sifter.js | https://github.com/orchidjs/sifter.js | Apache License (v2) */const zr=(i,e)=>{if(i)return i[e]},qr=(i,e)=>{if(i){for(var t,n=e.split(".");(t=n.shift())&&(i=i[t]););return i}},vn=(i,e,t)=>{var n,r;return!i||(i=i+"",e.regex==null)||(r=i.search(e.regex),r===-1)?0:(n=e.string.length/i.length,r===0&&(n+=.5),n*t)},In=(i,e)=>{var t=i[e];if(typeof t=="function")return t;t&&!Array.isArray(t)&&(i[e]=[t])},Qe=(i,e)=>{if(Array.isArray(i))i.forEach(e);else for(var t in i)i.hasOwnProperty(t)&&e(i[t],t)},Yr=(i,e)=>typeof i=="number"&&typeof e=="number"?i>e?1:i<e?-1:0:(i=Yt(i+"").toLowerCase(),e=Yt(e+"").toLowerCase(),i>e?1:e>i?-1:0);/*! sifter.js | https://github.com/orchidjs/sifter.js | Apache License (v2) */class Kr{constructor(e,t){this.items=void 0,this.settings=void 0,this.items=e,this.settings=t||{diacritics:!0}}tokenize(e,t,n){if(!e||!e.length)return[];const r=[],o=e.split(/\s+/);var l;return n&&(l=new RegExp("^("+Object.keys(n).map(_t).join("|")+"):(.*)$")),o.forEach(d=>{let p,I=null,k=null;l&&(p=d.match(l))&&(I=p[1],d=p[2]),d.length>0&&(this.settings.diacritics?k=Wr(d)||null:k=_t(d),k&&t&&(k="\\b"+k)),r.push({string:d,regex:k?new RegExp(k,"iu"):null,field:I})}),r}getScoreFunction(e,t){var n=this.prepareSearch(e,t);return this._getScoreFunction(n)}_getScoreFunction(e){const t=e.tokens,n=t.length;if(!n)return function(){return 0};const r=e.options.fields,o=e.weights,l=r.length,d=e.getAttrFn;if(!l)return function(){return 1};const p=function(){return l===1?function(I,k){const A=r[0].field;return vn(d(k,A),I,o[A]||1)}:function(I,k){var A=0;if(I.field){const D=d(k,I.field);!I.regex&&D?A+=1/l:A+=vn(D,I,1)}else Qe(o,(D,F)=>{A+=vn(d(k,F),I,D)});return A/l}}();return n===1?function(I){return p(t[0],I)}:e.options.conjunction==="and"?function(I){var k,A=0;for(let D of t){if(k=p(D,I),k<=0)return 0;A+=k}return A/n}:function(I){var k=0;return Qe(t,A=>{k+=p(A,I)}),k/n}}getSortFunction(e,t){var n=this.prepareSearch(e,t);return this._getSortFunction(n)}_getSortFunction(e){var t,n=[];const r=this,o=e.options,l=!e.query&&o.sort_empty?o.sort_empty:o.sort;if(typeof l=="function")return l.bind(this);const d=function(k,A){return k==="$score"?A.score:e.getAttrFn(r.items[A.id],k)};if(l)for(let I of l)(e.query||I.field!=="$score")&&n.push(I);if(e.query){t=!0;for(let I of n)if(I.field==="$score"){t=!1;break}t&&n.unshift({field:"$score",direction:"desc"})}else n=n.filter(I=>I.field!=="$score");return n.length?function(I,k){var A,D;for(let F of n)if(D=F.field,A=(F.direction==="desc"?-1:1)*Yr(d(D,I),d(D,k)),A)return A;return 0}:null}prepareSearch(e,t){const n={};var r=Object.assign({},t);if(In(r,"sort"),In(r,"sort_empty"),r.fields){In(r,"fields");const o=[];r.fields.forEach(l=>{typeof l=="string"&&(l={field:l,weight:1}),o.push(l),n[l.field]="weight"in l?l.weight:1}),r.fields=o}return{options:r,query:e.toLowerCase().trim(),tokens:this.tokenize(e,r.respect_word_boundaries,n),total:0,items:[],weights:n,getAttrFn:r.nesting?qr:zr}}search(e,t){var n=this,r,o;o=this.prepareSearch(e,t),t=o.options,e=o.query;const l=t.score||n._getScoreFunction(o);e.length?Qe(n.items,(p,I)=>{r=l(p),(t.filter===!1||r>0)&&o.items.push({score:r,id:I})}):Qe(n.items,(p,I)=>{o.items.push({score:1,id:I})});const d=n._getSortFunction(o);return d&&o.items.sort(d),o.total=o.items.length,typeof t.limit=="number"&&(o.items=o.items.slice(0,t.limit)),o}}const bt=(i,e)=>{if(Array.isArray(i))i.forEach(e);else for(var t in i)i.hasOwnProperty(t)&&e(i[t],t)},We=i=>{if(i.jquery)return i[0];if(i instanceof HTMLElement)return i;if(Ci(i)){var e=document.createElement("template");return e.innerHTML=i.trim(),e.content.firstChild}return document.querySelector(i)},Ci=i=>typeof i=="string"&&i.indexOf("<")>-1,Zr=i=>i.replace(/['"\\]/g,"\\$&"),En=(i,e)=>{var t=document.createEvent("HTMLEvents");t.initEvent(e,!0,!1),i.dispatchEvent(t)},Pt=(i,e)=>{Object.assign(i.style,e)},Je=(i,...e)=>{var t=Di(e);i=Ai(i),i.map(n=>{t.map(r=>{n.classList.add(r)})})},dt=(i,...e)=>{var t=Di(e);i=Ai(i),i.map(n=>{t.map(r=>{n.classList.remove(r)})})},Di=i=>{var e=[];return bt(i,t=>{typeof t=="string"&&(t=t.trim().split(/[\11\12\14\15\40]/)),Array.isArray(t)&&(e=e.concat(t))}),e.filter(Boolean)},Ai=i=>(Array.isArray(i)||(i=[i]),i),Vt=(i,e,t)=>{if(!(t&&!t.contains(i)))for(;i&&i.matches;){if(i.matches(e))return i;i=i.parentNode}},si=(i,e=0)=>e>0?i[i.length-1]:i[0],Jr=i=>Object.keys(i).length===0,Zt=(i,e)=>{if(!i)return-1;e=e||i.nodeName;for(var t=0;i=i.previousElementSibling;)i.matches(e)&&t++;return t},Fe=(i,e)=>{bt(e,(t,n)=>{t==null?i.removeAttribute(n):i.setAttribute(n,""+t)})},Cn=(i,e)=>{i.parentNode&&i.parentNode.replaceChild(e,i)},Qr=(i,e)=>{if(e===null)return;if(typeof e=="string"){if(!e.length)return;e=new RegExp(e,"i")}const t=o=>{var l=o.data.match(e);if(l&&o.data.length>0){var d=document.createElement("span");d.className="highlight";var p=o.splitText(l.index);p.splitText(l[0].length);var I=p.cloneNode(!0);return d.appendChild(I),Cn(p,d),1}return 0},n=o=>{o.nodeType===1&&o.childNodes&&!/(script|style)/i.test(o.tagName)&&(o.className!=="highlight"||o.tagName!=="SPAN")&&Array.from(o.childNodes).forEach(l=>{r(l)})},r=o=>o.nodeType===3?t(o):(n(o),0);r(i)},eo=i=>{var e=i.querySelectorAll("span.highlight");Array.prototype.forEach.call(e,function(t){var n=t.parentNode;n.replaceChild(t.firstChild,t),n.normalize()})},to=65,no=13,Mi=27,Dn=37,io=38,Pi=39,ro=40,li=8,oo=46,An=9,ao=typeof navigator>"u"?!1:/Mac/.test(navigator.userAgent),$t=ao?"metaKey":"ctrlKey";var ci={options:[],optgroups:[],plugins:[],delimiter:",",splitOn:null,persist:!0,diacritics:!0,create:null,createOnBlur:!1,createFilter:null,highlight:!0,openOnFocus:!0,shouldOpen:null,maxOptions:50,maxItems:null,hideSelected:null,duplicates:!1,addPrecedence:!1,selectOnTab:!1,preload:null,allowEmptyOption:!1,refreshThrottle:300,loadThrottle:300,loadingClass:"loading",dataAttr:null,optgroupField:"optgroup",valueField:"value",labelField:"text",disabledField:"disabled",optgroupLabelField:"label",optgroupValueField:"value",lockOptgroupOrder:!1,sortField:"$order",searchField:["text"],searchConjunction:"and",mode:null,wrapperClass:"ts-wrapper",controlClass:"ts-control",dropdownClass:"ts-dropdown",dropdownContentClass:"ts-dropdown-content",itemClass:"item",optionClass:"option",dropdownParent:null,controlInput:'<input type="text" autocomplete="off" size="1" />',copyClassesToDropdown:!1,placeholder:null,hidePlaceholder:null,shouldLoad:function(i){return i.length>0},render:{}};const it=i=>typeof i>"u"||i===null?null:Ut(i),Ut=i=>typeof i=="boolean"?i?"1":"0":i+"",jt=i=>(i+"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;"),so=(i,e)=>e>0?setTimeout(i,e):(i.call(null),null),lo=(i,e)=>{var t;return function(n,r){var o=this;t&&(o.loading=Math.max(o.loading-1,0),clearTimeout(t)),t=setTimeout(function(){t=null,o.loadedSearches[n]=!0,i.call(o,n,r)},e)}},ui=(i,e,t)=>{var n,r=i.trigger,o={};i.trigger=function(){var l=arguments[0];if(e.indexOf(l)!==-1)o[l]=arguments;else return r.apply(i,arguments)},t.apply(i,[]),i.trigger=r;for(n of e)n in o&&r.apply(i,o[n])},co=i=>({start:i.selectionStart||0,length:(i.selectionEnd||0)-(i.selectionStart||0)}),Ae=(i,e=!1)=>{i&&(i.preventDefault(),e&&i.stopPropagation())},Pe=(i,e,t,n)=>{i.addEventListener(e,t,n)},mt=(i,e)=>{if(!e||!e[i])return!1;var t=(e.altKey?1:0)+(e.ctrlKey?1:0)+(e.shiftKey?1:0)+(e.metaKey?1:0);return t===1},wn=(i,e)=>{const t=i.getAttribute("id");return t||(i.setAttribute("id",e),e)},di=i=>i.replace(/[\\"']/g,"\\$&"),yt=(i,e)=>{e&&i.append(e)};function fi(i,e){var t=Object.assign({},ci,e),n=t.dataAttr,r=t.labelField,o=t.valueField,l=t.disabledField,d=t.optgroupField,p=t.optgroupLabelField,I=t.optgroupValueField,k=i.tagName.toLowerCase(),A=i.getAttribute("placeholder")||i.getAttribute("data-placeholder");if(!A&&!t.allowEmptyOption){let P=i.querySelector('option[value=""]');P&&(A=P.textContent)}var D={placeholder:A,options:[],optgroups:[],items:[],maxItems:null},F=()=>{var P,_=D.options,B={},M=1;let X=0;var V=E=>{var h=Object.assign({},E.dataset),y=n&&h[n];return typeof y=="string"&&y.length&&(h=Object.assign(h,JSON.parse(y))),h},Z=(E,h)=>{var y=it(E.value);if(y!=null&&!(!y&&!t.allowEmptyOption)){if(B.hasOwnProperty(y)){if(h){var g=B[y][d];g?Array.isArray(g)?g.push(h):B[y][d]=[g,h]:B[y][d]=h}}else{var N=V(E);N[r]=N[r]||E.textContent,N[o]=N[o]||y,N[l]=N[l]||E.disabled,N[d]=N[d]||h,N.$option=E,N.$order=N.$order||++X,B[y]=N,_.push(N)}E.selected&&D.items.push(y)}},O=E=>{var h,y;y=V(E),y[p]=y[p]||E.getAttribute("label")||"",y[I]=y[I]||M++,y[l]=y[l]||E.disabled,y.$order=y.$order||++X,D.optgroups.push(y),h=y[I],bt(E.children,g=>{Z(g,h)})};D.maxItems=i.hasAttribute("multiple")?null:1,bt(i.children,E=>{P=E.tagName.toLowerCase(),P==="optgroup"?O(E):P==="option"&&Z(E)})},w=()=>{const P=i.getAttribute(n);if(P)D.options=JSON.parse(P),bt(D.options,B=>{D.items.push(B[o])});else{var _=i.value.trim()||"";if(!t.allowEmptyOption&&!_.length)return;const B=_.split(t.delimiter);bt(B,M=>{const X={};X[r]=M,X[o]=M,D.options.push(X)}),D.items=B}};return k==="select"?F():w(),Object.assign({},ci,D,e)}var pi=0;class et extends Cr(xr){constructor(e,t){super(),this.control_input=void 0,this.wrapper=void 0,this.dropdown=void 0,this.control=void 0,this.dropdown_content=void 0,this.focus_node=void 0,this.order=0,this.settings=void 0,this.input=void 0,this.tabIndex=void 0,this.is_select_tag=void 0,this.rtl=void 0,this.inputId=void 0,this._destroy=void 0,this.sifter=void 0,this.isOpen=!1,this.isDisabled=!1,this.isReadOnly=!1,this.isRequired=void 0,this.isInvalid=!1,this.isValid=!0,this.isLocked=!1,this.isFocused=!1,this.isInputHidden=!1,this.isSetup=!1,this.ignoreFocus=!1,this.ignoreHover=!1,this.hasOptions=!1,this.currentResults=void 0,this.lastValue="",this.caretPos=0,this.loading=0,this.loadedSearches={},this.activeOption=null,this.activeItems=[],this.optgroups={},this.options={},this.userOptions={},this.items=[],this.refreshTimeout=null,pi++;var n,r=We(e);if(r.tomselect)throw new Error("Tom Select already initialized on this element");r.tomselect=this;var o=window.getComputedStyle&&window.getComputedStyle(r,null);n=o.getPropertyValue("direction");const l=fi(r,t);this.settings=l,this.input=r,this.tabIndex=r.tabIndex||0,this.is_select_tag=r.tagName.toLowerCase()==="select",this.rtl=/rtl/i.test(n),this.inputId=wn(r,"tomselect-"+pi),this.isRequired=r.required,this.sifter=new Kr(this.options,{diacritics:l.diacritics}),l.mode=l.mode||(l.maxItems===1?"single":"multi"),typeof l.hideSelected!="boolean"&&(l.hideSelected=l.mode==="multi"),typeof l.hidePlaceholder!="boolean"&&(l.hidePlaceholder=l.mode!=="multi");var d=l.createFilter;typeof d!="function"&&(typeof d=="string"&&(d=new RegExp(d)),d instanceof RegExp?l.createFilter=_=>d.test(_):l.createFilter=_=>this.settings.duplicates||!this.options[_]),this.initializePlugins(l.plugins),this.setupCallbacks(),this.setupTemplates();const p=We("<div>"),I=We("<div>"),k=this._render("dropdown"),A=We('<div role="listbox" tabindex="-1">'),D=this.input.getAttribute("class")||"",F=l.mode;var w;if(Je(p,l.wrapperClass,D,F),Je(I,l.controlClass),yt(p,I),Je(k,l.dropdownClass,F),l.copyClassesToDropdown&&Je(k,D),Je(A,l.dropdownContentClass),yt(k,A),We(l.dropdownParent||p).appendChild(k),Ci(l.controlInput)){w=We(l.controlInput);var P=["autocorrect","autocapitalize","autocomplete","spellcheck"];Qe(P,_=>{r.getAttribute(_)&&Fe(w,{[_]:r.getAttribute(_)})}),w.tabIndex=-1,I.appendChild(w),this.focus_node=w}else l.controlInput?(w=We(l.controlInput),this.focus_node=w):(w=We("<input/>"),this.focus_node=I);this.wrapper=p,this.dropdown=k,this.dropdown_content=A,this.control=I,this.control_input=w,this.setup()}setup(){const e=this,t=e.settings,n=e.control_input,r=e.dropdown,o=e.dropdown_content,l=e.wrapper,d=e.control,p=e.input,I=e.focus_node,k={passive:!0},A=e.inputId+"-ts-dropdown";Fe(o,{id:A}),Fe(I,{role:"combobox","aria-haspopup":"listbox","aria-expanded":"false","aria-controls":A});const D=wn(I,e.inputId+"-ts-control"),F="label[for='"+Zr(e.inputId)+"']",w=document.querySelector(F),P=e.focus.bind(e);if(w){Pe(w,"click",P),Fe(w,{for:D});const M=wn(w,e.inputId+"-ts-label");Fe(I,{"aria-labelledby":M}),Fe(o,{"aria-labelledby":M})}if(l.style.width=p.style.width,e.plugins.names.length){const M="plugin-"+e.plugins.names.join(" plugin-");Je([l,r],M)}(t.maxItems===null||t.maxItems>1)&&e.is_select_tag&&Fe(p,{multiple:"multiple"}),t.placeholder&&Fe(n,{placeholder:t.placeholder}),!t.splitOn&&t.delimiter&&(t.splitOn=new RegExp("\\s*"+_t(t.delimiter)+"+\\s*")),t.load&&t.loadThrottle&&(t.load=lo(t.load,t.loadThrottle)),Pe(r,"mousemove",()=>{e.ignoreHover=!1}),Pe(r,"mouseenter",M=>{var X=Vt(M.target,"[data-selectable]",r);X&&e.onOptionHover(M,X)},{capture:!0}),Pe(r,"click",M=>{const X=Vt(M.target,"[data-selectable]");X&&(e.onOptionSelect(M,X),Ae(M,!0))}),Pe(d,"click",M=>{var X=Vt(M.target,"[data-ts-item]",d);if(X&&e.onItemSelect(M,X)){Ae(M,!0);return}n.value==""&&(e.onClick(),Ae(M,!0))}),Pe(I,"keydown",M=>e.onKeyDown(M)),Pe(n,"keypress",M=>e.onKeyPress(M)),Pe(n,"input",M=>e.onInput(M)),Pe(I,"blur",M=>e.onBlur(M)),Pe(I,"focus",M=>e.onFocus(M)),Pe(n,"paste",M=>e.onPaste(M));const _=M=>{const X=M.composedPath()[0];if(!l.contains(X)&&!r.contains(X)){e.isFocused&&e.blur(),e.inputState();return}X==n&&e.isOpen?M.stopPropagation():Ae(M,!0)},B=()=>{e.isOpen&&e.positionDropdown()};Pe(document,"mousedown",_),Pe(window,"scroll",B,k),Pe(window,"resize",B,k),this._destroy=()=>{document.removeEventListener("mousedown",_),window.removeEventListener("scroll",B),window.removeEventListener("resize",B),w&&w.removeEventListener("click",P)},this.revertSettings={innerHTML:p.innerHTML,tabIndex:p.tabIndex},p.tabIndex=-1,p.insertAdjacentElement("afterend",e.wrapper),e.sync(!1),t.items=[],delete t.optgroups,delete t.options,Pe(p,"invalid",()=>{e.isValid&&(e.isValid=!1,e.isInvalid=!0,e.refreshState())}),e.updateOriginalInput(),e.refreshItems(),e.close(!1),e.inputState(),e.isSetup=!0,p.disabled?e.disable():p.readOnly?e.setReadOnly(!0):e.enable(),e.on("change",this.onChange),Je(p,"tomselected","ts-hidden-accessible"),e.trigger("initialize"),t.preload===!0&&e.preload()}setupOptions(e=[],t=[]){this.addOptions(e),Qe(t,n=>{this.registerOptionGroup(n)})}setupTemplates(){var e=this,t=e.settings.labelField,n=e.settings.optgroupLabelField,r={optgroup:o=>{let l=document.createElement("div");return l.className="optgroup",l.appendChild(o.options),l},optgroup_header:(o,l)=>'<div class="optgroup-header">'+l(o[n])+"</div>",option:(o,l)=>"<div>"+l(o[t])+"</div>",item:(o,l)=>"<div>"+l(o[t])+"</div>",option_create:(o,l)=>'<div class="create">Add <strong>'+l(o.input)+"</strong>&hellip;</div>",no_results:()=>'<div class="no-results">No results found</div>',loading:()=>'<div class="spinner"></div>',not_loading:()=>{},dropdown:()=>"<div></div>"};e.settings.render=Object.assign({},r,e.settings.render)}setupCallbacks(){var e,t,n={initialize:"onInitialize",change:"onChange",item_add:"onItemAdd",item_remove:"onItemRemove",item_select:"onItemSelect",clear:"onClear",option_add:"onOptionAdd",option_remove:"onOptionRemove",option_clear:"onOptionClear",optgroup_add:"onOptionGroupAdd",optgroup_remove:"onOptionGroupRemove",optgroup_clear:"onOptionGroupClear",dropdown_open:"onDropdownOpen",dropdown_close:"onDropdownClose",type:"onType",load:"onLoad",focus:"onFocus",blur:"onBlur"};for(e in n)t=this.settings[n[e]],t&&this.on(e,t)}sync(e=!0){const t=this,n=e?fi(t.input,{delimiter:t.settings.delimiter}):t.settings;t.setupOptions(n.options,n.optgroups),t.setValue(n.items||[],!0),t.lastQuery=null}onClick(){var e=this;if(e.activeItems.length>0){e.clearActiveItems(),e.focus();return}e.isFocused&&e.isOpen?e.blur():e.focus()}onMouseDown(){}onChange(){En(this.input,"input"),En(this.input,"change")}onPaste(e){var t=this;if(t.isInputHidden||t.isLocked){Ae(e);return}t.settings.splitOn&&setTimeout(()=>{var n=t.inputValue();if(n.match(t.settings.splitOn)){var r=n.trim().split(t.settings.splitOn);Qe(r,o=>{it(o)&&(this.options[o]?t.addItem(o):t.createItem(o))})}},0)}onKeyPress(e){var t=this;if(t.isLocked){Ae(e);return}var n=String.fromCharCode(e.keyCode||e.which);if(t.settings.create&&t.settings.mode==="multi"&&n===t.settings.delimiter){t.createItem(),Ae(e);return}}onKeyDown(e){var t=this;if(t.ignoreHover=!0,t.isLocked){e.keyCode!==An&&Ae(e);return}switch(e.keyCode){case to:if(mt($t,e)&&t.control_input.value==""){Ae(e),t.selectAll();return}break;case Mi:t.isOpen&&(Ae(e,!0),t.close()),t.clearActiveItems();return;case ro:if(!t.isOpen&&t.hasOptions)t.open();else if(t.activeOption){let n=t.getAdjacent(t.activeOption,1);n&&t.setActiveOption(n)}Ae(e);return;case io:if(t.activeOption){let n=t.getAdjacent(t.activeOption,-1);n&&t.setActiveOption(n)}Ae(e);return;case no:t.canSelect(t.activeOption)?(t.onOptionSelect(e,t.activeOption),Ae(e)):(t.settings.create&&t.createItem()||document.activeElement==t.control_input&&t.isOpen)&&Ae(e);return;case Dn:t.advanceSelection(-1,e);return;case Pi:t.advanceSelection(1,e);return;case An:t.settings.selectOnTab&&(t.canSelect(t.activeOption)&&(t.onOptionSelect(e,t.activeOption),Ae(e)),t.settings.create&&t.createItem()&&Ae(e));return;case li:case oo:t.deleteSelection(e);return}t.isInputHidden&&!mt($t,e)&&Ae(e)}onInput(e){if(this.isLocked)return;const t=this.inputValue();if(this.lastValue!==t){if(this.lastValue=t,t==""){this._onInput();return}this.refreshTimeout&&clearTimeout(this.refreshTimeout),this.refreshTimeout=so(()=>{this.refreshTimeout=null,this._onInput()},this.settings.refreshThrottle)}}_onInput(){const e=this.lastValue;this.settings.shouldLoad.call(this,e)&&this.load(e),this.refreshOptions(),this.trigger("type",e)}onOptionHover(e,t){this.ignoreHover||this.setActiveOption(t,!1)}onFocus(e){var t=this,n=t.isFocused;if(t.isDisabled||t.isReadOnly){t.blur(),Ae(e);return}t.ignoreFocus||(t.isFocused=!0,t.settings.preload==="focus"&&t.preload(),n||t.trigger("focus"),t.activeItems.length||(t.inputState(),t.refreshOptions(!!t.settings.openOnFocus)),t.refreshState())}onBlur(e){if(document.hasFocus()!==!1){var t=this;if(t.isFocused){t.isFocused=!1,t.ignoreFocus=!1;var n=()=>{t.close(),t.setActiveItem(),t.setCaret(t.items.length),t.trigger("blur")};t.settings.create&&t.settings.createOnBlur?t.createItem(null,n):n()}}}onOptionSelect(e,t){var n,r=this;t.parentElement&&t.parentElement.matches("[data-disabled]")||(t.classList.contains("create")?r.createItem(null,()=>{r.settings.closeAfterSelect&&r.close()}):(n=t.dataset.value,typeof n<"u"&&(r.lastQuery=null,r.addItem(n),r.settings.closeAfterSelect&&r.close(),!r.settings.hideSelected&&e.type&&/click/.test(e.type)&&r.setActiveOption(t))))}canSelect(e){return!!(this.isOpen&&e&&this.dropdown_content.contains(e))}onItemSelect(e,t){var n=this;return!n.isLocked&&n.settings.mode==="multi"?(Ae(e),n.setActiveItem(t,e),!0):!1}canLoad(e){return!(!this.settings.load||this.loadedSearches.hasOwnProperty(e))}load(e){const t=this;if(!t.canLoad(e))return;Je(t.wrapper,t.settings.loadingClass),t.loading++;const n=t.loadCallback.bind(t);t.settings.load.call(t,e,n)}loadCallback(e,t){const n=this;n.loading=Math.max(n.loading-1,0),n.lastQuery=null,n.clearActiveOption(),n.setupOptions(e,t),n.refreshOptions(n.isFocused&&!n.isInputHidden),n.loading||dt(n.wrapper,n.settings.loadingClass),n.trigger("load",e,t)}preload(){var e=this.wrapper.classList;e.contains("preloaded")||(e.add("preloaded"),this.load(""))}setTextboxValue(e=""){var t=this.control_input,n=t.value!==e;n&&(t.value=e,En(t,"update"),this.lastValue=e)}getValue(){return this.is_select_tag&&this.input.hasAttribute("multiple")?this.items:this.items.join(this.settings.delimiter)}setValue(e,t){var n=t?[]:["change"];ui(this,n,()=>{this.clear(t),this.addItems(e,t)})}setMaxItems(e){e===0&&(e=null),this.settings.maxItems=e,this.refreshState()}setActiveItem(e,t){var n=this,r,o,l,d,p,I;if(n.settings.mode!=="single"){if(!e){n.clearActiveItems(),n.isFocused&&n.inputState();return}if(r=t&&t.type.toLowerCase(),r==="click"&&mt("shiftKey",t)&&n.activeItems.length){for(I=n.getLastActive(),l=Array.prototype.indexOf.call(n.control.children,I),d=Array.prototype.indexOf.call(n.control.children,e),l>d&&(p=l,l=d,d=p),o=l;o<=d;o++)e=n.control.children[o],n.activeItems.indexOf(e)===-1&&n.setActiveItemClass(e);Ae(t)}else r==="click"&&mt($t,t)||r==="keydown"&&mt("shiftKey",t)?e.classList.contains("active")?n.removeActiveItem(e):n.setActiveItemClass(e):(n.clearActiveItems(),n.setActiveItemClass(e));n.inputState(),n.isFocused||n.focus()}}setActiveItemClass(e){const t=this,n=t.control.querySelector(".last-active");n&&dt(n,"last-active"),Je(e,"active last-active"),t.trigger("item_select",e),t.activeItems.indexOf(e)==-1&&t.activeItems.push(e)}removeActiveItem(e){var t=this.activeItems.indexOf(e);this.activeItems.splice(t,1),dt(e,"active")}clearActiveItems(){dt(this.activeItems,"active"),this.activeItems=[]}setActiveOption(e,t=!0){e!==this.activeOption&&(this.clearActiveOption(),e&&(this.activeOption=e,Fe(this.focus_node,{"aria-activedescendant":e.getAttribute("id")}),Fe(e,{"aria-selected":"true"}),Je(e,"active"),t&&this.scrollToOption(e)))}scrollToOption(e,t){if(!e)return;const n=this.dropdown_content,r=n.clientHeight,o=n.scrollTop||0,l=e.offsetHeight,d=e.getBoundingClientRect().top-n.getBoundingClientRect().top+o;d+l>r+o?this.scroll(d-r+l,t):d<o&&this.scroll(d,t)}scroll(e,t){const n=this.dropdown_content;t&&(n.style.scrollBehavior=t),n.scrollTop=e,n.style.scrollBehavior=""}clearActiveOption(){this.activeOption&&(dt(this.activeOption,"active"),Fe(this.activeOption,{"aria-selected":null})),this.activeOption=null,Fe(this.focus_node,{"aria-activedescendant":null})}selectAll(){const e=this;if(e.settings.mode==="single")return;const t=e.controlChildren();t.length&&(e.inputState(),e.close(),e.activeItems=t,Qe(t,n=>{e.setActiveItemClass(n)}))}inputState(){var e=this;e.control.contains(e.control_input)&&(Fe(e.control_input,{placeholder:e.settings.placeholder}),e.activeItems.length>0||!e.isFocused&&e.settings.hidePlaceholder&&e.items.length>0?(e.setTextboxValue(),e.isInputHidden=!0):(e.settings.hidePlaceholder&&e.items.length>0&&Fe(e.control_input,{placeholder:""}),e.isInputHidden=!1),e.wrapper.classList.toggle("input-hidden",e.isInputHidden))}inputValue(){return this.control_input.value.trim()}focus(){var e=this;e.isDisabled||e.isReadOnly||(e.ignoreFocus=!0,e.control_input.offsetWidth?e.control_input.focus():e.focus_node.focus(),setTimeout(()=>{e.ignoreFocus=!1,e.onFocus()},0))}blur(){this.focus_node.blur(),this.onBlur()}getScoreFunction(e){return this.sifter.getScoreFunction(e,this.getSearchOptions())}getSearchOptions(){var e=this.settings,t=e.sortField;return typeof e.sortField=="string"&&(t=[{field:e.sortField}]),{fields:e.searchField,conjunction:e.searchConjunction,sort:t,nesting:e.nesting}}search(e){var t,n,r=this,o=this.getSearchOptions();if(r.settings.score&&(n=r.settings.score.call(r,e),typeof n!="function"))throw new Error('Tom Select "score" setting must be a function that returns a function');return e!==r.lastQuery?(r.lastQuery=e,t=r.sifter.search(e,Object.assign(o,{score:n})),r.currentResults=t):t=Object.assign({},r.currentResults),r.settings.hideSelected&&(t.items=t.items.filter(l=>{let d=it(l.id);return!(d&&r.items.indexOf(d)!==-1)})),t}refreshOptions(e=!0){var t,n,r,o,l,d,p,I,k,A;const D={},F=[];var w=this,P=w.inputValue();const _=P===w.lastQuery||P==""&&w.lastQuery==null;var B=w.search(P),M=null,X=w.settings.shouldOpen||!1,V=w.dropdown_content;_&&(M=w.activeOption,M&&(k=M.closest("[data-group]"))),o=B.items.length,typeof w.settings.maxOptions=="number"&&(o=Math.min(o,w.settings.maxOptions)),o>0&&(X=!0);const Z=(E,h)=>{let y=D[E];if(y!==void 0){let N=F[y];if(N!==void 0)return[y,N.fragment]}let g=document.createDocumentFragment();return y=F.length,F.push({fragment:g,order:h,optgroup:E}),[y,g]};for(t=0;t<o;t++){let E=B.items[t];if(!E)continue;let h=E.id,y=w.options[h];if(y===void 0)continue;let g=Ut(h),N=w.getOption(g,!0);for(w.settings.hideSelected||N.classList.toggle("selected",w.items.includes(g)),l=y[w.settings.optgroupField]||"",d=Array.isArray(l)?l:[l],n=0,r=d&&d.length;n<r;n++){l=d[n];let $=y.$order,W=w.optgroups[l];W===void 0?l="":$=W.$order;const[ae,se]=Z(l,$);n>0&&(N=N.cloneNode(!0),Fe(N,{id:y.$id+"-clone-"+n,"aria-selected":null}),N.classList.add("ts-cloned"),dt(N,"active"),w.activeOption&&w.activeOption.dataset.value==h&&k&&k.dataset.group===l.toString()&&(M=N)),se.appendChild(N),l!=""&&(D[l]=ae)}}w.settings.lockOptgroupOrder&&F.sort((E,h)=>E.order-h.order),p=document.createDocumentFragment(),Qe(F,E=>{let h=E.fragment,y=E.optgroup;if(!h||!h.children.length)return;let g=w.optgroups[y];if(g!==void 0){let N=document.createDocumentFragment(),$=w.render("optgroup_header",g);yt(N,$),yt(N,h);let W=w.render("optgroup",{group:g,options:N});yt(p,W)}else yt(p,h)}),V.innerHTML="",yt(V,p),w.settings.highlight&&(eo(V),B.query.length&&B.tokens.length&&Qe(B.tokens,E=>{Qr(V,E.regex)}));var O=E=>{let h=w.render(E,{input:P});return h&&(X=!0,V.insertBefore(h,V.firstChild)),h};if(w.loading?O("loading"):w.settings.shouldLoad.call(w,P)?B.items.length===0&&O("no_results"):O("not_loading"),I=w.canCreate(P),I&&(A=O("option_create")),w.hasOptions=B.items.length>0||I,X){if(B.items.length>0){if(!M&&w.settings.mode==="single"&&w.items[0]!=null&&(M=w.getOption(w.items[0])),!V.contains(M)){let E=0;A&&!w.settings.addPrecedence&&(E=1),M=w.selectable()[E]}}else A&&(M=A);e&&!w.isOpen&&(w.open(),w.scrollToOption(M,"auto")),w.setActiveOption(M)}else w.clearActiveOption(),e&&w.isOpen&&w.close(!1)}selectable(){return this.dropdown_content.querySelectorAll("[data-selectable]")}addOption(e,t=!1){const n=this;if(Array.isArray(e))return n.addOptions(e,t),!1;const r=it(e[n.settings.valueField]);return r===null||n.options.hasOwnProperty(r)?!1:(e.$order=e.$order||++n.order,e.$id=n.inputId+"-opt-"+e.$order,n.options[r]=e,n.lastQuery=null,t&&(n.userOptions[r]=t,n.trigger("option_add",r,e)),r)}addOptions(e,t=!1){Qe(e,n=>{this.addOption(n,t)})}registerOption(e){return this.addOption(e)}registerOptionGroup(e){var t=it(e[this.settings.optgroupValueField]);return t===null?!1:(e.$order=e.$order||++this.order,this.optgroups[t]=e,t)}addOptionGroup(e,t){var n;t[this.settings.optgroupValueField]=e,(n=this.registerOptionGroup(t))&&this.trigger("optgroup_add",n,t)}removeOptionGroup(e){this.optgroups.hasOwnProperty(e)&&(delete this.optgroups[e],this.clearCache(),this.trigger("optgroup_remove",e))}clearOptionGroups(){this.optgroups={},this.clearCache(),this.trigger("optgroup_clear")}updateOption(e,t){const n=this;var r,o;const l=it(e),d=it(t[n.settings.valueField]);if(l===null)return;const p=n.options[l];if(p==null)return;if(typeof d!="string")throw new Error("Value must be set in option data");const I=n.getOption(l),k=n.getItem(l);if(t.$order=t.$order||p.$order,delete n.options[l],n.uncacheValue(d),n.options[d]=t,I){if(n.dropdown_content.contains(I)){const A=n._render("option",t);Cn(I,A),n.activeOption===I&&n.setActiveOption(A)}I.remove()}k&&(o=n.items.indexOf(l),o!==-1&&n.items.splice(o,1,d),r=n._render("item",t),k.classList.contains("active")&&Je(r,"active"),Cn(k,r)),n.lastQuery=null}removeOption(e,t){const n=this;e=Ut(e),n.uncacheValue(e),delete n.userOptions[e],delete n.options[e],n.lastQuery=null,n.trigger("option_remove",e),n.removeItem(e,t)}clearOptions(e){const t=(e||this.clearFilter).bind(this);this.loadedSearches={},this.userOptions={},this.clearCache();const n={};Qe(this.options,(r,o)=>{t(r,o)&&(n[o]=r)}),this.options=this.sifter.items=n,this.lastQuery=null,this.trigger("option_clear")}clearFilter(e,t){return this.items.indexOf(t)>=0}getOption(e,t=!1){const n=it(e);if(n===null)return null;const r=this.options[n];if(r!=null){if(r.$div)return r.$div;if(t)return this._render("option",r)}return null}getAdjacent(e,t,n="option"){var r=this,o;if(!e)return null;n=="item"?o=r.controlChildren():o=r.dropdown_content.querySelectorAll("[data-selectable]");for(let l=0;l<o.length;l++)if(o[l]==e)return t>0?o[l+1]:o[l-1];return null}getItem(e){if(typeof e=="object")return e;var t=it(e);return t!==null?this.control.querySelector(`[data-value="${di(t)}"]`):null}addItems(e,t){var n=this,r=Array.isArray(e)?e:[e];r=r.filter(l=>n.items.indexOf(l)===-1);const o=r[r.length-1];r.forEach(l=>{n.isPending=l!==o,n.addItem(l,t)})}addItem(e,t){var n=t?[]:["change","dropdown_close"];ui(this,n,()=>{var r,o;const l=this,d=l.settings.mode,p=it(e);if(!(p&&l.items.indexOf(p)!==-1&&(d==="single"&&l.close(),d==="single"||!l.settings.duplicates))&&!(p===null||!l.options.hasOwnProperty(p))&&(d==="single"&&l.clear(t),!(d==="multi"&&l.isFull()))){if(r=l._render("item",l.options[p]),l.control.contains(r)&&(r=r.cloneNode(!0)),o=l.isFull(),l.items.splice(l.caretPos,0,p),l.insertAtCaret(r),l.isSetup){if(!l.isPending&&l.settings.hideSelected){let I=l.getOption(p),k=l.getAdjacent(I,1);k&&l.setActiveOption(k)}!l.isPending&&!l.settings.closeAfterSelect&&l.refreshOptions(l.isFocused&&d!=="single"),l.settings.closeAfterSelect!=!1&&l.isFull()?l.close():l.isPending||l.positionDropdown(),l.trigger("item_add",p,r),l.isPending||l.updateOriginalInput({silent:t})}(!l.isPending||!o&&l.isFull())&&(l.inputState(),l.refreshState())}})}removeItem(e=null,t){const n=this;if(e=n.getItem(e),!e)return;var r,o;const l=e.dataset.value;r=Zt(e),e.remove(),e.classList.contains("active")&&(o=n.activeItems.indexOf(e),n.activeItems.splice(o,1),dt(e,"active")),n.items.splice(r,1),n.lastQuery=null,!n.settings.persist&&n.userOptions.hasOwnProperty(l)&&n.removeOption(l,t),r<n.caretPos&&n.setCaret(n.caretPos-1),n.updateOriginalInput({silent:t}),n.refreshState(),n.positionDropdown(),n.trigger("item_remove",l,e)}createItem(e=null,t=()=>{}){arguments.length===3&&(t=arguments[2]),typeof t!="function"&&(t=()=>{});var n=this,r=n.caretPos,o;if(e=e||n.inputValue(),!n.canCreate(e))return t(),!1;n.lock();var l=!1,d=p=>{if(n.unlock(),!p||typeof p!="object")return t();var I=it(p[n.settings.valueField]);if(typeof I!="string")return t();n.setTextboxValue(),n.addOption(p,!0),n.setCaret(r),n.addItem(I),t(p),l=!0};return typeof n.settings.create=="function"?o=n.settings.create.call(this,e,d):o={[n.settings.labelField]:e,[n.settings.valueField]:e},l||d(o),!0}refreshItems(){var e=this;e.lastQuery=null,e.isSetup&&e.addItems(e.items),e.updateOriginalInput(),e.refreshState()}refreshState(){const e=this;e.refreshValidityState();const t=e.isFull(),n=e.isLocked;e.wrapper.classList.toggle("rtl",e.rtl);const r=e.wrapper.classList;r.toggle("focus",e.isFocused),r.toggle("disabled",e.isDisabled),r.toggle("readonly",e.isReadOnly),r.toggle("required",e.isRequired),r.toggle("invalid",!e.isValid),r.toggle("locked",n),r.toggle("full",t),r.toggle("input-active",e.isFocused&&!e.isInputHidden),r.toggle("dropdown-active",e.isOpen),r.toggle("has-options",Jr(e.options)),r.toggle("has-items",e.items.length>0)}refreshValidityState(){var e=this;e.input.validity&&(e.isValid=e.input.validity.valid,e.isInvalid=!e.isValid)}isFull(){return this.settings.maxItems!==null&&this.items.length>=this.settings.maxItems}updateOriginalInput(e={}){const t=this;var n,r;const o=t.input.querySelector('option[value=""]');if(t.is_select_tag){let p=function(I,k,A){return I||(I=We('<option value="'+jt(k)+'">'+jt(A)+"</option>")),I!=o&&t.input.append(I),l.push(I),(I!=o||d>0)&&(I.selected=!0),I};const l=[],d=t.input.querySelectorAll("option:checked").length;t.input.querySelectorAll("option:checked").forEach(I=>{I.selected=!1}),t.items.length==0&&t.settings.mode=="single"?p(o,"",""):t.items.forEach(I=>{if(n=t.options[I],r=n[t.settings.labelField]||"",l.includes(n.$option)){const k=t.input.querySelector(`option[value="${di(I)}"]:not(:checked)`);p(k,I,r)}else n.$option=p(n.$option,I,r)})}else t.input.value=t.getValue();t.isSetup&&(e.silent||t.trigger("change",t.getValue()))}open(){var e=this;e.isLocked||e.isOpen||e.settings.mode==="multi"&&e.isFull()||(e.isOpen=!0,Fe(e.focus_node,{"aria-expanded":"true"}),e.refreshState(),Pt(e.dropdown,{visibility:"hidden",display:"block"}),e.positionDropdown(),Pt(e.dropdown,{visibility:"visible",display:"block"}),e.focus(),e.trigger("dropdown_open",e.dropdown))}close(e=!0){var t=this,n=t.isOpen;e&&(t.setTextboxValue(),t.settings.mode==="single"&&t.items.length&&t.inputState()),t.isOpen=!1,Fe(t.focus_node,{"aria-expanded":"false"}),Pt(t.dropdown,{display:"none"}),t.settings.hideSelected&&t.clearActiveOption(),t.refreshState(),n&&t.trigger("dropdown_close",t.dropdown)}positionDropdown(){if(this.settings.dropdownParent==="body"){var e=this.control,t=e.getBoundingClientRect(),n=e.offsetHeight+t.top+window.scrollY,r=t.left+window.scrollX;Pt(this.dropdown,{width:t.width+"px",top:n+"px",left:r+"px"})}}clear(e){var t=this;if(t.items.length){var n=t.controlChildren();Qe(n,r=>{t.removeItem(r,!0)}),t.inputState(),e||t.updateOriginalInput(),t.trigger("clear")}}insertAtCaret(e){const t=this,n=t.caretPos,r=t.control;r.insertBefore(e,r.children[n]||null),t.setCaret(n+1)}deleteSelection(e){var t,n,r,o,l=this;t=e&&e.keyCode===li?-1:1,n=co(l.control_input);const d=[];if(l.activeItems.length)o=si(l.activeItems,t),r=Zt(o),t>0&&r++,Qe(l.activeItems,p=>d.push(p));else if((l.isFocused||l.settings.mode==="single")&&l.items.length){const p=l.controlChildren();let I;t<0&&n.start===0&&n.length===0?I=p[l.caretPos-1]:t>0&&n.start===l.inputValue().length&&(I=p[l.caretPos]),I!==void 0&&d.push(I)}if(!l.shouldDelete(d,e))return!1;for(Ae(e,!0),typeof r<"u"&&l.setCaret(r);d.length;)l.removeItem(d.pop());return l.inputState(),l.positionDropdown(),l.refreshOptions(!1),!0}shouldDelete(e,t){const n=e.map(r=>r.dataset.value);return!(!n.length||typeof this.settings.onDelete=="function"&&this.settings.onDelete(n,t)===!1)}advanceSelection(e,t){var n,r,o=this;o.rtl&&(e*=-1),!o.inputValue().length&&(mt($t,t)||mt("shiftKey",t)?(n=o.getLastActive(e),n?n.classList.contains("active")?r=o.getAdjacent(n,e,"item"):r=n:e>0?r=o.control_input.nextElementSibling:r=o.control_input.previousElementSibling,r&&(r.classList.contains("active")&&o.removeActiveItem(n),o.setActiveItemClass(r))):o.moveCaret(e))}moveCaret(e){}getLastActive(e){let t=this.control.querySelector(".last-active");if(t)return t;var n=this.control.querySelectorAll(".active");if(n)return si(n,e)}setCaret(e){this.caretPos=this.items.length}controlChildren(){return Array.from(this.control.querySelectorAll("[data-ts-item]"))}lock(){this.setLocked(!0)}unlock(){this.setLocked(!1)}setLocked(e=this.isReadOnly||this.isDisabled){this.isLocked=e,this.refreshState()}disable(){this.setDisabled(!0),this.close()}enable(){this.setDisabled(!1)}setDisabled(e){this.focus_node.tabIndex=e?-1:this.tabIndex,this.isDisabled=e,this.input.disabled=e,this.control_input.disabled=e,this.setLocked()}setReadOnly(e){this.isReadOnly=e,this.input.readOnly=e,this.control_input.readOnly=e,this.setLocked()}destroy(){var e=this,t=e.revertSettings;e.trigger("destroy"),e.off(),e.wrapper.remove(),e.dropdown.remove(),e.input.innerHTML=t.innerHTML,e.input.tabIndex=t.tabIndex,dt(e.input,"tomselected","ts-hidden-accessible"),e._destroy(),delete e.input.tomselect}render(e,t){var n,r;const o=this;if(typeof this.settings.render[e]!="function"||(r=o.settings.render[e].call(this,t,jt),!r))return null;if(r=We(r),e==="option"||e==="option_create"?t[o.settings.disabledField]?Fe(r,{"aria-disabled":"true"}):Fe(r,{"data-selectable":""}):e==="optgroup"&&(n=t.group[o.settings.optgroupValueField],Fe(r,{"data-group":n}),t.group[o.settings.disabledField]&&Fe(r,{"data-disabled":""})),e==="option"||e==="item"){const l=Ut(t[o.settings.valueField]);Fe(r,{"data-value":l}),e==="item"?(Je(r,o.settings.itemClass),Fe(r,{"data-ts-item":""})):(Je(r,o.settings.optionClass),Fe(r,{role:"option",id:t.$id}),t.$div=r,o.options[l]=t)}return r}_render(e,t){const n=this.render(e,t);if(n==null)throw"HTMLElement expected";return n}clearCache(){Qe(this.options,e=>{e.$div&&(e.$div.remove(),delete e.$div)})}uncacheValue(e){const t=this.getOption(e);t&&t.remove()}canCreate(e){return this.settings.create&&e.length>0&&this.settings.createFilter.call(this,e)}hook(e,t,n){var r=this,o=r[t];r[t]=function(){var l,d;return e==="after"&&(l=o.apply(r,arguments)),d=n.apply(r,arguments),e==="instead"?d:(e==="before"&&(l=o.apply(r,arguments)),l)}}}function uo(){Pe(this.input,"change",()=>{this.sync()})}function fo(i){var e=this,t=e.onOptionSelect;e.settings.hideSelected=!1;const n=Object.assign({className:"tomselect-checkbox",checkedClassNames:void 0,uncheckedClassNames:void 0},i);var r=function(d,p){p?(d.checked=!0,n.uncheckedClassNames&&d.classList.remove(...n.uncheckedClassNames),n.checkedClassNames&&d.classList.add(...n.checkedClassNames)):(d.checked=!1,n.checkedClassNames&&d.classList.remove(...n.checkedClassNames),n.uncheckedClassNames&&d.classList.add(...n.uncheckedClassNames))},o=function(d){setTimeout(()=>{var p=d.querySelector("input."+n.className);p instanceof HTMLInputElement&&r(p,d.classList.contains("selected"))},1)};e.hook("after","setupTemplates",()=>{var l=e.settings.render.option;e.settings.render.option=(d,p)=>{var I=We(l.call(e,d,p)),k=document.createElement("input");n.className&&k.classList.add(n.className),k.addEventListener("click",function(D){Ae(D)}),k.type="checkbox";const A=it(d[e.settings.valueField]);return r(k,!!(A&&e.items.indexOf(A)>-1)),I.prepend(k),I}}),e.on("item_remove",l=>{var d=e.getOption(l);d&&(d.classList.remove("selected"),o(d))}),e.on("item_add",l=>{var d=e.getOption(l);d&&o(d)}),e.hook("instead","onOptionSelect",(l,d)=>{if(d.classList.contains("selected")){d.classList.remove("selected"),e.removeItem(d.dataset.value),e.refreshOptions(),Ae(l,!0);return}t.call(e,l,d),o(d)})}function po(i){const e=this,t=Object.assign({className:"clear-button",title:"Clear All",html:n=>`<div class="${n.className}" title="${n.title}">&#10799;</div>`},i);e.on("initialize",()=>{var n=We(t.html(t));n.addEventListener("click",r=>{e.isLocked||(e.clear(),e.settings.mode==="single"&&e.settings.allowEmptyOption&&e.addItem(""),r.preventDefault(),r.stopPropagation())}),e.control.appendChild(n)})}const ho=(i,e)=>{var t;(t=i.parentNode)==null||t.insertBefore(e,i.nextSibling)},go=(i,e)=>{var t;(t=i.parentNode)==null||t.insertBefore(e,i)},mo=(i,e)=>{do{var t;if(e=(t=e)==null?void 0:t.previousElementSibling,i==e)return!0}while(e&&e.previousElementSibling);return!1};function yo(){var i=this;if(i.settings.mode!=="multi")return;var e=i.lock,t=i.unlock;let n=!0,r;i.hook("after","setupTemplates",()=>{var o=i.settings.render.item;i.settings.render.item=(l,d)=>{const p=We(o.call(i,l,d));Fe(p,{draggable:"true"});const I=P=>{n||Ae(P),P.stopPropagation()},k=P=>{r=p,setTimeout(()=>{p.classList.add("ts-dragging")},0)},A=P=>{P.preventDefault(),p.classList.add("ts-drag-over"),F(p,r)},D=()=>{p.classList.remove("ts-drag-over")},F=(P,_)=>{_!==void 0&&(mo(_,p)?ho(P,_):go(P,_))},w=()=>{var P;document.querySelectorAll(".ts-drag-over").forEach(B=>B.classList.remove("ts-drag-over")),(P=r)==null||P.classList.remove("ts-dragging"),r=void 0;var _=[];i.control.querySelectorAll("[data-value]").forEach(B=>{if(B.dataset.value){let M=B.dataset.value;M&&_.push(M)}}),i.setValue(_)};return Pe(p,"mousedown",I),Pe(p,"dragstart",k),Pe(p,"dragenter",A),Pe(p,"dragover",A),Pe(p,"dragleave",D),Pe(p,"dragend",w),p}}),i.hook("instead","lock",()=>(n=!1,e.call(i))),i.hook("instead","unlock",()=>(n=!0,t.call(i)))}function vo(i){const e=this,t=Object.assign({title:"Untitled",headerClass:"dropdown-header",titleRowClass:"dropdown-header-title",labelClass:"dropdown-header-label",closeClass:"dropdown-header-close",html:n=>'<div class="'+n.headerClass+'"><div class="'+n.titleRowClass+'"><span class="'+n.labelClass+'">'+n.title+'</span><a class="'+n.closeClass+'">&times;</a></div></div>'},i);e.on("initialize",()=>{var n=We(t.html(t)),r=n.querySelector("."+t.closeClass);r&&r.addEventListener("click",o=>{Ae(o,!0),e.close()}),e.dropdown.insertBefore(n,e.dropdown.firstChild)})}function Io(){var i=this;i.hook("instead","setCaret",e=>{i.settings.mode==="single"||!i.control.contains(i.control_input)?e=i.items.length:(e=Math.max(0,Math.min(i.items.length,e)),e!=i.caretPos&&!i.isPending&&i.controlChildren().forEach((t,n)=>{n<e?i.control_input.insertAdjacentElement("beforebegin",t):i.control.appendChild(t)})),i.caretPos=e}),i.hook("instead","moveCaret",e=>{if(!i.isFocused)return;const t=i.getLastActive(e);if(t){const n=Zt(t);i.setCaret(e>0?n+1:n),i.setActiveItem(),dt(t,"last-active")}else i.setCaret(i.caretPos+e)})}function Eo(){const i=this;i.settings.shouldOpen=!0,i.hook("before","setup",()=>{i.focus_node=i.control,Je(i.control_input,"dropdown-input");const e=We('<div class="dropdown-input-wrap">');e.append(i.control_input),i.dropdown.insertBefore(e,i.dropdown.firstChild);const t=We('<input class="items-placeholder" tabindex="-1" />');t.placeholder=i.settings.placeholder||"",i.control.append(t)}),i.on("initialize",()=>{i.control_input.addEventListener("keydown",t=>{switch(t.keyCode){case Mi:i.isOpen&&(Ae(t,!0),i.close()),i.clearActiveItems();return;case An:i.focus_node.tabIndex=-1;break}return i.onKeyDown.call(i,t)}),i.on("blur",()=>{i.focus_node.tabIndex=i.isDisabled?-1:i.tabIndex}),i.on("dropdown_open",()=>{i.control_input.focus()});const e=i.onBlur;i.hook("instead","onBlur",t=>{if(!(t&&t.relatedTarget==i.control_input))return e.call(i)}),Pe(i.control_input,"blur",()=>i.onBlur()),i.hook("before","close",()=>{i.isOpen&&i.focus_node.focus({preventScroll:!0})})})}function wo(){var i=this;i.on("initialize",()=>{var e=document.createElement("span"),t=i.control_input;e.style.cssText="position:absolute; top:-99999px; left:-99999px; width:auto; padding:0; white-space:pre; ",i.wrapper.appendChild(e);var n=["letterSpacing","fontSize","fontFamily","fontWeight","textTransform"];for(const o of n)e.style[o]=t.style[o];var r=()=>{e.textContent=t.value,t.style.width=e.clientWidth+"px"};r(),i.on("update item_add item_remove",r),Pe(t,"input",r),Pe(t,"keyup",r),Pe(t,"blur",r),Pe(t,"update",r)})}function bo(){var i=this,e=i.deleteSelection;this.hook("instead","deleteSelection",t=>i.activeItems.length?e.call(i,t):!1)}function So(){this.hook("instead","setActiveItem",()=>{}),this.hook("instead","selectAll",()=>{})}function To(){var i=this,e=i.onKeyDown;i.hook("instead","onKeyDown",t=>{var n,r,o,l;if(!i.isOpen||!(t.keyCode===Dn||t.keyCode===Pi))return e.call(i,t);i.ignoreHover=!0,l=Vt(i.activeOption,"[data-group]"),n=Zt(i.activeOption,"[data-selectable]"),l&&(t.keyCode===Dn?l=l.previousSibling:l=l.nextSibling,l&&(o=l.querySelectorAll("[data-selectable]"),r=o[Math.min(o.length-1,n)],r&&i.setActiveOption(r)))})}function No(i){const e=Object.assign({label:"&times;",title:"Remove",className:"remove",append:!0},i);var t=this;if(e.append){var n='<a href="javascript:void(0)" class="'+e.className+'" tabindex="-1" title="'+jt(e.title)+'">'+e.label+"</a>";t.hook("after","setupTemplates",()=>{var r=t.settings.render.item;t.settings.render.item=(o,l)=>{var d=We(r.call(t,o,l)),p=We(n);return d.appendChild(p),Pe(p,"mousedown",I=>{Ae(I,!0)}),Pe(p,"click",I=>{t.isLocked||(Ae(I,!0),!t.isLocked&&t.shouldDelete([d],I)&&(t.removeItem(d),t.refreshOptions(!1),t.inputState()))}),d}})}}function Oo(i){const e=this,t=Object.assign({text:n=>n[e.settings.labelField]},i);e.on("item_remove",function(n){if(e.isFocused&&e.control_input.value.trim()===""){var r=e.options[n];r&&e.setTextboxValue(t.text.call(e,r))}})}function ko(){const i=this,e=i.canLoad,t=i.clearActiveOption,n=i.loadCallback;var r={},o,l=!1,d,p=[];if(i.settings.shouldLoadMore||(i.settings.shouldLoadMore=()=>{if(o.clientHeight/(o.scrollHeight-o.scrollTop)>.9)return!0;if(i.activeOption){var D=i.selectable(),F=Array.from(D).indexOf(i.activeOption);if(F>=D.length-2)return!0}return!1}),!i.settings.firstUrl)throw"virtual_scroll plugin requires a firstUrl() method";i.settings.sortField=[{field:"$order"},{field:"$score"}];const I=A=>typeof i.settings.maxOptions=="number"&&o.children.length>=i.settings.maxOptions?!1:!!(A in r&&r[A]),k=(A,D)=>i.items.indexOf(D)>=0||p.indexOf(D)>=0;i.setNextUrl=(A,D)=>{r[A]=D},i.getUrl=A=>{if(A in r){const D=r[A];return r[A]=!1,D}return i.clearPagination(),i.settings.firstUrl.call(i,A)},i.clearPagination=()=>{r={}},i.hook("instead","clearActiveOption",()=>{if(!l)return t.call(i)}),i.hook("instead","canLoad",A=>A in r?I(A):e.call(i,A)),i.hook("instead","loadCallback",(A,D)=>{if(!l)i.clearOptions(k);else if(d){const F=A[0];F!==void 0&&(d.dataset.value=F[i.settings.valueField])}n.call(i,A,D),l=!1}),i.hook("after","refreshOptions",()=>{const A=i.lastValue;var D;I(A)?(D=i.render("loading_more",{query:A}),D&&(D.setAttribute("data-selectable",""),d=D)):A in r&&!o.querySelector(".no-results")&&(D=i.render("no_more_results",{query:A})),D&&(Je(D,i.settings.optionClass),o.append(D))}),i.on("initialize",()=>{p=Object.keys(i.options),o=i.dropdown_content,i.settings.render=Object.assign({},{loading_more:()=>'<div class="loading-more-results">Loading more results ... </div>',no_more_results:()=>'<div class="no-more-results">No more results</div>'},i.settings.render),o.addEventListener("scroll",()=>{i.settings.shouldLoadMore.call(i)&&I(i.lastValue)&&(l||(l=!0,i.load.call(i,i.lastValue)))})})}et.define("change_listener",uo);et.define("checkbox_options",fo);et.define("clear_button",po);et.define("drag_drop",yo);et.define("dropdown_header",vo);et.define("caret_position",Io);et.define("dropdown_input",Eo);et.define("input_autogrow",wo);et.define("no_backspace_delete",bo);et.define("no_active_items",So);et.define("optgroup_columns",To);et.define("remove_button",No);et.define("restore_on_backspace",Oo);et.define("virtual_scroll",ko);async function _o(i){if(!b.sceneReady)return;const t=(await C.scene.local.getItems(r=>r.layer==="CHARACTER"))?.map(r=>r.id);let n=!1;for(const r of i){const o=r.metadata[`${f.SPECTREID}/metadata_ghosts`];if(o?.length>0){n=!0;const l=o.map(p=>p.id);for(const p of o){const I=p.metadata[`${f.SPECTREID}/viewers`];I&&(I.includes(b.playerId)?await C.scene.local.addItems([p]):t.includes(p.id)&&await C.scene.local.deleteItems([p.id]))}const d=t.filter(p=>!l.includes(p));d?.length>0&&await C.scene.local.deleteItems(d)}}n||await C.scene.local.deleteItems(t)}function xo(){const i=document.querySelectorAll(".tSelects");for(const e of i)if(e&&e.tomselect){const t=e.tomselect,n=[];for(const r of b.party)n.push({value:r.id,text:r.name});t.clearOptions(),t.addOption(n),n.length===0?(t.settings.placeholder="No Players",t.inputState()):(t.settings.placeholder="Choose..",t.inputState())}}async function Co(){let i=b.sceneMetadata[`${f.SPECTREID}/stored`];i&&(await C.scene.local.addItems(i),i.forEach(e=>{Ri(e)}))}async function hi(){C.scene.local.onChange(async i=>{const e=i.filter(n=>n.layer=="CHARACTER");if(e.length===0)return;const t={};t[`${f.SPECTREID}/metadata_ghosts`]=e,await C.player.setMetadata(t)}),await C.contextMenu.create({id:`${f.SPECTREID}/context-menu`,icons:[{icon:"/ghost.svg",label:"Spectre",filter:{every:[{key:"layer",value:"CHARACTER"},{key:["metadata",`${f.SPECTREID}/spectred`],value:void 0,operator:"==",coordinator:"&&"}]}},{icon:"/ghost.svg",label:"Un-Spectre",filter:{every:[{key:"layer",value:"CHARACTER"},{key:["metadata",`${f.SPECTREID}/spectred`],value:void 0,operator:"!=",coordinator:"&&"}]}}],async onClick(i){if(i.items.every(t=>t.metadata[`${f.SPECTREID}/spectred`]===void 0)){document.getElementById("spectreWarning").style.display="none";for(const t of i.items)Ri(t)}else for(const t of i.items){const n=t;n.metadata[`${f.SPECTREID}/spectred`]=void 0;const r=b.ghosts.findIndex(l=>l.id===n.id);b.ghosts.splice(r,1),document.getElementById(`tr-${n.id}`)?.remove(),await $i(n),n.metadata[`${f.SPECTREID}/viewers`]=[],await C.scene.items.addItems([n])}}})}async function $i(i){const t=b.sceneMetadata[`${f.SPECTREID}/stored`].filter(n=>n.id!==i.id);await C.scene.setMetadata({[`${f.SPECTREID}/stored`]:t}),await C.scene.local.deleteItems([i.id])}async function Do(i){let e=b.sceneMetadata[`${f.SPECTREID}/stored`];if(!e)e=[i];else{if(e.find(n=>n.id===i.id))return;e.push(i)}await C.scene.setMetadata({[`${f.SPECTREID}/stored`]:e})}async function Ri(i){const e=i.text?.plainText||i.name;i.metadata[`${f.SPECTREID}/spectred`]=!0,await C.scene.items.deleteItems([i.id]),await C.scene.local.addItems([i]),await Do(i),b.ghosts.push(i);const t=document.getElementById("ghostList"),n=document.createElement("tr");n.id=`tr-${i.id}`,n.className="ghost-table-entry",n.innerHTML=`<td class="token-name">${e}</td>
        <td><select id="select-${i.id}" class="tSelects" multiple autocomplete="off" /></td>
        <td><input type="button" class="mysteryButton" id="deleteGhost-${i.id}" value="Delete"/></td>`,t.appendChild(n);const r=document.getElementById(`select-${i.id}`);for(const d of b.party){const p=document.createElement("option");p.value=d.id,p.text=d.name,r.appendChild(p)}const o={plugins:{remove_button:{title:"Remove this item"}},allowEmptyOption:!0,placeholder:b.party.length==0?"No Players":"Choose..",maxItems:null,create:!1,onDelete:async function(d,p){const I=p.currentTarget.parentElement.parentElement.parentElement.parentElement.parentElement.id.slice(3);await C.scene.local.updateItems([I],k=>{const A=k[0].metadata[`${f.SPECTREID}/viewers`],D=A.findIndex(F=>F==d);A.splice(D,1),k[0].metadata[`${f.SPECTREID}/viewers`]=A})},onItemAdd:async function(d,p){const I=p.parentElement.parentElement.parentElement.parentElement.id.slice(3);await C.scene.local.updateItems([I],k=>{const A=k[0].metadata[`${f.SPECTREID}/viewers`];A?(A.push(d),k[0].metadata[`${f.SPECTREID}/viewers`]=A):k[0].metadata[`${f.SPECTREID}/viewers`]=[d]})}};new et(`#select-${i.id}`,o);const l=document.getElementById(`deleteGhost-${i.id}`);l.onclick=async()=>{const d=b.ghosts.findIndex(p=>p.id===i.id);b.ghosts.splice(d,1),n.remove(),await C.scene.local.updateItems([i.id],p=>{p[0].metadata[`${f.SPECTREID}/viewers`]=[]}),await $i(i)}}async function gi(){await C.contextMenu.create({id:`${f.EXTENSIONID}/toggle-vision-menu`,icons:[{icon:"/no-vision.svg",label:"Enable Vision",filter:{every:[{key:["metadata",`${f.EXTENSIONID}/hasVision`],operator:"==",value:void 0,coordinator:"&&"},{key:["metadata",`${f.SPECTREID}/spectred`],operator:"==",value:void 0}],some:[{key:"layer",value:"CHARACTER",coordinator:"||"},{key:"layer",value:"ATTACHMENT"}]}},{icon:"/icon.svg",label:"Disable Vision",filter:{every:[{key:["metadata",`${f.SPECTREID}/spectred`],operator:"==",value:void 0}],some:[{key:"layer",value:"CHARACTER",coordinator:"||"},{key:"layer",value:"ATTACHMENT"}]}}],async onClick(i){const e=i.items.every(t=>t.metadata[`${f.EXTENSIONID}/hasVision`]===void 0);await C.scene.items.updateItems(i.items,t=>{for(const n of t)e?(n.metadata[`${f.EXTENSIONID}/hasVision`]=!0,n.metadata[`${f.EXTENSIONID}/visionRange`]===void 0&&(n.metadata[`${f.EXTENSIONID}/visionRange`]=f.VISIONDEFAULT)):delete n.metadata[`${f.EXTENSIONID}/hasVision`]})}}),await C.contextMenu.create({id:`${f.EXTENSIONID}/toggle-groupvision-menu`,icons:[{icon:"/no-vision.svg",label:"Toggle Attachments Vision",filter:{every:[{key:"layer",value:"NOTE"},{key:["metadata",`${f.EXTENSIONID}/hasVision`],value:void 0}]}}],async onClick(i){if(i.items.length>0){const e=i.items.map(n=>n.id),t=await C.scene.items.getItemAttachments(e);await C.scene.items.updateItems(t,n=>{for(const r of n)e.includes(r.attachedTo)&&(r.metadata[`${f.EXTENSIONID}/hasVision`]&&(r.layer=="CHARACTER"||r.layer=="ATTACHMENT")?delete r.metadata[`${f.EXTENSIONID}/hasVision`]:(r.layer=="CHARACTER"||r.layer=="ATTACHMENT")&&(r.metadata[`${f.EXTENSIONID}/hasVision`]=!0,r.metadata[`${f.EXTENSIONID}/visionRange`]===void 0&&(r.metadata[`${f.EXTENSIONID}/visionRange`]=f.VISIONDEFAULT)))})}}}),await C.contextMenu.create({id:`${f.EXTENSIONID}/toggle-vision-line`,icons:[{icon:"/icon.svg",label:"Disable Vision Line",filter:{some:[{key:["metadata",`${f.EXTENSIONID}/isVisionLine`],value:!0,coordinator:"&&"},{key:["metadata",`${f.EXTENSIONID}/disabled`],value:void 0,coordinator:"||"},{key:["metadata",`${f.ARMINDOID}/isVisionLine`],value:!0,coordinator:"&&"},{key:["metadata",`${f.ARMINDOID}/disabled`],value:void 0}]}},{icon:"/no-vision.svg",label:"Enable Vision Line",filter:{some:[{key:["metadata",`${f.EXTENSIONID}/isVisionLine`],value:!0,coordinator:"||"},{key:["metadata",`${f.ARMINDOID}/isVisionLine`],value:!0}]}}],async onClick(i){await C.scene.items.updateItems(i.items,e=>{for(const t of e)t.metadata[`${f.EXTENSIONID}/isVisionLine`]&&t.metadata[`${f.EXTENSIONID}/disabled`]?delete t.metadata[`${f.EXTENSIONID}/disabled`]:t.metadata[`${f.EXTENSIONID}/isVisionLine`]&&(t.metadata[`${f.EXTENSIONID}/disabled`]=!0)})}}),await C.contextMenu.create({id:`${f.EXTENSIONID}/switch-one-sided-type`,icons:[{icon:"/two-sided.svg",label:"Two-sided",filter:{some:[{key:["metadata",`${f.EXTENSIONID}/isVisionLine`],value:!0,coordinator:"&&"},{key:["metadata",`${f.EXTENSIONID}/oneSided`],value:void 0,coordinator:"||"},{key:["metadata",`${f.ARMINDOID}/isVisionLine`],value:!0,coordinator:"&&"},{key:["metadata",`${f.ARMINDOID}/oneSided`],value:void 0}]}},{icon:"/left-sided.svg",label:"One-sided left",filter:{some:[{key:["metadata",`${f.EXTENSIONID}/isVisionLine`],value:!0,coordinator:"&&"},{key:["metadata",`${f.EXTENSIONID}/oneSided`],value:"left",coordinator:"||"},{key:["metadata",`${f.ARMINDOID}/isVisionLine`],value:!0,coordinator:"&&"},{key:["metadata",`${f.ARMINDOID}/oneSided`],value:"left"}]}},{icon:"/right-sided.svg",label:"One-sided right",filter:{some:[{key:["metadata",`${f.EXTENSIONID}/isVisionLine`],value:!0,coordinator:"||"},{key:["metadata",`${f.ARMINDOID}/isVisionLine`],value:!0}]}}],async onClick(i){await C.scene.items.updateItems(i.items,e=>{for(const t of e)(t.metadata[`${f.EXTENSIONID}/isVisionLine`]||t.metadata[`${f.ARMINDOID}/isVisionLine`])&&(t.metadata[`${f.EXTENSIONID}/oneSided`]=="right"||t.metadata[`${f.ARMINDOID}/oneSided`]=="right")?(delete t.metadata[`${f.EXTENSIONID}/oneSided`],delete t.metadata[`${f.ARMINDOID}/oneSided`]):(t.metadata[`${f.EXTENSIONID}/isVisionLine`]||t.metadata[`${f.ARMINDOID}/isVisionLine`])&&(t.metadata[`${f.EXTENSIONID}/oneSided`]=="left"||t.metadata[`${f.ARMINDOID}/oneSided`]=="left")?(t.metadata[`${f.EXTENSIONID}/oneSided`]="right",t.metadata[`${f.ARMINDOID}/oneSided`]="right"):(t.metadata[`${f.EXTENSIONID}/isVisionLine`]||t.metadata[`${f.ARMINDOID}/isVisionLine`])&&(t.metadata[`${f.EXTENSIONID}/oneSided`]="left",t.metadata[`${f.ARMINDOID}/oneSided`]="left")})}}),await C.contextMenu.create({id:`${f.EXTENSIONID}/toggle-fog-background`,icons:[{icon:"/fog-background.svg",label:"Convert To Fog Background",filter:{every:[{key:"layer",value:"MAP"}]}}],async onClick(i){i.items.length>0&&await C.scene.items.updateItems(i.items,e=>{for(let t=0;t<e.length;t++)e[t].zIndex=1,e[t].layer="FOG",e[t].disableHit=!0,e[t].locked=!1,e[t].visible=!1,e[t].metadata[`${f.EXTENSIONID}/isBackgroundMap`]=!0})}}),await C.contextMenu.create({id:`${f.EXTENSIONID}/bounding-grid`,icons:[{icon:"/icon.svg",label:"Smoke Bounding Grid",filter:{every:[{key:["metadata",`${f.EXTENSIONID}/grid`],value:!0}]}}],async onClick(i){await C.notification.show("This is the Smoke&Spectre Bounding Grid. It contains the area your fog can be drawn in. To remove this and have fog contained dynamically by the size of your map(s), turn on AutoDetect Maps in Settings.","INFO")}}),await C.contextMenu.create({id:`${f.EXTENSIONID}/toggle-door`,icons:[{icon:"/opendoor.svg",label:"Enable Door",filter:{every:[{key:"layer",value:"DRAWING"},{key:["metadata",`${f.EXTENSIONID}/isDoor`],value:void 0},{key:["metadata",`${f.EXTENSIONID}/doorId`],value:void 0},{key:["metadata",`${f.EXTENSIONID}/grid`],value:void 0}],roles:["GM"]}},{icon:"/closedoor.svg",label:"Disable Door",filter:{every:[{key:"layer",value:"DRAWING"},{key:["metadata",`${f.EXTENSIONID}/doorId`],value:void 0},{key:["metadata",`${f.EXTENSIONID}/grid`],value:void 0}],roles:["GM"]}}],async onClick(i){const e=i.items.every(t=>t.metadata[`${f.EXTENSIONID}/isDoor`]===void 0);await C.scene.items.updateItems(i.items,t=>{for(const n of t)e?n.metadata[`${f.EXTENSIONID}/isDoor`]=!0:delete n.metadata[`${f.EXTENSIONID}/isDoor`]}),e?await zt(i.items):await wr(i.items)}})}async function Jt(i){i?await C.contextMenu.create({id:`${f.EXTENSIONID}/toggle-autohide-menu`,icons:[{icon:"/autohide-off.svg",label:"Enable Autohide",filter:{every:[{key:"layer",value:"CHARACTER"},{key:["metadata",`${f.EXTENSIONID}/hasAutohide`],value:void 0}],roles:["GM"]}},{icon:"/autohide-on.svg",label:"Disable Autohide",filter:{every:[{key:"layer",value:"CHARACTER"}],roles:["GM"]}}],async onClick(e){const t=e.items.every(n=>n.metadata[`${f.EXTENSIONID}/hasAutohide`]===void 0);await C.scene.items.updateItems(e.items,n=>{for(const r of n)t?r.metadata[`${f.EXTENSIONID}/hasAutohide`]=!0:delete r.metadata[`${f.EXTENSIONID}/hasAutohide`]})}}):await C.contextMenu.remove(`${f.EXTENSIONID}/toggle-autohide-menu`)}async function Mn(){await C.scene.items.deleteItems(b.sceneItems.filter(wt).map(e=>e.id)),Jt(b.sceneMetadata[`${f.EXTENSIONID}/fowEnabled`]==!0);let i;if(b.sceneItems.filter(ia).length==0){const e=b.sceneItems.filter(n=>n.layer=="MAP"&&Wt(n)),t=e.map(n=>n.image.width*n.image.height/Math.pow(n.grid.dpi,2));i=e[t.indexOf(Math.max(...t))]}if(b.sceneMetadata[`${f.EXTENSIONID}/autodetectEnabled`]===void 0&&(b.playerRole==="GM"&&(re.autodetectCheckbox.checked=!0),await C.scene.setMetadata({[`${f.EXTENSIONID}/autodetectEnabled`]:!0})),b.sceneMetadata[`${f.EXTENSIONID}/sceneId`]===void 0)await C.scene.setMetadata({[`${f.EXTENSIONID}/sceneId`]:crypto.randomUUID()});else try{const e=b.sceneMetadata[`${f.EXTENSIONID}/sceneId`],t=localStorage.getItem(`${f.EXTENSIONID}/fogCache/${b.playerId}/${e}`);if(t!==null&&b.sceneMetadata[`${f.EXTENSIONID}/persistenceEnabled`]===!0){const n=JSON.parse(t),r=[];for(let o=0;o<n.length;o++){const l=st().commands(n[o].commands).fillRule("evenodd").locked(!0).visible(!1).fillColor("#000000").strokeColor("#000000").layer("FOG").name("Fog of War").metadata({[`${f.EXTENSIONID}/isVisionFog`]:!0,[`${f.EXTENSIONID}/digest`]:n[o].digest}).build();l.zIndex=3,r.push(l)}await C.scene.local.addItems(r)}}catch{}b.playerRole==="GM"&&(await Co(),await re.UpdateUI(),re.mapSubmit.onclick=async()=>{await C.scene.items.updateItems([f.GRIDID],e=>{for(const t of e){const n=t;n.width=b.gridDpi*+re.mapWidth.value,n.height=b.gridDpi*+re.mapHeight.value,n.scale={x:1,y:1}}})},i!==void 0&&await C.scene.items.updateItems([i],e=>{e[0].metadata[`${f.EXTENSIONID}/isBackgroundImage`]=!0})),b.snap=!0,b.sceneInitialized=!0}var Li={exports:{}};const Ao={},Mo=Object.freeze(Object.defineProperty({__proto__:null,default:Ao},Symbol.toStringTag,{value:"Module"})),bn=gr(Mo);(function(i,e){var t=(()=>{var n=typeof document<"u"&&document.currentScript?document.currentScript.src:void 0;return typeof __filename<"u"&&(n=n||__filename),function(r){r=r||{};var o;o||(o=typeof r<"u"?r:{});var l=Object.assign,d,p;o.ready=new Promise(function(s,a){d=s,p=a}),function(s){var a={};s.loadCmdsTypedArray=function(U){for(var K=0,te=0;te<U.length;te++)K+=U[te].length;if(a[K])var ie=a[K];else ie=new Float32Array(K),a[K]=ie;var ce=0;for(te=0;te<U.length;te++)for(var xe=0;xe<U[te].length;xe++){var Le=U[te][xe];typeof Le=="string"&&(Le=s.SkBits2FloatUnsigned(parseInt(Le))),ie[ce]=Le,ce++}return U=s._malloc(ie.length*ie.BYTES_PER_ELEMENT),s.HEAPF32.set(ie,U/ie.BYTES_PER_ELEMENT),[U,K]},s.FromCmds=function(U){U=s.loadCmdsTypedArray(U);var K=s._FromCmds(U[0],U[1]);return s._free(U[0]),K};var u,m,x,R,Y;s.cubicYFromX=function(U,K,te,ie,ce){return u&&m===U&&x===K&&R===te&&Y===ie||(u&&u.delete(),u=new s._SkCubicMap([U,K],[te,ie]),m=U,x=K,R=te,Y=ie),u.computeYFromX(ce)},s.cubicPtFromT=function(U,K,te,ie,ce){return u&&m===U&&x===K&&R===te&&Y===ie||(u&&u.delete(),u=new s._SkCubicMap([U,K],[te,ie]),m=U,x=K,R=te,Y=ie),u.computePtFromT(ce)}}(o),function(s){s.onRuntimeInitialized=function(){s.SkPath.prototype.addPath=function(){var a=arguments[0];if(arguments.length===1)this._addPath(a,1,0,0,0,1,0,0,0,1);else if(arguments.length===2){var u=arguments[1];this._addPath(a,u.a,u.c,u.e,u.b,u.d,u.f,0,0,1)}else if(arguments.length===7)u=arguments,this._addPath(a,u[1],u[3],u[5],u[2],u[4],u[6],0,0,1);else if(arguments.length===10)u=arguments,this._addPath(a,u[1],u[2],u[3],u[4],u[5],u[6],u[7],u[8],u[9]);else return console.Ma("addPath expected to take 1, 2, 7, or 10 args. Got "+arguments.length),null;return this},s.SkPath.prototype.arc=function(a,u,m,x,R,Y){return this._arc(a,u,m,x,R,!!Y),this},s.SkPath.prototype.arcTo=function(a,u,m,x,R){return this._arcTo(a,u,m,x,R),this},s.SkPath.prototype.bezierCurveTo=function(a,u,m,x,R,Y){return this._cubicTo(a,u,m,x,R,Y),this},s.SkPath.prototype.close=function(){return this._close(),this},s.SkPath.prototype.closePath=function(){return this._close(),this},s.SkPath.prototype.conicTo=function(a,u,m,x,R){return this._conicTo(a,u,m,x,R),this},s.SkPath.prototype.cubicTo=function(a,u,m,x,R,Y){return this._cubicTo(a,u,m,x,R,Y),this},s.SkPath.prototype.dash=function(a,u,m){return this._dash(a,u,m)?this:null},s.SkPath.prototype.ellipse=function(a,u,m,x,R,Y,U,K){return this._ellipse(a,u,m,x,R,Y,U,!!K),this},s.SkPath.prototype.lineTo=function(a,u){return this._lineTo(a,u),this},s.SkPath.prototype.moveTo=function(a,u){return this._moveTo(a,u),this},s.SkPath.prototype.op=function(a,u){return this._op(a,u)?this:null},s.SkPath.prototype.quadraticCurveTo=function(a,u,m,x){return this._quadTo(a,u,m,x),this},s.SkPath.prototype.quadTo=function(a,u,m,x){return this._quadTo(a,u,m,x),this},s.SkPath.prototype.rect=function(a,u,m,x){return this._rect(a,u,m,x),this},s.SkPath.prototype.simplify=function(){return this._simplify()?this:null},s.SkPath.prototype.stroke=function(a){return a=a||{},a.width=a.width||1,a.miter_limit=a.miter_limit||4,a.cap=a.cap||s.StrokeCap.BUTT,a.join=a.join||s.StrokeJoin.MITER,this._stroke(a)?this:null},s.SkPath.prototype.transform=function(){if(arguments.length===1)this._transform(arguments[0]);else if(arguments.length===9){var a=arguments;this._transform(a[0],a[1],a[2],a[3],a[4],a[5],a[6],a[7],a[8])}else return console.Ma("transform expected to take 1 or 9 arguments. Got "+arguments.length),null;return this},s.SkPath.prototype.trim=function(a,u,m){return this._trim(a,u,!!m)?this:null}}}(o);var I=l({},o),k=typeof window=="object",A=typeof importScripts=="function",D="",F,w,P,_,B,M;typeof process=="object"&&typeof process.versions=="object"&&typeof process.versions.node=="string"?(D=A?bn.dirname(D)+"/":__dirname+"/",M=()=>{B||(_=bn,B=bn)},F=function(s,a){return M(),s=B.normalize(s),_.readFileSync(s,a?null:"utf8")},P=s=>(s=F(s,!0),s.buffer||(s=new Uint8Array(s)),s),w=(s,a,u)=>{M(),s=B.normalize(s),_.readFile(s,function(m,x){m?u(m):a(x.buffer)})},1<process.argv.length&&process.argv[1].replace(/\\/g,"/"),process.argv.slice(2),process.on("uncaughtException",function(s){throw s}),process.on("unhandledRejection",function(s){throw s}),o.inspect=function(){return"[Emscripten Module object]"}):(k||A)&&(A?D=self.location.href:typeof document<"u"&&document.currentScript&&(D=document.currentScript.src),n&&(D=n),D.indexOf("blob:")!==0?D=D.substr(0,D.replace(/[?#].*/,"").lastIndexOf("/")+1):D="",F=s=>{var a=new XMLHttpRequest;return a.open("GET",s,!1),a.send(null),a.responseText},A&&(P=s=>{var a=new XMLHttpRequest;return a.open("GET",s,!1),a.responseType="arraybuffer",a.send(null),new Uint8Array(a.response)}),w=(s,a,u)=>{var m=new XMLHttpRequest;m.open("GET",s,!0),m.responseType="arraybuffer",m.onload=()=>{m.status==200||m.status==0&&m.response?a(m.response):u()},m.onerror=u,m.send(null)});var X=o.print||console.log.bind(console),V=o.printErr||console.warn.bind(console);l(o,I),I=null;var Z;o.wasmBinary&&(Z=o.wasmBinary),o.noExitRuntime,typeof WebAssembly!="object"&&pe("no native wasm support detected");var O,E=!1,h=typeof TextDecoder<"u"?new TextDecoder("utf8"):void 0;function y(s,a,u){var m=a+u;for(u=a;s[u]&&!(u>=m);)++u;if(16<u-a&&s.subarray&&h)return h.decode(s.subarray(a,u));for(m="";a<u;){var x=s[a++];if(x&128){var R=s[a++]&63;if((x&224)==192)m+=String.fromCharCode((x&31)<<6|R);else{var Y=s[a++]&63;x=(x&240)==224?(x&15)<<12|R<<6|Y:(x&7)<<18|R<<12|Y<<6|s[a++]&63,65536>x?m+=String.fromCharCode(x):(x-=65536,m+=String.fromCharCode(55296|x>>10,56320|x&1023))}}else m+=String.fromCharCode(x)}return m}function g(s,a,u){var m=Q;if(0<u){u=a+u-1;for(var x=0;x<s.length;++x){var R=s.charCodeAt(x);if(55296<=R&&57343>=R){var Y=s.charCodeAt(++x);R=65536+((R&1023)<<10)|Y&1023}if(127>=R){if(a>=u)break;m[a++]=R}else{if(2047>=R){if(a+1>=u)break;m[a++]=192|R>>6}else{if(65535>=R){if(a+2>=u)break;m[a++]=224|R>>12}else{if(a+3>=u)break;m[a++]=240|R>>18,m[a++]=128|R>>12&63}m[a++]=128|R>>6&63}m[a++]=128|R&63}}m[a]=0}}var N=typeof TextDecoder<"u"?new TextDecoder("utf-16le"):void 0;function $(s,a){for(var u=s>>1,m=u+a/2;!(u>=m)&&Ie[u];)++u;if(u<<=1,32<u-s&&N)return N.decode(Q.subarray(s,u));for(u="",m=0;!(m>=a/2);++m){var x=oe[s+2*m>>1];if(x==0)break;u+=String.fromCharCode(x)}return u}function W(s,a,u){if(u===void 0&&(u=2147483647),2>u)return 0;u-=2;var m=a;u=u<2*s.length?u/2:s.length;for(var x=0;x<u;++x)oe[a>>1]=s.charCodeAt(x),a+=2;return oe[a>>1]=0,a-m}function ae(s){return 2*s.length}function se(s,a){for(var u=0,m="";!(u>=a/4);){var x=le[s+4*u>>2];if(x==0)break;++u,65536<=x?(x-=65536,m+=String.fromCharCode(55296|x>>10,56320|x&1023)):m+=String.fromCharCode(x)}return m}function ee(s,a,u){if(u===void 0&&(u=2147483647),4>u)return 0;var m=a;u=m+u-4;for(var x=0;x<s.length;++x){var R=s.charCodeAt(x);if(55296<=R&&57343>=R){var Y=s.charCodeAt(++x);R=65536+((R&1023)<<10)|Y&1023}if(le[a>>2]=R,a+=4,a+4>u)break}return le[a>>2]=0,a-m}function ve(s){for(var a=0,u=0;u<s.length;++u){var m=s.charCodeAt(u);55296<=m&&57343>=m&&++u,a+=4}return a}var Oe,be,Q,oe,Ie,le,ue,Ee,Te;function ye(){var s=O.buffer;Oe=s,o.HEAP8=be=new Int8Array(s),o.HEAP16=oe=new Int16Array(s),o.HEAP32=le=new Int32Array(s),o.HEAPU8=Q=new Uint8Array(s),o.HEAPU16=Ie=new Uint16Array(s),o.HEAPU32=ue=new Uint32Array(s),o.HEAPF32=Ee=new Float32Array(s),o.HEAPF64=Te=new Float64Array(s)}var z,c=[],v=[],T=[];function G(){var s=o.preRun.shift();c.unshift(s)}var L=0,J=null;o.preloadedImages={},o.preloadedAudios={};function pe(s){throw o.onAbort&&o.onAbort(s),s="Aborted("+s+")",V(s),E=!0,s=new WebAssembly.RuntimeError(s+". Build with -s ASSERTIONS=1 for more info."),p(s),s}function ke(){return we.startsWith("data:application/octet-stream;base64,")}var we;if(we="pathkit.wasm",!ke()){var Ve=we;we=o.locateFile?o.locateFile(Ve,D):D+Ve}function Be(){var s=we;try{if(s==we&&Z)return new Uint8Array(Z);if(P)return P(s);throw"both async and sync fetching of the wasm failed"}catch(a){pe(a)}}function Xe(){if(!Z&&(k||A)){if(typeof fetch=="function"&&!we.startsWith("file://"))return fetch(we,{credentials:"same-origin"}).then(function(s){if(!s.ok)throw"failed to load wasm binary file at '"+we+"'";return s.arrayBuffer()}).catch(function(){return Be()});if(w)return new Promise(function(s,a){w(we,function(u){s(new Uint8Array(u))},a)})}return Promise.resolve().then(function(){return Be()})}function $e(s){for(;0<s.length;){var a=s.shift();if(typeof a=="function")a(o);else{var u=a.Wa;typeof u=="number"?a.xa===void 0?z.get(u)():z.get(u)(a.xa):u(a.xa===void 0?null:a.xa)}}}var ge={};function q(s){for(;s.length;){var a=s.pop();s.pop()(a)}}function fe(s){return this.fromWireType(ue[s>>2])}var He={},Ue={},S={};function H(s){if(s===void 0)return"_unknown";s=s.replace(/[^a-zA-Z0-9_]/g,"$");var a=s.charCodeAt(0);return 48<=a&&57>=a?"_"+s:s}function j(s,a){return s=H(s),function(){return a.apply(this,arguments)}}function ne(s){var a=Error,u=j(s,function(m){this.name=s,this.message=m,m=Error(m).stack,m!==void 0&&(this.stack=this.toString()+`
`+m.replace(/^Error(:[^\n]*)?\n/,""))});return u.prototype=Object.create(a.prototype),u.prototype.constructor=u,u.prototype.toString=function(){return this.message===void 0?this.name:this.name+": "+this.message},u}var de=void 0;function me(s){throw new de(s)}function he(s,a,u){function m(U){U=u(U),U.length!==s.length&&me("Mismatched type converter count");for(var K=0;K<s.length;++K)lt(s[K],U[K])}s.forEach(function(U){S[U]=a});var x=Array(a.length),R=[],Y=0;a.forEach(function(U,K){Ue.hasOwnProperty(U)?x[K]=Ue[U]:(R.push(U),He.hasOwnProperty(U)||(He[U]=[]),He[U].push(function(){x[K]=Ue[U],++Y,Y===R.length&&m(x)}))}),R.length===0&&m(x)}var Re={};function Se(s){switch(s){case 1:return 0;case 2:return 1;case 4:return 2;case 8:return 3;default:throw new TypeError("Unknown type size: "+s)}}var je=void 0;function _e(s){for(var a="";Q[s];)a+=je[Q[s++]];return a}var Ge=void 0;function Ne(s){throw new Ge(s)}function lt(s,a,u={}){if(!("argPackAdvance"in a))throw new TypeError("registerType registeredInstance requires argPackAdvance");var m=a.name;if(s||Ne('type "'+m+'" must have a positive integer typeid pointer'),Ue.hasOwnProperty(s)){if(u.Qa)return;Ne("Cannot register type '"+m+"' twice")}Ue[s]=a,delete S[s],He.hasOwnProperty(s)&&(a=He[s],delete He[s],a.forEach(function(x){x()}))}function tn(s){Ne(s.ea.ha.fa.name+" instance already deleted")}var nn=!1;function Bn(){}function Fn(s){--s.count.value,s.count.value===0&&(s.ka?s.ma.la(s.ka):s.ha.fa.la(s.ga))}function St(s){return typeof FinalizationGroup>"u"?(St=a=>a,s):(nn=new FinalizationGroup(function(a){for(var u=a.next();!u.done;u=a.next())u=u.value,u.ga?Fn(u):console.warn("object already deleted: "+u.ga)}),St=a=>(nn.register(a,a.ea,a.ea),a),Bn=a=>{nn.unregister(a.ea)},St(s))}var Tt=void 0,Nt=[];function rn(){for(;Nt.length;){var s=Nt.pop();s.ea.pa=!1,s.delete()}}function ft(){}var Xn={};function Hn(s,a,u){if(s[a].ia===void 0){var m=s[a];s[a]=function(){return s[a].ia.hasOwnProperty(arguments.length)||Ne("Function '"+u+"' called with an invalid number of arguments ("+arguments.length+") - expects one of ("+s[a].ia+")!"),s[a].ia[arguments.length].apply(this,arguments)},s[a].ia=[],s[a].ia[m.ua]=m}}function on(s,a,u){o.hasOwnProperty(s)?((u===void 0||o[s].ia!==void 0&&o[s].ia[u]!==void 0)&&Ne("Cannot register public name '"+s+"' twice"),Hn(o,s,s),o.hasOwnProperty(u)&&Ne("Cannot register multiple overloads of a function with the same number of arguments ("+u+")!"),o[s].ia[u]=a):(o[s]=a,u!==void 0&&(o[s].Xa=u))}function Qi(s,a,u,m,x,R,Y,U){this.name=s,this.constructor=a,this.qa=u,this.la=m,this.na=x,this.Oa=R,this.ta=Y,this.La=U,this.Ta=[]}function an(s,a,u){for(;a!==u;)a.ta||Ne("Expected null or instance of "+u.name+", got an instance of "+a.name),s=a.ta(s),a=a.na;return s}function er(s,a){return a===null?(this.Ba&&Ne("null is not a valid "+this.name),0):(a.ea||Ne('Cannot pass "'+dn(a)+'" as a '+this.name),a.ea.ga||Ne("Cannot pass deleted object as a pointer of type "+this.name),an(a.ea.ga,a.ea.ha.fa,this.fa))}function tr(s,a){if(a===null){if(this.Ba&&Ne("null is not a valid "+this.name),this.wa){var u=this.sa();return s!==null&&s.push(this.la,u),u}return 0}if(a.ea||Ne('Cannot pass "'+dn(a)+'" as a '+this.name),a.ea.ga||Ne("Cannot pass deleted object as a pointer of type "+this.name),!this.va&&a.ea.ha.va&&Ne("Cannot convert argument of type "+(a.ea.ma?a.ea.ma.name:a.ea.ha.name)+" to parameter type "+this.name),u=an(a.ea.ga,a.ea.ha.fa,this.fa),this.wa)switch(a.ea.ka===void 0&&Ne("Passing raw pointer to smart pointer is illegal"),this.Va){case 0:a.ea.ma===this?u=a.ea.ka:Ne("Cannot convert argument of type "+(a.ea.ma?a.ea.ma.name:a.ea.ha.name)+" to parameter type "+this.name);break;case 1:u=a.ea.ka;break;case 2:if(a.ea.ma===this)u=a.ea.ka;else{var m=a.clone();u=this.Ua(u,pt(function(){m.delete()})),s!==null&&s.push(this.la,u)}break;default:Ne("Unsupporting sharing policy")}return u}function nr(s,a){return a===null?(this.Ba&&Ne("null is not a valid "+this.name),0):(a.ea||Ne('Cannot pass "'+dn(a)+'" as a '+this.name),a.ea.ga||Ne("Cannot pass deleted object as a pointer of type "+this.name),a.ea.ha.va&&Ne("Cannot convert argument of type "+a.ea.ha.name+" to parameter type "+this.name),an(a.ea.ga,a.ea.ha.fa,this.fa))}function Vn(s,a,u){return a===u?s:u.na===void 0?null:(s=Vn(s,a,u.na),s===null?null:u.La(s))}var Ot={};function ir(s,a){for(a===void 0&&Ne("ptr should not be undefined");s.na;)a=s.ta(a),s=s.na;return Ot[a]}function xt(s,a){return a.ha&&a.ga||me("makeClassHandle requires ptr and ptrType"),!!a.ma!=!!a.ka&&me("Both smartPtrType and smartPtr must be specified"),a.count={value:1},St(Object.create(s,{ea:{value:a}}))}function ct(s,a,u,m){this.name=s,this.fa=a,this.Ba=u,this.va=m,this.wa=!1,this.la=this.Ua=this.sa=this.Ia=this.Va=this.Sa=void 0,a.na!==void 0?this.toWireType=tr:(this.toWireType=m?er:nr,this.ja=null)}function Un(s,a,u){o.hasOwnProperty(s)||me("Replacing nonexistant public symbol"),o[s].ia!==void 0&&u!==void 0?o[s].ia[u]=a:(o[s]=a,o[s].ua=u)}function rr(s,a){var u=[];return function(){u.length=arguments.length;for(var m=0;m<arguments.length;m++)u[m]=arguments[m];return s.includes("j")?(m=o["dynCall_"+s],m=u&&u.length?m.apply(null,[a].concat(u)):m.call(null,a)):m=z.get(a).apply(null,u),m}}function Ye(s,a){s=_e(s);var u=s.includes("j")?rr(s,a):z.get(a);return typeof u!="function"&&Ne("unknown function pointer with signature "+s+": "+a),u}var jn=void 0;function Gn(s){s=Zn(s);var a=_e(s);return ut(s),a}function Ct(s,a){function u(R){x[R]||Ue[R]||(S[R]?S[R].forEach(u):(m.push(R),x[R]=!0))}var m=[],x={};throw a.forEach(u),new jn(s+": "+m.map(Gn).join([", "]))}function sn(s,a){for(var u=[],m=0;m<s;m++)u.push(le[(a>>2)+m]);return u}function ln(s,a,u,m,x){var R=a.length;2>R&&Ne("argTypes array size mismatch! Must at least get return value and 'this' types!");var Y=a[1]!==null&&u!==null,U=!1;for(u=1;u<a.length;++u)if(a[u]!==null&&a[u].ja===void 0){U=!0;break}var K=a[0].name!=="void",te=R-2,ie=Array(te),ce=[],xe=[];return function(){if(arguments.length!==te&&Ne("function "+s+" called with "+arguments.length+" arguments, expected "+te+" args!"),xe.length=0,ce.length=Y?2:1,ce[0]=x,Y){var Le=a[1].toWireType(xe,this);ce[1]=Le}for(var Ce=0;Ce<te;++Ce)ie[Ce]=a[Ce+2].toWireType(xe,arguments[Ce]),ce.push(ie[Ce]);if(Ce=m.apply(null,ce),U)q(xe);else for(var Ke=Y?1:2;Ke<a.length;Ke++){var Ze=Ke===1?Le:ie[Ke-2];a[Ke].ja!==null&&a[Ke].ja(Ze)}return Le=K?a[0].fromWireType(Ce):void 0,Le}}var cn=[],at=[{},{value:void 0},{value:null},{value:!0},{value:!1}];function Wn(s){4<s&&--at[s].Ca===0&&(at[s]=void 0,cn.push(s))}function un(s){return s||Ne("Cannot use deleted val. handle = "+s),at[s].value}function pt(s){switch(s){case void 0:return 1;case null:return 2;case!0:return 3;case!1:return 4;default:var a=cn.length?cn.pop():at.length;return at[a]={Ca:1,value:s},a}}function or(s,a,u){switch(a){case 0:return function(m){return this.fromWireType((u?be:Q)[m])};case 1:return function(m){return this.fromWireType((u?oe:Ie)[m>>1])};case 2:return function(m){return this.fromWireType((u?le:ue)[m>>2])};default:throw new TypeError("Unknown integer type: "+s)}}function Dt(s,a){var u=Ue[s];return u===void 0&&Ne(a+" has unknown type "+Gn(s)),u}function dn(s){if(s===null)return"null";var a=typeof s;return a==="object"||a==="array"||a==="function"?s.toString():""+s}function ar(s,a){switch(a){case 2:return function(u){return this.fromWireType(Ee[u>>2])};case 3:return function(u){return this.fromWireType(Te[u>>3])};default:throw new TypeError("Unknown float type: "+s)}}function sr(s,a,u){switch(a){case 0:return u?function(m){return be[m]}:function(m){return Q[m]};case 1:return u?function(m){return oe[m>>1]}:function(m){return Ie[m>>1]};case 2:return u?function(m){return le[m>>2]}:function(m){return ue[m>>2]};default:throw new TypeError("Unknown integer type: "+s)}}var lr={};function fn(s){var a=lr[s];return a===void 0?_e(s):a}var pn=[];function zn(){function s(a){a.$$$embind_global$$$=a;var u=typeof $$$embind_global$$$=="object"&&a.$$$embind_global$$$===a;return u||delete a.$$$embind_global$$$,u}if(typeof globalThis=="object")return globalThis;if(typeof $$$embind_global$$$=="object"||(typeof mn=="object"&&s(mn)?$$$embind_global$$$=mn:typeof self=="object"&&s(self)&&($$$embind_global$$$=self),typeof $$$embind_global$$$=="object"))return $$$embind_global$$$;throw Error("unable to get global object.")}function cr(s){var a=pn.length;return pn.push(s),a}function ur(s,a){for(var u=Array(s),m=0;m<s;++m)u[m]=Dt(le[(a>>2)+m],"parameter "+m);return u}var qn=[];function dr(s){var a=Array(s+1);return function(u,m,x){a[0]=u;for(var R=0;R<s;++R){var Y=Dt(le[(m>>2)+R],"parameter "+R);a[R+1]=Y.readValueFromPointer(x),x+=Y.argPackAdvance}return u=new(u.bind.apply(u,a)),pt(u)}}var Yn={},fr=[null,[],[]];de=o.InternalError=ne("InternalError");for(var Kn=Array(256),At=0;256>At;++At)Kn[At]=String.fromCharCode(At);je=Kn,Ge=o.BindingError=ne("BindingError"),ft.prototype.isAliasOf=function(s){if(!(this instanceof ft&&s instanceof ft))return!1;var a=this.ea.ha.fa,u=this.ea.ga,m=s.ea.ha.fa;for(s=s.ea.ga;a.na;)u=a.ta(u),a=a.na;for(;m.na;)s=m.ta(s),m=m.na;return a===m&&u===s},ft.prototype.clone=function(){if(this.ea.ga||tn(this),this.ea.ra)return this.ea.count.value+=1,this;var s=St,a=Object,u=a.create,m=Object.getPrototypeOf(this),x=this.ea;return s=s(u.call(a,m,{ea:{value:{count:x.count,pa:x.pa,ra:x.ra,ga:x.ga,ha:x.ha,ka:x.ka,ma:x.ma}}})),s.ea.count.value+=1,s.ea.pa=!1,s},ft.prototype.delete=function(){this.ea.ga||tn(this),this.ea.pa&&!this.ea.ra&&Ne("Object already scheduled for deletion"),Bn(this),Fn(this.ea),this.ea.ra||(this.ea.ka=void 0,this.ea.ga=void 0)},ft.prototype.isDeleted=function(){return!this.ea.ga},ft.prototype.deleteLater=function(){return this.ea.ga||tn(this),this.ea.pa&&!this.ea.ra&&Ne("Object already scheduled for deletion"),Nt.push(this),Nt.length===1&&Tt&&Tt(rn),this.ea.pa=!0,this},ct.prototype.Pa=function(s){return this.Ia&&(s=this.Ia(s)),s},ct.prototype.Ga=function(s){this.la&&this.la(s)},ct.prototype.argPackAdvance=8,ct.prototype.readValueFromPointer=fe,ct.prototype.deleteObject=function(s){s!==null&&s.delete()},ct.prototype.fromWireType=function(s){function a(){return this.wa?xt(this.fa.qa,{ha:this.Sa,ga:u,ma:this,ka:s}):xt(this.fa.qa,{ha:this,ga:s})}var u=this.Pa(s);if(!u)return this.Ga(s),null;var m=ir(this.fa,u);if(m!==void 0)return m.ea.count.value===0?(m.ea.ga=u,m.ea.ka=s,m.clone()):(m=m.clone(),this.Ga(s),m);if(m=this.fa.Oa(u),m=Xn[m],!m)return a.call(this);m=this.va?m.Ja:m.pointerType;var x=Vn(u,this.fa,m.fa);return x===null?a.call(this):this.wa?xt(m.fa.qa,{ha:m,ga:x,ma:this,ka:s}):xt(m.fa.qa,{ha:m,ga:x})},o.getInheritedInstanceCount=function(){return Object.keys(Ot).length},o.getLiveInheritedInstances=function(){var s=[],a;for(a in Ot)Ot.hasOwnProperty(a)&&s.push(Ot[a]);return s},o.flushPendingDeletes=rn,o.setDelayFunction=function(s){Tt=s,Nt.length&&Tt&&Tt(rn)},jn=o.UnboundTypeError=ne("UnboundTypeError"),o.count_emval_handles=function(){for(var s=0,a=5;a<at.length;++a)at[a]!==void 0&&++s;return s},o.get_first_emval=function(){for(var s=5;s<at.length;++s)if(at[s]!==void 0)return at[s];return null};var pr={r:function(s){var a=ge[s];delete ge[s];var u=a.elements,m=u.length,x=u.map(function(U){return U.Aa}).concat(u.map(function(U){return U.Ea})),R=a.sa,Y=a.la;he([s],x,function(U){return u.forEach(function(K,te){var ie=U[te],ce=K.ya,xe=K.za,Le=U[te+m],Ce=K.Da,Ke=K.Fa;K.read=Ze=>ie.fromWireType(ce(xe,Ze)),K.write=(Ze,gt)=>{var nt=[];Ce(Ke,Ze,Le.toWireType(nt,gt)),q(nt)}}),[{name:a.name,fromWireType:function(K){for(var te=Array(m),ie=0;ie<m;++ie)te[ie]=u[ie].read(K);return Y(K),te},toWireType:function(K,te){if(m!==te.length)throw new TypeError("Incorrect number of tuple elements for "+a.name+": expected="+m+", actual="+te.length);for(var ie=R(),ce=0;ce<m;++ce)u[ce].write(ie,te[ce]);return K!==null&&K.push(Y,ie),ie},argPackAdvance:8,readValueFromPointer:fe,ja:Y}]})},u:function(s){var a=Re[s];delete Re[s];var u=a.sa,m=a.la,x=a.Ha,R=x.map(function(Y){return Y.Aa}).concat(x.map(function(Y){return Y.Ea}));he([s],R,function(Y){var U={};return x.forEach(function(K,te){var ie=Y[te],ce=K.ya,xe=K.za,Le=Y[te+x.length],Ce=K.Da,Ke=K.Fa;U[K.Na]={read:function(Ze){return ie.fromWireType(ce(xe,Ze))},write:function(Ze,gt){var nt=[];Ce(Ke,Ze,Le.toWireType(nt,gt)),q(nt)}}}),[{name:a.name,fromWireType:function(K){var te={},ie;for(ie in U)te[ie]=U[ie].read(K);return m(K),te},toWireType:function(K,te){for(var ie in U)if(!(ie in te))throw new TypeError('Missing field:  "'+ie+'"');var ce=u();for(ie in U)U[ie].write(ce,te[ie]);return K!==null&&K.push(m,ce),ce},argPackAdvance:8,readValueFromPointer:fe,ja:m}]})},z:function(){},F:function(s,a,u,m,x){var R=Se(u);a=_e(a),lt(s,{name:a,fromWireType:function(Y){return!!Y},toWireType:function(Y,U){return U?m:x},argPackAdvance:8,readValueFromPointer:function(Y){if(u===1)var U=be;else if(u===2)U=oe;else if(u===4)U=le;else throw new TypeError("Unknown boolean type size: "+a);return this.fromWireType(U[Y>>R])},ja:null})},l:function(s,a,u,m,x,R,Y,U,K,te,ie,ce,xe){ie=_e(ie),R=Ye(x,R),U&&(U=Ye(Y,U)),te&&(te=Ye(K,te)),xe=Ye(ce,xe);var Le=H(ie);on(Le,function(){Ct("Cannot construct "+ie+" due to unbound types",[m])}),he([s,a,u],m?[m]:[],function(Ce){if(Ce=Ce[0],m)var Ke=Ce.fa,Ze=Ke.qa;else Ze=ft.prototype;Ce=j(Le,function(){if(Object.getPrototypeOf(this)!==gt)throw new Ge("Use 'new' to construct "+ie);if(nt.oa===void 0)throw new Ge(ie+" has no accessible constructor");var Qn=nt.oa[arguments.length];if(Qn===void 0)throw new Ge("Tried to invoke ctor of "+ie+" with invalid number of parameters ("+arguments.length+") - expected ("+Object.keys(nt.oa).toString()+") parameters instead!");return Qn.apply(this,arguments)});var gt=Object.create(Ze,{constructor:{value:Ce}});Ce.prototype=gt;var nt=new Qi(ie,Ce,gt,xe,Ke,R,U,te);Ke=new ct(ie,nt,!0,!1),Ze=new ct(ie+"*",nt,!1,!1);var Jn=new ct(ie+" const*",nt,!1,!0);return Xn[s]={pointerType:Ze,Ja:Jn},Un(Le,Ce),[Ke,Ze,Jn]})},i:function(s,a,u,m,x,R){0<a||pe(void 0);var Y=sn(a,u);x=Ye(m,x),he([],[s],function(U){U=U[0];var K="constructor "+U.name;if(U.fa.oa===void 0&&(U.fa.oa=[]),U.fa.oa[a-1]!==void 0)throw new Ge("Cannot register multiple constructors with identical number of parameters ("+(a-1)+") for class '"+U.name+"'! Overload resolution is currently only performed using the parameter count, not actual type info!");return U.fa.oa[a-1]=()=>{Ct("Cannot construct "+U.name+" due to unbound types",Y)},he([],Y,function(te){return te.splice(1,0,null),U.fa.oa[a-1]=ln(K,te,null,x,R),[]}),[]})},a:function(s,a,u,m,x,R,Y,U){var K=sn(u,m);a=_e(a),R=Ye(x,R),he([],[s],function(te){function ie(){Ct("Cannot call "+ce+" due to unbound types",K)}te=te[0];var ce=te.name+"."+a;a.startsWith("@@")&&(a=Symbol[a.substring(2)]),U&&te.fa.Ta.push(a);var xe=te.fa.qa,Le=xe[a];return Le===void 0||Le.ia===void 0&&Le.className!==te.name&&Le.ua===u-2?(ie.ua=u-2,ie.className=te.name,xe[a]=ie):(Hn(xe,a,ce),xe[a].ia[u-2]=ie),he([],K,function(Ce){return Ce=ln(ce,Ce,te,R,Y),xe[a].ia===void 0?(Ce.ua=u-2,xe[a]=Ce):xe[a].ia[u-2]=Ce,[]}),[]})},I:function(s,a,u){s=_e(s),he([],[a],function(m){return m=m[0],o[s]=m.fromWireType(u),[]})},E:function(s,a){a=_e(a),lt(s,{name:a,fromWireType:function(u){var m=un(u);return Wn(u),m},toWireType:function(u,m){return pt(m)},argPackAdvance:8,readValueFromPointer:fe,ja:null})},h:function(s,a,u,m){function x(){}u=Se(u),a=_e(a),x.values={},lt(s,{name:a,constructor:x,fromWireType:function(R){return this.constructor.values[R]},toWireType:function(R,Y){return Y.value},argPackAdvance:8,readValueFromPointer:or(a,u,m),ja:null}),on(a,x)},k:function(s,a,u){var m=Dt(s,"enum");a=_e(a),s=m.constructor,m=Object.create(m.constructor.prototype,{value:{value:u},constructor:{value:j(m.name+"_"+a,function(){})}}),s.values[u]=m,s[a]=m},q:function(s,a,u){u=Se(u),a=_e(a),lt(s,{name:a,fromWireType:function(m){return m},toWireType:function(m,x){return x},argPackAdvance:8,readValueFromPointer:ar(a,u),ja:null})},f:function(s,a,u,m,x,R){var Y=sn(a,u);s=_e(s),x=Ye(m,x),on(s,function(){Ct("Cannot call "+s+" due to unbound types",Y)},a-1),he([],Y,function(U){return U=[U[0],null].concat(U.slice(1)),Un(s,ln(s,U,null,x,R),a-1),[]})},e:function(s,a,u,m,x){a=_e(a),x===-1&&(x=4294967295),x=Se(u);var R=U=>U;if(m===0){var Y=32-8*u;R=U=>U<<Y>>>Y}u=a.includes("unsigned")?function(U,K){return K>>>0}:function(U,K){return K},lt(s,{name:a,fromWireType:R,toWireType:u,argPackAdvance:8,readValueFromPointer:sr(a,x,m!==0),ja:null})},b:function(s,a,u){function m(R){R>>=2;var Y=ue;return new x(Oe,Y[R+1],Y[R])}var x=[Int8Array,Uint8Array,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array][a];u=_e(u),lt(s,{name:u,fromWireType:m,argPackAdvance:8,readValueFromPointer:m},{Qa:!0})},p:function(s,a){a=_e(a);var u=a==="std::string";lt(s,{name:a,fromWireType:function(m){var x=ue[m>>2];if(u)for(var R=m+4,Y=0;Y<=x;++Y){var U=m+4+Y;if(Y==x||Q[U]==0){if(R=R?y(Q,R,U-R):"",K===void 0)var K=R;else K+=String.fromCharCode(0),K+=R;R=U+1}}else{for(K=Array(x),Y=0;Y<x;++Y)K[Y]=String.fromCharCode(Q[m+4+Y]);K=K.join("")}return ut(m),K},toWireType:function(m,x){x instanceof ArrayBuffer&&(x=new Uint8Array(x));var R=typeof x=="string";R||x instanceof Uint8Array||x instanceof Uint8ClampedArray||x instanceof Int8Array||Ne("Cannot pass non-string to std::string");var Y=(u&&R?()=>{for(var te=0,ie=0;ie<x.length;++ie){var ce=x.charCodeAt(ie);55296<=ce&&57343>=ce&&(ce=65536+((ce&1023)<<10)|x.charCodeAt(++ie)&1023),127>=ce?++te:te=2047>=ce?te+2:65535>=ce?te+3:te+4}return te}:()=>x.length)(),U=hn(4+Y+1);if(ue[U>>2]=Y,u&&R)g(x,U+4,Y+1);else if(R)for(R=0;R<Y;++R){var K=x.charCodeAt(R);255<K&&(ut(U),Ne("String has UTF-16 code units that do not fit in 8 bits")),Q[U+4+R]=K}else for(R=0;R<Y;++R)Q[U+4+R]=x[R];return m!==null&&m.push(ut,U),U},argPackAdvance:8,readValueFromPointer:fe,ja:function(m){ut(m)}})},m:function(s,a,u){if(u=_e(u),a===2)var m=$,x=W,R=ae,Y=()=>Ie,U=1;else a===4&&(m=se,x=ee,R=ve,Y=()=>ue,U=2);lt(s,{name:u,fromWireType:function(K){for(var te=ue[K>>2],ie=Y(),ce,xe=K+4,Le=0;Le<=te;++Le){var Ce=K+4+Le*a;(Le==te||ie[Ce>>U]==0)&&(xe=m(xe,Ce-xe),ce===void 0?ce=xe:(ce+=String.fromCharCode(0),ce+=xe),xe=Ce+a)}return ut(K),ce},toWireType:function(K,te){typeof te!="string"&&Ne("Cannot pass non-string to C++ string type "+u);var ie=R(te),ce=hn(4+ie+a);return ue[ce>>2]=ie>>U,x(te,ce+4,ie+a),K!==null&&K.push(ut,ce),ce},argPackAdvance:8,readValueFromPointer:fe,ja:function(K){ut(K)}})},t:function(s,a,u,m,x,R){ge[s]={name:_e(a),sa:Ye(u,m),la:Ye(x,R),elements:[]}},s:function(s,a,u,m,x,R,Y,U,K){ge[s].elements.push({Aa:a,ya:Ye(u,m),za:x,Ea:R,Da:Ye(Y,U),Fa:K})},v:function(s,a,u,m,x,R){Re[s]={name:_e(a),sa:Ye(u,m),la:Ye(x,R),Ha:[]}},j:function(s,a,u,m,x,R,Y,U,K,te){Re[s].Ha.push({Na:_e(a),Aa:u,ya:Ye(m,x),za:R,Ea:Y,Da:Ye(U,K),Fa:te})},G:function(s,a){a=_e(a),lt(s,{Ra:!0,name:a,argPackAdvance:0,fromWireType:function(){},toWireType:function(){}})},d:function(s,a,u,m){s=pn[s],a=un(a),u=fn(u),s(a,u,null,m)},J:Wn,x:function(s){return s===0?pt(zn()):(s=fn(s),pt(zn()[s]))},c:function(s,a){var u=ur(s,a),m=u[0];a=m.name+"_$"+u.slice(1).map(function(Y){return Y.name}).join("_")+"$";var x=qn[a];if(x!==void 0)return x;var R=Array(s-1);return x=cr((Y,U,K,te)=>{for(var ie=0,ce=0;ce<s-1;++ce)R[ce]=u[ce+1].readValueFromPointer(te+ie),ie+=u[ce+1].argPackAdvance;for(Y=Y[U].apply(Y,R),ce=0;ce<s-1;++ce)u[ce+1].Ka&&u[ce+1].Ka(R[ce]);if(!m.Ra)return m.toWireType(K,Y)}),qn[a]=x},n:function(s){4<s&&(at[s].Ca+=1)},w:function(s,a,u,m){s=un(s);var x=Yn[a];return x||(x=dr(a),Yn[a]=x),x(s,u,m)},K:function(){return pt([])},D:function(s){return pt(fn(s))},H:function(s,a){return s=Dt(s,"_emval_take_value"),s=s.readValueFromPointer(a),pt(s)},g:function(){pe("")},B:function(s){var a=Q.length;if(s>>>=0,2147483648<s)return!1;for(var u=1;4>=u;u*=2){var m=a*(1+.2/u);m=Math.min(m,s+100663296),m=Math.max(s,m),0<m%65536&&(m+=65536-m%65536);e:{try{O.grow(Math.min(2147483648,m)-Oe.byteLength+65535>>>16),ye();var x=1;break e}catch{}x=void 0}if(x)return!0}return!1},C:function(){return 0},y:function(){},o:function(s,a,u,m){for(var x=0,R=0;R<u;R++){var Y=le[a>>2],U=le[a+4>>2];a+=8;for(var K=0;K<U;K++){var te=Q[Y+K],ie=fr[s];te===0||te===10?((s===1?X:V)(y(ie,0)),ie.length=0):ie.push(te)}x+=U}return le[m>>2]=x,0},A:function(){}};(function(){function s(x){o.asm=x.exports,O=o.asm.L,ye(),z=o.asm._,v.unshift(o.asm.M),L--,o.monitorRunDependencies&&o.monitorRunDependencies(L),L==0&&J&&(x=J,J=null,x())}function a(x){s(x.instance)}function u(x){return Xe().then(function(R){return WebAssembly.instantiate(R,m)}).then(function(R){return R}).then(x,function(R){V("failed to asynchronously prepare wasm: "+R),pe(R)})}var m={a:pr};if(L++,o.monitorRunDependencies&&o.monitorRunDependencies(L),o.instantiateWasm)try{return o.instantiateWasm(m,s)}catch(x){return V("Module.instantiateWasm callback failed with error: "+x),!1}return function(){return Z||typeof WebAssembly.instantiateStreaming!="function"||ke()||we.startsWith("file://")||typeof fetch!="function"?u(a):fetch(we,{credentials:"same-origin"}).then(function(x){return WebAssembly.instantiateStreaming(x,m).then(a,function(R){return V("wasm streaming compile failed: "+R),V("falling back to ArrayBuffer instantiation"),u(a)})})}().catch(p),{}})(),o.___wasm_call_ctors=function(){return(o.___wasm_call_ctors=o.asm.M).apply(null,arguments)},o.__Z6ToCmdsRK6SkPath=function(){return(o.__Z6ToCmdsRK6SkPath=o.asm.N).apply(null,arguments)},o.__Z8FromCmdsmi=function(){return(o.__Z8FromCmdsmi=o.asm.O).apply(null,arguments)},o.__Z7NewPathv=function(){return(o.__Z7NewPathv=o.asm.P).apply(null,arguments)},o.__Z8CopyPathRK6SkPath=function(){return(o.__Z8CopyPathRK6SkPath=o.asm.Q).apply(null,arguments)},o.__Z6EqualsRK6SkPathS1_=function(){return(o.__Z6EqualsRK6SkPathS1_=o.asm.R).apply(null,arguments)},o.__Z11ToSVGStringRK6SkPath=function(){return(o.__Z11ToSVGStringRK6SkPath=o.asm.S).apply(null,arguments)},o.__Z13FromSVGStringNSt3__212basic_stringIcNS_11char_traitsIcEENS_9allocatorIcEEEE=function(){return(o.__Z13FromSVGStringNSt3__212basic_stringIcNS_11char_traitsIcEENS_9allocatorIcEEEE=o.asm.T).apply(null,arguments)},o.__Z13ApplySimplifyR6SkPath=function(){return(o.__Z13ApplySimplifyR6SkPath=o.asm.U).apply(null,arguments)},o.__Z11ApplyPathOpR6SkPathRKS_8SkPathOp=function(){return(o.__Z11ApplyPathOpR6SkPathRKS_8SkPathOp=o.asm.V).apply(null,arguments)},o.__Z10MakeFromOpRK6SkPathS1_8SkPathOp=function(){return(o.__Z10MakeFromOpRK6SkPathS1_8SkPathOp=o.asm.W).apply(null,arguments)},o.__Z14ResolveBuilderR11SkOpBuilder=function(){return(o.__Z14ResolveBuilderR11SkOpBuilder=o.asm.X).apply(null,arguments)},o.__Z8ToCanvasRK6SkPathN10emscripten3valE=function(){return(o.__Z8ToCanvasRK6SkPathN10emscripten3valE=o.asm.Y).apply(null,arguments)},o.__Z8ToPath2DRK6SkPath=function(){return(o.__Z8ToPath2DRK6SkPath=o.asm.Z).apply(null,arguments)};var ut=o._free=function(){return(ut=o._free=o.asm.$).apply(null,arguments)},hn=o._malloc=function(){return(hn=o._malloc=o.asm.aa).apply(null,arguments)},Zn=o.___getTypeName=function(){return(Zn=o.___getTypeName=o.asm.ba).apply(null,arguments)};o.___embind_register_native_and_builtin_types=function(){return(o.___embind_register_native_and_builtin_types=o.asm.ca).apply(null,arguments)},o.dynCall_jiji=function(){return(o.dynCall_jiji=o.asm.da).apply(null,arguments)};var Mt;J=function s(){Mt||gn(),Mt||(J=s)};function gn(){function s(){if(!Mt&&(Mt=!0,o.calledRun=!0,!E)){if($e(v),d(o),o.onRuntimeInitialized&&o.onRuntimeInitialized(),o.postRun)for(typeof o.postRun=="function"&&(o.postRun=[o.postRun]);o.postRun.length;){var a=o.postRun.shift();T.unshift(a)}$e(T)}}if(!(0<L)){if(o.preRun)for(typeof o.preRun=="function"&&(o.preRun=[o.preRun]);o.preRun.length;)G();$e(c),0<L||(o.setStatus?(o.setStatus("Running..."),setTimeout(function(){setTimeout(function(){o.setStatus("")},1),s()},1)):s())}}if(o.run=gn,o.preInit)for(typeof o.preInit=="function"&&(o.preInit=[o.preInit]);0<o.preInit.length;)o.preInit.pop()();return gn(),r.ready}})();i.exports=t})(Li);var Po=Li.exports;const $o=$n(Po),Ro="/assets/pathkit-1356ccfa.wasm";class Sn{startTime;accumulatedTime;constructor(){this.startTime=-1,this.accumulatedTime=-1}start(){this.startTime=performance.now(),this.accumulatedTime=0}resume(){this.startTime=performance.now()}pause(){return this.accumulatedTime+=performance.now()-this.startTime,this.startTime=-1,this.accumulatedTime}stop(){if(this.startTime!=-1){const e=performance.now()-this.startTime+this.accumulatedTime;return this.accumulatedTime=0,e}else{const e=this.accumulatedTime;return this.accumulatedTime=0,e}}}function Rt(i,e){return(i.x-e.x)*(i.x-e.x)+(i.y-e.y)*(i.y-e.y)}function Bi(i,e){return i.x==e.x&&i.y==e.y}function Lt(i,e,t){return t===void 0&&(t=.01),Math.abs(i-e)<=t}function Tn(i,e){return(i%e+e)%e}function Lo(i,e){return qe.pointInPolygon(i[0],e)||qe.pointInPolygon(i[0],e)?!0:Bt(i,[e[0],e[1]])||Bt(i,[e[1],e[2]])||Bt(i,[e[2],e[3]])||Bt(i,[e[3],e[0]])}function Bt(i,e){const t=(i[1].x-i[0].x)*(e[1].y-e[0].y)-(e[1].x-e[0].x)*(i[1].y-i[0].y),n=((e[1].y-e[0].y)*(e[1].x-i[0].x)+(e[0].x-e[1].x)*(e[1].y-i[0].y))/t,r=((i[0].y-i[1].y)*(e[1].x-i[0].x)+(i[1].x-i[0].x)*(e[1].y-i[0].y))/t;return n>=0&&n<=1&&r>=0&&r<=1}function Ft(i,e,t){return{x:i.x+e*Math.cos(t),y:i.y+e*Math.sin(t)}}function Bo(i,e,t,n){const r=Math.atan2(i.y-t.y,i.x-t.x);let o=Ft(i,e,r+Math.PI/2),l=Ft(i,e,r-Math.PI/2),d=Ft(t,n,r+Math.PI/2),p=Ft(t,n,r-Math.PI/2);const I=qe.normalize(qe.subtract(i,t));return o=qe.add(o,qe.multiply(I,e)),l=qe.add(l,qe.multiply(I,e)),d=qe.add(d,qe.multiply(I,0-n)),p=qe.add(p,qe.multiply(I,0-n)),[o,l,p,d]}function Fo(i){return i.filter(e=>e.points&&e.points.length>1).flatMap(e=>{const t=ze.fromItem(e);return e.points.slice(0,-1).map((n,r)=>{const o=ze.fromPosition(e.points[r]),l=ze.fromPosition(e.points[r+1]),d=ze.decompose(ze.multiply(t,o)).position,p=ze.decompose(ze.multiply(t,l)).position;return{startPosition:d,endPosition:p,originalShape:e,oneSided:e.metadata[`${f.EXTENSIONID}/oneSided`]}})})}function Xo(i,e,t,n,r,o){let l=[],d=0,p=0,I=[t,n];b.party.filter(Z=>Z.role==="GM");const k=[{x:(t+r[0])*o[0],y:r[1]*o[1]},{x:(t+r[0])*o[0],y:(n+r[1])*o[1]},{x:r[0]*o[0],y:(n+r[1])*o[1]},{x:r[0]*o[0],y:r[1]*o[1]}],A=b.gridDpi,D=f.EXTENSIONID,F=e.some(It);let w;if(b.enableVisionDebug&&(w=De.NewPath()),e.length===0)return l;for(const Z of e){const O=b.playerId===Z.createdUserId,h=b.sceneMetadata[`${f.EXTENSIONID}/USER-${Z.createdUserId}`]?.role==="GM";if(!O&&b.playerRole!=="GM"&&!h)continue;const y=Z.metadata[`${D}/visionRange`],g=b.playerShadowCache.getValue(Z.id);if(l.push([]),g!==void 0&&Bi(g.player.position,Z.position)&&g.player.metadata[`${D}/visionRange`]===y)continue;let N=A*1e3;y&&(N=A*(y/b.gridScale+.5));const $=[];if(F&&!It(Z)){for(const W of e)if(It(W)){const ae=W.metadata[`${f.EXTENSIONID}/visionRange`];let se=1e3*b.gridDpi;ae&&(se=b.gridDpi*(ae/b.gridScale+.5));const ee=Bo(Z.position,N,W.position,se);if($.push(ee),b.enableVisionDebug){let ve=De.NewPath();ve.moveTo(ee[0].x,ee[0].y).lineTo(ee[1].x,ee[1].y).lineTo(ee[2].x,ee[2].y).lineTo(ee[3].x,ee[3].y).closePath();const Oe=st().fillRule("evenodd").commands(ve.toCmds()).locked(!0).visible(!0).fillColor("#660000").strokeColor("#FF0000").fillOpacity(.2).layer("DRAWING").metadata({[`${f.EXTENSIONID}/debug`]:!0}).build();C.scene.local.addItems([Oe]),ve.delete()}}}for(const W of i){const ae=(Z.position.x-W.startPosition.x)*(W.endPosition.y-W.startPosition.y)-(Z.position.y-W.startPosition.y)*(W.endPosition.x-W.startPosition.x);if(W.oneSided!==void 0&&(W.oneSided==="right"&&ae>0||W.oneSided==="left"&&ae<0))continue;let se=W.startPosition.x,ee=W.startPosition.y,ve=W.endPosition.x,Oe=W.endPosition.y;if(se<r[0]||ee<r[1]||se>r[0]+I[0]||ee>r[1]+I[1]||ve<r[0]||Oe<r[1]||ve>r[0]+I[0]||Oe>r[1]+I[1]){p++;continue}const be=[W.startPosition,W.endPosition],Q=qe.distance(W.startPosition,W.endPosition),Ie=Math.floor(Q/(N/3));for(let L=1;L<Ie;L++)be.push(qe.lerp(W.startPosition,W.endPosition,L/Ie));let le=!0;for(const L of be)if(qe.compare(Z.position,L,N*1.05)){le=!1;break}if(le&&F&&!It(Z)){for(const L of $)if(Lo([W.startPosition,W.endPosition],L)){le=!1;break}}if(le){b.enableVisionDebug&&w.moveTo(W.startPosition.x,W.startPosition.y).lineTo(W.endPosition.x,W.endPosition.y),p++;continue}d++;const ue={x:W.startPosition.x-Z.position.x,y:W.startPosition.y-Z.position.y},Ee={x:W.endPosition.x-Z.position.x,y:W.endPosition.y-Z.position.y};var P={x:0,y:0},_={x:0,y:0},B=0,M=0,X=0,V=0;//! This is probably not required if we later compute the intersection
//! (using PathKit) of these polygons with a base rectangle the size of
//! our background image
ue.x<0?B=r[0]*o[0]:B=(t+r[0])*o[0],ue.y<0?M=r[1]*o[1]:M=(n+r[1])*o[1],Ee.x<0?X=r[0]*o[0]:X=(t+r[0])*o[0],Ee.y<0?V=r[1]*o[1]:V=(n+r[1])*o[1];const Te=[],ye=[];if(ue.x!=0){const L=ue.y/ue.x,J=W.startPosition.y-L*W.startPosition.x;Te.push({x:B,y:L*B+J})}if(ue.y!=0){const L=ue.x/ue.y,J=L*W.startPosition.y-W.startPosition.x;Te.push({x:L*M-J,y:M})}if(Ee.x!=0){const L=Ee.y/Ee.x,J=W.endPosition.y-L*W.endPosition.x;ye.push({x:X,y:L*X+J})}if(Ee.y!=0){const L=Ee.x/Ee.y,J=L*W.endPosition.y-W.endPosition.x;ye.push({x:L*V-J,y:V})}if(Te.length===0||ye.length===0)continue;Te.length==1||Rt(Te[0],W.startPosition)<Rt(Te[1],W.startPosition)?P=Te[0]:P=Te[1],ye.length==1||Rt(ye[0],W.endPosition)<Rt(ye[1],W.endPosition)?_=ye[0]:_=ye[1];const z=[{x:W.startPosition.x,y:W.startPosition.y},P,_,{x:W.endPosition.x,y:W.endPosition.y}],c=[0,0];let v=0;for(const L of[P,_])Lt(L.y,r[1]*o[1])?c[v]=0:Lt(L.y,(n+r[1])*o[1])?c[v]=2:Lt(L.x,r[0]*o[0])?c[v]=3:Lt(L.x,(t+r[0])*o[0])&&(c[v]=1),v++;let T=Math.sign(ae);T=T==0?1:-T;const G=T==1?c[1]:Tn(c[1]-1,4);for(let L=c[0]+(T==1?0:-1);Tn(L,4)!=G;L+=T)z.splice(z.length-2,0,k[Tn(L,4)]);l[l.length-1].push({pointset:z,fromShape:W.originalShape})}}if(b.enableVisionDebug){console.log("skip",p,"lines",d);const Z=st().commands(w.toCmds()).visible(!0).locked(!0).strokeColor("#00FF00").fillOpacity(0).layer("DRAWING").name("smokedebug").metadata({[`${f.EXTENSIONID}/debug`]:!0}).build();C.scene.local.addItems([Z]),w.delete()}return l}let De;async function vt(i){if(await C.action.setBadgeText("⏱️"),await C.player.setMetadata({[`${f.EXTENSIONID}/processed`]:!1}),De||(De=await $o({locateFile:()=>Ro})),!b.sceneReady){b.playerShadowCache.invalidate(),b.busy=!1,await C.action.setBadgeText(void 0);return}if(b.busy||!b.sceneInitialized)return;b.busy=!0;const[e,t]=[new Sn,new Sn];e.start(),e.pause(),t.start();const n=b.sceneItems.filter(Q=>yi(Q)&&(!It(Q)||Q.visible===!0)),r=b.sceneItems.filter(oa),o=b.sceneItems.filter(vi),l=b.sceneItems.filter(zi)?.[0],d=b.sceneMetadata[`${f.EXTENSIONID}/visionEnabled`]===!0,p=b.sceneMetadata[`${f.EXTENSIONID}/persistenceEnabled`]===!0,I=b.sceneMetadata[`${f.EXTENSIONID}/autodetectEnabled`]===!0,k=b.sceneMetadata[`${f.EXTENSIONID}/fowEnabled`]===!0,A=b.sceneMetadata[`${f.EXTENSIONID}/fowColor`],D=b.sceneMetadata[`${f.EXTENSIONID}/playerDoors`]===!0;let F=[],w=[],P=[],_=!1,B=[];if(l===void 0?(F[0]=0,F[1]=0,w[0]=1,w[1]=1,P[0]=0,P[1]=0):(F[0]=l.width*l.scale.x,F[1]=l.height*l.scale.y,w[0]=l.scale.x,w[1]=l.scale.y,P[0]=l.position.x,P[1]=l.position.y),b.playerRole==="GM"){B=n;const Q=document.getElementById("mapHeight"),oe=document.getElementById("mapWidth");oe&&(oe.value=(Math.round(F[0])/b.gridDpi).toString()),Q&&(Q.value=(Math.round(F[1])/b.gridDpi).toString())}else{B=n.filter(aa);for(const Q of n)yi(Q)&&b.sceneMetadata[`${f.EXTENSIONID}/USER-${Q.createdUserId}`]?.role==="GM"&&B.push(Q)}const M=JSON.stringify(r),X=JSON.stringify(o),V=JSON.stringify(n),Z=JSON.stringify(l);if(b.previousMap===Z&&b.previousVisionEnabled===d&&b.previousFowColor===A&&b.previousAutodetectEnabled===I&&b.previousFowEnabled===k&&b.previousPersistenceEnabled===p&&b.previousVisionShapes===M&&b.previousAutohideItems===X&&b.previousPlayersWithVision===V&&b.previousSize[0]===F[0]&&b.previousSize[1]===F[1]&&i!==!0){b.busy=!1,await C.action.setBadgeText(void 0);return}(Z!=b.previousMap||b.previousVisionShapes!=M||F[0]!=b.previousSize[0]||F[1]!=b.previousSize[1])&&(_=!0),b.previousMap=Z,b.previousPlayersWithVision=V,b.previousVisionShapes=M,b.previousSize=F,b.previousVisionEnabled=d,b.previousAutodetectEnabled=I,b.previousFowEnabled=k,b.previousFowColor=A,b.previousPersistenceEnabled=p,t.pause(),b.enableVisionDebug&&await C.scene.local.deleteItems((await C.scene.local.getItems(Q=>Q.metadata[`${f.EXTENSIONID}/debug`]===!0)).map(Q=>Q.id));const O=[];for(let Q=0;Q<=6;Q++)O.push(new Sn);O[1].start();let[E,h]=F;if(I){const Q=b.sceneItems.filter(Ie=>Ie.layer==="MAP"&&Wt(Ie));let oe=[];for(let Ie of Q){let le=b.gridDpi/Ie.grid.dpi,ue=Ie.position.x-le*Ie.grid.offset.x*Ie.scale.x,Ee=Ie.position.y-le*Ie.grid.offset.y*Ie.scale.y,Te=ue+le*Ie.image.width*Ie.scale.x,ye=Ee+le*Ie.image.height*Ie.scale.y;if(Ie.rotation>0){const z=Math.abs(Te-ue),c=Math.abs(ye-Ee);switch(Ie.rotation){case 270:Ee-=c,ye-=c;break;case 180:Ee-=c,ye-=c,ue-=z,Te-=z;break;case 90:ue-=z,Te-=z;break}}oe.length?(ue<oe[0]&&(oe[0]=ue),Ee<oe[1]&&(oe[1]=Ee),Te>oe[2]&&(oe[2]=Te),ye>oe[3]&&(oe[3]=ye)):(oe[0]=ue,oe[1]=Ee,oe[2]=Te,oe[3]=ye)}P=[oe[0],oe[1]],F=[oe[2]-oe[0],oe[3]-oe[1]],w=[1,1],[E,h]=F}let y=0,g=0;if(_&&b.playerShadowCache.invalidate(),t.resume(),!(b.sceneMetadata[`${f.EXTENSIONID}/visionEnabled`]===!0)||n.length==0){const Q=await C.scene.local.getItems(Pn);await C.scene.local.deleteItems(Q.map(oe=>oe.id)),b.busy=!1,await C.action.setBadgeText(void 0);return}const $=Fo(r),W=Xo($,n,E,h,P,w);if(W.length==0){b.busy=!1,await C.action.setBadgeText(void 0);return}const ae=[];O[1].pause(),O[2].start();const se={};let ee=0;await ve();async function ve(){const Q=n[ee];let oe=b.playerShadowCache.getValue(Q.id);if(oe!==void 0&&Bi(oe.player.position,Q.position)&&oe.player.metadata[`${f.EXTENSIONID}/visionRange`]===Q.metadata[`${f.EXTENSIONID}/visionRange`]){const Te=De.FromCmds(oe.shadowPath);if(se[ee]=Te,y++,ee===n.length-1){await Oe(O);return}else{ee++,await ve();return}}g++;const Ie=W[ee];let le=new De.SkOpBuilder;const ue=De.NewPath().rect(P[0],P[1],F[0],F[1]);le.add(ue,De.PathOp.UNION),ue.delete(),await Ee(Ie);function Ee(Te){const ye=Math.ceil(Te.length/b.workers.length);let z=0,c=0,v={};for(let T=0;T<b.workers.length;T++){const G=z+ye,L=Te.slice(z,G+10);b.workers[T].onmessage=async function(J){if(J.data){const{numb:pe,messageData:ke}=J.data;if(c++,v[pe]=ke,c===b.workers.length){for(let Be=0;Be<b.workers.length;Be++){const Xe=De.FromCmds(v[Be]);le.add(Xe,De.PathOp.INTERSECT),Xe.delete()}let we=le.resolve();if(we.simplify(),!we){console.error("Couldn't compute fog"),b.busy=!1,await C.action.setBadgeText(void 0);return}se[ee]=we,oe!==void 0&&(oe.shadowPath="");const Ve=we.toCmds();b.playerShadowCache.cacheValue(Q.id,{shadowPath:Ve,player:Q}),le.delete(),ee===n.length-1?await Oe(O):(ee++,await ve())}}},b.workers[T].postMessage({numb:T,polygons:L,mapOffset:P,mapSize:F}),z=G}}}async function Oe(Q){Q[2].pause(),Q[3].start();const oe=[],Ie=De.NewPath();for(let q=0;q<n.length;q++){const fe=n[q],He=fe.metadata[`${f.EXTENSIONID}/visionRange`],Ue=b.playerId===n[q].createdUserId,H=b.sceneMetadata[`${f.EXTENSIONID}/USER-${n[q].createdUserId}`]?.role==="GM";if(It(fe)?oe[q]=!0:Ie.op(se[q],De.PathOp.UNION),He){if(!Ue&&b.playerRole!=="GM"&&!H)continue;const j=b.gridDpi*(He/b.gridScale+.5),ne=De.NewPath().ellipse(fe.position.x,fe.position.y,j,j,0,0,2*Math.PI);se[q]?.op(ne,De.PathOp.INTERSECT),ne.delete();const de=b.sceneMetadata[`${f.EXTENSIONID}/USER-${fe.createdUserId}`];if(de&&b.playerRole==="GM"&&!It(fe)&&de.role!=="GM"){const me=bi().strokeColor(de.color).fillOpacity(0).position({x:fe.position.x,y:fe.position.y}).width(j*2).height(j*2).shapeType("CIRCLE").metadata({[`${f.EXTENSIONID}/isIndicatorRing`]:!0}).locked(!0).build();ae.push(me)}}}Ie.simplify();for(let q=0;q<oe.length;q++)oe[q]===!0&&(se[q].op(Ie,De.PathOp.INTERSECT),se[q].simplify());Ie.delete(),Q[3].pause(),Q[4].start();const le=[],ue=[],Ee=De.NewPath(),Te={},ye=await C.scene.local.getItems(Pn),z=await C.scene.local.getItems(ra);k&&Ee.rect(P[0],P[1],F[0],F[1]);let c=[],v,T=null;if(p)if(c=ye.filter(q=>wt(q)),v=new De.SkOpBuilder,Te.reuse=!0,c.length===0){const q=st().commands([]).fillRule("evenodd").locked(!0).visible(!1).fillColor("#000000").strokeColor("#000000").layer("FOG").name("Fog of War").metadata({[`${f.EXTENSIONID}/isVisionFog`]:!0,[`${f.EXTENSIONID}/digest`]:"reuse"}).build();q.zIndex=3,await C.scene.local.addItems([q]),c=await C.scene.local.getItems(wt)}else T=De.FromCmds(c[0].commands),T.setFillType(De.FillType.EVENODD);const G=new De.SkOpBuilder;let L=!1;for(const q of Object.keys(se)){const fe=se[q],Ue=new TextEncoder().encode(fe.toCmds().toString()),S=await crypto.subtle.digest("SHA-1",Ue).then(j=>[...new Uint8Array(j)].map(ne=>ne.toString(16).padStart(2,"0")).join(""));if(ye.filter(j=>wt(j)&&j.metadata[`${f.EXTENSIONID}/digest`]===S).length===0?p?v.add(fe,De.PathOp.UNION):le.push({cmds:fe.toCmds(),visible:!1,zIndex:3,playerId:n[q].id,digest:S}):Te[S]=!0,k){if(b.enableVisionDebug){const j=st().commands(fe.toCmds()).locked(!0).visible(fe.visible).fillColor("#555500").fillOpacity(.3).strokeColor("#00FF00").layer("DRAWING").metadata({[`${f.EXTENSIONID}/debug`]:!0}).build();await C.scene.local.addItems([j])}Ee.op(fe,De.PathOp.DIFFERENCE),b.playerRole==="GM"&&(L=!0,G.add(fe,De.PathOp.UNION))}fe.delete()}const J=b.sceneMetadata[`${f.EXTENSIONID}/sceneId`];if(p){const q=v.resolve();q.setFillType(De.FillType.EVENODD),T!==null&&q.op(T,De.PathOp.UNION);const fe=q.toCmds();c.length>0&&await C.scene.local.updateItems([c[0].id],He=>{He.length>0&&(He[0].commands=fe)});try{localStorage.setItem(`${f.EXTENSIONID}/fogCache/${b.playerId}/${J}`,JSON.stringify([{digest:"reuse",commands:fe}]))}catch{}T!==null&&T.delete(),q.delete(),v.delete()}else if(p){const q=ye.filter(wt);try{localStorage.setItem(`${f.EXTENSIONID}/fogCache/${b.playerId}/${J}`,JSON.stringify(q.map(fe=>({digest:fe.metadata[`${f.EXTENSIONID}/digest`],commands:fe.commands}))))}catch{}}let pe;L&&(pe=G.resolve()),G.delete();const ke=ye.filter(Gt),we=ye.filter(q=>{const fe=q.metadata[`${f.EXTENSIONID}/digest`];return wt(q)&&Te[fe]===void 0});if(k){let q=b.sceneMetadata[`${f.EXTENSIONID}/fowColor`]?b.sceneMetadata[`${f.EXTENSIONID}/fowColor`]:"#00000088",fe=.5;q.length==9&&(fe=Number.parseInt(q.substring(7),16)/255,q=q.substring(0,7));const He=st().commands(Ee.toCmds()).locked(!0).fillRule("evenodd").visible(!0).fillColor(q).fillOpacity(fe).strokeWidth(0).strokeColor("#000000").layer("DRAWING").metadata({[`${f.EXTENSIONID}/isTrailingFog`]:!0}).name("Trailing Fog").build();He.disableHit=!0,ke.length>0?await C.scene.local.updateItems(Gt,Ue=>{for(const S of Ue)S.commands=He.commands},!1):ue.push(C.scene.local.addItems([He]))}else ue.push(C.scene.local.deleteItems(ye.filter(Gt).map(q=>q.id)));Ee.delete(),Q[4].pause(),Q[5].start();const Ve=await C.scene.local.getItems(q=>q.metadata[`${f.EXTENSIONID}/doorId`]!==void 0);D||b.playerRole=="GM"?await Sr():Ve.length>0&&await C.scene.local.deleteItems(Ve.map(q=>q.id));for(const q of Ve){const fe=q.metadata[`${f.EXTENSIONID}/doorId`],He=b.sceneItems.find(Ue=>Ue.id===fe);if(He){const S=q.commands.length==f.DOOROPEN.length,H=!!He.metadata[`${f.EXTENSIONID}/doorOpen`];if(S===H)continue;ue.push(C.scene.local.updateItems([q.id],j=>{const ne=j[0];hr(ne)&&(ne.commands=Si(H))}))}}t.pause(),e.resume(),ue.push(C.scene.local.deleteItems(z.map(q=>q.id))),ue.push(C.scene.local.addItems(le.map(q=>{const fe=st().commands(q.cmds).fillRule("evenodd").locked(!0).visible(q.visible).fillColor("#000000").strokeColor("#000000").layer("FOG").name("Fog of War").metadata({[`${f.EXTENSIONID}/isVisionFog`]:!0,[`${f.EXTENSIONID}/digest`]:q.digest}).build();return fe.zIndex=q.zIndex,fe}))),p||ue.push(C.scene.local.deleteItems(we.map(q=>q.id))),ae.length>0&&ue.push(C.scene.local.addItems(ae)),b.fogFilled||ue.push(C.scene.fog.setFilled(!0)),await Promise.all(ue);let Be=0;Q[5].pause(),Q[6].start(),L&&(await be(pe),pe.delete()),Q[6].pause();const[Xe,$e]=[e.stop(),t.stop()],ge={compute_time:`${$e} ms`,communication_time:`${Xe} ms`,cache_hits:y.toString(),cache_misses:g.toString(),item_counter:Be.toString()};for(let q=1;q<=6;q++){const fe=Q[q].stop();ge["stage"+q]=`${fe} ms`}Ho(ge),b.busy=!1,await C.player.setMetadata({[`${f.EXTENSIONID}/processed`]:!0}),await C.action.setBadgeText(void 0)}async function be(Q){const oe=[],Ie=b.sceneItems.filter(le=>vi(le)&&Wt(le));Q.simplify();for(const le of Ie){const ue=new De.SkOpBuilder,Ee=De.NewPath(),Te=b.gridDpi/le.grid.dpi*(le.image.width/2)*le.scale.x;for(let c=0;c<6;c++){const v=c*60*Math.PI/180,T=le.position.x+Te*Math.cos(v),G=le.position.y+Te*Math.sin(v);c==0?Ee.moveTo(T,G):Ee.lineTo(T,G)}if(Ee.closePath(),b.enableVisionDebug){const c=st().strokeColor("#0000ff").locked(!0).fillOpacity(1).commands(Ee.toCmds()).metadata({[`${f.EXTENSIONID}/debug`]:!0}).build();await C.scene.local.addItems([c])}ue.add(Ee,De.PathOp.UNION),ue.add(Q,De.PathOp.INTERSECT);const ye=ue.resolve(),z=!ye.toCmds().length;if(le.visible==z&&oe.push(le),b.enableVisionDebug){const c=st().fillRule("evenodd").locked(!0).strokeColor("#ff0000").fillOpacity(0).commands(ye.toCmds()).metadata({[`${f.EXTENSIONID}/debug`]:!0}).build();await C.scene.local.addItems([c])}Ee.delete(),ue.delete(),ye.delete()}await C.scene.items.updateItems(oe.map(le=>le.id),le=>{for(let ue=0;ue<le.length;ue++)le[ue].visible=!le[ue].visible})}}function Ho(i){for(const[e,t]of Object.entries(i)){const n=document.getElementById(e);e=="compute_time"||e=="communication_time"||e[0]=="s"?n&&(n.innerText=Number.parseFloat(t).toFixed(1)+"ms"):n&&(n.innerText=t)}}let rt=null;const Vo="#000000",Uo=8,jo=[];async function Fi(){await C.popover.close(f.LINETOOLID),await C.player.setMetadata({[`${f.EXTENSIONID}/finishLine`]:!1})}async function Xi(){if(!rt)return;const[i,e]=rt;e(),rt=null,await Fi(),await C.player.setMetadata({[`${f.EXTENSIONID}/cancelLine`]:!1})}async function Hi(){if(!rt)return;const[i,e]=rt,t=i(n=>{n.visible=!1,n.metadata[`${f.EXTENSIONID}/isVisionLine`]=!0,n.points.pop()});t.points.length>=2&&await C.scene.items.addItems([t]),e(),rt=null,await Fi(),await C.player.setMetadata({[`${f.EXTENSIONID}/finishLine`]:!1})}async function Go(i,e){if(!e.transformer)if(rt){const[t]=rt;t(n=>{n.points.push(e.pointerPosition)})}else{const t=Qt().tension(0).points([e.pointerPosition,e.pointerPosition]).strokeColor(b.sceneMetadata[`${f.EXTENSIONID}/toolColor`]??Vo).strokeDash(b.sceneMetadata[`${f.EXTENSIONID}/toolStyle`]??jo).strokeWidth(b.sceneMetadata[`${f.EXTENSIONID}/toolWidth`]??Uo).fillOpacity(0).fillColor("#000000").layer("DRAWING").name("Vision Line (Line)").closed(!1).locked(!0).build();rt=await C.interaction.startItemInteraction(t),await C.popover.open({id:f.LINETOOLID,url:"/pages/line.html",height:70,width:350,disableClickAway:!0})}}function Wo(i,e){if(!rt||e.transformer)return;const[t]=rt,n=Math.round(b.gridDpi/b.gridSnap),r=Math.round(e.pointerPosition.x/b.gridDpi)*b.gridDpi,o=Math.round(e.pointerPosition.y/b.gridDpi)*b.gridDpi,l=Math.abs(r-e.pointerPosition.x),d=Math.abs(o-e.pointerPosition.y);let p,I;l<=n?p=r:p=e.pointerPosition.x,d<=n?I=o:I=e.pointerPosition.y,t(k=>{k.points[k.points.length-1]=b.snap?{x:p,y:I}:e.pointerPosition})}function zo(i,e){rt&&(e.key=="Escape"?Xi():e.key=="Enter"&&Hi())}const Nn={onToolClick:Go,onToolMove:Wo,onKeyDown:zo};let ot=null;const qo="#000000",Yo=8,Ko=[];async function Vi(){await C.popover.close(f.POLYTOOLID)}async function Ui(){if(!ot)return;const[i,e]=ot;e(),ot=null,Vi(),await C.player.setMetadata({[`${f.EXTENSIONID}/cancelPoly`]:!1})}async function ji(){if(!ot)return;const[i,e]=ot,t=i(n=>{n.visible=!1,n.metadata[`${f.EXTENSIONID}/isVisionLine`]=!0,n.points.pop(),n.points.push(n.points[0])});t.points.length>=4&&await C.scene.items.addItems([t]),e(),ot=null,Vi(),await C.player.setMetadata({[`${f.EXTENSIONID}/finishPoly`]:!1})}async function Zo(i,e){if(!e.transformer)if(ot){const[t]=ot;t(n=>{n.points.push(e.pointerPosition)})}else{const t=Qt().tension(0).points([e.pointerPosition,e.pointerPosition]).strokeColor(b.sceneMetadata[`${f.EXTENSIONID}/toolColor`]??qo).strokeDash(b.sceneMetadata[`${f.EXTENSIONID}/toolStyle`]??Ko).strokeWidth(b.sceneMetadata[`${f.EXTENSIONID}/toolWidth`]??Yo).fillOpacity(.5).fillColor("#000000").layer("DRAWING").name("Vision Line (Polygon)").locked(!0).build();ot=await C.interaction.startItemInteraction(t),await C.popover.open({id:f.POLYTOOLID,url:"/pages/polygon.html",height:70,width:350,disableClickAway:!0})}}function Jo(i,e){if(!ot||e.transformer)return;const[t]=ot,n=Math.round(b.gridDpi/b.gridSnap),r=Math.round(e.pointerPosition.x/b.gridDpi)*b.gridDpi,o=Math.round(e.pointerPosition.y/b.gridDpi)*b.gridDpi,l=Math.abs(r-e.pointerPosition.x),d=Math.abs(o-e.pointerPosition.y);let p,I;l<=n?p=r:p=e.pointerPosition.x,d<=n?I=o:I=e.pointerPosition.y,t(k=>{k.points[k.points.length-1]=b.snap?{x:p,y:I}:e.pointerPosition})}function Qo(i,e){ot&&(e.key=="Escape"?Ui():e.key=="Enter"&&ji())}const On={onToolClick:Zo,onToolMove:Jo,onKeyDown:Qo};function Xt(i){throw new Error('Could not dynamically require "'+i+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var Gi={exports:{}};(function(i,e){(function(t){i.exports=t()})(function(){return function t(n,r,o){function l(I,k){if(!r[I]){if(!n[I]){var A=typeof Xt=="function"&&Xt;if(!k&&A)return A(I,!0);if(d)return d(I,!0);throw new Error("Cannot find module '"+I+"'")}k=r[I]={exports:{}},n[I][0].call(k.exports,function(D){var F=n[I][1][D];return l(F||D)},k,k.exports,t,n,r,o)}return r[I].exports}for(var d=typeof Xt=="function"&&Xt,p=0;p<o.length;p++)l(o[p]);return l}({1:[function(t,n,r){(function(o,l,d,p,I,k,A,D,F){var w=t("crypto");function P(O,E){E=M(O,E);var h;return(h=E.algorithm!=="passthrough"?w.createHash(E.algorithm):new Z).write===void 0&&(h.write=h.update,h.end=h.update),V(E,h).dispatch(O),h.update||h.end(""),h.digest?h.digest(E.encoding==="buffer"?void 0:E.encoding):(O=h.read(),E.encoding!=="buffer"?O.toString(E.encoding):O)}(r=n.exports=P).sha1=function(O){return P(O)},r.keys=function(O){return P(O,{excludeValues:!0,algorithm:"sha1",encoding:"hex"})},r.MD5=function(O){return P(O,{algorithm:"md5",encoding:"hex"})},r.keysMD5=function(O){return P(O,{algorithm:"md5",encoding:"hex",excludeValues:!0})};var _=w.getHashes?w.getHashes().slice():["sha1","md5"],B=(_.push("passthrough"),["buffer","hex","binary","base64"]);function M(O,E){var h={};if(h.algorithm=(E=E||{}).algorithm||"sha1",h.encoding=E.encoding||"hex",h.excludeValues=!!E.excludeValues,h.algorithm=h.algorithm.toLowerCase(),h.encoding=h.encoding.toLowerCase(),h.ignoreUnknown=E.ignoreUnknown===!0,h.respectType=E.respectType!==!1,h.respectFunctionNames=E.respectFunctionNames!==!1,h.respectFunctionProperties=E.respectFunctionProperties!==!1,h.unorderedArrays=E.unorderedArrays===!0,h.unorderedSets=E.unorderedSets!==!1,h.unorderedObjects=E.unorderedObjects!==!1,h.replacer=E.replacer||void 0,h.excludeKeys=E.excludeKeys||void 0,O===void 0)throw new Error("Object argument required.");for(var y=0;y<_.length;++y)_[y].toLowerCase()===h.algorithm.toLowerCase()&&(h.algorithm=_[y]);if(_.indexOf(h.algorithm)===-1)throw new Error('Algorithm "'+h.algorithm+'"  not supported. supported values: '+_.join(", "));if(B.indexOf(h.encoding)===-1&&h.algorithm!=="passthrough")throw new Error('Encoding "'+h.encoding+'"  not supported. supported values: '+B.join(", "));return h}function X(O){if(typeof O=="function")return/^function\s+\w*\s*\(\s*\)\s*{\s+\[native code\]\s+}$/i.exec(Function.prototype.toString.call(O))!=null}function V(O,E,h){h=h||[];function y(g){return E.update?E.update(g,"utf8"):E.write(g,"utf8")}return{dispatch:function(g){return this["_"+((g=O.replacer?O.replacer(g):g)===null?"null":typeof g)](g)},_object:function(g){var N,$=Object.prototype.toString.call(g),W=/\[object (.*)\]/i.exec($);if(W=(W=W?W[1]:"unknown:["+$+"]").toLowerCase(),0<=($=h.indexOf(g)))return this.dispatch("[CIRCULAR:"+$+"]");if(h.push(g),d!==void 0&&d.isBuffer&&d.isBuffer(g))return y("buffer:"),y(g);if(W==="object"||W==="function"||W==="asyncfunction")return $=Object.keys(g),O.unorderedObjects&&($=$.sort()),O.respectType===!1||X(g)||$.splice(0,0,"prototype","__proto__","constructor"),O.excludeKeys&&($=$.filter(function(ae){return!O.excludeKeys(ae)})),y("object:"+$.length+":"),N=this,$.forEach(function(ae){N.dispatch(ae),y(":"),O.excludeValues||N.dispatch(g[ae]),y(",")});if(!this["_"+W]){if(O.ignoreUnknown)return y("["+W+"]");throw new Error('Unknown object type "'+W+'"')}this["_"+W](g)},_array:function(g,ae){ae=ae!==void 0?ae:O.unorderedArrays!==!1;var $=this;if(y("array:"+g.length+":"),!ae||g.length<=1)return g.forEach(function(se){return $.dispatch(se)});var W=[],ae=g.map(function(se){var ee=new Z,ve=h.slice();return V(O,ee,ve).dispatch(se),W=W.concat(ve.slice(h.length)),ee.read().toString()});return h=h.concat(W),ae.sort(),this._array(ae,!1)},_date:function(g){return y("date:"+g.toJSON())},_symbol:function(g){return y("symbol:"+g.toString())},_error:function(g){return y("error:"+g.toString())},_boolean:function(g){return y("bool:"+g.toString())},_string:function(g){y("string:"+g.length+":"),y(g.toString())},_function:function(g){y("fn:"),X(g)?this.dispatch("[native]"):this.dispatch(g.toString()),O.respectFunctionNames!==!1&&this.dispatch("function-name:"+String(g.name)),O.respectFunctionProperties&&this._object(g)},_number:function(g){return y("number:"+g.toString())},_xml:function(g){return y("xml:"+g.toString())},_null:function(){return y("Null")},_undefined:function(){return y("Undefined")},_regexp:function(g){return y("regex:"+g.toString())},_uint8array:function(g){return y("uint8array:"),this.dispatch(Array.prototype.slice.call(g))},_uint8clampedarray:function(g){return y("uint8clampedarray:"),this.dispatch(Array.prototype.slice.call(g))},_int8array:function(g){return y("int8array:"),this.dispatch(Array.prototype.slice.call(g))},_uint16array:function(g){return y("uint16array:"),this.dispatch(Array.prototype.slice.call(g))},_int16array:function(g){return y("int16array:"),this.dispatch(Array.prototype.slice.call(g))},_uint32array:function(g){return y("uint32array:"),this.dispatch(Array.prototype.slice.call(g))},_int32array:function(g){return y("int32array:"),this.dispatch(Array.prototype.slice.call(g))},_float32array:function(g){return y("float32array:"),this.dispatch(Array.prototype.slice.call(g))},_float64array:function(g){return y("float64array:"),this.dispatch(Array.prototype.slice.call(g))},_arraybuffer:function(g){return y("arraybuffer:"),this.dispatch(new Uint8Array(g))},_url:function(g){return y("url:"+g.toString())},_map:function(g){return y("map:"),g=Array.from(g),this._array(g,O.unorderedSets!==!1)},_set:function(g){return y("set:"),g=Array.from(g),this._array(g,O.unorderedSets!==!1)},_file:function(g){return y("file:"),this.dispatch([g.name,g.size,g.type,g.lastModfied])},_blob:function(){if(O.ignoreUnknown)return y("[blob]");throw Error(`Hashing Blob objects is currently not supported
(see https://github.com/puleos/object-hash/issues/26)
Use "options.replacer" or "options.ignoreUnknown"
`)},_domwindow:function(){return y("domwindow")},_bigint:function(g){return y("bigint:"+g.toString())},_process:function(){return y("process")},_timer:function(){return y("timer")},_pipe:function(){return y("pipe")},_tcp:function(){return y("tcp")},_udp:function(){return y("udp")},_tty:function(){return y("tty")},_statwatcher:function(){return y("statwatcher")},_securecontext:function(){return y("securecontext")},_connection:function(){return y("connection")},_zlib:function(){return y("zlib")},_context:function(){return y("context")},_nodescript:function(){return y("nodescript")},_httpparser:function(){return y("httpparser")},_dataview:function(){return y("dataview")},_signal:function(){return y("signal")},_fsevent:function(){return y("fsevent")},_tlswrap:function(){return y("tlswrap")}}}function Z(){return{buf:"",write:function(O){this.buf+=O},end:function(O){this.buf+=O},read:function(){return this.buf}}}r.writeToStream=function(O,E,h){return h===void 0&&(h=E,E={}),V(E=M(O,E),h).dispatch(O)}}).call(this,t("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},t("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/fake_9a5aa49d.js","/")},{buffer:3,crypto:5,lYpoI2:11}],2:[function(t,n,r){(function(o,l,d,p,I,k,A,D,F){(function(w){var P=typeof Uint8Array<"u"?Uint8Array:Array,_="+".charCodeAt(0),B="/".charCodeAt(0),M="0".charCodeAt(0),X="a".charCodeAt(0),V="A".charCodeAt(0),Z="-".charCodeAt(0),O="_".charCodeAt(0);function E(h){return h=h.charCodeAt(0),h===_||h===Z?62:h===B||h===O?63:h<M?-1:h<M+10?h-M+26+26:h<V+26?h-V:h<X+26?h-X+26:void 0}w.toByteArray=function(h){var y,g;if(0<h.length%4)throw new Error("Invalid string. Length must be a multiple of 4");var N=h.length,N=h.charAt(N-2)==="="?2:h.charAt(N-1)==="="?1:0,$=new P(3*h.length/4-N),W=0<N?h.length-4:h.length,ae=0;function se(ee){$[ae++]=ee}for(y=0;y<W;y+=4,0)se((16711680&(g=E(h.charAt(y))<<18|E(h.charAt(y+1))<<12|E(h.charAt(y+2))<<6|E(h.charAt(y+3))))>>16),se((65280&g)>>8),se(255&g);return N==2?se(255&(g=E(h.charAt(y))<<2|E(h.charAt(y+1))>>4)):N==1&&(se((g=E(h.charAt(y))<<10|E(h.charAt(y+1))<<4|E(h.charAt(y+2))>>2)>>8&255),se(255&g)),$},w.fromByteArray=function(h){var y,g,N,$,W=h.length%3,ae="";function se(ee){return"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(ee)}for(y=0,N=h.length-W;y<N;y+=3)g=(h[y]<<16)+(h[y+1]<<8)+h[y+2],ae+=se(($=g)>>18&63)+se($>>12&63)+se($>>6&63)+se(63&$);switch(W){case 1:ae=(ae+=se((g=h[h.length-1])>>2))+se(g<<4&63)+"==";break;case 2:ae=(ae=(ae+=se((g=(h[h.length-2]<<8)+h[h.length-1])>>10))+se(g>>4&63))+se(g<<2&63)+"="}return ae}})(r===void 0?this.base64js={}:r)}).call(this,t("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},t("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/base64-js/lib/b64.js","/node_modules/gulp-browserify/node_modules/base64-js/lib")},{buffer:3,lYpoI2:11}],3:[function(t,n,r){(function(o,l,_,p,I,k,A,D,F){var w=t("base64-js"),P=t("ieee754");function _(c,v,T){if(!(this instanceof _))return new _(c,v,T);var G,L,J,pe,ke=typeof c;if(v==="base64"&&ke=="string")for(c=(pe=c).trim?pe.trim():pe.replace(/^\s+|\s+$/g,"");c.length%4!=0;)c+="=";if(ke=="number")G=Oe(c);else if(ke=="string")G=_.byteLength(c,v);else{if(ke!="object")throw new Error("First argument needs to be a number, array or string.");G=Oe(c.length)}if(_._useTypedArrays?L=_._augment(new Uint8Array(G)):((L=this).length=G,L._isBuffer=!0),_._useTypedArrays&&typeof c.byteLength=="number")L._set(c);else if(be(pe=c)||_.isBuffer(pe)||pe&&typeof pe=="object"&&typeof pe.length=="number")for(J=0;J<G;J++)_.isBuffer(c)?L[J]=c.readUInt8(J):L[J]=c[J];else if(ke=="string")L.write(c,0,v);else if(ke=="number"&&!_._useTypedArrays&&!T)for(J=0;J<G;J++)L[J]=0;return L}function B(c,v,T,G){return _._charsWritten=le(function(L){for(var J=[],pe=0;pe<L.length;pe++)J.push(255&L.charCodeAt(pe));return J}(v),c,T,G)}function M(c,v,T,G){return _._charsWritten=le(function(L){for(var J,pe,ke=[],we=0;we<L.length;we++)pe=L.charCodeAt(we),J=pe>>8,pe=pe%256,ke.push(pe),ke.push(J);return ke}(v),c,T,G)}function X(c,v,T){var G="";T=Math.min(c.length,T);for(var L=v;L<T;L++)G+=String.fromCharCode(c[L]);return G}function V(c,v,T,J){J||(z(typeof T=="boolean","missing or invalid endian"),z(v!=null,"missing offset"),z(v+1<c.length,"Trying to read beyond buffer length"));var L,J=c.length;if(!(J<=v))return T?(L=c[v],v+1<J&&(L|=c[v+1]<<8)):(L=c[v]<<8,v+1<J&&(L|=c[v+1])),L}function Z(c,v,T,J){J||(z(typeof T=="boolean","missing or invalid endian"),z(v!=null,"missing offset"),z(v+3<c.length,"Trying to read beyond buffer length"));var L,J=c.length;if(!(J<=v))return T?(v+2<J&&(L=c[v+2]<<16),v+1<J&&(L|=c[v+1]<<8),L|=c[v],v+3<J&&(L+=c[v+3]<<24>>>0)):(v+1<J&&(L=c[v+1]<<16),v+2<J&&(L|=c[v+2]<<8),v+3<J&&(L|=c[v+3]),L+=c[v]<<24>>>0),L}function O(c,v,T,G){if(G||(z(typeof T=="boolean","missing or invalid endian"),z(v!=null,"missing offset"),z(v+1<c.length,"Trying to read beyond buffer length")),!(c.length<=v))return G=V(c,v,T,!0),32768&G?-1*(65535-G+1):G}function E(c,v,T,G){if(G||(z(typeof T=="boolean","missing or invalid endian"),z(v!=null,"missing offset"),z(v+3<c.length,"Trying to read beyond buffer length")),!(c.length<=v))return G=Z(c,v,T,!0),2147483648&G?-1*(4294967295-G+1):G}function h(c,v,T,G){return G||(z(typeof T=="boolean","missing or invalid endian"),z(v+3<c.length,"Trying to read beyond buffer length")),P.read(c,v,T,23,4)}function y(c,v,T,G){return G||(z(typeof T=="boolean","missing or invalid endian"),z(v+7<c.length,"Trying to read beyond buffer length")),P.read(c,v,T,52,8)}function g(c,v,T,G,L){if(L||(z(v!=null,"missing value"),z(typeof G=="boolean","missing or invalid endian"),z(T!=null,"missing offset"),z(T+1<c.length,"trying to write beyond buffer length"),Ee(v,65535)),L=c.length,!(L<=T))for(var J=0,pe=Math.min(L-T,2);J<pe;J++)c[T+J]=(v&255<<8*(G?J:1-J))>>>8*(G?J:1-J)}function N(c,v,T,G,L){if(L||(z(v!=null,"missing value"),z(typeof G=="boolean","missing or invalid endian"),z(T!=null,"missing offset"),z(T+3<c.length,"trying to write beyond buffer length"),Ee(v,4294967295)),L=c.length,!(L<=T))for(var J=0,pe=Math.min(L-T,4);J<pe;J++)c[T+J]=v>>>8*(G?J:3-J)&255}function $(c,v,T,G,L){L||(z(v!=null,"missing value"),z(typeof G=="boolean","missing or invalid endian"),z(T!=null,"missing offset"),z(T+1<c.length,"Trying to write beyond buffer length"),Te(v,32767,-32768)),c.length<=T||g(c,0<=v?v:65535+v+1,T,G,L)}function W(c,v,T,G,L){L||(z(v!=null,"missing value"),z(typeof G=="boolean","missing or invalid endian"),z(T!=null,"missing offset"),z(T+3<c.length,"Trying to write beyond buffer length"),Te(v,2147483647,-2147483648)),c.length<=T||N(c,0<=v?v:4294967295+v+1,T,G,L)}function ae(c,v,T,G,L){L||(z(v!=null,"missing value"),z(typeof G=="boolean","missing or invalid endian"),z(T!=null,"missing offset"),z(T+3<c.length,"Trying to write beyond buffer length"),ye(v,34028234663852886e22,-34028234663852886e22)),c.length<=T||P.write(c,v,T,G,23,4)}function se(c,v,T,G,L){L||(z(v!=null,"missing value"),z(typeof G=="boolean","missing or invalid endian"),z(T!=null,"missing offset"),z(T+7<c.length,"Trying to write beyond buffer length"),ye(v,17976931348623157e292,-17976931348623157e292)),c.length<=T||P.write(c,v,T,G,52,8)}r.Buffer=_,r.SlowBuffer=_,r.INSPECT_MAX_BYTES=50,_.poolSize=8192,_._useTypedArrays=function(){try{var c=new ArrayBuffer(0),v=new Uint8Array(c);return v.foo=function(){return 42},v.foo()===42&&typeof v.subarray=="function"}catch{return!1}}(),_.isEncoding=function(c){switch(String(c).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"binary":case"base64":case"raw":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},_.isBuffer=function(c){return!(c==null||!c._isBuffer)},_.byteLength=function(c,v){var T;switch(c+="",v||"utf8"){case"hex":T=c.length/2;break;case"utf8":case"utf-8":T=oe(c).length;break;case"ascii":case"binary":case"raw":T=c.length;break;case"base64":T=Ie(c).length;break;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":T=2*c.length;break;default:throw new Error("Unknown encoding")}return T},_.concat=function(c,v){if(z(be(c),`Usage: Buffer.concat(list, [totalLength])
list should be an Array.`),c.length===0)return new _(0);if(c.length===1)return c[0];if(typeof v!="number")for(L=v=0;L<c.length;L++)v+=c[L].length;for(var T=new _(v),G=0,L=0;L<c.length;L++){var J=c[L];J.copy(T,G),G+=J.length}return T},_.prototype.write=function(c,v,T,G){isFinite(v)?isFinite(T)||(G=T,T=void 0):(we=G,G=v,v=T,T=we),v=Number(v)||0;var L,J,pe,ke,we=this.length-v;switch((!T||we<(T=Number(T)))&&(T=we),G=String(G||"utf8").toLowerCase()){case"hex":L=function(Ve,Be,Xe,$e){Xe=Number(Xe)||0;var ge=Ve.length-Xe;(!$e||ge<($e=Number($e)))&&($e=ge),z((ge=Be.length)%2==0,"Invalid hex string"),ge/2<$e&&($e=ge/2);for(var q=0;q<$e;q++){var fe=parseInt(Be.substr(2*q,2),16);z(!isNaN(fe),"Invalid hex string"),Ve[Xe+q]=fe}return _._charsWritten=2*q,q}(this,c,v,T);break;case"utf8":case"utf-8":J=this,pe=v,ke=T,L=_._charsWritten=le(oe(c),J,pe,ke);break;case"ascii":case"binary":L=B(this,c,v,T);break;case"base64":J=this,pe=v,ke=T,L=_._charsWritten=le(Ie(c),J,pe,ke);break;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":L=M(this,c,v,T);break;default:throw new Error("Unknown encoding")}return L},_.prototype.toString=function(c,v,T){var G,L,J,pe,ke=this;if(c=String(c||"utf8").toLowerCase(),v=Number(v)||0,(T=T!==void 0?Number(T):ke.length)===v)return"";switch(c){case"hex":G=function(we,Ve,Be){var Xe=we.length;(!Ve||Ve<0)&&(Ve=0),(!Be||Be<0||Xe<Be)&&(Be=Xe);for(var $e="",ge=Ve;ge<Be;ge++)$e+=Q(we[ge]);return $e}(ke,v,T);break;case"utf8":case"utf-8":G=function(we,Ve,Be){var Xe="",$e="";Be=Math.min(we.length,Be);for(var ge=Ve;ge<Be;ge++)we[ge]<=127?(Xe+=ue($e)+String.fromCharCode(we[ge]),$e=""):$e+="%"+we[ge].toString(16);return Xe+ue($e)}(ke,v,T);break;case"ascii":case"binary":G=X(ke,v,T);break;case"base64":L=ke,pe=T,G=(J=v)===0&&pe===L.length?w.fromByteArray(L):w.fromByteArray(L.slice(J,pe));break;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":G=function(we,Ve,Be){for(var Xe=we.slice(Ve,Be),$e="",ge=0;ge<Xe.length;ge+=2)$e+=String.fromCharCode(Xe[ge]+256*Xe[ge+1]);return $e}(ke,v,T);break;default:throw new Error("Unknown encoding")}return G},_.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}},_.prototype.copy=function(c,v,T,G){if(v=v||0,(G=G||G===0?G:this.length)!==(T=T||0)&&c.length!==0&&this.length!==0){z(T<=G,"sourceEnd < sourceStart"),z(0<=v&&v<c.length,"targetStart out of bounds"),z(0<=T&&T<this.length,"sourceStart out of bounds"),z(0<=G&&G<=this.length,"sourceEnd out of bounds"),G>this.length&&(G=this.length);var L=(G=c.length-v<G-T?c.length-v+T:G)-T;if(L<100||!_._useTypedArrays)for(var J=0;J<L;J++)c[J+v]=this[J+T];else c._set(this.subarray(T,T+L),v)}},_.prototype.slice=function(c,v){var T=this.length;if(c=ve(c,T,0),v=ve(v,T,T),_._useTypedArrays)return _._augment(this.subarray(c,v));for(var G=v-c,L=new _(G,void 0,!0),J=0;J<G;J++)L[J]=this[J+c];return L},_.prototype.get=function(c){return console.log(".get() is deprecated. Access using array indexes instead."),this.readUInt8(c)},_.prototype.set=function(c,v){return console.log(".set() is deprecated. Access using array indexes instead."),this.writeUInt8(c,v)},_.prototype.readUInt8=function(c,v){if(v||(z(c!=null,"missing offset"),z(c<this.length,"Trying to read beyond buffer length")),!(c>=this.length))return this[c]},_.prototype.readUInt16LE=function(c,v){return V(this,c,!0,v)},_.prototype.readUInt16BE=function(c,v){return V(this,c,!1,v)},_.prototype.readUInt32LE=function(c,v){return Z(this,c,!0,v)},_.prototype.readUInt32BE=function(c,v){return Z(this,c,!1,v)},_.prototype.readInt8=function(c,v){if(v||(z(c!=null,"missing offset"),z(c<this.length,"Trying to read beyond buffer length")),!(c>=this.length))return 128&this[c]?-1*(255-this[c]+1):this[c]},_.prototype.readInt16LE=function(c,v){return O(this,c,!0,v)},_.prototype.readInt16BE=function(c,v){return O(this,c,!1,v)},_.prototype.readInt32LE=function(c,v){return E(this,c,!0,v)},_.prototype.readInt32BE=function(c,v){return E(this,c,!1,v)},_.prototype.readFloatLE=function(c,v){return h(this,c,!0,v)},_.prototype.readFloatBE=function(c,v){return h(this,c,!1,v)},_.prototype.readDoubleLE=function(c,v){return y(this,c,!0,v)},_.prototype.readDoubleBE=function(c,v){return y(this,c,!1,v)},_.prototype.writeUInt8=function(c,v,T){T||(z(c!=null,"missing value"),z(v!=null,"missing offset"),z(v<this.length,"trying to write beyond buffer length"),Ee(c,255)),v>=this.length||(this[v]=c)},_.prototype.writeUInt16LE=function(c,v,T){g(this,c,v,!0,T)},_.prototype.writeUInt16BE=function(c,v,T){g(this,c,v,!1,T)},_.prototype.writeUInt32LE=function(c,v,T){N(this,c,v,!0,T)},_.prototype.writeUInt32BE=function(c,v,T){N(this,c,v,!1,T)},_.prototype.writeInt8=function(c,v,T){T||(z(c!=null,"missing value"),z(v!=null,"missing offset"),z(v<this.length,"Trying to write beyond buffer length"),Te(c,127,-128)),v>=this.length||(0<=c?this.writeUInt8(c,v,T):this.writeUInt8(255+c+1,v,T))},_.prototype.writeInt16LE=function(c,v,T){$(this,c,v,!0,T)},_.prototype.writeInt16BE=function(c,v,T){$(this,c,v,!1,T)},_.prototype.writeInt32LE=function(c,v,T){W(this,c,v,!0,T)},_.prototype.writeInt32BE=function(c,v,T){W(this,c,v,!1,T)},_.prototype.writeFloatLE=function(c,v,T){ae(this,c,v,!0,T)},_.prototype.writeFloatBE=function(c,v,T){ae(this,c,v,!1,T)},_.prototype.writeDoubleLE=function(c,v,T){se(this,c,v,!0,T)},_.prototype.writeDoubleBE=function(c,v,T){se(this,c,v,!1,T)},_.prototype.fill=function(c,v,T){if(v=v||0,T=T||this.length,z(typeof(c=typeof(c=c||0)=="string"?c.charCodeAt(0):c)=="number"&&!isNaN(c),"value is not a number"),z(v<=T,"end < start"),T!==v&&this.length!==0){z(0<=v&&v<this.length,"start out of bounds"),z(0<=T&&T<=this.length,"end out of bounds");for(var G=v;G<T;G++)this[G]=c}},_.prototype.inspect=function(){for(var c=[],v=this.length,T=0;T<v;T++)if(c[T]=Q(this[T]),T===r.INSPECT_MAX_BYTES){c[T+1]="...";break}return"<Buffer "+c.join(" ")+">"},_.prototype.toArrayBuffer=function(){if(typeof Uint8Array>"u")throw new Error("Buffer.toArrayBuffer not supported in this browser");if(_._useTypedArrays)return new _(this).buffer;for(var c=new Uint8Array(this.length),v=0,T=c.length;v<T;v+=1)c[v]=this[v];return c.buffer};var ee=_.prototype;function ve(c,v,T){return typeof c!="number"?T:v<=(c=~~c)?v:0<=c||0<=(c+=v)?c:0}function Oe(c){return(c=~~Math.ceil(+c))<0?0:c}function be(c){return(Array.isArray||function(v){return Object.prototype.toString.call(v)==="[object Array]"})(c)}function Q(c){return c<16?"0"+c.toString(16):c.toString(16)}function oe(c){for(var v=[],T=0;T<c.length;T++){var G=c.charCodeAt(T);if(G<=127)v.push(c.charCodeAt(T));else for(var L=T,J=(55296<=G&&G<=57343&&T++,encodeURIComponent(c.slice(L,T+1)).substr(1).split("%")),pe=0;pe<J.length;pe++)v.push(parseInt(J[pe],16))}return v}function Ie(c){return w.toByteArray(c)}function le(c,v,T,G){for(var L=0;L<G&&!(L+T>=v.length||L>=c.length);L++)v[L+T]=c[L];return L}function ue(c){try{return decodeURIComponent(c)}catch{return String.fromCharCode(65533)}}function Ee(c,v){z(typeof c=="number","cannot write a non-number as a number"),z(0<=c,"specified a negative value for writing an unsigned value"),z(c<=v,"value is larger than maximum value for type"),z(Math.floor(c)===c,"value has a fractional component")}function Te(c,v,T){z(typeof c=="number","cannot write a non-number as a number"),z(c<=v,"value larger than maximum allowed value"),z(T<=c,"value smaller than minimum allowed value"),z(Math.floor(c)===c,"value has a fractional component")}function ye(c,v,T){z(typeof c=="number","cannot write a non-number as a number"),z(c<=v,"value larger than maximum allowed value"),z(T<=c,"value smaller than minimum allowed value")}function z(c,v){if(!c)throw new Error(v||"Failed assertion")}_._augment=function(c){return c._isBuffer=!0,c._get=c.get,c._set=c.set,c.get=ee.get,c.set=ee.set,c.write=ee.write,c.toString=ee.toString,c.toLocaleString=ee.toString,c.toJSON=ee.toJSON,c.copy=ee.copy,c.slice=ee.slice,c.readUInt8=ee.readUInt8,c.readUInt16LE=ee.readUInt16LE,c.readUInt16BE=ee.readUInt16BE,c.readUInt32LE=ee.readUInt32LE,c.readUInt32BE=ee.readUInt32BE,c.readInt8=ee.readInt8,c.readInt16LE=ee.readInt16LE,c.readInt16BE=ee.readInt16BE,c.readInt32LE=ee.readInt32LE,c.readInt32BE=ee.readInt32BE,c.readFloatLE=ee.readFloatLE,c.readFloatBE=ee.readFloatBE,c.readDoubleLE=ee.readDoubleLE,c.readDoubleBE=ee.readDoubleBE,c.writeUInt8=ee.writeUInt8,c.writeUInt16LE=ee.writeUInt16LE,c.writeUInt16BE=ee.writeUInt16BE,c.writeUInt32LE=ee.writeUInt32LE,c.writeUInt32BE=ee.writeUInt32BE,c.writeInt8=ee.writeInt8,c.writeInt16LE=ee.writeInt16LE,c.writeInt16BE=ee.writeInt16BE,c.writeInt32LE=ee.writeInt32LE,c.writeInt32BE=ee.writeInt32BE,c.writeFloatLE=ee.writeFloatLE,c.writeFloatBE=ee.writeFloatBE,c.writeDoubleLE=ee.writeDoubleLE,c.writeDoubleBE=ee.writeDoubleBE,c.fill=ee.fill,c.inspect=ee.inspect,c.toArrayBuffer=ee.toArrayBuffer,c}}).call(this,t("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},t("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/buffer/index.js","/node_modules/gulp-browserify/node_modules/buffer")},{"base64-js":2,buffer:3,ieee754:10,lYpoI2:11}],4:[function(t,n,r){(function(o,l,w,p,I,k,A,D,F){var w=t("buffer").Buffer,P=4,_=new w(P);_.fill(0),n.exports={hash:function(B,M,X,V){for(var Z=M(function(g,N){g.length%P!=0&&($=g.length+(P-g.length%P),g=w.concat([g,_],$));for(var $,W=[],ae=N?g.readInt32BE:g.readInt32LE,se=0;se<g.length;se+=P)W.push(ae.call(g,se));return W}(B=w.isBuffer(B)?B:new w(B),V),8*B.length),M=V,O=new w(X),E=M?O.writeInt32BE:O.writeInt32LE,h=0;h<Z.length;h++)E.call(O,Z[h],4*h,!0);return O}}}).call(this,t("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},t("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/crypto-browserify/helpers.js","/node_modules/gulp-browserify/node_modules/crypto-browserify")},{buffer:3,lYpoI2:11}],5:[function(t,n,r){(function(o,l,w,p,I,k,A,D,F){var w=t("buffer").Buffer,P=t("./sha"),_=t("./sha256"),B=t("./rng"),M={sha1:P,sha256:_,md5:t("./md5")},X=64,V=new w(X);function Z(g,N){var $=M[g=g||"sha1"],W=[];return $||O("algorithm:",g,"is not yet supported"),{update:function(ae){return w.isBuffer(ae)||(ae=new w(ae)),W.push(ae),ae.length,this},digest:function(ae){var se=w.concat(W),se=N?function(ee,ve,Oe){w.isBuffer(ve)||(ve=new w(ve)),w.isBuffer(Oe)||(Oe=new w(Oe)),ve.length>X?ve=ee(ve):ve.length<X&&(ve=w.concat([ve,V],X));for(var be=new w(X),Q=new w(X),oe=0;oe<X;oe++)be[oe]=54^ve[oe],Q[oe]=92^ve[oe];return Oe=ee(w.concat([be,Oe])),ee(w.concat([Q,Oe]))}($,N,se):$(se);return W=null,ae?se.toString(ae):se}}}function O(){var g=[].slice.call(arguments).join(" ");throw new Error([g,"we accept pull requests","http://github.com/dominictarr/crypto-browserify"].join(`
`))}V.fill(0),r.createHash=function(g){return Z(g)},r.createHmac=Z,r.randomBytes=function(g,N){if(!N||!N.call)return new w(B(g));try{N.call(this,void 0,new w(B(g)))}catch($){N($)}};var E,h=["createCredentials","createCipher","createCipheriv","createDecipher","createDecipheriv","createSign","createVerify","createDiffieHellman","pbkdf2"],y=function(g){r[g]=function(){O("sorry,",g,"is not implemented yet")}};for(E in h)y(h[E])}).call(this,t("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},t("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/crypto-browserify/index.js","/node_modules/gulp-browserify/node_modules/crypto-browserify")},{"./md5":6,"./rng":7,"./sha":8,"./sha256":9,buffer:3,lYpoI2:11}],6:[function(t,n,r){(function(o,l,d,p,I,k,A,D,F){var w=t("./helpers");function P(O,E){O[E>>5]|=128<<E%32,O[14+(E+64>>>9<<4)]=E;for(var h=1732584193,y=-271733879,g=-1732584194,N=271733878,$=0;$<O.length;$+=16){var W=h,ae=y,se=g,ee=N,h=B(h,y,g,N,O[$+0],7,-680876936),N=B(N,h,y,g,O[$+1],12,-389564586),g=B(g,N,h,y,O[$+2],17,606105819),y=B(y,g,N,h,O[$+3],22,-1044525330);h=B(h,y,g,N,O[$+4],7,-176418897),N=B(N,h,y,g,O[$+5],12,1200080426),g=B(g,N,h,y,O[$+6],17,-1473231341),y=B(y,g,N,h,O[$+7],22,-45705983),h=B(h,y,g,N,O[$+8],7,1770035416),N=B(N,h,y,g,O[$+9],12,-1958414417),g=B(g,N,h,y,O[$+10],17,-42063),y=B(y,g,N,h,O[$+11],22,-1990404162),h=B(h,y,g,N,O[$+12],7,1804603682),N=B(N,h,y,g,O[$+13],12,-40341101),g=B(g,N,h,y,O[$+14],17,-1502002290),h=M(h,y=B(y,g,N,h,O[$+15],22,1236535329),g,N,O[$+1],5,-165796510),N=M(N,h,y,g,O[$+6],9,-1069501632),g=M(g,N,h,y,O[$+11],14,643717713),y=M(y,g,N,h,O[$+0],20,-373897302),h=M(h,y,g,N,O[$+5],5,-701558691),N=M(N,h,y,g,O[$+10],9,38016083),g=M(g,N,h,y,O[$+15],14,-660478335),y=M(y,g,N,h,O[$+4],20,-405537848),h=M(h,y,g,N,O[$+9],5,568446438),N=M(N,h,y,g,O[$+14],9,-1019803690),g=M(g,N,h,y,O[$+3],14,-187363961),y=M(y,g,N,h,O[$+8],20,1163531501),h=M(h,y,g,N,O[$+13],5,-1444681467),N=M(N,h,y,g,O[$+2],9,-51403784),g=M(g,N,h,y,O[$+7],14,1735328473),h=X(h,y=M(y,g,N,h,O[$+12],20,-1926607734),g,N,O[$+5],4,-378558),N=X(N,h,y,g,O[$+8],11,-2022574463),g=X(g,N,h,y,O[$+11],16,1839030562),y=X(y,g,N,h,O[$+14],23,-35309556),h=X(h,y,g,N,O[$+1],4,-1530992060),N=X(N,h,y,g,O[$+4],11,1272893353),g=X(g,N,h,y,O[$+7],16,-155497632),y=X(y,g,N,h,O[$+10],23,-1094730640),h=X(h,y,g,N,O[$+13],4,681279174),N=X(N,h,y,g,O[$+0],11,-358537222),g=X(g,N,h,y,O[$+3],16,-722521979),y=X(y,g,N,h,O[$+6],23,76029189),h=X(h,y,g,N,O[$+9],4,-640364487),N=X(N,h,y,g,O[$+12],11,-421815835),g=X(g,N,h,y,O[$+15],16,530742520),h=V(h,y=X(y,g,N,h,O[$+2],23,-995338651),g,N,O[$+0],6,-198630844),N=V(N,h,y,g,O[$+7],10,1126891415),g=V(g,N,h,y,O[$+14],15,-1416354905),y=V(y,g,N,h,O[$+5],21,-57434055),h=V(h,y,g,N,O[$+12],6,1700485571),N=V(N,h,y,g,O[$+3],10,-1894986606),g=V(g,N,h,y,O[$+10],15,-1051523),y=V(y,g,N,h,O[$+1],21,-2054922799),h=V(h,y,g,N,O[$+8],6,1873313359),N=V(N,h,y,g,O[$+15],10,-30611744),g=V(g,N,h,y,O[$+6],15,-1560198380),y=V(y,g,N,h,O[$+13],21,1309151649),h=V(h,y,g,N,O[$+4],6,-145523070),N=V(N,h,y,g,O[$+11],10,-1120210379),g=V(g,N,h,y,O[$+2],15,718787259),y=V(y,g,N,h,O[$+9],21,-343485551),h=Z(h,W),y=Z(y,ae),g=Z(g,se),N=Z(N,ee)}return Array(h,y,g,N)}function _(O,E,h,y,g,N){return Z((E=Z(Z(E,O),Z(y,N)))<<g|E>>>32-g,h)}function B(O,E,h,y,g,N,$){return _(E&h|~E&y,O,E,g,N,$)}function M(O,E,h,y,g,N,$){return _(E&y|h&~y,O,E,g,N,$)}function X(O,E,h,y,g,N,$){return _(E^h^y,O,E,g,N,$)}function V(O,E,h,y,g,N,$){return _(h^(E|~y),O,E,g,N,$)}function Z(O,E){var h=(65535&O)+(65535&E);return(O>>16)+(E>>16)+(h>>16)<<16|65535&h}n.exports=function(O){return w.hash(O,P,16)}}).call(this,t("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},t("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/crypto-browserify/md5.js","/node_modules/gulp-browserify/node_modules/crypto-browserify")},{"./helpers":4,buffer:3,lYpoI2:11}],7:[function(t,n,r){(function(o,l,d,p,I,k,A,D,F){n.exports=function(w){for(var P,_=new Array(w),B=0;B<w;B++)!(3&B)&&(P=4294967296*Math.random()),_[B]=P>>>((3&B)<<3)&255;return _}}).call(this,t("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},t("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/crypto-browserify/rng.js","/node_modules/gulp-browserify/node_modules/crypto-browserify")},{buffer:3,lYpoI2:11}],8:[function(t,n,r){(function(o,l,d,p,I,k,A,D,F){var w=t("./helpers");function P(M,X){M[X>>5]|=128<<24-X%32,M[15+(X+64>>9<<4)]=X;for(var V,Z,O,E=Array(80),h=1732584193,y=-271733879,g=-1732584194,N=271733878,$=-1009589776,W=0;W<M.length;W+=16){for(var ae=h,se=y,ee=g,ve=N,Oe=$,be=0;be<80;be++){E[be]=be<16?M[W+be]:B(E[be-3]^E[be-8]^E[be-14]^E[be-16],1);var Q=_(_(B(h,5),(Q=y,Z=g,O=N,(V=be)<20?Q&Z|~Q&O:!(V<40)&&V<60?Q&Z|Q&O|Z&O:Q^Z^O)),_(_($,E[be]),(V=be)<20?1518500249:V<40?1859775393:V<60?-1894007588:-899497514)),$=N,N=g,g=B(y,30),y=h,h=Q}h=_(h,ae),y=_(y,se),g=_(g,ee),N=_(N,ve),$=_($,Oe)}return Array(h,y,g,N,$)}function _(M,X){var V=(65535&M)+(65535&X);return(M>>16)+(X>>16)+(V>>16)<<16|65535&V}function B(M,X){return M<<X|M>>>32-X}n.exports=function(M){return w.hash(M,P,20,!0)}}).call(this,t("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},t("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/crypto-browserify/sha.js","/node_modules/gulp-browserify/node_modules/crypto-browserify")},{"./helpers":4,buffer:3,lYpoI2:11}],9:[function(t,n,r){(function(o,l,d,p,I,k,A,D,F){function w(X,V){var Z=(65535&X)+(65535&V);return(X>>16)+(V>>16)+(Z>>16)<<16|65535&Z}function P(X,V){var Z,O=new Array(1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298),E=new Array(1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225),h=new Array(64);X[V>>5]|=128<<24-V%32,X[15+(V+64>>9<<4)]=V;for(var y,g,N=0;N<X.length;N+=16){for(var $=E[0],W=E[1],ae=E[2],se=E[3],ee=E[4],ve=E[5],Oe=E[6],be=E[7],Q=0;Q<64;Q++)h[Q]=Q<16?X[Q+N]:w(w(w((g=h[Q-2],B(g,17)^B(g,19)^M(g,10)),h[Q-7]),(g=h[Q-15],B(g,7)^B(g,18)^M(g,3))),h[Q-16]),Z=w(w(w(w(be,B(g=ee,6)^B(g,11)^B(g,25)),ee&ve^~ee&Oe),O[Q]),h[Q]),y=w(B(y=$,2)^B(y,13)^B(y,22),$&W^$&ae^W&ae),be=Oe,Oe=ve,ve=ee,ee=w(se,Z),se=ae,ae=W,W=$,$=w(Z,y);E[0]=w($,E[0]),E[1]=w(W,E[1]),E[2]=w(ae,E[2]),E[3]=w(se,E[3]),E[4]=w(ee,E[4]),E[5]=w(ve,E[5]),E[6]=w(Oe,E[6]),E[7]=w(be,E[7])}return E}var _=t("./helpers"),B=function(X,V){return X>>>V|X<<32-V},M=function(X,V){return X>>>V};n.exports=function(X){return _.hash(X,P,32,!0)}}).call(this,t("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},t("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/crypto-browserify/sha256.js","/node_modules/gulp-browserify/node_modules/crypto-browserify")},{"./helpers":4,buffer:3,lYpoI2:11}],10:[function(t,n,r){(function(o,l,d,p,I,k,A,D,F){r.read=function(w,P,_,B,N){var X,V,Z=8*N-B-1,O=(1<<Z)-1,E=O>>1,h=-7,y=_?N-1:0,g=_?-1:1,N=w[P+y];for(y+=g,X=N&(1<<-h)-1,N>>=-h,h+=Z;0<h;X=256*X+w[P+y],y+=g,h-=8);for(V=X&(1<<-h)-1,X>>=-h,h+=B;0<h;V=256*V+w[P+y],y+=g,h-=8);if(X===0)X=1-E;else{if(X===O)return V?NaN:1/0*(N?-1:1);V+=Math.pow(2,B),X-=E}return(N?-1:1)*V*Math.pow(2,X-B)},r.write=function(w,P,_,B,M,$){var V,Z,O=8*$-M-1,E=(1<<O)-1,h=E>>1,y=M===23?Math.pow(2,-24)-Math.pow(2,-77):0,g=B?0:$-1,N=B?1:-1,$=P<0||P===0&&1/P<0?1:0;for(P=Math.abs(P),isNaN(P)||P===1/0?(Z=isNaN(P)?1:0,V=E):(V=Math.floor(Math.log(P)/Math.LN2),P*(B=Math.pow(2,-V))<1&&(V--,B*=2),2<=(P+=1<=V+h?y/B:y*Math.pow(2,1-h))*B&&(V++,B/=2),E<=V+h?(Z=0,V=E):1<=V+h?(Z=(P*B-1)*Math.pow(2,M),V+=h):(Z=P*Math.pow(2,h-1)*Math.pow(2,M),V=0));8<=M;w[_+g]=255&Z,g+=N,Z/=256,M-=8);for(V=V<<M|Z,O+=M;0<O;w[_+g]=255&V,g+=N,V/=256,O-=8);w[_+g-N]|=128*$}}).call(this,t("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},t("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/ieee754/index.js","/node_modules/gulp-browserify/node_modules/ieee754")},{buffer:3,lYpoI2:11}],11:[function(t,n,r){(function(o,l,d,p,I,k,A,D,F){var w,P,_;function B(){}(o=n.exports={}).nextTick=(P=typeof window<"u"&&window.setImmediate,_=typeof window<"u"&&window.postMessage&&window.addEventListener,P?function(M){return window.setImmediate(M)}:_?(w=[],window.addEventListener("message",function(M){var X=M.source;X!==window&&X!==null||M.data!=="process-tick"||(M.stopPropagation(),0<w.length&&w.shift()())},!0),function(M){w.push(M),window.postMessage("process-tick","*")}):function(M){setTimeout(M,0)}),o.title="browser",o.browser=!0,o.env={},o.argv=[],o.on=B,o.addListener=B,o.once=B,o.off=B,o.removeListener=B,o.removeAllListeners=B,o.emit=B,o.binding=function(M){throw new Error("process.binding is not supported")},o.cwd=function(){return"/"},o.chdir=function(M){throw new Error("process.chdir is not supported")}}).call(this,t("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},t("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/process/browser.js","/node_modules/gulp-browserify/node_modules/process")},{buffer:3,lYpoI2:11}]},{},[1])(1)})})(Gi);var ea=Gi.exports;const Ht=$n(ea);class ta{cache;useHash;constructor(e){this.cache={},this.useHash=e}cacheValue(e,t){this.cache[this.useHash?Ht(e):String(e)]=t}deleteValue(e){delete this.cache[this.useHash?Ht(e):String(e)]}getValue(e){return this.cache[this.useHash?Ht(e):String(e)]}isCached(e){return(this.useHash?Ht(e):String(e))in this.cache}invalidate(e){e&&Object.entries(this.cache).forEach(([t,n])=>e(t,n)),this.cache={}}}function na(){return new Worker("/assets/worker-57f2ae30.js",{type:"module"})}class Me{static PLAYER="PLAYER";static PARTY="PARTY";static SCENEITEMS="SCENEITEMS";static SCENEMETA="SCENEMETADATA";static SCENEGRID="SCENEGRID";static SCENEFOG="SCENEFOG";static ROOMMETA="ROOMMETADATA";playerId;playerColor;playerName;playerMetadata;playerRole;party;lastParty;fogFilled;fogColor;fogStroke;gridDpi;gridScale;gridSnap;storedMetaItems;sceneItems;sceneSelected;sceneMetadata;sceneReady;sceneInitialized;roomMetadata;theme;caches;playerShadowCache;ghosts;snap;torchActive;previousVisionShapes;previousAutohideItems;previousPlayersWithVision;previousSize=[];previousVisionEnabled;previousMap;previousAutodetectEnabled;previousFowEnabled;previousPersistenceEnabled;previousFowColor;busy;workers;workersSetup;enableVisionDebug;sceneMetadataHandler;sceneItemsHandler;sceneGridHandler;sceneReadyHandler;playerHandler;partyHandler;themeHandler;roomHandler;fogHandler;constructor(e){this.playerId="",this.playerName="",this.playerColor="",this.playerMetadata={},this.playerRole="PLAYER",this.party=[],this.lastParty=[],this.fogFilled=!1,this.fogColor="#000",this.fogStroke=5,this.storedMetaItems=[],this.sceneItems=[],this.sceneSelected=[],this.sceneMetadata={},this.gridDpi=0,this.gridScale=5,this.gridSnap=10,this.sceneReady=!1,this.sceneInitialized=!1,this.theme="DARK",this.roomMetadata={},this.ghosts=[],this.snap=!1,this.busy=!1,this.torchActive=!1,this.caches=e,this.playerShadowCache=new ta(!1),this.previousVisionShapes="",this.previousAutohideItems="",this.previousPlayersWithVision="",this.previousSize=[],this.previousVisionEnabled=!1,this.previousMap="",this.previousAutodetectEnabled=!1,this.previousFowEnabled=!1,this.previousPersistenceEnabled=!1,this.previousFowColor="",this.enableVisionDebug=!1,this.workers=[],this.workersSetup=!1}async InitializeCache(){if(this.CreateWorkers(),this.sceneReady=await C.scene.isReady(),this.theme=await C.theme.getTheme(),ii(this.theme,document),this.caches.includes(Me.PLAYER)&&(this.playerId=await C.player.getId(),this.playerName=await C.player.getName(),this.playerColor=await C.player.getColor(),this.playerMetadata=await C.player.getMetadata(),this.playerRole=await C.player.getRole()),this.caches.includes(Me.PARTY)&&(this.party=await C.party.getPlayers()),this.caches.includes(Me.SCENEFOG)&&this.sceneReady&&(this.fogColor=await C.scene.fog.getColor(),this.fogFilled=await C.scene.fog.getFilled()),this.caches.includes(Me.SCENEITEMS)&&this.sceneReady&&(this.sceneItems=await C.scene.items.getItems()),this.caches.includes(Me.SCENEMETA)&&this.sceneReady){this.sceneMetadata=await C.scene.getMetadata();const e=this.sceneMetadata[`${f.EXTENSIONID}/stored`];e&&(this.storedMetaItems=e)}this.caches.includes(Me.SCENEGRID)&&this.sceneReady&&(this.gridDpi=await C.scene.grid.getDpi(),this.gridScale=(await C.scene.grid.getScale()).parsed?.multiplier??5),this.caches.includes(Me.ROOMMETA)&&this.sceneReady&&(this.roomMetadata=await C.room.getMetadata()),C.broadcast.onMessage(f.RESETID,async e=>{e.data&&await re.ResetPersistence()}),this.SaveUserToScene()}CreateWorkers(){const t=Math.min(navigator.hardwareConcurrency??1,16);for(let n=0;n<t;n++){const r=new na;this.workers.push(r)}}async SaveUserToScene(){await C.scene.setMetadata({[`${f.EXTENSIONID}/USER-${this.playerId}`]:{role:this.playerRole,name:this.playerName,color:this.playerColor}})}KillHandlers(){this.caches.includes(Me.SCENEMETA)&&this.sceneMetadataHandler!==void 0&&this.sceneMetadataHandler(),this.caches.includes(Me.SCENEITEMS)&&this.sceneItemsHandler!==void 0&&this.sceneItemsHandler(),this.caches.includes(Me.SCENEGRID)&&this.sceneGridHandler!==void 0&&this.sceneGridHandler(),this.caches.includes(Me.PLAYER)&&this.playerHandler!==void 0&&this.playerHandler(),this.caches.includes(Me.PARTY)&&this.partyHandler!==void 0&&this.partyHandler(),this.caches.includes(Me.ROOMMETA)&&this.roomHandler!==void 0&&this.roomHandler(),this.caches.includes(Me.SCENEFOG)&&this.fogHandler!==void 0&&this.fogHandler(),this.themeHandler!==void 0&&this.themeHandler()}SetupHandlers(){(this.sceneMetadataHandler===void 0||this.sceneMetadataHandler.length===0)&&this.caches.includes(Me.SCENEMETA)&&(this.sceneMetadataHandler=C.scene.onMetadataChange(async e=>{this.sceneMetadata=e,await this.OnSceneMetadataChanges(e)})),(this.sceneItemsHandler===void 0||this.sceneItemsHandler.length===0)&&this.caches.includes(Me.SCENEITEMS)&&(this.sceneItemsHandler=C.scene.items.onChange(async e=>{this.sceneItems=e,await this.OnSceneItemsChange(e)})),(this.sceneGridHandler===void 0||this.sceneGridHandler.length===0)&&this.caches.includes(Me.SCENEGRID)&&(this.sceneGridHandler=C.scene.grid.onChange(async e=>{await this.OnSceneGridChange(e),this.gridDpi=e.dpi,this.gridScale=parseInt(e.scale)})),(this.playerHandler===void 0||this.playerHandler.length===0)&&this.caches.includes(Me.PLAYER)&&(this.playerHandler=C.player.onChange(async e=>{let t=!1;(this.playerName!==e.name||this.playerColor!==e.color||this.playerRole!==e.role)&&(t=!0),await this.OnPlayerChange(e),this.playerName=e.name,this.playerColor=e.color,this.playerId=e.id,this.playerRole=e.role,this.playerMetadata=e.metadata,t&&await this.SaveUserToScene()})),(this.partyHandler===void 0||this.partyHandler.length===0)&&this.caches.includes(Me.PARTY)&&(this.partyHandler=C.party.onChange(async e=>{this.party=e.filter(t=>t.id!==""),await this.OnPartyChange(e)})),(this.roomHandler===void 0||this.roomHandler.length===0)&&this.caches.includes(Me.ROOMMETA)&&(this.roomHandler=C.room.onMetadataChange(async e=>{await this.OnRoomMetadataChange(e),this.roomMetadata=e})),(this.fogHandler===void 0||this.fogHandler.length===0)&&this.caches.includes(Me.ROOMMETA)&&(this.fogHandler=C.scene.fog.onChange(async e=>{await this.OnFogChange(e),this.fogColor=e.style.color,this.fogFilled=e.filled})),this.themeHandler===void 0&&(this.themeHandler=C.theme.onChange(async e=>{this.theme=e.mode,await this.OnThemeChange(e)})),this.sceneReadyHandler===void 0&&(this.sceneReadyHandler=C.scene.onReadyChange(async e=>{this.sceneReady=e,e&&(this.sceneItems=await C.scene.items.getItems(),this.sceneMetadata=await C.scene.getMetadata(),this.gridDpi=await C.scene.grid.getDpi(),this.gridScale=(await C.scene.grid.getScale()).parsed?.multiplier??5),await this.OnSceneReadyChange(e)}))}async OnSceneMetadataChanges(e){this.playerRole==="GM"&&await _n(),await vt()}async OnSceneItemsChange(e){this.playerRole==="GM"?(await re.UpdateUI(),await xn(re.mapAlign)):re.UpdatePlayerVisionList(),await vt()}async OnSceneGridChange(e){await vt()}async OnSceneReadyChange(e){e?(this.KillHandlers(),await Mn(),await vt(),this.SetupHandlers(),this.playerRole==="GM"&&await _n()):this.playerRole==="GM"&&(this.sceneInitialized=!1,await re.UpdateUI())}async OnPlayerChange(e){this.playerRole!==e.role&&(e.role==="GM"&&(await C.action.setHeight(510),await C.action.setWidth(420)),await re.SoftReset(),e.role==="PLAYER"&&re.UpdatePlayerVisionList());const t=document.querySelectorAll(".token-table-entry");for(let p of t){let I=p.id.substring(3);e.selection!==void 0&&e.selection.includes(I)?p.classList.add("token-table-selected"):p.classList.remove("token-table-selected")}e.selection!==void 0&&e.selection.length===1&&br(e.selection[0]);const n=e.metadata;(n[`${f.EXTENSIONID}/finishLine`]??!1)===!0&&Hi(),(n[`${f.EXTENSIONID}/cancelLine`]??!1)===!0&&Xi(),(n[`${f.EXTENSIONID}/finishPoly`]??!1)===!0&&ji(),(n[`${f.EXTENSIONID}/cancelPoly`]??!1)===!0&&Ui()}async OnPartyChange(e){if(this.playerRole==="PLAYER")await _o(this.party);else{const t=document.getElementById("playerListing");t.innerHTML="",t.appendChild(re.GetEmptyContextItem());for(const n of this.party){const r=document.createElement("li");r.id=n.id,r.textContent=n.name,r.style.color=n.color,t.appendChild(r)}xo(),re.UpdatePlayerProcessUI()}}async OnFogChange(e){}async OnRoomMetadataChange(e){}async OnThemeChange(e){ii(e,document)}}const b=new Me([Me.SCENEITEMS,Me.SCENEMETA,Me.SCENEFOG,Me.SCENEGRID,Me.PLAYER,Me.PARTY]);function ia(i){return i.layer=="MAP"&&(i.metadata[`${f.EXTENSIONID}/isBackgroundImage`]||i.metadata[`${f.ARMINDOID}/isBackgroundImage`])}function wt(i){return i.metadata[`${f.EXTENSIONID}/isVisionFog`]||i.metadata[`${f.ARMINDOID}/isVisionFog`]}function ra(i){return i.metadata[`${f.EXTENSIONID}/isIndicatorRing`]||i.metadata[`${f.ARMINDOID}/isIndicatorRing`]}function mi(i){return i.metadata[`${f.EXTENSIONID}/isVisionLine`]||i.metadata[`${f.ARMINDOID}/isVisionLine`]}function oa(i){return i.metadata[`${f.EXTENSIONID}/isVisionLine`]&&!i.metadata[`${f.EXTENSIONID}/disabled`]||i.metadata[`${f.ARMINDOID}/isVisionLine`]&&!i.metadata[`${f.ARMINDOID}/disabled`]}function Wi(i){return(i.layer==="CHARACTER"||i.layer==="MOUNT"||i.layer==="ATTACHMENT"||i.layer==="PROP")&&(i.metadata[`${f.EXTENSIONID}/hasVision`]||i.metadata[`${f.ARMINDOID}/hasVision`])}function yi(i){return(i.layer==="CHARACTER"||i.layer==="MOUNT"||i.layer==="ATTACHMENT"||i.layer==="PROP")&&(i.metadata[`${f.EXTENSIONID}/hasVision`]||i.metadata[`${f.ARMINDOID}/hasVision`])&&!i.metadata[`${f.EXTENSIONID}/visionBlind`]}function aa(i){return(i.layer==="CHARACTER"||i.layer==="MOUNT"||i.layer==="ATTACHMENT"||i.layer==="PROP")&&i.createdUserId==b.playerId&&(i.metadata[`${f.EXTENSIONID}/hasVision`]||i.metadata[`${f.ARMINDOID}/hasVision`])&&!i.metadata[`${f.EXTENSIONID}/visionBlind`]}function zi(i){return i.layer=="DRAWING"&&(i.metadata[`${f.EXTENSIONID}/isBackgroundImage`]||i.metadata[`${f.ARMINDOID}/isBackgroundImage`])}function Gt(i){return i.metadata[`${f.EXTENSIONID}/isTrailingFog`]}function Pn(i){return i.metadata[`${f.EXTENSIONID}/isTrailingFog`]||i.metadata[`${f.EXTENSIONID}/isVisionFog`]||i.metadata[`${f.ARMINDOID}/isVisionFog`]||i.metadata[`${f.EXTENSIONID}/isIndicatorRing`]}function sa(i){return i.metadata[`${f.EXTENSIONID}/isBrushSquare`]}function It(i){return i.metadata[`${f.EXTENSIONID}/visionTorch`]}function vi(i){return(i.layer==="CHARACTER"||i.layer==="MOUNT"||i.layer==="ATTACHMENT"||i.layer==="PROP")&&!Wi(i)&&i.metadata[`${f.EXTENSIONID}/hasAutohide`]===!0}var tt=function(){/*!
* Copyright (c) 2021-2023 Momo Bassit.
* Licensed under the MIT License (MIT)
* https://github.com/mdbassit/Coloris
* Version: 0.21.1
* NPM: https://github.com/melloware/coloris-npm
*/return function(i,e,t,n){var r=e.createElement("canvas").getContext("2d"),o={r:0,g:0,b:0,h:0,s:0,v:0,a:1},l,d,p,I,k,A,D,F,w,P,_,B,M,X,V,Z,O={},E={el:"[data-coloris]",parent:"body",theme:"default",themeMode:"light",rtl:!1,wrap:!0,margin:2,format:"hex",formatToggle:!1,swatches:[],swatchesOnly:!1,alpha:!0,forceAlpha:!1,focusInput:!0,selectInput:!1,inline:!1,defaultColor:"#000000",clearButton:!1,clearLabel:"Clear",closeButton:!1,closeLabel:"Close",onChange:function(){return n},a11y:{open:"Open color picker",close:"Close color picker",clear:"Clear the selected color",marker:"Saturation: {s}. Brightness: {v}.",hueSlider:"Hue slider",alphaSlider:"Opacity slider",input:"Color value field",format:"Color format",swatch:"Color swatch",instruction:"Saturation and brightness selector. Use up, down, left and right arrow keys to select."}},h={},y="",g={},N=!1;function $(S){if(typeof S=="object"){var H=function(){switch(j){case"el":ve(S.el),S.wrap!==!1&&be(S.el);break;case"parent":l=e.querySelector(S.parent),l&&(l.appendChild(d),E.parent=S.parent,l===e.body&&(l=n));break;case"themeMode":E.themeMode=S.themeMode,S.themeMode==="auto"&&i.matchMedia&&i.matchMedia("(prefers-color-scheme: dark)").matches&&(E.themeMode="dark");case"theme":S.theme&&(E.theme=S.theme),d.className="clr-picker clr-"+E.theme+" clr-"+E.themeMode,E.inline&&Oe();break;case"rtl":E.rtl=!!S.rtl,e.querySelectorAll(".clr-field").forEach(function(Ge){return Ge.classList.toggle("clr-rtl",E.rtl)});break;case"margin":S.margin*=1,E.margin=isNaN(S.margin)?E.margin:S.margin;break;case"wrap":S.el&&S.wrap&&be(S.el);break;case"formatToggle":E.formatToggle=!!S.formatToggle,ge("clr-format").style.display=E.formatToggle?"block":"none",E.formatToggle&&(E.format="auto");break;case"swatches":if(Array.isArray(S.swatches)){var de=[];S.swatches.forEach(function(Ge,Ne){de.push('<button type="button" id="clr-swatch-'+Ne+'" aria-labelledby="clr-swatch-label clr-swatch-'+Ne+'" style="color: '+Ge+';">'+Ge+"</button>")}),ge("clr-swatches").innerHTML=de.length?"<div>"+de.join("")+"</div>":"",E.swatches=S.swatches.slice()}break;case"swatchesOnly":E.swatchesOnly=!!S.swatchesOnly,d.setAttribute("data-minimal",E.swatchesOnly);break;case"alpha":E.alpha=!!S.alpha,d.setAttribute("data-alpha",E.alpha);break;case"inline":if(E.inline=!!S.inline,d.setAttribute("data-inline",E.inline),E.inline){var me=S.defaultColor||E.defaultColor;X=Ie(me),Oe(),oe(me)}break;case"clearButton":typeof S.clearButton=="object"&&(S.clearButton.label&&(E.clearLabel=S.clearButton.label,D.innerHTML=E.clearLabel),S.clearButton=S.clearButton.show),E.clearButton=!!S.clearButton,D.style.display=E.clearButton?"block":"none";break;case"clearLabel":E.clearLabel=S.clearLabel,D.innerHTML=E.clearLabel;break;case"closeButton":E.closeButton=!!S.closeButton,E.closeButton?d.insertBefore(F,k):k.appendChild(F);break;case"closeLabel":E.closeLabel=S.closeLabel,F.innerHTML=E.closeLabel;break;case"a11y":var he=S.a11y,Re=!1;if(typeof he=="object")for(var Se in he)he[Se]&&E.a11y[Se]&&(E.a11y[Se]=he[Se],Re=!0);if(Re){var je=ge("clr-open-label"),_e=ge("clr-swatch-label");je.innerHTML=E.a11y.open,_e.innerHTML=E.a11y.swatch,F.setAttribute("aria-label",E.a11y.close),D.setAttribute("aria-label",E.a11y.clear),w.setAttribute("aria-label",E.a11y.hueSlider),_.setAttribute("aria-label",E.a11y.alphaSlider),A.setAttribute("aria-label",E.a11y.input),p.setAttribute("aria-label",E.a11y.instruction)}break;default:E[j]=S[j]}};for(var j in S)H()}}function W(S,H){typeof S=="string"&&typeof H=="object"&&(h[S]=H,N=!0)}function ae(S){delete h[S],Object.keys(h).length===0&&(N=!1,S===y&&ee())}function se(S){if(N){var H=["el","wrap","rtl","inline","defaultColor","a11y"],j=function(){var he=h[ne];if(S.matches(ne)){y=ne,g={},H.forEach(function(Se){return delete he[Se]});for(var Re in he)g[Re]=Array.isArray(E[Re])?E[Re].slice():E[Re];return $(he),"break"}};for(var ne in h){var de=j();if(de==="break")break}}}function ee(){Object.keys(g).length>0&&($(g),y="",g={})}function ve(S){q(e,"click",S,function(H){E.inline||(se(H.target),M=H.target,V=M.value,X=Ie(V),d.classList.add("clr-open"),Oe(),oe(V),(E.focusInput||E.selectInput)&&(A.focus({preventScroll:!0}),A.setSelectionRange(M.selectionStart,M.selectionEnd)),E.selectInput&&A.select(),(Z||E.swatchesOnly)&&$e().shift().focus(),M.dispatchEvent(new Event("open",{bubbles:!0})))}),q(e,"input",S,function(H){var j=H.target.parentNode;j.classList.contains("clr-field")&&(j.style.color=H.target.value)})}function Oe(){if(!(!d||!M&&!E.inline)){var S=l,H=i.scrollY,j=d.offsetWidth,ne=d.offsetHeight,de={left:!1,top:!1},me,he,Re,Se={x:0,y:0};if(S&&(me=i.getComputedStyle(S),he=parseFloat(me.marginTop),Re=parseFloat(me.borderTopWidth),Se=S.getBoundingClientRect(),Se.y+=Re+H),!E.inline){var je=M.getBoundingClientRect(),_e=je.x,Ge=H+je.y+je.height+E.margin;S?(_e-=Se.x,Ge-=Se.y,_e+j>S.clientWidth&&(_e+=je.width-j,de.left=!0),Ge+ne>S.clientHeight-he&&ne+E.margin<=je.top-(Se.y-H)&&(Ge-=je.height+ne+E.margin*2,de.top=!0),Ge+=S.scrollTop):(_e+j>e.documentElement.clientWidth&&(_e+=je.width-j,de.left=!0),Ge+ne-H>e.documentElement.clientHeight&&ne+E.margin<=je.top&&(Ge=H+je.y-ne-E.margin,de.top=!0)),d.classList.toggle("clr-left",de.left),d.classList.toggle("clr-top",de.top),d.style.left=_e+"px",d.style.top=Ge+"px",Se.x+=d.offsetLeft,Se.y+=d.offsetTop}O={width:p.offsetWidth,height:p.offsetHeight,x:p.offsetLeft+Se.x,y:p.offsetTop+Se.y}}}function be(S){e.querySelectorAll(S).forEach(function(H){var j=H.parentNode;if(!j.classList.contains("clr-field")){var ne=e.createElement("div"),de="clr-field";(E.rtl||H.classList.contains("clr-rtl"))&&(de+=" clr-rtl"),ne.innerHTML='<button type="button" aria-labelledby="clr-open-label"></button>',j.insertBefore(ne,H),ne.setAttribute("class",de),ne.style.color=H.value,ne.appendChild(H)}})}function Q(S){if(M&&!E.inline){var H=M;S&&(M=n,V!==H.value&&(H.value=V,H.dispatchEvent(new Event("input",{bubbles:!0})))),setTimeout(function(){V!==H.value&&H.dispatchEvent(new Event("change",{bubbles:!0}))}),d.classList.remove("clr-open"),N&&ee(),H.dispatchEvent(new Event("close",{bubbles:!0})),E.focusInput&&H.focus({preventScroll:!0}),M=n}}function oe(S){var H=ke(S),j=pe(H);Ee(j.s,j.v),v(H,j),w.value=j.h,d.style.color="hsl("+j.h+", 100%, 50%)",P.style.left=j.h/360*100+"%",I.style.left=O.width*j.s/100+"px",I.style.top=O.height-O.height*j.v/100+"px",_.value=j.a*100,B.style.left=j.a*100+"%"}function Ie(S){var H=S.substring(0,3).toLowerCase();return H==="rgb"||H==="hsl"?H:"hex"}function le(S){S=S!==n?S:A.value,M&&(M.value=S,M.dispatchEvent(new Event("input",{bubbles:!0}))),E.onChange&&E.onChange.call(i,S,M),e.dispatchEvent(new CustomEvent("coloris:pick",{detail:{color:S,currentEl:M}}))}function ue(S,H){var j={h:w.value*1,s:S/O.width*100,v:100-H/O.height*100,a:_.value/100},ne=L(j);Ee(j.s,j.v),v(ne,j),le()}function Ee(S,H){var j=E.a11y.marker;S=S.toFixed(1)*1,H=H.toFixed(1)*1,j=j.replace("{s}",S),j=j.replace("{v}",H),I.setAttribute("aria-label",j)}function Te(S){return{pageX:S.changedTouches?S.changedTouches[0].pageX:S.pageX,pageY:S.changedTouches?S.changedTouches[0].pageY:S.pageY}}function ye(S){var H=Te(S),j=H.pageX-O.x,ne=H.pageY-O.y;l&&(ne+=l.scrollTop),c(j,ne),S.preventDefault(),S.stopPropagation()}function z(S,H){var j=I.style.left.replace("px","")*1+S,ne=I.style.top.replace("px","")*1+H;c(j,ne)}function c(S,H){S=S<0?0:S>O.width?O.width:S,H=H<0?0:H>O.height?O.height:H,I.style.left=S+"px",I.style.top=H+"px",ue(S,H),I.focus()}function v(S,H){S===void 0&&(S={}),H===void 0&&(H={});var j=E.format;for(var ne in S)o[ne]=S[ne];for(var de in H)o[de]=H[de];var me=we(o),he=me.substring(0,7);switch(I.style.color=he,B.parentNode.style.color=he,B.style.color=me,k.style.color=me,p.style.display="none",p.offsetHeight,p.style.display="",B.nextElementSibling.style.display="none",B.nextElementSibling.offsetHeight,B.nextElementSibling.style.display="",j==="mixed"?j=o.a===1?"hex":"rgb":j==="auto"&&(j=X),j){case"hex":A.value=me;break;case"rgb":A.value=Ve(o);break;case"hsl":A.value=Be(J(o));break}e.querySelector('.clr-format [value="'+j+'"]').checked=!0}function T(){var S=w.value*1,H=I.style.left.replace("px","")*1,j=I.style.top.replace("px","")*1;d.style.color="hsl("+S+", 100%, 50%)",P.style.left=S/360*100+"%",ue(H,j)}function G(){var S=_.value/100;B.style.left=S*100+"%",v({a:S}),le()}function L(S){var H=S.s/100,j=S.v/100,ne=H*j,de=S.h/60,me=ne*(1-t.abs(de%2-1)),he=j-ne;ne=ne+he,me=me+he;var Re=t.floor(de)%6,Se=[ne,me,he,he,me,ne][Re],je=[me,ne,ne,me,he,he][Re],_e=[he,he,me,ne,ne,me][Re];return{r:t.round(Se*255),g:t.round(je*255),b:t.round(_e*255),a:S.a}}function J(S){var H=S.v/100,j=H*(1-S.s/100/2),ne;return j>0&&j<1&&(ne=t.round((H-j)/t.min(j,1-j)*100)),{h:S.h,s:ne||0,l:t.round(j*100),a:S.a}}function pe(S){var H=S.r/255,j=S.g/255,ne=S.b/255,de=t.max(H,j,ne),me=t.min(H,j,ne),he=de-me,Re=de,Se=0,je=0;return he&&(de===H&&(Se=(j-ne)/he),de===j&&(Se=2+(ne-H)/he),de===ne&&(Se=4+(H-j)/he),de&&(je=he/de)),Se=t.floor(Se*60),{h:Se<0?Se+360:Se,s:t.round(je*100),v:t.round(Re*100),a:S.a}}function ke(S){var H=/^((rgba)|rgb)[\D]+([\d.]+)[\D]+([\d.]+)[\D]+([\d.]+)[\D]*?([\d.]+|$)/i,j,ne;return r.fillStyle="#000",r.fillStyle=S,j=H.exec(r.fillStyle),j?(ne={r:j[3]*1,g:j[4]*1,b:j[5]*1,a:j[6]*1},ne.a=+ne.a.toFixed(2)):(j=r.fillStyle.replace("#","").match(/.{2}/g).map(function(de){return parseInt(de,16)}),ne={r:j[0],g:j[1],b:j[2],a:1}),ne}function we(S){var H=S.r.toString(16),j=S.g.toString(16),ne=S.b.toString(16),de="";if(S.r<16&&(H="0"+H),S.g<16&&(j="0"+j),S.b<16&&(ne="0"+ne),E.alpha&&(S.a<1||E.forceAlpha)){var me=S.a*255|0;de=me.toString(16),me<16&&(de="0"+de)}return"#"+H+j+ne+de}function Ve(S){return!E.alpha||S.a===1&&!E.forceAlpha?"rgb("+S.r+", "+S.g+", "+S.b+")":"rgba("+S.r+", "+S.g+", "+S.b+", "+S.a+")"}function Be(S){return!E.alpha||S.a===1&&!E.forceAlpha?"hsl("+S.h+", "+S.s+"%, "+S.l+"%)":"hsla("+S.h+", "+S.s+"%, "+S.l+"%, "+S.a+")"}function Xe(){e.getElementById("clr-picker")||(l=n,d=e.createElement("div"),d.setAttribute("id","clr-picker"),d.className="clr-picker",d.innerHTML='<input id="clr-color-value" name="clr-color-value" class="clr-color" type="text" value="" spellcheck="false" aria-label="'+E.a11y.input+'">'+('<div id="clr-color-area" class="clr-gradient" role="application" aria-label="'+E.a11y.instruction+'">')+'<div id="clr-color-marker" class="clr-marker" tabindex="0"></div></div><div class="clr-hue">'+('<input id="clr-hue-slider" name="clr-hue-slider" type="range" min="0" max="360" step="1" aria-label="'+E.a11y.hueSlider+'">')+'<div id="clr-hue-marker"></div></div><div class="clr-alpha">'+('<input id="clr-alpha-slider" name="clr-alpha-slider" type="range" min="0" max="100" step="1" aria-label="'+E.a11y.alphaSlider+'">')+'<div id="clr-alpha-marker"></div><span></span></div><div id="clr-format" class="clr-format"><fieldset class="clr-segmented">'+("<legend>"+E.a11y.format+"</legend>")+'<input id="clr-f1" type="radio" name="clr-format" value="hex"><label for="clr-f1">Hex</label><input id="clr-f2" type="radio" name="clr-format" value="rgb"><label for="clr-f2">RGB</label><input id="clr-f3" type="radio" name="clr-format" value="hsl"><label for="clr-f3">HSL</label><span></span></fieldset></div><div id="clr-swatches" class="clr-swatches"></div>'+('<button type="button" id="clr-clear" class="clr-clear" aria-label="'+E.a11y.clear+'">'+E.clearLabel+"</button>")+'<div id="clr-color-preview" class="clr-preview">'+('<button type="button" id="clr-close" class="clr-close" aria-label="'+E.a11y.close+'">'+E.closeLabel+"</button>")+"</div>"+('<span id="clr-open-label" hidden>'+E.a11y.open+"</span>")+('<span id="clr-swatch-label" hidden>'+E.a11y.swatch+"</span>"),e.body.appendChild(d),p=ge("clr-color-area"),I=ge("clr-color-marker"),D=ge("clr-clear"),F=ge("clr-close"),k=ge("clr-color-preview"),A=ge("clr-color-value"),w=ge("clr-hue-slider"),P=ge("clr-hue-marker"),_=ge("clr-alpha-slider"),B=ge("clr-alpha-marker"),ve(E.el),be(E.el),q(d,"mousedown",function(S){d.classList.remove("clr-keyboard-nav"),S.stopPropagation()}),q(p,"mousedown",function(S){q(e,"mousemove",ye)}),q(p,"touchstart",function(S){e.addEventListener("touchmove",ye,{passive:!1})}),q(I,"mousedown",function(S){q(e,"mousemove",ye)}),q(I,"touchstart",function(S){e.addEventListener("touchmove",ye,{passive:!1})}),q(A,"change",function(S){var H=A.value;if(M||E.inline){var j=H===""?H:oe(H);le(j)}}),q(D,"click",function(S){le(""),Q()}),q(F,"click",function(S){le(),Q()}),q(ge("clr-format"),"click",".clr-format input",function(S){X=S.target.value,v(),le()}),q(d,"click",".clr-swatches button",function(S){oe(S.target.textContent),le(),E.swatchesOnly&&Q()}),q(e,"mouseup",function(S){e.removeEventListener("mousemove",ye)}),q(e,"touchend",function(S){e.removeEventListener("touchmove",ye)}),q(e,"mousedown",function(S){Z=!1,d.classList.remove("clr-keyboard-nav"),Q()}),q(e,"keydown",function(S){var H=S.key,j=S.target,ne=S.shiftKey,de=["Tab","ArrowUp","ArrowDown","ArrowLeft","ArrowRight"];if(H==="Escape"?Q(!0):de.includes(H)&&(Z=!0,d.classList.add("clr-keyboard-nav")),H==="Tab"&&j.matches(".clr-picker *")){var me=$e(),he=me.shift(),Re=me.pop();ne&&j===he?(Re.focus(),S.preventDefault()):!ne&&j===Re&&(he.focus(),S.preventDefault())}}),q(e,"click",".clr-field button",function(S){N&&ee(),S.target.nextElementSibling.dispatchEvent(new Event("click",{bubbles:!0}))}),q(I,"keydown",function(S){var H={ArrowUp:[0,-1],ArrowDown:[0,1],ArrowLeft:[-1,0],ArrowRight:[1,0]};Object.keys(H).includes(S.key)&&(z.apply(void 0,H[S.key]),S.preventDefault())}),q(p,"click",ye),q(w,"input",T),q(_,"input",G))}function $e(){var S=Array.from(d.querySelectorAll("input, button")),H=S.filter(function(j){return!!j.offsetWidth});return H}function ge(S){return e.getElementById(S)}function q(S,H,j,ne){var de=Element.prototype.matches||Element.prototype.msMatchesSelector;typeof j=="string"?S.addEventListener(H,function(me){de.call(me.target,j)&&ne.call(me.target,me)}):(ne=j,S.addEventListener(H,ne))}function fe(S,H){H=H!==n?H:[],e.readyState!=="loading"?S.apply(void 0,H):e.addEventListener("DOMContentLoaded",function(){S.apply(void 0,H)})}NodeList!==n&&NodeList.prototype&&!NodeList.prototype.forEach&&(NodeList.prototype.forEach=Array.prototype.forEach);function He(S,H){M=H,V=M.value,se(H),X=Ie(S),Oe(),oe(S),le(),V!==S&&M.dispatchEvent(new Event("change",{bubbles:!0}))}var Ue=function(){var S={init:Xe,set:$,wrap:be,close:Q,setInstance:W,setColor:He,removeInstance:ae,updatePosition:Oe};function H(de){fe(function(){de&&(typeof de=="string"?ve(de):$(de))})}var j=function(me){H[me]=function(){for(var he=arguments.length,Re=new Array(he),Se=0;Se<he;Se++)Re[Se]=arguments[Se];fe(S[me],Re)}};for(var ne in S)j(ne);return fe(function(){i.addEventListener("resize",function(de){H.updatePosition()}),i.addEventListener("scroll",function(de){H.updatePosition()})}),H}();return Ue.coloris=Ue,Ue}(window,document,Math)}();tt.coloris;tt.init;tt.set;tt.wrap;tt.close;tt.setInstance;tt.removeInstance;tt.updatePosition;function Ii(){re.processedIndicator.onclick=async()=>{await C.popover.open({id:f.PROCESSEDID,url:"/pages/processed.html",height:300,width:300,disableClickAway:!1})},re.visionCheckbox.onclick=async t=>{if(!b.sceneReady){t.preventDefault();return}const n=t.target;await C.scene.setMetadata({[`${f.EXTENSIONID}/visionEnabled`]:n.checked}),await C.scene.fog.setFilled(n.checked)},re.snapCheckbox.checked=!0,re.snapCheckbox.onclick=async t=>{if(!b.sceneReady){t.preventDefault();return}const n=t.target;b.snap=n.checked},re.settingsButton.onclick=async t=>{!t||!t.target||(re.settingsUIDiv.style.display==="block"?(re.settingsUIDiv.style.display="none",re.mainUIDiv.style.display="block"):(re.settingsUIDiv.style.display="block",re.mainUIDiv.style.display="none"))},re.persistenceCheckbox.onclick=async t=>{if(!t||!t.target)return;const n=t.target;await C.scene.setMetadata({[`${f.EXTENSIONID}/persistenceEnabled`]:n.checked})},re.autodetectCheckbox.onclick=async t=>{if(!t||!t.target)return;const n=t.target;await C.scene.setMetadata({[`${f.EXTENSIONID}/autodetectEnabled`]:n.checked}),re.boundryOptions.style.display=n.checked?"none":"",await _n()},re.fowCheckbox.onclick=async t=>{if(!t||!t.target)return;const n=t.target;await Jt(n.checked),await C.scene.setMetadata({[`${f.EXTENSIONID}/fowEnabled`]:n.checked})},re.doorCheckbox.onclick=async t=>{if(!t||!t.target)return;const n=t.target;await C.scene.setMetadata({[`${f.EXTENSIONID}/playerDoors`]:n.checked})},re.resetButton.onclick=async t=>{!t||!t.target||C.broadcast.sendMessage(f.RESETID,!0,{destination:"ALL"})},re.debugButton.onclick=async t=>{!t||!t.target||(re.debugDiv.style.display=="none"?(re.debugDiv.style.display="grid",re.debugButton.value="Disable Debugging"):(re.debugDiv.style.display="none",re.debugButton.value="Enable Debugging"),await C.scene.setMetadata({[`${f.EXTENSIONID}/debug`]:re.debugDiv.style.display==="grid"}))},re.unlockFogButton.onclick=async t=>{!t||!t.target||await C.scene.items.updateItems(mi,n=>{for(let r of n)r.locked=!1})},re.lockFogButton.onclick=async t=>{!t||!t.target||await C.scene.items.updateItems(mi,n=>{for(let r of n)r.locked=!0})},re.backgroundButton.onclick=async t=>{!t||!t.target||(t.target,await C.scene.items.updateItems(n=>n.layer=="FOG"&&n.metadata[`${f.EXTENSIONID}/isBackgroundMap`]===!0,n=>{for(let r=0;r<n.length;r++)n[r].layer="MAP",n[r].disableHit=!1,n[r].locked=!1,n[r].visible=!0,delete n[r].metadata[`${f.EXTENSIONID}/isBackgroundMap`]}))};let i;re.fowColor.onclick=()=>{tt({el:`#${re.fowColor.id}`,alpha:!0,forceAlpha:!0})},re.fowColor.oninput=async t=>{if(!t||!t.target)return;const n=t.target;clearTimeout(i),i=setTimeout(async()=>{if(/#[a-f0-9]{8}/.test(n.value)){await C.scene.setMetadata({[`${f.EXTENSIONID}/fowColor`]:n.value});const o=await C.scene.local.getItems(Gt);await C.scene.local.deleteItems(o.map(l=>l.id))}},500)},re.convertButton.onclick=async t=>{if(!(!t||!t.target)&&window.confirm(`WARNING: THIS CANNOT BE UNDONE.

This operation will remove all metadata from the original dynamic fog extension, and will break fog lines and other things if you do not continue using Smoke!.

WARNING: THIS CANNOT BE UNDONE.

Are you REALLY sure?`)){for(const n in b.sceneMetadata)n.substring(0,n.indexOf("/"))==f.ARMINDOID&&await C.scene.setMetadata({[`${n}`]:void 0});await C.scene.items.updateItems(b.sceneItems,n=>{for(const r of n)r.metadata[`${f.ARMINDOID}/isVisionLine`]!==void 0&&(r.metadata[`${f.EXTENSIONID}/isVisionLine`]=r.metadata[`${f.ARMINDOID}/isVisionLine`],delete r.metadata[`${f.ARMINDOID}/isVisionLine`]),r.metadata[`${f.ARMINDOID}/disabled`]!==void 0&&(r.metadata[`${f.EXTENSIONID}/disabled`]=r.metadata[`${f.ARMINDOID}/disabled`],delete r.metadata[`${f.ARMINDOID}/disabled`])})}};var e;re.importFile.onchange=t=>{if(re.importButton.disabled=!0,!t||!t.target)return;const n=t.target;if(!n.files)return;const r=n.files[0];if(r.type!=="text/javascript"&&r.type,r){var o=new FileReader;o.onload=function(l){if(!l||!l.target){re.importErrors.innerText="Invalid import event";return}const d=l.target;if(!d.result){re.importErrors.innerText="Unable to read imported file";return}const p=d.result;e=JSON.parse(p),e&&(e.walls&&e.walls.length||e.line_of_sight&&e.line_of_sight.length)?re.importButton.disabled=!1:re.importErrors.innerText="Imported file has no walls"},o.readAsText(r)}else re.importErrors.innerText="Failed to load file"},re.importButton.onclick=async t=>{!t||!t.target||(t.target,Or(re.importFormat.value,e,re.dpiAutodetect.checked?0:Number.parseInt(re.importDpi.value),re.mapAlign.value,re.importErrors))},re.toolColor.onclick=async t=>{tt({el:`#${re.toolColor.id}`,alpha:!1,forceAlpha:!1})},re.toolColor.oninput=async t=>{if(!t||!t.target)return;const n=t.target;clearTimeout(i),i=setTimeout(async()=>{/#[a-f0-9]{6}/.test(n.value)&&await C.scene.setMetadata({[`${f.EXTENSIONID}/toolColor`]:n.value})},400)},re.toolStyle.onchange=async t=>{const n=t.currentTarget;await C.scene.setMetadata({[`${f.EXTENSIONID}/toolStyle`]:n.value=="solid"?[]:[25,25]})},re.toolWidth.onchange=t=>{const n=t.currentTarget;clearTimeout(i),i=setTimeout(async()=>{await C.scene.setMetadata({[`${f.EXTENSIONID}/toolWidth`]:n.value})},400)},re.whatsNewButton.onclick=async function(){re.whatsNewIcon?.classList.remove("new-shine"),await C.modal.open({id:f.EXTENSIONWHATSNEW,url:"/pages/whatsnew.html",height:500,width:400})},tt({themeMode:"dark",alpha:!0,forceAlpha:!0,el:"#fow_color"}),tt({themeMode:"dark",alpha:!1,forceAlpha:!1,el:"#tool_color"})}const qi="#000000",la=8,ca=[];let ht=[];async function Yi(){ht=[];const i=await C.scene.local.getItems(sa);await C.scene.local.deleteItems(i.map(e=>e.id)),await C.popover.close(f.BRUSHTOOLID)}async function ua(i,e){await Ki(e.pointerPosition)}async function da(){await C.popover.open({id:f.BRUSHTOOLID,url:"/pages/brush.html",height:70,width:350,disableClickAway:!0})}async function fa(){await C.popover.close(f.BRUSHTOOLID)}async function pa(i,e){await Ki(e.pointerPosition)}async function ha(i,e){await ma(),await Yi()}async function ga(i,e){await Yi()}async function Ki(i){const e={x:Math.floor(i.x/b.gridDpi),y:Math.floor(i.y/b.gridDpi)};if(!ht.some(n=>n.x===e.x&&n.y===e.y)){const n={x:e.x*b.gridDpi,y:e.y*b.gridDpi},r={x:(e.x+1)*b.gridDpi,y:e.y*b.gridDpi},o={x:e.x*b.gridDpi,y:(e.y+1)*b.gridDpi},l={x:(e.x+1)*b.gridDpi,y:(e.y+1)*b.gridDpi},d=[[kt.MOVE,n.x,n.y],[kt.LINE,r.x,r.y],[kt.LINE,l.x,l.y],[kt.LINE,o.x,o.y],[kt.CLOSE]],p=st().commands(d).strokeOpacity(0).fillOpacity(.5).fillColor(b.sceneMetadata[`${f.EXTENSIONID}/toolColor`]??qi).build();p.metadata[`${f.EXTENSIONID}/isBrushSquare`]=!0,ht.push(e),await C.scene.local.addItems([p])}}async function ma(){const i=[];for(const l of ht){const{x:d,y:p}=l,I={x:d*b.gridDpi,y:p*b.gridDpi},k={x:(d+1)*b.gridDpi,y:p*b.gridDpi},A={x:d*b.gridDpi,y:(p+1)*b.gridDpi},D={x:(d+1)*b.gridDpi,y:(p+1)*b.gridDpi};if(!ht.some(F=>F.x===d&&F.y===p-1)){const F=I,w=k;i.push({Start:F,End:w})}if(!ht.some(F=>F.x===d&&F.y===p+1)){const F=A,w=D;i.push({Start:F,End:w})}if(!ht.some(F=>F.x===d-1&&F.y===p)){const F=I,w=A;i.push({Start:F,End:w})}if(!ht.some(F=>F.x===d+1&&F.y===p)){const F=k,w=D;i.push({Start:F,End:w})}}const e=Ji(i),t=Zi(e),n=Ia(t),r=25,o=n.length;for(let l=0;l<o;l+=r){const d=n.slice(l,l+r);await C.scene.items.addItems(d)}}function Zi(i){let e=[],t=[],n=!1;for(const r of i){const o=r.Start.x===r.End.x?i.filter(p=>p.Start.x===p.End.x):i.filter(p=>p.Start.y===p.End.y),l=r.Start.x===r.End.x?o.filter(p=>p.Start.x===r.Start.x&&p.End.x===r.End.x):o.filter(p=>p.Start.y===r.Start.y&&p.End.y===r.End.y),d=r.Start.x!==r.End.x?l.find(p=>p.Start.x>r.Start.x&&p.Start.x<r.End.x):l.find(p=>p.Start.y>r.Start.y&&p.Start.y<r.End.y);if(d){const p=va(r,d);t.push(p),e.push(r),e.push(d),t=t.filter(I=>I!==r&&I!==d),n=!0}else e.includes(r)||t.push(r)}return n?Zi(t):t}function Ji(i){let e=[],t=[],n=!1;for(const r of i){const l=(r.Start.x===r.End.x?i.filter(d=>d.Start.x===d.End.x):i.filter(d=>d.Start.y===d.End.y)).find(d=>d.Start.x===r.End.x&&d.Start.y===r.End.y);if(l){const d=ya(r,l);t.push(d),e.push(r),e.push(l),t=t.filter(p=>p!==r&&p!==l),n=!0}else e.includes(r)||t.push(r)}return n?Ji(t):t}function ya(i,e){return{Start:i.Start,End:e.End}}function va(i,e){const t=Math.min(i.Start.x,e.Start.x),n=Math.min(i.Start.y,e.Start.y),r=Math.max(i.End.x,e.End.x),o=Math.max(i.End.y,e.End.y);return{Start:{x:t,y:n},End:{x:r,y:o}}}function Ia(i){const e=[];for(const t of i){const n=Qt().tension(0).points([t.Start,t.End]).strokeColor(b.sceneMetadata[`${f.EXTENSIONID}/toolColor`]??qi).strokeDash(b.sceneMetadata[`${f.EXTENSIONID}/toolStyle`]??ca).strokeWidth(b.sceneMetadata[`${f.EXTENSIONID}/toolWidth`]??la).fillOpacity(0).fillColor("#000000").layer("DRAWING").name("Vision Line (Brushed)").closed(!1).locked(!0).build();n.visible=!1,n.metadata[`${f.EXTENSIONID}/isVisionLine`]=!0,e.push(n)}return e}const Et={onActivate:da,onDeactivate:fa,onDragStart:ua,onDragMove:pa,onDragEnd:ha,onDragCancel:ga};async function Ei(){await C.tool.create({id:`${f.EXTENSIONID}/vision-tool`,icons:[{icon:"/icon.svg",label:"Setup Vision"}],async onClick(){await C.tool.activateTool(`${f.EXTENSIONID}/vision-tool`)}}),await C.tool.createMode({id:`${f.EXTENSIONID}/add-vision-polygon-mode`,icons:[{icon:"/object.svg",label:"Add Obstruction Object",filter:{activeTools:[`${f.EXTENSIONID}/vision-tool`]}}],onToolDown:On.onToolClick,onToolMove:On.onToolMove,onKeyDown:On.onKeyDown,preventDrag:{dragging:!1}}),await C.tool.createMode({id:`${f.EXTENSIONID}/add-vision-line-mode`,icons:[{icon:"/line.svg",label:"Add Obstruction Line",filter:{activeTools:[`${f.EXTENSIONID}/vision-tool`]}}],onToolDown:Nn.onToolClick,onToolMove:Nn.onToolMove,onKeyDown:Nn.onKeyDown,preventDrag:{dragging:!1}}),await C.tool.createMode({id:`${f.EXTENSIONID}/add-vision-brush-mode`,icons:[{icon:"/brush.svg",label:"Paint Obstructions by Grid",filter:{activeTools:[`${f.EXTENSIONID}/vision-tool`]}}],onToolDown:Et.onActivate,onToolUp:Et.onDeactivate,onToolDragStart:Et.onDragStart,onToolDragMove:Et.onDragMove,onToolDragEnd:Et.onDragEnd,onToolDragCancel:Et.onDragCancel})}class Ea{mainWindow=document.getElementById("app");mainUIDiv;playerListContainer;settingsUIDiv;visionCheckbox;snapCheckbox;table;message;mapHeight;mapWidth;mapSubmit;whatsNewButton;whatsNewIcon;processedIndicator;persistenceCheckbox;autodetectCheckbox;fowCheckbox;doorCheckbox;fowColor;resetButton;convertButton;settingsButton;boundryOptions;debugDiv;debugButton;backgroundButton;lockFogButton;unlockFogButton;toolWidth;toolColor;toolStyle;importButton;importFile;mapAlign;importErrors;dpiAutodetect;importDpi;importFormat;version;constructor(e){this.version=`SMOKEANDSPECTRE-${e}`}SetupGMElements(){this.mainWindow.innerHTML=`
        <div>
            <div>
                <div id="localStorageWarning"></div>
                <div class="title">
                <button class="circle-button" id="processedIndicator"></button>
                    Smoke!
                    <input type="checkbox" id="vision_checkbox" class="large" title="Enable Dynamic Fog">
                    <div class="tooltip" id="settings_button" title="Settings"><svg class="svgclickable" fill="#fff" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><path d="M.63 11.08zm.21.41v-.1zm.23.38L1 11.68zM1 11.68l-.11-.19zm-.21-.29c-.06-.1-.11-.21-.16-.31.05.1.1.21.16.31zm.32.54v-.06z"/><path d="m11.26 12.63 1.83 1.09a7.34 7.34 0 0 0 1-.94 7.48 7.48 0 0 0 1.56-2.86l-1.74-1A5.29 5.29 0 0 0 14 8a5.29 5.29 0 0 0-.08-.9l1.74-1a7.45 7.45 0 0 0-1.33-2.58 7.54 7.54 0 0 0-1.24-1.22l-1.83 1.04a6 6 0 0 0-1.11-.53v-2A8.55 8.55 0 0 0 7.94.53a8.39 8.39 0 0 0-2.26.3v2a7.23 7.23 0 0 0-1.12.54L2.78 2.28A7.46 7.46 0 0 0 .2 6.06l1.72 1a5.29 5.29 0 0 0-.08.9 5.29 5.29 0 0 0 .08.9l-1.73 1a8 8 0 0 0 .43 1.15c.05.1.1.21.16.31v.1l.11.19.12.19v.06a7.69 7.69 0 0 0 1.64 1.78l1.81-1.08a7.23 7.23 0 0 0 1.12.54v2a8.39 8.39 0 0 0 2.26.31 8.56 8.56 0 0 0 2.22-.3v-2a6 6 0 0 0 1.2-.48zm-2.39 1.52a7.57 7.57 0 0 1-.95.06 7.73 7.73 0 0 1-1-.06v-1.69a4.92 4.92 0 0 1-2.53-1.27l-1.54.92a6.22 6.22 0 0 1-1.08-1.61l1.56-.93a4.27 4.27 0 0 1 0-3.17l-1.56-.92a6.11 6.11 0 0 1 1.12-1.62l1.56.93A5 5 0 0 1 7 3.53V1.82a7.73 7.73 0 0 1 1-.06 7.57 7.57 0 0 1 .95.06v1.72a4.9 4.9 0 0 1 2.4 1.26l1.59-.94a6.31 6.31 0 0 1 1.11 1.62l-1.6.94a4.35 4.35 0 0 1 .3 1.58 4.44 4.44 0 0 1-.29 1.55l1.56.93a6.43 6.43 0 0 1-1.11 1.61l-1.58-.93a5 5 0 0 1-2.49 1.28z"/><path d="M7.92 5.49A2.59 2.59 0 0 0 5.25 8a2.59 2.59 0 0 0 2.67 2.51A2.6 2.6 0 0 0 10.6 8a2.6 2.6 0 0 0-2.68-2.51zM8 9.2A1.35 1.35 0 0 1 6.55 8 1.35 1.35 0 0 1 8 6.7 1.35 1.35 0 0 1 9.39 8 1.35 1.35 0 0 1 8 9.2z"/></svg></div>
                    <div class="tooltip" id="whatsnewbutton" title="Whats New"><svg id="whatsNewIcon" class="svgclickable" fill="#fff" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 3a7 7 0 100 14 7 7 0 000-14zm-9 7a9 9 0 1118 0 9 9 0 01-18 0zm8-4a1 1 0 011-1h.01a1 1 0 110 2H10a1 1 0 01-1-1zm.01 8a1 1 0 102 0V9a1 1 0 10-2 0v5z"/></svg></div>
                </div>
                <hr>
                ${f.SETTINGSPAGE}
                ${f.MAINPAGE}
                ${f.DEBUGPAGE}
            </div>
        </div>
        `,this.mainWindow.parentElement.style.placeItems="start",this.mainUIDiv=document.getElementById("main-ui"),this.settingsUIDiv=document.getElementById("settings-ui"),this.visionCheckbox=document.getElementById("vision_checkbox"),this.snapCheckbox=document.getElementById("snap_checkbox"),this.table=document.getElementById("token_list"),this.message=document.getElementById("no_tokens_message"),this.mapHeight=document.getElementById("mapHeight"),this.mapWidth=document.getElementById("mapWidth"),this.mapSubmit=document.getElementById("mapSubmit"),this.whatsNewButton=document.getElementById("whatsnewbutton"),this.whatsNewIcon=document.getElementById("whatsNewIcon"),this.processedIndicator=document.getElementById("processedIndicator"),this.persistenceCheckbox=document.getElementById("persistence_checkbox"),this.autodetectCheckbox=document.getElementById("autodetect_checkbox"),this.fowCheckbox=document.getElementById("fow_checkbox"),this.doorCheckbox=document.getElementById("door_checkbox"),this.fowColor=document.getElementById("fow_color"),this.resetButton=document.getElementById("persistence_reset"),this.convertButton=document.getElementById("convert_button"),this.settingsButton=document.getElementById("settings_button"),this.boundryOptions=document.getElementById("boundry_options"),this.debugDiv=document.getElementById("debug_div"),this.debugButton=document.getElementById("debug_button"),this.backgroundButton=document.getElementById("background_button"),this.lockFogButton=document.getElementById("lock_button"),this.unlockFogButton=document.getElementById("unlock_button"),this.toolWidth=document.getElementById("tool_width"),this.toolColor=document.getElementById("tool_color"),this.toolStyle=document.getElementById("tool_style"),this.importButton=document.getElementById("import_button"),this.importFile=document.getElementById("import_file"),this.mapAlign=document.getElementById("map_align"),this.importErrors=document.getElementById("import_errors"),this.dpiAutodetect=document.getElementById("dpi_autodetect"),this.importDpi=document.getElementById("import_dpi"),this.importFormat=document.getElementById("import_format");const e=document.getElementById("playerListing");e.appendChild(this.GetEmptyContextItem());for(const t of b.party){const n=document.createElement("li");n.id=t.id,n.textContent=t.name,n.style.color=t.color,e.appendChild(n)}tt.init()}async SetupPlayerElements(){this.mainWindow.innerHTML=`<div class="title">Configuration via GM.
            <div class="tooltip" id="helpButton" title="Need Help?"></div>
            </div>
            <hr><sub>You must have ownership of a token to see it.</sub></br></br>Tokens Owned By You:<div id="playerOwnedTokens"></div><div id="localStorageWarning"></div>`,await C.action.setHeight(300),await C.action.setWidth(350),this.playerListContainer=document.getElementById("playerOwnedTokens");const e=document.getElementById("helpButton"),t=document.createElement("input");t.classList.add("clickable"),t.src="/help.svg",t.height=15,t.width=15,t.type="image",t.title="Need Help?",t.onclick=async function(){await C.modal.open({id:f.EXTENSIONWHATSNEW,url:"/pages/whatsnew.html?gethelp=true",height:500,width:350})},e.appendChild(t)}GetEmptyContextItem(){const e=document.createElement("li");return e.id=b.playerId,e.textContent="Self",e}async ResetPersistence(){const e=await C.scene.local.getItems(Pn);await C.scene.local.deleteItems(e.map(n=>n.id));const t=b.sceneMetadata[`${f.EXTENSIONID}/sceneId`];localStorage.removeItem(`${f.EXTENSIONID}/fogCache/${b.playerId}/${t}`),await vt()}async UpdateUI(){const e=b.sceneItems.filter(p=>Wi(p));let t=!1;vr(b.sceneMetadata)||(this.visionCheckbox.checked=b.sceneMetadata[`${f.EXTENSIONID}/visionEnabled`]==!0,this.autodetectCheckbox.checked=b.sceneMetadata[`${f.EXTENSIONID}/autodetectEnabled`]==!0,this.persistenceCheckbox.checked=b.sceneMetadata[`${f.EXTENSIONID}/persistenceEnabled`]==!0,this.autodetectCheckbox.checked=b.sceneMetadata[`${f.EXTENSIONID}/autodetectEnabled`]==!0,this.fowCheckbox.checked=b.sceneMetadata[`${f.EXTENSIONID}/fowEnabled`]==!0,this.doorCheckbox.checked=b.sceneMetadata[`${f.EXTENSIONID}/playerDoors`]==!0,this.fowColor.value=b.sceneMetadata[`${f.EXTENSIONID}/fowColor`]?b.sceneMetadata[`${f.EXTENSIONID}/fowColor`]:"#00000088",t=b.sceneMetadata[`${f.EXTENSIONID}/debug`]==!0),this.debugDiv.style.display=t?"grid":"none",this.boundryOptions.style.display=this.autodetectCheckbox.checked?"none":"",this.message.style.display=e.length>0?"none":"block";const n=b.sceneItems.filter(p=>p.layer==="FOG"&&p.metadata[`${f.EXTENSIONID}/isBackgroundMap`]===!0),r=document.querySelectorAll(".fog-background-entry");for(const p of r){const I=p.id.slice(3);n.find(k=>k.id===I)===void 0&&p.remove()}for(const p of n)if(!document.querySelector(`#bg-${p.id}`)){const k=document.createElement("div");k.id=`bg-${p.id}`,k.className="fog-background-entry grid-3 grid-main",k.style.width="300",k.innerHTML=`<div class="token-name grid-2">${p.name}</div>
                    <div><label title="Unlock this fog background and turn it back into a map"><input type="button" value="Unlock"></label></div>`,document.querySelector("#fog_background_list").appendChild(k),k.querySelector("input").addEventListener("click",async D=>{if(!D||!D.target)return;const w=D.target.parentElement.parentElement.parentElement.id.slice(3);await C.scene.items.updateItems(P=>P.id===w&&P.layer=="FOG"&&P.metadata[`${f.EXTENSIONID}/isBackgroundMap`]===!0,P=>{for(let _=0;_<P.length;_++)P[_].layer="MAP",P[_].disableHit=!1,P[_].locked=!1,P[_].visible=!0,delete P[_].metadata[`${f.EXTENSIONID}/isBackgroundMap`]})})}const o=document.querySelector("#fog_backgrounds");n.length==0?o.style.display="none":o.style.display="block";const l=document.getElementsByClassName("token-table-entry"),d=[];for(const p of l){const I=p.id.slice(3);e.find(k=>k.id===I)===void 0&&d.push(p)}for(const p of d)p.remove();for(const p of e)Er(p)}UpdatePlayerProcessUI(){b.party.every(t=>t.metadata[`${f.EXTENSIONID}/processed`]===!0)?(this.processedIndicator.style.backgroundColor="green",this.processedIndicator.title="Everything looks good."):(this.processedIndicator.style.backgroundColor="red",this.processedIndicator.title="A player is having trouble processing/seeing.")}UpdatePlayerVisionList(){const e=[];for(const t of b.sceneItems)if(Wt(t)&&t.createdUserId===b.playerId){const n=t.metadata[`${f.EXTENSIONID}/hasVision`]!==void 0;e.push(`<li>${t.name}${n?"":": <b>Vision Disabled</b>"}</li>`)}e.length===0&&e.push("<li>None found.</li>"),this.playerListContainer.innerHTML=`<ul>${e.join("")}</ul>`}HighlightWhatsNew(){let e=localStorage.getItem(this.version);(e==="false"||!e)&&(this.whatsNewIcon?.classList.add("new-shine"),localStorage.setItem(this.version,"true"))}async SoftReset(){b.playerRole==="GM"?(this.SetupGMElements(),Ii(),this.UpdatePlayerProcessUI(),xn(this.mapAlign),await Promise.all([gi(),Ei(),hi(),Jt(!1),this.UpdateUI()])):this.SetupPlayerElements(),b.sceneReady&&(await Mn(),await vt())}async Start(){Ir(),b.playerRole==="GM"?(this.SetupGMElements(),Ii(),this.UpdatePlayerProcessUI(),xn(this.mapAlign),await Promise.all([gi(),Ei(),hi(),Jt(!1),this.UpdateUI()])):(await this.SetupPlayerElements(),this.UpdatePlayerVisionList()),await Mn(),await vt(),b.SetupHandlers(),this.HighlightWhatsNew()}}const re=new Ea("2.33");C.onReady(async()=>{const i=await C.scene.isReady();if(!document.getElementById("papp"))if(i===!1){const t=C.scene.onReadyChange(async n=>{n&&(t(),await wi())})}else await wi()});async function wi(){await b.InitializeCache(),await re.Start()}export{yi as i};
