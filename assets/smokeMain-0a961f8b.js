import{C as c,b as Vi,O as b,a as gt,c as Ro,d as Xo,e as Fo,f as ct,i as Bo,g as _t}from"./bsConstants-0c7edbdf.js";/* empty css              */var wn=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function jn(i){return i&&i.__esModule&&Object.prototype.hasOwnProperty.call(i,"default")?i.default:i}function Vo(i){if(i.__esModule)return i;var e=i.default;if(typeof e=="function"){var t=function n(){return this instanceof n?Reflect.construct(e,arguments,this.constructor):e.apply(this,arguments)};t.prototype=e.prototype}else t={};return Object.defineProperty(t,"__esModule",{value:!0}),Object.keys(i).forEach(function(n){var o=Object.getOwnPropertyDescriptor(i,n);Object.defineProperty(t,n,o.get?o:{enumerable:!0,get:function(){return i[n]}})}),t}function Ho(i){return i.type==="CURVE"}function Jt(i){return i.type==="IMAGE"}function gi(i,e){return Math.round(i/e)*e}function mi(i,e){return Math.floor(i/e)*e}function Mn(i){return i*(Math.PI/180)}function Uo(i){return i*(180/Math.PI)}function yi(i,e,t){return i*(1-t)+e*t}class ze{static magnitudeSquared(e){return e.x*e.x+e.y*e.y}static magnitude(e){const t=Math.sqrt(this.magnitudeSquared(e));return isNaN(t)?0:t}static normalize(e){const t=this.magnitude(e);return t===0?{x:0,y:0}:this.divide(e,t)}static dot(e,t){return e.x*t.x+e.y*t.y}static subtract(e,t){return typeof t=="number"?{x:e.x-t,y:e.y-t}:{x:e.x-t.x,y:e.y-t.y}}static add(e,t){return typeof t=="number"?{x:e.x+t,y:e.y+t}:{x:e.x+t.x,y:e.y+t.y}}static multiply(e,t){return typeof t=="number"?{x:e.x*t,y:e.y*t}:{x:e.x*t.x,y:e.y*t.y}}static divide(e,t){return typeof t=="number"?{x:e.x/t,y:e.y/t}:{x:e.x/t.x,y:e.y/t.y}}static rotate(e,t,n){const o=Math.cos(Mn(n)),r=Math.sin(Mn(n)),s=this.subtract(e,t);return{x:t.x+o*s.x-r*s.y,y:t.y+r*s.x+o*s.y}}static min(e,t){return typeof t=="number"?{x:Math.min(e.x,t),y:Math.min(e.y,t)}:{x:Math.min(e.x,t.x),y:Math.min(e.y,t.y)}}static componentMin(e){return e.x<e.y?e.x:e.y}static max(e,t){return typeof t=="number"?{x:Math.max(e.x,t),y:Math.max(e.y,t)}:{x:Math.max(e.x,t.x),y:Math.max(e.y,t.y)}}static componentMax(e){return e.x>e.y?e.x:e.y}static roundTo(e,t){return{x:gi(e.x,t.x),y:gi(e.y,t.y)}}static floorTo(e,t){return{x:mi(e.x,t.x),y:mi(e.y,t.y)}}static sign(e){return{x:Math.sign(e.x),y:Math.sign(e.y)}}static abs(e){return{x:Math.abs(e.x),y:Math.abs(e.y)}}static pow(e,t){return typeof t=="number"?{x:Math.pow(e.x,t),y:Math.pow(e.y,t)}:{x:Math.pow(e.x,t.x),y:Math.pow(e.y,t.y)}}static clamp(e,t,n){return{x:Math.min(Math.max(e.x,t),n),y:Math.min(Math.max(e.y,t),n)}}static boundingBox(e){let t=Number.MAX_SAFE_INTEGER,n=Number.MIN_SAFE_INTEGER,o=Number.MAX_SAFE_INTEGER,r=Number.MIN_SAFE_INTEGER;for(let y of e)t=y.x<t?y.x:t,n=y.x>n?y.x:n,o=y.y<o?y.y:o,r=y.y>r?y.y:r;let s=n-t,u=r-o,h={x:(t+n)/2,y:(o+r)/2};return{min:{x:t,y:o},max:{x:n,y:r},width:s,height:u,center:h}}static pointInPolygon(e,t){const n=this.boundingBox(t);if(e.x<n.min.x||e.x>n.max.x||e.y<n.min.y||e.y>n.max.y)return!1;let o=!1;for(let r=0,s=t.length-1;r<t.length;s=r++){const u=t[r].y>e.y,h=t[s].y>e.y;u!==h&&e.x<(t[s].x-t[r].x)*(e.y-t[r].y)/(t[s].y-t[r].y)+t[r].x&&(o=!o)}return o}static compare(e,t,n){return this.magnitudeSquared(this.subtract(e,t))<n*n}static distance(e,t){return this.magnitude(this.subtract(e,t))}static lerp(e,t,n){return{x:yi(e.x,t.x,n),y:yi(e.y,t.y,n)}}static centroid(e){let t={x:0,y:0};for(let n of e)t.x+=n.x,t.y+=n.y;return e.length>0&&(t={x:t.x/e.length,y:t.y/e.length}),t}}class We{static inverse(e){const[t,n,o,r,s,u,h,y,O]=e,x=t*(s*O-y*u)-n*(r*O-u*h)+o*(r*y-s*h);if(Math.abs(x)<1e-14)return e;const $=1/x,M=(s*O-y*u)*$,S=(o*y-n*O)*$,P=(n*u-o*s)*$,C=(u*h-r*O)*$,R=(t*O-o*h)*$,L=(r*o-t*u)*$,B=(r*y-h*s)*$,H=(h*n-t*y)*$,ie=(t*s-r*n)*$;return[M,S,P,C,R,L,B,H,ie]}static multiply(e,t){return[e[0]*t[0]+e[1]*t[3]+e[2]*t[6],e[0]*t[1]+e[1]*t[4]+e[2]*t[7],e[0]*t[2]+e[1]*t[5]+e[2]*t[8],e[3]*t[0]+e[4]*t[3]+e[5]*t[6],e[3]*t[1]+e[4]*t[4]+e[5]*t[7],e[3]*t[2]+e[4]*t[5]+e[5]*t[8],e[6]*t[0]+e[7]*t[3]+e[8]*t[6],e[6]*t[1]+e[7]*t[4]+e[8]*t[7],e[6]*t[2]+e[7]*t[5]+e[8]*t[8]]}static fromPosition(e){return[1,0,e.x,0,1,e.y,0,0,1]}static fromRotation(e){const t=Mn(e);return[Math.cos(t),-Math.sin(t),0,Math.sin(t),Math.cos(t),0,0,0,1]}static fromScale(e){return[e.x,0,0,0,e.y,0,0,0,1]}static fromItem(e){const t=We.fromPosition(e.position),n=We.fromScale(e.scale),o=We.fromRotation(e.rotation);return We.multiply(We.multiply(t,o),n)}static decompose(e){const[t,n,o,r,s,u]=e,h=t*s-r*n,y={position:{x:o,y:u},rotation:0,scale:{x:1,y:1}};if(t!=0||r!=0){var O=Math.sqrt(t*t+r*r);y.rotation=r>0?Math.acos(t/O):-Math.acos(t/O),y.scale={x:O,y:h/O}}else if(n!=0||s!=0){var x=Math.sqrt(n*n+s*s);y.rotation=Math.PI/2-(s>0?Math.acos(-n/x):-Math.acos(n/x)),y.scale={x:h/x,y:x}}return y.rotation=Uo(y.rotation),y}}function vi(i,e){let t=!1;const n=e.length;let o=e[0];for(let r=1;r<=n;r++){const s=e[r%n];if(i.y>Math.min(o.y,s.y)&&i.y<=Math.max(o.y,s.y)&&i.x<=Math.max(o.x,s.x)&&o.y!=s.y){const u=(i.y-o.y)*(s.x-o.x)/(s.y-o.y)+o.x;(o.x==s.x||i.x<=u)&&(t=!t)}o=s}return t}function Ii(i,e){let t;return function(...o){t&&clearTimeout(t),t=setTimeout(()=>{i(...o),t=void 0},e)}}function Go(i){for(const e in i)if(i.hasOwnProperty(e))return!1;return!0}function Wn(i,e,t=[]){if(i===e)return!0;if(typeof i!="object"||typeof e!="object"||i===null||e===null)return!1;const n=Object.keys(i).filter(r=>!t.includes(r)),o=Object.keys(e).filter(r=>!t.includes(r));if(n.length!==o.length)return!1;for(const r of n)if(!o.includes(r)||!Wn(i[r],e[r],t))return!1;return!0}function jo(i,e){return Wn(i,e,["lastModified","lastModifiedUserId"])}function Ei(i,e){let t=JSON.stringify(i);if(e){const o=JSON.stringify(e);t=t+o}return new TextEncoder().encode(t).length>14384}function Sn(i,e){const t=["lastModified","lastModifiedUserId"];if(i.length!==e.length)return!1;for(let n=0;n<i.length;n++)if(!Wn(i[n],e[n],t))return!1;return!0}function Wo(i,e){e.forEach(t=>{const n=i.findIndex(o=>o.id===t.id);n!==-1?i[n]=t:i.push(t)})}function qo(){try{localStorage.setItem("STORAGECHECK","test")}catch{const e=document.getElementById("localStorageWarning");e.innerText="Local Storage disabled. Some features will not function."}}function wi(i,e){const t=window.matchMedia("(prefers-color-scheme: dark)"),n=t.matches?"dark":"light",o=t.matches?"light":"dark";for(var r=0;r<e.styleSheets.length;r++)for(var s=0;s<e.styleSheets[r].cssRules.length;s++){let u=e.styleSheets[r].cssRules[s];u&&u.media&&u.media.mediaText.includes("prefers-color-scheme")&&(i.mode=="LIGHT"?(u.media.appendMedium(`(prefers-color-scheme: ${n})`),u.media.mediaText.includes(o)&&u.media.deleteMedium(`(prefers-color-scheme: ${o})`)):i.mode=="DARK"&&(u.media.appendMedium(`(prefers-color-scheme: ${o})`),u.media.mediaText.includes(n)&&u.media.deleteMedium(`(prefers-color-scheme: ${n})`)))}}async function $n(){const i=g.sceneItems.filter(mo);if(!g.sceneMetadata[`${c.EXTENSIONID}/autodetectEnabled`]&&i.length==0){let e=Vi().width(g.gridDpi*30).height(g.gridDpi*30).visible(!1).shapeType("RECTANGLE").visible(!0).locked(!1).strokeColor("pink").strokeOpacity(.5).fillOpacity(0).strokeDash([200,500]).strokeWidth(50).build();e.metadata[`${c.EXTENSIONID}/isBackgroundImage`]=!0,e.metadata[`${c.EXTENSIONID}/grid`]=!0,e.id=c.GRIDID,await b.scene.items.addItems([e])}g.sceneMetadata[`${c.EXTENSIONID}/autodetectEnabled`]===!0&&i.length>0&&await b.scene.items.deleteItems([c.GRIDID])}function Ko(i){function e(){document.getElementById("contextMenu").style.display="none"}const t=document.getElementById(`tr-${i.id}`);if(t){const n=t.getElementsByClassName("token-name")[0],o=t.getElementsByClassName("token-vision-range")[0],r=t.getElementsByClassName("unlimited-vision")[0],s=t.getElementsByClassName("no-vision")[0],u=t.getElementsByClassName("hidden-token")[0];n&&(n.innerText=i.name),o&&!r.checked&&!s.checked&&(o.value=i.metadata[`${c.EXTENSIONID}/visionRange`]!==void 0?i.metadata[`${c.EXTENSIONID}/visionRange`]:c.VISIONDEFAULT),r&&(r.checked=i.metadata[`${c.EXTENSIONID}/visionRange`]===0),s&&(s.checked=i.metadata[`${c.EXTENSIONID}/visionBlind`]),u&&(u.checked=i.metadata[`${c.EXTENSIONID}/hiddenToken`]),r.checked||s.checked?o.setAttribute("disabled","disabled"):o.removeAttribute("disabled")}else{const n=g.sceneMetadata[`${c.EXTENSIONID}/USER-${i.createdUserId}`];let o=n?.color,r=n?.name?`This token is owned by ${n.name}.`:"This token is owned by you.";!o&&i.createdUserId!==g.playerId&&(o="#aeb0af",r="This tokens owner is not in the room currently.");const s=g.sceneItems.find(M=>M.id===i.id),u=document.createElement("tr");u.id=`tr-${s.id}`,u.className="token-table-entry",u.innerHTML=`<td id="contextLocator" title="${r}" ${o==="#aeb0af"?'style="color:black !important; font-style: italic;" ':""}data-color="${o}" class="token-name">${s.name}</td>
                           <td class="token-vision-container" title="The unit of measurement for your grid"><input class="token-vision-range" type="number" value=${c.VISIONDEFAULT}><span class="unit">${g.gridType}</span></td>
                           <td class="token-vision-container-grid">
                            <div class="vision-container-div">
                                <label class="cbutton" title="Unlimited vision range"><input type="checkbox" class="unlimited-vision"><span class="emoji">&infin;</span></label>
                                <label class="cbutton" title="Turn token into a light source"><input type="checkbox" class="torch-vision"><span class="emoji">&#128294;</span></label>
                                <label class="cbutton" title="Disable vision on this token"><input type="checkbox" class="no-vision"><span class="emoji">&#8856;</span></label>
                                <label class="cbutton" title="Move to Out-of-Sight List"><input type="checkbox" class="hidden-token"><span class="emoji">&#128065;</span></label>
                            </div>
                           </td>`,i.metadata[`${c.EXTENSIONID}/hiddenToken`]===!0?Z.hiddenTable.prepend(u):Z.table.appendChild(u),u.getElementsByClassName("token-name")[0].style.textShadow=`
        -2px -2px 2px ${o},
        2px -2px 2px ${o},
        -2px 2px 2px ${o},
        2px 2px 2px ${o}`;const h=u.getElementsByClassName("token-vision-range")[0],y=u.getElementsByClassName("unlimited-vision")[0],O=u.getElementsByClassName("torch-vision")[0],x=u.getElementsByClassName("no-vision")[0],$=u.getElementsByClassName("hidden-token")[0];h&&!y.checked&&!x.checked&&(h.value=i.metadata[`${c.EXTENSIONID}/visionRange`]?i.metadata[`${c.EXTENSIONID}/visionRange`]:c.VISIONDEFAULT),y&&(y.checked=i.metadata[`${c.EXTENSIONID}/visionRange`]===0),O&&(O.checked=i.metadata[`${c.EXTENSIONID}/visionTorch`]),x&&(x.checked=i.metadata[`${c.EXTENSIONID}/visionBlind`]),$&&($.checked=i.metadata[`${c.EXTENSIONID}/hiddenToken`]),y.checked||x.checked?h.setAttribute("disabled","disabled"):h.removeAttribute("disabled"),h.onchange=async M=>{if(!M||!M.target)return;const S=g.sceneItems.find(R=>R.id===i.id),P=M.target,C=parseInt(P.value);C<0&&(P.value="0"),C>999&&(P.value="999"),await b.scene.items.updateItems([S],R=>{R[0].metadata[`${c.EXTENSIONID}/visionRange`]=C})},$.onclick=async M=>{if(!M||!M.target)return;const S=g.sceneItems.find(R=>R.id===i.id),P=M.target,C=document.getElementById(`tr-${i.id}`);P.checked?Z.hiddenTable.prepend(C):Z.table.appendChild(C),await b.scene.items.updateItems([S],R=>{R[0].metadata[`${c.EXTENSIONID}/hiddenToken`]=P.checked})},y.onclick=async M=>{if(!M||!M.target)return;const S=g.sceneItems.find(R=>R.id===i.id);let P=0;M.target.checked?(h.setAttribute("disabled","disabled"),x.checked=!1):(P=parseInt(h.value),h.removeAttribute("disabled")),await b.scene.items.updateItems([S],R=>{R[0].metadata[`${c.EXTENSIONID}/visionRange`]=P})},x.onclick=async M=>{if(!M||!M.target)return;const S=g.sceneItems.find(C=>C.id===i.id),P=M.target;P.checked?h.setAttribute("disabled","disabled"):h.removeAttribute("disabled"),await b.scene.items.updateItems([S],C=>{C[0].metadata[`${c.EXTENSIONID}/visionBlind`]=P.checked})},O.onclick=async M=>{if(!M||!M.target)return;const S=g.sceneItems.find(C=>C.id===i.id),P=M.target;await b.scene.items.updateItems([S],C=>{C[0].metadata[`${c.EXTENSIONID}/visionTorch`]=P.checked})},h.addEventListener("mousewheel",async()=>{}),u.oncontextmenu=async function(M){M.preventDefault();const S=M.currentTarget,P=document.getElementById("contextMenu"),C=B=>{B.preventDefault()},R=async B=>{const H=B.target,ie=P.getAttribute("currentUnit"),D=g.party.find(I=>H.id===I.id)?.color,m=document.getElementById(`tr-${ie}`).getElementsByClassName("token-name")[0];D?m.style.textShadow=`
                    -2px -2px 2px ${D},
                    2px -2px 2px ${D},
                    -2px 2px 2px ${D},
                    2px 2px 2px ${D}`:m.style.textShadow="",await b.scene.items.updateItems([ie],I=>{for(const p of I)p.createdUserId=H.id}),P.style.display="none",B.stopPropagation(),window.removeEventListener("click",L),P.removeEventListener("click",R),P.removeEventListener("contextmenu",C)};P.setAttribute("currentUnit",S.id.substring(3));const L=()=>{P.style.display="none",window.removeEventListener("click",L),P.removeEventListener("click",R),P.removeEventListener("contextmenu",C)};if(P.addEventListener("click",R),P.addEventListener("contextmenu",C),window.addEventListener("click",L),P.style.display=="block")e();else{const B=Math.min(M.pageX,window.innerWidth-150),H=Math.min(M.pageY,(window.innerHeight>300?window.innerHeight-50:window.innerHeight)-120);P.style.display="block",P.style.left=B+"px",P.style.top=H+"px"}}}}async function zo(i){const e=await b.scene.local.getItems(n=>n.metadata[`${c.EXTENSIONID}/doorId`]!==void 0),t=[];for(let n of e){let o=!1;for(const r of i)n.metadata[`${c.EXTENSIONID}/doorId`]==r.id&&(o=!0);o&&t.push(n.id)}await b.scene.local.deleteItems(t)}async function Qt(i){const e=[],t=await b.scene.local.getItems(n=>n.metadata[`${c.EXTENSIONID}/doorId`]!==void 0);for(const n of i){if(!Ho(n)||t.some(s=>s.metadata[`${c.EXTENSIONID}/doorId`]===n.id))continue;const o=We.fromItem(n),r=[];for(let s=0;s<n.points.length;s++){const u=We.fromPosition(n.points[s]);r.push(We.decompose(We.multiply(o,u)).position)}e.push(gt().locked(!0).commands(Hi(n.metadata[`${c.EXTENSIONID}/disabled`]===!0)).scale({x:.2,y:.2}).name("Door").position(ze.centroid(r)).metadata({[`${c.EXTENSIONID}/doorId`]:n.id}).build())}e.length>0&&await b.scene.local.addItems(e)}async function Yo(i){const e=await b.scene.local.getItems(t=>t.id===i&&t.metadata[`${c.EXTENSIONID}/doorId`]!==void 0);if(e.length===1){const t=e[0].metadata[`${c.EXTENSIONID}/doorId`],n=g.sceneItems.filter(o=>o.id===t);await b.scene.items.updateItems(n,o=>{const r=o[0];r.metadata[`${c.EXTENSIONID}/isVisionLine`]&&r.metadata[`${c.EXTENSIONID}/disabled`]?(delete r.metadata[`${c.EXTENSIONID}/disabled`],delete r.metadata[`${c.EXTENSIONID}/doorOpen`]):r.metadata[`${c.EXTENSIONID}/isVisionLine`]&&(r.metadata[`${c.EXTENSIONID}/disabled`]=!0,r.metadata[`${c.EXTENSIONID}/doorOpen`]=!0)}),await b.player.deselect([i])}}async function Zo(){const i=g.sceneItems.filter(e=>e.metadata[`${c.EXTENSIONID}/isDoor`]===!0);await Qt(i)}function Hi(i){return i?c.DOOROPEN:c.DOORCLOSED}var Ui={exports:{}};(function(i){(function(){function e(u,h){var y=u.x-h.x,O=u.y-h.y;return y*y+O*O}function t(u,h,y){var O=h.x,x=h.y,$=y.x-O,M=y.y-x;if($!==0||M!==0){var S=((u.x-O)*$+(u.y-x)*M)/($*$+M*M);S>1?(O=y.x,x=y.y):S>0&&(O+=$*S,x+=M*S)}return $=u.x-O,M=u.y-x,$*$+M*M}function n(u,h){for(var y=u[0],O=[y],x,$=1,M=u.length;$<M;$++)x=u[$],e(x,y)>h&&(O.push(x),y=x);return y!==x&&O.push(x),O}function o(u,h,y,O,x){for(var $=O,M,S=h+1;S<y;S++){var P=t(u[S],u[h],u[y]);P>$&&(M=S,$=P)}$>O&&(M-h>1&&o(u,h,M,O,x),x.push(u[M]),y-M>1&&o(u,M,y,O,x))}function r(u,h){var y=u.length-1,O=[u[0]];return o(u,0,y,h,O),O.push(u[y]),O}function s(u,h,y){if(u.length<=2)return u;var O=h!==void 0?h*h:1;return u=y?u:n(u,O),u=r(u,O),u}i.exports=s,i.exports.default=s})()})(Ui);var Jo=Ui.exports;const Qo=jn(Jo),qn="#000000",Kn=8,zn=[];function Pn(i){const e=g.sceneItems.filter(o=>o.layer==="MAP"),t={};for(let o=0;o<e.length;o++){let r=i.querySelector("#map-"+e[o].id);r===null&&(r=document.createElement("option"),r.id="map-"+e[o].id,r.value=e[o].id,r.innerText=e[o].name,i.appendChild(r)),t[e[o].id]=e[o].name}let n=i.querySelectorAll("option");for(let o=0;o<n.length;o++)t[n[o].value]===void 0&&i.removeChild(n[o])}async function er(i,e,t,n,o){if(o.innerText="",Number.isNaN(t)||t<0){o.innerText="Invalid DPI";return}let r=g.gridDpi/t,s,u=[];if(u[0]=0,u[1]=0,n!==""){let h=await b.scene.items.getItems([n]);if(h.length>0)s=h[0],t===0&&(t=s.grid.dpi),r=g.gridDpi/t,u[0]=s.position.x-s.grid.offset.x*r,u[1]=s.position.y-s.grid.offset.y*r;else{o.innerText="Unable to find map";return}}else{o.innerText="No map selected";return}i==="foundry"?or(e,r,u,o):i==="uvtt"&&ir(e,r,u,o)}function Si(i){const e=[];for(const t of i){const n=[];for(const r of t)n.push({x:r.x*g.gridDpi,y:r.y*g.gridDpi});const o=ct().tension(0).points(n).strokeColor(g.sceneMetadata[`${c.EXTENSIONID}/toolColor`]??qn).strokeDash(g.sceneMetadata[`${c.EXTENSIONID}/toolStyle`]??zn).strokeWidth(g.sceneMetadata[`${c.EXTENSIONID}/toolWidth`]??Kn).fillOpacity(0).fillColor("#000000").layer("DRAWING").name("Vision Line (Line)").closed(!1).locked(!0).visible(!1).metadata({[`${c.EXTENSIONID}/isVisionLine`]:!0}).build();e.push(o)}return e}function tr(i){const e=[];for(const t of i){const n=[];for(const r of t.bounds)n.push({x:r.x*g.gridDpi,y:r.y*g.gridDpi});const o=ct().tension(0).points(n).strokeColor(g.sceneMetadata[`${c.EXTENSIONID}/toolColor`]??qn).strokeDash(g.sceneMetadata[`${c.EXTENSIONID}/toolStyle`]??zn).strokeWidth(g.sceneMetadata[`${c.EXTENSIONID}/toolWidth`]??Kn).fillOpacity(0).fillColor("#000000").layer("DRAWING").name("Vision Line (Door)").closed(!1).locked(!0).visible(!1).metadata({[`${c.EXTENSIONID}/isVisionLine`]:!0,[`${c.EXTENSIONID}/isDoor`]:!0}).build();e.push(o)}return e}async function nr(i,e){let t=[];i.objects_line_of_sight?.length>0&&(t=t.concat(Si(i.objects_line_of_sight))),i.line_of_sight?.length>0&&(t=t.concat(Si(i.line_of_sight))),i.portals?.length>0&&(t=t.concat(tr(i.portals)));try{if(i.lights?.length>0){const h=[];for(const y of i.lights){const O=Ro({height:150,width:150,url:"https://battle-system.com/blank.png",mime:"image/png"},{dpi:300,offset:{x:150,y:150}}).position({x:y.position.x*g.gridDpi,y:y.position.y*g.gridDpi}).layer("CHARACTER").metadata({[`${c.EXTENSIONID}/hasVision`]:!0,[`${c.EXTENSIONID}/visionRange`]:y.range.toString(),[`${c.EXTENSIONID}/visionTorch`]:!0,[`${c.EXTENSIONID}/hiddenToken`]:!0}).name("Imported Light Source").build();h.push(O)}t=t.concat(h)}const n=atob(i.image),o=new Uint8Array(n.length);for(let h=0;h<n.length;h++)o[h]=n.charCodeAt(h);const r=new Blob([o],{type:"image/png"}),s=Xo(r).grid({dpi:i.resolution.pixels_per_grid,offset:{x:0,y:0}}).build(),u=Fo().baseMap(s).name("New UVTT Scene").items(t).build();await b.assets.uploadScenes([u],!0),await b.notification.show("Toggle Smoke Off then On when opening the new Scene","DEFAULT")}catch(n){await b.notification.show("There was an error: "+n,"ERROR")}}async function Gi(i,e,t,n,o){let r=0,s=0,u=0;const h=[];for(let y=0;y<i.length;y++){let O=[],x=!1;for(let $=0;$<i[y].length-1;$++){let M=i[y][$].x*e,S=i[y][$].y*e,P=i[y][$+1].x*e,C=i[y][$+1].y*e;O.push({x:M*t+n[0],y:S*t+n[1]}),O.push({x:P*t+n[0],y:C*t+n[1]}),s++,!x&&i[y][$].door&&(x=!0)}O.length>128&&(O.length,O=Qo(O,8,!1));for(let $=0;$<O.length;$+=256){const M=O.slice($>0?$-1:0,$+256),S=ct().tension(0).points(M).strokeColor(g.sceneMetadata[`${c.EXTENSIONID}/toolColor`]??qn).strokeDash(g.sceneMetadata[`${c.EXTENSIONID}/toolStyle`]??zn).strokeWidth(g.sceneMetadata[`${c.EXTENSIONID}/toolWidth`]??Kn).fillOpacity(0).fillColor("#000000").layer("DRAWING").name("Vision Line (Import)").closed(!1).locked(!0).build();if(S.visible=!1,S.metadata[`${c.EXTENSIONID}/isVisionLine`]=!0,x&&(S.metadata[`${c.EXTENSIONID}/isDoor`]=!0),h.push(S),u+=M.length,u>512||h.length>64){r+=h.length,await b.scene.items.addItems(h);const P=h.filter(C=>C.metadata[`${c.EXTENSIONID}/isDoor`]===!0);await Qt(P),h.length=0,u=0}}}if(h.length>0){r+=h.length,await b.scene.items.addItems(h);const y=h.filter(O=>O.metadata[`${c.EXTENSIONID}/isDoor`]===!0);await Qt(y)}o.innerText="Finished importing "+r+" walls, "+s+" points."}function ir(i,e,t,n){if(i.resolution.map_origin!==void 0&&(t[0]-=i.resolution.map_origin.x*i.resolution.pixels_per_grid,t[1]-=i.resolution.map_origin.y*i.resolution.pixels_per_grid),i.portals&&i.portals.length)for(let r=0;r<i.portals.length;r++){let s=i.portals[r].bounds;s[0].door=!0,s[1].door=!0,i.line_of_sight.push(s)}const o=i.line_of_sight.concat(i.objects_line_of_sight);Gi(o,i.resolution.pixels_per_grid,e,t,n)}function or(i,e,t,n){if(!i.walls||i.walls.length===0){n.innerText="No walls found";return}const o=[];for(var r=0;r<i.walls.length;r++)o.push([{x:i.walls[r].c[0],y:i.walls[r].c[1],door:!!i.walls[r].door},{x:i.walls[r].c[2],y:i.walls[r].c[3],door:!!i.walls[r].door}]);Gi(o,1,e,t,n)}async function Ti(){await b.contextMenu.create({id:`${c.EXTENSIONID}/convert-curve`,icons:[{icon:"/opendoor.svg",label:"Convert to Obstruction",filter:{every:[{key:"layer",value:"DRAWING"},{key:["metadata",`${c.EXTENSIONID}/elevation`],value:void 0},{key:["metadata",`${c.EXTENSIONID}/isVisionLine`],value:void 0}],roles:["GM"]}}],async onClick(i){const e="#000000",n=[],o=[],r=[];for(const s of i.items){if(s.type==="CURVE"){const u=s;if(u.points.length>2){const h=ct().tension(0).points(u.points).strokeColor(g.sceneMetadata[`${c.EXTENSIONID}/toolColor`]??e).strokeDash(g.sceneMetadata[`${c.EXTENSIONID}/toolStyle`]??n).strokeWidth(g.sceneMetadata[`${c.EXTENSIONID}/toolWidth`]??8).fillOpacity(0).fillColor("#000000").layer("DRAWING").name("Vision Line (Line)").closed(!1).locked(!0).visible(!1).position(u.position).metadata({[`${c.EXTENSIONID}/isVisionLine`]:!0}).build();u.style.closed&&h.points.push(u.points[0]),o.push(h),r.push(u.id)}}else if(s.type==="LINE"){const u=s,h=ct().tension(0).points([u.startPosition,u.endPosition]).strokeColor(g.sceneMetadata[`${c.EXTENSIONID}/toolColor`]??e).strokeDash(g.sceneMetadata[`${c.EXTENSIONID}/toolStyle`]??n).strokeWidth(g.sceneMetadata[`${c.EXTENSIONID}/toolWidth`]??8).fillOpacity(0).fillColor("#000000").layer("DRAWING").name("Vision Line (Line)").closed(!1).locked(!0).visible(!1).position(u.position).metadata({[`${c.EXTENSIONID}/isVisionLine`]:!0}).build();o.push(h),r.push(u.id)}else if(s.type==="SHAPE"){const u=s,h=[];if(u.shapeType==="CIRCLE"){const y=Math.min(u.width,u.height)/2,O=2*Math.PI/20;for(let x=0;x<20;x++){const $=x*O,M=y*Math.cos($),S=y*Math.sin($);h.push({x:M,y:S})}}else if(u.shapeType==="RECTANGLE"){const x=0+u.width,$=0+u.height;h.push({x:0,y:0}),h.push({x,y:0}),h.push({x,y:$}),h.push({x:0,y:$})}else if(u.shapeType==="HEXAGON"){const y=u.width/2,O=[Math.PI/2,Math.PI/6,11*Math.PI/6,3*Math.PI/2,7*Math.PI/6,5*Math.PI/6];for(let x=0;x<6;x++){const $=O[x],M=y*Math.cos($),S=y*Math.sin($);h.push({x:M,y:S})}}else u.shapeType==="TRIANGLE"&&(h.push({x:0,y:0}),h.push({x:0-u.width/2,y:0+u.height}),h.push({x:0+u.width/2,y:0+u.height}));if(h.length>0){const y=ct().tension(0).points(h).position(u.position).rotation(u.rotation).strokeColor(g.sceneMetadata[`${c.EXTENSIONID}/toolColor`]??e).strokeDash(g.sceneMetadata[`${c.EXTENSIONID}/toolStyle`]??n).strokeWidth(g.sceneMetadata[`${c.EXTENSIONID}/toolWidth`]??8).fillOpacity(0).fillColor("#000000").layer("DRAWING").name("Vision Line (Line)").closed(!1).locked(!0).visible(!1).metadata({[`${c.EXTENSIONID}/isVisionLine`]:!0}).build();y.points.push(h[0]),o.push(y),r.push(u.id)}}o.length>0&&(await b.scene.items.addItems(o),await b.scene.items.deleteItems(r))}}}),await b.contextMenu.create({id:`${c.EXTENSIONID}/toggle-vision-menu`,icons:[{icon:"/no-vision.svg",label:"Enable Vision",filter:{every:[{key:["metadata",`${c.EXTENSIONID}/hasVision`],operator:"==",value:void 0,coordinator:"&&"},{key:["metadata",`${c.SPECTREID}/spectred`],operator:"==",value:void 0}],some:[{key:"layer",value:"CHARACTER",coordinator:"||"},{key:"layer",value:"ATTACHMENT"}]}},{icon:"/icon.svg",label:"Disable Vision",filter:{every:[{key:["metadata",`${c.SPECTREID}/spectred`],operator:"==",value:void 0}],some:[{key:"layer",value:"CHARACTER",coordinator:"||"},{key:"layer",value:"ATTACHMENT"}]}}],async onClick(i){const e=i.items.every(t=>t.metadata[`${c.EXTENSIONID}/hasVision`]===void 0);await b.scene.items.updateItems(i.items,t=>{for(const n of t)e?(n.metadata[`${c.EXTENSIONID}/hasVision`]=!0,n.metadata[`${c.EXTENSIONID}/visionRange`]===void 0&&(n.metadata[`${c.EXTENSIONID}/visionRange`]=c.VISIONDEFAULT)):delete n.metadata[`${c.EXTENSIONID}/hasVision`]})}}),await b.contextMenu.create({id:`${c.EXTENSIONID}/toggle-groupvision-menu`,icons:[{icon:"/no-vision.svg",label:"Toggle Attachments Vision",filter:{every:[{key:"layer",value:"NOTE"},{key:["metadata",`${c.EXTENSIONID}/hasVision`],value:void 0}]}}],async onClick(i){if(i.items.length>0){const e=i.items.map(n=>n.id),t=await b.scene.items.getItemAttachments(e);await b.scene.items.updateItems(t,n=>{for(const o of n)e.includes(o.attachedTo)&&(o.metadata[`${c.EXTENSIONID}/hasVision`]&&(o.layer=="CHARACTER"||o.layer=="ATTACHMENT")?delete o.metadata[`${c.EXTENSIONID}/hasVision`]:(o.layer=="CHARACTER"||o.layer=="ATTACHMENT")&&(o.metadata[`${c.EXTENSIONID}/hasVision`]=!0,o.metadata[`${c.EXTENSIONID}/visionRange`]===void 0&&(o.metadata[`${c.EXTENSIONID}/visionRange`]=c.VISIONDEFAULT)))})}}}),await b.contextMenu.create({id:`${c.EXTENSIONID}/toggle-vision-line`,icons:[{icon:"/icon.svg",label:"Disable Vision Line",filter:{some:[{key:["metadata",`${c.EXTENSIONID}/isVisionLine`],value:!0,coordinator:"&&"},{key:["metadata",`${c.EXTENSIONID}/disabled`],value:void 0,coordinator:"||"},{key:["metadata",`${c.ARMINDOID}/isVisionLine`],value:!0,coordinator:"&&"},{key:["metadata",`${c.ARMINDOID}/disabled`],value:void 0}]}},{icon:"/no-vision.svg",label:"Enable Vision Line",filter:{some:[{key:["metadata",`${c.EXTENSIONID}/isVisionLine`],value:!0,coordinator:"||"},{key:["metadata",`${c.ARMINDOID}/isVisionLine`],value:!0}]}}],async onClick(i){await b.scene.items.updateItems(i.items,e=>{for(const t of e)t.metadata[`${c.EXTENSIONID}/isVisionLine`]&&t.metadata[`${c.EXTENSIONID}/disabled`]?delete t.metadata[`${c.EXTENSIONID}/disabled`]:t.metadata[`${c.EXTENSIONID}/isVisionLine`]&&(t.metadata[`${c.EXTENSIONID}/disabled`]=!0)})}}),await b.contextMenu.create({id:`${c.EXTENSIONID}/switch-one-sided-type`,icons:[{icon:"/two-sided.svg",label:"Two-sided",filter:{some:[{key:["metadata",`${c.EXTENSIONID}/isVisionLine`],value:!0,coordinator:"&&"},{key:["metadata",`${c.EXTENSIONID}/oneSided`],value:void 0,coordinator:"||"},{key:["metadata",`${c.ARMINDOID}/isVisionLine`],value:!0,coordinator:"&&"},{key:["metadata",`${c.ARMINDOID}/oneSided`],value:void 0}]}},{icon:"/left-sided.svg",label:"One-sided left",filter:{some:[{key:["metadata",`${c.EXTENSIONID}/isVisionLine`],value:!0,coordinator:"&&"},{key:["metadata",`${c.EXTENSIONID}/oneSided`],value:"left",coordinator:"||"},{key:["metadata",`${c.ARMINDOID}/isVisionLine`],value:!0,coordinator:"&&"},{key:["metadata",`${c.ARMINDOID}/oneSided`],value:"left"}]}},{icon:"/right-sided.svg",label:"One-sided right",filter:{some:[{key:["metadata",`${c.EXTENSIONID}/isVisionLine`],value:!0,coordinator:"||"},{key:["metadata",`${c.ARMINDOID}/isVisionLine`],value:!0}]}}],async onClick(i){await b.scene.items.updateItems(i.items,e=>{for(const t of e)(t.metadata[`${c.EXTENSIONID}/isVisionLine`]||t.metadata[`${c.ARMINDOID}/isVisionLine`])&&(t.metadata[`${c.EXTENSIONID}/oneSided`]=="right"||t.metadata[`${c.ARMINDOID}/oneSided`]=="right")?(delete t.metadata[`${c.EXTENSIONID}/oneSided`],delete t.metadata[`${c.ARMINDOID}/oneSided`]):(t.metadata[`${c.EXTENSIONID}/isVisionLine`]||t.metadata[`${c.ARMINDOID}/isVisionLine`])&&(t.metadata[`${c.EXTENSIONID}/oneSided`]=="left"||t.metadata[`${c.ARMINDOID}/oneSided`]=="left")?(t.metadata[`${c.EXTENSIONID}/oneSided`]="right",t.metadata[`${c.ARMINDOID}/oneSided`]="right"):(t.metadata[`${c.EXTENSIONID}/isVisionLine`]||t.metadata[`${c.ARMINDOID}/isVisionLine`])&&(t.metadata[`${c.EXTENSIONID}/oneSided`]="left",t.metadata[`${c.ARMINDOID}/oneSided`]="left")})}}),await b.contextMenu.create({id:`${c.EXTENSIONID}/toggle-fog-background`,icons:[{icon:"/fog-background.svg",label:"Convert To Fog Background",filter:{every:[{key:"layer",value:"MAP"}]}}],async onClick(i){i.items.length>0&&await b.scene.items.updateItems(i.items,e=>{for(let t=0;t<e.length;t++)e[t].zIndex=1,e[t].layer="FOG",e[t].disableHit=!0,e[t].locked=!1,e[t].visible=!1,e[t].metadata[`${c.EXTENSIONID}/isBackgroundMap`]=!0})}}),await b.contextMenu.create({id:`${c.EXTENSIONID}/bounding-grid`,icons:[{icon:"/icon.svg",label:"Smoke Bounding Grid",filter:{every:[{key:["metadata",`${c.EXTENSIONID}/grid`],value:!0}]}}],async onClick(i){await b.notification.show("This is the Smoke&Spectre Bounding Grid. It contains the area your fog can be drawn in. To remove this and have fog contained dynamically by the size of your map(s), turn on AutoDetect Maps in Settings.","INFO")}}),await b.contextMenu.create({id:`${c.EXTENSIONID}/toggle-door`,icons:[{icon:"/opendoor.svg",label:"Enable Door",filter:{every:[{key:"layer",value:"DRAWING"},{key:["metadata",`${c.EXTENSIONID}/isVisionLine`],value:!0},{key:["metadata",`${c.EXTENSIONID}/isDoor`],value:void 0},{key:["metadata",`${c.EXTENSIONID}/doorId`],value:void 0},{key:["metadata",`${c.EXTENSIONID}/grid`],value:void 0}],roles:["GM"]}},{icon:"/closedoor.svg",label:"Disable Door",filter:{every:[{key:"layer",value:"DRAWING"},{key:["metadata",`${c.EXTENSIONID}/isVisionLine`],value:!0},{key:["metadata",`${c.EXTENSIONID}/doorId`],value:void 0},{key:["metadata",`${c.EXTENSIONID}/grid`],value:void 0}],roles:["GM"]}}],async onClick(i){const e=i.items.every(t=>t.metadata[`${c.EXTENSIONID}/isDoor`]===void 0);await b.scene.items.updateItems(i.items,t=>{for(const n of t)e?n.metadata[`${c.EXTENSIONID}/isDoor`]=!0:delete n.metadata[`${c.EXTENSIONID}/isDoor`]}),e?await Qt(i.items):await zo(i.items)}})}async function en(i){i?await b.contextMenu.create({id:`${c.EXTENSIONID}/toggle-autohide-menu`,icons:[{icon:"/autohide-off.svg",label:"Enable Autohide",filter:{every:[{key:"layer",value:"CHARACTER"},{key:["metadata",`${c.EXTENSIONID}/hasAutohide`],value:void 0}],roles:["GM"]}},{icon:"/autohide-on.svg",label:"Disable Autohide",filter:{every:[{key:"layer",value:"CHARACTER"}],roles:["GM"]}}],async onClick(e){const t=e.items.every(n=>n.metadata[`${c.EXTENSIONID}/hasAutohide`]===void 0);await b.scene.items.updateItems(e.items,n=>{for(const o of n)t?o.metadata[`${c.EXTENSIONID}/hasAutohide`]=!0:delete o.metadata[`${c.EXTENSIONID}/hasAutohide`]})}}):await b.contextMenu.remove(`${c.EXTENSIONID}/toggle-autohide-menu`)}function Tn(i,e){i.split(/\s+/).forEach(t=>{e(t)})}class rr{constructor(){this._events=void 0,this._events={}}on(e,t){Tn(e,n=>{const o=this._events[n]||[];o.push(t),this._events[n]=o})}off(e,t){var n=arguments.length;if(n===0){this._events={};return}Tn(e,o=>{if(n===1){delete this._events[o];return}const r=this._events[o];r!==void 0&&(r.splice(r.indexOf(t),1),this._events[o]=r)})}trigger(e,...t){var n=this;Tn(e,o=>{const r=n._events[o];r!==void 0&&r.forEach(s=>{s.apply(n,t)})})}}function ar(i){return i.plugins={},class extends i{constructor(...e){super(...e),this.plugins={names:[],settings:{},requested:{},loaded:{}}}static define(e,t){i.plugins[e]={name:e,fn:t}}initializePlugins(e){var t,n;const o=this,r=[];if(Array.isArray(e))e.forEach(s=>{typeof s=="string"?r.push(s):(o.plugins.settings[s.name]=s.options,r.push(s.name))});else if(e)for(t in e)e.hasOwnProperty(t)&&(o.plugins.settings[t]=e[t],r.push(t));for(;n=r.shift();)o.require(n)}loadPlugin(e){var t=this,n=t.plugins,o=i.plugins[e];if(!i.plugins.hasOwnProperty(e))throw new Error('Unable to find "'+e+'" plugin');n.requested[e]=!0,n.loaded[e]=o.fn.apply(t,[t.plugins.settings[e]||{}]),n.names.push(e)}require(e){var t=this,n=t.plugins;if(!t.plugins.loaded.hasOwnProperty(e)){if(n.requested[e])throw new Error('Plugin has circular dependency ("'+e+'")');t.loadPlugin(e)}return n.loaded[e]}}}/*! @orchidjs/unicode-variants | https://github.com/orchidjs/unicode-variants | Apache License (v2) */const an=i=>(i=i.filter(Boolean),i.length<2?i[0]||"":lr(i)==1?"["+i.join("")+"]":"(?:"+i.join("|")+")"),ji=i=>{if(!sr(i))return i.join("");let e="",t=0;const n=()=>{t>1&&(e+="{"+t+"}")};return i.forEach((o,r)=>{if(o===i[r-1]){t++;return}n(),e+=o,t=1}),n(),e},Wi=i=>{let e=Yn(i);return an(e)},sr=i=>new Set(i).size!==i.length,Mt=i=>(i+"").replace(/([\$\(\)\*\+\.\?\[\]\^\{\|\}\\])/gu,"\\$1"),lr=i=>i.reduce((e,t)=>Math.max(e,cr(t)),0),cr=i=>Yn(i).length,Yn=i=>Array.from(i);/*! @orchidjs/unicode-variants | https://github.com/orchidjs/unicode-variants | Apache License (v2) */const qi=i=>{if(i.length===1)return[[i]];let e=[];const t=i.substring(1);return qi(t).forEach(function(o){let r=o.slice(0);r[0]=i.charAt(0)+r[0],e.push(r),r=o.slice(0),r.unshift(i.charAt(0)),e.push(r)}),e};/*! @orchidjs/unicode-variants | https://github.com/orchidjs/unicode-variants | Apache License (v2) */const ur=[[0,65535]],dr="[̀-ͯ·ʾʼ]";let tn,Ki;const fr=3,Zn={},bi={"/":"⁄∕",0:"߀",a:"ⱥɐɑ",aa:"ꜳ",ae:"æǽǣ",ao:"ꜵ",au:"ꜷ",av:"ꜹꜻ",ay:"ꜽ",b:"ƀɓƃ",c:"ꜿƈȼↄ",d:"đɗɖᴅƌꮷԁɦ",e:"ɛǝᴇɇ",f:"ꝼƒ",g:"ǥɠꞡᵹꝿɢ",h:"ħⱨⱶɥ",i:"ɨı",j:"ɉȷ",k:"ƙⱪꝁꝃꝅꞣ",l:"łƚɫⱡꝉꝇꞁɭ",m:"ɱɯϻ",n:"ꞥƞɲꞑᴎлԉ",o:"øǿɔɵꝋꝍᴑ",oe:"œ",oi:"ƣ",oo:"ꝏ",ou:"ȣ",p:"ƥᵽꝑꝓꝕρ",q:"ꝗꝙɋ",r:"ɍɽꝛꞧꞃ",s:"ßȿꞩꞅʂ",t:"ŧƭʈⱦꞇ",th:"þ",tz:"ꜩ",u:"ʉ",v:"ʋꝟʌ",vy:"ꝡ",w:"ⱳ",y:"ƴɏỿ",z:"ƶȥɀⱬꝣ",hv:"ƕ"};for(let i in bi){let e=bi[i]||"";for(let t=0;t<e.length;t++){let n=e.substring(t,t+1);Zn[n]=i}}const hr=new RegExp(Object.keys(Zn).join("|")+"|"+dr,"gu"),pr=i=>{tn===void 0&&(tn=vr(i||ur))},Ni=(i,e="NFKD")=>i.normalize(e),nn=i=>Yn(i).reduce((e,t)=>e+gr(t),""),gr=i=>(i=Ni(i).toLowerCase().replace(hr,e=>Zn[e]||""),Ni(i,"NFC"));function*mr(i){for(const[e,t]of i)for(let n=e;n<=t;n++){let o=String.fromCharCode(n),r=nn(o);r!=o.toLowerCase()&&(r.length>fr||r.length!=0&&(yield{folded:r,composed:o,code_point:n}))}}const yr=i=>{const e={},t=(n,o)=>{const r=e[n]||new Set,s=new RegExp("^"+Wi(r)+"$","iu");o.match(s)||(r.add(Mt(o)),e[n]=r)};for(let n of mr(i))t(n.folded,n.folded),t(n.folded,n.composed);return e},vr=i=>{const e=yr(i),t={};let n=[];for(let r in e){let s=e[r];s&&(t[r]=Wi(s)),r.length>1&&n.push(Mt(r))}n.sort((r,s)=>s.length-r.length);const o=an(n);return Ki=new RegExp("^"+o,"u"),t},Ir=(i,e=1)=>{let t=0;return i=i.map(n=>(tn[n]&&(t+=n.length),tn[n]||n)),t>=e?ji(i):""},Er=(i,e=1)=>(e=Math.max(e,i.length-1),an(qi(i).map(t=>Ir(t,e)))),Oi=(i,e=!0)=>{let t=i.length>1?1:0;return an(i.map(n=>{let o=[];const r=e?n.length():n.length()-1;for(let s=0;s<r;s++)o.push(Er(n.substrs[s]||"",t));return ji(o)}))},wr=(i,e)=>{for(const t of e){if(t.start!=i.start||t.end!=i.end||t.substrs.join("")!==i.substrs.join(""))continue;let n=i.parts;const o=s=>{for(const u of n){if(u.start===s.start&&u.substr===s.substr)return!1;if(!(s.length==1||u.length==1)&&(s.start<u.start&&s.end>u.start||u.start<s.start&&u.end>s.start))return!0}return!1};if(!(t.parts.filter(o).length>0))return!0}return!1};class on{constructor(){this.parts=[],this.substrs=[],this.start=0,this.end=0}add(e){e&&(this.parts.push(e),this.substrs.push(e.substr),this.start=Math.min(e.start,this.start),this.end=Math.max(e.end,this.end))}last(){return this.parts[this.parts.length-1]}length(){return this.parts.length}clone(e,t){let n=new on,o=JSON.parse(JSON.stringify(this.parts)),r=o.pop();for(const h of o)n.add(h);let s=t.substr.substring(0,e-r.start),u=s.length;return n.add({start:r.start,end:r.start+u,length:u,substr:s}),n}}const Sr=i=>{pr(),i=nn(i);let e="",t=[new on];for(let n=0;n<i.length;n++){let r=i.substring(n).match(Ki);const s=i.substring(n,n+1),u=r?r[0]:null;let h=[],y=new Set;for(const O of t){const x=O.last();if(!x||x.length==1||x.end<=n)if(u){const $=u.length;O.add({start:n,end:n+$,length:$,substr:u}),y.add("1")}else O.add({start:n,end:n+1,length:1,substr:s}),y.add("2");else if(u){let $=O.clone(n,x);const M=u.length;$.add({start:n,end:n+M,length:M,substr:u}),h.push($)}else y.add("3")}if(h.length>0){h=h.sort((O,x)=>O.length()-x.length());for(let O of h)wr(O,t)||t.push(O);continue}if(n>0&&y.size==1&&!y.has("3")){e+=Oi(t,!1);let O=new on;const x=t[0];x&&O.add(x.last()),t=[O]}}return e+=Oi(t,!0),e};/*! sifter.js | https://github.com/orchidjs/sifter.js | Apache License (v2) */const Tr=(i,e)=>{if(i)return i[e]},br=(i,e)=>{if(i){for(var t,n=e.split(".");(t=n.shift())&&(i=i[t]););return i}},bn=(i,e,t)=>{var n,o;return!i||(i=i+"",e.regex==null)||(o=i.search(e.regex),o===-1)?0:(n=e.string.length/i.length,o===0&&(n+=.5),n*t)},Nn=(i,e)=>{var t=i[e];if(typeof t=="function")return t;t&&!Array.isArray(t)&&(i[e]=[t])},et=(i,e)=>{if(Array.isArray(i))i.forEach(e);else for(var t in i)i.hasOwnProperty(t)&&e(i[t],t)},Nr=(i,e)=>typeof i=="number"&&typeof e=="number"?i>e?1:i<e?-1:0:(i=nn(i+"").toLowerCase(),e=nn(e+"").toLowerCase(),i>e?1:e>i?-1:0);/*! sifter.js | https://github.com/orchidjs/sifter.js | Apache License (v2) */class Or{constructor(e,t){this.items=void 0,this.settings=void 0,this.items=e,this.settings=t||{diacritics:!0}}tokenize(e,t,n){if(!e||!e.length)return[];const o=[],r=e.split(/\s+/);var s;return n&&(s=new RegExp("^("+Object.keys(n).map(Mt).join("|")+"):(.*)$")),r.forEach(u=>{let h,y=null,O=null;s&&(h=u.match(s))&&(y=h[1],u=h[2]),u.length>0&&(this.settings.diacritics?O=Sr(u)||null:O=Mt(u),O&&t&&(O="\\b"+O)),o.push({string:u,regex:O?new RegExp(O,"iu"):null,field:y})}),o}getScoreFunction(e,t){var n=this.prepareSearch(e,t);return this._getScoreFunction(n)}_getScoreFunction(e){const t=e.tokens,n=t.length;if(!n)return function(){return 0};const o=e.options.fields,r=e.weights,s=o.length,u=e.getAttrFn;if(!s)return function(){return 1};const h=function(){return s===1?function(y,O){const x=o[0].field;return bn(u(O,x),y,r[x]||1)}:function(y,O){var x=0;if(y.field){const $=u(O,y.field);!y.regex&&$?x+=1/s:x+=bn($,y,1)}else et(r,($,M)=>{x+=bn(u(O,M),y,$)});return x/s}}();return n===1?function(y){return h(t[0],y)}:e.options.conjunction==="and"?function(y){var O,x=0;for(let $ of t){if(O=h($,y),O<=0)return 0;x+=O}return x/n}:function(y){var O=0;return et(t,x=>{O+=h(x,y)}),O/n}}getSortFunction(e,t){var n=this.prepareSearch(e,t);return this._getSortFunction(n)}_getSortFunction(e){var t,n=[];const o=this,r=e.options,s=!e.query&&r.sort_empty?r.sort_empty:r.sort;if(typeof s=="function")return s.bind(this);const u=function(O,x){return O==="$score"?x.score:e.getAttrFn(o.items[x.id],O)};if(s)for(let y of s)(e.query||y.field!=="$score")&&n.push(y);if(e.query){t=!0;for(let y of n)if(y.field==="$score"){t=!1;break}t&&n.unshift({field:"$score",direction:"desc"})}else n=n.filter(y=>y.field!=="$score");return n.length?function(y,O){var x,$;for(let M of n)if($=M.field,x=(M.direction==="desc"?-1:1)*Nr(u($,y),u($,O)),x)return x;return 0}:null}prepareSearch(e,t){const n={};var o=Object.assign({},t);if(Nn(o,"sort"),Nn(o,"sort_empty"),o.fields){Nn(o,"fields");const r=[];o.fields.forEach(s=>{typeof s=="string"&&(s={field:s,weight:1}),r.push(s),n[s.field]="weight"in s?s.weight:1}),o.fields=r}return{options:o,query:e.toLowerCase().trim(),tokens:this.tokenize(e,o.respect_word_boundaries,n),total:0,items:[],weights:n,getAttrFn:o.nesting?br:Tr}}search(e,t){var n=this,o,r;r=this.prepareSearch(e,t),t=r.options,e=r.query;const s=t.score||n._getScoreFunction(r);e.length?et(n.items,(h,y)=>{o=s(h),(t.filter===!1||o>0)&&r.items.push({score:o,id:y})}):et(n.items,(h,y)=>{r.items.push({score:1,id:y})});const u=n._getSortFunction(r);return u&&r.items.sort(u),r.total=r.items.length,typeof t.limit=="number"&&(r.items=r.items.slice(0,t.limit)),r}}const Nt=(i,e)=>{if(Array.isArray(i))i.forEach(e);else for(var t in i)i.hasOwnProperty(t)&&e(i[t],t)},je=i=>{if(i.jquery)return i[0];if(i instanceof HTMLElement)return i;if(zi(i)){var e=document.createElement("template");return e.innerHTML=i.trim(),e.content.firstChild}return document.querySelector(i)},zi=i=>typeof i=="string"&&i.indexOf("<")>-1,kr=i=>i.replace(/['"\\]/g,"\\$&"),On=(i,e)=>{var t=document.createEvent("HTMLEvents");t.initEvent(e,!0,!1),i.dispatchEvent(t)},Ft=(i,e)=>{Object.assign(i.style,e)},Qe=(i,...e)=>{var t=Yi(e);i=Zi(i),i.map(n=>{t.map(o=>{n.classList.add(o)})})},pt=(i,...e)=>{var t=Yi(e);i=Zi(i),i.map(n=>{t.map(o=>{n.classList.remove(o)})})},Yi=i=>{var e=[];return Nt(i,t=>{typeof t=="string"&&(t=t.trim().split(/[\11\12\14\15\40]/)),Array.isArray(t)&&(e=e.concat(t))}),e.filter(Boolean)},Zi=i=>(Array.isArray(i)||(i=[i]),i),Kt=(i,e,t)=>{if(!(t&&!t.contains(i)))for(;i&&i.matches;){if(i.matches(e))return i;i=i.parentNode}},ki=(i,e=0)=>e>0?i[i.length-1]:i[0],Dr=i=>Object.keys(i).length===0,rn=(i,e)=>{if(!i)return-1;e=e||i.nodeName;for(var t=0;i=i.previousElementSibling;)i.matches(e)&&t++;return t},Ve=(i,e)=>{Nt(e,(t,n)=>{t==null?i.removeAttribute(n):i.setAttribute(n,""+t)})},Ln=(i,e)=>{i.parentNode&&i.parentNode.replaceChild(e,i)},xr=(i,e)=>{if(e===null)return;if(typeof e=="string"){if(!e.length)return;e=new RegExp(e,"i")}const t=r=>{var s=r.data.match(e);if(s&&r.data.length>0){var u=document.createElement("span");u.className="highlight";var h=r.splitText(s.index);h.splitText(s[0].length);var y=h.cloneNode(!0);return u.appendChild(y),Ln(h,u),1}return 0},n=r=>{r.nodeType===1&&r.childNodes&&!/(script|style)/i.test(r.tagName)&&(r.className!=="highlight"||r.tagName!=="SPAN")&&Array.from(r.childNodes).forEach(s=>{o(s)})},o=r=>r.nodeType===3?t(r):(n(r),0);o(i)},Cr=i=>{var e=i.querySelectorAll("span.highlight");Array.prototype.forEach.call(e,function(t){var n=t.parentNode;n.replaceChild(t.firstChild,t),n.normalize()})},_r=65,Ar=13,Ji=27,Rn=37,Mr=38,Qi=39,$r=40,Di=8,Pr=46,Xn=9,Lr=typeof navigator>"u"?!1:/Mac/.test(navigator.userAgent),Bt=Lr?"metaKey":"ctrlKey";var xi={options:[],optgroups:[],plugins:[],delimiter:",",splitOn:null,persist:!0,diacritics:!0,create:null,createOnBlur:!1,createFilter:null,highlight:!0,openOnFocus:!0,shouldOpen:null,maxOptions:50,maxItems:null,hideSelected:null,duplicates:!1,addPrecedence:!1,selectOnTab:!1,preload:null,allowEmptyOption:!1,refreshThrottle:300,loadThrottle:300,loadingClass:"loading",dataAttr:null,optgroupField:"optgroup",valueField:"value",labelField:"text",disabledField:"disabled",optgroupLabelField:"label",optgroupValueField:"value",lockOptgroupOrder:!1,sortField:"$order",searchField:["text"],searchConjunction:"and",mode:null,wrapperClass:"ts-wrapper",controlClass:"ts-control",dropdownClass:"ts-dropdown",dropdownContentClass:"ts-dropdown-content",itemClass:"item",optionClass:"option",dropdownParent:null,controlInput:'<input type="text" autocomplete="off" size="1" />',copyClassesToDropdown:!1,placeholder:null,hidePlaceholder:null,shouldLoad:function(i){return i.length>0},render:{}};const st=i=>typeof i>"u"||i===null?null:zt(i),zt=i=>typeof i=="boolean"?i?"1":"0":i+"",Yt=i=>(i+"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;"),Rr=(i,e)=>e>0?setTimeout(i,e):(i.call(null),null),Xr=(i,e)=>{var t;return function(n,o){var r=this;t&&(r.loading=Math.max(r.loading-1,0),clearTimeout(t)),t=setTimeout(function(){t=null,r.loadedSearches[n]=!0,i.call(r,n,o)},e)}},Ci=(i,e,t)=>{var n,o=i.trigger,r={};i.trigger=function(){var s=arguments[0];if(e.indexOf(s)!==-1)r[s]=arguments;else return o.apply(i,arguments)},t.apply(i,[]),i.trigger=o;for(n of e)n in r&&o.apply(i,r[n])},Fr=i=>({start:i.selectionStart||0,length:(i.selectionEnd||0)-(i.selectionStart||0)}),Pe=(i,e=!1)=>{i&&(i.preventDefault(),e&&i.stopPropagation())},Le=(i,e,t,n)=>{i.addEventListener(e,t,n)},Et=(i,e)=>{if(!e||!e[i])return!1;var t=(e.altKey?1:0)+(e.ctrlKey?1:0)+(e.shiftKey?1:0)+(e.metaKey?1:0);return t===1},kn=(i,e)=>{const t=i.getAttribute("id");return t||(i.setAttribute("id",e),e)},_i=i=>i.replace(/[\\"']/g,"\\$&"),wt=(i,e)=>{e&&i.append(e)};function Ai(i,e){var t=Object.assign({},xi,e),n=t.dataAttr,o=t.labelField,r=t.valueField,s=t.disabledField,u=t.optgroupField,h=t.optgroupLabelField,y=t.optgroupValueField,O=i.tagName.toLowerCase(),x=i.getAttribute("placeholder")||i.getAttribute("data-placeholder");if(!x&&!t.allowEmptyOption){let P=i.querySelector('option[value=""]');P&&(x=P.textContent)}var $={placeholder:x,options:[],optgroups:[],items:[],maxItems:null},M=()=>{var P,C=$.options,R={},L=1;let B=0;var H=w=>{var m=Object.assign({},w.dataset),I=n&&m[n];return typeof I=="string"&&I.length&&(m=Object.assign(m,JSON.parse(I))),m},ie=(w,m)=>{var I=st(w.value);if(I!=null&&!(!I&&!t.allowEmptyOption)){if(R.hasOwnProperty(I)){if(m){var p=R[I][u];p?Array.isArray(p)?p.push(m):R[I][u]=[p,m]:R[I][u]=m}}else{var _=H(w);_[o]=_[o]||w.textContent,_[r]=_[r]||I,_[s]=_[s]||w.disabled,_[u]=_[u]||m,_.$option=w,_.$order=_.$order||++B,R[I]=_,C.push(_)}w.selected&&$.items.push(I)}},D=w=>{var m,I;I=H(w),I[h]=I[h]||w.getAttribute("label")||"",I[y]=I[y]||L++,I[s]=I[s]||w.disabled,I.$order=I.$order||++B,$.optgroups.push(I),m=I[y],Nt(w.children,p=>{ie(p,m)})};$.maxItems=i.hasAttribute("multiple")?null:1,Nt(i.children,w=>{P=w.tagName.toLowerCase(),P==="optgroup"?D(w):P==="option"&&ie(w)})},S=()=>{const P=i.getAttribute(n);if(P)$.options=JSON.parse(P),Nt($.options,R=>{$.items.push(R[r])});else{var C=i.value.trim()||"";if(!t.allowEmptyOption&&!C.length)return;const R=C.split(t.delimiter);Nt(R,L=>{const B={};B[o]=L,B[r]=L,$.options.push(B)}),$.items=R}};return O==="select"?M():S(),Object.assign({},xi,$,e)}var Mi=0;class tt extends ar(rr){constructor(e,t){super(),this.control_input=void 0,this.wrapper=void 0,this.dropdown=void 0,this.control=void 0,this.dropdown_content=void 0,this.focus_node=void 0,this.order=0,this.settings=void 0,this.input=void 0,this.tabIndex=void 0,this.is_select_tag=void 0,this.rtl=void 0,this.inputId=void 0,this._destroy=void 0,this.sifter=void 0,this.isOpen=!1,this.isDisabled=!1,this.isReadOnly=!1,this.isRequired=void 0,this.isInvalid=!1,this.isValid=!0,this.isLocked=!1,this.isFocused=!1,this.isInputHidden=!1,this.isSetup=!1,this.ignoreFocus=!1,this.ignoreHover=!1,this.hasOptions=!1,this.currentResults=void 0,this.lastValue="",this.caretPos=0,this.loading=0,this.loadedSearches={},this.activeOption=null,this.activeItems=[],this.optgroups={},this.options={},this.userOptions={},this.items=[],this.refreshTimeout=null,Mi++;var n,o=je(e);if(o.tomselect)throw new Error("Tom Select already initialized on this element");o.tomselect=this;var r=window.getComputedStyle&&window.getComputedStyle(o,null);n=r.getPropertyValue("direction");const s=Ai(o,t);this.settings=s,this.input=o,this.tabIndex=o.tabIndex||0,this.is_select_tag=o.tagName.toLowerCase()==="select",this.rtl=/rtl/i.test(n),this.inputId=kn(o,"tomselect-"+Mi),this.isRequired=o.required,this.sifter=new Or(this.options,{diacritics:s.diacritics}),s.mode=s.mode||(s.maxItems===1?"single":"multi"),typeof s.hideSelected!="boolean"&&(s.hideSelected=s.mode==="multi"),typeof s.hidePlaceholder!="boolean"&&(s.hidePlaceholder=s.mode!=="multi");var u=s.createFilter;typeof u!="function"&&(typeof u=="string"&&(u=new RegExp(u)),u instanceof RegExp?s.createFilter=C=>u.test(C):s.createFilter=C=>this.settings.duplicates||!this.options[C]),this.initializePlugins(s.plugins),this.setupCallbacks(),this.setupTemplates();const h=je("<div>"),y=je("<div>"),O=this._render("dropdown"),x=je('<div role="listbox" tabindex="-1">'),$=this.input.getAttribute("class")||"",M=s.mode;var S;if(Qe(h,s.wrapperClass,$,M),Qe(y,s.controlClass),wt(h,y),Qe(O,s.dropdownClass,M),s.copyClassesToDropdown&&Qe(O,$),Qe(x,s.dropdownContentClass),wt(O,x),je(s.dropdownParent||h).appendChild(O),zi(s.controlInput)){S=je(s.controlInput);var P=["autocorrect","autocapitalize","autocomplete","spellcheck"];et(P,C=>{o.getAttribute(C)&&Ve(S,{[C]:o.getAttribute(C)})}),S.tabIndex=-1,y.appendChild(S),this.focus_node=S}else s.controlInput?(S=je(s.controlInput),this.focus_node=S):(S=je("<input/>"),this.focus_node=y);this.wrapper=h,this.dropdown=O,this.dropdown_content=x,this.control=y,this.control_input=S,this.setup()}setup(){const e=this,t=e.settings,n=e.control_input,o=e.dropdown,r=e.dropdown_content,s=e.wrapper,u=e.control,h=e.input,y=e.focus_node,O={passive:!0},x=e.inputId+"-ts-dropdown";Ve(r,{id:x}),Ve(y,{role:"combobox","aria-haspopup":"listbox","aria-expanded":"false","aria-controls":x});const $=kn(y,e.inputId+"-ts-control"),M="label[for='"+kr(e.inputId)+"']",S=document.querySelector(M),P=e.focus.bind(e);if(S){Le(S,"click",P),Ve(S,{for:$});const L=kn(S,e.inputId+"-ts-label");Ve(y,{"aria-labelledby":L}),Ve(r,{"aria-labelledby":L})}if(s.style.width=h.style.width,e.plugins.names.length){const L="plugin-"+e.plugins.names.join(" plugin-");Qe([s,o],L)}(t.maxItems===null||t.maxItems>1)&&e.is_select_tag&&Ve(h,{multiple:"multiple"}),t.placeholder&&Ve(n,{placeholder:t.placeholder}),!t.splitOn&&t.delimiter&&(t.splitOn=new RegExp("\\s*"+Mt(t.delimiter)+"+\\s*")),t.load&&t.loadThrottle&&(t.load=Xr(t.load,t.loadThrottle)),Le(o,"mousemove",()=>{e.ignoreHover=!1}),Le(o,"mouseenter",L=>{var B=Kt(L.target,"[data-selectable]",o);B&&e.onOptionHover(L,B)},{capture:!0}),Le(o,"click",L=>{const B=Kt(L.target,"[data-selectable]");B&&(e.onOptionSelect(L,B),Pe(L,!0))}),Le(u,"click",L=>{var B=Kt(L.target,"[data-ts-item]",u);if(B&&e.onItemSelect(L,B)){Pe(L,!0);return}n.value==""&&(e.onClick(),Pe(L,!0))}),Le(y,"keydown",L=>e.onKeyDown(L)),Le(n,"keypress",L=>e.onKeyPress(L)),Le(n,"input",L=>e.onInput(L)),Le(y,"blur",L=>e.onBlur(L)),Le(y,"focus",L=>e.onFocus(L)),Le(n,"paste",L=>e.onPaste(L));const C=L=>{const B=L.composedPath()[0];if(!s.contains(B)&&!o.contains(B)){e.isFocused&&e.blur(),e.inputState();return}B==n&&e.isOpen?L.stopPropagation():Pe(L,!0)},R=()=>{e.isOpen&&e.positionDropdown()};Le(document,"mousedown",C),Le(window,"scroll",R,O),Le(window,"resize",R,O),this._destroy=()=>{document.removeEventListener("mousedown",C),window.removeEventListener("scroll",R),window.removeEventListener("resize",R),S&&S.removeEventListener("click",P)},this.revertSettings={innerHTML:h.innerHTML,tabIndex:h.tabIndex},h.tabIndex=-1,h.insertAdjacentElement("afterend",e.wrapper),e.sync(!1),t.items=[],delete t.optgroups,delete t.options,Le(h,"invalid",()=>{e.isValid&&(e.isValid=!1,e.isInvalid=!0,e.refreshState())}),e.updateOriginalInput(),e.refreshItems(),e.close(!1),e.inputState(),e.isSetup=!0,h.disabled?e.disable():h.readOnly?e.setReadOnly(!0):e.enable(),e.on("change",this.onChange),Qe(h,"tomselected","ts-hidden-accessible"),e.trigger("initialize"),t.preload===!0&&e.preload()}setupOptions(e=[],t=[]){this.addOptions(e),et(t,n=>{this.registerOptionGroup(n)})}setupTemplates(){var e=this,t=e.settings.labelField,n=e.settings.optgroupLabelField,o={optgroup:r=>{let s=document.createElement("div");return s.className="optgroup",s.appendChild(r.options),s},optgroup_header:(r,s)=>'<div class="optgroup-header">'+s(r[n])+"</div>",option:(r,s)=>"<div>"+s(r[t])+"</div>",item:(r,s)=>"<div>"+s(r[t])+"</div>",option_create:(r,s)=>'<div class="create">Add <strong>'+s(r.input)+"</strong>&hellip;</div>",no_results:()=>'<div class="no-results">No results found</div>',loading:()=>'<div class="spinner"></div>',not_loading:()=>{},dropdown:()=>"<div></div>"};e.settings.render=Object.assign({},o,e.settings.render)}setupCallbacks(){var e,t,n={initialize:"onInitialize",change:"onChange",item_add:"onItemAdd",item_remove:"onItemRemove",item_select:"onItemSelect",clear:"onClear",option_add:"onOptionAdd",option_remove:"onOptionRemove",option_clear:"onOptionClear",optgroup_add:"onOptionGroupAdd",optgroup_remove:"onOptionGroupRemove",optgroup_clear:"onOptionGroupClear",dropdown_open:"onDropdownOpen",dropdown_close:"onDropdownClose",type:"onType",load:"onLoad",focus:"onFocus",blur:"onBlur"};for(e in n)t=this.settings[n[e]],t&&this.on(e,t)}sync(e=!0){const t=this,n=e?Ai(t.input,{delimiter:t.settings.delimiter}):t.settings;t.setupOptions(n.options,n.optgroups),t.setValue(n.items||[],!0),t.lastQuery=null}onClick(){var e=this;if(e.activeItems.length>0){e.clearActiveItems(),e.focus();return}e.isFocused&&e.isOpen?e.blur():e.focus()}onMouseDown(){}onChange(){On(this.input,"input"),On(this.input,"change")}onPaste(e){var t=this;if(t.isInputHidden||t.isLocked){Pe(e);return}t.settings.splitOn&&setTimeout(()=>{var n=t.inputValue();if(n.match(t.settings.splitOn)){var o=n.trim().split(t.settings.splitOn);et(o,r=>{st(r)&&(this.options[r]?t.addItem(r):t.createItem(r))})}},0)}onKeyPress(e){var t=this;if(t.isLocked){Pe(e);return}var n=String.fromCharCode(e.keyCode||e.which);if(t.settings.create&&t.settings.mode==="multi"&&n===t.settings.delimiter){t.createItem(),Pe(e);return}}onKeyDown(e){var t=this;if(t.ignoreHover=!0,t.isLocked){e.keyCode!==Xn&&Pe(e);return}switch(e.keyCode){case _r:if(Et(Bt,e)&&t.control_input.value==""){Pe(e),t.selectAll();return}break;case Ji:t.isOpen&&(Pe(e,!0),t.close()),t.clearActiveItems();return;case $r:if(!t.isOpen&&t.hasOptions)t.open();else if(t.activeOption){let n=t.getAdjacent(t.activeOption,1);n&&t.setActiveOption(n)}Pe(e);return;case Mr:if(t.activeOption){let n=t.getAdjacent(t.activeOption,-1);n&&t.setActiveOption(n)}Pe(e);return;case Ar:t.canSelect(t.activeOption)?(t.onOptionSelect(e,t.activeOption),Pe(e)):(t.settings.create&&t.createItem()||document.activeElement==t.control_input&&t.isOpen)&&Pe(e);return;case Rn:t.advanceSelection(-1,e);return;case Qi:t.advanceSelection(1,e);return;case Xn:t.settings.selectOnTab&&(t.canSelect(t.activeOption)&&(t.onOptionSelect(e,t.activeOption),Pe(e)),t.settings.create&&t.createItem()&&Pe(e));return;case Di:case Pr:t.deleteSelection(e);return}t.isInputHidden&&!Et(Bt,e)&&Pe(e)}onInput(e){if(this.isLocked)return;const t=this.inputValue();if(this.lastValue!==t){if(this.lastValue=t,t==""){this._onInput();return}this.refreshTimeout&&clearTimeout(this.refreshTimeout),this.refreshTimeout=Rr(()=>{this.refreshTimeout=null,this._onInput()},this.settings.refreshThrottle)}}_onInput(){const e=this.lastValue;this.settings.shouldLoad.call(this,e)&&this.load(e),this.refreshOptions(),this.trigger("type",e)}onOptionHover(e,t){this.ignoreHover||this.setActiveOption(t,!1)}onFocus(e){var t=this,n=t.isFocused;if(t.isDisabled||t.isReadOnly){t.blur(),Pe(e);return}t.ignoreFocus||(t.isFocused=!0,t.settings.preload==="focus"&&t.preload(),n||t.trigger("focus"),t.activeItems.length||(t.inputState(),t.refreshOptions(!!t.settings.openOnFocus)),t.refreshState())}onBlur(e){if(document.hasFocus()!==!1){var t=this;if(t.isFocused){t.isFocused=!1,t.ignoreFocus=!1;var n=()=>{t.close(),t.setActiveItem(),t.setCaret(t.items.length),t.trigger("blur")};t.settings.create&&t.settings.createOnBlur?t.createItem(null,n):n()}}}onOptionSelect(e,t){var n,o=this;t.parentElement&&t.parentElement.matches("[data-disabled]")||(t.classList.contains("create")?o.createItem(null,()=>{o.settings.closeAfterSelect&&o.close()}):(n=t.dataset.value,typeof n<"u"&&(o.lastQuery=null,o.addItem(n),o.settings.closeAfterSelect&&o.close(),!o.settings.hideSelected&&e.type&&/click/.test(e.type)&&o.setActiveOption(t))))}canSelect(e){return!!(this.isOpen&&e&&this.dropdown_content.contains(e))}onItemSelect(e,t){var n=this;return!n.isLocked&&n.settings.mode==="multi"?(Pe(e),n.setActiveItem(t,e),!0):!1}canLoad(e){return!(!this.settings.load||this.loadedSearches.hasOwnProperty(e))}load(e){const t=this;if(!t.canLoad(e))return;Qe(t.wrapper,t.settings.loadingClass),t.loading++;const n=t.loadCallback.bind(t);t.settings.load.call(t,e,n)}loadCallback(e,t){const n=this;n.loading=Math.max(n.loading-1,0),n.lastQuery=null,n.clearActiveOption(),n.setupOptions(e,t),n.refreshOptions(n.isFocused&&!n.isInputHidden),n.loading||pt(n.wrapper,n.settings.loadingClass),n.trigger("load",e,t)}preload(){var e=this.wrapper.classList;e.contains("preloaded")||(e.add("preloaded"),this.load(""))}setTextboxValue(e=""){var t=this.control_input,n=t.value!==e;n&&(t.value=e,On(t,"update"),this.lastValue=e)}getValue(){return this.is_select_tag&&this.input.hasAttribute("multiple")?this.items:this.items.join(this.settings.delimiter)}setValue(e,t){var n=t?[]:["change"];Ci(this,n,()=>{this.clear(t),this.addItems(e,t)})}setMaxItems(e){e===0&&(e=null),this.settings.maxItems=e,this.refreshState()}setActiveItem(e,t){var n=this,o,r,s,u,h,y;if(n.settings.mode!=="single"){if(!e){n.clearActiveItems(),n.isFocused&&n.inputState();return}if(o=t&&t.type.toLowerCase(),o==="click"&&Et("shiftKey",t)&&n.activeItems.length){for(y=n.getLastActive(),s=Array.prototype.indexOf.call(n.control.children,y),u=Array.prototype.indexOf.call(n.control.children,e),s>u&&(h=s,s=u,u=h),r=s;r<=u;r++)e=n.control.children[r],n.activeItems.indexOf(e)===-1&&n.setActiveItemClass(e);Pe(t)}else o==="click"&&Et(Bt,t)||o==="keydown"&&Et("shiftKey",t)?e.classList.contains("active")?n.removeActiveItem(e):n.setActiveItemClass(e):(n.clearActiveItems(),n.setActiveItemClass(e));n.inputState(),n.isFocused||n.focus()}}setActiveItemClass(e){const t=this,n=t.control.querySelector(".last-active");n&&pt(n,"last-active"),Qe(e,"active last-active"),t.trigger("item_select",e),t.activeItems.indexOf(e)==-1&&t.activeItems.push(e)}removeActiveItem(e){var t=this.activeItems.indexOf(e);this.activeItems.splice(t,1),pt(e,"active")}clearActiveItems(){pt(this.activeItems,"active"),this.activeItems=[]}setActiveOption(e,t=!0){e!==this.activeOption&&(this.clearActiveOption(),e&&(this.activeOption=e,Ve(this.focus_node,{"aria-activedescendant":e.getAttribute("id")}),Ve(e,{"aria-selected":"true"}),Qe(e,"active"),t&&this.scrollToOption(e)))}scrollToOption(e,t){if(!e)return;const n=this.dropdown_content,o=n.clientHeight,r=n.scrollTop||0,s=e.offsetHeight,u=e.getBoundingClientRect().top-n.getBoundingClientRect().top+r;u+s>o+r?this.scroll(u-o+s,t):u<r&&this.scroll(u,t)}scroll(e,t){const n=this.dropdown_content;t&&(n.style.scrollBehavior=t),n.scrollTop=e,n.style.scrollBehavior=""}clearActiveOption(){this.activeOption&&(pt(this.activeOption,"active"),Ve(this.activeOption,{"aria-selected":null})),this.activeOption=null,Ve(this.focus_node,{"aria-activedescendant":null})}selectAll(){const e=this;if(e.settings.mode==="single")return;const t=e.controlChildren();t.length&&(e.inputState(),e.close(),e.activeItems=t,et(t,n=>{e.setActiveItemClass(n)}))}inputState(){var e=this;e.control.contains(e.control_input)&&(Ve(e.control_input,{placeholder:e.settings.placeholder}),e.activeItems.length>0||!e.isFocused&&e.settings.hidePlaceholder&&e.items.length>0?(e.setTextboxValue(),e.isInputHidden=!0):(e.settings.hidePlaceholder&&e.items.length>0&&Ve(e.control_input,{placeholder:""}),e.isInputHidden=!1),e.wrapper.classList.toggle("input-hidden",e.isInputHidden))}inputValue(){return this.control_input.value.trim()}focus(){var e=this;e.isDisabled||e.isReadOnly||(e.ignoreFocus=!0,e.control_input.offsetWidth?e.control_input.focus():e.focus_node.focus(),setTimeout(()=>{e.ignoreFocus=!1,e.onFocus()},0))}blur(){this.focus_node.blur(),this.onBlur()}getScoreFunction(e){return this.sifter.getScoreFunction(e,this.getSearchOptions())}getSearchOptions(){var e=this.settings,t=e.sortField;return typeof e.sortField=="string"&&(t=[{field:e.sortField}]),{fields:e.searchField,conjunction:e.searchConjunction,sort:t,nesting:e.nesting}}search(e){var t,n,o=this,r=this.getSearchOptions();if(o.settings.score&&(n=o.settings.score.call(o,e),typeof n!="function"))throw new Error('Tom Select "score" setting must be a function that returns a function');return e!==o.lastQuery?(o.lastQuery=e,t=o.sifter.search(e,Object.assign(r,{score:n})),o.currentResults=t):t=Object.assign({},o.currentResults),o.settings.hideSelected&&(t.items=t.items.filter(s=>{let u=st(s.id);return!(u&&o.items.indexOf(u)!==-1)})),t}refreshOptions(e=!0){var t,n,o,r,s,u,h,y,O,x;const $={},M=[];var S=this,P=S.inputValue();const C=P===S.lastQuery||P==""&&S.lastQuery==null;var R=S.search(P),L=null,B=S.settings.shouldOpen||!1,H=S.dropdown_content;C&&(L=S.activeOption,L&&(O=L.closest("[data-group]"))),r=R.items.length,typeof S.settings.maxOptions=="number"&&(r=Math.min(r,S.settings.maxOptions)),r>0&&(B=!0);const ie=(w,m)=>{let I=$[w];if(I!==void 0){let _=M[I];if(_!==void 0)return[I,_.fragment]}let p=document.createDocumentFragment();return I=M.length,M.push({fragment:p,order:m,optgroup:w}),[I,p]};for(t=0;t<r;t++){let w=R.items[t];if(!w)continue;let m=w.id,I=S.options[m];if(I===void 0)continue;let p=zt(m),_=S.getOption(p,!0);for(S.settings.hideSelected||_.classList.toggle("selected",S.items.includes(p)),s=I[S.settings.optgroupField]||"",u=Array.isArray(s)?s:[s],n=0,o=u&&u.length;n<o;n++){s=u[n];let k=I.$order,ce=S.optgroups[s];ce===void 0?s="":k=ce.$order;const[se,ae]=ie(s,k);n>0&&(_=_.cloneNode(!0),Ve(_,{id:I.$id+"-clone-"+n,"aria-selected":null}),_.classList.add("ts-cloned"),pt(_,"active"),S.activeOption&&S.activeOption.dataset.value==m&&O&&O.dataset.group===s.toString()&&(L=_)),ae.appendChild(_),s!=""&&($[s]=se)}}S.settings.lockOptgroupOrder&&M.sort((w,m)=>w.order-m.order),h=document.createDocumentFragment(),et(M,w=>{let m=w.fragment,I=w.optgroup;if(!m||!m.children.length)return;let p=S.optgroups[I];if(p!==void 0){let _=document.createDocumentFragment(),k=S.render("optgroup_header",p);wt(_,k),wt(_,m);let ce=S.render("optgroup",{group:p,options:_});wt(h,ce)}else wt(h,m)}),H.innerHTML="",wt(H,h),S.settings.highlight&&(Cr(H),R.query.length&&R.tokens.length&&et(R.tokens,w=>{xr(H,w.regex)}));var D=w=>{let m=S.render(w,{input:P});return m&&(B=!0,H.insertBefore(m,H.firstChild)),m};if(S.loading?D("loading"):S.settings.shouldLoad.call(S,P)?R.items.length===0&&D("no_results"):D("not_loading"),y=S.canCreate(P),y&&(x=D("option_create")),S.hasOptions=R.items.length>0||y,B){if(R.items.length>0){if(!L&&S.settings.mode==="single"&&S.items[0]!=null&&(L=S.getOption(S.items[0])),!H.contains(L)){let w=0;x&&!S.settings.addPrecedence&&(w=1),L=S.selectable()[w]}}else x&&(L=x);e&&!S.isOpen&&(S.open(),S.scrollToOption(L,"auto")),S.setActiveOption(L)}else S.clearActiveOption(),e&&S.isOpen&&S.close(!1)}selectable(){return this.dropdown_content.querySelectorAll("[data-selectable]")}addOption(e,t=!1){const n=this;if(Array.isArray(e))return n.addOptions(e,t),!1;const o=st(e[n.settings.valueField]);return o===null||n.options.hasOwnProperty(o)?!1:(e.$order=e.$order||++n.order,e.$id=n.inputId+"-opt-"+e.$order,n.options[o]=e,n.lastQuery=null,t&&(n.userOptions[o]=t,n.trigger("option_add",o,e)),o)}addOptions(e,t=!1){et(e,n=>{this.addOption(n,t)})}registerOption(e){return this.addOption(e)}registerOptionGroup(e){var t=st(e[this.settings.optgroupValueField]);return t===null?!1:(e.$order=e.$order||++this.order,this.optgroups[t]=e,t)}addOptionGroup(e,t){var n;t[this.settings.optgroupValueField]=e,(n=this.registerOptionGroup(t))&&this.trigger("optgroup_add",n,t)}removeOptionGroup(e){this.optgroups.hasOwnProperty(e)&&(delete this.optgroups[e],this.clearCache(),this.trigger("optgroup_remove",e))}clearOptionGroups(){this.optgroups={},this.clearCache(),this.trigger("optgroup_clear")}updateOption(e,t){const n=this;var o,r;const s=st(e),u=st(t[n.settings.valueField]);if(s===null)return;const h=n.options[s];if(h==null)return;if(typeof u!="string")throw new Error("Value must be set in option data");const y=n.getOption(s),O=n.getItem(s);if(t.$order=t.$order||h.$order,delete n.options[s],n.uncacheValue(u),n.options[u]=t,y){if(n.dropdown_content.contains(y)){const x=n._render("option",t);Ln(y,x),n.activeOption===y&&n.setActiveOption(x)}y.remove()}O&&(r=n.items.indexOf(s),r!==-1&&n.items.splice(r,1,u),o=n._render("item",t),O.classList.contains("active")&&Qe(o,"active"),Ln(O,o)),n.lastQuery=null}removeOption(e,t){const n=this;e=zt(e),n.uncacheValue(e),delete n.userOptions[e],delete n.options[e],n.lastQuery=null,n.trigger("option_remove",e),n.removeItem(e,t)}clearOptions(e){const t=(e||this.clearFilter).bind(this);this.loadedSearches={},this.userOptions={},this.clearCache();const n={};et(this.options,(o,r)=>{t(o,r)&&(n[r]=o)}),this.options=this.sifter.items=n,this.lastQuery=null,this.trigger("option_clear")}clearFilter(e,t){return this.items.indexOf(t)>=0}getOption(e,t=!1){const n=st(e);if(n===null)return null;const o=this.options[n];if(o!=null){if(o.$div)return o.$div;if(t)return this._render("option",o)}return null}getAdjacent(e,t,n="option"){var o=this,r;if(!e)return null;n=="item"?r=o.controlChildren():r=o.dropdown_content.querySelectorAll("[data-selectable]");for(let s=0;s<r.length;s++)if(r[s]==e)return t>0?r[s+1]:r[s-1];return null}getItem(e){if(typeof e=="object")return e;var t=st(e);return t!==null?this.control.querySelector(`[data-value="${_i(t)}"]`):null}addItems(e,t){var n=this,o=Array.isArray(e)?e:[e];o=o.filter(s=>n.items.indexOf(s)===-1);const r=o[o.length-1];o.forEach(s=>{n.isPending=s!==r,n.addItem(s,t)})}addItem(e,t){var n=t?[]:["change","dropdown_close"];Ci(this,n,()=>{var o,r;const s=this,u=s.settings.mode,h=st(e);if(!(h&&s.items.indexOf(h)!==-1&&(u==="single"&&s.close(),u==="single"||!s.settings.duplicates))&&!(h===null||!s.options.hasOwnProperty(h))&&(u==="single"&&s.clear(t),!(u==="multi"&&s.isFull()))){if(o=s._render("item",s.options[h]),s.control.contains(o)&&(o=o.cloneNode(!0)),r=s.isFull(),s.items.splice(s.caretPos,0,h),s.insertAtCaret(o),s.isSetup){if(!s.isPending&&s.settings.hideSelected){let y=s.getOption(h),O=s.getAdjacent(y,1);O&&s.setActiveOption(O)}!s.isPending&&!s.settings.closeAfterSelect&&s.refreshOptions(s.isFocused&&u!=="single"),s.settings.closeAfterSelect!=!1&&s.isFull()?s.close():s.isPending||s.positionDropdown(),s.trigger("item_add",h,o),s.isPending||s.updateOriginalInput({silent:t})}(!s.isPending||!r&&s.isFull())&&(s.inputState(),s.refreshState())}})}removeItem(e=null,t){const n=this;if(e=n.getItem(e),!e)return;var o,r;const s=e.dataset.value;o=rn(e),e.remove(),e.classList.contains("active")&&(r=n.activeItems.indexOf(e),n.activeItems.splice(r,1),pt(e,"active")),n.items.splice(o,1),n.lastQuery=null,!n.settings.persist&&n.userOptions.hasOwnProperty(s)&&n.removeOption(s,t),o<n.caretPos&&n.setCaret(n.caretPos-1),n.updateOriginalInput({silent:t}),n.refreshState(),n.positionDropdown(),n.trigger("item_remove",s,e)}createItem(e=null,t=()=>{}){arguments.length===3&&(t=arguments[2]),typeof t!="function"&&(t=()=>{});var n=this,o=n.caretPos,r;if(e=e||n.inputValue(),!n.canCreate(e))return t(),!1;n.lock();var s=!1,u=h=>{if(n.unlock(),!h||typeof h!="object")return t();var y=st(h[n.settings.valueField]);if(typeof y!="string")return t();n.setTextboxValue(),n.addOption(h,!0),n.setCaret(o),n.addItem(y),t(h),s=!0};return typeof n.settings.create=="function"?r=n.settings.create.call(this,e,u):r={[n.settings.labelField]:e,[n.settings.valueField]:e},s||u(r),!0}refreshItems(){var e=this;e.lastQuery=null,e.isSetup&&e.addItems(e.items),e.updateOriginalInput(),e.refreshState()}refreshState(){const e=this;e.refreshValidityState();const t=e.isFull(),n=e.isLocked;e.wrapper.classList.toggle("rtl",e.rtl);const o=e.wrapper.classList;o.toggle("focus",e.isFocused),o.toggle("disabled",e.isDisabled),o.toggle("readonly",e.isReadOnly),o.toggle("required",e.isRequired),o.toggle("invalid",!e.isValid),o.toggle("locked",n),o.toggle("full",t),o.toggle("input-active",e.isFocused&&!e.isInputHidden),o.toggle("dropdown-active",e.isOpen),o.toggle("has-options",Dr(e.options)),o.toggle("has-items",e.items.length>0)}refreshValidityState(){var e=this;e.input.validity&&(e.isValid=e.input.validity.valid,e.isInvalid=!e.isValid)}isFull(){return this.settings.maxItems!==null&&this.items.length>=this.settings.maxItems}updateOriginalInput(e={}){const t=this;var n,o;const r=t.input.querySelector('option[value=""]');if(t.is_select_tag){let h=function(y,O,x){return y||(y=je('<option value="'+Yt(O)+'">'+Yt(x)+"</option>")),y!=r&&t.input.append(y),s.push(y),(y!=r||u>0)&&(y.selected=!0),y};const s=[],u=t.input.querySelectorAll("option:checked").length;t.input.querySelectorAll("option:checked").forEach(y=>{y.selected=!1}),t.items.length==0&&t.settings.mode=="single"?h(r,"",""):t.items.forEach(y=>{if(n=t.options[y],o=n[t.settings.labelField]||"",s.includes(n.$option)){const O=t.input.querySelector(`option[value="${_i(y)}"]:not(:checked)`);h(O,y,o)}else n.$option=h(n.$option,y,o)})}else t.input.value=t.getValue();t.isSetup&&(e.silent||t.trigger("change",t.getValue()))}open(){var e=this;e.isLocked||e.isOpen||e.settings.mode==="multi"&&e.isFull()||(e.isOpen=!0,Ve(e.focus_node,{"aria-expanded":"true"}),e.refreshState(),Ft(e.dropdown,{visibility:"hidden",display:"block"}),e.positionDropdown(),Ft(e.dropdown,{visibility:"visible",display:"block"}),e.focus(),e.trigger("dropdown_open",e.dropdown))}close(e=!0){var t=this,n=t.isOpen;e&&(t.setTextboxValue(),t.settings.mode==="single"&&t.items.length&&t.inputState()),t.isOpen=!1,Ve(t.focus_node,{"aria-expanded":"false"}),Ft(t.dropdown,{display:"none"}),t.settings.hideSelected&&t.clearActiveOption(),t.refreshState(),n&&t.trigger("dropdown_close",t.dropdown)}positionDropdown(){if(this.settings.dropdownParent==="body"){var e=this.control,t=e.getBoundingClientRect(),n=e.offsetHeight+t.top+window.scrollY,o=t.left+window.scrollX;Ft(this.dropdown,{width:t.width+"px",top:n+"px",left:o+"px"})}}clear(e){var t=this;if(t.items.length){var n=t.controlChildren();et(n,o=>{t.removeItem(o,!0)}),t.inputState(),e||t.updateOriginalInput(),t.trigger("clear")}}insertAtCaret(e){const t=this,n=t.caretPos,o=t.control;o.insertBefore(e,o.children[n]||null),t.setCaret(n+1)}deleteSelection(e){var t,n,o,r,s=this;t=e&&e.keyCode===Di?-1:1,n=Fr(s.control_input);const u=[];if(s.activeItems.length)r=ki(s.activeItems,t),o=rn(r),t>0&&o++,et(s.activeItems,h=>u.push(h));else if((s.isFocused||s.settings.mode==="single")&&s.items.length){const h=s.controlChildren();let y;t<0&&n.start===0&&n.length===0?y=h[s.caretPos-1]:t>0&&n.start===s.inputValue().length&&(y=h[s.caretPos]),y!==void 0&&u.push(y)}if(!s.shouldDelete(u,e))return!1;for(Pe(e,!0),typeof o<"u"&&s.setCaret(o);u.length;)s.removeItem(u.pop());return s.inputState(),s.positionDropdown(),s.refreshOptions(!1),!0}shouldDelete(e,t){const n=e.map(o=>o.dataset.value);return!(!n.length||typeof this.settings.onDelete=="function"&&this.settings.onDelete(n,t)===!1)}advanceSelection(e,t){var n,o,r=this;r.rtl&&(e*=-1),!r.inputValue().length&&(Et(Bt,t)||Et("shiftKey",t)?(n=r.getLastActive(e),n?n.classList.contains("active")?o=r.getAdjacent(n,e,"item"):o=n:e>0?o=r.control_input.nextElementSibling:o=r.control_input.previousElementSibling,o&&(o.classList.contains("active")&&r.removeActiveItem(n),r.setActiveItemClass(o))):r.moveCaret(e))}moveCaret(e){}getLastActive(e){let t=this.control.querySelector(".last-active");if(t)return t;var n=this.control.querySelectorAll(".active");if(n)return ki(n,e)}setCaret(e){this.caretPos=this.items.length}controlChildren(){return Array.from(this.control.querySelectorAll("[data-ts-item]"))}lock(){this.setLocked(!0)}unlock(){this.setLocked(!1)}setLocked(e=this.isReadOnly||this.isDisabled){this.isLocked=e,this.refreshState()}disable(){this.setDisabled(!0),this.close()}enable(){this.setDisabled(!1)}setDisabled(e){this.focus_node.tabIndex=e?-1:this.tabIndex,this.isDisabled=e,this.input.disabled=e,this.control_input.disabled=e,this.setLocked()}setReadOnly(e){this.isReadOnly=e,this.input.readOnly=e,this.control_input.readOnly=e,this.setLocked()}destroy(){var e=this,t=e.revertSettings;e.trigger("destroy"),e.off(),e.wrapper.remove(),e.dropdown.remove(),e.input.innerHTML=t.innerHTML,e.input.tabIndex=t.tabIndex,pt(e.input,"tomselected","ts-hidden-accessible"),e._destroy(),delete e.input.tomselect}render(e,t){var n,o;const r=this;if(typeof this.settings.render[e]!="function"||(o=r.settings.render[e].call(this,t,Yt),!o))return null;if(o=je(o),e==="option"||e==="option_create"?t[r.settings.disabledField]?Ve(o,{"aria-disabled":"true"}):Ve(o,{"data-selectable":""}):e==="optgroup"&&(n=t.group[r.settings.optgroupValueField],Ve(o,{"data-group":n}),t.group[r.settings.disabledField]&&Ve(o,{"data-disabled":""})),e==="option"||e==="item"){const s=zt(t[r.settings.valueField]);Ve(o,{"data-value":s}),e==="item"?(Qe(o,r.settings.itemClass),Ve(o,{"data-ts-item":""})):(Qe(o,r.settings.optionClass),Ve(o,{role:"option",id:t.$id}),t.$div=o,r.options[s]=t)}return o}_render(e,t){const n=this.render(e,t);if(n==null)throw"HTMLElement expected";return n}clearCache(){et(this.options,e=>{e.$div&&(e.$div.remove(),delete e.$div)})}uncacheValue(e){const t=this.getOption(e);t&&t.remove()}canCreate(e){return this.settings.create&&e.length>0&&this.settings.createFilter.call(this,e)}hook(e,t,n){var o=this,r=o[t];o[t]=function(){var s,u;return e==="after"&&(s=r.apply(o,arguments)),u=n.apply(o,arguments),e==="instead"?u:(e==="before"&&(s=r.apply(o,arguments)),s)}}}function Br(){Le(this.input,"change",()=>{this.sync()})}function Vr(i){var e=this,t=e.onOptionSelect;e.settings.hideSelected=!1;const n=Object.assign({className:"tomselect-checkbox",checkedClassNames:void 0,uncheckedClassNames:void 0},i);var o=function(u,h){h?(u.checked=!0,n.uncheckedClassNames&&u.classList.remove(...n.uncheckedClassNames),n.checkedClassNames&&u.classList.add(...n.checkedClassNames)):(u.checked=!1,n.checkedClassNames&&u.classList.remove(...n.checkedClassNames),n.uncheckedClassNames&&u.classList.add(...n.uncheckedClassNames))},r=function(u){setTimeout(()=>{var h=u.querySelector("input."+n.className);h instanceof HTMLInputElement&&o(h,u.classList.contains("selected"))},1)};e.hook("after","setupTemplates",()=>{var s=e.settings.render.option;e.settings.render.option=(u,h)=>{var y=je(s.call(e,u,h)),O=document.createElement("input");n.className&&O.classList.add(n.className),O.addEventListener("click",function($){Pe($)}),O.type="checkbox";const x=st(u[e.settings.valueField]);return o(O,!!(x&&e.items.indexOf(x)>-1)),y.prepend(O),y}}),e.on("item_remove",s=>{var u=e.getOption(s);u&&(u.classList.remove("selected"),r(u))}),e.on("item_add",s=>{var u=e.getOption(s);u&&r(u)}),e.hook("instead","onOptionSelect",(s,u)=>{if(u.classList.contains("selected")){u.classList.remove("selected"),e.removeItem(u.dataset.value),e.refreshOptions(),Pe(s,!0);return}t.call(e,s,u),r(u)})}function Hr(i){const e=this,t=Object.assign({className:"clear-button",title:"Clear All",html:n=>`<div class="${n.className}" title="${n.title}">&#10799;</div>`},i);e.on("initialize",()=>{var n=je(t.html(t));n.addEventListener("click",o=>{e.isLocked||(e.clear(),e.settings.mode==="single"&&e.settings.allowEmptyOption&&e.addItem(""),o.preventDefault(),o.stopPropagation())}),e.control.appendChild(n)})}const Ur=(i,e)=>{var t;(t=i.parentNode)==null||t.insertBefore(e,i.nextSibling)},Gr=(i,e)=>{var t;(t=i.parentNode)==null||t.insertBefore(e,i)},jr=(i,e)=>{do{var t;if(e=(t=e)==null?void 0:t.previousElementSibling,i==e)return!0}while(e&&e.previousElementSibling);return!1};function Wr(){var i=this;if(i.settings.mode!=="multi")return;var e=i.lock,t=i.unlock;let n=!0,o;i.hook("after","setupTemplates",()=>{var r=i.settings.render.item;i.settings.render.item=(s,u)=>{const h=je(r.call(i,s,u));Ve(h,{draggable:"true"});const y=P=>{n||Pe(P),P.stopPropagation()},O=P=>{o=h,setTimeout(()=>{h.classList.add("ts-dragging")},0)},x=P=>{P.preventDefault(),h.classList.add("ts-drag-over"),M(h,o)},$=()=>{h.classList.remove("ts-drag-over")},M=(P,C)=>{C!==void 0&&(jr(C,h)?Ur(P,C):Gr(P,C))},S=()=>{var P;document.querySelectorAll(".ts-drag-over").forEach(R=>R.classList.remove("ts-drag-over")),(P=o)==null||P.classList.remove("ts-dragging"),o=void 0;var C=[];i.control.querySelectorAll("[data-value]").forEach(R=>{if(R.dataset.value){let L=R.dataset.value;L&&C.push(L)}}),i.setValue(C)};return Le(h,"mousedown",y),Le(h,"dragstart",O),Le(h,"dragenter",x),Le(h,"dragover",x),Le(h,"dragleave",$),Le(h,"dragend",S),h}}),i.hook("instead","lock",()=>(n=!1,e.call(i))),i.hook("instead","unlock",()=>(n=!0,t.call(i)))}function qr(i){const e=this,t=Object.assign({title:"Untitled",headerClass:"dropdown-header",titleRowClass:"dropdown-header-title",labelClass:"dropdown-header-label",closeClass:"dropdown-header-close",html:n=>'<div class="'+n.headerClass+'"><div class="'+n.titleRowClass+'"><span class="'+n.labelClass+'">'+n.title+'</span><a class="'+n.closeClass+'">&times;</a></div></div>'},i);e.on("initialize",()=>{var n=je(t.html(t)),o=n.querySelector("."+t.closeClass);o&&o.addEventListener("click",r=>{Pe(r,!0),e.close()}),e.dropdown.insertBefore(n,e.dropdown.firstChild)})}function Kr(){var i=this;i.hook("instead","setCaret",e=>{i.settings.mode==="single"||!i.control.contains(i.control_input)?e=i.items.length:(e=Math.max(0,Math.min(i.items.length,e)),e!=i.caretPos&&!i.isPending&&i.controlChildren().forEach((t,n)=>{n<e?i.control_input.insertAdjacentElement("beforebegin",t):i.control.appendChild(t)})),i.caretPos=e}),i.hook("instead","moveCaret",e=>{if(!i.isFocused)return;const t=i.getLastActive(e);if(t){const n=rn(t);i.setCaret(e>0?n+1:n),i.setActiveItem(),pt(t,"last-active")}else i.setCaret(i.caretPos+e)})}function zr(){const i=this;i.settings.shouldOpen=!0,i.hook("before","setup",()=>{i.focus_node=i.control,Qe(i.control_input,"dropdown-input");const e=je('<div class="dropdown-input-wrap">');e.append(i.control_input),i.dropdown.insertBefore(e,i.dropdown.firstChild);const t=je('<input class="items-placeholder" tabindex="-1" />');t.placeholder=i.settings.placeholder||"",i.control.append(t)}),i.on("initialize",()=>{i.control_input.addEventListener("keydown",t=>{switch(t.keyCode){case Ji:i.isOpen&&(Pe(t,!0),i.close()),i.clearActiveItems();return;case Xn:i.focus_node.tabIndex=-1;break}return i.onKeyDown.call(i,t)}),i.on("blur",()=>{i.focus_node.tabIndex=i.isDisabled?-1:i.tabIndex}),i.on("dropdown_open",()=>{i.control_input.focus()});const e=i.onBlur;i.hook("instead","onBlur",t=>{if(!(t&&t.relatedTarget==i.control_input))return e.call(i)}),Le(i.control_input,"blur",()=>i.onBlur()),i.hook("before","close",()=>{i.isOpen&&i.focus_node.focus({preventScroll:!0})})})}function Yr(){var i=this;i.on("initialize",()=>{var e=document.createElement("span"),t=i.control_input;e.style.cssText="position:absolute; top:-99999px; left:-99999px; width:auto; padding:0; white-space:pre; ",i.wrapper.appendChild(e);var n=["letterSpacing","fontSize","fontFamily","fontWeight","textTransform"];for(const r of n)e.style[r]=t.style[r];var o=()=>{e.textContent=t.value,t.style.width=e.clientWidth+"px"};o(),i.on("update item_add item_remove",o),Le(t,"input",o),Le(t,"keyup",o),Le(t,"blur",o),Le(t,"update",o)})}function Zr(){var i=this,e=i.deleteSelection;this.hook("instead","deleteSelection",t=>i.activeItems.length?e.call(i,t):!1)}function Jr(){this.hook("instead","setActiveItem",()=>{}),this.hook("instead","selectAll",()=>{})}function Qr(){var i=this,e=i.onKeyDown;i.hook("instead","onKeyDown",t=>{var n,o,r,s;if(!i.isOpen||!(t.keyCode===Rn||t.keyCode===Qi))return e.call(i,t);i.ignoreHover=!0,s=Kt(i.activeOption,"[data-group]"),n=rn(i.activeOption,"[data-selectable]"),s&&(t.keyCode===Rn?s=s.previousSibling:s=s.nextSibling,s&&(r=s.querySelectorAll("[data-selectable]"),o=r[Math.min(r.length-1,n)],o&&i.setActiveOption(o)))})}function ea(i){const e=Object.assign({label:"&times;",title:"Remove",className:"remove",append:!0},i);var t=this;if(e.append){var n='<a href="javascript:void(0)" class="'+e.className+'" tabindex="-1" title="'+Yt(e.title)+'">'+e.label+"</a>";t.hook("after","setupTemplates",()=>{var o=t.settings.render.item;t.settings.render.item=(r,s)=>{var u=je(o.call(t,r,s)),h=je(n);return u.appendChild(h),Le(h,"mousedown",y=>{Pe(y,!0)}),Le(h,"click",y=>{t.isLocked||(Pe(y,!0),!t.isLocked&&t.shouldDelete([u],y)&&(t.removeItem(u),t.refreshOptions(!1),t.inputState()))}),u}})}}function ta(i){const e=this,t=Object.assign({text:n=>n[e.settings.labelField]},i);e.on("item_remove",function(n){if(e.isFocused&&e.control_input.value.trim()===""){var o=e.options[n];o&&e.setTextboxValue(t.text.call(e,o))}})}function na(){const i=this,e=i.canLoad,t=i.clearActiveOption,n=i.loadCallback;var o={},r,s=!1,u,h=[];if(i.settings.shouldLoadMore||(i.settings.shouldLoadMore=()=>{if(r.clientHeight/(r.scrollHeight-r.scrollTop)>.9)return!0;if(i.activeOption){var $=i.selectable(),M=Array.from($).indexOf(i.activeOption);if(M>=$.length-2)return!0}return!1}),!i.settings.firstUrl)throw"virtual_scroll plugin requires a firstUrl() method";i.settings.sortField=[{field:"$order"},{field:"$score"}];const y=x=>typeof i.settings.maxOptions=="number"&&r.children.length>=i.settings.maxOptions?!1:!!(x in o&&o[x]),O=(x,$)=>i.items.indexOf($)>=0||h.indexOf($)>=0;i.setNextUrl=(x,$)=>{o[x]=$},i.getUrl=x=>{if(x in o){const $=o[x];return o[x]=!1,$}return i.clearPagination(),i.settings.firstUrl.call(i,x)},i.clearPagination=()=>{o={}},i.hook("instead","clearActiveOption",()=>{if(!s)return t.call(i)}),i.hook("instead","canLoad",x=>x in o?y(x):e.call(i,x)),i.hook("instead","loadCallback",(x,$)=>{if(!s)i.clearOptions(O);else if(u){const M=x[0];M!==void 0&&(u.dataset.value=M[i.settings.valueField])}n.call(i,x,$),s=!1}),i.hook("after","refreshOptions",()=>{const x=i.lastValue;var $;y(x)?($=i.render("loading_more",{query:x}),$&&($.setAttribute("data-selectable",""),u=$)):x in o&&!r.querySelector(".no-results")&&($=i.render("no_more_results",{query:x})),$&&(Qe($,i.settings.optionClass),r.append($))}),i.on("initialize",()=>{h=Object.keys(i.options),r=i.dropdown_content,i.settings.render=Object.assign({},{loading_more:()=>'<div class="loading-more-results">Loading more results ... </div>',no_more_results:()=>'<div class="no-more-results">No more results</div>'},i.settings.render),r.addEventListener("scroll",()=>{i.settings.shouldLoadMore.call(i)&&y(i.lastValue)&&(s||(s=!0,i.load.call(i,i.lastValue)))})})}tt.define("change_listener",Br);tt.define("checkbox_options",Vr);tt.define("clear_button",Hr);tt.define("drag_drop",Wr);tt.define("dropdown_header",qr);tt.define("caret_position",Kr);tt.define("dropdown_input",zr);tt.define("input_autogrow",Yr);tt.define("no_backspace_delete",Zr);tt.define("no_active_items",Jr);tt.define("optgroup_columns",Qr);tt.define("remove_button",ea);tt.define("restore_on_backspace",ta);tt.define("virtual_scroll",na);class ia{debouncedLocalChanges;debouncedBroadcastChanges;constructor(){this.debouncedBroadcastChanges=Ii(async e=>{if(!e.data||e.data.length===0)return;const t=e.data,n=g.playerRole==="GM"?t:t.filter(u=>u.metadata[`${c.SPECTREID}/viewers`].includes(g.playerId)),r=g.localGhosts.filter(u=>u.metadata[`${c.SPECTREID}/spectred`]===!0).filter(u=>u.metadata[`${c.SPECTREID}/viewers`].includes(g.playerId));if(!Sn(n,r)){const u=n.map(O=>O.id),h=[],y=g.localGhosts.filter(O=>!u.includes(O.id));for(const O of n){const x=g.localGhosts.find($=>$.id===O.id);x&&jo(O,x)||h.push(O)}h.length>0&&await b.scene.local.addItems(h),y.length>0&&await b.scene.local.deleteItems(y.map(O=>O.id)),g.localGhosts=t}},0),this.debouncedLocalChanges=Ii(async e=>{if(g.playerRole==="GM"){const t=e.filter(n=>n.metadata[`${c.SPECTREID}/spectred`]===!0);if(Sn(g.localGhosts,t))return;g.localGhosts=t,Ei(t)?await b.notification.show("You currently have too many Spectres in the scene. Unable to update.","ERROR"):(await b.scene.setMetadata({[`${c.SPECTREID}/current_spectres`]:t}),await b.broadcast.sendMessage(c.SPECTREBROADCASTID,t))}else{const t=e.filter(s=>s.metadata[`${c.SPECTREID}/spectred`]===!0),o=g.localGhosts.filter(s=>s.metadata[`${c.SPECTREID}/spectred`]===!0).filter(s=>s.metadata[`${c.SPECTREID}/viewers`].includes(g.playerId));if(t.length<o.length){const s=[];for(const u of o)t.includes(u)||s.push(u.id);s.length>0&&await b.broadcast.sendMessage("SPECTREDELETED",s)}if(t.length===0&&o.length===0)return;if(t.length<o.length){g.localGhosts=t;return}Sn(t,o)||(Wo(g.localGhosts,t),await b.broadcast.sendMessage(c.SPECTREBROADCASTID,g.localGhosts))}},0)}SetupLocalSpecterHandlers(){g.sceneReady&&(b.broadcast.onMessage(c.SPECTREBROADCASTID,e=>{this.debouncedBroadcastChanges(e)}),g.playerRole==="GM"&&b.broadcast.onMessage("SPECTREDELETED",async e=>{const t=e.data;if(t.length>0){for(const n of t)document.getElementById(`tr-${n}`).remove();await b.scene.local.deleteItems(t)}}))}async LoadSpectreSceneMetadata(){g.localGhosts=g.sceneMetadata[`${c.SPECTREID}/current_spectres`],g.localGhosts||(g.localGhosts=[]);const e=[];for(const t of g.localGhosts)t.metadata[`${c.SPECTREID}/viewers`].includes(g.playerId)&&g.playerRole!=="GM"&&e.push(t);e.length>0&&await b.scene.local.addItems(e)}UpdateSpectreTargets(){const e=document.querySelectorAll(".tSelects");for(const t of e)if(t&&t.tomselect){const n=t.tomselect,o=[];for(const r of g.party)o.push({value:r.id,text:r.name});n.clearOptions(),n.addOption(o),o.length===0?(n.settings.placeholder="No Players Present",n.inputState()):(n.settings.placeholder="Choose..",n.inputState())}}async SetupSpectreGM(){await b.contextMenu.create({id:`${c.SPECTREID}/context-menu`,icons:[{icon:"/ghost.svg",label:"Spectre",filter:{every:[{key:"type",value:"IMAGE"},{key:["metadata",`${c.SPECTREID}/spectred`],value:void 0,operator:"==",coordinator:"&&"}]}},{icon:"/ghost.svg",label:"Un-Spectre",filter:{every:[{key:"type",value:"IMAGE"},{key:["metadata",`${c.SPECTREID}/spectred`],value:void 0,operator:"!=",coordinator:"&&"}]}}],async onClick(e){if(e.items.every(n=>n.metadata[`${c.SPECTREID}/spectred`]===void 0))if(Ei(g.localGhosts,e.items))await b.notification.show("This would exceed the maximum Spectres. Please remove some before adding more.","INFO");else for(const n of e.items){const o=n;dt.SetupTomSelect(o)}else for(const n of e.items){const o=n;await dt.RemoveGhost(o),o.metadata[`${c.SPECTREID}/spectred`]=void 0;const r=g.localGhosts.findIndex(u=>u.id===o.id);g.localGhosts.splice(r,1),document.getElementById(`tr-${o.id}`)?.remove(),o.metadata[`${c.SPECTREID}/viewers`]=[],await b.scene.items.addItems([o])}}})}async RestoreGhostsGM(){g.localGhosts=g.sceneMetadata[`${c.SPECTREID}/current_spectres`],g.localGhosts||(g.localGhosts=[]),g.localGhosts.length>0&&(await b.scene.local.addItems(g.localGhosts),g.localGhosts.forEach(e=>{this.SetupTomSelect(e)}))}async StoreGhost(e){let t=g.sceneMetadata[`${c.SPECTREID}/current_spectres`];if(!t)t=[e];else{if(t.find(o=>o.id===e.id))return;t.push(e)}await b.scene.setMetadata({[`${c.SPECTREID}/current_spectres`]:t})}async RemoveGhost(e){let t=g.sceneMetadata[`${c.SPECTREID}/current_spectres`];t||(t=[]);const n=t.filter(o=>o.id!==e.id);await b.scene.local.deleteItems([e.id]),await b.scene.setMetadata({[`${c.SPECTREID}/current_spectres`]:n})}async SetupTomSelect(e){const t=e.text?.plainText||e.name;let n=e.metadata[`${c.SPECTREID}/viewers`];e.metadata[`${c.SPECTREID}/spectred`]=!0,n===void 0&&(n=[],e.metadata[`${c.SPECTREID}/viewers`]=[]),await b.scene.items.deleteItems([e.id]),await b.scene.local.addItems([e]),await this.StoreGhost(e),g.localGhosts.push(e);const o=document.getElementById("ghostList"),r=document.createElement("tr");r.id=`tr-${e.id}`,r.className="ghost-table-entry",r.innerHTML=`<td class="token-name">${t}</td>
            <td><select id="select-${e.id}" class="tSelects" multiple autocomplete="off" /></td>
            <td><input type="button" class="mysteryButton" id="deleteGhost-${e.id}" value="Delete"/></td>`,o.appendChild(r);const s=document.getElementById(`select-${e.id}`);for(const O of g.party){const x=document.createElement("option");x.value=O.id,x.text=O.name,s.appendChild(x)}const u={plugins:{remove_button:{title:"Remove this item"}},allowEmptyOption:!0,placeholder:g.party.length==0?"No Players Present":"Choose..",maxItems:null,create:!1,onDelete:async function(O,x){const $=x.currentTarget.parentElement.parentElement.parentElement.parentElement.parentElement.id.slice(3);await b.scene.local.updateItems([$],M=>{const S=M[0].metadata[`${c.SPECTREID}/viewers`],P=S.findIndex(C=>C==O);S.splice(P,1),M[0].metadata[`${c.SPECTREID}/viewers`]=S})},onItemAdd:async function(O,x){const $=x.parentElement.parentElement.parentElement.parentElement.id.slice(3);await b.scene.local.updateItems([$],M=>{const S=M[0].metadata[`${c.SPECTREID}/viewers`];S?(S.push(O),M[0].metadata[`${c.SPECTREID}/viewers`]=S):M[0].metadata[`${c.SPECTREID}/viewers`]=[O]})}},h=new tt(`#select-${e.id}`,u);if(n.length>0)for(const O of n){if(!g.party.find($=>$.id===O)){const $=g.sceneMetadata[`${c.EXTENSIONID}/USER-${O}`],M=[];M.push({value:O,text:$.name}),h.addOption(M)}h.addItem(O,!0)}const y=document.getElementById(`deleteGhost-${e.id}`);y.onclick=async()=>{const O=g.localGhosts.findIndex(x=>x.id===e.id);g.localGhosts.splice(O,1),r.remove(),await b.scene.local.updateItems([e.id],x=>{x[0]&&(x[0].metadata[`${c.SPECTREID}/viewers`]=[])}),await this.RemoveGhost(e)}}ClearGhostList(){const e=document.getElementById("ghostList");e&&(e.innerHTML="")}}const dt=new ia;async function Fn(){await b.scene.items.deleteItems(g.sceneItems.filter(At).map(e=>e.id)),en(g.sceneMetadata[`${c.EXTENSIONID}/fowEnabled`]==!0);let i;if(g.sceneItems.filter(La).length==0){const e=g.sceneItems.filter(n=>n.layer=="MAP"&&Jt(n)),t=e.map(n=>n.image.width*n.image.height/Math.pow(n.grid.dpi,2));i=e[t.indexOf(Math.max(...t))]}if(g.sceneMetadata[`${c.EXTENSIONID}/autodetectEnabled`]===void 0&&(g.playerRole==="GM"&&(Z.autodetectCheckbox.checked=!0),await b.scene.setMetadata({[`${c.EXTENSIONID}/autodetectEnabled`]:!0})),g.sceneMetadata[`${c.EXTENSIONID}/sceneId`]===void 0)await b.scene.setMetadata({[`${c.EXTENSIONID}/sceneId`]:crypto.randomUUID()});else try{const e=g.sceneMetadata[`${c.EXTENSIONID}/sceneId`],t=localStorage.getItem(`${c.EXTENSIONID}/fogCache/${g.playerId}/${e}`);if(t!==null&&g.sceneMetadata[`${c.EXTENSIONID}/persistenceEnabled`]===!0){const n=JSON.parse(t),o=[];for(let r=0;r<n.length;r++){const s=gt().commands(n[r].commands).fillRule("evenodd").locked(!0).visible(!1).fillColor("#000000").strokeColor("#000000").layer("FOG").name("Fog of War").metadata({[`${c.EXTENSIONID}/isVisionFog`]:!0,[`${c.EXTENSIONID}/digest`]:n[r].digest}).build();s.zIndex=3,o.push(s)}await b.scene.local.addItems(o)}}catch{}g.playerRole==="GM"?(await dt.RestoreGhostsGM(),await Z.UpdateUI(),Z.mapSubmit.onclick=async()=>{await b.scene.items.updateItems([c.GRIDID],e=>{for(const t of e){const n=t;n.width=g.gridDpi*+Z.mapWidth.value,n.height=g.gridDpi*+Z.mapHeight.value,n.scale={x:1,y:1}}})},i!==void 0&&await b.scene.items.updateItems([i],e=>{e[0].metadata[`${c.EXTENSIONID}/isBackgroundImage`]=!0})):await dt.LoadSpectreSceneMetadata(),g.snap=!0,g.sceneInitialized=!0}var eo={exports:{}};const oa={},ra=Object.freeze(Object.defineProperty({__proto__:null,default:oa},Symbol.toStringTag,{value:"Module"})),Dn=Vo(ra);(function(i,e){var t=(()=>{var n=typeof document<"u"&&document.currentScript?document.currentScript.src:void 0;return typeof __filename<"u"&&(n=n||__filename),function(o){o=o||{};var r;r||(r=typeof o<"u"?o:{});var s=Object.assign,u,h;r.ready=new Promise(function(l,a){u=l,h=a}),function(l){var a={};l.loadCmdsTypedArray=function(U){for(var K=0,Q=0;Q<U.length;Q++)K+=U[Q].length;if(a[K])var ee=a[K];else ee=new Float32Array(K),a[K]=ee;var le=0;for(Q=0;Q<U.length;Q++)for(var _e=0;_e<U[Q].length;_e++){var Re=U[Q][_e];typeof Re=="string"&&(Re=l.SkBits2FloatUnsigned(parseInt(Re))),ee[le]=Re,le++}return U=l._malloc(ee.length*ee.BYTES_PER_ELEMENT),l.HEAPF32.set(ee,U/ee.BYTES_PER_ELEMENT),[U,K]},l.FromCmds=function(U){U=l.loadCmdsTypedArray(U);var K=l._FromCmds(U[0],U[1]);return l._free(U[0]),K};var f,v,A,F,q;l.cubicYFromX=function(U,K,Q,ee,le){return f&&v===U&&A===K&&F===Q&&q===ee||(f&&f.delete(),f=new l._SkCubicMap([U,K],[Q,ee]),v=U,A=K,F=Q,q=ee),f.computeYFromX(le)},l.cubicPtFromT=function(U,K,Q,ee,le){return f&&v===U&&A===K&&F===Q&&q===ee||(f&&f.delete(),f=new l._SkCubicMap([U,K],[Q,ee]),v=U,A=K,F=Q,q=ee),f.computePtFromT(le)}}(r),function(l){l.onRuntimeInitialized=function(){l.SkPath.prototype.addPath=function(){var a=arguments[0];if(arguments.length===1)this._addPath(a,1,0,0,0,1,0,0,0,1);else if(arguments.length===2){var f=arguments[1];this._addPath(a,f.a,f.c,f.e,f.b,f.d,f.f,0,0,1)}else if(arguments.length===7)f=arguments,this._addPath(a,f[1],f[3],f[5],f[2],f[4],f[6],0,0,1);else if(arguments.length===10)f=arguments,this._addPath(a,f[1],f[2],f[3],f[4],f[5],f[6],f[7],f[8],f[9]);else return console.Ma("addPath expected to take 1, 2, 7, or 10 args. Got "+arguments.length),null;return this},l.SkPath.prototype.arc=function(a,f,v,A,F,q){return this._arc(a,f,v,A,F,!!q),this},l.SkPath.prototype.arcTo=function(a,f,v,A,F){return this._arcTo(a,f,v,A,F),this},l.SkPath.prototype.bezierCurveTo=function(a,f,v,A,F,q){return this._cubicTo(a,f,v,A,F,q),this},l.SkPath.prototype.close=function(){return this._close(),this},l.SkPath.prototype.closePath=function(){return this._close(),this},l.SkPath.prototype.conicTo=function(a,f,v,A,F){return this._conicTo(a,f,v,A,F),this},l.SkPath.prototype.cubicTo=function(a,f,v,A,F,q){return this._cubicTo(a,f,v,A,F,q),this},l.SkPath.prototype.dash=function(a,f,v){return this._dash(a,f,v)?this:null},l.SkPath.prototype.ellipse=function(a,f,v,A,F,q,U,K){return this._ellipse(a,f,v,A,F,q,U,!!K),this},l.SkPath.prototype.lineTo=function(a,f){return this._lineTo(a,f),this},l.SkPath.prototype.moveTo=function(a,f){return this._moveTo(a,f),this},l.SkPath.prototype.op=function(a,f){return this._op(a,f)?this:null},l.SkPath.prototype.quadraticCurveTo=function(a,f,v,A){return this._quadTo(a,f,v,A),this},l.SkPath.prototype.quadTo=function(a,f,v,A){return this._quadTo(a,f,v,A),this},l.SkPath.prototype.rect=function(a,f,v,A){return this._rect(a,f,v,A),this},l.SkPath.prototype.simplify=function(){return this._simplify()?this:null},l.SkPath.prototype.stroke=function(a){return a=a||{},a.width=a.width||1,a.miter_limit=a.miter_limit||4,a.cap=a.cap||l.StrokeCap.BUTT,a.join=a.join||l.StrokeJoin.MITER,this._stroke(a)?this:null},l.SkPath.prototype.transform=function(){if(arguments.length===1)this._transform(arguments[0]);else if(arguments.length===9){var a=arguments;this._transform(a[0],a[1],a[2],a[3],a[4],a[5],a[6],a[7],a[8])}else return console.Ma("transform expected to take 1 or 9 arguments. Got "+arguments.length),null;return this},l.SkPath.prototype.trim=function(a,f,v){return this._trim(a,f,!!v)?this:null}}}(r);var y=s({},r),O=typeof window=="object",x=typeof importScripts=="function",$="",M,S,P,C,R,L;typeof process=="object"&&typeof process.versions=="object"&&typeof process.versions.node=="string"?($=x?Dn.dirname($)+"/":__dirname+"/",L=()=>{R||(C=Dn,R=Dn)},M=function(l,a){return L(),l=R.normalize(l),C.readFileSync(l,a?null:"utf8")},P=l=>(l=M(l,!0),l.buffer||(l=new Uint8Array(l)),l),S=(l,a,f)=>{L(),l=R.normalize(l),C.readFile(l,function(v,A){v?f(v):a(A.buffer)})},1<process.argv.length&&process.argv[1].replace(/\\/g,"/"),process.argv.slice(2),process.on("uncaughtException",function(l){throw l}),process.on("unhandledRejection",function(l){throw l}),r.inspect=function(){return"[Emscripten Module object]"}):(O||x)&&(x?$=self.location.href:typeof document<"u"&&document.currentScript&&($=document.currentScript.src),n&&($=n),$.indexOf("blob:")!==0?$=$.substr(0,$.replace(/[?#].*/,"").lastIndexOf("/")+1):$="",M=l=>{var a=new XMLHttpRequest;return a.open("GET",l,!1),a.send(null),a.responseText},x&&(P=l=>{var a=new XMLHttpRequest;return a.open("GET",l,!1),a.responseType="arraybuffer",a.send(null),new Uint8Array(a.response)}),S=(l,a,f)=>{var v=new XMLHttpRequest;v.open("GET",l,!0),v.responseType="arraybuffer",v.onload=()=>{v.status==200||v.status==0&&v.response?a(v.response):f()},v.onerror=f,v.send(null)});var B=r.print||console.log.bind(console),H=r.printErr||console.warn.bind(console);s(r,y),y=null;var ie;r.wasmBinary&&(ie=r.wasmBinary),r.noExitRuntime,typeof WebAssembly!="object"&&he("no native wasm support detected");var D,w=!1,m=typeof TextDecoder<"u"?new TextDecoder("utf8"):void 0;function I(l,a,f){var v=a+f;for(f=a;l[f]&&!(f>=v);)++f;if(16<f-a&&l.subarray&&m)return m.decode(l.subarray(a,f));for(v="";a<f;){var A=l[a++];if(A&128){var F=l[a++]&63;if((A&224)==192)v+=String.fromCharCode((A&31)<<6|F);else{var q=l[a++]&63;A=(A&240)==224?(A&15)<<12|F<<6|q:(A&7)<<18|F<<12|q<<6|l[a++]&63,65536>A?v+=String.fromCharCode(A):(A-=65536,v+=String.fromCharCode(55296|A>>10,56320|A&1023))}}else v+=String.fromCharCode(A)}return v}function p(l,a,f){var v=Y;if(0<f){f=a+f-1;for(var A=0;A<l.length;++A){var F=l.charCodeAt(A);if(55296<=F&&57343>=F){var q=l.charCodeAt(++A);F=65536+((F&1023)<<10)|q&1023}if(127>=F){if(a>=f)break;v[a++]=F}else{if(2047>=F){if(a+1>=f)break;v[a++]=192|F>>6}else{if(65535>=F){if(a+2>=f)break;v[a++]=224|F>>12}else{if(a+3>=f)break;v[a++]=240|F>>18,v[a++]=128|F>>12&63}v[a++]=128|F>>6&63}v[a++]=128|F&63}}v[a]=0}}var _=typeof TextDecoder<"u"?new TextDecoder("utf-16le"):void 0;function k(l,a){for(var f=l>>1,v=f+a/2;!(f>=v)&&Ie[f];)++f;if(f<<=1,32<f-l&&_)return _.decode(Y.subarray(l,f));for(f="",v=0;!(v>=a/2);++v){var A=re[l+2*v>>1];if(A==0)break;f+=String.fromCharCode(A)}return f}function ce(l,a,f){if(f===void 0&&(f=2147483647),2>f)return 0;f-=2;var v=a;f=f<2*l.length?f/2:l.length;for(var A=0;A<f;++A)re[a>>1]=l.charCodeAt(A),a+=2;return re[a>>1]=0,a-v}function se(l){return 2*l.length}function ae(l,a){for(var f=0,v="";!(f>=a/4);){var A=ge[l+4*f>>2];if(A==0)break;++f,65536<=A?(A-=65536,v+=String.fromCharCode(55296|A>>10,56320|A&1023)):v+=String.fromCharCode(A)}return v}function J(l,a,f){if(f===void 0&&(f=2147483647),4>f)return 0;var v=a;f=v+f-4;for(var A=0;A<l.length;++A){var F=l.charCodeAt(A);if(55296<=F&&57343>=F){var q=l.charCodeAt(++A);F=65536+((F&1023)<<10)|q&1023}if(ge[a>>2]=F,a+=4,a+4>f)break}return ge[a>>2]=0,a-v}function Se(l){for(var a=0,f=0;f<l.length;++f){var v=l.charCodeAt(f);55296<=v&&57343>=v&&++f,a+=4}return a}var De,Te,Y,re,Ie,ge,ue,de,ye;function we(){var l=D.buffer;De=l,r.HEAP8=Te=new Int8Array(l),r.HEAP16=re=new Int16Array(l),r.HEAP32=ge=new Int32Array(l),r.HEAPU8=Y=new Uint8Array(l),r.HEAPU16=Ie=new Uint16Array(l),r.HEAPU32=ue=new Uint32Array(l),r.HEAPF32=de=new Float32Array(l),r.HEAPF64=ye=new Float64Array(l)}var W,d=[],E=[],N=[];function j(){var l=r.preRun.shift();d.unshift(l)}var X=0,z=null;r.preloadedImages={},r.preloadedAudios={};function he(l){throw r.onAbort&&r.onAbort(l),l="Aborted("+l+")",H(l),w=!0,l=new WebAssembly.RuntimeError(l+". Build with -s ASSERTIONS=1 for more info."),h(l),l}function xe(){return Ee.startsWith("data:application/octet-stream;base64,")}var Ee;if(Ee="pathkit.wasm",!xe()){var He=Ee;Ee=r.locateFile?r.locateFile(He,$):$+He}function Fe(){var l=Ee;try{if(l==Ee&&ie)return new Uint8Array(ie);if(P)return P(l);throw"both async and sync fetching of the wasm failed"}catch(a){he(a)}}function Be(){if(!ie&&(O||x)){if(typeof fetch=="function"&&!Ee.startsWith("file://"))return fetch(Ee,{credentials:"same-origin"}).then(function(l){if(!l.ok)throw"failed to load wasm binary file at '"+Ee+"'";return l.arrayBuffer()}).catch(function(){return Fe()});if(S)return new Promise(function(l,a){S(Ee,function(f){l(new Uint8Array(f))},a)})}return Promise.resolve().then(function(){return Fe()})}function Me(l){for(;0<l.length;){var a=l.shift();if(typeof a=="function")a(r);else{var f=a.Wa;typeof f=="number"?a.xa===void 0?W.get(f)():W.get(f)(a.xa):f(a.xa===void 0?null:a.xa)}}}var ve={};function Oe(l){for(;l.length;){var a=l.pop();l.pop()(a)}}function qe(l){return this.fromWireType(ue[l>>2])}var te={},me={},T={};function V(l){if(l===void 0)return"_unknown";l=l.replace(/[^a-zA-Z0-9_]/g,"$");var a=l.charCodeAt(0);return 48<=a&&57>=a?"_"+l:l}function G(l,a){return l=V(l),function(){return a.apply(this,arguments)}}function ne(l){var a=Error,f=G(l,function(v){this.name=l,this.message=v,v=Error(v).stack,v!==void 0&&(this.stack=this.toString()+`
`+v.replace(/^Error(:[^\n]*)?\n/,""))});return f.prototype=Object.create(a.prototype),f.prototype.constructor=f,f.prototype.toString=function(){return this.message===void 0?this.name:this.name+": "+this.message},f}var oe=void 0;function fe(l){throw new oe(l)}function pe(l,a,f){function v(U){U=f(U),U.length!==l.length&&fe("Mismatched type converter count");for(var K=0;K<l.length;++K)ut(l[K],U[K])}l.forEach(function(U){T[U]=a});var A=Array(a.length),F=[],q=0;a.forEach(function(U,K){me.hasOwnProperty(U)?A[K]=me[U]:(F.push(U),te.hasOwnProperty(U)||(te[U]=[]),te[U].push(function(){A[K]=me[U],++q,q===F.length&&v(A)}))}),F.length===0&&v(A)}var $e={};function be(l){switch(l){case 1:return 0;case 2:return 1;case 4:return 2;case 8:return 3;default:throw new TypeError("Unknown type size: "+l)}}var Ue=void 0;function Ce(l){for(var a="";Y[l];)a+=Ue[Y[l++]];return a}var Ge=void 0;function ke(l){throw new Ge(l)}function ut(l,a,f={}){if(!("argPackAdvance"in a))throw new TypeError("registerType registeredInstance requires argPackAdvance");var v=a.name;if(l||ke('type "'+v+'" must have a positive integer typeid pointer'),me.hasOwnProperty(l)){if(f.Qa)return;ke("Cannot register type '"+v+"' twice")}me[l]=a,delete T[l],te.hasOwnProperty(l)&&(a=te[l],delete te[l],a.forEach(function(A){A()}))}function sn(l){ke(l.ea.ha.fa.name+" instance already deleted")}var ln=!1;function Qn(){}function ei(l){--l.count.value,l.count.value===0&&(l.ka?l.ma.la(l.ka):l.ha.fa.la(l.ga))}function kt(l){return typeof FinalizationGroup>"u"?(kt=a=>a,l):(ln=new FinalizationGroup(function(a){for(var f=a.next();!f.done;f=a.next())f=f.value,f.ga?ei(f):console.warn("object already deleted: "+f.ga)}),kt=a=>(ln.register(a,a.ea,a.ea),a),Qn=a=>{ln.unregister(a.ea)},kt(l))}var Dt=void 0,xt=[];function cn(){for(;xt.length;){var l=xt.pop();l.ea.pa=!1,l.delete()}}function mt(){}var ti={};function ni(l,a,f){if(l[a].ia===void 0){var v=l[a];l[a]=function(){return l[a].ia.hasOwnProperty(arguments.length)||ke("Function '"+f+"' called with an invalid number of arguments ("+arguments.length+") - expects one of ("+l[a].ia+")!"),l[a].ia[arguments.length].apply(this,arguments)},l[a].ia=[],l[a].ia[v.ua]=v}}function un(l,a,f){r.hasOwnProperty(l)?((f===void 0||r[l].ia!==void 0&&r[l].ia[f]!==void 0)&&ke("Cannot register public name '"+l+"' twice"),ni(r,l,l),r.hasOwnProperty(f)&&ke("Cannot register multiple overloads of a function with the same number of arguments ("+f+")!"),r[l].ia[f]=a):(r[l]=a,f!==void 0&&(r[l].Xa=f))}function So(l,a,f,v,A,F,q,U){this.name=l,this.constructor=a,this.qa=f,this.la=v,this.na=A,this.Oa=F,this.ta=q,this.La=U,this.Ta=[]}function dn(l,a,f){for(;a!==f;)a.ta||ke("Expected null or instance of "+f.name+", got an instance of "+a.name),l=a.ta(l),a=a.na;return l}function To(l,a){return a===null?(this.Ba&&ke("null is not a valid "+this.name),0):(a.ea||ke('Cannot pass "'+mn(a)+'" as a '+this.name),a.ea.ga||ke("Cannot pass deleted object as a pointer of type "+this.name),dn(a.ea.ga,a.ea.ha.fa,this.fa))}function bo(l,a){if(a===null){if(this.Ba&&ke("null is not a valid "+this.name),this.wa){var f=this.sa();return l!==null&&l.push(this.la,f),f}return 0}if(a.ea||ke('Cannot pass "'+mn(a)+'" as a '+this.name),a.ea.ga||ke("Cannot pass deleted object as a pointer of type "+this.name),!this.va&&a.ea.ha.va&&ke("Cannot convert argument of type "+(a.ea.ma?a.ea.ma.name:a.ea.ha.name)+" to parameter type "+this.name),f=dn(a.ea.ga,a.ea.ha.fa,this.fa),this.wa)switch(a.ea.ka===void 0&&ke("Passing raw pointer to smart pointer is illegal"),this.Va){case 0:a.ea.ma===this?f=a.ea.ka:ke("Cannot convert argument of type "+(a.ea.ma?a.ea.ma.name:a.ea.ha.name)+" to parameter type "+this.name);break;case 1:f=a.ea.ka;break;case 2:if(a.ea.ma===this)f=a.ea.ka;else{var v=a.clone();f=this.Ua(f,yt(function(){v.delete()})),l!==null&&l.push(this.la,f)}break;default:ke("Unsupporting sharing policy")}return f}function No(l,a){return a===null?(this.Ba&&ke("null is not a valid "+this.name),0):(a.ea||ke('Cannot pass "'+mn(a)+'" as a '+this.name),a.ea.ga||ke("Cannot pass deleted object as a pointer of type "+this.name),a.ea.ha.va&&ke("Cannot convert argument of type "+a.ea.ha.name+" to parameter type "+this.name),dn(a.ea.ga,a.ea.ha.fa,this.fa))}function ii(l,a,f){return a===f?l:f.na===void 0?null:(l=ii(l,a,f.na),l===null?null:f.La(l))}var Ct={};function Oo(l,a){for(a===void 0&&ke("ptr should not be undefined");l.na;)a=l.ta(a),l=l.na;return Ct[a]}function $t(l,a){return a.ha&&a.ga||fe("makeClassHandle requires ptr and ptrType"),!!a.ma!=!!a.ka&&fe("Both smartPtrType and smartPtr must be specified"),a.count={value:1},kt(Object.create(l,{ea:{value:a}}))}function ft(l,a,f,v){this.name=l,this.fa=a,this.Ba=f,this.va=v,this.wa=!1,this.la=this.Ua=this.sa=this.Ia=this.Va=this.Sa=void 0,a.na!==void 0?this.toWireType=bo:(this.toWireType=v?To:No,this.ja=null)}function oi(l,a,f){r.hasOwnProperty(l)||fe("Replacing nonexistant public symbol"),r[l].ia!==void 0&&f!==void 0?r[l].ia[f]=a:(r[l]=a,r[l].ua=f)}function ko(l,a){var f=[];return function(){f.length=arguments.length;for(var v=0;v<arguments.length;v++)f[v]=arguments[v];return l.includes("j")?(v=r["dynCall_"+l],v=f&&f.length?v.apply(null,[a].concat(f)):v.call(null,a)):v=W.get(a).apply(null,f),v}}function Ye(l,a){l=Ce(l);var f=l.includes("j")?ko(l,a):W.get(a);return typeof f!="function"&&ke("unknown function pointer with signature "+l+": "+a),f}var ri=void 0;function ai(l){l=fi(l);var a=Ce(l);return ht(l),a}function Pt(l,a){function f(F){A[F]||me[F]||(T[F]?T[F].forEach(f):(v.push(F),A[F]=!0))}var v=[],A={};throw a.forEach(f),new ri(l+": "+v.map(ai).join([", "]))}function fn(l,a){for(var f=[],v=0;v<l;v++)f.push(ge[(a>>2)+v]);return f}function hn(l,a,f,v,A){var F=a.length;2>F&&ke("argTypes array size mismatch! Must at least get return value and 'this' types!");var q=a[1]!==null&&f!==null,U=!1;for(f=1;f<a.length;++f)if(a[f]!==null&&a[f].ja===void 0){U=!0;break}var K=a[0].name!=="void",Q=F-2,ee=Array(Q),le=[],_e=[];return function(){if(arguments.length!==Q&&ke("function "+l+" called with "+arguments.length+" arguments, expected "+Q+" args!"),_e.length=0,le.length=q?2:1,le[0]=A,q){var Re=a[1].toWireType(_e,this);le[1]=Re}for(var Ae=0;Ae<Q;++Ae)ee[Ae]=a[Ae+2].toWireType(_e,arguments[Ae]),le.push(ee[Ae]);if(Ae=v.apply(null,le),U)Oe(_e);else for(var Ze=q?1:2;Ze<a.length;Ze++){var Je=Ze===1?Re:ee[Ze-2];a[Ze].ja!==null&&a[Ze].ja(Je)}return Re=K?a[0].fromWireType(Ae):void 0,Re}}var pn=[],lt=[{},{value:void 0},{value:null},{value:!0},{value:!1}];function si(l){4<l&&--lt[l].Ca===0&&(lt[l]=void 0,pn.push(l))}function gn(l){return l||ke("Cannot use deleted val. handle = "+l),lt[l].value}function yt(l){switch(l){case void 0:return 1;case null:return 2;case!0:return 3;case!1:return 4;default:var a=pn.length?pn.pop():lt.length;return lt[a]={Ca:1,value:l},a}}function Do(l,a,f){switch(a){case 0:return function(v){return this.fromWireType((f?Te:Y)[v])};case 1:return function(v){return this.fromWireType((f?re:Ie)[v>>1])};case 2:return function(v){return this.fromWireType((f?ge:ue)[v>>2])};default:throw new TypeError("Unknown integer type: "+l)}}function Lt(l,a){var f=me[l];return f===void 0&&ke(a+" has unknown type "+ai(l)),f}function mn(l){if(l===null)return"null";var a=typeof l;return a==="object"||a==="array"||a==="function"?l.toString():""+l}function xo(l,a){switch(a){case 2:return function(f){return this.fromWireType(de[f>>2])};case 3:return function(f){return this.fromWireType(ye[f>>3])};default:throw new TypeError("Unknown float type: "+l)}}function Co(l,a,f){switch(a){case 0:return f?function(v){return Te[v]}:function(v){return Y[v]};case 1:return f?function(v){return re[v>>1]}:function(v){return Ie[v>>1]};case 2:return f?function(v){return ge[v>>2]}:function(v){return ue[v>>2]};default:throw new TypeError("Unknown integer type: "+l)}}var _o={};function yn(l){var a=_o[l];return a===void 0?Ce(l):a}var vn=[];function li(){function l(a){a.$$$embind_global$$$=a;var f=typeof $$$embind_global$$$=="object"&&a.$$$embind_global$$$===a;return f||delete a.$$$embind_global$$$,f}if(typeof globalThis=="object")return globalThis;if(typeof $$$embind_global$$$=="object"||(typeof wn=="object"&&l(wn)?$$$embind_global$$$=wn:typeof self=="object"&&l(self)&&($$$embind_global$$$=self),typeof $$$embind_global$$$=="object"))return $$$embind_global$$$;throw Error("unable to get global object.")}function Ao(l){var a=vn.length;return vn.push(l),a}function Mo(l,a){for(var f=Array(l),v=0;v<l;++v)f[v]=Lt(ge[(a>>2)+v],"parameter "+v);return f}var ci=[];function $o(l){var a=Array(l+1);return function(f,v,A){a[0]=f;for(var F=0;F<l;++F){var q=Lt(ge[(v>>2)+F],"parameter "+F);a[F+1]=q.readValueFromPointer(A),A+=q.argPackAdvance}return f=new(f.bind.apply(f,a)),yt(f)}}var ui={},Po=[null,[],[]];oe=r.InternalError=ne("InternalError");for(var di=Array(256),Rt=0;256>Rt;++Rt)di[Rt]=String.fromCharCode(Rt);Ue=di,Ge=r.BindingError=ne("BindingError"),mt.prototype.isAliasOf=function(l){if(!(this instanceof mt&&l instanceof mt))return!1;var a=this.ea.ha.fa,f=this.ea.ga,v=l.ea.ha.fa;for(l=l.ea.ga;a.na;)f=a.ta(f),a=a.na;for(;v.na;)l=v.ta(l),v=v.na;return a===v&&f===l},mt.prototype.clone=function(){if(this.ea.ga||sn(this),this.ea.ra)return this.ea.count.value+=1,this;var l=kt,a=Object,f=a.create,v=Object.getPrototypeOf(this),A=this.ea;return l=l(f.call(a,v,{ea:{value:{count:A.count,pa:A.pa,ra:A.ra,ga:A.ga,ha:A.ha,ka:A.ka,ma:A.ma}}})),l.ea.count.value+=1,l.ea.pa=!1,l},mt.prototype.delete=function(){this.ea.ga||sn(this),this.ea.pa&&!this.ea.ra&&ke("Object already scheduled for deletion"),Qn(this),ei(this.ea),this.ea.ra||(this.ea.ka=void 0,this.ea.ga=void 0)},mt.prototype.isDeleted=function(){return!this.ea.ga},mt.prototype.deleteLater=function(){return this.ea.ga||sn(this),this.ea.pa&&!this.ea.ra&&ke("Object already scheduled for deletion"),xt.push(this),xt.length===1&&Dt&&Dt(cn),this.ea.pa=!0,this},ft.prototype.Pa=function(l){return this.Ia&&(l=this.Ia(l)),l},ft.prototype.Ga=function(l){this.la&&this.la(l)},ft.prototype.argPackAdvance=8,ft.prototype.readValueFromPointer=qe,ft.prototype.deleteObject=function(l){l!==null&&l.delete()},ft.prototype.fromWireType=function(l){function a(){return this.wa?$t(this.fa.qa,{ha:this.Sa,ga:f,ma:this,ka:l}):$t(this.fa.qa,{ha:this,ga:l})}var f=this.Pa(l);if(!f)return this.Ga(l),null;var v=Oo(this.fa,f);if(v!==void 0)return v.ea.count.value===0?(v.ea.ga=f,v.ea.ka=l,v.clone()):(v=v.clone(),this.Ga(l),v);if(v=this.fa.Oa(f),v=ti[v],!v)return a.call(this);v=this.va?v.Ja:v.pointerType;var A=ii(f,this.fa,v.fa);return A===null?a.call(this):this.wa?$t(v.fa.qa,{ha:v,ga:A,ma:this,ka:l}):$t(v.fa.qa,{ha:v,ga:A})},r.getInheritedInstanceCount=function(){return Object.keys(Ct).length},r.getLiveInheritedInstances=function(){var l=[],a;for(a in Ct)Ct.hasOwnProperty(a)&&l.push(Ct[a]);return l},r.flushPendingDeletes=cn,r.setDelayFunction=function(l){Dt=l,xt.length&&Dt&&Dt(cn)},ri=r.UnboundTypeError=ne("UnboundTypeError"),r.count_emval_handles=function(){for(var l=0,a=5;a<lt.length;++a)lt[a]!==void 0&&++l;return l},r.get_first_emval=function(){for(var l=5;l<lt.length;++l)if(lt[l]!==void 0)return lt[l];return null};var Lo={r:function(l){var a=ve[l];delete ve[l];var f=a.elements,v=f.length,A=f.map(function(U){return U.Aa}).concat(f.map(function(U){return U.Ea})),F=a.sa,q=a.la;pe([l],A,function(U){return f.forEach(function(K,Q){var ee=U[Q],le=K.ya,_e=K.za,Re=U[Q+v],Ae=K.Da,Ze=K.Fa;K.read=Je=>ee.fromWireType(le(_e,Je)),K.write=(Je,It)=>{var at=[];Ae(Ze,Je,Re.toWireType(at,It)),Oe(at)}}),[{name:a.name,fromWireType:function(K){for(var Q=Array(v),ee=0;ee<v;++ee)Q[ee]=f[ee].read(K);return q(K),Q},toWireType:function(K,Q){if(v!==Q.length)throw new TypeError("Incorrect number of tuple elements for "+a.name+": expected="+v+", actual="+Q.length);for(var ee=F(),le=0;le<v;++le)f[le].write(ee,Q[le]);return K!==null&&K.push(q,ee),ee},argPackAdvance:8,readValueFromPointer:qe,ja:q}]})},u:function(l){var a=$e[l];delete $e[l];var f=a.sa,v=a.la,A=a.Ha,F=A.map(function(q){return q.Aa}).concat(A.map(function(q){return q.Ea}));pe([l],F,function(q){var U={};return A.forEach(function(K,Q){var ee=q[Q],le=K.ya,_e=K.za,Re=q[Q+A.length],Ae=K.Da,Ze=K.Fa;U[K.Na]={read:function(Je){return ee.fromWireType(le(_e,Je))},write:function(Je,It){var at=[];Ae(Ze,Je,Re.toWireType(at,It)),Oe(at)}}}),[{name:a.name,fromWireType:function(K){var Q={},ee;for(ee in U)Q[ee]=U[ee].read(K);return v(K),Q},toWireType:function(K,Q){for(var ee in U)if(!(ee in Q))throw new TypeError('Missing field:  "'+ee+'"');var le=f();for(ee in U)U[ee].write(le,Q[ee]);return K!==null&&K.push(v,le),le},argPackAdvance:8,readValueFromPointer:qe,ja:v}]})},z:function(){},F:function(l,a,f,v,A){var F=be(f);a=Ce(a),ut(l,{name:a,fromWireType:function(q){return!!q},toWireType:function(q,U){return U?v:A},argPackAdvance:8,readValueFromPointer:function(q){if(f===1)var U=Te;else if(f===2)U=re;else if(f===4)U=ge;else throw new TypeError("Unknown boolean type size: "+a);return this.fromWireType(U[q>>F])},ja:null})},l:function(l,a,f,v,A,F,q,U,K,Q,ee,le,_e){ee=Ce(ee),F=Ye(A,F),U&&(U=Ye(q,U)),Q&&(Q=Ye(K,Q)),_e=Ye(le,_e);var Re=V(ee);un(Re,function(){Pt("Cannot construct "+ee+" due to unbound types",[v])}),pe([l,a,f],v?[v]:[],function(Ae){if(Ae=Ae[0],v)var Ze=Ae.fa,Je=Ze.qa;else Je=mt.prototype;Ae=G(Re,function(){if(Object.getPrototypeOf(this)!==It)throw new Ge("Use 'new' to construct "+ee);if(at.oa===void 0)throw new Ge(ee+" has no accessible constructor");var pi=at.oa[arguments.length];if(pi===void 0)throw new Ge("Tried to invoke ctor of "+ee+" with invalid number of parameters ("+arguments.length+") - expected ("+Object.keys(at.oa).toString()+") parameters instead!");return pi.apply(this,arguments)});var It=Object.create(Je,{constructor:{value:Ae}});Ae.prototype=It;var at=new So(ee,Ae,It,_e,Ze,F,U,Q);Ze=new ft(ee,at,!0,!1),Je=new ft(ee+"*",at,!1,!1);var hi=new ft(ee+" const*",at,!1,!0);return ti[l]={pointerType:Je,Ja:hi},oi(Re,Ae),[Ze,Je,hi]})},i:function(l,a,f,v,A,F){0<a||he(void 0);var q=fn(a,f);A=Ye(v,A),pe([],[l],function(U){U=U[0];var K="constructor "+U.name;if(U.fa.oa===void 0&&(U.fa.oa=[]),U.fa.oa[a-1]!==void 0)throw new Ge("Cannot register multiple constructors with identical number of parameters ("+(a-1)+") for class '"+U.name+"'! Overload resolution is currently only performed using the parameter count, not actual type info!");return U.fa.oa[a-1]=()=>{Pt("Cannot construct "+U.name+" due to unbound types",q)},pe([],q,function(Q){return Q.splice(1,0,null),U.fa.oa[a-1]=hn(K,Q,null,A,F),[]}),[]})},a:function(l,a,f,v,A,F,q,U){var K=fn(f,v);a=Ce(a),F=Ye(A,F),pe([],[l],function(Q){function ee(){Pt("Cannot call "+le+" due to unbound types",K)}Q=Q[0];var le=Q.name+"."+a;a.startsWith("@@")&&(a=Symbol[a.substring(2)]),U&&Q.fa.Ta.push(a);var _e=Q.fa.qa,Re=_e[a];return Re===void 0||Re.ia===void 0&&Re.className!==Q.name&&Re.ua===f-2?(ee.ua=f-2,ee.className=Q.name,_e[a]=ee):(ni(_e,a,le),_e[a].ia[f-2]=ee),pe([],K,function(Ae){return Ae=hn(le,Ae,Q,F,q),_e[a].ia===void 0?(Ae.ua=f-2,_e[a]=Ae):_e[a].ia[f-2]=Ae,[]}),[]})},I:function(l,a,f){l=Ce(l),pe([],[a],function(v){return v=v[0],r[l]=v.fromWireType(f),[]})},E:function(l,a){a=Ce(a),ut(l,{name:a,fromWireType:function(f){var v=gn(f);return si(f),v},toWireType:function(f,v){return yt(v)},argPackAdvance:8,readValueFromPointer:qe,ja:null})},h:function(l,a,f,v){function A(){}f=be(f),a=Ce(a),A.values={},ut(l,{name:a,constructor:A,fromWireType:function(F){return this.constructor.values[F]},toWireType:function(F,q){return q.value},argPackAdvance:8,readValueFromPointer:Do(a,f,v),ja:null}),un(a,A)},k:function(l,a,f){var v=Lt(l,"enum");a=Ce(a),l=v.constructor,v=Object.create(v.constructor.prototype,{value:{value:f},constructor:{value:G(v.name+"_"+a,function(){})}}),l.values[f]=v,l[a]=v},q:function(l,a,f){f=be(f),a=Ce(a),ut(l,{name:a,fromWireType:function(v){return v},toWireType:function(v,A){return A},argPackAdvance:8,readValueFromPointer:xo(a,f),ja:null})},f:function(l,a,f,v,A,F){var q=fn(a,f);l=Ce(l),A=Ye(v,A),un(l,function(){Pt("Cannot call "+l+" due to unbound types",q)},a-1),pe([],q,function(U){return U=[U[0],null].concat(U.slice(1)),oi(l,hn(l,U,null,A,F),a-1),[]})},e:function(l,a,f,v,A){a=Ce(a),A===-1&&(A=4294967295),A=be(f);var F=U=>U;if(v===0){var q=32-8*f;F=U=>U<<q>>>q}f=a.includes("unsigned")?function(U,K){return K>>>0}:function(U,K){return K},ut(l,{name:a,fromWireType:F,toWireType:f,argPackAdvance:8,readValueFromPointer:Co(a,A,v!==0),ja:null})},b:function(l,a,f){function v(F){F>>=2;var q=ue;return new A(De,q[F+1],q[F])}var A=[Int8Array,Uint8Array,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array][a];f=Ce(f),ut(l,{name:f,fromWireType:v,argPackAdvance:8,readValueFromPointer:v},{Qa:!0})},p:function(l,a){a=Ce(a);var f=a==="std::string";ut(l,{name:a,fromWireType:function(v){var A=ue[v>>2];if(f)for(var F=v+4,q=0;q<=A;++q){var U=v+4+q;if(q==A||Y[U]==0){if(F=F?I(Y,F,U-F):"",K===void 0)var K=F;else K+=String.fromCharCode(0),K+=F;F=U+1}}else{for(K=Array(A),q=0;q<A;++q)K[q]=String.fromCharCode(Y[v+4+q]);K=K.join("")}return ht(v),K},toWireType:function(v,A){A instanceof ArrayBuffer&&(A=new Uint8Array(A));var F=typeof A=="string";F||A instanceof Uint8Array||A instanceof Uint8ClampedArray||A instanceof Int8Array||ke("Cannot pass non-string to std::string");var q=(f&&F?()=>{for(var Q=0,ee=0;ee<A.length;++ee){var le=A.charCodeAt(ee);55296<=le&&57343>=le&&(le=65536+((le&1023)<<10)|A.charCodeAt(++ee)&1023),127>=le?++Q:Q=2047>=le?Q+2:65535>=le?Q+3:Q+4}return Q}:()=>A.length)(),U=In(4+q+1);if(ue[U>>2]=q,f&&F)p(A,U+4,q+1);else if(F)for(F=0;F<q;++F){var K=A.charCodeAt(F);255<K&&(ht(U),ke("String has UTF-16 code units that do not fit in 8 bits")),Y[U+4+F]=K}else for(F=0;F<q;++F)Y[U+4+F]=A[F];return v!==null&&v.push(ht,U),U},argPackAdvance:8,readValueFromPointer:qe,ja:function(v){ht(v)}})},m:function(l,a,f){if(f=Ce(f),a===2)var v=k,A=ce,F=se,q=()=>Ie,U=1;else a===4&&(v=ae,A=J,F=Se,q=()=>ue,U=2);ut(l,{name:f,fromWireType:function(K){for(var Q=ue[K>>2],ee=q(),le,_e=K+4,Re=0;Re<=Q;++Re){var Ae=K+4+Re*a;(Re==Q||ee[Ae>>U]==0)&&(_e=v(_e,Ae-_e),le===void 0?le=_e:(le+=String.fromCharCode(0),le+=_e),_e=Ae+a)}return ht(K),le},toWireType:function(K,Q){typeof Q!="string"&&ke("Cannot pass non-string to C++ string type "+f);var ee=F(Q),le=In(4+ee+a);return ue[le>>2]=ee>>U,A(Q,le+4,ee+a),K!==null&&K.push(ht,le),le},argPackAdvance:8,readValueFromPointer:qe,ja:function(K){ht(K)}})},t:function(l,a,f,v,A,F){ve[l]={name:Ce(a),sa:Ye(f,v),la:Ye(A,F),elements:[]}},s:function(l,a,f,v,A,F,q,U,K){ve[l].elements.push({Aa:a,ya:Ye(f,v),za:A,Ea:F,Da:Ye(q,U),Fa:K})},v:function(l,a,f,v,A,F){$e[l]={name:Ce(a),sa:Ye(f,v),la:Ye(A,F),Ha:[]}},j:function(l,a,f,v,A,F,q,U,K,Q){$e[l].Ha.push({Na:Ce(a),Aa:f,ya:Ye(v,A),za:F,Ea:q,Da:Ye(U,K),Fa:Q})},G:function(l,a){a=Ce(a),ut(l,{Ra:!0,name:a,argPackAdvance:0,fromWireType:function(){},toWireType:function(){}})},d:function(l,a,f,v){l=vn[l],a=gn(a),f=yn(f),l(a,f,null,v)},J:si,x:function(l){return l===0?yt(li()):(l=yn(l),yt(li()[l]))},c:function(l,a){var f=Mo(l,a),v=f[0];a=v.name+"_$"+f.slice(1).map(function(q){return q.name}).join("_")+"$";var A=ci[a];if(A!==void 0)return A;var F=Array(l-1);return A=Ao((q,U,K,Q)=>{for(var ee=0,le=0;le<l-1;++le)F[le]=f[le+1].readValueFromPointer(Q+ee),ee+=f[le+1].argPackAdvance;for(q=q[U].apply(q,F),le=0;le<l-1;++le)f[le+1].Ka&&f[le+1].Ka(F[le]);if(!v.Ra)return v.toWireType(K,q)}),ci[a]=A},n:function(l){4<l&&(lt[l].Ca+=1)},w:function(l,a,f,v){l=gn(l);var A=ui[a];return A||(A=$o(a),ui[a]=A),A(l,f,v)},K:function(){return yt([])},D:function(l){return yt(yn(l))},H:function(l,a){return l=Lt(l,"_emval_take_value"),l=l.readValueFromPointer(a),yt(l)},g:function(){he("")},B:function(l){var a=Y.length;if(l>>>=0,2147483648<l)return!1;for(var f=1;4>=f;f*=2){var v=a*(1+.2/f);v=Math.min(v,l+100663296),v=Math.max(l,v),0<v%65536&&(v+=65536-v%65536);e:{try{D.grow(Math.min(2147483648,v)-De.byteLength+65535>>>16),we();var A=1;break e}catch{}A=void 0}if(A)return!0}return!1},C:function(){return 0},y:function(){},o:function(l,a,f,v){for(var A=0,F=0;F<f;F++){var q=ge[a>>2],U=ge[a+4>>2];a+=8;for(var K=0;K<U;K++){var Q=Y[q+K],ee=Po[l];Q===0||Q===10?((l===1?B:H)(I(ee,0)),ee.length=0):ee.push(Q)}A+=U}return ge[v>>2]=A,0},A:function(){}};(function(){function l(A){r.asm=A.exports,D=r.asm.L,we(),W=r.asm._,E.unshift(r.asm.M),X--,r.monitorRunDependencies&&r.monitorRunDependencies(X),X==0&&z&&(A=z,z=null,A())}function a(A){l(A.instance)}function f(A){return Be().then(function(F){return WebAssembly.instantiate(F,v)}).then(function(F){return F}).then(A,function(F){H("failed to asynchronously prepare wasm: "+F),he(F)})}var v={a:Lo};if(X++,r.monitorRunDependencies&&r.monitorRunDependencies(X),r.instantiateWasm)try{return r.instantiateWasm(v,l)}catch(A){return H("Module.instantiateWasm callback failed with error: "+A),!1}return function(){return ie||typeof WebAssembly.instantiateStreaming!="function"||xe()||Ee.startsWith("file://")||typeof fetch!="function"?f(a):fetch(Ee,{credentials:"same-origin"}).then(function(A){return WebAssembly.instantiateStreaming(A,v).then(a,function(F){return H("wasm streaming compile failed: "+F),H("falling back to ArrayBuffer instantiation"),f(a)})})}().catch(h),{}})(),r.___wasm_call_ctors=function(){return(r.___wasm_call_ctors=r.asm.M).apply(null,arguments)},r.__Z6ToCmdsRK6SkPath=function(){return(r.__Z6ToCmdsRK6SkPath=r.asm.N).apply(null,arguments)},r.__Z8FromCmdsmi=function(){return(r.__Z8FromCmdsmi=r.asm.O).apply(null,arguments)},r.__Z7NewPathv=function(){return(r.__Z7NewPathv=r.asm.P).apply(null,arguments)},r.__Z8CopyPathRK6SkPath=function(){return(r.__Z8CopyPathRK6SkPath=r.asm.Q).apply(null,arguments)},r.__Z6EqualsRK6SkPathS1_=function(){return(r.__Z6EqualsRK6SkPathS1_=r.asm.R).apply(null,arguments)},r.__Z11ToSVGStringRK6SkPath=function(){return(r.__Z11ToSVGStringRK6SkPath=r.asm.S).apply(null,arguments)},r.__Z13FromSVGStringNSt3__212basic_stringIcNS_11char_traitsIcEENS_9allocatorIcEEEE=function(){return(r.__Z13FromSVGStringNSt3__212basic_stringIcNS_11char_traitsIcEENS_9allocatorIcEEEE=r.asm.T).apply(null,arguments)},r.__Z13ApplySimplifyR6SkPath=function(){return(r.__Z13ApplySimplifyR6SkPath=r.asm.U).apply(null,arguments)},r.__Z11ApplyPathOpR6SkPathRKS_8SkPathOp=function(){return(r.__Z11ApplyPathOpR6SkPathRKS_8SkPathOp=r.asm.V).apply(null,arguments)},r.__Z10MakeFromOpRK6SkPathS1_8SkPathOp=function(){return(r.__Z10MakeFromOpRK6SkPathS1_8SkPathOp=r.asm.W).apply(null,arguments)},r.__Z14ResolveBuilderR11SkOpBuilder=function(){return(r.__Z14ResolveBuilderR11SkOpBuilder=r.asm.X).apply(null,arguments)},r.__Z8ToCanvasRK6SkPathN10emscripten3valE=function(){return(r.__Z8ToCanvasRK6SkPathN10emscripten3valE=r.asm.Y).apply(null,arguments)},r.__Z8ToPath2DRK6SkPath=function(){return(r.__Z8ToPath2DRK6SkPath=r.asm.Z).apply(null,arguments)};var ht=r._free=function(){return(ht=r._free=r.asm.$).apply(null,arguments)},In=r._malloc=function(){return(In=r._malloc=r.asm.aa).apply(null,arguments)},fi=r.___getTypeName=function(){return(fi=r.___getTypeName=r.asm.ba).apply(null,arguments)};r.___embind_register_native_and_builtin_types=function(){return(r.___embind_register_native_and_builtin_types=r.asm.ca).apply(null,arguments)},r.dynCall_jiji=function(){return(r.dynCall_jiji=r.asm.da).apply(null,arguments)};var Xt;z=function l(){Xt||En(),Xt||(z=l)};function En(){function l(){if(!Xt&&(Xt=!0,r.calledRun=!0,!w)){if(Me(E),u(r),r.onRuntimeInitialized&&r.onRuntimeInitialized(),r.postRun)for(typeof r.postRun=="function"&&(r.postRun=[r.postRun]);r.postRun.length;){var a=r.postRun.shift();N.unshift(a)}Me(N)}}if(!(0<X)){if(r.preRun)for(typeof r.preRun=="function"&&(r.preRun=[r.preRun]);r.preRun.length;)j();Me(d),0<X||(r.setStatus?(r.setStatus("Running..."),setTimeout(function(){setTimeout(function(){r.setStatus("")},1),l()},1)):l())}}if(r.run=En,r.preInit)for(typeof r.preInit=="function"&&(r.preInit=[r.preInit]);0<r.preInit.length;)r.preInit.pop()();return En(),o.ready}})();i.exports=t})(eo);var aa=eo.exports;const sa=jn(aa),la="/assets/pathkit-1356ccfa.wasm";class xn{startTime;accumulatedTime;constructor(){this.startTime=-1,this.accumulatedTime=-1}start(){this.startTime=performance.now(),this.accumulatedTime=0}resume(){this.startTime=performance.now()}pause(){return this.accumulatedTime+=performance.now()-this.startTime,this.startTime=-1,this.accumulatedTime}stop(){if(this.startTime!=-1){const e=performance.now()-this.startTime+this.accumulatedTime;return this.accumulatedTime=0,e}else{const e=this.accumulatedTime;return this.accumulatedTime=0,e}}}class ca{activated;constructor(e){this.activated=e}async BlueTokenBoundingPath(e){if(this.activated){const t=gt().strokeColor("#0000ff").locked(!0).fillOpacity(1).commands(e.toCmds()).metadata({[`${c.EXTENSIONID}/debug`]:!0}).build();await b.scene.local.addItems([t])}}async RedIntersectionPath(e){if(this.activated){const t=gt().fillRule("evenodd").locked(!0).strokeColor("#ff0000").fillOpacity(0).commands(e.toCmds()).metadata({[`${c.EXTENSIONID}/debug`]:!0}).build();await b.scene.local.addItems([t])}}async GreenDebugPath(e){if(this.activated){const t=gt().commands(e.toCmds()).locked(!0).visible(e.visible).fillColor("#555500").fillOpacity(.3).strokeColor("#00FF00").layer("DRAWING").metadata({[`${c.EXTENSIONID}/debug`]:!0}).build();await b.scene.local.addItems([t])}}async DebugBlobINeverUse(){this.activated}}const Vt=new ca(!1);function Ht(i,e){return(i.x-e.x)*(i.x-e.x)+(i.y-e.y)*(i.y-e.y)}function to(i,e){return i.x==e.x&&i.y==e.y}function Ut(i,e,t){return t===void 0&&(t=.01),Math.abs(i-e)<=t}function Cn(i,e){return(i%e+e)%e}function ua(i,e){return ze.pointInPolygon(i[0],e)||ze.pointInPolygon(i[0],e)?!0:Gt(i,[e[0],e[1]])||Gt(i,[e[1],e[2]])||Gt(i,[e[2],e[3]])||Gt(i,[e[3],e[0]])}function Gt(i,e){const t=(i[1].x-i[0].x)*(e[1].y-e[0].y)-(e[1].x-e[0].x)*(i[1].y-i[0].y),n=((e[1].y-e[0].y)*(e[1].x-i[0].x)+(e[0].x-e[1].x)*(e[1].y-i[0].y))/t,o=((i[0].y-i[1].y)*(e[1].x-i[0].x)+(i[1].x-i[0].x)*(e[1].y-i[0].y))/t;return n>=0&&n<=1&&o>=0&&o<=1}function jt(i,e,t){return{x:i.x+e*Math.cos(t),y:i.y+e*Math.sin(t)}}function da(i,e,t,n){const o=Math.atan2(i.y-t.y,i.x-t.x);let r=jt(i,e,o+Math.PI/2),s=jt(i,e,o-Math.PI/2),u=jt(t,n,o+Math.PI/2),h=jt(t,n,o-Math.PI/2);const y=ze.normalize(ze.subtract(i,t));return r=ze.add(r,ze.multiply(y,e)),s=ze.add(s,ze.multiply(y,e)),u=ze.add(u,ze.multiply(y,0-n)),h=ze.add(h,ze.multiply(y,0-n)),[r,s,h,u]}function fa(i){return i.filter(e=>e.points&&e.points.length>1).flatMap(e=>{const t=We.fromItem(e);return e.points.slice(0,-1).map((n,o)=>{const r=We.fromPosition(e.points[o]),s=We.fromPosition(e.points[o+1]),u=We.decompose(We.multiply(t,r)).position,h=We.decompose(We.multiply(t,s)).position;return{startPosition:u,endPosition:h,originalShape:e,oneSided:e.metadata[`${c.EXTENSIONID}/oneSided`]}})})}function ha(i,e,t,n,o,r){let s=[],u=[t,n];const h=g.sceneMetadata[`${c.EXTENSIONID}/elevationMapping`]??[],y=[{x:(t+o[0])*r[0],y:o[1]*r[1]},{x:(t+o[0])*r[0],y:(n+o[1])*r[1]},{x:o[0]*r[0],y:(n+o[1])*r[1]},{x:o[0]*r[0],y:o[1]*r[1]}],O=g.gridDpi,x=c.EXTENSIONID,$=e.some(Tt);if(e.length===0)return s;for(const B of e){const H=g.playerId===B.createdUserId,D=g.sceneMetadata[`${c.EXTENSIONID}/USER-${B.createdUserId}`]?.role==="GM";let w=0;for(const k of h)vi(B.position,k.Points)&&k.Depth>w&&(w=k.Depth);if(!H&&g.playerRole!=="GM"&&!D)continue;const m=B.metadata[`${x}/visionRange`],I=g.playerShadowCache.getValue(B.id);if(s.push([]),I!==void 0&&to(I.player.position,B.position)&&I.player.metadata[`${x}/visionRange`]===m)continue;let p=O*1e3;m&&(p=O*(m/g.gridScale+.5));const _=[];if($&&!Tt(B)){for(const k of e)if(Tt(k)){const ce=k.metadata[`${c.EXTENSIONID}/visionRange`];let se=1e3*g.gridDpi;ce&&(se=g.gridDpi*(ce/g.gridScale+.5));const ae=da(B.position,p,k.position,se);_.push(ae)}}for(const k of i){let ce=0;for(const X of h)vi(k.startPosition,X.Points)&&X.Depth>w&&(ce=X.Depth);if(w>ce)continue;const se=(B.position.x-k.startPosition.x)*(k.endPosition.y-k.startPosition.y)-(B.position.y-k.startPosition.y)*(k.endPosition.x-k.startPosition.x);if(k.oneSided!==void 0&&(k.oneSided==="right"&&se>0||k.oneSided==="left"&&se<0))continue;let ae=k.startPosition.x,J=k.startPosition.y,Se=k.endPosition.x,De=k.endPosition.y;(ae<o[0]||J<o[1]||ae>o[0]+u[0]||J>o[1]+u[1]||Se<o[0]||De<o[1]||Se>o[0]+u[0]||De>o[1]+u[1])&&(ae=Math.max(o[0],Math.min(ae,o[0]+u[0])),J=Math.max(o[1],Math.min(J,o[1]+u[1])),k.startPosition=$i(k,o,u).startPosition,k.endPosition=$i(k,o,u).endPosition);const Te=[k.startPosition,k.endPosition],Y=ze.distance(k.startPosition,k.endPosition),Ie=Math.floor(Y/(p/3));for(let X=1;X<Ie;X++)Te.push(ze.lerp(k.startPosition,k.endPosition,X/Ie));let ge=!0;for(const X of Te)if(ze.compare(B.position,X,p*1.05)){ge=!1;break}if(ge&&$&&!Tt(B)){for(const X of _)if(ua([k.startPosition,k.endPosition],X)){ge=!1;break}}if(ge)continue;const ue={x:k.startPosition.x-B.position.x,y:k.startPosition.y-B.position.y},de={x:k.endPosition.x-B.position.x,y:k.endPosition.y-B.position.y};var M={x:0,y:0},S={x:0,y:0},P=0,C=0,R=0,L=0;ue.x<0?P=o[0]*r[0]:P=(t+o[0])*r[0],ue.y<0?C=o[1]*r[1]:C=(n+o[1])*r[1],de.x<0?R=o[0]*r[0]:R=(t+o[0])*r[0],de.y<0?L=o[1]*r[1]:L=(n+o[1])*r[1];const ye=[],we=[];if(ue.x!=0){const X=ue.y/ue.x,z=k.startPosition.y-X*k.startPosition.x;ye.push({x:P,y:X*P+z})}if(ue.y!=0){const X=ue.x/ue.y,z=X*k.startPosition.y-k.startPosition.x;ye.push({x:X*C-z,y:C})}if(de.x!=0){const X=de.y/de.x,z=k.endPosition.y-X*k.endPosition.x;we.push({x:R,y:X*R+z})}if(de.y!=0){const X=de.x/de.y,z=X*k.endPosition.y-k.endPosition.x;we.push({x:X*L-z,y:L})}if(ye.length===0||we.length===0)continue;ye.length==1||Ht(ye[0],k.startPosition)<Ht(ye[1],k.startPosition)?M=ye[0]:M=ye[1],we.length==1||Ht(we[0],k.endPosition)<Ht(we[1],k.endPosition)?S=we[0]:S=we[1];const W=[{x:k.startPosition.x,y:k.startPosition.y},M,S,{x:k.endPosition.x,y:k.endPosition.y}],d=[0,0];let E=0;for(const X of[M,S])Ut(X.y,o[1]*r[1])?d[E]=0:Ut(X.y,(n+o[1])*r[1])?d[E]=2:Ut(X.x,o[0]*r[0])?d[E]=3:Ut(X.x,(t+o[0])*r[0])&&(d[E]=1),E++;let N=Math.sign(se);N=N==0?1:-N;const j=N==1?d[1]:Cn(d[1]-1,4);for(let X=d[0]+(N==1?0:-1);Cn(X,4)!=j;X+=N)W.splice(W.length-2,0,y[Cn(X,4)]);s[s.length-1].push({pointset:W,fromShape:k.originalShape})}}return s}function $i(i,e,t){let{x:n,y:o}=i.startPosition,{x:r,y:s}=i.endPosition,u=(s-o)/(r-n),h=o-u*n,y=[];if(o<e[1]){let M=(e[1]-h)/u;M>=e[0]&&M<=e[0]+t[0]&&y.push({x:M,y:e[1]})}if(o>e[1]+t[1]){let M=(e[1]+t[1]-h)/u;M>=e[0]&&M<=e[0]+t[0]&&y.push({x:M,y:e[1]+t[1]})}if(n<e[0]){let M=u*e[0]+h;M>=e[1]&&M<=e[1]+t[1]&&y.push({x:e[0],y:M})}if(n>e[0]+t[0]){let M=u*(e[0]+t[0])+h;M>=e[1]&&M<=e[1]+t[1]&&y.push({x:e[0]+t[0],y:M})}y.sort((M,S)=>{let P=Math.sqrt((M.x-n)**2+(M.y-o)**2),C=Math.sqrt((S.x-n)**2+(S.y-o)**2);return P-C});let O=y.length>0?y[0]:{x:n,y:o},x=y.length>0?y[y.length-1]:{x:r,y:s};return{startPosition:O,endPosition:x}}let Xe;async function St(i){if(await b.action.setBadgeText("⏱️"),await b.player.setMetadata({[`${c.EXTENSIONID}/processed`]:!1}),Xe||(Xe=await sa({locateFile:()=>la})),!g.sceneReady||!g.sceneInitialized){g.playerShadowCache.invalidate(),g.busy=!1,await b.action.setBadgeText(void 0);return}if(g.busy)return;g.busy=!0;const[e,t]=[new xn,new xn];e.start(),e.pause(),t.start();const n=g.sceneItems.filter(Y=>Li(Y)&&(!Tt(Y)||Y.visible===!0)),o=g.sceneItems.filter(Xa),r=g.sceneItems.filter(Ri),s=g.sceneItems.filter(mo)?.[0],u=g.sceneMetadata[`${c.EXTENSIONID}/visionEnabled`]===!0,h=g.sceneMetadata[`${c.EXTENSIONID}/persistenceEnabled`]===!0,y=g.sceneMetadata[`${c.EXTENSIONID}/autodetectEnabled`]===!0,O=g.sceneMetadata[`${c.EXTENSIONID}/fowEnabled`]===!0,x=g.sceneMetadata[`${c.EXTENSIONID}/fowColor`],$=g.sceneMetadata[`${c.EXTENSIONID}/playerDoors`]===!0;let M=[],S=[],P=[],C=!1,R=[];if(s===void 0?(M[0]=0,M[1]=0,S[0]=1,S[1]=1,P[0]=0,P[1]=0):(M[0]=s.width*s.scale.x,M[1]=s.height*s.scale.y,S[0]=s.scale.x,S[1]=s.scale.y,P[0]=s.position.x,P[1]=s.position.y),g.playerRole==="GM"){R=n;const Y=document.getElementById("mapHeight"),re=document.getElementById("mapWidth");re&&(re.value=(Math.round(M[0])/g.gridDpi).toString()),Y&&(Y.value=(Math.round(M[1])/g.gridDpi).toString())}else{R=n.filter(Fa);for(const Y of n)Li(Y)&&g.sceneMetadata[`${c.EXTENSIONID}/USER-${Y.createdUserId}`]?.role==="GM"&&R.push(Y)}const L=JSON.stringify(o),B=JSON.stringify(r),H=JSON.stringify(R),ie=JSON.stringify(s);if(g.previousMap===ie&&g.previousVisionEnabled===u&&g.previousFowColor===x&&g.previousAutodetectEnabled===y&&g.previousFowEnabled===O&&g.previousPersistenceEnabled===h&&g.previousVisionShapes===L&&g.previousAutohideItems===B&&g.previousPlayersWithVision===H&&g.previousSize[0]===M[0]&&g.previousSize[1]===M[1]&&i!==!0){g.busy=!1,await b.action.setBadgeText(void 0);return}(ie!=g.previousMap||g.previousVisionShapes!=L||M[0]!=g.previousSize[0]||M[1]!=g.previousSize[1])&&(C=!0),g.previousMap=ie,g.previousPlayersWithVision=H,g.previousVisionShapes=L,g.previousSize=M,g.previousVisionEnabled=u,g.previousAutodetectEnabled=y,g.previousFowEnabled=O,g.previousFowColor=x,g.previousPersistenceEnabled=h,t.pause();const D=[];for(let Y=0;Y<=6;Y++)D.push(new xn);D[1].start();let[w,m]=M;if(y){const Y=g.sceneItems.filter(Ie=>Ie.layer==="MAP"&&Jt(Ie));if(Y.length===0){g.busy=!1,await b.action.setBadgeText(void 0);return}let re=[];for(let Ie of Y){let ge=g.gridDpi/Ie.grid.dpi,ue=Ie.position.x-ge*Ie.grid.offset.x*Ie.scale.x,de=Ie.position.y-ge*Ie.grid.offset.y*Ie.scale.y,ye=ue+ge*Ie.image.width*Ie.scale.x,we=de+ge*Ie.image.height*Ie.scale.y;if(Ie.rotation>0){const W=Math.abs(ye-ue),d=Math.abs(we-de);switch(Ie.rotation){case 270:de-=d,we-=d;break;case 180:de-=d,we-=d,ue-=W,ye-=W;break;case 90:ue-=W,ye-=W;break}}re.length?(ue<re[0]&&(re[0]=ue),de<re[1]&&(re[1]=de),ye>re[2]&&(re[2]=ye),we>re[3]&&(re[3]=we)):(re[0]=ue,re[1]=de,re[2]=ye,re[3]=we)}P=[re[0],re[1]],M=[re[2]-re[0],re[3]-re[1]],S=[1,1],[w,m]=M}let I=0,p=0;if(C&&g.playerShadowCache.invalidate(),t.resume(),!(g.sceneMetadata[`${c.EXTENSIONID}/visionEnabled`]===!0)||R.length==0){const Y=g.sceneLocal.filter(re=>Gn(re));await b.scene.local.deleteItems(Y.map(re=>re.id)),g.busy=!1,await b.action.setBadgeText(void 0);return}const k=fa(o),ce=ha(k,R,w,m,P,S);if(ce.length==0){g.busy=!1,await b.action.setBadgeText(void 0);return}const se=[];D[1].pause(),D[2].start();const ae={};let J=0;await Se();async function Se(){const Y=R[J];let re=g.playerShadowCache.getValue(Y.id);if(re!==void 0&&to(re.player.position,Y.position)&&re.player.metadata[`${c.EXTENSIONID}/visionRange`]===Y.metadata[`${c.EXTENSIONID}/visionRange`]){const ye=Xe.FromCmds(re.shadowPath);if(ae[J]=ye,I++,J===R.length-1){await De(D);return}else{J++,await Se();return}}p++;const Ie=ce[J];let ge=new Xe.SkOpBuilder;const ue=Xe.NewPath().rect(P[0],P[1],M[0],M[1]);ge.add(ue,Xe.PathOp.UNION),ue.delete(),await de(Ie);function de(ye){const we=Math.ceil(ye.length/g.workers.length);let W=0,d=0,E={};for(let N=0;N<g.workers.length;N++){const j=W+we,X=ye.slice(W,j+10);g.workers[N].onmessage=async function(z){if(z.data){const{numb:he,messageData:xe}=z.data;if(d++,E[he]=xe,d===g.workers.length){for(let Fe=0;Fe<g.workers.length;Fe++){const Be=E[Fe];if(Be){const Me=Xe.FromCmds(Be);ge.add(Me,Xe.PathOp.INTERSECT),Me.delete()}}let Ee=ge.resolve();if(Ee.simplify(),!Ee){console.error("Couldn't compute fog"),g.busy=!1,await b.action.setBadgeText(void 0);return}ae[J]=Ee,re!==void 0&&(re.shadowPath="");const He=Ee.toCmds();g.playerShadowCache.cacheValue(Y.id,{shadowPath:He,player:Y}),ge.delete(),J===R.length-1?await De(D):(J++,await Se())}}},g.workers[N].postMessage({numb:N,polygons:X,mapOffset:P,mapSize:M}),W=j}}}async function De(Y){Y[2].pause(),Y[3].start();const re=[],Ie=Xe.NewPath();for(let te=0;te<R.length;te++){const me=R[te],T=me.metadata[`${c.EXTENSIONID}/visionRange`],V=g.playerId===R[te].createdUserId,ne=g.sceneMetadata[`${c.EXTENSIONID}/USER-${R[te].createdUserId}`]?.role==="GM";if(Tt(me)?re[te]=!0:Ie.op(ae[te],Xe.PathOp.UNION),T){if(!V&&g.playerRole!=="GM"&&!ne)continue;const oe=g.gridDpi*(T/g.gridScale+.5),fe=Xe.NewPath().ellipse(me.position.x,me.position.y,oe,oe,0,0,2*Math.PI);ae[te]?.op(fe,Xe.PathOp.INTERSECT),fe.delete();const pe=g.sceneMetadata[`${c.EXTENSIONID}/USER-${me.createdUserId}`];if(pe&&g.playerRole==="GM"&&!Tt(me)&&pe.role!=="GM"){const $e=Vi().strokeColor(pe.color).fillOpacity(0).position({x:me.position.x,y:me.position.y}).width(oe*2).height(oe*2).shapeType("CIRCLE").metadata({[`${c.EXTENSIONID}/isIndicatorRing`]:!0}).locked(!0).build();se.push($e)}}}Ie.simplify();for(let te=0;te<re.length;te++)re[te]===!0&&(ae[te].op(Ie,Xe.PathOp.INTERSECT),ae[te].simplify());Ie.delete(),Y[3].pause(),Y[4].start();const ge=[],ue=[];let de=[],ye=[];const we=Xe.NewPath(),W={},d=g.sceneLocal.filter(te=>Gn(te)),E=g.sceneLocal.filter(te=>Ra(te));O&&we.rect(P[0],P[1],M[0],M[1]);let N=[],j,X=null;if(h)if(N=d.filter(te=>At(te)),j=new Xe.SkOpBuilder,W.reuse=!0,N.length===0){const te=gt().commands([]).fillRule("evenodd").locked(!0).visible(!1).fillColor("#000000").strokeColor("#000000").layer("FOG").name("Fog of War").metadata({[`${c.EXTENSIONID}/isVisionFog`]:!0,[`${c.EXTENSIONID}/digest`]:"reuse"}).build();te.zIndex=3,ye.push(te),N=[te]}else X=Xe.FromCmds(N[0].commands),X.setFillType(Xe.FillType.EVENODD);const z=new Xe.SkOpBuilder;let he=!1;for(const te of Object.keys(ae)){const me=ae[te],V=new TextEncoder().encode(me.toCmds().toString()),G=await crypto.subtle.digest("SHA-1",V).then(oe=>[...new Uint8Array(oe)].map(fe=>fe.toString(16).padStart(2,"0")).join(""));if(d.filter(oe=>At(oe)&&oe.metadata[`${c.EXTENSIONID}/digest`]===G).length===0?h?j.add(me,Xe.PathOp.UNION):ge.push({cmds:me.toCmds(),visible:!1,zIndex:3,playerId:R[te].id,digest:G}):W[G]=!0,O){const oe=g.sceneLocal.filter(fe=>fe.metadata[`${c.EXTENSIONID}/debug`]===!0).map(fe=>fe.id);oe.length>0&&(de=de.concat(oe)),await Vt.GreenDebugPath(me),we.op(me,Xe.PathOp.DIFFERENCE),g.playerRole==="GM"&&(he=!0,z.add(me,Xe.PathOp.UNION))}me.delete()}const xe=g.sceneMetadata[`${c.EXTENSIONID}/sceneId`];if(h){const te=j.resolve();te.setFillType(Xe.FillType.EVENODD),X!==null&&te.op(X,Xe.PathOp.UNION);const me=te.toCmds();N.length>0&&(N[0].commands=me,ye=ye.concat(N));try{localStorage.setItem(`${c.EXTENSIONID}/fogCache/${g.playerId}/${xe}`,JSON.stringify([{digest:"reuse",commands:me}]))}catch{console.log("Local storage is disabled")}X!==null&&X.delete(),te.delete(),j.delete()}else if(h){const te=d.filter(At);try{localStorage.setItem(`${c.EXTENSIONID}/fogCache/${g.playerId}/${xe}`,JSON.stringify(te.map(me=>({digest:me.metadata[`${c.EXTENSIONID}/digest`],commands:me.commands}))))}catch{console.log("Local storage is disabled")}}let Ee;he&&(Ee=z.resolve()),z.delete();const He=d.filter(Zt),Fe=d.filter(te=>{const me=te.metadata[`${c.EXTENSIONID}/digest`];return At(te)&&W[me]===void 0});if(O){let te=g.sceneMetadata[`${c.EXTENSIONID}/fowColor`]?g.sceneMetadata[`${c.EXTENSIONID}/fowColor`]:"#00000088",me=.5;te.length==9&&(me=Number.parseInt(te.substring(7),16)/255,te=te.substring(0,7));const T=gt().commands(we.toCmds()).locked(!0).fillRule("evenodd").visible(!0).fillColor(te).fillOpacity(me).strokeWidth(0).strokeColor("#000000").layer("DRAWING").metadata({[`${c.EXTENSIONID}/isTrailingFog`]:!0}).name("Trailing Fog").build();T.disableHit=!0,He.length>0?ue.push(b.scene.local.updateItems(Zt,V=>{for(const G of V)G.commands=T.commands},!1)):ye.push(T)}else de=de.concat(d.filter(Zt).map(te=>te.id));we.delete(),Y[4].pause(),Y[5].start();const Be=g.sceneLocal.filter(te=>te.metadata[`${c.EXTENSIONID}/doorId`]!==void 0);$||g.playerRole=="GM"?await Zo():Be.length>0&&(de=de.concat(Be.map(te=>te.id)));for(const te of Be){const me=te.metadata[`${c.EXTENSIONID}/doorId`],T=g.sceneItems.find(V=>V.id===me);if(T){const V=te.commands.length==c.DOOROPEN.length,G=!!T.metadata[`${c.EXTENSIONID}/doorOpen`];if(V===G)continue;ue.push(b.scene.local.updateItems([te.id],ne=>{const oe=ne[0];Bo(oe)&&(oe.commands=Hi(G))}))}}t.pause(),e.resume(),await Vt.DebugBlobINeverUse(),de=de.concat(E.map(te=>te.id)),ge.map(te=>{const me=gt().commands(te.cmds).fillRule("evenodd").locked(!0).visible(te.visible).fillColor("#000000").strokeColor("#000000").layer("FOG").name("Fog of War").metadata({[`${c.EXTENSIONID}/isVisionFog`]:!0,[`${c.EXTENSIONID}/digest`]:te.digest}).build();me.zIndex=te.zIndex,ye.push(me)}),h||(de=de.concat(Fe.map(te=>te.id))),se.length>0&&(ye=ye.concat(se)),g.fogFilled||await b.scene.fog.setFilled(!0),await Promise.all(ue),await b.scene.local.deleteItems(de),await b.scene.local.addItems(ye);let Me=0;Y[5].pause(),Y[6].start(),he&&(await Te(Ee,ue),Ee.delete()),Y[6].pause();const[ve,Oe]=[e.stop(),t.stop()],qe={compute_time:`${Oe} ms`,communication_time:`${ve} ms`,cache_hits:I.toString(),cache_misses:p.toString(),item_counter:Me.toString()};for(let te=1;te<=6;te++){const me=Y[te].stop();qe["stage"+te]=`${me} ms`}pa(qe),g.busy=!1,await b.player.setMetadata({[`${c.EXTENSIONID}/processed`]:!0}),await b.action.setBadgeText(void 0)}async function Te(Y,re){const Ie=[],ge=g.sceneItems.filter(ue=>Ri(ue)&&Jt(ue));Y.simplify();for(const ue of ge){const de=new Xe.SkOpBuilder,ye=Xe.NewPath(),we=g.gridDpi/ue.grid.dpi*(ue.image.width/2)*ue.scale.x;for(let E=0;E<6;E++){const N=E*60*Math.PI/180,j=ue.position.x+we*Math.cos(N),X=ue.position.y+we*Math.sin(N);E==0?ye.moveTo(j,X):ye.lineTo(j,X)}ye.closePath(),await Vt.BlueTokenBoundingPath(ye),de.add(ye,Xe.PathOp.UNION),de.add(Y,Xe.PathOp.INTERSECT);const W=de.resolve(),d=!W.toCmds().length;ue.visible==d&&Ie.push(ue),await Vt.RedIntersectionPath(W),ye.delete(),de.delete(),W.delete()}re.push(b.scene.items.updateItems(Ie.map(ue=>ue.id),ue=>{for(let de=0;de<ue.length;de++)ue[de].visible=!ue[de].visible}))}}function pa(i){for(const[e,t]of Object.entries(i)){const n=document.getElementById(e);e=="compute_time"||e=="communication_time"||e[0]=="s"?n&&(n.innerText=Number.parseFloat(t).toFixed(1)+"ms"):n&&(n.innerText=t)}}function Ot(i){if(i.ctrlKey)return i.pointerPosition;const e=Math.round(g.gridDpi/g.gridSnap),t=Math.round(i.pointerPosition.x/g.gridDpi)*g.gridDpi,n=Math.round(i.pointerPosition.y/g.gridDpi)*g.gridDpi,o=Math.abs(t-i.pointerPosition.x),r=Math.abs(n-i.pointerPosition.y);let s,u;return o<=e?s=t:s=i.pointerPosition.x,r<=e?u=n:u=i.pointerPosition.y,{x:s,y:u}}let nt=null;const ga="#000000",ma=8,ya=[];async function no(){await b.popover.close(c.LINETOOLID)}async function Bn(){if(!nt)return;const[i,e]=nt;e(),nt=null,await no()}async function Vn(){if(!nt)return;const[i,e]=nt,t=i(n=>{n.visible=!1,n.metadata[`${c.EXTENSIONID}/isVisionLine`]=!0,n.points.pop()});t.points.length>=2&&await b.scene.items.addItems([t]),e(),nt=null,await no()}async function io(){if(!nt)return;const[i]=nt;i(e=>{e.points.length>2&&e.points.pop()})}async function va(i,e){if(!e.transformer)if(nt){const[t]=nt;t(n=>{n.points.push(e.pointerPosition)})}else{const t=Ot(e),n=g.snap?t:e.pointerPosition,o=ct().tension(0).points([n,n]).strokeColor(g.sceneMetadata[`${c.EXTENSIONID}/toolColor`]??ga).strokeDash(g.sceneMetadata[`${c.EXTENSIONID}/toolStyle`]??ya).strokeWidth(g.sceneMetadata[`${c.EXTENSIONID}/toolWidth`]??ma).fillOpacity(0).fillColor("#000000").layer("DRAWING").name("Vision Line (Line)").closed(!1).locked(!0).build();nt=await b.interaction.startItemInteraction(o);const r=await b.viewport.getWidth();await b.popover.open({id:c.LINETOOLID,url:"/pages/line.html",height:75,width:350,disableClickAway:!0,hidePaper:!0,anchorPosition:{top:50,left:r/2},anchorReference:"POSITION",anchorOrigin:{vertical:"CENTER",horizontal:"CENTER"},transformOrigin:{vertical:"TOP",horizontal:"CENTER"}})}}function Ia(i,e){if(!nt||e.transformer)return;const[t]=nt,n=Ot(e);t(o=>{o.points[o.points.length-1]=g.snap?n:e.pointerPosition})}function Ea(i,e){nt&&(e.key=="Escape"?Bn():e.key=="Enter"?Vn():e.key==="z"&&io())}const _n={onToolClick:va,onToolMove:Ia,onKeyDown:Ea};let it=null;const wa="#000000",Sa=8,Ta=[];async function oo(){await b.popover.close(c.POLYTOOLID)}async function Hn(){if(!it)return;const[i,e]=it;e(),it=null,oo(),await b.player.setMetadata({[`${c.EXTENSIONID}/cancelPoly`]:!1})}async function Un(){if(!it)return;const[i,e]=it,t=i(n=>{n.visible=!1,n.metadata[`${c.EXTENSIONID}/isVisionLine`]=!0,n.points.pop(),n.points.push(n.points[0])});t.points.length>=4&&await b.scene.items.addItems([t]),e(),it=null,oo(),await b.player.setMetadata({[`${c.EXTENSIONID}/finishPoly`]:!1})}async function ro(){if(!it)return;const[i]=it;i(e=>{e.points.length>2&&e.points.pop()})}async function ba(i,e){if(!e.transformer)if(it){const[t]=it;t(n=>{n.points.push(e.pointerPosition)})}else{const t=Ot(e),n=g.snap?t:e.pointerPosition,o=ct().tension(0).points([n,n]).strokeColor(g.sceneMetadata[`${c.EXTENSIONID}/toolColor`]??wa).strokeDash(g.sceneMetadata[`${c.EXTENSIONID}/toolStyle`]??Ta).strokeWidth(g.sceneMetadata[`${c.EXTENSIONID}/toolWidth`]??Sa).fillOpacity(.5).fillColor("#000000").layer("DRAWING").name("Vision Line (Polygon)").locked(!0).build();it=await b.interaction.startItemInteraction(o);const r=await b.viewport.getWidth();await b.popover.open({id:c.POLYTOOLID,url:"/pages/polygon.html",height:75,width:400,disableClickAway:!0,hidePaper:!0,anchorPosition:{top:50,left:r/2},anchorReference:"POSITION",anchorOrigin:{vertical:"CENTER",horizontal:"CENTER"},transformOrigin:{vertical:"TOP",horizontal:"CENTER"}})}}function Na(i,e){if(!it||e.transformer)return;const[t]=it,n=Ot(e);t(o=>{o.points[o.points.length-1]=g.snap?n:e.pointerPosition})}function Oa(i,e){it&&(e.key=="Escape"?Hn():e.key=="Enter"?Un():e.key==="z"&&ro())}const An={onToolClick:ba,onToolMove:Na,onKeyDown:Oa};let ot=null;const ao=8,so=[];async function lo(){await b.popover.close(c.ELEVATIONTOOLID)}async function Jn(){if(!ot)return;const[i,e]=ot;e(),ot=null,lo()}async function co(){if(!ot)return;const[i,e]=ot,t=i(n=>{n.visible=!1,n.points.pop(),n.points.push(n.points[0])});if(t.points.length>=4){await b.scene.local.addItems([t]);let n=g.sceneMetadata[`${c.EXTENSIONID}/elevationMapping`];n||(n=[]);const o=t.metadata[`${c.EXTENSIONID}/elevation`]??0,r={Points:t.points,Depth:o};n.push(r),await b.scene.setMetadata({[`${c.EXTENSIONID}/elevationMapping`]:n})}e(),ot=null,lo()}async function uo(){if(!ot)return;const[i]=ot;i(e=>{e.points.length>2&&e.points.pop()})}async function ka(i,e,t){if(!e.transformer)if(ot){const[n]=ot;n(o=>{o.points.push(e.pointerPosition)})}else{const n=Ot(e),o=g.snap?n:e.pointerPosition,r=ct().tension(0).points([o,o]).strokeColor(fo(t)).strokeDash(g.sceneMetadata[`${c.EXTENSIONID}/toolStyle`]??so).strokeWidth(g.sceneMetadata[`${c.EXTENSIONID}/toolWidth`]??ao).fillOpacity(.5).fillColor(ho(t)).layer("DRAWING").metadata({[`${c.EXTENSIONID}/elevation`]:t}).name(`Elevation-${t} Area`).zIndex(t).locked(!0).build();ot=await b.interaction.startItemInteraction(r);const s=await b.viewport.getWidth();await b.popover.open({id:c.ELEVATIONTOOLID,url:"/pages/elevation.html",height:110,width:360,disableClickAway:!0,anchorPosition:{top:60,left:s/2},anchorReference:"POSITION",anchorOrigin:{vertical:"CENTER",horizontal:"CENTER"},transformOrigin:{vertical:"TOP",horizontal:"CENTER"}})}}function Da(i,e){if(!ot||e.transformer)return;const[t]=ot,n=Ot(e);t(o=>{o.points[o.points.length-1]=g.snap?n:e.pointerPosition})}function xa(i,e,t){ot&&(e.key=="Escape"?Jn():e.key=="Enter"?co():e.key==="z"&&uo())}async function Ca(i){const e=i.metadata[`${c.EXTENSIONID}/elevationEditor`]??!1;await b.tool.setMetadata(`${c.EXTENSIONID}/vision-tool`,{[`${c.EXTENSIONID}/elevationEditor`]:!e}),e?await Aa():await _a()}async function _a(i){const t=(await b.scene.getMetadata())[`${c.EXTENSIONID}/elevationMapping`]??[];if(t&&t.length>0){const n=[];for(const o of t){const r=ct().tension(0).points(o.Points).strokeColor(fo(o.Depth)).strokeDash(g.sceneMetadata[`${c.EXTENSIONID}/toolStyle`]??so).strokeWidth(g.sceneMetadata[`${c.EXTENSIONID}/toolWidth`]??ao).fillOpacity(.5).fillColor(ho(o.Depth)).layer("DRAWING").name("Elevation-1 Area").locked(!0).visible(!1).metadata({[`${c.EXTENSIONID}/elevation`]:o.Depth}).zIndex(o.Depth).build();n.push(r)}await b.scene.local.addItems(n)}}async function Aa(i){const e=g.sceneLocal.filter(t=>t.metadata[`${c.EXTENSIONID}/elevation`]!==void 0);if(e.length>0){const t=[];for(const n of e){let o=n.points;(n.position.x!==0||n.position.y!==0)&&(o=n.points.map(s=>{const u=s.x+n.position.x,h=s.y+n.position.y;return{x:u,y:h}}));const r={Points:o,Depth:n.metadata[`${c.EXTENSIONID}/elevation`]??0};t.push(r)}await b.scene.setMetadata({[`${c.EXTENSIONID}/elevationMapping`]:t}),await b.scene.local.deleteItems(e.map(n=>n.id))}else await b.scene.setMetadata({[`${c.EXTENSIONID}/elevationMapping`]:[]})}function fo(i){switch(i){case 1:return"#6454ac";case 2:return"#029658";case 3:return"#fcd444";case 4:return"#fc6404";case 5:return"#ff0000";default:return"#000000"}}function ho(i){switch(i){case 1:return"#6454ac4F";case 2:return"#0296584F";case 3:return"#fcd4444F";case 4:return"#fc64044F";case 5:return"#ff00004F";default:return"#0000004F"}}const Ke={onToolClick:ka,onToolMove:Da,onKeyDown:xa,enterEditMode:Ca,cancelDrawing:Jn};function Wt(i){throw new Error('Could not dynamically require "'+i+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var po={exports:{}};(function(i,e){(function(t){i.exports=t()})(function(){return function t(n,o,r){function s(y,O){if(!o[y]){if(!n[y]){var x=typeof Wt=="function"&&Wt;if(!O&&x)return x(y,!0);if(u)return u(y,!0);throw new Error("Cannot find module '"+y+"'")}O=o[y]={exports:{}},n[y][0].call(O.exports,function($){var M=n[y][1][$];return s(M||$)},O,O.exports,t,n,o,r)}return o[y].exports}for(var u=typeof Wt=="function"&&Wt,h=0;h<r.length;h++)s(r[h]);return s}({1:[function(t,n,o){(function(r,s,u,h,y,O,x,$,M){var S=t("crypto");function P(D,w){w=L(D,w);var m;return(m=w.algorithm!=="passthrough"?S.createHash(w.algorithm):new ie).write===void 0&&(m.write=m.update,m.end=m.update),H(w,m).dispatch(D),m.update||m.end(""),m.digest?m.digest(w.encoding==="buffer"?void 0:w.encoding):(D=m.read(),w.encoding!=="buffer"?D.toString(w.encoding):D)}(o=n.exports=P).sha1=function(D){return P(D)},o.keys=function(D){return P(D,{excludeValues:!0,algorithm:"sha1",encoding:"hex"})},o.MD5=function(D){return P(D,{algorithm:"md5",encoding:"hex"})},o.keysMD5=function(D){return P(D,{algorithm:"md5",encoding:"hex",excludeValues:!0})};var C=S.getHashes?S.getHashes().slice():["sha1","md5"],R=(C.push("passthrough"),["buffer","hex","binary","base64"]);function L(D,w){var m={};if(m.algorithm=(w=w||{}).algorithm||"sha1",m.encoding=w.encoding||"hex",m.excludeValues=!!w.excludeValues,m.algorithm=m.algorithm.toLowerCase(),m.encoding=m.encoding.toLowerCase(),m.ignoreUnknown=w.ignoreUnknown===!0,m.respectType=w.respectType!==!1,m.respectFunctionNames=w.respectFunctionNames!==!1,m.respectFunctionProperties=w.respectFunctionProperties!==!1,m.unorderedArrays=w.unorderedArrays===!0,m.unorderedSets=w.unorderedSets!==!1,m.unorderedObjects=w.unorderedObjects!==!1,m.replacer=w.replacer||void 0,m.excludeKeys=w.excludeKeys||void 0,D===void 0)throw new Error("Object argument required.");for(var I=0;I<C.length;++I)C[I].toLowerCase()===m.algorithm.toLowerCase()&&(m.algorithm=C[I]);if(C.indexOf(m.algorithm)===-1)throw new Error('Algorithm "'+m.algorithm+'"  not supported. supported values: '+C.join(", "));if(R.indexOf(m.encoding)===-1&&m.algorithm!=="passthrough")throw new Error('Encoding "'+m.encoding+'"  not supported. supported values: '+R.join(", "));return m}function B(D){if(typeof D=="function")return/^function\s+\w*\s*\(\s*\)\s*{\s+\[native code\]\s+}$/i.exec(Function.prototype.toString.call(D))!=null}function H(D,w,m){m=m||[];function I(p){return w.update?w.update(p,"utf8"):w.write(p,"utf8")}return{dispatch:function(p){return this["_"+((p=D.replacer?D.replacer(p):p)===null?"null":typeof p)](p)},_object:function(p){var _,k=Object.prototype.toString.call(p),ce=/\[object (.*)\]/i.exec(k);if(ce=(ce=ce?ce[1]:"unknown:["+k+"]").toLowerCase(),0<=(k=m.indexOf(p)))return this.dispatch("[CIRCULAR:"+k+"]");if(m.push(p),u!==void 0&&u.isBuffer&&u.isBuffer(p))return I("buffer:"),I(p);if(ce==="object"||ce==="function"||ce==="asyncfunction")return k=Object.keys(p),D.unorderedObjects&&(k=k.sort()),D.respectType===!1||B(p)||k.splice(0,0,"prototype","__proto__","constructor"),D.excludeKeys&&(k=k.filter(function(se){return!D.excludeKeys(se)})),I("object:"+k.length+":"),_=this,k.forEach(function(se){_.dispatch(se),I(":"),D.excludeValues||_.dispatch(p[se]),I(",")});if(!this["_"+ce]){if(D.ignoreUnknown)return I("["+ce+"]");throw new Error('Unknown object type "'+ce+'"')}this["_"+ce](p)},_array:function(p,se){se=se!==void 0?se:D.unorderedArrays!==!1;var k=this;if(I("array:"+p.length+":"),!se||p.length<=1)return p.forEach(function(ae){return k.dispatch(ae)});var ce=[],se=p.map(function(ae){var J=new ie,Se=m.slice();return H(D,J,Se).dispatch(ae),ce=ce.concat(Se.slice(m.length)),J.read().toString()});return m=m.concat(ce),se.sort(),this._array(se,!1)},_date:function(p){return I("date:"+p.toJSON())},_symbol:function(p){return I("symbol:"+p.toString())},_error:function(p){return I("error:"+p.toString())},_boolean:function(p){return I("bool:"+p.toString())},_string:function(p){I("string:"+p.length+":"),I(p.toString())},_function:function(p){I("fn:"),B(p)?this.dispatch("[native]"):this.dispatch(p.toString()),D.respectFunctionNames!==!1&&this.dispatch("function-name:"+String(p.name)),D.respectFunctionProperties&&this._object(p)},_number:function(p){return I("number:"+p.toString())},_xml:function(p){return I("xml:"+p.toString())},_null:function(){return I("Null")},_undefined:function(){return I("Undefined")},_regexp:function(p){return I("regex:"+p.toString())},_uint8array:function(p){return I("uint8array:"),this.dispatch(Array.prototype.slice.call(p))},_uint8clampedarray:function(p){return I("uint8clampedarray:"),this.dispatch(Array.prototype.slice.call(p))},_int8array:function(p){return I("int8array:"),this.dispatch(Array.prototype.slice.call(p))},_uint16array:function(p){return I("uint16array:"),this.dispatch(Array.prototype.slice.call(p))},_int16array:function(p){return I("int16array:"),this.dispatch(Array.prototype.slice.call(p))},_uint32array:function(p){return I("uint32array:"),this.dispatch(Array.prototype.slice.call(p))},_int32array:function(p){return I("int32array:"),this.dispatch(Array.prototype.slice.call(p))},_float32array:function(p){return I("float32array:"),this.dispatch(Array.prototype.slice.call(p))},_float64array:function(p){return I("float64array:"),this.dispatch(Array.prototype.slice.call(p))},_arraybuffer:function(p){return I("arraybuffer:"),this.dispatch(new Uint8Array(p))},_url:function(p){return I("url:"+p.toString())},_map:function(p){return I("map:"),p=Array.from(p),this._array(p,D.unorderedSets!==!1)},_set:function(p){return I("set:"),p=Array.from(p),this._array(p,D.unorderedSets!==!1)},_file:function(p){return I("file:"),this.dispatch([p.name,p.size,p.type,p.lastModfied])},_blob:function(){if(D.ignoreUnknown)return I("[blob]");throw Error(`Hashing Blob objects is currently not supported
(see https://github.com/puleos/object-hash/issues/26)
Use "options.replacer" or "options.ignoreUnknown"
`)},_domwindow:function(){return I("domwindow")},_bigint:function(p){return I("bigint:"+p.toString())},_process:function(){return I("process")},_timer:function(){return I("timer")},_pipe:function(){return I("pipe")},_tcp:function(){return I("tcp")},_udp:function(){return I("udp")},_tty:function(){return I("tty")},_statwatcher:function(){return I("statwatcher")},_securecontext:function(){return I("securecontext")},_connection:function(){return I("connection")},_zlib:function(){return I("zlib")},_context:function(){return I("context")},_nodescript:function(){return I("nodescript")},_httpparser:function(){return I("httpparser")},_dataview:function(){return I("dataview")},_signal:function(){return I("signal")},_fsevent:function(){return I("fsevent")},_tlswrap:function(){return I("tlswrap")}}}function ie(){return{buf:"",write:function(D){this.buf+=D},end:function(D){this.buf+=D},read:function(){return this.buf}}}o.writeToStream=function(D,w,m){return m===void 0&&(m=w,w={}),H(w=L(D,w),m).dispatch(D)}}).call(this,t("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},t("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/fake_9a5aa49d.js","/")},{buffer:3,crypto:5,lYpoI2:11}],2:[function(t,n,o){(function(r,s,u,h,y,O,x,$,M){(function(S){var P=typeof Uint8Array<"u"?Uint8Array:Array,C="+".charCodeAt(0),R="/".charCodeAt(0),L="0".charCodeAt(0),B="a".charCodeAt(0),H="A".charCodeAt(0),ie="-".charCodeAt(0),D="_".charCodeAt(0);function w(m){return m=m.charCodeAt(0),m===C||m===ie?62:m===R||m===D?63:m<L?-1:m<L+10?m-L+26+26:m<H+26?m-H:m<B+26?m-B+26:void 0}S.toByteArray=function(m){var I,p;if(0<m.length%4)throw new Error("Invalid string. Length must be a multiple of 4");var _=m.length,_=m.charAt(_-2)==="="?2:m.charAt(_-1)==="="?1:0,k=new P(3*m.length/4-_),ce=0<_?m.length-4:m.length,se=0;function ae(J){k[se++]=J}for(I=0;I<ce;I+=4,0)ae((16711680&(p=w(m.charAt(I))<<18|w(m.charAt(I+1))<<12|w(m.charAt(I+2))<<6|w(m.charAt(I+3))))>>16),ae((65280&p)>>8),ae(255&p);return _==2?ae(255&(p=w(m.charAt(I))<<2|w(m.charAt(I+1))>>4)):_==1&&(ae((p=w(m.charAt(I))<<10|w(m.charAt(I+1))<<4|w(m.charAt(I+2))>>2)>>8&255),ae(255&p)),k},S.fromByteArray=function(m){var I,p,_,k,ce=m.length%3,se="";function ae(J){return"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(J)}for(I=0,_=m.length-ce;I<_;I+=3)p=(m[I]<<16)+(m[I+1]<<8)+m[I+2],se+=ae((k=p)>>18&63)+ae(k>>12&63)+ae(k>>6&63)+ae(63&k);switch(ce){case 1:se=(se+=ae((p=m[m.length-1])>>2))+ae(p<<4&63)+"==";break;case 2:se=(se=(se+=ae((p=(m[m.length-2]<<8)+m[m.length-1])>>10))+ae(p>>4&63))+ae(p<<2&63)+"="}return se}})(o===void 0?this.base64js={}:o)}).call(this,t("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},t("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/base64-js/lib/b64.js","/node_modules/gulp-browserify/node_modules/base64-js/lib")},{buffer:3,lYpoI2:11}],3:[function(t,n,o){(function(r,s,C,h,y,O,x,$,M){var S=t("base64-js"),P=t("ieee754");function C(d,E,N){if(!(this instanceof C))return new C(d,E,N);var j,X,z,he,xe=typeof d;if(E==="base64"&&xe=="string")for(d=(he=d).trim?he.trim():he.replace(/^\s+|\s+$/g,"");d.length%4!=0;)d+="=";if(xe=="number")j=De(d);else if(xe=="string")j=C.byteLength(d,E);else{if(xe!="object")throw new Error("First argument needs to be a number, array or string.");j=De(d.length)}if(C._useTypedArrays?X=C._augment(new Uint8Array(j)):((X=this).length=j,X._isBuffer=!0),C._useTypedArrays&&typeof d.byteLength=="number")X._set(d);else if(Te(he=d)||C.isBuffer(he)||he&&typeof he=="object"&&typeof he.length=="number")for(z=0;z<j;z++)C.isBuffer(d)?X[z]=d.readUInt8(z):X[z]=d[z];else if(xe=="string")X.write(d,0,E);else if(xe=="number"&&!C._useTypedArrays&&!N)for(z=0;z<j;z++)X[z]=0;return X}function R(d,E,N,j){return C._charsWritten=ge(function(X){for(var z=[],he=0;he<X.length;he++)z.push(255&X.charCodeAt(he));return z}(E),d,N,j)}function L(d,E,N,j){return C._charsWritten=ge(function(X){for(var z,he,xe=[],Ee=0;Ee<X.length;Ee++)he=X.charCodeAt(Ee),z=he>>8,he=he%256,xe.push(he),xe.push(z);return xe}(E),d,N,j)}function B(d,E,N){var j="";N=Math.min(d.length,N);for(var X=E;X<N;X++)j+=String.fromCharCode(d[X]);return j}function H(d,E,N,z){z||(W(typeof N=="boolean","missing or invalid endian"),W(E!=null,"missing offset"),W(E+1<d.length,"Trying to read beyond buffer length"));var X,z=d.length;if(!(z<=E))return N?(X=d[E],E+1<z&&(X|=d[E+1]<<8)):(X=d[E]<<8,E+1<z&&(X|=d[E+1])),X}function ie(d,E,N,z){z||(W(typeof N=="boolean","missing or invalid endian"),W(E!=null,"missing offset"),W(E+3<d.length,"Trying to read beyond buffer length"));var X,z=d.length;if(!(z<=E))return N?(E+2<z&&(X=d[E+2]<<16),E+1<z&&(X|=d[E+1]<<8),X|=d[E],E+3<z&&(X+=d[E+3]<<24>>>0)):(E+1<z&&(X=d[E+1]<<16),E+2<z&&(X|=d[E+2]<<8),E+3<z&&(X|=d[E+3]),X+=d[E]<<24>>>0),X}function D(d,E,N,j){if(j||(W(typeof N=="boolean","missing or invalid endian"),W(E!=null,"missing offset"),W(E+1<d.length,"Trying to read beyond buffer length")),!(d.length<=E))return j=H(d,E,N,!0),32768&j?-1*(65535-j+1):j}function w(d,E,N,j){if(j||(W(typeof N=="boolean","missing or invalid endian"),W(E!=null,"missing offset"),W(E+3<d.length,"Trying to read beyond buffer length")),!(d.length<=E))return j=ie(d,E,N,!0),2147483648&j?-1*(4294967295-j+1):j}function m(d,E,N,j){return j||(W(typeof N=="boolean","missing or invalid endian"),W(E+3<d.length,"Trying to read beyond buffer length")),P.read(d,E,N,23,4)}function I(d,E,N,j){return j||(W(typeof N=="boolean","missing or invalid endian"),W(E+7<d.length,"Trying to read beyond buffer length")),P.read(d,E,N,52,8)}function p(d,E,N,j,X){if(X||(W(E!=null,"missing value"),W(typeof j=="boolean","missing or invalid endian"),W(N!=null,"missing offset"),W(N+1<d.length,"trying to write beyond buffer length"),de(E,65535)),X=d.length,!(X<=N))for(var z=0,he=Math.min(X-N,2);z<he;z++)d[N+z]=(E&255<<8*(j?z:1-z))>>>8*(j?z:1-z)}function _(d,E,N,j,X){if(X||(W(E!=null,"missing value"),W(typeof j=="boolean","missing or invalid endian"),W(N!=null,"missing offset"),W(N+3<d.length,"trying to write beyond buffer length"),de(E,4294967295)),X=d.length,!(X<=N))for(var z=0,he=Math.min(X-N,4);z<he;z++)d[N+z]=E>>>8*(j?z:3-z)&255}function k(d,E,N,j,X){X||(W(E!=null,"missing value"),W(typeof j=="boolean","missing or invalid endian"),W(N!=null,"missing offset"),W(N+1<d.length,"Trying to write beyond buffer length"),ye(E,32767,-32768)),d.length<=N||p(d,0<=E?E:65535+E+1,N,j,X)}function ce(d,E,N,j,X){X||(W(E!=null,"missing value"),W(typeof j=="boolean","missing or invalid endian"),W(N!=null,"missing offset"),W(N+3<d.length,"Trying to write beyond buffer length"),ye(E,2147483647,-2147483648)),d.length<=N||_(d,0<=E?E:4294967295+E+1,N,j,X)}function se(d,E,N,j,X){X||(W(E!=null,"missing value"),W(typeof j=="boolean","missing or invalid endian"),W(N!=null,"missing offset"),W(N+3<d.length,"Trying to write beyond buffer length"),we(E,34028234663852886e22,-34028234663852886e22)),d.length<=N||P.write(d,E,N,j,23,4)}function ae(d,E,N,j,X){X||(W(E!=null,"missing value"),W(typeof j=="boolean","missing or invalid endian"),W(N!=null,"missing offset"),W(N+7<d.length,"Trying to write beyond buffer length"),we(E,17976931348623157e292,-17976931348623157e292)),d.length<=N||P.write(d,E,N,j,52,8)}o.Buffer=C,o.SlowBuffer=C,o.INSPECT_MAX_BYTES=50,C.poolSize=8192,C._useTypedArrays=function(){try{var d=new ArrayBuffer(0),E=new Uint8Array(d);return E.foo=function(){return 42},E.foo()===42&&typeof E.subarray=="function"}catch{return!1}}(),C.isEncoding=function(d){switch(String(d).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"binary":case"base64":case"raw":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},C.isBuffer=function(d){return!(d==null||!d._isBuffer)},C.byteLength=function(d,E){var N;switch(d+="",E||"utf8"){case"hex":N=d.length/2;break;case"utf8":case"utf-8":N=re(d).length;break;case"ascii":case"binary":case"raw":N=d.length;break;case"base64":N=Ie(d).length;break;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":N=2*d.length;break;default:throw new Error("Unknown encoding")}return N},C.concat=function(d,E){if(W(Te(d),`Usage: Buffer.concat(list, [totalLength])
list should be an Array.`),d.length===0)return new C(0);if(d.length===1)return d[0];if(typeof E!="number")for(X=E=0;X<d.length;X++)E+=d[X].length;for(var N=new C(E),j=0,X=0;X<d.length;X++){var z=d[X];z.copy(N,j),j+=z.length}return N},C.prototype.write=function(d,E,N,j){isFinite(E)?isFinite(N)||(j=N,N=void 0):(Ee=j,j=E,E=N,N=Ee),E=Number(E)||0;var X,z,he,xe,Ee=this.length-E;switch((!N||Ee<(N=Number(N)))&&(N=Ee),j=String(j||"utf8").toLowerCase()){case"hex":X=function(He,Fe,Be,Me){Be=Number(Be)||0;var ve=He.length-Be;(!Me||ve<(Me=Number(Me)))&&(Me=ve),W((ve=Fe.length)%2==0,"Invalid hex string"),ve/2<Me&&(Me=ve/2);for(var Oe=0;Oe<Me;Oe++){var qe=parseInt(Fe.substr(2*Oe,2),16);W(!isNaN(qe),"Invalid hex string"),He[Be+Oe]=qe}return C._charsWritten=2*Oe,Oe}(this,d,E,N);break;case"utf8":case"utf-8":z=this,he=E,xe=N,X=C._charsWritten=ge(re(d),z,he,xe);break;case"ascii":case"binary":X=R(this,d,E,N);break;case"base64":z=this,he=E,xe=N,X=C._charsWritten=ge(Ie(d),z,he,xe);break;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":X=L(this,d,E,N);break;default:throw new Error("Unknown encoding")}return X},C.prototype.toString=function(d,E,N){var j,X,z,he,xe=this;if(d=String(d||"utf8").toLowerCase(),E=Number(E)||0,(N=N!==void 0?Number(N):xe.length)===E)return"";switch(d){case"hex":j=function(Ee,He,Fe){var Be=Ee.length;(!He||He<0)&&(He=0),(!Fe||Fe<0||Be<Fe)&&(Fe=Be);for(var Me="",ve=He;ve<Fe;ve++)Me+=Y(Ee[ve]);return Me}(xe,E,N);break;case"utf8":case"utf-8":j=function(Ee,He,Fe){var Be="",Me="";Fe=Math.min(Ee.length,Fe);for(var ve=He;ve<Fe;ve++)Ee[ve]<=127?(Be+=ue(Me)+String.fromCharCode(Ee[ve]),Me=""):Me+="%"+Ee[ve].toString(16);return Be+ue(Me)}(xe,E,N);break;case"ascii":case"binary":j=B(xe,E,N);break;case"base64":X=xe,he=N,j=(z=E)===0&&he===X.length?S.fromByteArray(X):S.fromByteArray(X.slice(z,he));break;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":j=function(Ee,He,Fe){for(var Be=Ee.slice(He,Fe),Me="",ve=0;ve<Be.length;ve+=2)Me+=String.fromCharCode(Be[ve]+256*Be[ve+1]);return Me}(xe,E,N);break;default:throw new Error("Unknown encoding")}return j},C.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}},C.prototype.copy=function(d,E,N,j){if(E=E||0,(j=j||j===0?j:this.length)!==(N=N||0)&&d.length!==0&&this.length!==0){W(N<=j,"sourceEnd < sourceStart"),W(0<=E&&E<d.length,"targetStart out of bounds"),W(0<=N&&N<this.length,"sourceStart out of bounds"),W(0<=j&&j<=this.length,"sourceEnd out of bounds"),j>this.length&&(j=this.length);var X=(j=d.length-E<j-N?d.length-E+N:j)-N;if(X<100||!C._useTypedArrays)for(var z=0;z<X;z++)d[z+E]=this[z+N];else d._set(this.subarray(N,N+X),E)}},C.prototype.slice=function(d,E){var N=this.length;if(d=Se(d,N,0),E=Se(E,N,N),C._useTypedArrays)return C._augment(this.subarray(d,E));for(var j=E-d,X=new C(j,void 0,!0),z=0;z<j;z++)X[z]=this[z+d];return X},C.prototype.get=function(d){return console.log(".get() is deprecated. Access using array indexes instead."),this.readUInt8(d)},C.prototype.set=function(d,E){return console.log(".set() is deprecated. Access using array indexes instead."),this.writeUInt8(d,E)},C.prototype.readUInt8=function(d,E){if(E||(W(d!=null,"missing offset"),W(d<this.length,"Trying to read beyond buffer length")),!(d>=this.length))return this[d]},C.prototype.readUInt16LE=function(d,E){return H(this,d,!0,E)},C.prototype.readUInt16BE=function(d,E){return H(this,d,!1,E)},C.prototype.readUInt32LE=function(d,E){return ie(this,d,!0,E)},C.prototype.readUInt32BE=function(d,E){return ie(this,d,!1,E)},C.prototype.readInt8=function(d,E){if(E||(W(d!=null,"missing offset"),W(d<this.length,"Trying to read beyond buffer length")),!(d>=this.length))return 128&this[d]?-1*(255-this[d]+1):this[d]},C.prototype.readInt16LE=function(d,E){return D(this,d,!0,E)},C.prototype.readInt16BE=function(d,E){return D(this,d,!1,E)},C.prototype.readInt32LE=function(d,E){return w(this,d,!0,E)},C.prototype.readInt32BE=function(d,E){return w(this,d,!1,E)},C.prototype.readFloatLE=function(d,E){return m(this,d,!0,E)},C.prototype.readFloatBE=function(d,E){return m(this,d,!1,E)},C.prototype.readDoubleLE=function(d,E){return I(this,d,!0,E)},C.prototype.readDoubleBE=function(d,E){return I(this,d,!1,E)},C.prototype.writeUInt8=function(d,E,N){N||(W(d!=null,"missing value"),W(E!=null,"missing offset"),W(E<this.length,"trying to write beyond buffer length"),de(d,255)),E>=this.length||(this[E]=d)},C.prototype.writeUInt16LE=function(d,E,N){p(this,d,E,!0,N)},C.prototype.writeUInt16BE=function(d,E,N){p(this,d,E,!1,N)},C.prototype.writeUInt32LE=function(d,E,N){_(this,d,E,!0,N)},C.prototype.writeUInt32BE=function(d,E,N){_(this,d,E,!1,N)},C.prototype.writeInt8=function(d,E,N){N||(W(d!=null,"missing value"),W(E!=null,"missing offset"),W(E<this.length,"Trying to write beyond buffer length"),ye(d,127,-128)),E>=this.length||(0<=d?this.writeUInt8(d,E,N):this.writeUInt8(255+d+1,E,N))},C.prototype.writeInt16LE=function(d,E,N){k(this,d,E,!0,N)},C.prototype.writeInt16BE=function(d,E,N){k(this,d,E,!1,N)},C.prototype.writeInt32LE=function(d,E,N){ce(this,d,E,!0,N)},C.prototype.writeInt32BE=function(d,E,N){ce(this,d,E,!1,N)},C.prototype.writeFloatLE=function(d,E,N){se(this,d,E,!0,N)},C.prototype.writeFloatBE=function(d,E,N){se(this,d,E,!1,N)},C.prototype.writeDoubleLE=function(d,E,N){ae(this,d,E,!0,N)},C.prototype.writeDoubleBE=function(d,E,N){ae(this,d,E,!1,N)},C.prototype.fill=function(d,E,N){if(E=E||0,N=N||this.length,W(typeof(d=typeof(d=d||0)=="string"?d.charCodeAt(0):d)=="number"&&!isNaN(d),"value is not a number"),W(E<=N,"end < start"),N!==E&&this.length!==0){W(0<=E&&E<this.length,"start out of bounds"),W(0<=N&&N<=this.length,"end out of bounds");for(var j=E;j<N;j++)this[j]=d}},C.prototype.inspect=function(){for(var d=[],E=this.length,N=0;N<E;N++)if(d[N]=Y(this[N]),N===o.INSPECT_MAX_BYTES){d[N+1]="...";break}return"<Buffer "+d.join(" ")+">"},C.prototype.toArrayBuffer=function(){if(typeof Uint8Array>"u")throw new Error("Buffer.toArrayBuffer not supported in this browser");if(C._useTypedArrays)return new C(this).buffer;for(var d=new Uint8Array(this.length),E=0,N=d.length;E<N;E+=1)d[E]=this[E];return d.buffer};var J=C.prototype;function Se(d,E,N){return typeof d!="number"?N:E<=(d=~~d)?E:0<=d||0<=(d+=E)?d:0}function De(d){return(d=~~Math.ceil(+d))<0?0:d}function Te(d){return(Array.isArray||function(E){return Object.prototype.toString.call(E)==="[object Array]"})(d)}function Y(d){return d<16?"0"+d.toString(16):d.toString(16)}function re(d){for(var E=[],N=0;N<d.length;N++){var j=d.charCodeAt(N);if(j<=127)E.push(d.charCodeAt(N));else for(var X=N,z=(55296<=j&&j<=57343&&N++,encodeURIComponent(d.slice(X,N+1)).substr(1).split("%")),he=0;he<z.length;he++)E.push(parseInt(z[he],16))}return E}function Ie(d){return S.toByteArray(d)}function ge(d,E,N,j){for(var X=0;X<j&&!(X+N>=E.length||X>=d.length);X++)E[X+N]=d[X];return X}function ue(d){try{return decodeURIComponent(d)}catch{return String.fromCharCode(65533)}}function de(d,E){W(typeof d=="number","cannot write a non-number as a number"),W(0<=d,"specified a negative value for writing an unsigned value"),W(d<=E,"value is larger than maximum value for type"),W(Math.floor(d)===d,"value has a fractional component")}function ye(d,E,N){W(typeof d=="number","cannot write a non-number as a number"),W(d<=E,"value larger than maximum allowed value"),W(N<=d,"value smaller than minimum allowed value"),W(Math.floor(d)===d,"value has a fractional component")}function we(d,E,N){W(typeof d=="number","cannot write a non-number as a number"),W(d<=E,"value larger than maximum allowed value"),W(N<=d,"value smaller than minimum allowed value")}function W(d,E){if(!d)throw new Error(E||"Failed assertion")}C._augment=function(d){return d._isBuffer=!0,d._get=d.get,d._set=d.set,d.get=J.get,d.set=J.set,d.write=J.write,d.toString=J.toString,d.toLocaleString=J.toString,d.toJSON=J.toJSON,d.copy=J.copy,d.slice=J.slice,d.readUInt8=J.readUInt8,d.readUInt16LE=J.readUInt16LE,d.readUInt16BE=J.readUInt16BE,d.readUInt32LE=J.readUInt32LE,d.readUInt32BE=J.readUInt32BE,d.readInt8=J.readInt8,d.readInt16LE=J.readInt16LE,d.readInt16BE=J.readInt16BE,d.readInt32LE=J.readInt32LE,d.readInt32BE=J.readInt32BE,d.readFloatLE=J.readFloatLE,d.readFloatBE=J.readFloatBE,d.readDoubleLE=J.readDoubleLE,d.readDoubleBE=J.readDoubleBE,d.writeUInt8=J.writeUInt8,d.writeUInt16LE=J.writeUInt16LE,d.writeUInt16BE=J.writeUInt16BE,d.writeUInt32LE=J.writeUInt32LE,d.writeUInt32BE=J.writeUInt32BE,d.writeInt8=J.writeInt8,d.writeInt16LE=J.writeInt16LE,d.writeInt16BE=J.writeInt16BE,d.writeInt32LE=J.writeInt32LE,d.writeInt32BE=J.writeInt32BE,d.writeFloatLE=J.writeFloatLE,d.writeFloatBE=J.writeFloatBE,d.writeDoubleLE=J.writeDoubleLE,d.writeDoubleBE=J.writeDoubleBE,d.fill=J.fill,d.inspect=J.inspect,d.toArrayBuffer=J.toArrayBuffer,d}}).call(this,t("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},t("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/buffer/index.js","/node_modules/gulp-browserify/node_modules/buffer")},{"base64-js":2,buffer:3,ieee754:10,lYpoI2:11}],4:[function(t,n,o){(function(r,s,S,h,y,O,x,$,M){var S=t("buffer").Buffer,P=4,C=new S(P);C.fill(0),n.exports={hash:function(R,L,B,H){for(var ie=L(function(p,_){p.length%P!=0&&(k=p.length+(P-p.length%P),p=S.concat([p,C],k));for(var k,ce=[],se=_?p.readInt32BE:p.readInt32LE,ae=0;ae<p.length;ae+=P)ce.push(se.call(p,ae));return ce}(R=S.isBuffer(R)?R:new S(R),H),8*R.length),L=H,D=new S(B),w=L?D.writeInt32BE:D.writeInt32LE,m=0;m<ie.length;m++)w.call(D,ie[m],4*m,!0);return D}}}).call(this,t("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},t("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/crypto-browserify/helpers.js","/node_modules/gulp-browserify/node_modules/crypto-browserify")},{buffer:3,lYpoI2:11}],5:[function(t,n,o){(function(r,s,S,h,y,O,x,$,M){var S=t("buffer").Buffer,P=t("./sha"),C=t("./sha256"),R=t("./rng"),L={sha1:P,sha256:C,md5:t("./md5")},B=64,H=new S(B);function ie(p,_){var k=L[p=p||"sha1"],ce=[];return k||D("algorithm:",p,"is not yet supported"),{update:function(se){return S.isBuffer(se)||(se=new S(se)),ce.push(se),se.length,this},digest:function(se){var ae=S.concat(ce),ae=_?function(J,Se,De){S.isBuffer(Se)||(Se=new S(Se)),S.isBuffer(De)||(De=new S(De)),Se.length>B?Se=J(Se):Se.length<B&&(Se=S.concat([Se,H],B));for(var Te=new S(B),Y=new S(B),re=0;re<B;re++)Te[re]=54^Se[re],Y[re]=92^Se[re];return De=J(S.concat([Te,De])),J(S.concat([Y,De]))}(k,_,ae):k(ae);return ce=null,se?ae.toString(se):ae}}}function D(){var p=[].slice.call(arguments).join(" ");throw new Error([p,"we accept pull requests","http://github.com/dominictarr/crypto-browserify"].join(`
`))}H.fill(0),o.createHash=function(p){return ie(p)},o.createHmac=ie,o.randomBytes=function(p,_){if(!_||!_.call)return new S(R(p));try{_.call(this,void 0,new S(R(p)))}catch(k){_(k)}};var w,m=["createCredentials","createCipher","createCipheriv","createDecipher","createDecipheriv","createSign","createVerify","createDiffieHellman","pbkdf2"],I=function(p){o[p]=function(){D("sorry,",p,"is not implemented yet")}};for(w in m)I(m[w])}).call(this,t("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},t("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/crypto-browserify/index.js","/node_modules/gulp-browserify/node_modules/crypto-browserify")},{"./md5":6,"./rng":7,"./sha":8,"./sha256":9,buffer:3,lYpoI2:11}],6:[function(t,n,o){(function(r,s,u,h,y,O,x,$,M){var S=t("./helpers");function P(D,w){D[w>>5]|=128<<w%32,D[14+(w+64>>>9<<4)]=w;for(var m=1732584193,I=-271733879,p=-1732584194,_=271733878,k=0;k<D.length;k+=16){var ce=m,se=I,ae=p,J=_,m=R(m,I,p,_,D[k+0],7,-680876936),_=R(_,m,I,p,D[k+1],12,-389564586),p=R(p,_,m,I,D[k+2],17,606105819),I=R(I,p,_,m,D[k+3],22,-1044525330);m=R(m,I,p,_,D[k+4],7,-176418897),_=R(_,m,I,p,D[k+5],12,1200080426),p=R(p,_,m,I,D[k+6],17,-1473231341),I=R(I,p,_,m,D[k+7],22,-45705983),m=R(m,I,p,_,D[k+8],7,1770035416),_=R(_,m,I,p,D[k+9],12,-1958414417),p=R(p,_,m,I,D[k+10],17,-42063),I=R(I,p,_,m,D[k+11],22,-1990404162),m=R(m,I,p,_,D[k+12],7,1804603682),_=R(_,m,I,p,D[k+13],12,-40341101),p=R(p,_,m,I,D[k+14],17,-1502002290),m=L(m,I=R(I,p,_,m,D[k+15],22,1236535329),p,_,D[k+1],5,-165796510),_=L(_,m,I,p,D[k+6],9,-1069501632),p=L(p,_,m,I,D[k+11],14,643717713),I=L(I,p,_,m,D[k+0],20,-373897302),m=L(m,I,p,_,D[k+5],5,-701558691),_=L(_,m,I,p,D[k+10],9,38016083),p=L(p,_,m,I,D[k+15],14,-660478335),I=L(I,p,_,m,D[k+4],20,-405537848),m=L(m,I,p,_,D[k+9],5,568446438),_=L(_,m,I,p,D[k+14],9,-1019803690),p=L(p,_,m,I,D[k+3],14,-187363961),I=L(I,p,_,m,D[k+8],20,1163531501),m=L(m,I,p,_,D[k+13],5,-1444681467),_=L(_,m,I,p,D[k+2],9,-51403784),p=L(p,_,m,I,D[k+7],14,1735328473),m=B(m,I=L(I,p,_,m,D[k+12],20,-1926607734),p,_,D[k+5],4,-378558),_=B(_,m,I,p,D[k+8],11,-2022574463),p=B(p,_,m,I,D[k+11],16,1839030562),I=B(I,p,_,m,D[k+14],23,-35309556),m=B(m,I,p,_,D[k+1],4,-1530992060),_=B(_,m,I,p,D[k+4],11,1272893353),p=B(p,_,m,I,D[k+7],16,-155497632),I=B(I,p,_,m,D[k+10],23,-1094730640),m=B(m,I,p,_,D[k+13],4,681279174),_=B(_,m,I,p,D[k+0],11,-358537222),p=B(p,_,m,I,D[k+3],16,-722521979),I=B(I,p,_,m,D[k+6],23,76029189),m=B(m,I,p,_,D[k+9],4,-640364487),_=B(_,m,I,p,D[k+12],11,-421815835),p=B(p,_,m,I,D[k+15],16,530742520),m=H(m,I=B(I,p,_,m,D[k+2],23,-995338651),p,_,D[k+0],6,-198630844),_=H(_,m,I,p,D[k+7],10,1126891415),p=H(p,_,m,I,D[k+14],15,-1416354905),I=H(I,p,_,m,D[k+5],21,-57434055),m=H(m,I,p,_,D[k+12],6,1700485571),_=H(_,m,I,p,D[k+3],10,-1894986606),p=H(p,_,m,I,D[k+10],15,-1051523),I=H(I,p,_,m,D[k+1],21,-2054922799),m=H(m,I,p,_,D[k+8],6,1873313359),_=H(_,m,I,p,D[k+15],10,-30611744),p=H(p,_,m,I,D[k+6],15,-1560198380),I=H(I,p,_,m,D[k+13],21,1309151649),m=H(m,I,p,_,D[k+4],6,-145523070),_=H(_,m,I,p,D[k+11],10,-1120210379),p=H(p,_,m,I,D[k+2],15,718787259),I=H(I,p,_,m,D[k+9],21,-343485551),m=ie(m,ce),I=ie(I,se),p=ie(p,ae),_=ie(_,J)}return Array(m,I,p,_)}function C(D,w,m,I,p,_){return ie((w=ie(ie(w,D),ie(I,_)))<<p|w>>>32-p,m)}function R(D,w,m,I,p,_,k){return C(w&m|~w&I,D,w,p,_,k)}function L(D,w,m,I,p,_,k){return C(w&I|m&~I,D,w,p,_,k)}function B(D,w,m,I,p,_,k){return C(w^m^I,D,w,p,_,k)}function H(D,w,m,I,p,_,k){return C(m^(w|~I),D,w,p,_,k)}function ie(D,w){var m=(65535&D)+(65535&w);return(D>>16)+(w>>16)+(m>>16)<<16|65535&m}n.exports=function(D){return S.hash(D,P,16)}}).call(this,t("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},t("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/crypto-browserify/md5.js","/node_modules/gulp-browserify/node_modules/crypto-browserify")},{"./helpers":4,buffer:3,lYpoI2:11}],7:[function(t,n,o){(function(r,s,u,h,y,O,x,$,M){n.exports=function(S){for(var P,C=new Array(S),R=0;R<S;R++)!(3&R)&&(P=4294967296*Math.random()),C[R]=P>>>((3&R)<<3)&255;return C}}).call(this,t("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},t("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/crypto-browserify/rng.js","/node_modules/gulp-browserify/node_modules/crypto-browserify")},{buffer:3,lYpoI2:11}],8:[function(t,n,o){(function(r,s,u,h,y,O,x,$,M){var S=t("./helpers");function P(L,B){L[B>>5]|=128<<24-B%32,L[15+(B+64>>9<<4)]=B;for(var H,ie,D,w=Array(80),m=1732584193,I=-271733879,p=-1732584194,_=271733878,k=-1009589776,ce=0;ce<L.length;ce+=16){for(var se=m,ae=I,J=p,Se=_,De=k,Te=0;Te<80;Te++){w[Te]=Te<16?L[ce+Te]:R(w[Te-3]^w[Te-8]^w[Te-14]^w[Te-16],1);var Y=C(C(R(m,5),(Y=I,ie=p,D=_,(H=Te)<20?Y&ie|~Y&D:!(H<40)&&H<60?Y&ie|Y&D|ie&D:Y^ie^D)),C(C(k,w[Te]),(H=Te)<20?1518500249:H<40?1859775393:H<60?-1894007588:-899497514)),k=_,_=p,p=R(I,30),I=m,m=Y}m=C(m,se),I=C(I,ae),p=C(p,J),_=C(_,Se),k=C(k,De)}return Array(m,I,p,_,k)}function C(L,B){var H=(65535&L)+(65535&B);return(L>>16)+(B>>16)+(H>>16)<<16|65535&H}function R(L,B){return L<<B|L>>>32-B}n.exports=function(L){return S.hash(L,P,20,!0)}}).call(this,t("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},t("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/crypto-browserify/sha.js","/node_modules/gulp-browserify/node_modules/crypto-browserify")},{"./helpers":4,buffer:3,lYpoI2:11}],9:[function(t,n,o){(function(r,s,u,h,y,O,x,$,M){function S(B,H){var ie=(65535&B)+(65535&H);return(B>>16)+(H>>16)+(ie>>16)<<16|65535&ie}function P(B,H){var ie,D=new Array(1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298),w=new Array(1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225),m=new Array(64);B[H>>5]|=128<<24-H%32,B[15+(H+64>>9<<4)]=H;for(var I,p,_=0;_<B.length;_+=16){for(var k=w[0],ce=w[1],se=w[2],ae=w[3],J=w[4],Se=w[5],De=w[6],Te=w[7],Y=0;Y<64;Y++)m[Y]=Y<16?B[Y+_]:S(S(S((p=m[Y-2],R(p,17)^R(p,19)^L(p,10)),m[Y-7]),(p=m[Y-15],R(p,7)^R(p,18)^L(p,3))),m[Y-16]),ie=S(S(S(S(Te,R(p=J,6)^R(p,11)^R(p,25)),J&Se^~J&De),D[Y]),m[Y]),I=S(R(I=k,2)^R(I,13)^R(I,22),k&ce^k&se^ce&se),Te=De,De=Se,Se=J,J=S(ae,ie),ae=se,se=ce,ce=k,k=S(ie,I);w[0]=S(k,w[0]),w[1]=S(ce,w[1]),w[2]=S(se,w[2]),w[3]=S(ae,w[3]),w[4]=S(J,w[4]),w[5]=S(Se,w[5]),w[6]=S(De,w[6]),w[7]=S(Te,w[7])}return w}var C=t("./helpers"),R=function(B,H){return B>>>H|B<<32-H},L=function(B,H){return B>>>H};n.exports=function(B){return C.hash(B,P,32,!0)}}).call(this,t("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},t("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/crypto-browserify/sha256.js","/node_modules/gulp-browserify/node_modules/crypto-browserify")},{"./helpers":4,buffer:3,lYpoI2:11}],10:[function(t,n,o){(function(r,s,u,h,y,O,x,$,M){o.read=function(S,P,C,R,_){var B,H,ie=8*_-R-1,D=(1<<ie)-1,w=D>>1,m=-7,I=C?_-1:0,p=C?-1:1,_=S[P+I];for(I+=p,B=_&(1<<-m)-1,_>>=-m,m+=ie;0<m;B=256*B+S[P+I],I+=p,m-=8);for(H=B&(1<<-m)-1,B>>=-m,m+=R;0<m;H=256*H+S[P+I],I+=p,m-=8);if(B===0)B=1-w;else{if(B===D)return H?NaN:1/0*(_?-1:1);H+=Math.pow(2,R),B-=w}return(_?-1:1)*H*Math.pow(2,B-R)},o.write=function(S,P,C,R,L,k){var H,ie,D=8*k-L-1,w=(1<<D)-1,m=w>>1,I=L===23?Math.pow(2,-24)-Math.pow(2,-77):0,p=R?0:k-1,_=R?1:-1,k=P<0||P===0&&1/P<0?1:0;for(P=Math.abs(P),isNaN(P)||P===1/0?(ie=isNaN(P)?1:0,H=w):(H=Math.floor(Math.log(P)/Math.LN2),P*(R=Math.pow(2,-H))<1&&(H--,R*=2),2<=(P+=1<=H+m?I/R:I*Math.pow(2,1-m))*R&&(H++,R/=2),w<=H+m?(ie=0,H=w):1<=H+m?(ie=(P*R-1)*Math.pow(2,L),H+=m):(ie=P*Math.pow(2,m-1)*Math.pow(2,L),H=0));8<=L;S[C+p]=255&ie,p+=_,ie/=256,L-=8);for(H=H<<L|ie,D+=L;0<D;S[C+p]=255&H,p+=_,H/=256,D-=8);S[C+p-_]|=128*k}}).call(this,t("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},t("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/ieee754/index.js","/node_modules/gulp-browserify/node_modules/ieee754")},{buffer:3,lYpoI2:11}],11:[function(t,n,o){(function(r,s,u,h,y,O,x,$,M){var S,P,C;function R(){}(r=n.exports={}).nextTick=(P=typeof window<"u"&&window.setImmediate,C=typeof window<"u"&&window.postMessage&&window.addEventListener,P?function(L){return window.setImmediate(L)}:C?(S=[],window.addEventListener("message",function(L){var B=L.source;B!==window&&B!==null||L.data!=="process-tick"||(L.stopPropagation(),0<S.length&&S.shift()())},!0),function(L){S.push(L),window.postMessage("process-tick","*")}):function(L){setTimeout(L,0)}),r.title="browser",r.browser=!0,r.env={},r.argv=[],r.on=R,r.addListener=R,r.once=R,r.off=R,r.removeListener=R,r.removeAllListeners=R,r.emit=R,r.binding=function(L){throw new Error("process.binding is not supported")},r.cwd=function(){return"/"},r.chdir=function(L){throw new Error("process.chdir is not supported")}}).call(this,t("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},t("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/process/browser.js","/node_modules/gulp-browserify/node_modules/process")},{buffer:3,lYpoI2:11}]},{},[1])(1)})})(po);var Ma=po.exports;const qt=jn(Ma);class $a{cache;useHash;constructor(e){this.cache={},this.useHash=e}cacheValue(e,t){this.cache[this.useHash?qt(e):String(e)]=t}deleteValue(e){delete this.cache[this.useHash?qt(e):String(e)]}getValue(e){return this.cache[this.useHash?qt(e):String(e)]}isCached(e){return(this.useHash?qt(e):String(e))in this.cache}invalidate(e){e&&Object.entries(this.cache).forEach(([t,n])=>e(t,n)),this.cache={}}}function Pa(){return new Worker("/assets/worker-b3cb1e7d.js",{type:"module"})}class Ne{static PLAYER="PLAYER";static PARTY="PARTY";static SCENEITEMS="SCENEITEMS";static SCENELOCAL="SCENELOCAL";static SCENEMETA="SCENEMETADATA";static SCENEGRID="SCENEGRID";static SCENEFOG="SCENEFOG";static ROOMMETA="ROOMMETADATA";playerId;playerColor;playerName;playerMetadata;playerRole;party;lastParty;fogFilled;fogColor;fogStroke;gridDpi;gridScale;gridSnap;gridType;storedMetaItems;sceneItems;sceneLocal;sceneSelected;sceneMetadata;sceneReady;sceneInitialized;roomMetadata;theme;caches;playerShadowCache;localGhosts;snap;torchActive;previousVisionShapes;previousAutohideItems;previousPlayersWithVision;previousSize=[];previousVisionEnabled;previousMap;previousAutodetectEnabled;previousFowEnabled;previousPersistenceEnabled;previousFowColor;busy;workers;workersSetup;toolStarted;sceneMetadataHandler;sceneItemsHandler;sceneLocalHandler;sceneGridHandler;sceneReadyHandler;playerHandler;partyHandler;themeHandler;roomHandler;fogHandler;constructor(e){this.playerId="",this.playerName="",this.playerColor="",this.playerMetadata={},this.playerRole="PLAYER",this.party=[],this.lastParty=[],this.fogFilled=!1,this.fogColor="#000",this.fogStroke=5,this.storedMetaItems=[],this.sceneItems=[],this.sceneLocal=[],this.sceneSelected=[],this.sceneMetadata={},this.gridDpi=0,this.gridScale=5,this.gridSnap=10,this.gridType="ft",this.sceneReady=!1,this.sceneInitialized=!1,this.theme="DARK",this.roomMetadata={},this.localGhosts=[],this.snap=!1,this.busy=!1,this.torchActive=!1,this.toolStarted=!1,this.caches=e,this.playerShadowCache=new $a(!1),this.previousVisionShapes="",this.previousAutohideItems="",this.previousPlayersWithVision="",this.previousSize=[],this.previousVisionEnabled=!1,this.previousMap="",this.previousAutodetectEnabled=!1,this.previousFowEnabled=!1,this.previousPersistenceEnabled=!1,this.previousFowColor="",this.workers=[],this.workersSetup=!1}async RefreshCache(){if(this.caches.includes(Ne.PLAYER)&&(this.playerId=await b.player.getId(),this.playerName=await b.player.getName(),this.playerColor=await b.player.getColor(),this.playerMetadata=await b.player.getMetadata(),this.playerRole=await b.player.getRole()),this.caches.includes(Ne.PARTY)&&(this.party=await b.party.getPlayers()),this.caches.includes(Ne.SCENEFOG)&&this.sceneReady&&(this.fogColor=await b.scene.fog.getColor(),this.fogFilled=await b.scene.fog.getFilled()),this.caches.includes(Ne.SCENEITEMS)&&this.sceneReady&&(this.sceneItems=await b.scene.items.getItems(),this.sceneLocal=await b.scene.local.getItems()),this.caches.includes(Ne.SCENEMETA)&&this.sceneReady){this.sceneMetadata=await b.scene.getMetadata();const e=this.sceneMetadata[`${c.EXTENSIONID}/stored`];e&&(this.storedMetaItems=e)}if(this.caches.includes(Ne.SCENEGRID)&&this.sceneReady){this.gridDpi=await b.scene.grid.getDpi();const e=await b.scene.grid.getScale();this.gridScale=e.parsed?.multiplier??5,this.gridType=e.parsed.unit}this.caches.includes(Ne.ROOMMETA)&&this.sceneReady&&(this.roomMetadata=await b.room.getMetadata())}async InitializeCache(){if(this.CreateWorkers(),this.sceneReady=await b.scene.isReady(),this.theme=await b.theme.getTheme(),wi(this.theme,document),this.caches.includes(Ne.PLAYER)&&(this.playerId=await b.player.getId(),this.playerName=await b.player.getName(),this.playerColor=await b.player.getColor(),this.playerMetadata=await b.player.getMetadata(),this.playerRole=await b.player.getRole()),this.caches.includes(Ne.PARTY)&&(this.party=await b.party.getPlayers()),this.caches.includes(Ne.SCENEFOG)&&this.sceneReady&&(this.fogColor=await b.scene.fog.getColor(),this.fogFilled=await b.scene.fog.getFilled()),this.caches.includes(Ne.SCENEITEMS)&&this.sceneReady&&(this.sceneItems=await b.scene.items.getItems(),this.sceneLocal=await b.scene.local.getItems()),this.caches.includes(Ne.SCENEMETA)&&this.sceneReady){this.sceneMetadata=await b.scene.getMetadata();const e=this.sceneMetadata[`${c.EXTENSIONID}/stored`];e&&(this.storedMetaItems=e)}if(this.caches.includes(Ne.SCENEGRID)&&this.sceneReady){this.gridDpi=await b.scene.grid.getDpi();const e=await b.scene.grid.getScale();this.gridScale=e.parsed?.multiplier??5,this.gridType=e.parsed.unit}this.caches.includes(Ne.ROOMMETA)&&this.sceneReady&&(this.roomMetadata=await b.room.getMetadata()),b.broadcast.onMessage(c.RESETID,async e=>{e.data&&await Z.ResetPersistence()}),b.broadcast.onMessage(`${c.EXTENSIONID}/ELEVATIONEVENT`,e=>{switch(e.data){case"CANCEL":Jn();break;case"FINISH":co();break;case"UNDO":uo();break}}),b.broadcast.onMessage(`${c.EXTENSIONID}/LINEEVENT`,e=>{switch(e.data){case"CANCEL":Bn();break;case"FINISH":Vn();break;case"UNDO":io();break}}),b.broadcast.onMessage(`${c.EXTENSIONID}/POLYGONEVENT`,e=>{switch(e.data){case"CANCEL":Hn();break;case"FINISH":Un();break;case"UNDO":ro();break}}),await this.SaveUserToScene()}CreateWorkers(){const t=Math.min(navigator.hardwareConcurrency??1,16);for(let n=0;n<t;n++){const o=new Pa;this.workers.push(o)}}async SaveUserToScene(){await b.scene.setMetadata({[`${c.EXTENSIONID}/USER-${this.playerId}`]:{role:this.playerRole,name:this.playerName,color:this.playerColor}})}KillHandlers(){this.caches.includes(Ne.SCENEMETA)&&this.sceneMetadataHandler!==void 0&&this.sceneMetadataHandler(),this.caches.includes(Ne.SCENEITEMS)&&this.sceneItemsHandler!==void 0&&this.sceneItemsHandler(),this.caches.includes(Ne.SCENEITEMS)&&this.sceneLocalHandler!==void 0&&this.sceneLocalHandler(),this.caches.includes(Ne.SCENEGRID)&&this.sceneGridHandler!==void 0&&this.sceneGridHandler(),this.caches.includes(Ne.PLAYER)&&this.playerHandler!==void 0&&this.playerHandler(),this.caches.includes(Ne.PARTY)&&this.partyHandler!==void 0&&this.partyHandler(),this.caches.includes(Ne.ROOMMETA)&&this.roomHandler!==void 0&&this.roomHandler(),this.caches.includes(Ne.SCENEFOG)&&this.fogHandler!==void 0&&this.fogHandler(),this.themeHandler!==void 0&&this.themeHandler()}SetupHandlers(){(this.sceneMetadataHandler===void 0||this.sceneMetadataHandler.length===0)&&this.caches.includes(Ne.SCENEMETA)&&(this.sceneMetadataHandler=b.scene.onMetadataChange(async e=>{this.sceneMetadata=e,await this.OnSceneMetadataChanges(e)})),(this.sceneItemsHandler===void 0||this.sceneItemsHandler.length===0)&&this.caches.includes(Ne.SCENEITEMS)&&(this.sceneItemsHandler=b.scene.items.onChange(async e=>{this.sceneItems=e,await this.OnSceneItemsChange(e)}),this.sceneLocalHandler=b.scene.local.onChange(async e=>{this.sceneLocal=e,await this.OnSceneLocalChange(e)})),(this.sceneGridHandler===void 0||this.sceneGridHandler.length===0)&&this.caches.includes(Ne.SCENEGRID)&&(this.sceneGridHandler=b.scene.grid.onChange(async e=>{await this.OnSceneGridChange(e),this.gridDpi=e.dpi,this.gridScale=parseInt(e.scale)})),(this.playerHandler===void 0||this.playerHandler.length===0)&&this.caches.includes(Ne.PLAYER)&&(this.playerHandler=b.player.onChange(async e=>{const t=this.playerRole;let n=!1;(this.playerName!==e.name||this.playerColor!==e.color||this.playerRole!==e.role)&&(n=!0),this.playerName=e.name,this.playerColor=e.color,this.playerId=e.id,this.playerRole=e.role,this.playerMetadata=e.metadata,await this.OnPlayerChange(e,t),n&&await this.SaveUserToScene()})),(this.partyHandler===void 0||this.partyHandler.length===0)&&this.caches.includes(Ne.PARTY)&&(this.partyHandler=b.party.onChange(async e=>{this.party=e.filter(t=>t.id!==""),await this.OnPartyChange(e)})),(this.roomHandler===void 0||this.roomHandler.length===0)&&this.caches.includes(Ne.ROOMMETA)&&(this.roomHandler=b.room.onMetadataChange(async e=>{await this.OnRoomMetadataChange(e),this.roomMetadata=e})),(this.fogHandler===void 0||this.fogHandler.length===0)&&this.caches.includes(Ne.ROOMMETA)&&(this.fogHandler=b.scene.fog.onChange(async e=>{await this.OnFogChange(e),this.fogColor=e.style.color,this.fogFilled=e.filled})),this.themeHandler===void 0&&(this.themeHandler=b.theme.onChange(async e=>{this.theme=e.mode,await this.OnThemeChange(e)})),this.sceneReadyHandler===void 0&&(this.sceneReadyHandler=b.scene.onReadyChange(async e=>{this.sceneReady=e,e?(await this.SaveUserToScene(),await this.RefreshCache()):(dt.ClearGhostList(),this.KillHandlers(),this.toolStarted=!1,await b.tool.setMetadata(`${c.EXTENSIONID}/vision-tool`,{[`${c.EXTENSIONID}/elevationEditor`]:!1}),this.sceneItems=[],this.sceneMetadata={}),await this.OnSceneReadyChange(e)}))}async OnSceneMetadataChanges(e){this.playerRole==="GM"&&await $n(),await St()}async OnSceneItemsChange(e){this.playerRole==="GM"?(await Z.UpdateUI(),await Pn(Z.mapAlign)):Z.UpdatePlayerVisionList(),await St()}async OnSceneLocalChange(e){dt.debouncedLocalChanges(g.sceneLocal)}async OnSceneGridChange(e){await St()}async OnSceneReadyChange(e){e?(await Fn(),this.SetupHandlers(),await St(),this.playerRole==="GM"&&await $n()):this.playerRole==="GM"&&(this.sceneInitialized=!1,await Z.UpdateUI())}async OnPlayerChange(e,t){this.playerRole!==t&&(await Z.SoftReset(),e.role==="GM"?(await b.action.setHeight(510),await b.action.setWidth(420)):Z.UpdatePlayerVisionList());const n=document.querySelectorAll(".token-table-entry");for(let y of n){let O=y.id.substring(3);e.selection!==void 0&&e.selection.includes(O)?y.classList.add("token-table-selected"):y.classList.remove("token-table-selected")}e.selection!==void 0&&e.selection.length===1&&Yo(e.selection[0]);const o=e.metadata;(o[`${c.EXTENSIONID}/finishLine`]??!1)===!0&&Vn(),(o[`${c.EXTENSIONID}/cancelLine`]??!1)===!0&&Bn(),(o[`${c.EXTENSIONID}/finishPoly`]??!1)===!0&&Un(),(o[`${c.EXTENSIONID}/cancelPoly`]??!1)===!0&&Hn()}async OnPartyChange(e){if(this.playerRole!=="PLAYER"){const t=document.getElementById("playerListing");t.innerHTML="",t.appendChild(Z.GetEmptyContextItem());for(const n of this.party){const o=document.createElement("li");o.id=n.id,o.textContent=n.name,o.style.color=n.color,t.appendChild(o)}dt.UpdateSpectreTargets(),Z.UpdatePlayerProcessUI()}}async OnFogChange(e){}async OnRoomMetadataChange(e){}async OnThemeChange(e){wi(e,document)}async ToggleBusy(e){await b.action.setBadgeText(e?"⏱️":void 0),g.busy=e}}const g=new Ne([Ne.SCENEITEMS,Ne.SCENEMETA,Ne.SCENEFOG,Ne.SCENEGRID,Ne.PLAYER,Ne.PARTY]);function La(i){return i.layer=="MAP"&&(i.metadata[`${c.EXTENSIONID}/isBackgroundImage`]||i.metadata[`${c.ARMINDOID}/isBackgroundImage`])}function At(i){return i.metadata[`${c.EXTENSIONID}/isVisionFog`]||i.metadata[`${c.ARMINDOID}/isVisionFog`]}function Ra(i){return i.metadata[`${c.EXTENSIONID}/isIndicatorRing`]||i.metadata[`${c.ARMINDOID}/isIndicatorRing`]}function Pi(i){return i.metadata[`${c.EXTENSIONID}/isVisionLine`]||i.metadata[`${c.ARMINDOID}/isVisionLine`]}function Xa(i){return i.metadata[`${c.EXTENSIONID}/isVisionLine`]&&!i.metadata[`${c.EXTENSIONID}/disabled`]||i.metadata[`${c.ARMINDOID}/isVisionLine`]&&!i.metadata[`${c.ARMINDOID}/disabled`]}function go(i){return(i.layer==="CHARACTER"||i.layer==="MOUNT"||i.layer==="ATTACHMENT"||i.layer==="PROP")&&(i.metadata[`${c.EXTENSIONID}/hasVision`]||i.metadata[`${c.ARMINDOID}/hasVision`])}function Li(i){return(i.layer==="CHARACTER"||i.layer==="MOUNT"||i.layer==="ATTACHMENT"||i.layer==="PROP")&&(i.metadata[`${c.EXTENSIONID}/hasVision`]||i.metadata[`${c.ARMINDOID}/hasVision`])&&!i.metadata[`${c.EXTENSIONID}/visionBlind`]}function Fa(i){return(i.layer==="CHARACTER"||i.layer==="MOUNT"||i.layer==="ATTACHMENT"||i.layer==="PROP")&&i.createdUserId==g.playerId&&(i.metadata[`${c.EXTENSIONID}/hasVision`]||i.metadata[`${c.ARMINDOID}/hasVision`])&&!i.metadata[`${c.EXTENSIONID}/visionBlind`]}function mo(i){return(i.layer==="DRAWING"||i.layer==="MAP")&&(i.metadata[`${c.EXTENSIONID}/isBackgroundImage`]||i.metadata[`${c.ARMINDOID}/isBackgroundImage`])}function Zt(i){return i.metadata[`${c.EXTENSIONID}/isTrailingFog`]}function Gn(i){return i.metadata[`${c.EXTENSIONID}/isTrailingFog`]||i.metadata[`${c.EXTENSIONID}/isVisionFog`]||i.metadata[`${c.ARMINDOID}/isVisionFog`]||i.metadata[`${c.EXTENSIONID}/isIndicatorRing`]}function Ba(i){return i.metadata[`${c.EXTENSIONID}/isBrushSquare`]}function Tt(i){return i.metadata[`${c.EXTENSIONID}/visionTorch`]}function Ri(i){return(i.layer==="CHARACTER"||i.layer==="MOUNT"||i.layer==="ATTACHMENT"||i.layer==="PROP")&&!go(i)&&i.metadata[`${c.EXTENSIONID}/hasAutohide`]===!0}var rt=function(){/*!
* Copyright (c) 2021-2023 Momo Bassit.
* Licensed under the MIT License (MIT)
* https://github.com/mdbassit/Coloris
* Version: 0.21.1
* NPM: https://github.com/melloware/coloris-npm
*/return function(i,e,t,n){var o=e.createElement("canvas").getContext("2d"),r={r:0,g:0,b:0,h:0,s:0,v:0,a:1},s,u,h,y,O,x,$,M,S,P,C,R,L,B,H,ie,D={},w={el:"[data-coloris]",parent:"body",theme:"default",themeMode:"light",rtl:!1,wrap:!0,margin:2,format:"hex",formatToggle:!1,swatches:[],swatchesOnly:!1,alpha:!0,forceAlpha:!1,focusInput:!0,selectInput:!1,inline:!1,defaultColor:"#000000",clearButton:!1,clearLabel:"Clear",closeButton:!1,closeLabel:"Close",onChange:function(){return n},a11y:{open:"Open color picker",close:"Close color picker",clear:"Clear the selected color",marker:"Saturation: {s}. Brightness: {v}.",hueSlider:"Hue slider",alphaSlider:"Opacity slider",input:"Color value field",format:"Color format",swatch:"Color swatch",instruction:"Saturation and brightness selector. Use up, down, left and right arrow keys to select."}},m={},I="",p={},_=!1;function k(T){if(typeof T=="object"){var V=function(){switch(G){case"el":Se(T.el),T.wrap!==!1&&Te(T.el);break;case"parent":s=e.querySelector(T.parent),s&&(s.appendChild(u),w.parent=T.parent,s===e.body&&(s=n));break;case"themeMode":w.themeMode=T.themeMode,T.themeMode==="auto"&&i.matchMedia&&i.matchMedia("(prefers-color-scheme: dark)").matches&&(w.themeMode="dark");case"theme":T.theme&&(w.theme=T.theme),u.className="clr-picker clr-"+w.theme+" clr-"+w.themeMode,w.inline&&De();break;case"rtl":w.rtl=!!T.rtl,e.querySelectorAll(".clr-field").forEach(function(Ge){return Ge.classList.toggle("clr-rtl",w.rtl)});break;case"margin":T.margin*=1,w.margin=isNaN(T.margin)?w.margin:T.margin;break;case"wrap":T.el&&T.wrap&&Te(T.el);break;case"formatToggle":w.formatToggle=!!T.formatToggle,ve("clr-format").style.display=w.formatToggle?"block":"none",w.formatToggle&&(w.format="auto");break;case"swatches":if(Array.isArray(T.swatches)){var oe=[];T.swatches.forEach(function(Ge,ke){oe.push('<button type="button" id="clr-swatch-'+ke+'" aria-labelledby="clr-swatch-label clr-swatch-'+ke+'" style="color: '+Ge+';">'+Ge+"</button>")}),ve("clr-swatches").innerHTML=oe.length?"<div>"+oe.join("")+"</div>":"",w.swatches=T.swatches.slice()}break;case"swatchesOnly":w.swatchesOnly=!!T.swatchesOnly,u.setAttribute("data-minimal",w.swatchesOnly);break;case"alpha":w.alpha=!!T.alpha,u.setAttribute("data-alpha",w.alpha);break;case"inline":if(w.inline=!!T.inline,u.setAttribute("data-inline",w.inline),w.inline){var fe=T.defaultColor||w.defaultColor;B=Ie(fe),De(),re(fe)}break;case"clearButton":typeof T.clearButton=="object"&&(T.clearButton.label&&(w.clearLabel=T.clearButton.label,$.innerHTML=w.clearLabel),T.clearButton=T.clearButton.show),w.clearButton=!!T.clearButton,$.style.display=w.clearButton?"block":"none";break;case"clearLabel":w.clearLabel=T.clearLabel,$.innerHTML=w.clearLabel;break;case"closeButton":w.closeButton=!!T.closeButton,w.closeButton?u.insertBefore(M,O):O.appendChild(M);break;case"closeLabel":w.closeLabel=T.closeLabel,M.innerHTML=w.closeLabel;break;case"a11y":var pe=T.a11y,$e=!1;if(typeof pe=="object")for(var be in pe)pe[be]&&w.a11y[be]&&(w.a11y[be]=pe[be],$e=!0);if($e){var Ue=ve("clr-open-label"),Ce=ve("clr-swatch-label");Ue.innerHTML=w.a11y.open,Ce.innerHTML=w.a11y.swatch,M.setAttribute("aria-label",w.a11y.close),$.setAttribute("aria-label",w.a11y.clear),S.setAttribute("aria-label",w.a11y.hueSlider),C.setAttribute("aria-label",w.a11y.alphaSlider),x.setAttribute("aria-label",w.a11y.input),h.setAttribute("aria-label",w.a11y.instruction)}break;default:w[G]=T[G]}};for(var G in T)V()}}function ce(T,V){typeof T=="string"&&typeof V=="object"&&(m[T]=V,_=!0)}function se(T){delete m[T],Object.keys(m).length===0&&(_=!1,T===I&&J())}function ae(T){if(_){var V=["el","wrap","rtl","inline","defaultColor","a11y"],G=function(){var pe=m[ne];if(T.matches(ne)){I=ne,p={},V.forEach(function(be){return delete pe[be]});for(var $e in pe)p[$e]=Array.isArray(w[$e])?w[$e].slice():w[$e];return k(pe),"break"}};for(var ne in m){var oe=G();if(oe==="break")break}}}function J(){Object.keys(p).length>0&&(k(p),I="",p={})}function Se(T){Oe(e,"click",T,function(V){w.inline||(ae(V.target),L=V.target,H=L.value,B=Ie(H),u.classList.add("clr-open"),De(),re(H),(w.focusInput||w.selectInput)&&(x.focus({preventScroll:!0}),x.setSelectionRange(L.selectionStart,L.selectionEnd)),w.selectInput&&x.select(),(ie||w.swatchesOnly)&&Me().shift().focus(),L.dispatchEvent(new Event("open",{bubbles:!0})))}),Oe(e,"input",T,function(V){var G=V.target.parentNode;G.classList.contains("clr-field")&&(G.style.color=V.target.value)})}function De(){if(!(!u||!L&&!w.inline)){var T=s,V=i.scrollY,G=u.offsetWidth,ne=u.offsetHeight,oe={left:!1,top:!1},fe,pe,$e,be={x:0,y:0};if(T&&(fe=i.getComputedStyle(T),pe=parseFloat(fe.marginTop),$e=parseFloat(fe.borderTopWidth),be=T.getBoundingClientRect(),be.y+=$e+V),!w.inline){var Ue=L.getBoundingClientRect(),Ce=Ue.x,Ge=V+Ue.y+Ue.height+w.margin;T?(Ce-=be.x,Ge-=be.y,Ce+G>T.clientWidth&&(Ce+=Ue.width-G,oe.left=!0),Ge+ne>T.clientHeight-pe&&ne+w.margin<=Ue.top-(be.y-V)&&(Ge-=Ue.height+ne+w.margin*2,oe.top=!0),Ge+=T.scrollTop):(Ce+G>e.documentElement.clientWidth&&(Ce+=Ue.width-G,oe.left=!0),Ge+ne-V>e.documentElement.clientHeight&&ne+w.margin<=Ue.top&&(Ge=V+Ue.y-ne-w.margin,oe.top=!0)),u.classList.toggle("clr-left",oe.left),u.classList.toggle("clr-top",oe.top),u.style.left=Ce+"px",u.style.top=Ge+"px",be.x+=u.offsetLeft,be.y+=u.offsetTop}D={width:h.offsetWidth,height:h.offsetHeight,x:h.offsetLeft+be.x,y:h.offsetTop+be.y}}}function Te(T){e.querySelectorAll(T).forEach(function(V){var G=V.parentNode;if(!G.classList.contains("clr-field")){var ne=e.createElement("div"),oe="clr-field";(w.rtl||V.classList.contains("clr-rtl"))&&(oe+=" clr-rtl"),ne.innerHTML='<button type="button" aria-labelledby="clr-open-label"></button>',G.insertBefore(ne,V),ne.setAttribute("class",oe),ne.style.color=V.value,ne.appendChild(V)}})}function Y(T){if(L&&!w.inline){var V=L;T&&(L=n,H!==V.value&&(V.value=H,V.dispatchEvent(new Event("input",{bubbles:!0})))),setTimeout(function(){H!==V.value&&V.dispatchEvent(new Event("change",{bubbles:!0}))}),u.classList.remove("clr-open"),_&&J(),V.dispatchEvent(new Event("close",{bubbles:!0})),w.focusInput&&V.focus({preventScroll:!0}),L=n}}function re(T){var V=xe(T),G=he(V);de(G.s,G.v),E(V,G),S.value=G.h,u.style.color="hsl("+G.h+", 100%, 50%)",P.style.left=G.h/360*100+"%",y.style.left=D.width*G.s/100+"px",y.style.top=D.height-D.height*G.v/100+"px",C.value=G.a*100,R.style.left=G.a*100+"%"}function Ie(T){var V=T.substring(0,3).toLowerCase();return V==="rgb"||V==="hsl"?V:"hex"}function ge(T){T=T!==n?T:x.value,L&&(L.value=T,L.dispatchEvent(new Event("input",{bubbles:!0}))),w.onChange&&w.onChange.call(i,T,L),e.dispatchEvent(new CustomEvent("coloris:pick",{detail:{color:T,currentEl:L}}))}function ue(T,V){var G={h:S.value*1,s:T/D.width*100,v:100-V/D.height*100,a:C.value/100},ne=X(G);de(G.s,G.v),E(ne,G),ge()}function de(T,V){var G=w.a11y.marker;T=T.toFixed(1)*1,V=V.toFixed(1)*1,G=G.replace("{s}",T),G=G.replace("{v}",V),y.setAttribute("aria-label",G)}function ye(T){return{pageX:T.changedTouches?T.changedTouches[0].pageX:T.pageX,pageY:T.changedTouches?T.changedTouches[0].pageY:T.pageY}}function we(T){var V=ye(T),G=V.pageX-D.x,ne=V.pageY-D.y;s&&(ne+=s.scrollTop),d(G,ne),T.preventDefault(),T.stopPropagation()}function W(T,V){var G=y.style.left.replace("px","")*1+T,ne=y.style.top.replace("px","")*1+V;d(G,ne)}function d(T,V){T=T<0?0:T>D.width?D.width:T,V=V<0?0:V>D.height?D.height:V,y.style.left=T+"px",y.style.top=V+"px",ue(T,V),y.focus()}function E(T,V){T===void 0&&(T={}),V===void 0&&(V={});var G=w.format;for(var ne in T)r[ne]=T[ne];for(var oe in V)r[oe]=V[oe];var fe=Ee(r),pe=fe.substring(0,7);switch(y.style.color=pe,R.parentNode.style.color=pe,R.style.color=fe,O.style.color=fe,h.style.display="none",h.offsetHeight,h.style.display="",R.nextElementSibling.style.display="none",R.nextElementSibling.offsetHeight,R.nextElementSibling.style.display="",G==="mixed"?G=r.a===1?"hex":"rgb":G==="auto"&&(G=B),G){case"hex":x.value=fe;break;case"rgb":x.value=He(r);break;case"hsl":x.value=Fe(z(r));break}e.querySelector('.clr-format [value="'+G+'"]').checked=!0}function N(){var T=S.value*1,V=y.style.left.replace("px","")*1,G=y.style.top.replace("px","")*1;u.style.color="hsl("+T+", 100%, 50%)",P.style.left=T/360*100+"%",ue(V,G)}function j(){var T=C.value/100;R.style.left=T*100+"%",E({a:T}),ge()}function X(T){var V=T.s/100,G=T.v/100,ne=V*G,oe=T.h/60,fe=ne*(1-t.abs(oe%2-1)),pe=G-ne;ne=ne+pe,fe=fe+pe;var $e=t.floor(oe)%6,be=[ne,fe,pe,pe,fe,ne][$e],Ue=[fe,ne,ne,fe,pe,pe][$e],Ce=[pe,pe,fe,ne,ne,fe][$e];return{r:t.round(be*255),g:t.round(Ue*255),b:t.round(Ce*255),a:T.a}}function z(T){var V=T.v/100,G=V*(1-T.s/100/2),ne;return G>0&&G<1&&(ne=t.round((V-G)/t.min(G,1-G)*100)),{h:T.h,s:ne||0,l:t.round(G*100),a:T.a}}function he(T){var V=T.r/255,G=T.g/255,ne=T.b/255,oe=t.max(V,G,ne),fe=t.min(V,G,ne),pe=oe-fe,$e=oe,be=0,Ue=0;return pe&&(oe===V&&(be=(G-ne)/pe),oe===G&&(be=2+(ne-V)/pe),oe===ne&&(be=4+(V-G)/pe),oe&&(Ue=pe/oe)),be=t.floor(be*60),{h:be<0?be+360:be,s:t.round(Ue*100),v:t.round($e*100),a:T.a}}function xe(T){var V=/^((rgba)|rgb)[\D]+([\d.]+)[\D]+([\d.]+)[\D]+([\d.]+)[\D]*?([\d.]+|$)/i,G,ne;return o.fillStyle="#000",o.fillStyle=T,G=V.exec(o.fillStyle),G?(ne={r:G[3]*1,g:G[4]*1,b:G[5]*1,a:G[6]*1},ne.a=+ne.a.toFixed(2)):(G=o.fillStyle.replace("#","").match(/.{2}/g).map(function(oe){return parseInt(oe,16)}),ne={r:G[0],g:G[1],b:G[2],a:1}),ne}function Ee(T){var V=T.r.toString(16),G=T.g.toString(16),ne=T.b.toString(16),oe="";if(T.r<16&&(V="0"+V),T.g<16&&(G="0"+G),T.b<16&&(ne="0"+ne),w.alpha&&(T.a<1||w.forceAlpha)){var fe=T.a*255|0;oe=fe.toString(16),fe<16&&(oe="0"+oe)}return"#"+V+G+ne+oe}function He(T){return!w.alpha||T.a===1&&!w.forceAlpha?"rgb("+T.r+", "+T.g+", "+T.b+")":"rgba("+T.r+", "+T.g+", "+T.b+", "+T.a+")"}function Fe(T){return!w.alpha||T.a===1&&!w.forceAlpha?"hsl("+T.h+", "+T.s+"%, "+T.l+"%)":"hsla("+T.h+", "+T.s+"%, "+T.l+"%, "+T.a+")"}function Be(){e.getElementById("clr-picker")||(s=n,u=e.createElement("div"),u.setAttribute("id","clr-picker"),u.className="clr-picker",u.innerHTML='<input id="clr-color-value" name="clr-color-value" class="clr-color" type="text" value="" spellcheck="false" aria-label="'+w.a11y.input+'">'+('<div id="clr-color-area" class="clr-gradient" role="application" aria-label="'+w.a11y.instruction+'">')+'<div id="clr-color-marker" class="clr-marker" tabindex="0"></div></div><div class="clr-hue">'+('<input id="clr-hue-slider" name="clr-hue-slider" type="range" min="0" max="360" step="1" aria-label="'+w.a11y.hueSlider+'">')+'<div id="clr-hue-marker"></div></div><div class="clr-alpha">'+('<input id="clr-alpha-slider" name="clr-alpha-slider" type="range" min="0" max="100" step="1" aria-label="'+w.a11y.alphaSlider+'">')+'<div id="clr-alpha-marker"></div><span></span></div><div id="clr-format" class="clr-format"><fieldset class="clr-segmented">'+("<legend>"+w.a11y.format+"</legend>")+'<input id="clr-f1" type="radio" name="clr-format" value="hex"><label for="clr-f1">Hex</label><input id="clr-f2" type="radio" name="clr-format" value="rgb"><label for="clr-f2">RGB</label><input id="clr-f3" type="radio" name="clr-format" value="hsl"><label for="clr-f3">HSL</label><span></span></fieldset></div><div id="clr-swatches" class="clr-swatches"></div>'+('<button type="button" id="clr-clear" class="clr-clear" aria-label="'+w.a11y.clear+'">'+w.clearLabel+"</button>")+'<div id="clr-color-preview" class="clr-preview">'+('<button type="button" id="clr-close" class="clr-close" aria-label="'+w.a11y.close+'">'+w.closeLabel+"</button>")+"</div>"+('<span id="clr-open-label" hidden>'+w.a11y.open+"</span>")+('<span id="clr-swatch-label" hidden>'+w.a11y.swatch+"</span>"),e.body.appendChild(u),h=ve("clr-color-area"),y=ve("clr-color-marker"),$=ve("clr-clear"),M=ve("clr-close"),O=ve("clr-color-preview"),x=ve("clr-color-value"),S=ve("clr-hue-slider"),P=ve("clr-hue-marker"),C=ve("clr-alpha-slider"),R=ve("clr-alpha-marker"),Se(w.el),Te(w.el),Oe(u,"mousedown",function(T){u.classList.remove("clr-keyboard-nav"),T.stopPropagation()}),Oe(h,"mousedown",function(T){Oe(e,"mousemove",we)}),Oe(h,"touchstart",function(T){e.addEventListener("touchmove",we,{passive:!1})}),Oe(y,"mousedown",function(T){Oe(e,"mousemove",we)}),Oe(y,"touchstart",function(T){e.addEventListener("touchmove",we,{passive:!1})}),Oe(x,"change",function(T){var V=x.value;if(L||w.inline){var G=V===""?V:re(V);ge(G)}}),Oe($,"click",function(T){ge(""),Y()}),Oe(M,"click",function(T){ge(),Y()}),Oe(ve("clr-format"),"click",".clr-format input",function(T){B=T.target.value,E(),ge()}),Oe(u,"click",".clr-swatches button",function(T){re(T.target.textContent),ge(),w.swatchesOnly&&Y()}),Oe(e,"mouseup",function(T){e.removeEventListener("mousemove",we)}),Oe(e,"touchend",function(T){e.removeEventListener("touchmove",we)}),Oe(e,"mousedown",function(T){ie=!1,u.classList.remove("clr-keyboard-nav"),Y()}),Oe(e,"keydown",function(T){var V=T.key,G=T.target,ne=T.shiftKey,oe=["Tab","ArrowUp","ArrowDown","ArrowLeft","ArrowRight"];if(V==="Escape"?Y(!0):oe.includes(V)&&(ie=!0,u.classList.add("clr-keyboard-nav")),V==="Tab"&&G.matches(".clr-picker *")){var fe=Me(),pe=fe.shift(),$e=fe.pop();ne&&G===pe?($e.focus(),T.preventDefault()):!ne&&G===$e&&(pe.focus(),T.preventDefault())}}),Oe(e,"click",".clr-field button",function(T){_&&J(),T.target.nextElementSibling.dispatchEvent(new Event("click",{bubbles:!0}))}),Oe(y,"keydown",function(T){var V={ArrowUp:[0,-1],ArrowDown:[0,1],ArrowLeft:[-1,0],ArrowRight:[1,0]};Object.keys(V).includes(T.key)&&(W.apply(void 0,V[T.key]),T.preventDefault())}),Oe(h,"click",we),Oe(S,"input",N),Oe(C,"input",j))}function Me(){var T=Array.from(u.querySelectorAll("input, button")),V=T.filter(function(G){return!!G.offsetWidth});return V}function ve(T){return e.getElementById(T)}function Oe(T,V,G,ne){var oe=Element.prototype.matches||Element.prototype.msMatchesSelector;typeof G=="string"?T.addEventListener(V,function(fe){oe.call(fe.target,G)&&ne.call(fe.target,fe)}):(ne=G,T.addEventListener(V,ne))}function qe(T,V){V=V!==n?V:[],e.readyState!=="loading"?T.apply(void 0,V):e.addEventListener("DOMContentLoaded",function(){T.apply(void 0,V)})}NodeList!==n&&NodeList.prototype&&!NodeList.prototype.forEach&&(NodeList.prototype.forEach=Array.prototype.forEach);function te(T,V){L=V,H=L.value,ae(V),B=Ie(T),De(),re(T),ge(),H!==T&&L.dispatchEvent(new Event("change",{bubbles:!0}))}var me=function(){var T={init:Be,set:k,wrap:Te,close:Y,setInstance:ce,setColor:te,removeInstance:se,updatePosition:De};function V(oe){qe(function(){oe&&(typeof oe=="string"?Se(oe):k(oe))})}var G=function(fe){V[fe]=function(){for(var pe=arguments.length,$e=new Array(pe),be=0;be<pe;be++)$e[be]=arguments[be];qe(T[fe],$e)}};for(var ne in T)G(ne);return qe(function(){i.addEventListener("resize",function(oe){V.updatePosition()}),i.addEventListener("scroll",function(oe){V.updatePosition()})}),V}();return me.coloris=me,me}(window,document,Math)}();rt.coloris;rt.init;rt.set;rt.wrap;rt.close;rt.setInstance;rt.removeInstance;rt.updatePosition;function Va(){Z.smokeViewToggle.onclick=e=>{e.preventDefault(),i(Z.smokeViewToggle,Z.smokeViewPanel)},Z.spectreViewToggle.onclick=e=>{e.preventDefault(),i(Z.spectreViewToggle,Z.spectreViewPanel)},Z.settingsViewToggle.onclick=e=>{e.preventDefault(),i(Z.settingsViewToggle,Z.settingsViewPanel)},Z.debugViewToggle.onclick=e=>{e.preventDefault(),i(Z.debugViewToggle,Z.debugViewPanel)};function i(e,t){Z.smokeViewToggle?.classList.remove("selected"),Z.spectreViewToggle?.classList.remove("selected"),Z.settingsViewToggle?.classList.remove("selected"),Z.debugViewToggle?.classList.remove("selected"),Z.smokeViewPanel.style.display="none",Z.spectreViewPanel.style.display="none",Z.settingsViewPanel.style.display="none",Z.debugViewPanel.style.display="none",e.classList.add("selected"),t.style.display="block"}}function Xi(){Z.processedIndicator.onclick=async()=>{await b.popover.open({id:c.PROCESSEDID,url:"/pages/processed.html",height:300,width:320,disableClickAway:!1})},Z.hiddenListToggle.onclick=async t=>{Z.hiddenTable.style.display==="none"?(Z.hiddenTable.style.display="table-row-group",Z.hiddenListToggle.value="Out-of-Sight List: Click to Hide"):(Z.hiddenTable.style.display="none",Z.hiddenListToggle.value="Out-of-Sight List: Click to Show")},Z.visionCheckbox.onclick=async t=>{if(!g.sceneReady){t.preventDefault();return}const n=t.target;await b.scene.setMetadata({[`${c.EXTENSIONID}/visionEnabled`]:n.checked}),await b.scene.fog.setFilled(n.checked)},Z.snapCheckbox.checked=!0,Z.snapCheckbox.onclick=async t=>{if(!g.sceneReady){t.preventDefault();return}const n=t.target;g.snap=n.checked},Z.persistenceCheckbox.onclick=async t=>{if(!t||!t.target)return;const n=t.target;await b.scene.setMetadata({[`${c.EXTENSIONID}/persistenceEnabled`]:n.checked})},Z.autodetectCheckbox.onclick=async t=>{if(!t||!t.target)return;const n=t.target;await b.scene.setMetadata({[`${c.EXTENSIONID}/autodetectEnabled`]:n.checked}),Z.boundryOptions.style.display=n.checked?"none":"",await $n()},Z.fowCheckbox.onclick=async t=>{if(!t||!t.target)return;const n=t.target;await en(n.checked),await b.scene.setMetadata({[`${c.EXTENSIONID}/fowEnabled`]:n.checked})},Z.doorCheckbox.onclick=async t=>{if(!t||!t.target)return;const n=t.target;await b.scene.setMetadata({[`${c.EXTENSIONID}/playerDoors`]:n.checked})},Z.resetButton.onclick=async t=>{!t||!t.target||b.broadcast.sendMessage(c.RESETID,!0,{destination:"ALL"})},Z.unlockFogButton.onclick=async t=>{if(!t||!t.target)return;const n=g.sceneItems.filter(o=>Pi(o));await g.ToggleBusy(!0);for(let o=0;o<n.length;o+=64){const r=n.slice(o,o+64);await b.scene.items.updateItems(r,s=>{for(let u of s)u.locked=!1})}await g.ToggleBusy(!1)},Z.lockFogButton.onclick=async t=>{if(!t||!t.target)return;const n=g.sceneItems.filter(o=>Pi(o));await g.ToggleBusy(!0);for(let o=0;o<n.length;o+=64){const r=n.slice(o,o+64);await b.scene.items.updateItems(r,s=>{for(let u of s)u.locked=!0})}await g.ToggleBusy(!1)},Z.backgroundButton.onclick=async t=>{!t||!t.target||(t.target,await b.scene.items.updateItems(n=>n.layer=="FOG"&&n.metadata[`${c.EXTENSIONID}/isBackgroundMap`]===!0,n=>{for(let o=0;o<n.length;o++)n[o].layer="MAP",n[o].disableHit=!1,n[o].locked=!1,n[o].visible=!0,delete n[o].metadata[`${c.EXTENSIONID}/isBackgroundMap`]}))};let i;Z.fowColor.onclick=()=>{rt({el:`#${Z.fowColor.id}`,alpha:!0,forceAlpha:!0})},Z.fowColor.oninput=async t=>{if(!t||!t.target)return;const n=t.target;clearTimeout(i),i=setTimeout(async()=>{if(/#[a-f0-9]{8}/.test(n.value)){await b.scene.setMetadata({[`${c.EXTENSIONID}/fowColor`]:n.value});const r=await b.scene.local.getItems(Zt);await b.scene.local.deleteItems(r.map(s=>s.id))}},500)},Z.convertButton.onclick=async t=>{if(!(!t||!t.target)&&window.confirm(`WARNING: THIS CANNOT BE UNDONE.

This operation will remove all metadata from the original dynamic fog extension, and will break fog lines and other things if you do not continue using Smoke!.

WARNING: THIS CANNOT BE UNDONE.

Are you REALLY sure?`)){for(const n in g.sceneMetadata)n.substring(0,n.indexOf("/"))==c.ARMINDOID&&await b.scene.setMetadata({[`${n}`]:void 0});await b.scene.items.updateItems(g.sceneItems,n=>{for(const o of n)o.metadata[`${c.ARMINDOID}/isVisionLine`]!==void 0&&(o.metadata[`${c.EXTENSIONID}/isVisionLine`]=o.metadata[`${c.ARMINDOID}/isVisionLine`],delete o.metadata[`${c.ARMINDOID}/isVisionLine`]),o.metadata[`${c.ARMINDOID}/disabled`]!==void 0&&(o.metadata[`${c.EXTENSIONID}/disabled`]=o.metadata[`${c.ARMINDOID}/disabled`],delete o.metadata[`${c.ARMINDOID}/disabled`])})}};var e;Z.importFile.onchange=t=>{if(Z.importButton.disabled=!0,!t||!t.target)return;const n=t.target;if(!n.files)return;const o=n.files[0];if(o.type!=="text/javascript"&&o.type,o){var r=new FileReader;r.onload=function(s){if(!s||!s.target){Z.importErrors.innerText="Invalid import event";return}const u=s.target;if(!u.result){Z.importErrors.innerText="Unable to read imported file";return}const h=u.result;e=JSON.parse(h),e&&(e.walls&&e.walls.length||e.line_of_sight&&e.line_of_sight.length||e.objects_line_of_sight&&e.objects_line_of_sight.length)?Z.importButton.disabled=!1:Z.importErrors.innerText="Imported file has no walls"},r.readAsText(o)}else Z.importErrors.innerText="Failed to load file"},Z.dpiAutodetect.onclick=async t=>{!t||!t.target||(Z.importDpi.disabled=Z.dpiAutodetect.checked)},Z.importButton.onclick=async t=>{!t||!t.target||(await g.ToggleBusy(!0),Z.importFormat.value==="scene"?await nr(e,Z.importErrors):await er(Z.importFormat.value,e,Z.dpiAutodetect.checked?0:Number.parseInt(Z.importDpi.value),Z.mapAlign.value,Z.importErrors),await g.ToggleBusy(!1))},Z.toolColor.onclick=async t=>{rt({el:`#${Z.toolColor.id}`,alpha:!1,forceAlpha:!1})},Z.toolColor.oninput=async t=>{if(!t||!t.target)return;const n=t.target;clearTimeout(i),i=setTimeout(async()=>{/#[a-f0-9]{6}/.test(n.value)&&await b.scene.setMetadata({[`${c.EXTENSIONID}/toolColor`]:n.value})},400)},Z.toolStyle.onchange=async t=>{const n=t.currentTarget;await b.scene.setMetadata({[`${c.EXTENSIONID}/toolStyle`]:n.value=="solid"?[]:[25,25]})},Z.toolWidth.onchange=t=>{const n=t.currentTarget;clearTimeout(i),i=setTimeout(async()=>{await b.scene.setMetadata({[`${c.EXTENSIONID}/toolWidth`]:n.value})},400)},Z.whatsNewButton.onclick=async function(){Z.whatsNewIcon?.classList.remove("new-shine"),await b.modal.open({id:c.EXTENSIONWHATSNEW,url:"/pages/whatsnew.html",height:500,width:400})},rt({themeMode:"dark",alpha:!0,forceAlpha:!0,el:"#fow_color"}),rt({themeMode:"dark",alpha:!1,forceAlpha:!1,el:"#tool_color"})}const yo="#000000",Ha=8,Ua=[];let vt=[];async function vo(){vt=[];const i=await b.scene.local.getItems(Ba);await b.scene.local.deleteItems(i.map(e=>e.id)),await b.popover.close(c.BRUSHTOOLID)}async function Ga(i,e){await Io(e.pointerPosition)}async function ja(){const i=await b.viewport.getWidth();await b.popover.open({id:c.BRUSHTOOLID,url:"/pages/brush.html",height:80,width:350,disableClickAway:!0,anchorPosition:{top:60,left:i/2},anchorReference:"POSITION",anchorOrigin:{vertical:"CENTER",horizontal:"CENTER"},transformOrigin:{vertical:"TOP",horizontal:"CENTER"}})}async function Wa(){await b.popover.close(c.BRUSHTOOLID)}async function qa(i,e){await Io(e.pointerPosition)}async function Ka(i,e){await Ya(),await vo()}async function za(i,e){await vo()}async function Io(i){const e={x:Math.floor(i.x/g.gridDpi),y:Math.floor(i.y/g.gridDpi)};if(!vt.some(n=>n.x===e.x&&n.y===e.y)){const n={x:e.x*g.gridDpi,y:e.y*g.gridDpi},o={x:(e.x+1)*g.gridDpi,y:e.y*g.gridDpi},r={x:e.x*g.gridDpi,y:(e.y+1)*g.gridDpi},s={x:(e.x+1)*g.gridDpi,y:(e.y+1)*g.gridDpi},u=[[_t.MOVE,n.x,n.y],[_t.LINE,o.x,o.y],[_t.LINE,s.x,s.y],[_t.LINE,r.x,r.y],[_t.CLOSE]],h=gt().commands(u).strokeOpacity(0).fillOpacity(.5).fillColor(g.sceneMetadata[`${c.EXTENSIONID}/toolColor`]??yo).build();h.metadata[`${c.EXTENSIONID}/isBrushSquare`]=!0,vt.push(e),await b.scene.local.addItems([h])}}async function Ya(){const i=[];for(const s of vt){const{x:u,y:h}=s,y={x:u*g.gridDpi,y:h*g.gridDpi},O={x:(u+1)*g.gridDpi,y:h*g.gridDpi},x={x:u*g.gridDpi,y:(h+1)*g.gridDpi},$={x:(u+1)*g.gridDpi,y:(h+1)*g.gridDpi};if(!vt.some(M=>M.x===u&&M.y===h-1)){const M=y,S=O;i.push({Start:M,End:S})}if(!vt.some(M=>M.x===u&&M.y===h+1)){const M=x,S=$;i.push({Start:M,End:S})}if(!vt.some(M=>M.x===u-1&&M.y===h)){const M=y,S=x;i.push({Start:M,End:S})}if(!vt.some(M=>M.x===u+1&&M.y===h)){const M=O,S=$;i.push({Start:M,End:S})}}const e=wo(i),t=Eo(e),n=Qa(t),o=25,r=n.length;for(let s=0;s<r;s+=o){const u=n.slice(s,s+o);await b.scene.items.addItems(u)}}function Eo(i){let e=[],t=[],n=!1;for(const o of i){const r=o.Start.x===o.End.x?i.filter(h=>h.Start.x===h.End.x):i.filter(h=>h.Start.y===h.End.y),s=o.Start.x===o.End.x?r.filter(h=>h.Start.x===o.Start.x&&h.End.x===o.End.x):r.filter(h=>h.Start.y===o.Start.y&&h.End.y===o.End.y),u=o.Start.x!==o.End.x?s.find(h=>h.Start.x>o.Start.x&&h.Start.x<o.End.x):s.find(h=>h.Start.y>o.Start.y&&h.Start.y<o.End.y);if(u){const h=Ja(o,u);t.push(h),e.push(o),e.push(u),t=t.filter(y=>y!==o&&y!==u),n=!0}else e.includes(o)||t.push(o)}return n?Eo(t):t}function wo(i){let e=[],t=[],n=!1;for(const o of i){const s=(o.Start.x===o.End.x?i.filter(u=>u.Start.x===u.End.x):i.filter(u=>u.Start.y===u.End.y)).find(u=>u.Start.x===o.End.x&&u.Start.y===o.End.y);if(s){const u=Za(o,s);t.push(u),e.push(o),e.push(s),t=t.filter(h=>h!==o&&h!==s),n=!0}else e.includes(o)||t.push(o)}return n?wo(t):t}function Za(i,e){return{Start:i.Start,End:e.End}}function Ja(i,e){const t=Math.min(i.Start.x,e.Start.x),n=Math.min(i.Start.y,e.Start.y),o=Math.max(i.End.x,e.End.x),r=Math.max(i.End.y,e.End.y);return{Start:{x:t,y:n},End:{x:o,y:r}}}function Qa(i){const e=[];for(const t of i){const n=ct().tension(0).points([t.Start,t.End]).strokeColor(g.sceneMetadata[`${c.EXTENSIONID}/toolColor`]??yo).strokeDash(g.sceneMetadata[`${c.EXTENSIONID}/toolStyle`]??Ua).strokeWidth(g.sceneMetadata[`${c.EXTENSIONID}/toolWidth`]??Ha).fillOpacity(0).fillColor("#000000").layer("DRAWING").name("Vision Line (Brushed)").closed(!1).locked(!0).build();n.visible=!1,n.metadata[`${c.EXTENSIONID}/isVisionLine`]=!0,e.push(n)}return e}const bt={onActivate:ja,onDeactivate:Wa,onDragStart:Ga,onDragMove:qa,onDragEnd:Ka,onDragCancel:za};async function Fi(){await b.tool.create({id:`${c.EXTENSIONID}/vision-tool`,icons:[{icon:"/icon.svg",label:"Setup Vision"}],defaultMetadata:{[`${c.EXTENSIONID}/elevationEditor`]:!1},async onClick(){await b.tool.activateTool(`${c.EXTENSIONID}/vision-tool`),g.toolStarted||(g.toolStarted=!0,await b.tool.setMetadata(`${c.EXTENSIONID}/vision-tool`,{[`${c.EXTENSIONID}/elevationEditor`]:!1}))}}),await b.tool.createMode({id:`${c.EXTENSIONID}/add-vision-polygon-mode`,icons:[{icon:"/object.svg",label:"Add Obstruction Object",filter:{activeTools:[`${c.EXTENSIONID}/vision-tool`]}}],onToolDown:An.onToolClick,onToolMove:An.onToolMove,onKeyDown:An.onKeyDown,preventDrag:{dragging:!1}}),await b.tool.createMode({id:`${c.EXTENSIONID}/add-vision-line-mode`,icons:[{icon:"/line.svg",label:"Add Obstruction Line",filter:{activeTools:[`${c.EXTENSIONID}/vision-tool`]}}],onToolDown:_n.onToolClick,onToolMove:_n.onToolMove,onKeyDown:_n.onKeyDown,preventDrag:{dragging:!1}}),await b.tool.createMode({id:`${c.EXTENSIONID}/add-vision-brush-mode`,icons:[{icon:"/brush.svg",label:"Paint Obstructions by Grid",filter:{activeTools:[`${c.EXTENSIONID}/vision-tool`]}}],onToolDown:bt.onActivate,onToolUp:bt.onDeactivate,onToolDragStart:bt.onDragStart,onToolDragMove:bt.onDragMove,onToolDragEnd:bt.onDragEnd,onToolDragCancel:bt.onDragCancel}),await b.tool.createMode({id:`${c.EXTENSIONID}/enter-elevation-mode-1`,icons:[{icon:"/mountain1.svg",label:"Create Map Elevation Layer-1",filter:{activeTools:[`${c.EXTENSIONID}/vision-tool`]}}],disabled:{metadata:[{key:[`${c.EXTENSIONID}/elevationEditor`],value:!1}]},onToolDown:(i,e)=>{Ke.onToolClick(i,e,1)},onToolMove:Ke.onToolMove,onKeyDown:(i,e)=>{Ke.onKeyDown(i,e,1)},preventDrag:{dragging:!0}}),await b.tool.createMode({id:`${c.EXTENSIONID}/enter-elevation-mode-2`,icons:[{icon:"/mountain2.svg",label:"Create Map Elevation Layer-2",filter:{activeTools:[`${c.EXTENSIONID}/vision-tool`]}}],disabled:{metadata:[{key:[`${c.EXTENSIONID}/elevationEditor`],value:!1}]},onToolDown:(i,e)=>{Ke.onToolClick(i,e,2)},onToolMove:Ke.onToolMove,onKeyDown:(i,e)=>{Ke.onKeyDown(i,e,2)},preventDrag:{dragging:!0}}),await b.tool.createMode({id:`${c.EXTENSIONID}/enter-elevation-mode-3`,icons:[{icon:"/mountain3.svg",label:"Create Map Elevation Layer-3",filter:{activeTools:[`${c.EXTENSIONID}/vision-tool`]}}],disabled:{metadata:[{key:[`${c.EXTENSIONID}/elevationEditor`],value:!1}]},onToolDown:(i,e)=>{Ke.onToolClick(i,e,3)},onToolMove:Ke.onToolMove,onKeyDown:(i,e)=>{Ke.onKeyDown(i,e,3)},preventDrag:{dragging:!0}}),await b.tool.createMode({id:`${c.EXTENSIONID}/enter-elevation-mode-4`,icons:[{icon:"/mountain4.svg",label:"Create Map Elevation Layer-4",filter:{activeTools:[`${c.EXTENSIONID}/vision-tool`]}}],disabled:{metadata:[{key:[`${c.EXTENSIONID}/elevationEditor`],value:!1}]},onToolDown:(i,e)=>{Ke.onToolClick(i,e,4)},onToolMove:Ke.onToolMove,onKeyDown:(i,e)=>{Ke.onKeyDown(i,e,4)},preventDrag:{dragging:!0}}),await b.tool.createMode({id:`${c.EXTENSIONID}/enter-elevation-mode-5`,icons:[{icon:"/mountain5.svg",label:"Create Map Elevation Layer-5",filter:{activeTools:[`${c.EXTENSIONID}/vision-tool`]}}],disabled:{metadata:[{key:[`${c.EXTENSIONID}/elevationEditor`],value:!1}]},onToolDown:(i,e)=>{Ke.onToolClick(i,e,5)},onToolMove:Ke.onToolMove,onKeyDown:(i,e)=>{Ke.onKeyDown(i,e,5)},preventDrag:{dragging:!0}}),await b.tool.createMode({id:`${c.EXTENSIONID}/enter-elevation-mode-select`,icons:[{icon:"/mountain-select.svg",label:"Selector",filter:{activeTools:[`${c.EXTENSIONID}/vision-tool`]}}],disabled:{metadata:[{key:[`${c.EXTENSIONID}/elevationEditor`],value:!1}]},onToolDown:(i,e)=>!0,preventDrag:{dragging:!0}}),await b.tool.createAction({id:`${c.EXTENSIONID}/enter-elevation-mode`,icons:[{icon:"/eyeclosed.svg",label:"Activate Elevation Editor",filter:{activeTools:[`${c.EXTENSIONID}/vision-tool`],metadata:[{key:[`${c.EXTENSIONID}/elevationEditor`],value:!0,operator:"!="}]}},{icon:"/eyeopen.svg",label:"De-Activate Elevation Editor",filter:{activeTools:[`${c.EXTENSIONID}/vision-tool`],metadata:[{key:[`${c.EXTENSIONID}/elevationEditor`],value:!0,operator:"=="}]}}],onClick:Ke.enterEditMode})}class es{mainWindow=document.getElementById("app");mainUIDiv;playerListContainer;settingsUIDiv;visionCheckbox;hiddenListToggle;snapCheckbox;table;hiddenTable;message;mapHeight;mapWidth;mapSubmit;whatsNewButton;whatsNewIcon;processedIndicator;smokeViewToggle;spectreViewToggle;settingsViewToggle;debugViewToggle;smokeViewPanel;spectreViewPanel;settingsViewPanel;debugViewPanel;persistenceCheckbox;autodetectCheckbox;fowCheckbox;doorCheckbox;fowColor;resetButton;convertButton;boundryOptions;backgroundButton;lockFogButton;unlockFogButton;toolWidth;toolColor;toolStyle;importButton;importFile;mapAlign;importErrors;dpiAutodetect;importDpi;importFormat;version;constructor(e){this.version=`SMOKEANDSPECTRE-${e}`}SetupGMElements(){this.mainWindow.innerHTML=`
            <div id="localStorageWarning"></div>
            <div id="tabControls">
                <div class="controlContainer">
                    <button class="view-button selected" id="smokeViewToggle">SMOKE</button>
                    <button class="view-button" id="spectreViewToggle">SPECTRE</button>
                    <button class="view-button" id="settingsViewToggle">SETTINGS</button>
                    <button class="view-button" id="debugViewToggle">INFO</button>
                    <div id="miniButtons">
                        <button class="circle-button" id="processedIndicator"></button>
                        <input type="checkbox" id="vision_checkbox" class="large" title="Enable Dynamic Fog">    
                        <div class="tooltip" id="whatsnewbutton" title="Whats New"><svg id="whatsNewIcon" class="svgclickable" fill="#fff" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 3a7 7 0 100 14 7 7 0 000-14zm-9 7a9 9 0 1118 0 9 9 0 01-18 0zm8-4a1 1 0 011-1h.01a1 1 0 110 2H10a1 1 0 01-1-1zm.01 8a1 1 0 102 0V9a1 1 0 10-2 0v5z"/></svg></div>
                    </div>
                </div>
            </div>
            <div id="smokeViewPanel" class="panel"></div>
            <div id="spectreViewPanel" class="panel" style="display: none;"></div>
            <div id="settingsViewPanel" class="panel" style="display: none;"></div>
            <div id="debugViewPanel" class="panel" style="display: none;"></div>
        `,this.mainWindow.parentElement.style.placeItems="start",this.smokeViewToggle=document.getElementById("smokeViewToggle"),this.spectreViewToggle=document.getElementById("spectreViewToggle"),this.settingsViewToggle=document.getElementById("settingsViewToggle"),this.debugViewToggle=document.getElementById("debugViewToggle"),this.smokeViewPanel=document.getElementById("smokeViewPanel"),this.spectreViewPanel=document.getElementById("spectreViewPanel"),this.settingsViewPanel=document.getElementById("settingsViewPanel"),this.debugViewPanel=document.getElementById("debugViewPanel"),this.smokeViewPanel.innerHTML=c.SMOKEHTML,this.spectreViewPanel.innerHTML=c.SPECTREHTML,this.settingsViewPanel.innerHTML=c.SETTINGSHTML,this.debugViewPanel.innerHTML=c.DEBUGHTML,this.mainUIDiv=document.getElementById("main-ui"),this.settingsUIDiv=document.getElementById("settings-ui"),this.visionCheckbox=document.getElementById("vision_checkbox"),this.hiddenListToggle=document.getElementById("hideListToggle"),this.snapCheckbox=document.getElementById("snap_checkbox"),this.table=document.getElementById("token_list"),this.hiddenTable=document.getElementById("hidden_list"),this.message=document.getElementById("no_tokens_message"),this.mapHeight=document.getElementById("mapHeight"),this.mapWidth=document.getElementById("mapWidth"),this.mapSubmit=document.getElementById("mapSubmit"),this.whatsNewButton=document.getElementById("whatsnewbutton"),this.whatsNewIcon=document.getElementById("whatsNewIcon"),this.processedIndicator=document.getElementById("processedIndicator"),this.persistenceCheckbox=document.getElementById("persistence_checkbox"),this.autodetectCheckbox=document.getElementById("autodetect_checkbox"),this.fowCheckbox=document.getElementById("fow_checkbox"),this.doorCheckbox=document.getElementById("door_checkbox"),this.fowColor=document.getElementById("fow_color"),this.resetButton=document.getElementById("persistence_reset"),this.convertButton=document.getElementById("convert_button"),this.boundryOptions=document.getElementById("boundry_options"),this.backgroundButton=document.getElementById("background_button"),this.lockFogButton=document.getElementById("lock_button"),this.unlockFogButton=document.getElementById("unlock_button"),this.toolWidth=document.getElementById("tool_width"),this.toolColor=document.getElementById("tool_color"),this.toolStyle=document.getElementById("tool_style"),this.importButton=document.getElementById("import_button"),this.importFile=document.getElementById("import_file"),this.mapAlign=document.getElementById("map_align"),this.importErrors=document.getElementById("import_errors"),this.dpiAutodetect=document.getElementById("dpi_autodetect"),this.importDpi=document.getElementById("import_dpi"),this.importFormat=document.getElementById("import_format");const e=document.getElementById("playerListing");e.appendChild(this.GetEmptyContextItem());for(const t of g.party){const n=document.createElement("li");n.id=t.id,n.textContent=t.name,n.style.color=t.color,e.appendChild(n)}rt.init(),Va()}async SetupPlayerElements(){this.mainWindow.innerHTML=`<div class="title">Configuration via GM.
            <div class="tooltip" id="helpButton" title="Need Help?"></div>
            </div>
            <hr><sub>You must have ownership of a token to see it.</sub></br></br>Tokens Owned By You:<div id="playerOwnedTokens"></div><div id="localStorageWarning"></div>`,await b.action.setHeight(300),await b.action.setWidth(350),this.playerListContainer=document.getElementById("playerOwnedTokens");const e=document.getElementById("helpButton"),t=document.createElement("input");t.classList.add("clickable"),t.src="/help.svg",t.height=15,t.width=15,t.type="image",t.title="Need Help?",t.onclick=async function(){await b.modal.open({id:c.EXTENSIONWHATSNEW,url:"/pages/whatsnew.html?gethelp=true",height:500,width:350})},e.appendChild(t)}GetEmptyContextItem(){const e=document.createElement("li");return e.id=g.playerId,e.textContent="Self",e}async ResetPersistence(){const e=await b.scene.local.getItems(Gn);await b.scene.local.deleteItems(e.map(n=>n.id));const t=g.sceneMetadata[`${c.EXTENSIONID}/sceneId`];localStorage.removeItem(`${c.EXTENSIONID}/fogCache/${g.playerId}/${t}`),await St()}async UpdateUI(){const e=g.sceneItems.filter(u=>go(u));Go(g.sceneMetadata)||(this.visionCheckbox.checked=g.sceneMetadata[`${c.EXTENSIONID}/visionEnabled`]==!0,this.autodetectCheckbox.checked=g.sceneMetadata[`${c.EXTENSIONID}/autodetectEnabled`]==!0,this.persistenceCheckbox.checked=g.sceneMetadata[`${c.EXTENSIONID}/persistenceEnabled`]==!0,this.autodetectCheckbox.checked=g.sceneMetadata[`${c.EXTENSIONID}/autodetectEnabled`]==!0,this.fowCheckbox.checked=g.sceneMetadata[`${c.EXTENSIONID}/fowEnabled`]==!0,this.doorCheckbox.checked=g.sceneMetadata[`${c.EXTENSIONID}/playerDoors`]==!0,this.fowColor.value=g.sceneMetadata[`${c.EXTENSIONID}/fowColor`]?g.sceneMetadata[`${c.EXTENSIONID}/fowColor`]:"#00000088",g.sceneMetadata[`${c.EXTENSIONID}/debug`]==!0),this.boundryOptions.style.display=this.autodetectCheckbox.checked?"none":"";const t=g.sceneItems.filter(u=>u.layer==="FOG"&&u.metadata[`${c.EXTENSIONID}/isBackgroundMap`]===!0),n=document.querySelectorAll(".fog-background-entry");for(const u of n){const h=u.id.slice(3);t.find(y=>y.id===h)===void 0&&u.remove()}for(const u of t)if(!document.querySelector(`#bg-${u.id}`)){const y=document.createElement("div");y.id=`bg-${u.id}`,y.className="fog-background-entry grid-3 grid-main",y.style.width="300",y.innerHTML=`<div class="token-name grid-2">${u.name}</div>
                    <div><label title="Unlock this fog background and turn it back into a map"><input type="button" value="Unlock"></label></div>`,document.querySelector("#fog_background_list").appendChild(y),y.querySelector("input").addEventListener("click",async x=>{if(!x||!x.target)return;const M=x.target.parentElement.parentElement.parentElement.id.slice(3);await b.scene.items.updateItems(S=>S.id===M&&S.layer=="FOG"&&S.metadata[`${c.EXTENSIONID}/isBackgroundMap`]===!0,S=>{for(let P=0;P<S.length;P++)S[P].layer="MAP",S[P].disableHit=!1,S[P].locked=!1,S[P].visible=!0,delete S[P].metadata[`${c.EXTENSIONID}/isBackgroundMap`]})})}const o=document.querySelector("#fog_backgrounds");t.length==0?o.style.display="none":o.style.display="block";const r=document.getElementsByClassName("token-table-entry"),s=[];for(const u of r){const h=u.id.slice(3);e.find(y=>y.id===h)===void 0&&s.push(u)}for(const u of s)u.remove();for(const u of e)Ko(u)}UpdatePlayerProcessUI(){g.party.every(t=>t.metadata[`${c.EXTENSIONID}/processed`]===!0)?(this.processedIndicator.style.backgroundColor="green",this.processedIndicator.title="Everything looks good."):(this.processedIndicator.style.backgroundColor="red",this.processedIndicator.title="A player is having trouble processing/seeing.")}UpdatePlayerVisionList(){const e=[];for(const t of g.sceneItems)if(Jt(t)&&t.createdUserId===g.playerId){const n=t.metadata[`${c.EXTENSIONID}/hasVision`]!==void 0;e.push(`<li>${t.name}${n?"":": <b>Vision Disabled</b>"}</li>`)}e.length===0&&e.push("<li>None found.</li>"),this.playerListContainer.innerHTML=`<ul>${e.join("")}</ul>`}HighlightWhatsNew(){let e=localStorage.getItem(this.version);(e==="false"||!e)&&(this.whatsNewIcon?.classList.add("new-shine"),localStorage.setItem(this.version,"true"))}async SoftReset(){g.playerRole==="GM"?(this.SetupGMElements(),Xi(),this.UpdatePlayerProcessUI(),Pn(this.mapAlign),await Promise.all([Ti(),Fi(),dt.SetupSpectreGM(),en(!1),this.UpdateUI()])):this.SetupPlayerElements(),g.sceneReady&&(await Fn(),await St())}async Start(){qo(),g.playerRole==="GM"?(this.SetupGMElements(),Xi(),this.UpdatePlayerProcessUI(),Pn(this.mapAlign),await Promise.all([Ti(),Fi(),dt.SetupSpectreGM(),en(!1),this.UpdateUI()])):(await this.SetupPlayerElements(),this.UpdatePlayerVisionList()),await Fn(),await St(),dt.SetupLocalSpecterHandlers(),g.SetupHandlers(),this.HighlightWhatsNew()}}const Z=new es("2.61");b.onReady(async()=>{const i=await b.scene.isReady();if(!document.getElementById("papp"))if(i===!1){const t=b.scene.onReadyChange(async n=>{n&&(t(),await Bi())})}else await Bi()});async function Bi(){await g.InitializeCache(),await Z.Start()}export{Li as i};
