import{C as u,b as Ci,O as C,a as ft,c as Er,d as wr,e as br,f as mt,i as Sr,g as xt}from"./bsConstants-99533c10.js";/* empty css              */var In=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function Fn(i){return i&&i.__esModule&&Object.prototype.hasOwnProperty.call(i,"default")?i.default:i}function Tr(i){if(i.__esModule)return i;var e=i.default;if(typeof e=="function"){var t=function n(){return this instanceof n?Reflect.construct(e,arguments,this.constructor):e.apply(this,arguments)};t.prototype=e.prototype}else t={};return Object.defineProperty(t,"__esModule",{value:!0}),Object.keys(i).forEach(function(n){var r=Object.getOwnPropertyDescriptor(i,n);Object.defineProperty(t,n,r.get?r:{enumerable:!0,get:function(){return i[n]}})}),t}function Nr(i){return i.type==="CURVE"}function Yt(i){return i.type==="IMAGE"}function oi(i,e){return Math.round(i/e)*e}function si(i,e){return Math.floor(i/e)*e}function Dn(i){return i*(Math.PI/180)}function Or(i){return i*(180/Math.PI)}function ai(i,e,t){return i*(1-t)+e*t}class Ke{static magnitudeSquared(e){return e.x*e.x+e.y*e.y}static magnitude(e){const t=Math.sqrt(this.magnitudeSquared(e));return isNaN(t)?0:t}static normalize(e){const t=this.magnitude(e);return t===0?{x:0,y:0}:this.divide(e,t)}static dot(e,t){return e.x*t.x+e.y*t.y}static subtract(e,t){return typeof t=="number"?{x:e.x-t,y:e.y-t}:{x:e.x-t.x,y:e.y-t.y}}static add(e,t){return typeof t=="number"?{x:e.x+t,y:e.y+t}:{x:e.x+t.x,y:e.y+t.y}}static multiply(e,t){return typeof t=="number"?{x:e.x*t,y:e.y*t}:{x:e.x*t.x,y:e.y*t.y}}static divide(e,t){return typeof t=="number"?{x:e.x/t,y:e.y/t}:{x:e.x/t.x,y:e.y/t.y}}static rotate(e,t,n){const r=Math.cos(Dn(n)),o=Math.sin(Dn(n)),l=this.subtract(e,t);return{x:t.x+r*l.x-o*l.y,y:t.y+o*l.x+r*l.y}}static min(e,t){return typeof t=="number"?{x:Math.min(e.x,t),y:Math.min(e.y,t)}:{x:Math.min(e.x,t.x),y:Math.min(e.y,t.y)}}static componentMin(e){return e.x<e.y?e.x:e.y}static max(e,t){return typeof t=="number"?{x:Math.max(e.x,t),y:Math.max(e.y,t)}:{x:Math.max(e.x,t.x),y:Math.max(e.y,t.y)}}static componentMax(e){return e.x>e.y?e.x:e.y}static roundTo(e,t){return{x:oi(e.x,t.x),y:oi(e.y,t.y)}}static floorTo(e,t){return{x:si(e.x,t.x),y:si(e.y,t.y)}}static sign(e){return{x:Math.sign(e.x),y:Math.sign(e.y)}}static abs(e){return{x:Math.abs(e.x),y:Math.abs(e.y)}}static pow(e,t){return typeof t=="number"?{x:Math.pow(e.x,t),y:Math.pow(e.y,t)}:{x:Math.pow(e.x,t.x),y:Math.pow(e.y,t.y)}}static clamp(e,t,n){return{x:Math.min(Math.max(e.x,t),n),y:Math.min(Math.max(e.y,t),n)}}static boundingBox(e){let t=Number.MAX_SAFE_INTEGER,n=Number.MIN_SAFE_INTEGER,r=Number.MAX_SAFE_INTEGER,o=Number.MIN_SAFE_INTEGER;for(let y of e)t=y.x<t?y.x:t,n=y.x>n?y.x:n,r=y.y<r?y.y:r,o=y.y>o?y.y:o;let l=n-t,c=o-r,p={x:(t+n)/2,y:(r+o)/2};return{min:{x:t,y:r},max:{x:n,y:o},width:l,height:c,center:p}}static pointInPolygon(e,t){const n=this.boundingBox(t);if(e.x<n.min.x||e.x>n.max.x||e.y<n.min.y||e.y>n.max.y)return!1;let r=!1;for(let o=0,l=t.length-1;o<t.length;l=o++){const c=t[o].y>e.y,p=t[l].y>e.y;c!==p&&e.x<(t[l].x-t[o].x)*(e.y-t[o].y)/(t[l].y-t[o].y)+t[o].x&&(r=!r)}return r}static compare(e,t,n){return this.magnitudeSquared(this.subtract(e,t))<n*n}static distance(e,t){return this.magnitude(this.subtract(e,t))}static lerp(e,t,n){return{x:ai(e.x,t.x,n),y:ai(e.y,t.y,n)}}static centroid(e){let t={x:0,y:0};for(let n of e)t.x+=n.x,t.y+=n.y;return e.length>0&&(t={x:t.x/e.length,y:t.y/e.length}),t}}class We{static inverse(e){const[t,n,r,o,l,c,p,y,N]=e,x=t*(l*N-y*c)-n*(o*N-c*p)+r*(o*y-l*p);if(Math.abs(x)<1e-14)return e;const M=1/x,A=(l*N-y*c)*M,b=(r*y-n*N)*M,$=(n*c-r*l)*M,_=(c*p-o*N)*M,L=(t*N-r*p)*M,P=(o*r-t*c)*M,X=(o*y-p*l)*M,H=(p*n-t*y)*M,ie=(t*l-o*n)*M;return[A,b,$,_,L,P,X,H,ie]}static multiply(e,t){return[e[0]*t[0]+e[1]*t[3]+e[2]*t[6],e[0]*t[1]+e[1]*t[4]+e[2]*t[7],e[0]*t[2]+e[1]*t[5]+e[2]*t[8],e[3]*t[0]+e[4]*t[3]+e[5]*t[6],e[3]*t[1]+e[4]*t[4]+e[5]*t[7],e[3]*t[2]+e[4]*t[5]+e[5]*t[8],e[6]*t[0]+e[7]*t[3]+e[8]*t[6],e[6]*t[1]+e[7]*t[4]+e[8]*t[7],e[6]*t[2]+e[7]*t[5]+e[8]*t[8]]}static fromPosition(e){return[1,0,e.x,0,1,e.y,0,0,1]}static fromRotation(e){const t=Dn(e);return[Math.cos(t),-Math.sin(t),0,Math.sin(t),Math.cos(t),0,0,0,1]}static fromScale(e){return[e.x,0,0,0,e.y,0,0,0,1]}static fromItem(e){const t=We.fromPosition(e.position),n=We.fromScale(e.scale),r=We.fromRotation(e.rotation);return We.multiply(We.multiply(t,r),n)}static decompose(e){const[t,n,r,o,l,c]=e,p=t*l-o*n,y={position:{x:r,y:c},rotation:0,scale:{x:1,y:1}};if(t!=0||o!=0){var N=Math.sqrt(t*t+o*o);y.rotation=o>0?Math.acos(t/N):-Math.acos(t/N),y.scale={x:N,y:p/N}}else if(n!=0||l!=0){var x=Math.sqrt(n*n+l*l);y.rotation=Math.PI/2-(l>0?Math.acos(-n/x):-Math.acos(n/x)),y.scale={x:p/x,y:x}}return y.rotation=Or(y.rotation),y}}function li(i,e){let t;return function(...r){t&&clearTimeout(t),t=setTimeout(()=>{i(...r),t=void 0},e)}}function kr(i){for(const e in i)if(i.hasOwnProperty(e))return!1;return!0}function Xn(i,e,t=[]){if(i===e)return!0;if(typeof i!="object"||typeof e!="object"||i===null||e===null)return!1;const n=Object.keys(i).filter(o=>!t.includes(o)),r=Object.keys(e).filter(o=>!t.includes(o));if(n.length!==r.length)return!1;for(const o of n)if(!r.includes(o)||!Xn(i[o],e[o],t))return!1;return!0}function xr(i,e){return Xn(i,e,["lastModified","lastModifiedUserId"])}function ci(i,e){let t=JSON.stringify(i);if(e){const r=JSON.stringify(e);t=t+r}return new TextEncoder().encode(t).length>14384}function En(i,e){const t=["lastModified","lastModifiedUserId"];if(i.length!==e.length)return!1;for(let n=0;n<i.length;n++)if(!Xn(i[n],e[n],t))return!1;return!0}function _r(i,e){e.forEach(t=>{const n=i.findIndex(r=>r.id===t.id);n!==-1?i[n]=t:i.push(t)})}function Cr(){try{localStorage.setItem("STORAGECHECK","test")}catch{const e=document.getElementById("localStorageWarning");e.innerText="Local Storage disabled. Some features will not function."}}function ui(i,e){const t=window.matchMedia("(prefers-color-scheme: dark)"),n=t.matches?"dark":"light",r=t.matches?"light":"dark";for(var o=0;o<e.styleSheets.length;o++)for(var l=0;l<e.styleSheets[o].cssRules.length;l++){let c=e.styleSheets[o].cssRules[l];c&&c.media&&c.media.mediaText.includes("prefers-color-scheme")&&(i.mode=="LIGHT"?(c.media.appendMedium(`(prefers-color-scheme: ${n})`),c.media.mediaText.includes(r)&&c.media.deleteMedium(`(prefers-color-scheme: ${r})`)):i.mode=="DARK"&&(c.media.appendMedium(`(prefers-color-scheme: ${r})`),c.media.mediaText.includes(n)&&c.media.deleteMedium(`(prefers-color-scheme: ${n})`)))}}async function An(){const i=I.sceneItems.filter(Qi);if(!I.sceneMetadata[`${u.EXTENSIONID}/autodetectEnabled`]&&i.length==0){let e=Ci().width(I.gridDpi*30).height(I.gridDpi*30).visible(!1).shapeType("RECTANGLE").visible(!0).locked(!1).strokeColor("pink").strokeOpacity(.5).fillOpacity(0).strokeDash([200,500]).strokeWidth(50).build();e.metadata[`${u.EXTENSIONID}/isBackgroundImage`]=!0,e.metadata[`${u.EXTENSIONID}/grid`]=!0,e.id=u.GRIDID,await C.scene.items.addItems([e])}I.sceneMetadata[`${u.EXTENSIONID}/autodetectEnabled`]===!0&&i.length>0&&await C.scene.items.deleteItems([u.GRIDID])}function Dr(i){function e(){document.getElementById("contextMenu").style.display="none"}const t=document.getElementById(`tr-${i.id}`);if(t){const n=t.getElementsByClassName("token-name")[0],r=t.getElementsByClassName("token-vision-range")[0],o=t.getElementsByClassName("unlimited-vision")[0],l=t.getElementsByClassName("no-vision")[0],c=t.getElementsByClassName("hidden-token")[0];n&&(n.innerText=i.name),r&&!o.checked&&!l.checked&&(r.value=i.metadata[`${u.EXTENSIONID}/visionRange`]!==void 0?i.metadata[`${u.EXTENSIONID}/visionRange`]:u.VISIONDEFAULT),o&&(o.checked=i.metadata[`${u.EXTENSIONID}/visionRange`]===0),l&&(l.checked=i.metadata[`${u.EXTENSIONID}/visionBlind`]),c&&(c.checked=i.metadata[`${u.EXTENSIONID}/hiddenToken`]),o.checked||l.checked?r.setAttribute("disabled","disabled"):r.removeAttribute("disabled")}else{const n=I.sceneMetadata[`${u.EXTENSIONID}/USER-${i.createdUserId}`];let r=n?.color,o=n?.name?`This token is owned by ${n.name}.`:"This token is owned by you.";!r&&i.createdUserId!==I.playerId&&(r="#aeb0af",o="This tokens owner is not in the room currently.");const l=I.sceneItems.find(A=>A.id===i.id),c=document.createElement("tr");c.id=`tr-${l.id}`,c.className="token-table-entry",c.innerHTML=`<td id="contextLocator" title="${o}" ${r==="#aeb0af"?'style="color:black !important; font-style: italic;" ':""}data-color="${r}" class="token-name">${l.name}</td>
                           <td class="token-vision-container" title="The unit of measurement for your grid"><input class="token-vision-range" type="number" value=${u.VISIONDEFAULT}><span class="unit">${I.gridType}</span></td>
                           <td class="token-vision-container-grid">
                            <div class="vision-container-div">
                                <label class="cbutton" title="Unlimited vision range"><input type="checkbox" class="unlimited-vision"><span class="emoji">&infin;</span></label>
                                <label class="cbutton" title="Turn token into a light source"><input type="checkbox" class="torch-vision"><span class="emoji">&#128294;</span></label>
                                <label class="cbutton" title="Disable vision on this token"><input type="checkbox" class="no-vision"><span class="emoji">&#8856;</span></label>
                                <label class="cbutton" title="Move to Out-of-Sight List"><input type="checkbox" class="hidden-token"><span class="emoji">&#128065;</span></label>
                            </div>
                           </td>`,i.metadata[`${u.EXTENSIONID}/hiddenToken`]===!0?Z.hiddenTable.prepend(c):Z.table.appendChild(c),c.getElementsByClassName("token-name")[0].style.textShadow=`
        -2px -2px 2px ${r},
        2px -2px 2px ${r},
        -2px 2px 2px ${r},
        2px 2px 2px ${r}`;const p=c.getElementsByClassName("token-vision-range")[0],y=c.getElementsByClassName("unlimited-vision")[0],N=c.getElementsByClassName("torch-vision")[0],x=c.getElementsByClassName("no-vision")[0],M=c.getElementsByClassName("hidden-token")[0];p&&!y.checked&&!x.checked&&(p.value=i.metadata[`${u.EXTENSIONID}/visionRange`]?i.metadata[`${u.EXTENSIONID}/visionRange`]:u.VISIONDEFAULT),y&&(y.checked=i.metadata[`${u.EXTENSIONID}/visionRange`]===0),N&&(N.checked=i.metadata[`${u.EXTENSIONID}/visionTorch`]),x&&(x.checked=i.metadata[`${u.EXTENSIONID}/visionBlind`]),M&&(M.checked=i.metadata[`${u.EXTENSIONID}/hiddenToken`]),y.checked||x.checked?p.setAttribute("disabled","disabled"):p.removeAttribute("disabled"),p.onchange=async A=>{if(!A||!A.target)return;const b=I.sceneItems.find(L=>L.id===i.id),$=A.target,_=parseInt($.value);_<0&&($.value="0"),_>999&&($.value="999"),await C.scene.items.updateItems([b],L=>{L[0].metadata[`${u.EXTENSIONID}/visionRange`]=_})},M.onclick=async A=>{if(!A||!A.target)return;const b=I.sceneItems.find(L=>L.id===i.id),$=A.target,_=document.getElementById(`tr-${i.id}`);$.checked?Z.hiddenTable.prepend(_):Z.table.appendChild(_),await C.scene.items.updateItems([b],L=>{L[0].metadata[`${u.EXTENSIONID}/hiddenToken`]=$.checked})},y.onclick=async A=>{if(!A||!A.target)return;const b=I.sceneItems.find(L=>L.id===i.id);let $=0;A.target.checked?(p.setAttribute("disabled","disabled"),x.checked=!1):($=parseInt(p.value),p.removeAttribute("disabled")),await C.scene.items.updateItems([b],L=>{L[0].metadata[`${u.EXTENSIONID}/visionRange`]=$})},x.onclick=async A=>{if(!A||!A.target)return;const b=I.sceneItems.find(_=>_.id===i.id),$=A.target;$.checked?p.setAttribute("disabled","disabled"):p.removeAttribute("disabled"),await C.scene.items.updateItems([b],_=>{_[0].metadata[`${u.EXTENSIONID}/visionBlind`]=$.checked})},N.onclick=async A=>{if(!A||!A.target)return;const b=I.sceneItems.find(_=>_.id===i.id),$=A.target;await C.scene.items.updateItems([b],_=>{_[0].metadata[`${u.EXTENSIONID}/visionTorch`]=$.checked})},p.addEventListener("mousewheel",async()=>{}),c.oncontextmenu=async function(A){A.preventDefault();const b=A.currentTarget,$=document.getElementById("contextMenu"),_=X=>{X.preventDefault()},L=async X=>{const H=X.target,ie=$.getAttribute("currentUnit"),O=I.party.find(E=>H.id===E.id)?.color,g=document.getElementById(`tr-${ie}`).getElementsByClassName("token-name")[0];O?g.style.textShadow=`
                    -2px -2px 2px ${O},
                    2px -2px 2px ${O},
                    -2px 2px 2px ${O},
                    2px 2px 2px ${O}`:g.style.textShadow="",await C.scene.items.updateItems([ie],E=>{for(const h of E)h.createdUserId=H.id}),$.style.display="none",X.stopPropagation(),window.removeEventListener("click",P),$.removeEventListener("click",L),$.removeEventListener("contextmenu",_)};$.setAttribute("currentUnit",b.id.substring(3));const P=()=>{$.style.display="none",window.removeEventListener("click",P),$.removeEventListener("click",L),$.removeEventListener("contextmenu",_)};if($.addEventListener("click",L),$.addEventListener("contextmenu",_),window.addEventListener("click",P),$.style.display=="block")e();else{const X=Math.min(A.pageX,window.innerWidth-150),H=Math.min(A.pageY,(window.innerHeight>300?window.innerHeight-50:window.innerHeight)-120);$.style.display="block",$.style.left=X+"px",$.style.top=H+"px"}}}}async function Ar(i){const e=await C.scene.local.getItems(n=>n.metadata[`${u.EXTENSIONID}/doorId`]!==void 0),t=[];for(let n of e){let r=!1;for(const o of i)n.metadata[`${u.EXTENSIONID}/doorId`]==o.id&&(r=!0);r&&t.push(n.id)}await C.scene.local.deleteItems(t)}async function zt(i){const e=[],t=await C.scene.local.getItems(n=>n.metadata[`${u.EXTENSIONID}/doorId`]!==void 0);for(const n of i){if(!Nr(n)||t.some(l=>l.metadata[`${u.EXTENSIONID}/doorId`]===n.id))continue;const r=We.fromItem(n),o=[];for(let l=0;l<n.points.length;l++){const c=We.fromPosition(n.points[l]);o.push(We.decompose(We.multiply(r,c)).position)}e.push(ft().locked(!0).commands(Di(n.metadata[`${u.EXTENSIONID}/disabled`]===!0)).scale({x:.2,y:.2}).name("Door").position(Ke.centroid(o)).metadata({[`${u.EXTENSIONID}/doorId`]:n.id}).build())}e.length>0&&await C.scene.local.addItems(e)}async function Mr(i){const e=await C.scene.local.getItems(t=>t.id===i&&t.metadata[`${u.EXTENSIONID}/doorId`]!==void 0);if(e.length===1){const t=e[0].metadata[`${u.EXTENSIONID}/doorId`],n=I.sceneItems.filter(r=>r.id===t);await C.scene.items.updateItems(n,r=>{const o=r[0];o.metadata[`${u.EXTENSIONID}/isVisionLine`]&&o.metadata[`${u.EXTENSIONID}/disabled`]?(delete o.metadata[`${u.EXTENSIONID}/disabled`],delete o.metadata[`${u.EXTENSIONID}/doorOpen`]):o.metadata[`${u.EXTENSIONID}/isVisionLine`]&&(o.metadata[`${u.EXTENSIONID}/disabled`]=!0,o.metadata[`${u.EXTENSIONID}/doorOpen`]=!0)}),await C.player.deselect([i])}}async function Pr(){const i=I.sceneItems.filter(e=>e.metadata[`${u.EXTENSIONID}/isDoor`]===!0);await zt(i)}function Di(i){return i?u.DOOROPEN:u.DOORCLOSED}var Ai={exports:{}};(function(i){(function(){function e(c,p){var y=c.x-p.x,N=c.y-p.y;return y*y+N*N}function t(c,p,y){var N=p.x,x=p.y,M=y.x-N,A=y.y-x;if(M!==0||A!==0){var b=((c.x-N)*M+(c.y-x)*A)/(M*M+A*A);b>1?(N=y.x,x=y.y):b>0&&(N+=M*b,x+=A*b)}return M=c.x-N,A=c.y-x,M*M+A*A}function n(c,p){for(var y=c[0],N=[y],x,M=1,A=c.length;M<A;M++)x=c[M],e(x,y)>p&&(N.push(x),y=x);return y!==x&&N.push(x),N}function r(c,p,y,N,x){for(var M=N,A,b=p+1;b<y;b++){var $=t(c[b],c[p],c[y]);$>M&&(A=b,M=$)}M>N&&(A-p>1&&r(c,p,A,N,x),x.push(c[A]),y-A>1&&r(c,A,y,N,x))}function o(c,p){var y=c.length-1,N=[c[0]];return r(c,0,y,p,N),N.push(c[y]),N}function l(c,p,y){if(c.length<=2)return c;var N=p!==void 0?p*p:1;return c=y?c:n(c,N),c=o(c,N),c}i.exports=l,i.exports.default=l})()})(Ai);var $r=Ai.exports;const Lr=Fn($r);function Mn(i){const e=I.sceneItems.filter(r=>r.layer==="MAP"),t={};for(let r=0;r<e.length;r++){let o=i.querySelector("#map-"+e[r].id);o===null&&(o=document.createElement("option"),o.id="map-"+e[r].id,o.value=e[r].id,o.innerText=e[r].name,i.appendChild(o)),t[e[r].id]=e[r].name}let n=i.querySelectorAll("option");for(let r=0;r<n.length;r++)t[n[r].value]===void 0&&i.removeChild(n[r])}async function Rr(i,e,t,n,r){if(r.innerText="",Number.isNaN(t)||t<0){r.innerText="Invalid DPI";return}let o=I.gridDpi/t,l,c=[];if(c[0]=0,c[1]=0,n!==""){let p=await C.scene.items.getItems([n]);if(p.length>0)l=p[0],t===0&&(t=l.grid.dpi),o=I.gridDpi/t,c[0]=l.position.x-l.grid.offset.x*o,c[1]=l.position.y-l.grid.offset.y*o;else{r.innerText="Unable to find map";return}}else{r.innerText="No map selected";return}i==="foundry"?Xr(e,o,c,r):i==="uvtt"&&Fr(e,o,c,r)}function di(i){const e="#000000",n=[],r=[];for(const o of i){const l=[];for(const p of o)l.push({x:p.x*I.gridDpi,y:p.y*I.gridDpi});const c=mt().tension(0).points(l).strokeColor(I.sceneMetadata[`${u.EXTENSIONID}/toolColor`]??e).strokeDash(I.sceneMetadata[`${u.EXTENSIONID}/toolStyle`]??n).strokeWidth(I.sceneMetadata[`${u.EXTENSIONID}/toolWidth`]??8).fillOpacity(0).fillColor("#000000").layer("DRAWING").name("Vision Line (Line)").closed(!1).locked(!0).visible(!1).metadata({[`${u.EXTENSIONID}/isVisionLine`]:!0}).build();r.push(c)}return r}async function Br(i,e){let t=[];if(i.objects_line_of_sight.length>0&&(t=t.concat(di(i.objects_line_of_sight))),i.line_of_sight.length>0&&(t=t.concat(di(i.line_of_sight))),i.lights.length>0){const p=[];for(const y of i.lights){const N=Er({height:150,width:150,url:"https://battle-system.com/blank.png",mime:"image/png"},{dpi:300,offset:{x:150,y:150}}).position({x:y.position.x*I.gridDpi,y:y.position.y*I.gridDpi}).layer("CHARACTER").metadata({[`${u.EXTENSIONID}/hasVision`]:!0,[`${u.EXTENSIONID}/visionRange`]:y.range.toString(),[`${u.EXTENSIONID}/visionTorch`]:!0,[`${u.EXTENSIONID}/hiddenToken`]:!0}).name("Imported Light Source").build();p.push(N)}t=t.concat(p)}const n=atob(i.image),r=new Uint8Array(n.length);for(let p=0;p<n.length;p++)r[p]=n.charCodeAt(p);const o=new Blob([r],{type:"image/png"}),l=wr(o).grid({dpi:i.resolution.pixels_per_grid,offset:{x:0,y:0}}).build(),c=br().baseMap(l).name("New UVTT Scene").items(t).build();await C.assets.uploadScenes([c],!0),await C.notification.show("Toggle Smoke Off then On when opening the new Scene","DEFAULT")}async function Mi(i,e,t,n,r){let o=0,l=0,c=0;const p=[];for(let y=0;y<i.length;y++){let N=[],x=!1;for(let M=0;M<i[y].length-1;M++){let A=i[y][M].x*e,b=i[y][M].y*e,$=i[y][M+1].x*e,_=i[y][M+1].y*e;N.push({x:A*t+n[0],y:b*t+n[1]}),N.push({x:$*t+n[0],y:_*t+n[1]}),l++,!x&&i[y][M].door&&(x=!0)}N.length>128&&(N.length,N=Lr(N,8,!1));for(let M=0;M<N.length;M+=256){const A=N.slice(M>0?M-1:0,M+256),b=mt().tension(0).points(A).fillColor("#000000").fillOpacity(0).layer("DRAWING").name("Vision Line (Import)").closed(!1).locked(!0).build();if(b.visible=!1,b.metadata[`${u.EXTENSIONID}/isVisionLine`]=!0,x&&(b.metadata[`${u.EXTENSIONID}/isDoor`]=!0),p.push(b),c+=A.length,c>512||p.length>64){o+=p.length,await C.scene.items.addItems(p);const $=p.filter(_=>_.metadata[`${u.EXTENSIONID}/isDoor`]===!0);await zt($),p.length=0,c=0}}}if(p.length>0){o+=p.length,await C.scene.items.addItems(p);const y=p.filter(N=>N.metadata[`${u.EXTENSIONID}/isDoor`]===!0);await zt(y)}r.innerText="Finished importing "+o+" walls, "+l+" points."}function Fr(i,e,t,n){if(i.resolution.map_origin!==void 0&&(t[0]-=i.resolution.map_origin.x*i.resolution.pixels_per_grid,t[1]-=i.resolution.map_origin.y*i.resolution.pixels_per_grid),i.portals&&i.portals.length)for(let o=0;o<i.portals.length;o++){let l=i.portals[o].bounds;l[0].door=!0,l[1].door=!0,i.line_of_sight.push(l)}const r=i.line_of_sight.concat(i.objects_line_of_sight);Mi(r,i.resolution.pixels_per_grid,e,t,n)}function Xr(i,e,t,n){if(!i.walls||i.walls.length===0){n.innerText="No walls found";return}const r=[];for(var o=0;o<i.walls.length;o++)r.push([{x:i.walls[o].c[0],y:i.walls[o].c[1],door:!!i.walls[o].door},{x:i.walls[o].c[2],y:i.walls[o].c[3],door:!!i.walls[o].door}]);Mi(r,1,e,t,n)}async function fi(){await C.contextMenu.create({id:`${u.EXTENSIONID}/convert-curve`,icons:[{icon:"/opendoor.svg",label:"Convert to Obstruction",filter:{every:[{key:"layer",value:"DRAWING"},{key:["metadata",`${u.EXTENSIONID}/isVisionLine`],value:void 0}],roles:["GM"]}}],async onClick(i){const e="#000000",n=[],r=[],o=[];for(const l of i.items){if(l.type==="CURVE"){const c=l;if(c.points.length>2){const p=mt().tension(0).points(c.points).strokeColor(I.sceneMetadata[`${u.EXTENSIONID}/toolColor`]??e).strokeDash(I.sceneMetadata[`${u.EXTENSIONID}/toolStyle`]??n).strokeWidth(I.sceneMetadata[`${u.EXTENSIONID}/toolWidth`]??8).fillOpacity(0).fillColor("#000000").layer("DRAWING").name("Vision Line (Line)").closed(!1).locked(!0).visible(!1).position(c.position).metadata({[`${u.EXTENSIONID}/isVisionLine`]:!0}).build();c.style.closed&&p.points.push(c.points[0]),r.push(p),o.push(c.id)}}else if(l.type==="LINE"){const c=l,p=mt().tension(0).points([c.startPosition,c.endPosition]).strokeColor(I.sceneMetadata[`${u.EXTENSIONID}/toolColor`]??e).strokeDash(I.sceneMetadata[`${u.EXTENSIONID}/toolStyle`]??n).strokeWidth(I.sceneMetadata[`${u.EXTENSIONID}/toolWidth`]??8).fillOpacity(0).fillColor("#000000").layer("DRAWING").name("Vision Line (Line)").closed(!1).locked(!0).visible(!1).position(c.position).metadata({[`${u.EXTENSIONID}/isVisionLine`]:!0}).build();r.push(p),o.push(c.id)}else if(l.type==="SHAPE"){const c=l,p=[];if(c.shapeType==="CIRCLE"){const y=Math.min(c.width,c.height)/2,N=2*Math.PI/20;for(let x=0;x<20;x++){const M=x*N,A=y*Math.cos(M),b=y*Math.sin(M);p.push({x:A,y:b})}}else if(c.shapeType==="RECTANGLE"){const x=0+c.width,M=0+c.height;p.push({x:0,y:0}),p.push({x,y:0}),p.push({x,y:M}),p.push({x:0,y:M})}else if(c.shapeType==="HEXAGON"){const y=c.width/2,N=[Math.PI/2,Math.PI/6,11*Math.PI/6,3*Math.PI/2,7*Math.PI/6,5*Math.PI/6];for(let x=0;x<6;x++){const M=N[x],A=y*Math.cos(M),b=y*Math.sin(M);p.push({x:A,y:b})}}else c.shapeType==="TRIANGLE"&&(p.push({x:0,y:0}),p.push({x:0-c.width/2,y:0+c.height}),p.push({x:0+c.width/2,y:0+c.height}));if(p.length>0){const y=mt().tension(0).points(p).position(c.position).rotation(c.rotation).strokeColor(I.sceneMetadata[`${u.EXTENSIONID}/toolColor`]??e).strokeDash(I.sceneMetadata[`${u.EXTENSIONID}/toolStyle`]??n).strokeWidth(I.sceneMetadata[`${u.EXTENSIONID}/toolWidth`]??8).fillOpacity(0).fillColor("#000000").layer("DRAWING").name("Vision Line (Line)").closed(!1).locked(!0).visible(!1).metadata({[`${u.EXTENSIONID}/isVisionLine`]:!0}).build();y.points.push(p[0]),r.push(y),o.push(c.id)}}r.length>0&&(await C.scene.items.addItems(r),await C.scene.items.deleteItems(o))}}}),await C.contextMenu.create({id:`${u.EXTENSIONID}/toggle-vision-menu`,icons:[{icon:"/no-vision.svg",label:"Enable Vision",filter:{every:[{key:["metadata",`${u.EXTENSIONID}/hasVision`],operator:"==",value:void 0,coordinator:"&&"},{key:["metadata",`${u.SPECTREID}/spectred`],operator:"==",value:void 0}],some:[{key:"layer",value:"CHARACTER",coordinator:"||"},{key:"layer",value:"ATTACHMENT"}]}},{icon:"/icon.svg",label:"Disable Vision",filter:{every:[{key:["metadata",`${u.SPECTREID}/spectred`],operator:"==",value:void 0}],some:[{key:"layer",value:"CHARACTER",coordinator:"||"},{key:"layer",value:"ATTACHMENT"}]}}],async onClick(i){const e=i.items.every(t=>t.metadata[`${u.EXTENSIONID}/hasVision`]===void 0);await C.scene.items.updateItems(i.items,t=>{for(const n of t)e?(n.metadata[`${u.EXTENSIONID}/hasVision`]=!0,n.metadata[`${u.EXTENSIONID}/visionRange`]===void 0&&(n.metadata[`${u.EXTENSIONID}/visionRange`]=u.VISIONDEFAULT)):delete n.metadata[`${u.EXTENSIONID}/hasVision`]})}}),await C.contextMenu.create({id:`${u.EXTENSIONID}/toggle-groupvision-menu`,icons:[{icon:"/no-vision.svg",label:"Toggle Attachments Vision",filter:{every:[{key:"layer",value:"NOTE"},{key:["metadata",`${u.EXTENSIONID}/hasVision`],value:void 0}]}}],async onClick(i){if(i.items.length>0){const e=i.items.map(n=>n.id),t=await C.scene.items.getItemAttachments(e);await C.scene.items.updateItems(t,n=>{for(const r of n)e.includes(r.attachedTo)&&(r.metadata[`${u.EXTENSIONID}/hasVision`]&&(r.layer=="CHARACTER"||r.layer=="ATTACHMENT")?delete r.metadata[`${u.EXTENSIONID}/hasVision`]:(r.layer=="CHARACTER"||r.layer=="ATTACHMENT")&&(r.metadata[`${u.EXTENSIONID}/hasVision`]=!0,r.metadata[`${u.EXTENSIONID}/visionRange`]===void 0&&(r.metadata[`${u.EXTENSIONID}/visionRange`]=u.VISIONDEFAULT)))})}}}),await C.contextMenu.create({id:`${u.EXTENSIONID}/toggle-vision-line`,icons:[{icon:"/icon.svg",label:"Disable Vision Line",filter:{some:[{key:["metadata",`${u.EXTENSIONID}/isVisionLine`],value:!0,coordinator:"&&"},{key:["metadata",`${u.EXTENSIONID}/disabled`],value:void 0,coordinator:"||"},{key:["metadata",`${u.ARMINDOID}/isVisionLine`],value:!0,coordinator:"&&"},{key:["metadata",`${u.ARMINDOID}/disabled`],value:void 0}]}},{icon:"/no-vision.svg",label:"Enable Vision Line",filter:{some:[{key:["metadata",`${u.EXTENSIONID}/isVisionLine`],value:!0,coordinator:"||"},{key:["metadata",`${u.ARMINDOID}/isVisionLine`],value:!0}]}}],async onClick(i){await C.scene.items.updateItems(i.items,e=>{for(const t of e)t.metadata[`${u.EXTENSIONID}/isVisionLine`]&&t.metadata[`${u.EXTENSIONID}/disabled`]?delete t.metadata[`${u.EXTENSIONID}/disabled`]:t.metadata[`${u.EXTENSIONID}/isVisionLine`]&&(t.metadata[`${u.EXTENSIONID}/disabled`]=!0)})}}),await C.contextMenu.create({id:`${u.EXTENSIONID}/switch-one-sided-type`,icons:[{icon:"/two-sided.svg",label:"Two-sided",filter:{some:[{key:["metadata",`${u.EXTENSIONID}/isVisionLine`],value:!0,coordinator:"&&"},{key:["metadata",`${u.EXTENSIONID}/oneSided`],value:void 0,coordinator:"||"},{key:["metadata",`${u.ARMINDOID}/isVisionLine`],value:!0,coordinator:"&&"},{key:["metadata",`${u.ARMINDOID}/oneSided`],value:void 0}]}},{icon:"/left-sided.svg",label:"One-sided left",filter:{some:[{key:["metadata",`${u.EXTENSIONID}/isVisionLine`],value:!0,coordinator:"&&"},{key:["metadata",`${u.EXTENSIONID}/oneSided`],value:"left",coordinator:"||"},{key:["metadata",`${u.ARMINDOID}/isVisionLine`],value:!0,coordinator:"&&"},{key:["metadata",`${u.ARMINDOID}/oneSided`],value:"left"}]}},{icon:"/right-sided.svg",label:"One-sided right",filter:{some:[{key:["metadata",`${u.EXTENSIONID}/isVisionLine`],value:!0,coordinator:"||"},{key:["metadata",`${u.ARMINDOID}/isVisionLine`],value:!0}]}}],async onClick(i){await C.scene.items.updateItems(i.items,e=>{for(const t of e)(t.metadata[`${u.EXTENSIONID}/isVisionLine`]||t.metadata[`${u.ARMINDOID}/isVisionLine`])&&(t.metadata[`${u.EXTENSIONID}/oneSided`]=="right"||t.metadata[`${u.ARMINDOID}/oneSided`]=="right")?(delete t.metadata[`${u.EXTENSIONID}/oneSided`],delete t.metadata[`${u.ARMINDOID}/oneSided`]):(t.metadata[`${u.EXTENSIONID}/isVisionLine`]||t.metadata[`${u.ARMINDOID}/isVisionLine`])&&(t.metadata[`${u.EXTENSIONID}/oneSided`]=="left"||t.metadata[`${u.ARMINDOID}/oneSided`]=="left")?(t.metadata[`${u.EXTENSIONID}/oneSided`]="right",t.metadata[`${u.ARMINDOID}/oneSided`]="right"):(t.metadata[`${u.EXTENSIONID}/isVisionLine`]||t.metadata[`${u.ARMINDOID}/isVisionLine`])&&(t.metadata[`${u.EXTENSIONID}/oneSided`]="left",t.metadata[`${u.ARMINDOID}/oneSided`]="left")})}}),await C.contextMenu.create({id:`${u.EXTENSIONID}/toggle-fog-background`,icons:[{icon:"/fog-background.svg",label:"Convert To Fog Background",filter:{every:[{key:"layer",value:"MAP"}]}}],async onClick(i){i.items.length>0&&await C.scene.items.updateItems(i.items,e=>{for(let t=0;t<e.length;t++)e[t].zIndex=1,e[t].layer="FOG",e[t].disableHit=!0,e[t].locked=!1,e[t].visible=!1,e[t].metadata[`${u.EXTENSIONID}/isBackgroundMap`]=!0})}}),await C.contextMenu.create({id:`${u.EXTENSIONID}/bounding-grid`,icons:[{icon:"/icon.svg",label:"Smoke Bounding Grid",filter:{every:[{key:["metadata",`${u.EXTENSIONID}/grid`],value:!0}]}}],async onClick(i){await C.notification.show("This is the Smoke&Spectre Bounding Grid. It contains the area your fog can be drawn in. To remove this and have fog contained dynamically by the size of your map(s), turn on AutoDetect Maps in Settings.","INFO")}}),await C.contextMenu.create({id:`${u.EXTENSIONID}/toggle-door`,icons:[{icon:"/opendoor.svg",label:"Enable Door",filter:{every:[{key:"layer",value:"DRAWING"},{key:["metadata",`${u.EXTENSIONID}/isVisionLine`],value:!0},{key:["metadata",`${u.EXTENSIONID}/isDoor`],value:void 0},{key:["metadata",`${u.EXTENSIONID}/doorId`],value:void 0},{key:["metadata",`${u.EXTENSIONID}/grid`],value:void 0}],roles:["GM"]}},{icon:"/closedoor.svg",label:"Disable Door",filter:{every:[{key:"layer",value:"DRAWING"},{key:["metadata",`${u.EXTENSIONID}/isVisionLine`],value:!0},{key:["metadata",`${u.EXTENSIONID}/doorId`],value:void 0},{key:["metadata",`${u.EXTENSIONID}/grid`],value:void 0}],roles:["GM"]}}],async onClick(i){const e=i.items.every(t=>t.metadata[`${u.EXTENSIONID}/isDoor`]===void 0);await C.scene.items.updateItems(i.items,t=>{for(const n of t)e?n.metadata[`${u.EXTENSIONID}/isDoor`]=!0:delete n.metadata[`${u.EXTENSIONID}/isDoor`]}),e?await zt(i.items):await Ar(i.items)}})}async function Zt(i){i?await C.contextMenu.create({id:`${u.EXTENSIONID}/toggle-autohide-menu`,icons:[{icon:"/autohide-off.svg",label:"Enable Autohide",filter:{every:[{key:"layer",value:"CHARACTER"},{key:["metadata",`${u.EXTENSIONID}/hasAutohide`],value:void 0}],roles:["GM"]}},{icon:"/autohide-on.svg",label:"Disable Autohide",filter:{every:[{key:"layer",value:"CHARACTER"}],roles:["GM"]}}],async onClick(e){const t=e.items.every(n=>n.metadata[`${u.EXTENSIONID}/hasAutohide`]===void 0);await C.scene.items.updateItems(e.items,n=>{for(const r of n)t?r.metadata[`${u.EXTENSIONID}/hasAutohide`]=!0:delete r.metadata[`${u.EXTENSIONID}/hasAutohide`]})}}):await C.contextMenu.remove(`${u.EXTENSIONID}/toggle-autohide-menu`)}function wn(i,e){i.split(/\s+/).forEach(t=>{e(t)})}class Vr{constructor(){this._events=void 0,this._events={}}on(e,t){wn(e,n=>{const r=this._events[n]||[];r.push(t),this._events[n]=r})}off(e,t){var n=arguments.length;if(n===0){this._events={};return}wn(e,r=>{if(n===1){delete this._events[r];return}const o=this._events[r];o!==void 0&&(o.splice(o.indexOf(t),1),this._events[r]=o)})}trigger(e,...t){var n=this;wn(e,r=>{const o=n._events[r];o!==void 0&&o.forEach(l=>{l.apply(n,t)})})}}function Hr(i){return i.plugins={},class extends i{constructor(...e){super(...e),this.plugins={names:[],settings:{},requested:{},loaded:{}}}static define(e,t){i.plugins[e]={name:e,fn:t}}initializePlugins(e){var t,n;const r=this,o=[];if(Array.isArray(e))e.forEach(l=>{typeof l=="string"?o.push(l):(r.plugins.settings[l.name]=l.options,o.push(l.name))});else if(e)for(t in e)e.hasOwnProperty(t)&&(r.plugins.settings[t]=e[t],o.push(t));for(;n=o.shift();)r.require(n)}loadPlugin(e){var t=this,n=t.plugins,r=i.plugins[e];if(!i.plugins.hasOwnProperty(e))throw new Error('Unable to find "'+e+'" plugin');n.requested[e]=!0,n.loaded[e]=r.fn.apply(t,[t.plugins.settings[e]||{}]),n.names.push(e)}require(e){var t=this,n=t.plugins;if(!t.plugins.loaded.hasOwnProperty(e)){if(n.requested[e])throw new Error('Plugin has circular dependency ("'+e+'")');t.loadPlugin(e)}return n.loaded[e]}}}/*! @orchidjs/unicode-variants | https://github.com/orchidjs/unicode-variants | Apache License (v2) */const nn=i=>(i=i.filter(Boolean),i.length<2?i[0]||"":Gr(i)==1?"["+i.join("")+"]":"(?:"+i.join("|")+")"),Pi=i=>{if(!Ur(i))return i.join("");let e="",t=0;const n=()=>{t>1&&(e+="{"+t+"}")};return i.forEach((r,o)=>{if(r===i[o-1]){t++;return}n(),e+=r,t=1}),n(),e},$i=i=>{let e=Vn(i);return nn(e)},Ur=i=>new Set(i).size!==i.length,Ct=i=>(i+"").replace(/([\$\(\)\*\+\.\?\[\]\^\{\|\}\\])/gu,"\\$1"),Gr=i=>i.reduce((e,t)=>Math.max(e,jr(t)),0),jr=i=>Vn(i).length,Vn=i=>Array.from(i);/*! @orchidjs/unicode-variants | https://github.com/orchidjs/unicode-variants | Apache License (v2) */const Li=i=>{if(i.length===1)return[[i]];let e=[];const t=i.substring(1);return Li(t).forEach(function(r){let o=r.slice(0);o[0]=i.charAt(0)+o[0],e.push(o),o=r.slice(0),o.unshift(i.charAt(0)),e.push(o)}),e};/*! @orchidjs/unicode-variants | https://github.com/orchidjs/unicode-variants | Apache License (v2) */const Wr=[[0,65535]],qr="[̀-ͯ·ʾʼ]";let Jt,Ri;const Kr=3,Hn={},hi={"/":"⁄∕",0:"߀",a:"ⱥɐɑ",aa:"ꜳ",ae:"æǽǣ",ao:"ꜵ",au:"ꜷ",av:"ꜹꜻ",ay:"ꜽ",b:"ƀɓƃ",c:"ꜿƈȼↄ",d:"đɗɖᴅƌꮷԁɦ",e:"ɛǝᴇɇ",f:"ꝼƒ",g:"ǥɠꞡᵹꝿɢ",h:"ħⱨⱶɥ",i:"ɨı",j:"ɉȷ",k:"ƙⱪꝁꝃꝅꞣ",l:"łƚɫⱡꝉꝇꞁɭ",m:"ɱɯϻ",n:"ꞥƞɲꞑᴎлԉ",o:"øǿɔɵꝋꝍᴑ",oe:"œ",oi:"ƣ",oo:"ꝏ",ou:"ȣ",p:"ƥᵽꝑꝓꝕρ",q:"ꝗꝙɋ",r:"ɍɽꝛꞧꞃ",s:"ßȿꞩꞅʂ",t:"ŧƭʈⱦꞇ",th:"þ",tz:"ꜩ",u:"ʉ",v:"ʋꝟʌ",vy:"ꝡ",w:"ⱳ",y:"ƴɏỿ",z:"ƶȥɀⱬꝣ",hv:"ƕ"};for(let i in hi){let e=hi[i]||"";for(let t=0;t<e.length;t++){let n=e.substring(t,t+1);Hn[n]=i}}const Yr=new RegExp(Object.keys(Hn).join("|")+"|"+qr,"gu"),zr=i=>{Jt===void 0&&(Jt=eo(i||Wr))},pi=(i,e="NFKD")=>i.normalize(e),Qt=i=>Vn(i).reduce((e,t)=>e+Zr(t),""),Zr=i=>(i=pi(i).toLowerCase().replace(Yr,e=>Hn[e]||""),pi(i,"NFC"));function*Jr(i){for(const[e,t]of i)for(let n=e;n<=t;n++){let r=String.fromCharCode(n),o=Qt(r);o!=r.toLowerCase()&&(o.length>Kr||o.length!=0&&(yield{folded:o,composed:r,code_point:n}))}}const Qr=i=>{const e={},t=(n,r)=>{const o=e[n]||new Set,l=new RegExp("^"+$i(o)+"$","iu");r.match(l)||(o.add(Ct(r)),e[n]=o)};for(let n of Jr(i))t(n.folded,n.folded),t(n.folded,n.composed);return e},eo=i=>{const e=Qr(i),t={};let n=[];for(let o in e){let l=e[o];l&&(t[o]=$i(l)),o.length>1&&n.push(Ct(o))}n.sort((o,l)=>l.length-o.length);const r=nn(n);return Ri=new RegExp("^"+r,"u"),t},to=(i,e=1)=>{let t=0;return i=i.map(n=>(Jt[n]&&(t+=n.length),Jt[n]||n)),t>=e?Pi(i):""},no=(i,e=1)=>(e=Math.max(e,i.length-1),nn(Li(i).map(t=>to(t,e)))),gi=(i,e=!0)=>{let t=i.length>1?1:0;return nn(i.map(n=>{let r=[];const o=e?n.length():n.length()-1;for(let l=0;l<o;l++)r.push(no(n.substrs[l]||"",t));return Pi(r)}))},io=(i,e)=>{for(const t of e){if(t.start!=i.start||t.end!=i.end||t.substrs.join("")!==i.substrs.join(""))continue;let n=i.parts;const r=l=>{for(const c of n){if(c.start===l.start&&c.substr===l.substr)return!1;if(!(l.length==1||c.length==1)&&(l.start<c.start&&l.end>c.start||c.start<l.start&&c.end>l.start))return!0}return!1};if(!(t.parts.filter(r).length>0))return!0}return!1};class en{constructor(){this.parts=[],this.substrs=[],this.start=0,this.end=0}add(e){e&&(this.parts.push(e),this.substrs.push(e.substr),this.start=Math.min(e.start,this.start),this.end=Math.max(e.end,this.end))}last(){return this.parts[this.parts.length-1]}length(){return this.parts.length}clone(e,t){let n=new en,r=JSON.parse(JSON.stringify(this.parts)),o=r.pop();for(const p of r)n.add(p);let l=t.substr.substring(0,e-o.start),c=l.length;return n.add({start:o.start,end:o.start+c,length:c,substr:l}),n}}const ro=i=>{zr(),i=Qt(i);let e="",t=[new en];for(let n=0;n<i.length;n++){let o=i.substring(n).match(Ri);const l=i.substring(n,n+1),c=o?o[0]:null;let p=[],y=new Set;for(const N of t){const x=N.last();if(!x||x.length==1||x.end<=n)if(c){const M=c.length;N.add({start:n,end:n+M,length:M,substr:c}),y.add("1")}else N.add({start:n,end:n+1,length:1,substr:l}),y.add("2");else if(c){let M=N.clone(n,x);const A=c.length;M.add({start:n,end:n+A,length:A,substr:c}),p.push(M)}else y.add("3")}if(p.length>0){p=p.sort((N,x)=>N.length()-x.length());for(let N of p)io(N,t)||t.push(N);continue}if(n>0&&y.size==1&&!y.has("3")){e+=gi(t,!1);let N=new en;const x=t[0];x&&N.add(x.last()),t=[N]}}return e+=gi(t,!0),e};/*! sifter.js | https://github.com/orchidjs/sifter.js | Apache License (v2) */const oo=(i,e)=>{if(i)return i[e]},so=(i,e)=>{if(i){for(var t,n=e.split(".");(t=n.shift())&&(i=i[t]););return i}},bn=(i,e,t)=>{var n,r;return!i||(i=i+"",e.regex==null)||(r=i.search(e.regex),r===-1)?0:(n=e.string.length/i.length,r===0&&(n+=.5),n*t)},Sn=(i,e)=>{var t=i[e];if(typeof t=="function")return t;t&&!Array.isArray(t)&&(i[e]=[t])},Qe=(i,e)=>{if(Array.isArray(i))i.forEach(e);else for(var t in i)i.hasOwnProperty(t)&&e(i[t],t)},ao=(i,e)=>typeof i=="number"&&typeof e=="number"?i>e?1:i<e?-1:0:(i=Qt(i+"").toLowerCase(),e=Qt(e+"").toLowerCase(),i>e?1:e>i?-1:0);/*! sifter.js | https://github.com/orchidjs/sifter.js | Apache License (v2) */class lo{constructor(e,t){this.items=void 0,this.settings=void 0,this.items=e,this.settings=t||{diacritics:!0}}tokenize(e,t,n){if(!e||!e.length)return[];const r=[],o=e.split(/\s+/);var l;return n&&(l=new RegExp("^("+Object.keys(n).map(Ct).join("|")+"):(.*)$")),o.forEach(c=>{let p,y=null,N=null;l&&(p=c.match(l))&&(y=p[1],c=p[2]),c.length>0&&(this.settings.diacritics?N=ro(c)||null:N=Ct(c),N&&t&&(N="\\b"+N)),r.push({string:c,regex:N?new RegExp(N,"iu"):null,field:y})}),r}getScoreFunction(e,t){var n=this.prepareSearch(e,t);return this._getScoreFunction(n)}_getScoreFunction(e){const t=e.tokens,n=t.length;if(!n)return function(){return 0};const r=e.options.fields,o=e.weights,l=r.length,c=e.getAttrFn;if(!l)return function(){return 1};const p=function(){return l===1?function(y,N){const x=r[0].field;return bn(c(N,x),y,o[x]||1)}:function(y,N){var x=0;if(y.field){const M=c(N,y.field);!y.regex&&M?x+=1/l:x+=bn(M,y,1)}else Qe(o,(M,A)=>{x+=bn(c(N,A),y,M)});return x/l}}();return n===1?function(y){return p(t[0],y)}:e.options.conjunction==="and"?function(y){var N,x=0;for(let M of t){if(N=p(M,y),N<=0)return 0;x+=N}return x/n}:function(y){var N=0;return Qe(t,x=>{N+=p(x,y)}),N/n}}getSortFunction(e,t){var n=this.prepareSearch(e,t);return this._getSortFunction(n)}_getSortFunction(e){var t,n=[];const r=this,o=e.options,l=!e.query&&o.sort_empty?o.sort_empty:o.sort;if(typeof l=="function")return l.bind(this);const c=function(N,x){return N==="$score"?x.score:e.getAttrFn(r.items[x.id],N)};if(l)for(let y of l)(e.query||y.field!=="$score")&&n.push(y);if(e.query){t=!0;for(let y of n)if(y.field==="$score"){t=!1;break}t&&n.unshift({field:"$score",direction:"desc"})}else n=n.filter(y=>y.field!=="$score");return n.length?function(y,N){var x,M;for(let A of n)if(M=A.field,x=(A.direction==="desc"?-1:1)*ao(c(M,y),c(M,N)),x)return x;return 0}:null}prepareSearch(e,t){const n={};var r=Object.assign({},t);if(Sn(r,"sort"),Sn(r,"sort_empty"),r.fields){Sn(r,"fields");const o=[];r.fields.forEach(l=>{typeof l=="string"&&(l={field:l,weight:1}),o.push(l),n[l.field]="weight"in l?l.weight:1}),r.fields=o}return{options:r,query:e.toLowerCase().trim(),tokens:this.tokenize(e,r.respect_word_boundaries,n),total:0,items:[],weights:n,getAttrFn:r.nesting?so:oo}}search(e,t){var n=this,r,o;o=this.prepareSearch(e,t),t=o.options,e=o.query;const l=t.score||n._getScoreFunction(o);e.length?Qe(n.items,(p,y)=>{r=l(p),(t.filter===!1||r>0)&&o.items.push({score:r,id:y})}):Qe(n.items,(p,y)=>{o.items.push({score:1,id:y})});const c=n._getSortFunction(o);return c&&o.items.sort(c),o.total=o.items.length,typeof t.limit=="number"&&(o.items=o.items.slice(0,t.limit)),o}}const St=(i,e)=>{if(Array.isArray(i))i.forEach(e);else for(var t in i)i.hasOwnProperty(t)&&e(i[t],t)},je=i=>{if(i.jquery)return i[0];if(i instanceof HTMLElement)return i;if(Bi(i)){var e=document.createElement("template");return e.innerHTML=i.trim(),e.content.firstChild}return document.querySelector(i)},Bi=i=>typeof i=="string"&&i.indexOf("<")>-1,co=i=>i.replace(/['"\\]/g,"\\$&"),Tn=(i,e)=>{var t=document.createEvent("HTMLEvents");t.initEvent(e,!0,!1),i.dispatchEvent(t)},Lt=(i,e)=>{Object.assign(i.style,e)},Je=(i,...e)=>{var t=Fi(e);i=Xi(i),i.map(n=>{t.map(r=>{n.classList.add(r)})})},dt=(i,...e)=>{var t=Fi(e);i=Xi(i),i.map(n=>{t.map(r=>{n.classList.remove(r)})})},Fi=i=>{var e=[];return St(i,t=>{typeof t=="string"&&(t=t.trim().split(/[\11\12\14\15\40]/)),Array.isArray(t)&&(e=e.concat(t))}),e.filter(Boolean)},Xi=i=>(Array.isArray(i)||(i=[i]),i),jt=(i,e,t)=>{if(!(t&&!t.contains(i)))for(;i&&i.matches;){if(i.matches(e))return i;i=i.parentNode}},mi=(i,e=0)=>e>0?i[i.length-1]:i[0],uo=i=>Object.keys(i).length===0,tn=(i,e)=>{if(!i)return-1;e=e||i.nodeName;for(var t=0;i=i.previousElementSibling;)i.matches(e)&&t++;return t},Ve=(i,e)=>{St(e,(t,n)=>{t==null?i.removeAttribute(n):i.setAttribute(n,""+t)})},Pn=(i,e)=>{i.parentNode&&i.parentNode.replaceChild(e,i)},fo=(i,e)=>{if(e===null)return;if(typeof e=="string"){if(!e.length)return;e=new RegExp(e,"i")}const t=o=>{var l=o.data.match(e);if(l&&o.data.length>0){var c=document.createElement("span");c.className="highlight";var p=o.splitText(l.index);p.splitText(l[0].length);var y=p.cloneNode(!0);return c.appendChild(y),Pn(p,c),1}return 0},n=o=>{o.nodeType===1&&o.childNodes&&!/(script|style)/i.test(o.tagName)&&(o.className!=="highlight"||o.tagName!=="SPAN")&&Array.from(o.childNodes).forEach(l=>{r(l)})},r=o=>o.nodeType===3?t(o):(n(o),0);r(i)},ho=i=>{var e=i.querySelectorAll("span.highlight");Array.prototype.forEach.call(e,function(t){var n=t.parentNode;n.replaceChild(t.firstChild,t),n.normalize()})},po=65,go=13,Vi=27,$n=37,mo=38,Hi=39,yo=40,yi=8,vo=46,Ln=9,Io=typeof navigator>"u"?!1:/Mac/.test(navigator.userAgent),Rt=Io?"metaKey":"ctrlKey";var vi={options:[],optgroups:[],plugins:[],delimiter:",",splitOn:null,persist:!0,diacritics:!0,create:null,createOnBlur:!1,createFilter:null,highlight:!0,openOnFocus:!0,shouldOpen:null,maxOptions:50,maxItems:null,hideSelected:null,duplicates:!1,addPrecedence:!1,selectOnTab:!1,preload:null,allowEmptyOption:!1,refreshThrottle:300,loadThrottle:300,loadingClass:"loading",dataAttr:null,optgroupField:"optgroup",valueField:"value",labelField:"text",disabledField:"disabled",optgroupLabelField:"label",optgroupValueField:"value",lockOptgroupOrder:!1,sortField:"$order",searchField:["text"],searchConjunction:"and",mode:null,wrapperClass:"ts-wrapper",controlClass:"ts-control",dropdownClass:"ts-dropdown",dropdownContentClass:"ts-dropdown-content",itemClass:"item",optionClass:"option",dropdownParent:null,controlInput:'<input type="text" autocomplete="off" size="1" />',copyClassesToDropdown:!1,placeholder:null,hidePlaceholder:null,shouldLoad:function(i){return i.length>0},render:{}};const it=i=>typeof i>"u"||i===null?null:Wt(i),Wt=i=>typeof i=="boolean"?i?"1":"0":i+"",qt=i=>(i+"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;"),Eo=(i,e)=>e>0?setTimeout(i,e):(i.call(null),null),wo=(i,e)=>{var t;return function(n,r){var o=this;t&&(o.loading=Math.max(o.loading-1,0),clearTimeout(t)),t=setTimeout(function(){t=null,o.loadedSearches[n]=!0,i.call(o,n,r)},e)}},Ii=(i,e,t)=>{var n,r=i.trigger,o={};i.trigger=function(){var l=arguments[0];if(e.indexOf(l)!==-1)o[l]=arguments;else return r.apply(i,arguments)},t.apply(i,[]),i.trigger=r;for(n of e)n in o&&r.apply(i,o[n])},bo=i=>({start:i.selectionStart||0,length:(i.selectionEnd||0)-(i.selectionStart||0)}),Pe=(i,e=!1)=>{i&&(i.preventDefault(),e&&i.stopPropagation())},$e=(i,e,t,n)=>{i.addEventListener(e,t,n)},vt=(i,e)=>{if(!e||!e[i])return!1;var t=(e.altKey?1:0)+(e.ctrlKey?1:0)+(e.shiftKey?1:0)+(e.metaKey?1:0);return t===1},Nn=(i,e)=>{const t=i.getAttribute("id");return t||(i.setAttribute("id",e),e)},Ei=i=>i.replace(/[\\"']/g,"\\$&"),It=(i,e)=>{e&&i.append(e)};function wi(i,e){var t=Object.assign({},vi,e),n=t.dataAttr,r=t.labelField,o=t.valueField,l=t.disabledField,c=t.optgroupField,p=t.optgroupLabelField,y=t.optgroupValueField,N=i.tagName.toLowerCase(),x=i.getAttribute("placeholder")||i.getAttribute("data-placeholder");if(!x&&!t.allowEmptyOption){let $=i.querySelector('option[value=""]');$&&(x=$.textContent)}var M={placeholder:x,options:[],optgroups:[],items:[],maxItems:null},A=()=>{var $,_=M.options,L={},P=1;let X=0;var H=w=>{var g=Object.assign({},w.dataset),E=n&&g[n];return typeof E=="string"&&E.length&&(g=Object.assign(g,JSON.parse(E))),g},ie=(w,g)=>{var E=it(w.value);if(E!=null&&!(!E&&!t.allowEmptyOption)){if(L.hasOwnProperty(E)){if(g){var h=L[E][c];h?Array.isArray(h)?h.push(g):L[E][c]=[h,g]:L[E][c]=g}}else{var k=H(w);k[r]=k[r]||w.textContent,k[o]=k[o]||E,k[l]=k[l]||w.disabled,k[c]=k[c]||g,k.$option=w,k.$order=k.$order||++X,L[E]=k,_.push(k)}w.selected&&M.items.push(E)}},O=w=>{var g,E;E=H(w),E[p]=E[p]||w.getAttribute("label")||"",E[y]=E[y]||P++,E[l]=E[l]||w.disabled,E.$order=E.$order||++X,M.optgroups.push(E),g=E[y],St(w.children,h=>{ie(h,g)})};M.maxItems=i.hasAttribute("multiple")?null:1,St(i.children,w=>{$=w.tagName.toLowerCase(),$==="optgroup"?O(w):$==="option"&&ie(w)})},b=()=>{const $=i.getAttribute(n);if($)M.options=JSON.parse($),St(M.options,L=>{M.items.push(L[o])});else{var _=i.value.trim()||"";if(!t.allowEmptyOption&&!_.length)return;const L=_.split(t.delimiter);St(L,P=>{const X={};X[r]=P,X[o]=P,M.options.push(X)}),M.items=L}};return N==="select"?A():b(),Object.assign({},vi,M,e)}var bi=0;class et extends Hr(Vr){constructor(e,t){super(),this.control_input=void 0,this.wrapper=void 0,this.dropdown=void 0,this.control=void 0,this.dropdown_content=void 0,this.focus_node=void 0,this.order=0,this.settings=void 0,this.input=void 0,this.tabIndex=void 0,this.is_select_tag=void 0,this.rtl=void 0,this.inputId=void 0,this._destroy=void 0,this.sifter=void 0,this.isOpen=!1,this.isDisabled=!1,this.isReadOnly=!1,this.isRequired=void 0,this.isInvalid=!1,this.isValid=!0,this.isLocked=!1,this.isFocused=!1,this.isInputHidden=!1,this.isSetup=!1,this.ignoreFocus=!1,this.ignoreHover=!1,this.hasOptions=!1,this.currentResults=void 0,this.lastValue="",this.caretPos=0,this.loading=0,this.loadedSearches={},this.activeOption=null,this.activeItems=[],this.optgroups={},this.options={},this.userOptions={},this.items=[],this.refreshTimeout=null,bi++;var n,r=je(e);if(r.tomselect)throw new Error("Tom Select already initialized on this element");r.tomselect=this;var o=window.getComputedStyle&&window.getComputedStyle(r,null);n=o.getPropertyValue("direction");const l=wi(r,t);this.settings=l,this.input=r,this.tabIndex=r.tabIndex||0,this.is_select_tag=r.tagName.toLowerCase()==="select",this.rtl=/rtl/i.test(n),this.inputId=Nn(r,"tomselect-"+bi),this.isRequired=r.required,this.sifter=new lo(this.options,{diacritics:l.diacritics}),l.mode=l.mode||(l.maxItems===1?"single":"multi"),typeof l.hideSelected!="boolean"&&(l.hideSelected=l.mode==="multi"),typeof l.hidePlaceholder!="boolean"&&(l.hidePlaceholder=l.mode!=="multi");var c=l.createFilter;typeof c!="function"&&(typeof c=="string"&&(c=new RegExp(c)),c instanceof RegExp?l.createFilter=_=>c.test(_):l.createFilter=_=>this.settings.duplicates||!this.options[_]),this.initializePlugins(l.plugins),this.setupCallbacks(),this.setupTemplates();const p=je("<div>"),y=je("<div>"),N=this._render("dropdown"),x=je('<div role="listbox" tabindex="-1">'),M=this.input.getAttribute("class")||"",A=l.mode;var b;if(Je(p,l.wrapperClass,M,A),Je(y,l.controlClass),It(p,y),Je(N,l.dropdownClass,A),l.copyClassesToDropdown&&Je(N,M),Je(x,l.dropdownContentClass),It(N,x),je(l.dropdownParent||p).appendChild(N),Bi(l.controlInput)){b=je(l.controlInput);var $=["autocorrect","autocapitalize","autocomplete","spellcheck"];Qe($,_=>{r.getAttribute(_)&&Ve(b,{[_]:r.getAttribute(_)})}),b.tabIndex=-1,y.appendChild(b),this.focus_node=b}else l.controlInput?(b=je(l.controlInput),this.focus_node=b):(b=je("<input/>"),this.focus_node=y);this.wrapper=p,this.dropdown=N,this.dropdown_content=x,this.control=y,this.control_input=b,this.setup()}setup(){const e=this,t=e.settings,n=e.control_input,r=e.dropdown,o=e.dropdown_content,l=e.wrapper,c=e.control,p=e.input,y=e.focus_node,N={passive:!0},x=e.inputId+"-ts-dropdown";Ve(o,{id:x}),Ve(y,{role:"combobox","aria-haspopup":"listbox","aria-expanded":"false","aria-controls":x});const M=Nn(y,e.inputId+"-ts-control"),A="label[for='"+co(e.inputId)+"']",b=document.querySelector(A),$=e.focus.bind(e);if(b){$e(b,"click",$),Ve(b,{for:M});const P=Nn(b,e.inputId+"-ts-label");Ve(y,{"aria-labelledby":P}),Ve(o,{"aria-labelledby":P})}if(l.style.width=p.style.width,e.plugins.names.length){const P="plugin-"+e.plugins.names.join(" plugin-");Je([l,r],P)}(t.maxItems===null||t.maxItems>1)&&e.is_select_tag&&Ve(p,{multiple:"multiple"}),t.placeholder&&Ve(n,{placeholder:t.placeholder}),!t.splitOn&&t.delimiter&&(t.splitOn=new RegExp("\\s*"+Ct(t.delimiter)+"+\\s*")),t.load&&t.loadThrottle&&(t.load=wo(t.load,t.loadThrottle)),$e(r,"mousemove",()=>{e.ignoreHover=!1}),$e(r,"mouseenter",P=>{var X=jt(P.target,"[data-selectable]",r);X&&e.onOptionHover(P,X)},{capture:!0}),$e(r,"click",P=>{const X=jt(P.target,"[data-selectable]");X&&(e.onOptionSelect(P,X),Pe(P,!0))}),$e(c,"click",P=>{var X=jt(P.target,"[data-ts-item]",c);if(X&&e.onItemSelect(P,X)){Pe(P,!0);return}n.value==""&&(e.onClick(),Pe(P,!0))}),$e(y,"keydown",P=>e.onKeyDown(P)),$e(n,"keypress",P=>e.onKeyPress(P)),$e(n,"input",P=>e.onInput(P)),$e(y,"blur",P=>e.onBlur(P)),$e(y,"focus",P=>e.onFocus(P)),$e(n,"paste",P=>e.onPaste(P));const _=P=>{const X=P.composedPath()[0];if(!l.contains(X)&&!r.contains(X)){e.isFocused&&e.blur(),e.inputState();return}X==n&&e.isOpen?P.stopPropagation():Pe(P,!0)},L=()=>{e.isOpen&&e.positionDropdown()};$e(document,"mousedown",_),$e(window,"scroll",L,N),$e(window,"resize",L,N),this._destroy=()=>{document.removeEventListener("mousedown",_),window.removeEventListener("scroll",L),window.removeEventListener("resize",L),b&&b.removeEventListener("click",$)},this.revertSettings={innerHTML:p.innerHTML,tabIndex:p.tabIndex},p.tabIndex=-1,p.insertAdjacentElement("afterend",e.wrapper),e.sync(!1),t.items=[],delete t.optgroups,delete t.options,$e(p,"invalid",()=>{e.isValid&&(e.isValid=!1,e.isInvalid=!0,e.refreshState())}),e.updateOriginalInput(),e.refreshItems(),e.close(!1),e.inputState(),e.isSetup=!0,p.disabled?e.disable():p.readOnly?e.setReadOnly(!0):e.enable(),e.on("change",this.onChange),Je(p,"tomselected","ts-hidden-accessible"),e.trigger("initialize"),t.preload===!0&&e.preload()}setupOptions(e=[],t=[]){this.addOptions(e),Qe(t,n=>{this.registerOptionGroup(n)})}setupTemplates(){var e=this,t=e.settings.labelField,n=e.settings.optgroupLabelField,r={optgroup:o=>{let l=document.createElement("div");return l.className="optgroup",l.appendChild(o.options),l},optgroup_header:(o,l)=>'<div class="optgroup-header">'+l(o[n])+"</div>",option:(o,l)=>"<div>"+l(o[t])+"</div>",item:(o,l)=>"<div>"+l(o[t])+"</div>",option_create:(o,l)=>'<div class="create">Add <strong>'+l(o.input)+"</strong>&hellip;</div>",no_results:()=>'<div class="no-results">No results found</div>',loading:()=>'<div class="spinner"></div>',not_loading:()=>{},dropdown:()=>"<div></div>"};e.settings.render=Object.assign({},r,e.settings.render)}setupCallbacks(){var e,t,n={initialize:"onInitialize",change:"onChange",item_add:"onItemAdd",item_remove:"onItemRemove",item_select:"onItemSelect",clear:"onClear",option_add:"onOptionAdd",option_remove:"onOptionRemove",option_clear:"onOptionClear",optgroup_add:"onOptionGroupAdd",optgroup_remove:"onOptionGroupRemove",optgroup_clear:"onOptionGroupClear",dropdown_open:"onDropdownOpen",dropdown_close:"onDropdownClose",type:"onType",load:"onLoad",focus:"onFocus",blur:"onBlur"};for(e in n)t=this.settings[n[e]],t&&this.on(e,t)}sync(e=!0){const t=this,n=e?wi(t.input,{delimiter:t.settings.delimiter}):t.settings;t.setupOptions(n.options,n.optgroups),t.setValue(n.items||[],!0),t.lastQuery=null}onClick(){var e=this;if(e.activeItems.length>0){e.clearActiveItems(),e.focus();return}e.isFocused&&e.isOpen?e.blur():e.focus()}onMouseDown(){}onChange(){Tn(this.input,"input"),Tn(this.input,"change")}onPaste(e){var t=this;if(t.isInputHidden||t.isLocked){Pe(e);return}t.settings.splitOn&&setTimeout(()=>{var n=t.inputValue();if(n.match(t.settings.splitOn)){var r=n.trim().split(t.settings.splitOn);Qe(r,o=>{it(o)&&(this.options[o]?t.addItem(o):t.createItem(o))})}},0)}onKeyPress(e){var t=this;if(t.isLocked){Pe(e);return}var n=String.fromCharCode(e.keyCode||e.which);if(t.settings.create&&t.settings.mode==="multi"&&n===t.settings.delimiter){t.createItem(),Pe(e);return}}onKeyDown(e){var t=this;if(t.ignoreHover=!0,t.isLocked){e.keyCode!==Ln&&Pe(e);return}switch(e.keyCode){case po:if(vt(Rt,e)&&t.control_input.value==""){Pe(e),t.selectAll();return}break;case Vi:t.isOpen&&(Pe(e,!0),t.close()),t.clearActiveItems();return;case yo:if(!t.isOpen&&t.hasOptions)t.open();else if(t.activeOption){let n=t.getAdjacent(t.activeOption,1);n&&t.setActiveOption(n)}Pe(e);return;case mo:if(t.activeOption){let n=t.getAdjacent(t.activeOption,-1);n&&t.setActiveOption(n)}Pe(e);return;case go:t.canSelect(t.activeOption)?(t.onOptionSelect(e,t.activeOption),Pe(e)):(t.settings.create&&t.createItem()||document.activeElement==t.control_input&&t.isOpen)&&Pe(e);return;case $n:t.advanceSelection(-1,e);return;case Hi:t.advanceSelection(1,e);return;case Ln:t.settings.selectOnTab&&(t.canSelect(t.activeOption)&&(t.onOptionSelect(e,t.activeOption),Pe(e)),t.settings.create&&t.createItem()&&Pe(e));return;case yi:case vo:t.deleteSelection(e);return}t.isInputHidden&&!vt(Rt,e)&&Pe(e)}onInput(e){if(this.isLocked)return;const t=this.inputValue();if(this.lastValue!==t){if(this.lastValue=t,t==""){this._onInput();return}this.refreshTimeout&&clearTimeout(this.refreshTimeout),this.refreshTimeout=Eo(()=>{this.refreshTimeout=null,this._onInput()},this.settings.refreshThrottle)}}_onInput(){const e=this.lastValue;this.settings.shouldLoad.call(this,e)&&this.load(e),this.refreshOptions(),this.trigger("type",e)}onOptionHover(e,t){this.ignoreHover||this.setActiveOption(t,!1)}onFocus(e){var t=this,n=t.isFocused;if(t.isDisabled||t.isReadOnly){t.blur(),Pe(e);return}t.ignoreFocus||(t.isFocused=!0,t.settings.preload==="focus"&&t.preload(),n||t.trigger("focus"),t.activeItems.length||(t.inputState(),t.refreshOptions(!!t.settings.openOnFocus)),t.refreshState())}onBlur(e){if(document.hasFocus()!==!1){var t=this;if(t.isFocused){t.isFocused=!1,t.ignoreFocus=!1;var n=()=>{t.close(),t.setActiveItem(),t.setCaret(t.items.length),t.trigger("blur")};t.settings.create&&t.settings.createOnBlur?t.createItem(null,n):n()}}}onOptionSelect(e,t){var n,r=this;t.parentElement&&t.parentElement.matches("[data-disabled]")||(t.classList.contains("create")?r.createItem(null,()=>{r.settings.closeAfterSelect&&r.close()}):(n=t.dataset.value,typeof n<"u"&&(r.lastQuery=null,r.addItem(n),r.settings.closeAfterSelect&&r.close(),!r.settings.hideSelected&&e.type&&/click/.test(e.type)&&r.setActiveOption(t))))}canSelect(e){return!!(this.isOpen&&e&&this.dropdown_content.contains(e))}onItemSelect(e,t){var n=this;return!n.isLocked&&n.settings.mode==="multi"?(Pe(e),n.setActiveItem(t,e),!0):!1}canLoad(e){return!(!this.settings.load||this.loadedSearches.hasOwnProperty(e))}load(e){const t=this;if(!t.canLoad(e))return;Je(t.wrapper,t.settings.loadingClass),t.loading++;const n=t.loadCallback.bind(t);t.settings.load.call(t,e,n)}loadCallback(e,t){const n=this;n.loading=Math.max(n.loading-1,0),n.lastQuery=null,n.clearActiveOption(),n.setupOptions(e,t),n.refreshOptions(n.isFocused&&!n.isInputHidden),n.loading||dt(n.wrapper,n.settings.loadingClass),n.trigger("load",e,t)}preload(){var e=this.wrapper.classList;e.contains("preloaded")||(e.add("preloaded"),this.load(""))}setTextboxValue(e=""){var t=this.control_input,n=t.value!==e;n&&(t.value=e,Tn(t,"update"),this.lastValue=e)}getValue(){return this.is_select_tag&&this.input.hasAttribute("multiple")?this.items:this.items.join(this.settings.delimiter)}setValue(e,t){var n=t?[]:["change"];Ii(this,n,()=>{this.clear(t),this.addItems(e,t)})}setMaxItems(e){e===0&&(e=null),this.settings.maxItems=e,this.refreshState()}setActiveItem(e,t){var n=this,r,o,l,c,p,y;if(n.settings.mode!=="single"){if(!e){n.clearActiveItems(),n.isFocused&&n.inputState();return}if(r=t&&t.type.toLowerCase(),r==="click"&&vt("shiftKey",t)&&n.activeItems.length){for(y=n.getLastActive(),l=Array.prototype.indexOf.call(n.control.children,y),c=Array.prototype.indexOf.call(n.control.children,e),l>c&&(p=l,l=c,c=p),o=l;o<=c;o++)e=n.control.children[o],n.activeItems.indexOf(e)===-1&&n.setActiveItemClass(e);Pe(t)}else r==="click"&&vt(Rt,t)||r==="keydown"&&vt("shiftKey",t)?e.classList.contains("active")?n.removeActiveItem(e):n.setActiveItemClass(e):(n.clearActiveItems(),n.setActiveItemClass(e));n.inputState(),n.isFocused||n.focus()}}setActiveItemClass(e){const t=this,n=t.control.querySelector(".last-active");n&&dt(n,"last-active"),Je(e,"active last-active"),t.trigger("item_select",e),t.activeItems.indexOf(e)==-1&&t.activeItems.push(e)}removeActiveItem(e){var t=this.activeItems.indexOf(e);this.activeItems.splice(t,1),dt(e,"active")}clearActiveItems(){dt(this.activeItems,"active"),this.activeItems=[]}setActiveOption(e,t=!0){e!==this.activeOption&&(this.clearActiveOption(),e&&(this.activeOption=e,Ve(this.focus_node,{"aria-activedescendant":e.getAttribute("id")}),Ve(e,{"aria-selected":"true"}),Je(e,"active"),t&&this.scrollToOption(e)))}scrollToOption(e,t){if(!e)return;const n=this.dropdown_content,r=n.clientHeight,o=n.scrollTop||0,l=e.offsetHeight,c=e.getBoundingClientRect().top-n.getBoundingClientRect().top+o;c+l>r+o?this.scroll(c-r+l,t):c<o&&this.scroll(c,t)}scroll(e,t){const n=this.dropdown_content;t&&(n.style.scrollBehavior=t),n.scrollTop=e,n.style.scrollBehavior=""}clearActiveOption(){this.activeOption&&(dt(this.activeOption,"active"),Ve(this.activeOption,{"aria-selected":null})),this.activeOption=null,Ve(this.focus_node,{"aria-activedescendant":null})}selectAll(){const e=this;if(e.settings.mode==="single")return;const t=e.controlChildren();t.length&&(e.inputState(),e.close(),e.activeItems=t,Qe(t,n=>{e.setActiveItemClass(n)}))}inputState(){var e=this;e.control.contains(e.control_input)&&(Ve(e.control_input,{placeholder:e.settings.placeholder}),e.activeItems.length>0||!e.isFocused&&e.settings.hidePlaceholder&&e.items.length>0?(e.setTextboxValue(),e.isInputHidden=!0):(e.settings.hidePlaceholder&&e.items.length>0&&Ve(e.control_input,{placeholder:""}),e.isInputHidden=!1),e.wrapper.classList.toggle("input-hidden",e.isInputHidden))}inputValue(){return this.control_input.value.trim()}focus(){var e=this;e.isDisabled||e.isReadOnly||(e.ignoreFocus=!0,e.control_input.offsetWidth?e.control_input.focus():e.focus_node.focus(),setTimeout(()=>{e.ignoreFocus=!1,e.onFocus()},0))}blur(){this.focus_node.blur(),this.onBlur()}getScoreFunction(e){return this.sifter.getScoreFunction(e,this.getSearchOptions())}getSearchOptions(){var e=this.settings,t=e.sortField;return typeof e.sortField=="string"&&(t=[{field:e.sortField}]),{fields:e.searchField,conjunction:e.searchConjunction,sort:t,nesting:e.nesting}}search(e){var t,n,r=this,o=this.getSearchOptions();if(r.settings.score&&(n=r.settings.score.call(r,e),typeof n!="function"))throw new Error('Tom Select "score" setting must be a function that returns a function');return e!==r.lastQuery?(r.lastQuery=e,t=r.sifter.search(e,Object.assign(o,{score:n})),r.currentResults=t):t=Object.assign({},r.currentResults),r.settings.hideSelected&&(t.items=t.items.filter(l=>{let c=it(l.id);return!(c&&r.items.indexOf(c)!==-1)})),t}refreshOptions(e=!0){var t,n,r,o,l,c,p,y,N,x;const M={},A=[];var b=this,$=b.inputValue();const _=$===b.lastQuery||$==""&&b.lastQuery==null;var L=b.search($),P=null,X=b.settings.shouldOpen||!1,H=b.dropdown_content;_&&(P=b.activeOption,P&&(N=P.closest("[data-group]"))),o=L.items.length,typeof b.settings.maxOptions=="number"&&(o=Math.min(o,b.settings.maxOptions)),o>0&&(X=!0);const ie=(w,g)=>{let E=M[w];if(E!==void 0){let k=A[E];if(k!==void 0)return[E,k.fragment]}let h=document.createDocumentFragment();return E=A.length,A.push({fragment:h,order:g,optgroup:w}),[E,h]};for(t=0;t<o;t++){let w=L.items[t];if(!w)continue;let g=w.id,E=b.options[g];if(E===void 0)continue;let h=Wt(g),k=b.getOption(h,!0);for(b.settings.hideSelected||k.classList.toggle("selected",b.items.includes(h)),l=E[b.settings.optgroupField]||"",c=Array.isArray(l)?l:[l],n=0,r=c&&c.length;n<r;n++){l=c[n];let R=E.$order,ae=b.optgroups[l];ae===void 0?l="":R=ae.$order;const[ce,le]=ie(l,R);n>0&&(k=k.cloneNode(!0),Ve(k,{id:E.$id+"-clone-"+n,"aria-selected":null}),k.classList.add("ts-cloned"),dt(k,"active"),b.activeOption&&b.activeOption.dataset.value==g&&N&&N.dataset.group===l.toString()&&(P=k)),le.appendChild(k),l!=""&&(M[l]=ce)}}b.settings.lockOptgroupOrder&&A.sort((w,g)=>w.order-g.order),p=document.createDocumentFragment(),Qe(A,w=>{let g=w.fragment,E=w.optgroup;if(!g||!g.children.length)return;let h=b.optgroups[E];if(h!==void 0){let k=document.createDocumentFragment(),R=b.render("optgroup_header",h);It(k,R),It(k,g);let ae=b.render("optgroup",{group:h,options:k});It(p,ae)}else It(p,g)}),H.innerHTML="",It(H,p),b.settings.highlight&&(ho(H),L.query.length&&L.tokens.length&&Qe(L.tokens,w=>{fo(H,w.regex)}));var O=w=>{let g=b.render(w,{input:$});return g&&(X=!0,H.insertBefore(g,H.firstChild)),g};if(b.loading?O("loading"):b.settings.shouldLoad.call(b,$)?L.items.length===0&&O("no_results"):O("not_loading"),y=b.canCreate($),y&&(x=O("option_create")),b.hasOptions=L.items.length>0||y,X){if(L.items.length>0){if(!P&&b.settings.mode==="single"&&b.items[0]!=null&&(P=b.getOption(b.items[0])),!H.contains(P)){let w=0;x&&!b.settings.addPrecedence&&(w=1),P=b.selectable()[w]}}else x&&(P=x);e&&!b.isOpen&&(b.open(),b.scrollToOption(P,"auto")),b.setActiveOption(P)}else b.clearActiveOption(),e&&b.isOpen&&b.close(!1)}selectable(){return this.dropdown_content.querySelectorAll("[data-selectable]")}addOption(e,t=!1){const n=this;if(Array.isArray(e))return n.addOptions(e,t),!1;const r=it(e[n.settings.valueField]);return r===null||n.options.hasOwnProperty(r)?!1:(e.$order=e.$order||++n.order,e.$id=n.inputId+"-opt-"+e.$order,n.options[r]=e,n.lastQuery=null,t&&(n.userOptions[r]=t,n.trigger("option_add",r,e)),r)}addOptions(e,t=!1){Qe(e,n=>{this.addOption(n,t)})}registerOption(e){return this.addOption(e)}registerOptionGroup(e){var t=it(e[this.settings.optgroupValueField]);return t===null?!1:(e.$order=e.$order||++this.order,this.optgroups[t]=e,t)}addOptionGroup(e,t){var n;t[this.settings.optgroupValueField]=e,(n=this.registerOptionGroup(t))&&this.trigger("optgroup_add",n,t)}removeOptionGroup(e){this.optgroups.hasOwnProperty(e)&&(delete this.optgroups[e],this.clearCache(),this.trigger("optgroup_remove",e))}clearOptionGroups(){this.optgroups={},this.clearCache(),this.trigger("optgroup_clear")}updateOption(e,t){const n=this;var r,o;const l=it(e),c=it(t[n.settings.valueField]);if(l===null)return;const p=n.options[l];if(p==null)return;if(typeof c!="string")throw new Error("Value must be set in option data");const y=n.getOption(l),N=n.getItem(l);if(t.$order=t.$order||p.$order,delete n.options[l],n.uncacheValue(c),n.options[c]=t,y){if(n.dropdown_content.contains(y)){const x=n._render("option",t);Pn(y,x),n.activeOption===y&&n.setActiveOption(x)}y.remove()}N&&(o=n.items.indexOf(l),o!==-1&&n.items.splice(o,1,c),r=n._render("item",t),N.classList.contains("active")&&Je(r,"active"),Pn(N,r)),n.lastQuery=null}removeOption(e,t){const n=this;e=Wt(e),n.uncacheValue(e),delete n.userOptions[e],delete n.options[e],n.lastQuery=null,n.trigger("option_remove",e),n.removeItem(e,t)}clearOptions(e){const t=(e||this.clearFilter).bind(this);this.loadedSearches={},this.userOptions={},this.clearCache();const n={};Qe(this.options,(r,o)=>{t(r,o)&&(n[o]=r)}),this.options=this.sifter.items=n,this.lastQuery=null,this.trigger("option_clear")}clearFilter(e,t){return this.items.indexOf(t)>=0}getOption(e,t=!1){const n=it(e);if(n===null)return null;const r=this.options[n];if(r!=null){if(r.$div)return r.$div;if(t)return this._render("option",r)}return null}getAdjacent(e,t,n="option"){var r=this,o;if(!e)return null;n=="item"?o=r.controlChildren():o=r.dropdown_content.querySelectorAll("[data-selectable]");for(let l=0;l<o.length;l++)if(o[l]==e)return t>0?o[l+1]:o[l-1];return null}getItem(e){if(typeof e=="object")return e;var t=it(e);return t!==null?this.control.querySelector(`[data-value="${Ei(t)}"]`):null}addItems(e,t){var n=this,r=Array.isArray(e)?e:[e];r=r.filter(l=>n.items.indexOf(l)===-1);const o=r[r.length-1];r.forEach(l=>{n.isPending=l!==o,n.addItem(l,t)})}addItem(e,t){var n=t?[]:["change","dropdown_close"];Ii(this,n,()=>{var r,o;const l=this,c=l.settings.mode,p=it(e);if(!(p&&l.items.indexOf(p)!==-1&&(c==="single"&&l.close(),c==="single"||!l.settings.duplicates))&&!(p===null||!l.options.hasOwnProperty(p))&&(c==="single"&&l.clear(t),!(c==="multi"&&l.isFull()))){if(r=l._render("item",l.options[p]),l.control.contains(r)&&(r=r.cloneNode(!0)),o=l.isFull(),l.items.splice(l.caretPos,0,p),l.insertAtCaret(r),l.isSetup){if(!l.isPending&&l.settings.hideSelected){let y=l.getOption(p),N=l.getAdjacent(y,1);N&&l.setActiveOption(N)}!l.isPending&&!l.settings.closeAfterSelect&&l.refreshOptions(l.isFocused&&c!=="single"),l.settings.closeAfterSelect!=!1&&l.isFull()?l.close():l.isPending||l.positionDropdown(),l.trigger("item_add",p,r),l.isPending||l.updateOriginalInput({silent:t})}(!l.isPending||!o&&l.isFull())&&(l.inputState(),l.refreshState())}})}removeItem(e=null,t){const n=this;if(e=n.getItem(e),!e)return;var r,o;const l=e.dataset.value;r=tn(e),e.remove(),e.classList.contains("active")&&(o=n.activeItems.indexOf(e),n.activeItems.splice(o,1),dt(e,"active")),n.items.splice(r,1),n.lastQuery=null,!n.settings.persist&&n.userOptions.hasOwnProperty(l)&&n.removeOption(l,t),r<n.caretPos&&n.setCaret(n.caretPos-1),n.updateOriginalInput({silent:t}),n.refreshState(),n.positionDropdown(),n.trigger("item_remove",l,e)}createItem(e=null,t=()=>{}){arguments.length===3&&(t=arguments[2]),typeof t!="function"&&(t=()=>{});var n=this,r=n.caretPos,o;if(e=e||n.inputValue(),!n.canCreate(e))return t(),!1;n.lock();var l=!1,c=p=>{if(n.unlock(),!p||typeof p!="object")return t();var y=it(p[n.settings.valueField]);if(typeof y!="string")return t();n.setTextboxValue(),n.addOption(p,!0),n.setCaret(r),n.addItem(y),t(p),l=!0};return typeof n.settings.create=="function"?o=n.settings.create.call(this,e,c):o={[n.settings.labelField]:e,[n.settings.valueField]:e},l||c(o),!0}refreshItems(){var e=this;e.lastQuery=null,e.isSetup&&e.addItems(e.items),e.updateOriginalInput(),e.refreshState()}refreshState(){const e=this;e.refreshValidityState();const t=e.isFull(),n=e.isLocked;e.wrapper.classList.toggle("rtl",e.rtl);const r=e.wrapper.classList;r.toggle("focus",e.isFocused),r.toggle("disabled",e.isDisabled),r.toggle("readonly",e.isReadOnly),r.toggle("required",e.isRequired),r.toggle("invalid",!e.isValid),r.toggle("locked",n),r.toggle("full",t),r.toggle("input-active",e.isFocused&&!e.isInputHidden),r.toggle("dropdown-active",e.isOpen),r.toggle("has-options",uo(e.options)),r.toggle("has-items",e.items.length>0)}refreshValidityState(){var e=this;e.input.validity&&(e.isValid=e.input.validity.valid,e.isInvalid=!e.isValid)}isFull(){return this.settings.maxItems!==null&&this.items.length>=this.settings.maxItems}updateOriginalInput(e={}){const t=this;var n,r;const o=t.input.querySelector('option[value=""]');if(t.is_select_tag){let p=function(y,N,x){return y||(y=je('<option value="'+qt(N)+'">'+qt(x)+"</option>")),y!=o&&t.input.append(y),l.push(y),(y!=o||c>0)&&(y.selected=!0),y};const l=[],c=t.input.querySelectorAll("option:checked").length;t.input.querySelectorAll("option:checked").forEach(y=>{y.selected=!1}),t.items.length==0&&t.settings.mode=="single"?p(o,"",""):t.items.forEach(y=>{if(n=t.options[y],r=n[t.settings.labelField]||"",l.includes(n.$option)){const N=t.input.querySelector(`option[value="${Ei(y)}"]:not(:checked)`);p(N,y,r)}else n.$option=p(n.$option,y,r)})}else t.input.value=t.getValue();t.isSetup&&(e.silent||t.trigger("change",t.getValue()))}open(){var e=this;e.isLocked||e.isOpen||e.settings.mode==="multi"&&e.isFull()||(e.isOpen=!0,Ve(e.focus_node,{"aria-expanded":"true"}),e.refreshState(),Lt(e.dropdown,{visibility:"hidden",display:"block"}),e.positionDropdown(),Lt(e.dropdown,{visibility:"visible",display:"block"}),e.focus(),e.trigger("dropdown_open",e.dropdown))}close(e=!0){var t=this,n=t.isOpen;e&&(t.setTextboxValue(),t.settings.mode==="single"&&t.items.length&&t.inputState()),t.isOpen=!1,Ve(t.focus_node,{"aria-expanded":"false"}),Lt(t.dropdown,{display:"none"}),t.settings.hideSelected&&t.clearActiveOption(),t.refreshState(),n&&t.trigger("dropdown_close",t.dropdown)}positionDropdown(){if(this.settings.dropdownParent==="body"){var e=this.control,t=e.getBoundingClientRect(),n=e.offsetHeight+t.top+window.scrollY,r=t.left+window.scrollX;Lt(this.dropdown,{width:t.width+"px",top:n+"px",left:r+"px"})}}clear(e){var t=this;if(t.items.length){var n=t.controlChildren();Qe(n,r=>{t.removeItem(r,!0)}),t.inputState(),e||t.updateOriginalInput(),t.trigger("clear")}}insertAtCaret(e){const t=this,n=t.caretPos,r=t.control;r.insertBefore(e,r.children[n]||null),t.setCaret(n+1)}deleteSelection(e){var t,n,r,o,l=this;t=e&&e.keyCode===yi?-1:1,n=bo(l.control_input);const c=[];if(l.activeItems.length)o=mi(l.activeItems,t),r=tn(o),t>0&&r++,Qe(l.activeItems,p=>c.push(p));else if((l.isFocused||l.settings.mode==="single")&&l.items.length){const p=l.controlChildren();let y;t<0&&n.start===0&&n.length===0?y=p[l.caretPos-1]:t>0&&n.start===l.inputValue().length&&(y=p[l.caretPos]),y!==void 0&&c.push(y)}if(!l.shouldDelete(c,e))return!1;for(Pe(e,!0),typeof r<"u"&&l.setCaret(r);c.length;)l.removeItem(c.pop());return l.inputState(),l.positionDropdown(),l.refreshOptions(!1),!0}shouldDelete(e,t){const n=e.map(r=>r.dataset.value);return!(!n.length||typeof this.settings.onDelete=="function"&&this.settings.onDelete(n,t)===!1)}advanceSelection(e,t){var n,r,o=this;o.rtl&&(e*=-1),!o.inputValue().length&&(vt(Rt,t)||vt("shiftKey",t)?(n=o.getLastActive(e),n?n.classList.contains("active")?r=o.getAdjacent(n,e,"item"):r=n:e>0?r=o.control_input.nextElementSibling:r=o.control_input.previousElementSibling,r&&(r.classList.contains("active")&&o.removeActiveItem(n),o.setActiveItemClass(r))):o.moveCaret(e))}moveCaret(e){}getLastActive(e){let t=this.control.querySelector(".last-active");if(t)return t;var n=this.control.querySelectorAll(".active");if(n)return mi(n,e)}setCaret(e){this.caretPos=this.items.length}controlChildren(){return Array.from(this.control.querySelectorAll("[data-ts-item]"))}lock(){this.setLocked(!0)}unlock(){this.setLocked(!1)}setLocked(e=this.isReadOnly||this.isDisabled){this.isLocked=e,this.refreshState()}disable(){this.setDisabled(!0),this.close()}enable(){this.setDisabled(!1)}setDisabled(e){this.focus_node.tabIndex=e?-1:this.tabIndex,this.isDisabled=e,this.input.disabled=e,this.control_input.disabled=e,this.setLocked()}setReadOnly(e){this.isReadOnly=e,this.input.readOnly=e,this.control_input.readOnly=e,this.setLocked()}destroy(){var e=this,t=e.revertSettings;e.trigger("destroy"),e.off(),e.wrapper.remove(),e.dropdown.remove(),e.input.innerHTML=t.innerHTML,e.input.tabIndex=t.tabIndex,dt(e.input,"tomselected","ts-hidden-accessible"),e._destroy(),delete e.input.tomselect}render(e,t){var n,r;const o=this;if(typeof this.settings.render[e]!="function"||(r=o.settings.render[e].call(this,t,qt),!r))return null;if(r=je(r),e==="option"||e==="option_create"?t[o.settings.disabledField]?Ve(r,{"aria-disabled":"true"}):Ve(r,{"data-selectable":""}):e==="optgroup"&&(n=t.group[o.settings.optgroupValueField],Ve(r,{"data-group":n}),t.group[o.settings.disabledField]&&Ve(r,{"data-disabled":""})),e==="option"||e==="item"){const l=Wt(t[o.settings.valueField]);Ve(r,{"data-value":l}),e==="item"?(Je(r,o.settings.itemClass),Ve(r,{"data-ts-item":""})):(Je(r,o.settings.optionClass),Ve(r,{role:"option",id:t.$id}),t.$div=r,o.options[l]=t)}return r}_render(e,t){const n=this.render(e,t);if(n==null)throw"HTMLElement expected";return n}clearCache(){Qe(this.options,e=>{e.$div&&(e.$div.remove(),delete e.$div)})}uncacheValue(e){const t=this.getOption(e);t&&t.remove()}canCreate(e){return this.settings.create&&e.length>0&&this.settings.createFilter.call(this,e)}hook(e,t,n){var r=this,o=r[t];r[t]=function(){var l,c;return e==="after"&&(l=o.apply(r,arguments)),c=n.apply(r,arguments),e==="instead"?c:(e==="before"&&(l=o.apply(r,arguments)),l)}}}function So(){$e(this.input,"change",()=>{this.sync()})}function To(i){var e=this,t=e.onOptionSelect;e.settings.hideSelected=!1;const n=Object.assign({className:"tomselect-checkbox",checkedClassNames:void 0,uncheckedClassNames:void 0},i);var r=function(c,p){p?(c.checked=!0,n.uncheckedClassNames&&c.classList.remove(...n.uncheckedClassNames),n.checkedClassNames&&c.classList.add(...n.checkedClassNames)):(c.checked=!1,n.checkedClassNames&&c.classList.remove(...n.checkedClassNames),n.uncheckedClassNames&&c.classList.add(...n.uncheckedClassNames))},o=function(c){setTimeout(()=>{var p=c.querySelector("input."+n.className);p instanceof HTMLInputElement&&r(p,c.classList.contains("selected"))},1)};e.hook("after","setupTemplates",()=>{var l=e.settings.render.option;e.settings.render.option=(c,p)=>{var y=je(l.call(e,c,p)),N=document.createElement("input");n.className&&N.classList.add(n.className),N.addEventListener("click",function(M){Pe(M)}),N.type="checkbox";const x=it(c[e.settings.valueField]);return r(N,!!(x&&e.items.indexOf(x)>-1)),y.prepend(N),y}}),e.on("item_remove",l=>{var c=e.getOption(l);c&&(c.classList.remove("selected"),o(c))}),e.on("item_add",l=>{var c=e.getOption(l);c&&o(c)}),e.hook("instead","onOptionSelect",(l,c)=>{if(c.classList.contains("selected")){c.classList.remove("selected"),e.removeItem(c.dataset.value),e.refreshOptions(),Pe(l,!0);return}t.call(e,l,c),o(c)})}function No(i){const e=this,t=Object.assign({className:"clear-button",title:"Clear All",html:n=>`<div class="${n.className}" title="${n.title}">&#10799;</div>`},i);e.on("initialize",()=>{var n=je(t.html(t));n.addEventListener("click",r=>{e.isLocked||(e.clear(),e.settings.mode==="single"&&e.settings.allowEmptyOption&&e.addItem(""),r.preventDefault(),r.stopPropagation())}),e.control.appendChild(n)})}const Oo=(i,e)=>{var t;(t=i.parentNode)==null||t.insertBefore(e,i.nextSibling)},ko=(i,e)=>{var t;(t=i.parentNode)==null||t.insertBefore(e,i)},xo=(i,e)=>{do{var t;if(e=(t=e)==null?void 0:t.previousElementSibling,i==e)return!0}while(e&&e.previousElementSibling);return!1};function _o(){var i=this;if(i.settings.mode!=="multi")return;var e=i.lock,t=i.unlock;let n=!0,r;i.hook("after","setupTemplates",()=>{var o=i.settings.render.item;i.settings.render.item=(l,c)=>{const p=je(o.call(i,l,c));Ve(p,{draggable:"true"});const y=$=>{n||Pe($),$.stopPropagation()},N=$=>{r=p,setTimeout(()=>{p.classList.add("ts-dragging")},0)},x=$=>{$.preventDefault(),p.classList.add("ts-drag-over"),A(p,r)},M=()=>{p.classList.remove("ts-drag-over")},A=($,_)=>{_!==void 0&&(xo(_,p)?Oo($,_):ko($,_))},b=()=>{var $;document.querySelectorAll(".ts-drag-over").forEach(L=>L.classList.remove("ts-drag-over")),($=r)==null||$.classList.remove("ts-dragging"),r=void 0;var _=[];i.control.querySelectorAll("[data-value]").forEach(L=>{if(L.dataset.value){let P=L.dataset.value;P&&_.push(P)}}),i.setValue(_)};return $e(p,"mousedown",y),$e(p,"dragstart",N),$e(p,"dragenter",x),$e(p,"dragover",x),$e(p,"dragleave",M),$e(p,"dragend",b),p}}),i.hook("instead","lock",()=>(n=!1,e.call(i))),i.hook("instead","unlock",()=>(n=!0,t.call(i)))}function Co(i){const e=this,t=Object.assign({title:"Untitled",headerClass:"dropdown-header",titleRowClass:"dropdown-header-title",labelClass:"dropdown-header-label",closeClass:"dropdown-header-close",html:n=>'<div class="'+n.headerClass+'"><div class="'+n.titleRowClass+'"><span class="'+n.labelClass+'">'+n.title+'</span><a class="'+n.closeClass+'">&times;</a></div></div>'},i);e.on("initialize",()=>{var n=je(t.html(t)),r=n.querySelector("."+t.closeClass);r&&r.addEventListener("click",o=>{Pe(o,!0),e.close()}),e.dropdown.insertBefore(n,e.dropdown.firstChild)})}function Do(){var i=this;i.hook("instead","setCaret",e=>{i.settings.mode==="single"||!i.control.contains(i.control_input)?e=i.items.length:(e=Math.max(0,Math.min(i.items.length,e)),e!=i.caretPos&&!i.isPending&&i.controlChildren().forEach((t,n)=>{n<e?i.control_input.insertAdjacentElement("beforebegin",t):i.control.appendChild(t)})),i.caretPos=e}),i.hook("instead","moveCaret",e=>{if(!i.isFocused)return;const t=i.getLastActive(e);if(t){const n=tn(t);i.setCaret(e>0?n+1:n),i.setActiveItem(),dt(t,"last-active")}else i.setCaret(i.caretPos+e)})}function Ao(){const i=this;i.settings.shouldOpen=!0,i.hook("before","setup",()=>{i.focus_node=i.control,Je(i.control_input,"dropdown-input");const e=je('<div class="dropdown-input-wrap">');e.append(i.control_input),i.dropdown.insertBefore(e,i.dropdown.firstChild);const t=je('<input class="items-placeholder" tabindex="-1" />');t.placeholder=i.settings.placeholder||"",i.control.append(t)}),i.on("initialize",()=>{i.control_input.addEventListener("keydown",t=>{switch(t.keyCode){case Vi:i.isOpen&&(Pe(t,!0),i.close()),i.clearActiveItems();return;case Ln:i.focus_node.tabIndex=-1;break}return i.onKeyDown.call(i,t)}),i.on("blur",()=>{i.focus_node.tabIndex=i.isDisabled?-1:i.tabIndex}),i.on("dropdown_open",()=>{i.control_input.focus()});const e=i.onBlur;i.hook("instead","onBlur",t=>{if(!(t&&t.relatedTarget==i.control_input))return e.call(i)}),$e(i.control_input,"blur",()=>i.onBlur()),i.hook("before","close",()=>{i.isOpen&&i.focus_node.focus({preventScroll:!0})})})}function Mo(){var i=this;i.on("initialize",()=>{var e=document.createElement("span"),t=i.control_input;e.style.cssText="position:absolute; top:-99999px; left:-99999px; width:auto; padding:0; white-space:pre; ",i.wrapper.appendChild(e);var n=["letterSpacing","fontSize","fontFamily","fontWeight","textTransform"];for(const o of n)e.style[o]=t.style[o];var r=()=>{e.textContent=t.value,t.style.width=e.clientWidth+"px"};r(),i.on("update item_add item_remove",r),$e(t,"input",r),$e(t,"keyup",r),$e(t,"blur",r),$e(t,"update",r)})}function Po(){var i=this,e=i.deleteSelection;this.hook("instead","deleteSelection",t=>i.activeItems.length?e.call(i,t):!1)}function $o(){this.hook("instead","setActiveItem",()=>{}),this.hook("instead","selectAll",()=>{})}function Lo(){var i=this,e=i.onKeyDown;i.hook("instead","onKeyDown",t=>{var n,r,o,l;if(!i.isOpen||!(t.keyCode===$n||t.keyCode===Hi))return e.call(i,t);i.ignoreHover=!0,l=jt(i.activeOption,"[data-group]"),n=tn(i.activeOption,"[data-selectable]"),l&&(t.keyCode===$n?l=l.previousSibling:l=l.nextSibling,l&&(o=l.querySelectorAll("[data-selectable]"),r=o[Math.min(o.length-1,n)],r&&i.setActiveOption(r)))})}function Ro(i){const e=Object.assign({label:"&times;",title:"Remove",className:"remove",append:!0},i);var t=this;if(e.append){var n='<a href="javascript:void(0)" class="'+e.className+'" tabindex="-1" title="'+qt(e.title)+'">'+e.label+"</a>";t.hook("after","setupTemplates",()=>{var r=t.settings.render.item;t.settings.render.item=(o,l)=>{var c=je(r.call(t,o,l)),p=je(n);return c.appendChild(p),$e(p,"mousedown",y=>{Pe(y,!0)}),$e(p,"click",y=>{t.isLocked||(Pe(y,!0),!t.isLocked&&t.shouldDelete([c],y)&&(t.removeItem(c),t.refreshOptions(!1),t.inputState()))}),c}})}}function Bo(i){const e=this,t=Object.assign({text:n=>n[e.settings.labelField]},i);e.on("item_remove",function(n){if(e.isFocused&&e.control_input.value.trim()===""){var r=e.options[n];r&&e.setTextboxValue(t.text.call(e,r))}})}function Fo(){const i=this,e=i.canLoad,t=i.clearActiveOption,n=i.loadCallback;var r={},o,l=!1,c,p=[];if(i.settings.shouldLoadMore||(i.settings.shouldLoadMore=()=>{if(o.clientHeight/(o.scrollHeight-o.scrollTop)>.9)return!0;if(i.activeOption){var M=i.selectable(),A=Array.from(M).indexOf(i.activeOption);if(A>=M.length-2)return!0}return!1}),!i.settings.firstUrl)throw"virtual_scroll plugin requires a firstUrl() method";i.settings.sortField=[{field:"$order"},{field:"$score"}];const y=x=>typeof i.settings.maxOptions=="number"&&o.children.length>=i.settings.maxOptions?!1:!!(x in r&&r[x]),N=(x,M)=>i.items.indexOf(M)>=0||p.indexOf(M)>=0;i.setNextUrl=(x,M)=>{r[x]=M},i.getUrl=x=>{if(x in r){const M=r[x];return r[x]=!1,M}return i.clearPagination(),i.settings.firstUrl.call(i,x)},i.clearPagination=()=>{r={}},i.hook("instead","clearActiveOption",()=>{if(!l)return t.call(i)}),i.hook("instead","canLoad",x=>x in r?y(x):e.call(i,x)),i.hook("instead","loadCallback",(x,M)=>{if(!l)i.clearOptions(N);else if(c){const A=x[0];A!==void 0&&(c.dataset.value=A[i.settings.valueField])}n.call(i,x,M),l=!1}),i.hook("after","refreshOptions",()=>{const x=i.lastValue;var M;y(x)?(M=i.render("loading_more",{query:x}),M&&(M.setAttribute("data-selectable",""),c=M)):x in r&&!o.querySelector(".no-results")&&(M=i.render("no_more_results",{query:x})),M&&(Je(M,i.settings.optionClass),o.append(M))}),i.on("initialize",()=>{p=Object.keys(i.options),o=i.dropdown_content,i.settings.render=Object.assign({},{loading_more:()=>'<div class="loading-more-results">Loading more results ... </div>',no_more_results:()=>'<div class="no-more-results">No more results</div>'},i.settings.render),o.addEventListener("scroll",()=>{i.settings.shouldLoadMore.call(i)&&y(i.lastValue)&&(l||(l=!0,i.load.call(i,i.lastValue)))})})}et.define("change_listener",So);et.define("checkbox_options",To);et.define("clear_button",No);et.define("drag_drop",_o);et.define("dropdown_header",Co);et.define("caret_position",Do);et.define("dropdown_input",Ao);et.define("input_autogrow",Mo);et.define("no_backspace_delete",Po);et.define("no_active_items",$o);et.define("optgroup_columns",Lo);et.define("remove_button",Ro);et.define("restore_on_backspace",Bo);et.define("virtual_scroll",Fo);class Xo{debouncedLocalChanges;debouncedBroadcastChanges;constructor(){this.debouncedBroadcastChanges=li(async e=>{if(!e.data||e.data.length===0)return;const t=e.data,n=I.playerRole==="GM"?t:t.filter(c=>c.metadata[`${u.SPECTREID}/viewers`].includes(I.playerId)),o=I.localGhosts.filter(c=>c.metadata[`${u.SPECTREID}/spectred`]===!0).filter(c=>c.metadata[`${u.SPECTREID}/viewers`].includes(I.playerId));if(!En(n,o)){const c=n.map(N=>N.id),p=[],y=I.localGhosts.filter(N=>!c.includes(N.id));for(const N of n){const x=I.localGhosts.find(M=>M.id===N.id);x&&xr(N,x)||p.push(N)}p.length>0&&await C.scene.local.addItems(p),y.length>0&&await C.scene.local.deleteItems(y.map(N=>N.id)),I.localGhosts=t}},0),this.debouncedLocalChanges=li(async e=>{if(I.playerRole==="GM"){const t=e.filter(n=>n.metadata[`${u.SPECTREID}/spectred`]===!0);if(En(I.localGhosts,t))return;I.localGhosts=t,ci(t)?await C.notification.show("You currently have too many Spectres in the scene. Unable to update.","ERROR"):(await C.scene.setMetadata({[`${u.SPECTREID}/current_spectres`]:t}),await C.broadcast.sendMessage(u.SPECTREBROADCASTID,t))}else{const t=e.filter(l=>l.metadata[`${u.SPECTREID}/spectred`]===!0),r=I.localGhosts.filter(l=>l.metadata[`${u.SPECTREID}/spectred`]===!0).filter(l=>l.metadata[`${u.SPECTREID}/viewers`].includes(I.playerId));if(t.length<r.length){const l=[];for(const c of r)t.includes(c)||l.push(c.id);l.length>0&&await C.broadcast.sendMessage("SPECTREDELETED",l)}if(t.length===0&&r.length===0)return;if(t.length<r.length){I.localGhosts=t;return}En(t,r)||(_r(I.localGhosts,t),await C.broadcast.sendMessage(u.SPECTREBROADCASTID,I.localGhosts))}},0)}SetupLocalSpecterHandlers(){I.sceneReady&&(C.broadcast.onMessage(u.SPECTREBROADCASTID,e=>{this.debouncedBroadcastChanges(e)}),I.playerRole==="GM"&&C.broadcast.onMessage("SPECTREDELETED",async e=>{const t=e.data;if(t.length>0){for(const n of t)document.getElementById(`tr-${n}`).remove();await C.scene.local.deleteItems(t)}}))}async LoadSpectreSceneMetadata(){I.localGhosts=I.sceneMetadata[`${u.SPECTREID}/current_spectres`],I.localGhosts||(I.localGhosts=[]);const e=[];for(const t of I.localGhosts)t.metadata[`${u.SPECTREID}/viewers`].includes(I.playerId)&&I.playerRole!=="GM"&&e.push(t);e.length>0&&await C.scene.local.addItems(e)}UpdateSpectreTargets(){const e=document.querySelectorAll(".tSelects");for(const t of e)if(t&&t.tomselect){const n=t.tomselect,r=[];for(const o of I.party)r.push({value:o.id,text:o.name});n.clearOptions(),n.addOption(r),r.length===0?(n.settings.placeholder="No Players Present",n.inputState()):(n.settings.placeholder="Choose..",n.inputState())}}async SetupSpectreGM(){await C.contextMenu.create({id:`${u.SPECTREID}/context-menu`,icons:[{icon:"/ghost.svg",label:"Spectre",filter:{every:[{key:"type",value:"IMAGE"},{key:["metadata",`${u.SPECTREID}/spectred`],value:void 0,operator:"==",coordinator:"&&"}]}},{icon:"/ghost.svg",label:"Un-Spectre",filter:{every:[{key:"type",value:"IMAGE"},{key:["metadata",`${u.SPECTREID}/spectred`],value:void 0,operator:"!=",coordinator:"&&"}]}}],async onClick(e){if(e.items.every(n=>n.metadata[`${u.SPECTREID}/spectred`]===void 0))if(ci(I.localGhosts,e.items))await C.notification.show("This would exceed the maximum Spectres. Please remove some before adding more.","INFO");else for(const n of e.items){const r=n;lt.SetupTomSelect(r)}else for(const n of e.items){const r=n;await lt.RemoveGhost(r),r.metadata[`${u.SPECTREID}/spectred`]=void 0;const o=I.localGhosts.findIndex(c=>c.id===r.id);I.localGhosts.splice(o,1),document.getElementById(`tr-${r.id}`)?.remove(),r.metadata[`${u.SPECTREID}/viewers`]=[],await C.scene.items.addItems([r])}}})}async RestoreGhostsGM(){I.localGhosts=I.sceneMetadata[`${u.SPECTREID}/current_spectres`],I.localGhosts||(I.localGhosts=[]),I.localGhosts.length>0&&(await C.scene.local.addItems(I.localGhosts),I.localGhosts.forEach(e=>{this.SetupTomSelect(e)}))}async StoreGhost(e){let t=I.sceneMetadata[`${u.SPECTREID}/current_spectres`];if(!t)t=[e];else{if(t.find(r=>r.id===e.id))return;t.push(e)}await C.scene.setMetadata({[`${u.SPECTREID}/current_spectres`]:t})}async RemoveGhost(e){let t=I.sceneMetadata[`${u.SPECTREID}/current_spectres`];t||(t=[]);const n=t.filter(r=>r.id!==e.id);await C.scene.local.deleteItems([e.id]),await C.scene.setMetadata({[`${u.SPECTREID}/current_spectres`]:n})}async SetupTomSelect(e){const t=e.text?.plainText||e.name;let n=e.metadata[`${u.SPECTREID}/viewers`];e.metadata[`${u.SPECTREID}/spectred`]=!0,n===void 0&&(n=[],e.metadata[`${u.SPECTREID}/viewers`]=[]),await C.scene.items.deleteItems([e.id]),await C.scene.local.addItems([e]),await this.StoreGhost(e),I.localGhosts.push(e);const r=document.getElementById("ghostList"),o=document.createElement("tr");o.id=`tr-${e.id}`,o.className="ghost-table-entry",o.innerHTML=`<td class="token-name">${t}</td>
            <td><select id="select-${e.id}" class="tSelects" multiple autocomplete="off" /></td>
            <td><input type="button" class="mysteryButton" id="deleteGhost-${e.id}" value="Delete"/></td>`,r.appendChild(o);const l=document.getElementById(`select-${e.id}`);for(const N of I.party){const x=document.createElement("option");x.value=N.id,x.text=N.name,l.appendChild(x)}const c={plugins:{remove_button:{title:"Remove this item"}},allowEmptyOption:!0,placeholder:I.party.length==0?"No Players Present":"Choose..",maxItems:null,create:!1,onDelete:async function(N,x){const M=x.currentTarget.parentElement.parentElement.parentElement.parentElement.parentElement.id.slice(3);await C.scene.local.updateItems([M],A=>{const b=A[0].metadata[`${u.SPECTREID}/viewers`],$=b.findIndex(_=>_==N);b.splice($,1),A[0].metadata[`${u.SPECTREID}/viewers`]=b})},onItemAdd:async function(N,x){const M=x.parentElement.parentElement.parentElement.parentElement.id.slice(3);await C.scene.local.updateItems([M],A=>{const b=A[0].metadata[`${u.SPECTREID}/viewers`];b?(b.push(N),A[0].metadata[`${u.SPECTREID}/viewers`]=b):A[0].metadata[`${u.SPECTREID}/viewers`]=[N]})}},p=new et(`#select-${e.id}`,c);if(n.length>0)for(const N of n){if(!I.party.find(M=>M.id===N)){const M=I.sceneMetadata[`${u.EXTENSIONID}/USER-${N}`],A=[];A.push({value:N,text:M.name}),p.addOption(A)}p.addItem(N,!0)}const y=document.getElementById(`deleteGhost-${e.id}`);y.onclick=async()=>{const N=I.localGhosts.findIndex(x=>x.id===e.id);I.localGhosts.splice(N,1),o.remove(),await C.scene.local.updateItems([e.id],x=>{x[0]&&(x[0].metadata[`${u.SPECTREID}/viewers`]=[])}),await this.RemoveGhost(e)}}ClearGhostList(){const e=document.getElementById("ghostList");e&&(e.innerHTML="")}}const lt=new Xo;async function Rn(){await C.scene.items.deleteItems(I.sceneItems.filter(_t).map(e=>e.id)),Zt(I.sceneMetadata[`${u.EXTENSIONID}/fowEnabled`]==!0);let i;if(I.sceneItems.filter(hs).length==0){const e=I.sceneItems.filter(n=>n.layer=="MAP"&&Yt(n)),t=e.map(n=>n.image.width*n.image.height/Math.pow(n.grid.dpi,2));i=e[t.indexOf(Math.max(...t))]}if(I.sceneMetadata[`${u.EXTENSIONID}/autodetectEnabled`]===void 0&&(I.playerRole==="GM"&&(Z.autodetectCheckbox.checked=!0),await C.scene.setMetadata({[`${u.EXTENSIONID}/autodetectEnabled`]:!0})),I.sceneMetadata[`${u.EXTENSIONID}/sceneId`]===void 0)await C.scene.setMetadata({[`${u.EXTENSIONID}/sceneId`]:crypto.randomUUID()});else try{const e=I.sceneMetadata[`${u.EXTENSIONID}/sceneId`],t=localStorage.getItem(`${u.EXTENSIONID}/fogCache/${I.playerId}/${e}`);if(t!==null&&I.sceneMetadata[`${u.EXTENSIONID}/persistenceEnabled`]===!0){const n=JSON.parse(t),r=[];for(let o=0;o<n.length;o++){const l=ft().commands(n[o].commands).fillRule("evenodd").locked(!0).visible(!1).fillColor("#000000").strokeColor("#000000").layer("FOG").name("Fog of War").metadata({[`${u.EXTENSIONID}/isVisionFog`]:!0,[`${u.EXTENSIONID}/digest`]:n[o].digest}).build();l.zIndex=3,r.push(l)}await C.scene.local.addItems(r)}}catch{}I.playerRole==="GM"?(await lt.RestoreGhostsGM(),await Z.UpdateUI(),Z.mapSubmit.onclick=async()=>{await C.scene.items.updateItems([u.GRIDID],e=>{for(const t of e){const n=t;n.width=I.gridDpi*+Z.mapWidth.value,n.height=I.gridDpi*+Z.mapHeight.value,n.scale={x:1,y:1}}})},i!==void 0&&await C.scene.items.updateItems([i],e=>{e[0].metadata[`${u.EXTENSIONID}/isBackgroundImage`]=!0})):await lt.LoadSpectreSceneMetadata(),I.snap=!0,I.sceneInitialized=!0}var Ui={exports:{}};const Vo={},Ho=Object.freeze(Object.defineProperty({__proto__:null,default:Vo},Symbol.toStringTag,{value:"Module"})),On=Tr(Ho);(function(i,e){var t=(()=>{var n=typeof document<"u"&&document.currentScript?document.currentScript.src:void 0;return typeof __filename<"u"&&(n=n||__filename),function(r){r=r||{};var o;o||(o=typeof r<"u"?r:{});var l=Object.assign,c,p;o.ready=new Promise(function(a,s){c=a,p=s}),function(a){var s={};a.loadCmdsTypedArray=function(V){for(var K=0,Q=0;Q<V.length;Q++)K+=V[Q].length;if(s[K])var ee=s[K];else ee=new Float32Array(K),s[K]=ee;var se=0;for(Q=0;Q<V.length;Q++)for(var Ce=0;Ce<V[Q].length;Ce++){var Re=V[Q][Ce];typeof Re=="string"&&(Re=a.SkBits2FloatUnsigned(parseInt(Re))),ee[se]=Re,se++}return V=a._malloc(ee.length*ee.BYTES_PER_ELEMENT),a.HEAPF32.set(ee,V/ee.BYTES_PER_ELEMENT),[V,K]},a.FromCmds=function(V){V=a.loadCmdsTypedArray(V);var K=a._FromCmds(V[0],V[1]);return a._free(V[0]),K};var d,v,D,B,q;a.cubicYFromX=function(V,K,Q,ee,se){return d&&v===V&&D===K&&B===Q&&q===ee||(d&&d.delete(),d=new a._SkCubicMap([V,K],[Q,ee]),v=V,D=K,B=Q,q=ee),d.computeYFromX(se)},a.cubicPtFromT=function(V,K,Q,ee,se){return d&&v===V&&D===K&&B===Q&&q===ee||(d&&d.delete(),d=new a._SkCubicMap([V,K],[Q,ee]),v=V,D=K,B=Q,q=ee),d.computePtFromT(se)}}(o),function(a){a.onRuntimeInitialized=function(){a.SkPath.prototype.addPath=function(){var s=arguments[0];if(arguments.length===1)this._addPath(s,1,0,0,0,1,0,0,0,1);else if(arguments.length===2){var d=arguments[1];this._addPath(s,d.a,d.c,d.e,d.b,d.d,d.f,0,0,1)}else if(arguments.length===7)d=arguments,this._addPath(s,d[1],d[3],d[5],d[2],d[4],d[6],0,0,1);else if(arguments.length===10)d=arguments,this._addPath(s,d[1],d[2],d[3],d[4],d[5],d[6],d[7],d[8],d[9]);else return console.Ma("addPath expected to take 1, 2, 7, or 10 args. Got "+arguments.length),null;return this},a.SkPath.prototype.arc=function(s,d,v,D,B,q){return this._arc(s,d,v,D,B,!!q),this},a.SkPath.prototype.arcTo=function(s,d,v,D,B){return this._arcTo(s,d,v,D,B),this},a.SkPath.prototype.bezierCurveTo=function(s,d,v,D,B,q){return this._cubicTo(s,d,v,D,B,q),this},a.SkPath.prototype.close=function(){return this._close(),this},a.SkPath.prototype.closePath=function(){return this._close(),this},a.SkPath.prototype.conicTo=function(s,d,v,D,B){return this._conicTo(s,d,v,D,B),this},a.SkPath.prototype.cubicTo=function(s,d,v,D,B,q){return this._cubicTo(s,d,v,D,B,q),this},a.SkPath.prototype.dash=function(s,d,v){return this._dash(s,d,v)?this:null},a.SkPath.prototype.ellipse=function(s,d,v,D,B,q,V,K){return this._ellipse(s,d,v,D,B,q,V,!!K),this},a.SkPath.prototype.lineTo=function(s,d){return this._lineTo(s,d),this},a.SkPath.prototype.moveTo=function(s,d){return this._moveTo(s,d),this},a.SkPath.prototype.op=function(s,d){return this._op(s,d)?this:null},a.SkPath.prototype.quadraticCurveTo=function(s,d,v,D){return this._quadTo(s,d,v,D),this},a.SkPath.prototype.quadTo=function(s,d,v,D){return this._quadTo(s,d,v,D),this},a.SkPath.prototype.rect=function(s,d,v,D){return this._rect(s,d,v,D),this},a.SkPath.prototype.simplify=function(){return this._simplify()?this:null},a.SkPath.prototype.stroke=function(s){return s=s||{},s.width=s.width||1,s.miter_limit=s.miter_limit||4,s.cap=s.cap||a.StrokeCap.BUTT,s.join=s.join||a.StrokeJoin.MITER,this._stroke(s)?this:null},a.SkPath.prototype.transform=function(){if(arguments.length===1)this._transform(arguments[0]);else if(arguments.length===9){var s=arguments;this._transform(s[0],s[1],s[2],s[3],s[4],s[5],s[6],s[7],s[8])}else return console.Ma("transform expected to take 1 or 9 arguments. Got "+arguments.length),null;return this},a.SkPath.prototype.trim=function(s,d,v){return this._trim(s,d,!!v)?this:null}}}(o);var y=l({},o),N=typeof window=="object",x=typeof importScripts=="function",M="",A,b,$,_,L,P;typeof process=="object"&&typeof process.versions=="object"&&typeof process.versions.node=="string"?(M=x?On.dirname(M)+"/":__dirname+"/",P=()=>{L||(_=On,L=On)},A=function(a,s){return P(),a=L.normalize(a),_.readFileSync(a,s?null:"utf8")},$=a=>(a=A(a,!0),a.buffer||(a=new Uint8Array(a)),a),b=(a,s,d)=>{P(),a=L.normalize(a),_.readFile(a,function(v,D){v?d(v):s(D.buffer)})},1<process.argv.length&&process.argv[1].replace(/\\/g,"/"),process.argv.slice(2),process.on("uncaughtException",function(a){throw a}),process.on("unhandledRejection",function(a){throw a}),o.inspect=function(){return"[Emscripten Module object]"}):(N||x)&&(x?M=self.location.href:typeof document<"u"&&document.currentScript&&(M=document.currentScript.src),n&&(M=n),M.indexOf("blob:")!==0?M=M.substr(0,M.replace(/[?#].*/,"").lastIndexOf("/")+1):M="",A=a=>{var s=new XMLHttpRequest;return s.open("GET",a,!1),s.send(null),s.responseText},x&&($=a=>{var s=new XMLHttpRequest;return s.open("GET",a,!1),s.responseType="arraybuffer",s.send(null),new Uint8Array(s.response)}),b=(a,s,d)=>{var v=new XMLHttpRequest;v.open("GET",a,!0),v.responseType="arraybuffer",v.onload=()=>{v.status==200||v.status==0&&v.response?s(v.response):d()},v.onerror=d,v.send(null)});var X=o.print||console.log.bind(console),H=o.printErr||console.warn.bind(console);l(o,y),y=null;var ie;o.wasmBinary&&(ie=o.wasmBinary),o.noExitRuntime,typeof WebAssembly!="object"&&he("no native wasm support detected");var O,w=!1,g=typeof TextDecoder<"u"?new TextDecoder("utf8"):void 0;function E(a,s,d){var v=s+d;for(d=s;a[d]&&!(d>=v);)++d;if(16<d-s&&a.subarray&&g)return g.decode(a.subarray(s,d));for(v="";s<d;){var D=a[s++];if(D&128){var B=a[s++]&63;if((D&224)==192)v+=String.fromCharCode((D&31)<<6|B);else{var q=a[s++]&63;D=(D&240)==224?(D&15)<<12|B<<6|q:(D&7)<<18|B<<12|q<<6|a[s++]&63,65536>D?v+=String.fromCharCode(D):(D-=65536,v+=String.fromCharCode(55296|D>>10,56320|D&1023))}}else v+=String.fromCharCode(D)}return v}function h(a,s,d){var v=Y;if(0<d){d=s+d-1;for(var D=0;D<a.length;++D){var B=a.charCodeAt(D);if(55296<=B&&57343>=B){var q=a.charCodeAt(++D);B=65536+((B&1023)<<10)|q&1023}if(127>=B){if(s>=d)break;v[s++]=B}else{if(2047>=B){if(s+1>=d)break;v[s++]=192|B>>6}else{if(65535>=B){if(s+2>=d)break;v[s++]=224|B>>12}else{if(s+3>=d)break;v[s++]=240|B>>18,v[s++]=128|B>>12&63}v[s++]=128|B>>6&63}v[s++]=128|B&63}}v[s]=0}}var k=typeof TextDecoder<"u"?new TextDecoder("utf-16le"):void 0;function R(a,s){for(var d=a>>1,v=d+s/2;!(d>=v)&&ge[d];)++d;if(d<<=1,32<d-a&&k)return k.decode(Y.subarray(a,d));for(d="",v=0;!(v>=s/2);++v){var D=re[a+2*v>>1];if(D==0)break;d+=String.fromCharCode(D)}return d}function ae(a,s,d){if(d===void 0&&(d=2147483647),2>d)return 0;d-=2;var v=s;d=d<2*a.length?d/2:a.length;for(var D=0;D<d;++D)re[s>>1]=a.charCodeAt(D),s+=2;return re[s>>1]=0,s-v}function ce(a){return 2*a.length}function le(a,s){for(var d=0,v="";!(d>=s/4);){var D=de[a+4*d>>2];if(D==0)break;++d,65536<=D?(D-=65536,v+=String.fromCharCode(55296|D>>10,56320|D&1023)):v+=String.fromCharCode(D)}return v}function J(a,s,d){if(d===void 0&&(d=2147483647),4>d)return 0;var v=s;d=v+d-4;for(var D=0;D<a.length;++D){var B=a.charCodeAt(D);if(55296<=B&&57343>=B){var q=a.charCodeAt(++D);B=65536+((B&1023)<<10)|q&1023}if(de[s>>2]=B,s+=4,s+4>d)break}return de[s>>2]=0,s-v}function Te(a){for(var s=0,d=0;d<a.length;++d){var v=a.charCodeAt(d);55296<=v&&57343>=v&&++d,s+=4}return s}var Ae,we,Y,re,ge,de,ue,ye,ve;function Ne(){var a=O.buffer;Ae=a,o.HEAP8=we=new Int8Array(a),o.HEAP16=re=new Int16Array(a),o.HEAP32=de=new Int32Array(a),o.HEAPU8=Y=new Uint8Array(a),o.HEAPU16=ge=new Uint16Array(a),o.HEAPU32=ue=new Uint32Array(a),o.HEAPF32=ye=new Float32Array(a),o.HEAPF64=ve=new Float64Array(a)}var W,f=[],m=[],T=[];function j(){var a=o.preRun.shift();f.unshift(a)}var U=0,z=null;o.preloadedImages={},o.preloadedAudios={};function he(a){throw o.onAbort&&o.onAbort(a),a="Aborted("+a+")",H(a),w=!0,a=new WebAssembly.RuntimeError(a+". Build with -s ASSERTIONS=1 for more info."),p(a),a}function xe(){return Ee.startsWith("data:application/octet-stream;base64,")}var Ee;if(Ee="pathkit.wasm",!xe()){var He=Ee;Ee=o.locateFile?o.locateFile(He,M):M+He}function Fe(){var a=Ee;try{if(a==Ee&&ie)return new Uint8Array(ie);if($)return $(a);throw"both async and sync fetching of the wasm failed"}catch(s){he(s)}}function Xe(){if(!ie&&(N||x)){if(typeof fetch=="function"&&!Ee.startsWith("file://"))return fetch(Ee,{credentials:"same-origin"}).then(function(a){if(!a.ok)throw"failed to load wasm binary file at '"+Ee+"'";return a.arrayBuffer()}).catch(function(){return Fe()});if(b)return new Promise(function(a,s){b(Ee,function(d){a(new Uint8Array(d))},s)})}return Promise.resolve().then(function(){return Fe()})}function Le(a){for(;0<a.length;){var s=a.shift();if(typeof s=="function")s(o);else{var d=s.Wa;typeof d=="number"?s.xa===void 0?W.get(d)():W.get(d)(s.xa):d(s.xa===void 0?null:s.xa)}}}var Ie={};function Oe(a){for(;a.length;){var s=a.pop();a.pop()(s)}}function qe(a){return this.fromWireType(ue[a>>2])}var te={},me={},S={};function F(a){if(a===void 0)return"_unknown";a=a.replace(/[^a-zA-Z0-9_]/g,"$");var s=a.charCodeAt(0);return 48<=s&&57>=s?"_"+a:a}function G(a,s){return a=F(a),function(){return s.apply(this,arguments)}}function ne(a){var s=Error,d=G(a,function(v){this.name=a,this.message=v,v=Error(v).stack,v!==void 0&&(this.stack=this.toString()+`
`+v.replace(/^Error(:[^\n]*)?\n/,""))});return d.prototype=Object.create(s.prototype),d.prototype.constructor=d,d.prototype.toString=function(){return this.message===void 0?this.name:this.name+": "+this.message},d}var oe=void 0;function fe(a){throw new oe(a)}function pe(a,s,d){function v(V){V=d(V),V.length!==a.length&&fe("Mismatched type converter count");for(var K=0;K<a.length;++K)at(a[K],V[K])}a.forEach(function(V){S[V]=s});var D=Array(s.length),B=[],q=0;s.forEach(function(V,K){me.hasOwnProperty(V)?D[K]=me[V]:(B.push(V),te.hasOwnProperty(V)||(te[V]=[]),te[V].push(function(){D[K]=me[V],++q,q===B.length&&v(D)}))}),B.length===0&&v(D)}var Me={};function be(a){switch(a){case 1:return 0;case 2:return 1;case 4:return 2;case 8:return 3;default:throw new TypeError("Unknown type size: "+a)}}var Ue=void 0;function _e(a){for(var s="";Y[a];)s+=Ue[Y[a++]];return s}var Ge=void 0;function ke(a){throw new Ge(a)}function at(a,s,d={}){if(!("argPackAdvance"in s))throw new TypeError("registerType registeredInstance requires argPackAdvance");var v=s.name;if(a||ke('type "'+v+'" must have a positive integer typeid pointer'),me.hasOwnProperty(a)){if(d.Qa)return;ke("Cannot register type '"+v+"' twice")}me[a]=s,delete S[a],te.hasOwnProperty(a)&&(s=te[a],delete te[a],s.forEach(function(D){D()}))}function on(a){ke(a.ea.ha.fa.name+" instance already deleted")}var sn=!1;function Un(){}function Gn(a){--a.count.value,a.count.value===0&&(a.ka?a.ma.la(a.ka):a.ha.fa.la(a.ga))}function Tt(a){return typeof FinalizationGroup>"u"?(Tt=s=>s,a):(sn=new FinalizationGroup(function(s){for(var d=s.next();!d.done;d=s.next())d=d.value,d.ga?Gn(d):console.warn("object already deleted: "+d.ga)}),Tt=s=>(sn.register(s,s.ea,s.ea),s),Un=s=>{sn.unregister(s.ea)},Tt(a))}var Nt=void 0,Ot=[];function an(){for(;Ot.length;){var a=Ot.pop();a.ea.pa=!1,a.delete()}}function ht(){}var jn={};function Wn(a,s,d){if(a[s].ia===void 0){var v=a[s];a[s]=function(){return a[s].ia.hasOwnProperty(arguments.length)||ke("Function '"+d+"' called with an invalid number of arguments ("+arguments.length+") - expects one of ("+a[s].ia+")!"),a[s].ia[arguments.length].apply(this,arguments)},a[s].ia=[],a[s].ia[v.ua]=v}}function ln(a,s,d){o.hasOwnProperty(a)?((d===void 0||o[a].ia!==void 0&&o[a].ia[d]!==void 0)&&ke("Cannot register public name '"+a+"' twice"),Wn(o,a,a),o.hasOwnProperty(d)&&ke("Cannot register multiple overloads of a function with the same number of arguments ("+d+")!"),o[a].ia[d]=s):(o[a]=s,d!==void 0&&(o[a].Xa=d))}function or(a,s,d,v,D,B,q,V){this.name=a,this.constructor=s,this.qa=d,this.la=v,this.na=D,this.Oa=B,this.ta=q,this.La=V,this.Ta=[]}function cn(a,s,d){for(;s!==d;)s.ta||ke("Expected null or instance of "+d.name+", got an instance of "+s.name),a=s.ta(a),s=s.na;return a}function sr(a,s){return s===null?(this.Ba&&ke("null is not a valid "+this.name),0):(s.ea||ke('Cannot pass "'+pn(s)+'" as a '+this.name),s.ea.ga||ke("Cannot pass deleted object as a pointer of type "+this.name),cn(s.ea.ga,s.ea.ha.fa,this.fa))}function ar(a,s){if(s===null){if(this.Ba&&ke("null is not a valid "+this.name),this.wa){var d=this.sa();return a!==null&&a.push(this.la,d),d}return 0}if(s.ea||ke('Cannot pass "'+pn(s)+'" as a '+this.name),s.ea.ga||ke("Cannot pass deleted object as a pointer of type "+this.name),!this.va&&s.ea.ha.va&&ke("Cannot convert argument of type "+(s.ea.ma?s.ea.ma.name:s.ea.ha.name)+" to parameter type "+this.name),d=cn(s.ea.ga,s.ea.ha.fa,this.fa),this.wa)switch(s.ea.ka===void 0&&ke("Passing raw pointer to smart pointer is illegal"),this.Va){case 0:s.ea.ma===this?d=s.ea.ka:ke("Cannot convert argument of type "+(s.ea.ma?s.ea.ma.name:s.ea.ha.name)+" to parameter type "+this.name);break;case 1:d=s.ea.ka;break;case 2:if(s.ea.ma===this)d=s.ea.ka;else{var v=s.clone();d=this.Ua(d,pt(function(){v.delete()})),a!==null&&a.push(this.la,d)}break;default:ke("Unsupporting sharing policy")}return d}function lr(a,s){return s===null?(this.Ba&&ke("null is not a valid "+this.name),0):(s.ea||ke('Cannot pass "'+pn(s)+'" as a '+this.name),s.ea.ga||ke("Cannot pass deleted object as a pointer of type "+this.name),s.ea.ha.va&&ke("Cannot convert argument of type "+s.ea.ha.name+" to parameter type "+this.name),cn(s.ea.ga,s.ea.ha.fa,this.fa))}function qn(a,s,d){return s===d?a:d.na===void 0?null:(a=qn(a,s,d.na),a===null?null:d.La(a))}var kt={};function cr(a,s){for(s===void 0&&ke("ptr should not be undefined");a.na;)s=a.ta(s),a=a.na;return kt[s]}function Dt(a,s){return s.ha&&s.ga||fe("makeClassHandle requires ptr and ptrType"),!!s.ma!=!!s.ka&&fe("Both smartPtrType and smartPtr must be specified"),s.count={value:1},Tt(Object.create(a,{ea:{value:s}}))}function ct(a,s,d,v){this.name=a,this.fa=s,this.Ba=d,this.va=v,this.wa=!1,this.la=this.Ua=this.sa=this.Ia=this.Va=this.Sa=void 0,s.na!==void 0?this.toWireType=ar:(this.toWireType=v?sr:lr,this.ja=null)}function Kn(a,s,d){o.hasOwnProperty(a)||fe("Replacing nonexistant public symbol"),o[a].ia!==void 0&&d!==void 0?o[a].ia[d]=s:(o[a]=s,o[a].ua=d)}function ur(a,s){var d=[];return function(){d.length=arguments.length;for(var v=0;v<arguments.length;v++)d[v]=arguments[v];return a.includes("j")?(v=o["dynCall_"+a],v=d&&d.length?v.apply(null,[s].concat(d)):v.call(null,s)):v=W.get(s).apply(null,d),v}}function Ye(a,s){a=_e(a);var d=a.includes("j")?ur(a,s):W.get(s);return typeof d!="function"&&ke("unknown function pointer with signature "+a+": "+s),d}var Yn=void 0;function zn(a){a=ni(a);var s=_e(a);return ut(a),s}function At(a,s){function d(B){D[B]||me[B]||(S[B]?S[B].forEach(d):(v.push(B),D[B]=!0))}var v=[],D={};throw s.forEach(d),new Yn(a+": "+v.map(zn).join([", "]))}function un(a,s){for(var d=[],v=0;v<a;v++)d.push(de[(s>>2)+v]);return d}function dn(a,s,d,v,D){var B=s.length;2>B&&ke("argTypes array size mismatch! Must at least get return value and 'this' types!");var q=s[1]!==null&&d!==null,V=!1;for(d=1;d<s.length;++d)if(s[d]!==null&&s[d].ja===void 0){V=!0;break}var K=s[0].name!=="void",Q=B-2,ee=Array(Q),se=[],Ce=[];return function(){if(arguments.length!==Q&&ke("function "+a+" called with "+arguments.length+" arguments, expected "+Q+" args!"),Ce.length=0,se.length=q?2:1,se[0]=D,q){var Re=s[1].toWireType(Ce,this);se[1]=Re}for(var De=0;De<Q;++De)ee[De]=s[De+2].toWireType(Ce,arguments[De]),se.push(ee[De]);if(De=v.apply(null,se),V)Oe(Ce);else for(var ze=q?1:2;ze<s.length;ze++){var Ze=ze===1?Re:ee[ze-2];s[ze].ja!==null&&s[ze].ja(Ze)}return Re=K?s[0].fromWireType(De):void 0,Re}}var fn=[],st=[{},{value:void 0},{value:null},{value:!0},{value:!1}];function Zn(a){4<a&&--st[a].Ca===0&&(st[a]=void 0,fn.push(a))}function hn(a){return a||ke("Cannot use deleted val. handle = "+a),st[a].value}function pt(a){switch(a){case void 0:return 1;case null:return 2;case!0:return 3;case!1:return 4;default:var s=fn.length?fn.pop():st.length;return st[s]={Ca:1,value:a},s}}function dr(a,s,d){switch(s){case 0:return function(v){return this.fromWireType((d?we:Y)[v])};case 1:return function(v){return this.fromWireType((d?re:ge)[v>>1])};case 2:return function(v){return this.fromWireType((d?de:ue)[v>>2])};default:throw new TypeError("Unknown integer type: "+a)}}function Mt(a,s){var d=me[a];return d===void 0&&ke(s+" has unknown type "+zn(a)),d}function pn(a){if(a===null)return"null";var s=typeof a;return s==="object"||s==="array"||s==="function"?a.toString():""+a}function fr(a,s){switch(s){case 2:return function(d){return this.fromWireType(ye[d>>2])};case 3:return function(d){return this.fromWireType(ve[d>>3])};default:throw new TypeError("Unknown float type: "+a)}}function hr(a,s,d){switch(s){case 0:return d?function(v){return we[v]}:function(v){return Y[v]};case 1:return d?function(v){return re[v>>1]}:function(v){return ge[v>>1]};case 2:return d?function(v){return de[v>>2]}:function(v){return ue[v>>2]};default:throw new TypeError("Unknown integer type: "+a)}}var pr={};function gn(a){var s=pr[a];return s===void 0?_e(a):s}var mn=[];function Jn(){function a(s){s.$$$embind_global$$$=s;var d=typeof $$$embind_global$$$=="object"&&s.$$$embind_global$$$===s;return d||delete s.$$$embind_global$$$,d}if(typeof globalThis=="object")return globalThis;if(typeof $$$embind_global$$$=="object"||(typeof In=="object"&&a(In)?$$$embind_global$$$=In:typeof self=="object"&&a(self)&&($$$embind_global$$$=self),typeof $$$embind_global$$$=="object"))return $$$embind_global$$$;throw Error("unable to get global object.")}function gr(a){var s=mn.length;return mn.push(a),s}function mr(a,s){for(var d=Array(a),v=0;v<a;++v)d[v]=Mt(de[(s>>2)+v],"parameter "+v);return d}var Qn=[];function yr(a){var s=Array(a+1);return function(d,v,D){s[0]=d;for(var B=0;B<a;++B){var q=Mt(de[(v>>2)+B],"parameter "+B);s[B+1]=q.readValueFromPointer(D),D+=q.argPackAdvance}return d=new(d.bind.apply(d,s)),pt(d)}}var ei={},vr=[null,[],[]];oe=o.InternalError=ne("InternalError");for(var ti=Array(256),Pt=0;256>Pt;++Pt)ti[Pt]=String.fromCharCode(Pt);Ue=ti,Ge=o.BindingError=ne("BindingError"),ht.prototype.isAliasOf=function(a){if(!(this instanceof ht&&a instanceof ht))return!1;var s=this.ea.ha.fa,d=this.ea.ga,v=a.ea.ha.fa;for(a=a.ea.ga;s.na;)d=s.ta(d),s=s.na;for(;v.na;)a=v.ta(a),v=v.na;return s===v&&d===a},ht.prototype.clone=function(){if(this.ea.ga||on(this),this.ea.ra)return this.ea.count.value+=1,this;var a=Tt,s=Object,d=s.create,v=Object.getPrototypeOf(this),D=this.ea;return a=a(d.call(s,v,{ea:{value:{count:D.count,pa:D.pa,ra:D.ra,ga:D.ga,ha:D.ha,ka:D.ka,ma:D.ma}}})),a.ea.count.value+=1,a.ea.pa=!1,a},ht.prototype.delete=function(){this.ea.ga||on(this),this.ea.pa&&!this.ea.ra&&ke("Object already scheduled for deletion"),Un(this),Gn(this.ea),this.ea.ra||(this.ea.ka=void 0,this.ea.ga=void 0)},ht.prototype.isDeleted=function(){return!this.ea.ga},ht.prototype.deleteLater=function(){return this.ea.ga||on(this),this.ea.pa&&!this.ea.ra&&ke("Object already scheduled for deletion"),Ot.push(this),Ot.length===1&&Nt&&Nt(an),this.ea.pa=!0,this},ct.prototype.Pa=function(a){return this.Ia&&(a=this.Ia(a)),a},ct.prototype.Ga=function(a){this.la&&this.la(a)},ct.prototype.argPackAdvance=8,ct.prototype.readValueFromPointer=qe,ct.prototype.deleteObject=function(a){a!==null&&a.delete()},ct.prototype.fromWireType=function(a){function s(){return this.wa?Dt(this.fa.qa,{ha:this.Sa,ga:d,ma:this,ka:a}):Dt(this.fa.qa,{ha:this,ga:a})}var d=this.Pa(a);if(!d)return this.Ga(a),null;var v=cr(this.fa,d);if(v!==void 0)return v.ea.count.value===0?(v.ea.ga=d,v.ea.ka=a,v.clone()):(v=v.clone(),this.Ga(a),v);if(v=this.fa.Oa(d),v=jn[v],!v)return s.call(this);v=this.va?v.Ja:v.pointerType;var D=qn(d,this.fa,v.fa);return D===null?s.call(this):this.wa?Dt(v.fa.qa,{ha:v,ga:D,ma:this,ka:a}):Dt(v.fa.qa,{ha:v,ga:D})},o.getInheritedInstanceCount=function(){return Object.keys(kt).length},o.getLiveInheritedInstances=function(){var a=[],s;for(s in kt)kt.hasOwnProperty(s)&&a.push(kt[s]);return a},o.flushPendingDeletes=an,o.setDelayFunction=function(a){Nt=a,Ot.length&&Nt&&Nt(an)},Yn=o.UnboundTypeError=ne("UnboundTypeError"),o.count_emval_handles=function(){for(var a=0,s=5;s<st.length;++s)st[s]!==void 0&&++a;return a},o.get_first_emval=function(){for(var a=5;a<st.length;++a)if(st[a]!==void 0)return st[a];return null};var Ir={r:function(a){var s=Ie[a];delete Ie[a];var d=s.elements,v=d.length,D=d.map(function(V){return V.Aa}).concat(d.map(function(V){return V.Ea})),B=s.sa,q=s.la;pe([a],D,function(V){return d.forEach(function(K,Q){var ee=V[Q],se=K.ya,Ce=K.za,Re=V[Q+v],De=K.Da,ze=K.Fa;K.read=Ze=>ee.fromWireType(se(Ce,Ze)),K.write=(Ze,yt)=>{var nt=[];De(ze,Ze,Re.toWireType(nt,yt)),Oe(nt)}}),[{name:s.name,fromWireType:function(K){for(var Q=Array(v),ee=0;ee<v;++ee)Q[ee]=d[ee].read(K);return q(K),Q},toWireType:function(K,Q){if(v!==Q.length)throw new TypeError("Incorrect number of tuple elements for "+s.name+": expected="+v+", actual="+Q.length);for(var ee=B(),se=0;se<v;++se)d[se].write(ee,Q[se]);return K!==null&&K.push(q,ee),ee},argPackAdvance:8,readValueFromPointer:qe,ja:q}]})},u:function(a){var s=Me[a];delete Me[a];var d=s.sa,v=s.la,D=s.Ha,B=D.map(function(q){return q.Aa}).concat(D.map(function(q){return q.Ea}));pe([a],B,function(q){var V={};return D.forEach(function(K,Q){var ee=q[Q],se=K.ya,Ce=K.za,Re=q[Q+D.length],De=K.Da,ze=K.Fa;V[K.Na]={read:function(Ze){return ee.fromWireType(se(Ce,Ze))},write:function(Ze,yt){var nt=[];De(ze,Ze,Re.toWireType(nt,yt)),Oe(nt)}}}),[{name:s.name,fromWireType:function(K){var Q={},ee;for(ee in V)Q[ee]=V[ee].read(K);return v(K),Q},toWireType:function(K,Q){for(var ee in V)if(!(ee in Q))throw new TypeError('Missing field:  "'+ee+'"');var se=d();for(ee in V)V[ee].write(se,Q[ee]);return K!==null&&K.push(v,se),se},argPackAdvance:8,readValueFromPointer:qe,ja:v}]})},z:function(){},F:function(a,s,d,v,D){var B=be(d);s=_e(s),at(a,{name:s,fromWireType:function(q){return!!q},toWireType:function(q,V){return V?v:D},argPackAdvance:8,readValueFromPointer:function(q){if(d===1)var V=we;else if(d===2)V=re;else if(d===4)V=de;else throw new TypeError("Unknown boolean type size: "+s);return this.fromWireType(V[q>>B])},ja:null})},l:function(a,s,d,v,D,B,q,V,K,Q,ee,se,Ce){ee=_e(ee),B=Ye(D,B),V&&(V=Ye(q,V)),Q&&(Q=Ye(K,Q)),Ce=Ye(se,Ce);var Re=F(ee);ln(Re,function(){At("Cannot construct "+ee+" due to unbound types",[v])}),pe([a,s,d],v?[v]:[],function(De){if(De=De[0],v)var ze=De.fa,Ze=ze.qa;else Ze=ht.prototype;De=G(Re,function(){if(Object.getPrototypeOf(this)!==yt)throw new Ge("Use 'new' to construct "+ee);if(nt.oa===void 0)throw new Ge(ee+" has no accessible constructor");var ri=nt.oa[arguments.length];if(ri===void 0)throw new Ge("Tried to invoke ctor of "+ee+" with invalid number of parameters ("+arguments.length+") - expected ("+Object.keys(nt.oa).toString()+") parameters instead!");return ri.apply(this,arguments)});var yt=Object.create(Ze,{constructor:{value:De}});De.prototype=yt;var nt=new or(ee,De,yt,Ce,ze,B,V,Q);ze=new ct(ee,nt,!0,!1),Ze=new ct(ee+"*",nt,!1,!1);var ii=new ct(ee+" const*",nt,!1,!0);return jn[a]={pointerType:Ze,Ja:ii},Kn(Re,De),[ze,Ze,ii]})},i:function(a,s,d,v,D,B){0<s||he(void 0);var q=un(s,d);D=Ye(v,D),pe([],[a],function(V){V=V[0];var K="constructor "+V.name;if(V.fa.oa===void 0&&(V.fa.oa=[]),V.fa.oa[s-1]!==void 0)throw new Ge("Cannot register multiple constructors with identical number of parameters ("+(s-1)+") for class '"+V.name+"'! Overload resolution is currently only performed using the parameter count, not actual type info!");return V.fa.oa[s-1]=()=>{At("Cannot construct "+V.name+" due to unbound types",q)},pe([],q,function(Q){return Q.splice(1,0,null),V.fa.oa[s-1]=dn(K,Q,null,D,B),[]}),[]})},a:function(a,s,d,v,D,B,q,V){var K=un(d,v);s=_e(s),B=Ye(D,B),pe([],[a],function(Q){function ee(){At("Cannot call "+se+" due to unbound types",K)}Q=Q[0];var se=Q.name+"."+s;s.startsWith("@@")&&(s=Symbol[s.substring(2)]),V&&Q.fa.Ta.push(s);var Ce=Q.fa.qa,Re=Ce[s];return Re===void 0||Re.ia===void 0&&Re.className!==Q.name&&Re.ua===d-2?(ee.ua=d-2,ee.className=Q.name,Ce[s]=ee):(Wn(Ce,s,se),Ce[s].ia[d-2]=ee),pe([],K,function(De){return De=dn(se,De,Q,B,q),Ce[s].ia===void 0?(De.ua=d-2,Ce[s]=De):Ce[s].ia[d-2]=De,[]}),[]})},I:function(a,s,d){a=_e(a),pe([],[s],function(v){return v=v[0],o[a]=v.fromWireType(d),[]})},E:function(a,s){s=_e(s),at(a,{name:s,fromWireType:function(d){var v=hn(d);return Zn(d),v},toWireType:function(d,v){return pt(v)},argPackAdvance:8,readValueFromPointer:qe,ja:null})},h:function(a,s,d,v){function D(){}d=be(d),s=_e(s),D.values={},at(a,{name:s,constructor:D,fromWireType:function(B){return this.constructor.values[B]},toWireType:function(B,q){return q.value},argPackAdvance:8,readValueFromPointer:dr(s,d,v),ja:null}),ln(s,D)},k:function(a,s,d){var v=Mt(a,"enum");s=_e(s),a=v.constructor,v=Object.create(v.constructor.prototype,{value:{value:d},constructor:{value:G(v.name+"_"+s,function(){})}}),a.values[d]=v,a[s]=v},q:function(a,s,d){d=be(d),s=_e(s),at(a,{name:s,fromWireType:function(v){return v},toWireType:function(v,D){return D},argPackAdvance:8,readValueFromPointer:fr(s,d),ja:null})},f:function(a,s,d,v,D,B){var q=un(s,d);a=_e(a),D=Ye(v,D),ln(a,function(){At("Cannot call "+a+" due to unbound types",q)},s-1),pe([],q,function(V){return V=[V[0],null].concat(V.slice(1)),Kn(a,dn(a,V,null,D,B),s-1),[]})},e:function(a,s,d,v,D){s=_e(s),D===-1&&(D=4294967295),D=be(d);var B=V=>V;if(v===0){var q=32-8*d;B=V=>V<<q>>>q}d=s.includes("unsigned")?function(V,K){return K>>>0}:function(V,K){return K},at(a,{name:s,fromWireType:B,toWireType:d,argPackAdvance:8,readValueFromPointer:hr(s,D,v!==0),ja:null})},b:function(a,s,d){function v(B){B>>=2;var q=ue;return new D(Ae,q[B+1],q[B])}var D=[Int8Array,Uint8Array,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array][s];d=_e(d),at(a,{name:d,fromWireType:v,argPackAdvance:8,readValueFromPointer:v},{Qa:!0})},p:function(a,s){s=_e(s);var d=s==="std::string";at(a,{name:s,fromWireType:function(v){var D=ue[v>>2];if(d)for(var B=v+4,q=0;q<=D;++q){var V=v+4+q;if(q==D||Y[V]==0){if(B=B?E(Y,B,V-B):"",K===void 0)var K=B;else K+=String.fromCharCode(0),K+=B;B=V+1}}else{for(K=Array(D),q=0;q<D;++q)K[q]=String.fromCharCode(Y[v+4+q]);K=K.join("")}return ut(v),K},toWireType:function(v,D){D instanceof ArrayBuffer&&(D=new Uint8Array(D));var B=typeof D=="string";B||D instanceof Uint8Array||D instanceof Uint8ClampedArray||D instanceof Int8Array||ke("Cannot pass non-string to std::string");var q=(d&&B?()=>{for(var Q=0,ee=0;ee<D.length;++ee){var se=D.charCodeAt(ee);55296<=se&&57343>=se&&(se=65536+((se&1023)<<10)|D.charCodeAt(++ee)&1023),127>=se?++Q:Q=2047>=se?Q+2:65535>=se?Q+3:Q+4}return Q}:()=>D.length)(),V=yn(4+q+1);if(ue[V>>2]=q,d&&B)h(D,V+4,q+1);else if(B)for(B=0;B<q;++B){var K=D.charCodeAt(B);255<K&&(ut(V),ke("String has UTF-16 code units that do not fit in 8 bits")),Y[V+4+B]=K}else for(B=0;B<q;++B)Y[V+4+B]=D[B];return v!==null&&v.push(ut,V),V},argPackAdvance:8,readValueFromPointer:qe,ja:function(v){ut(v)}})},m:function(a,s,d){if(d=_e(d),s===2)var v=R,D=ae,B=ce,q=()=>ge,V=1;else s===4&&(v=le,D=J,B=Te,q=()=>ue,V=2);at(a,{name:d,fromWireType:function(K){for(var Q=ue[K>>2],ee=q(),se,Ce=K+4,Re=0;Re<=Q;++Re){var De=K+4+Re*s;(Re==Q||ee[De>>V]==0)&&(Ce=v(Ce,De-Ce),se===void 0?se=Ce:(se+=String.fromCharCode(0),se+=Ce),Ce=De+s)}return ut(K),se},toWireType:function(K,Q){typeof Q!="string"&&ke("Cannot pass non-string to C++ string type "+d);var ee=B(Q),se=yn(4+ee+s);return ue[se>>2]=ee>>V,D(Q,se+4,ee+s),K!==null&&K.push(ut,se),se},argPackAdvance:8,readValueFromPointer:qe,ja:function(K){ut(K)}})},t:function(a,s,d,v,D,B){Ie[a]={name:_e(s),sa:Ye(d,v),la:Ye(D,B),elements:[]}},s:function(a,s,d,v,D,B,q,V,K){Ie[a].elements.push({Aa:s,ya:Ye(d,v),za:D,Ea:B,Da:Ye(q,V),Fa:K})},v:function(a,s,d,v,D,B){Me[a]={name:_e(s),sa:Ye(d,v),la:Ye(D,B),Ha:[]}},j:function(a,s,d,v,D,B,q,V,K,Q){Me[a].Ha.push({Na:_e(s),Aa:d,ya:Ye(v,D),za:B,Ea:q,Da:Ye(V,K),Fa:Q})},G:function(a,s){s=_e(s),at(a,{Ra:!0,name:s,argPackAdvance:0,fromWireType:function(){},toWireType:function(){}})},d:function(a,s,d,v){a=mn[a],s=hn(s),d=gn(d),a(s,d,null,v)},J:Zn,x:function(a){return a===0?pt(Jn()):(a=gn(a),pt(Jn()[a]))},c:function(a,s){var d=mr(a,s),v=d[0];s=v.name+"_$"+d.slice(1).map(function(q){return q.name}).join("_")+"$";var D=Qn[s];if(D!==void 0)return D;var B=Array(a-1);return D=gr((q,V,K,Q)=>{for(var ee=0,se=0;se<a-1;++se)B[se]=d[se+1].readValueFromPointer(Q+ee),ee+=d[se+1].argPackAdvance;for(q=q[V].apply(q,B),se=0;se<a-1;++se)d[se+1].Ka&&d[se+1].Ka(B[se]);if(!v.Ra)return v.toWireType(K,q)}),Qn[s]=D},n:function(a){4<a&&(st[a].Ca+=1)},w:function(a,s,d,v){a=hn(a);var D=ei[s];return D||(D=yr(s),ei[s]=D),D(a,d,v)},K:function(){return pt([])},D:function(a){return pt(gn(a))},H:function(a,s){return a=Mt(a,"_emval_take_value"),a=a.readValueFromPointer(s),pt(a)},g:function(){he("")},B:function(a){var s=Y.length;if(a>>>=0,2147483648<a)return!1;for(var d=1;4>=d;d*=2){var v=s*(1+.2/d);v=Math.min(v,a+100663296),v=Math.max(a,v),0<v%65536&&(v+=65536-v%65536);e:{try{O.grow(Math.min(2147483648,v)-Ae.byteLength+65535>>>16),Ne();var D=1;break e}catch{}D=void 0}if(D)return!0}return!1},C:function(){return 0},y:function(){},o:function(a,s,d,v){for(var D=0,B=0;B<d;B++){var q=de[s>>2],V=de[s+4>>2];s+=8;for(var K=0;K<V;K++){var Q=Y[q+K],ee=vr[a];Q===0||Q===10?((a===1?X:H)(E(ee,0)),ee.length=0):ee.push(Q)}D+=V}return de[v>>2]=D,0},A:function(){}};(function(){function a(D){o.asm=D.exports,O=o.asm.L,Ne(),W=o.asm._,m.unshift(o.asm.M),U--,o.monitorRunDependencies&&o.monitorRunDependencies(U),U==0&&z&&(D=z,z=null,D())}function s(D){a(D.instance)}function d(D){return Xe().then(function(B){return WebAssembly.instantiate(B,v)}).then(function(B){return B}).then(D,function(B){H("failed to asynchronously prepare wasm: "+B),he(B)})}var v={a:Ir};if(U++,o.monitorRunDependencies&&o.monitorRunDependencies(U),o.instantiateWasm)try{return o.instantiateWasm(v,a)}catch(D){return H("Module.instantiateWasm callback failed with error: "+D),!1}return function(){return ie||typeof WebAssembly.instantiateStreaming!="function"||xe()||Ee.startsWith("file://")||typeof fetch!="function"?d(s):fetch(Ee,{credentials:"same-origin"}).then(function(D){return WebAssembly.instantiateStreaming(D,v).then(s,function(B){return H("wasm streaming compile failed: "+B),H("falling back to ArrayBuffer instantiation"),d(s)})})}().catch(p),{}})(),o.___wasm_call_ctors=function(){return(o.___wasm_call_ctors=o.asm.M).apply(null,arguments)},o.__Z6ToCmdsRK6SkPath=function(){return(o.__Z6ToCmdsRK6SkPath=o.asm.N).apply(null,arguments)},o.__Z8FromCmdsmi=function(){return(o.__Z8FromCmdsmi=o.asm.O).apply(null,arguments)},o.__Z7NewPathv=function(){return(o.__Z7NewPathv=o.asm.P).apply(null,arguments)},o.__Z8CopyPathRK6SkPath=function(){return(o.__Z8CopyPathRK6SkPath=o.asm.Q).apply(null,arguments)},o.__Z6EqualsRK6SkPathS1_=function(){return(o.__Z6EqualsRK6SkPathS1_=o.asm.R).apply(null,arguments)},o.__Z11ToSVGStringRK6SkPath=function(){return(o.__Z11ToSVGStringRK6SkPath=o.asm.S).apply(null,arguments)},o.__Z13FromSVGStringNSt3__212basic_stringIcNS_11char_traitsIcEENS_9allocatorIcEEEE=function(){return(o.__Z13FromSVGStringNSt3__212basic_stringIcNS_11char_traitsIcEENS_9allocatorIcEEEE=o.asm.T).apply(null,arguments)},o.__Z13ApplySimplifyR6SkPath=function(){return(o.__Z13ApplySimplifyR6SkPath=o.asm.U).apply(null,arguments)},o.__Z11ApplyPathOpR6SkPathRKS_8SkPathOp=function(){return(o.__Z11ApplyPathOpR6SkPathRKS_8SkPathOp=o.asm.V).apply(null,arguments)},o.__Z10MakeFromOpRK6SkPathS1_8SkPathOp=function(){return(o.__Z10MakeFromOpRK6SkPathS1_8SkPathOp=o.asm.W).apply(null,arguments)},o.__Z14ResolveBuilderR11SkOpBuilder=function(){return(o.__Z14ResolveBuilderR11SkOpBuilder=o.asm.X).apply(null,arguments)},o.__Z8ToCanvasRK6SkPathN10emscripten3valE=function(){return(o.__Z8ToCanvasRK6SkPathN10emscripten3valE=o.asm.Y).apply(null,arguments)},o.__Z8ToPath2DRK6SkPath=function(){return(o.__Z8ToPath2DRK6SkPath=o.asm.Z).apply(null,arguments)};var ut=o._free=function(){return(ut=o._free=o.asm.$).apply(null,arguments)},yn=o._malloc=function(){return(yn=o._malloc=o.asm.aa).apply(null,arguments)},ni=o.___getTypeName=function(){return(ni=o.___getTypeName=o.asm.ba).apply(null,arguments)};o.___embind_register_native_and_builtin_types=function(){return(o.___embind_register_native_and_builtin_types=o.asm.ca).apply(null,arguments)},o.dynCall_jiji=function(){return(o.dynCall_jiji=o.asm.da).apply(null,arguments)};var $t;z=function a(){$t||vn(),$t||(z=a)};function vn(){function a(){if(!$t&&($t=!0,o.calledRun=!0,!w)){if(Le(m),c(o),o.onRuntimeInitialized&&o.onRuntimeInitialized(),o.postRun)for(typeof o.postRun=="function"&&(o.postRun=[o.postRun]);o.postRun.length;){var s=o.postRun.shift();T.unshift(s)}Le(T)}}if(!(0<U)){if(o.preRun)for(typeof o.preRun=="function"&&(o.preRun=[o.preRun]);o.preRun.length;)j();Le(f),0<U||(o.setStatus?(o.setStatus("Running..."),setTimeout(function(){setTimeout(function(){o.setStatus("")},1),a()},1)):a())}}if(o.run=vn,o.preInit)for(typeof o.preInit=="function"&&(o.preInit=[o.preInit]);0<o.preInit.length;)o.preInit.pop()();return vn(),r.ready}})();i.exports=t})(Ui);var Uo=Ui.exports;const Go=Fn(Uo),jo="/assets/pathkit-1356ccfa.wasm";class kn{startTime;accumulatedTime;constructor(){this.startTime=-1,this.accumulatedTime=-1}start(){this.startTime=performance.now(),this.accumulatedTime=0}resume(){this.startTime=performance.now()}pause(){return this.accumulatedTime+=performance.now()-this.startTime,this.startTime=-1,this.accumulatedTime}stop(){if(this.startTime!=-1){const e=performance.now()-this.startTime+this.accumulatedTime;return this.accumulatedTime=0,e}else{const e=this.accumulatedTime;return this.accumulatedTime=0,e}}}class Wo{activated;constructor(e){this.activated=e}async BlueTokenBoundingPath(e){if(this.activated){const t=ft().strokeColor("#0000ff").locked(!0).fillOpacity(1).commands(e.toCmds()).metadata({[`${u.EXTENSIONID}/debug`]:!0}).build();await C.scene.local.addItems([t])}}async RedIntersectionPath(e){if(this.activated){const t=ft().fillRule("evenodd").locked(!0).strokeColor("#ff0000").fillOpacity(0).commands(e.toCmds()).metadata({[`${u.EXTENSIONID}/debug`]:!0}).build();await C.scene.local.addItems([t])}}async GreenDebugPath(e){if(this.activated){const t=ft().commands(e.toCmds()).locked(!0).visible(e.visible).fillColor("#555500").fillOpacity(.3).strokeColor("#00FF00").layer("DRAWING").metadata({[`${u.EXTENSIONID}/debug`]:!0}).build();await C.scene.local.addItems([t])}}async DebugBlobINeverUse(){this.activated}}const Bt=new Wo(!1);function Ft(i,e){return(i.x-e.x)*(i.x-e.x)+(i.y-e.y)*(i.y-e.y)}function Gi(i,e){return i.x==e.x&&i.y==e.y}function Xt(i,e,t){return t===void 0&&(t=.01),Math.abs(i-e)<=t}function xn(i,e){return(i%e+e)%e}function qo(i,e){return Ke.pointInPolygon(i[0],e)||Ke.pointInPolygon(i[0],e)?!0:Vt(i,[e[0],e[1]])||Vt(i,[e[1],e[2]])||Vt(i,[e[2],e[3]])||Vt(i,[e[3],e[0]])}function Vt(i,e){const t=(i[1].x-i[0].x)*(e[1].y-e[0].y)-(e[1].x-e[0].x)*(i[1].y-i[0].y),n=((e[1].y-e[0].y)*(e[1].x-i[0].x)+(e[0].x-e[1].x)*(e[1].y-i[0].y))/t,r=((i[0].y-i[1].y)*(e[1].x-i[0].x)+(i[1].x-i[0].x)*(e[1].y-i[0].y))/t;return n>=0&&n<=1&&r>=0&&r<=1}function Ht(i,e,t){return{x:i.x+e*Math.cos(t),y:i.y+e*Math.sin(t)}}function Ko(i,e,t,n){const r=Math.atan2(i.y-t.y,i.x-t.x);let o=Ht(i,e,r+Math.PI/2),l=Ht(i,e,r-Math.PI/2),c=Ht(t,n,r+Math.PI/2),p=Ht(t,n,r-Math.PI/2);const y=Ke.normalize(Ke.subtract(i,t));return o=Ke.add(o,Ke.multiply(y,e)),l=Ke.add(l,Ke.multiply(y,e)),c=Ke.add(c,Ke.multiply(y,0-n)),p=Ke.add(p,Ke.multiply(y,0-n)),[o,l,p,c]}function Yo(i){return i.filter(e=>e.points&&e.points.length>1).flatMap(e=>{const t=We.fromItem(e);return e.points.slice(0,-1).map((n,r)=>{const o=We.fromPosition(e.points[r]),l=We.fromPosition(e.points[r+1]),c=We.decompose(We.multiply(t,o)).position,p=We.decompose(We.multiply(t,l)).position;return{startPosition:c,endPosition:p,originalShape:e,oneSided:e.metadata[`${u.EXTENSIONID}/oneSided`]}})})}function zo(i,e,t,n,r,o){let l=[],c=[t,n];const p=[{x:(t+r[0])*o[0],y:r[1]*o[1]},{x:(t+r[0])*o[0],y:(n+r[1])*o[1]},{x:r[0]*o[0],y:(n+r[1])*o[1]},{x:r[0]*o[0],y:r[1]*o[1]}],y=I.gridDpi,N=u.EXTENSIONID,x=e.some(wt);if(e.length===0)return l;for(const P of e){const X=I.playerId===P.createdUserId,ie=I.sceneMetadata[`${u.EXTENSIONID}/USER-${P.createdUserId}`]?.role==="GM";if(!X&&I.playerRole!=="GM"&&!ie)continue;const O=P.metadata[`${N}/visionRange`],w=I.playerShadowCache.getValue(P.id);if(l.push([]),w!==void 0&&Gi(w.player.position,P.position)&&w.player.metadata[`${N}/visionRange`]===O)continue;let g=y*1e3;O&&(g=y*(O/I.gridScale+.5));const E=[];if(x&&!wt(P)){for(const h of e)if(wt(h)){const k=h.metadata[`${u.EXTENSIONID}/visionRange`];let R=1e3*I.gridDpi;k&&(R=I.gridDpi*(k/I.gridScale+.5));const ae=Ko(P.position,g,h.position,R);E.push(ae)}}for(const h of i){const k=(P.position.x-h.startPosition.x)*(h.endPosition.y-h.startPosition.y)-(P.position.y-h.startPosition.y)*(h.endPosition.x-h.startPosition.x);if(h.oneSided!==void 0&&(h.oneSided==="right"&&k>0||h.oneSided==="left"&&k<0))continue;let R=h.startPosition.x,ae=h.startPosition.y,ce=h.endPosition.x,le=h.endPosition.y;(R<r[0]||ae<r[1]||R>r[0]+c[0]||ae>r[1]+c[1]||ce<r[0]||le<r[1]||ce>r[0]+c[0]||le>r[1]+c[1])&&(R=Math.max(r[0],Math.min(R,r[0]+c[0])),ae=Math.max(r[1],Math.min(ae,r[1]+c[1])),h.startPosition=Si(h,r,c).startPosition,h.endPosition=Si(h,r,c).endPosition);const J=[h.startPosition,h.endPosition],Te=Ke.distance(h.startPosition,h.endPosition),we=Math.floor(Te/(g/3));for(let m=1;m<we;m++)J.push(Ke.lerp(h.startPosition,h.endPosition,m/we));let Y=!0;for(const m of J)if(Ke.compare(P.position,m,g*1.05)){Y=!1;break}if(Y&&x&&!wt(P)){for(const m of E)if(qo([h.startPosition,h.endPosition],m)){Y=!1;break}}if(Y)continue;const re={x:h.startPosition.x-P.position.x,y:h.startPosition.y-P.position.y},ge={x:h.endPosition.x-P.position.x,y:h.endPosition.y-P.position.y};var M={x:0,y:0},A={x:0,y:0},b=0,$=0,_=0,L=0;re.x<0?b=r[0]*o[0]:b=(t+r[0])*o[0],re.y<0?$=r[1]*o[1]:$=(n+r[1])*o[1],ge.x<0?_=r[0]*o[0]:_=(t+r[0])*o[0],ge.y<0?L=r[1]*o[1]:L=(n+r[1])*o[1];const de=[],ue=[];if(re.x!=0){const m=re.y/re.x,T=h.startPosition.y-m*h.startPosition.x;de.push({x:b,y:m*b+T})}if(re.y!=0){const m=re.x/re.y,T=m*h.startPosition.y-h.startPosition.x;de.push({x:m*$-T,y:$})}if(ge.x!=0){const m=ge.y/ge.x,T=h.endPosition.y-m*h.endPosition.x;ue.push({x:_,y:m*_+T})}if(ge.y!=0){const m=ge.x/ge.y,T=m*h.endPosition.y-h.endPosition.x;ue.push({x:m*L-T,y:L})}if(de.length===0||ue.length===0)continue;de.length==1||Ft(de[0],h.startPosition)<Ft(de[1],h.startPosition)?M=de[0]:M=de[1],ue.length==1||Ft(ue[0],h.endPosition)<Ft(ue[1],h.endPosition)?A=ue[0]:A=ue[1];const ye=[{x:h.startPosition.x,y:h.startPosition.y},M,A,{x:h.endPosition.x,y:h.endPosition.y}],ve=[0,0];let Ne=0;for(const m of[M,A])Xt(m.y,r[1]*o[1])?ve[Ne]=0:Xt(m.y,(n+r[1])*o[1])?ve[Ne]=2:Xt(m.x,r[0]*o[0])?ve[Ne]=3:Xt(m.x,(t+r[0])*o[0])&&(ve[Ne]=1),Ne++;let W=Math.sign(k);W=W==0?1:-W;const f=W==1?ve[1]:xn(ve[1]-1,4);for(let m=ve[0]+(W==1?0:-1);xn(m,4)!=f;m+=W)ye.splice(ye.length-2,0,p[xn(m,4)]);l[l.length-1].push({pointset:ye,fromShape:h.originalShape})}}return l}function Si(i,e,t){let{x:n,y:r}=i.startPosition,{x:o,y:l}=i.endPosition,c=(l-r)/(o-n),p=r-c*n,y=[];if(r<e[1]){let A=(e[1]-p)/c;A>=e[0]&&A<=e[0]+t[0]&&y.push({x:A,y:e[1]})}if(r>e[1]+t[1]){let A=(e[1]+t[1]-p)/c;A>=e[0]&&A<=e[0]+t[0]&&y.push({x:A,y:e[1]+t[1]})}if(n<e[0]){let A=c*e[0]+p;A>=e[1]&&A<=e[1]+t[1]&&y.push({x:e[0],y:A})}if(n>e[0]+t[0]){let A=c*(e[0]+t[0])+p;A>=e[1]&&A<=e[1]+t[1]&&y.push({x:e[0]+t[0],y:A})}y.sort((A,b)=>{let $=Math.sqrt((A.x-n)**2+(A.y-r)**2),_=Math.sqrt((b.x-n)**2+(b.y-r)**2);return $-_});let N=y.length>0?y[0]:{x:n,y:r},x=y.length>0?y[y.length-1]:{x:o,y:l};return{startPosition:N,endPosition:x}}let Be;async function Et(i){if(await C.action.setBadgeText("⏱️"),await C.player.setMetadata({[`${u.EXTENSIONID}/processed`]:!1}),Be||(Be=await Go({locateFile:()=>jo})),!I.sceneReady||!I.sceneInitialized){I.playerShadowCache.invalidate(),I.busy=!1,await C.action.setBadgeText(void 0);return}if(I.busy)return;I.busy=!0;const[e,t]=[new kn,new kn];e.start(),e.pause(),t.start();const n=I.sceneItems.filter(Y=>Ni(Y)&&(!wt(Y)||Y.visible===!0)),r=I.sceneItems.filter(gs),o=I.sceneItems.filter(Oi),l=I.sceneItems.filter(Qi)?.[0],c=I.sceneMetadata[`${u.EXTENSIONID}/visionEnabled`]===!0,p=I.sceneMetadata[`${u.EXTENSIONID}/persistenceEnabled`]===!0,y=I.sceneMetadata[`${u.EXTENSIONID}/autodetectEnabled`]===!0,N=I.sceneMetadata[`${u.EXTENSIONID}/fowEnabled`]===!0,x=I.sceneMetadata[`${u.EXTENSIONID}/fowColor`],M=I.sceneMetadata[`${u.EXTENSIONID}/playerDoors`]===!0;let A=[],b=[],$=[],_=!1,L=[];if(l===void 0?(A[0]=0,A[1]=0,b[0]=1,b[1]=1,$[0]=0,$[1]=0):(A[0]=l.width*l.scale.x,A[1]=l.height*l.scale.y,b[0]=l.scale.x,b[1]=l.scale.y,$[0]=l.position.x,$[1]=l.position.y),I.playerRole==="GM"){L=n;const Y=document.getElementById("mapHeight"),re=document.getElementById("mapWidth");re&&(re.value=(Math.round(A[0])/I.gridDpi).toString()),Y&&(Y.value=(Math.round(A[1])/I.gridDpi).toString())}else{L=n.filter(ms);for(const Y of n)Ni(Y)&&I.sceneMetadata[`${u.EXTENSIONID}/USER-${Y.createdUserId}`]?.role==="GM"&&L.push(Y)}const P=JSON.stringify(r),X=JSON.stringify(o),H=JSON.stringify(L),ie=JSON.stringify(l);if(I.previousMap===ie&&I.previousVisionEnabled===c&&I.previousFowColor===x&&I.previousAutodetectEnabled===y&&I.previousFowEnabled===N&&I.previousPersistenceEnabled===p&&I.previousVisionShapes===P&&I.previousAutohideItems===X&&I.previousPlayersWithVision===H&&I.previousSize[0]===A[0]&&I.previousSize[1]===A[1]&&i!==!0){I.busy=!1,await C.action.setBadgeText(void 0);return}(ie!=I.previousMap||I.previousVisionShapes!=P||A[0]!=I.previousSize[0]||A[1]!=I.previousSize[1])&&(_=!0),I.previousMap=ie,I.previousPlayersWithVision=H,I.previousVisionShapes=P,I.previousSize=A,I.previousVisionEnabled=c,I.previousAutodetectEnabled=y,I.previousFowEnabled=N,I.previousFowColor=x,I.previousPersistenceEnabled=p,t.pause();const O=[];for(let Y=0;Y<=6;Y++)O.push(new kn);O[1].start();let[w,g]=A;if(y){const Y=I.sceneItems.filter(ge=>ge.layer==="MAP"&&Yt(ge));if(Y.length===0){I.busy=!1,await C.action.setBadgeText(void 0);return}let re=[];for(let ge of Y){let de=I.gridDpi/ge.grid.dpi,ue=ge.position.x-de*ge.grid.offset.x*ge.scale.x,ye=ge.position.y-de*ge.grid.offset.y*ge.scale.y,ve=ue+de*ge.image.width*ge.scale.x,Ne=ye+de*ge.image.height*ge.scale.y;if(ge.rotation>0){const W=Math.abs(ve-ue),f=Math.abs(Ne-ye);switch(ge.rotation){case 270:ye-=f,Ne-=f;break;case 180:ye-=f,Ne-=f,ue-=W,ve-=W;break;case 90:ue-=W,ve-=W;break}}re.length?(ue<re[0]&&(re[0]=ue),ye<re[1]&&(re[1]=ye),ve>re[2]&&(re[2]=ve),Ne>re[3]&&(re[3]=Ne)):(re[0]=ue,re[1]=ye,re[2]=ve,re[3]=Ne)}$=[re[0],re[1]],A=[re[2]-re[0],re[3]-re[1]],b=[1,1],[w,g]=A}let E=0,h=0;if(_&&I.playerShadowCache.invalidate(),t.resume(),!(I.sceneMetadata[`${u.EXTENSIONID}/visionEnabled`]===!0)||L.length==0){const Y=I.sceneLocal.filter(re=>Bn(re));await C.scene.local.deleteItems(Y.map(re=>re.id)),I.busy=!1,await C.action.setBadgeText(void 0);return}const R=Yo(r),ae=zo(R,L,w,g,$,b);if(ae.length==0){I.busy=!1,await C.action.setBadgeText(void 0);return}const ce=[];O[1].pause(),O[2].start();const le={};let J=0;await Te();async function Te(){const Y=L[J];let re=I.playerShadowCache.getValue(Y.id);if(re!==void 0&&Gi(re.player.position,Y.position)&&re.player.metadata[`${u.EXTENSIONID}/visionRange`]===Y.metadata[`${u.EXTENSIONID}/visionRange`]){const ve=Be.FromCmds(re.shadowPath);if(le[J]=ve,E++,J===L.length-1){await Ae(O);return}else{J++,await Te();return}}h++;const ge=ae[J];let de=new Be.SkOpBuilder;const ue=Be.NewPath().rect($[0],$[1],A[0],A[1]);de.add(ue,Be.PathOp.UNION),ue.delete(),await ye(ge);function ye(ve){const Ne=Math.ceil(ve.length/I.workers.length);let W=0,f=0,m={};for(let T=0;T<I.workers.length;T++){const j=W+Ne,U=ve.slice(W,j+10);I.workers[T].onmessage=async function(z){if(z.data){const{numb:he,messageData:xe}=z.data;if(f++,m[he]=xe,f===I.workers.length){for(let Fe=0;Fe<I.workers.length;Fe++){const Xe=Be.FromCmds(m[Fe]);de.add(Xe,Be.PathOp.INTERSECT),Xe.delete()}let Ee=de.resolve();if(Ee.simplify(),!Ee){console.error("Couldn't compute fog"),I.busy=!1,await C.action.setBadgeText(void 0);return}le[J]=Ee,re!==void 0&&(re.shadowPath="");const He=Ee.toCmds();I.playerShadowCache.cacheValue(Y.id,{shadowPath:He,player:Y}),de.delete(),J===L.length-1?await Ae(O):(J++,await Te())}}},I.workers[T].postMessage({numb:T,polygons:U,mapOffset:$,mapSize:A}),W=j}}}async function Ae(Y){Y[2].pause(),Y[3].start();const re=[],ge=Be.NewPath();for(let te=0;te<L.length;te++){const me=L[te],S=me.metadata[`${u.EXTENSIONID}/visionRange`],F=I.playerId===L[te].createdUserId,ne=I.sceneMetadata[`${u.EXTENSIONID}/USER-${L[te].createdUserId}`]?.role==="GM";if(wt(me)?re[te]=!0:ge.op(le[te],Be.PathOp.UNION),S){if(!F&&I.playerRole!=="GM"&&!ne)continue;const oe=I.gridDpi*(S/I.gridScale+.5),fe=Be.NewPath().ellipse(me.position.x,me.position.y,oe,oe,0,0,2*Math.PI);le[te]?.op(fe,Be.PathOp.INTERSECT),fe.delete();const pe=I.sceneMetadata[`${u.EXTENSIONID}/USER-${me.createdUserId}`];if(pe&&I.playerRole==="GM"&&!wt(me)&&pe.role!=="GM"){const Me=Ci().strokeColor(pe.color).fillOpacity(0).position({x:me.position.x,y:me.position.y}).width(oe*2).height(oe*2).shapeType("CIRCLE").metadata({[`${u.EXTENSIONID}/isIndicatorRing`]:!0}).locked(!0).build();ce.push(Me)}}}ge.simplify();for(let te=0;te<re.length;te++)re[te]===!0&&(le[te].op(ge,Be.PathOp.INTERSECT),le[te].simplify());ge.delete(),Y[3].pause(),Y[4].start();const de=[],ue=[];let ye=[],ve=[];const Ne=Be.NewPath(),W={},f=I.sceneLocal.filter(te=>Bn(te)),m=I.sceneLocal.filter(te=>ps(te));N&&Ne.rect($[0],$[1],A[0],A[1]);let T=[],j,U=null;if(p)if(T=f.filter(te=>_t(te)),j=new Be.SkOpBuilder,W.reuse=!0,T.length===0){const te=ft().commands([]).fillRule("evenodd").locked(!0).visible(!1).fillColor("#000000").strokeColor("#000000").layer("FOG").name("Fog of War").metadata({[`${u.EXTENSIONID}/isVisionFog`]:!0,[`${u.EXTENSIONID}/digest`]:"reuse"}).build();te.zIndex=3,ve.push(te),T=[te]}else U=Be.FromCmds(T[0].commands),U.setFillType(Be.FillType.EVENODD);const z=new Be.SkOpBuilder;let he=!1;for(const te of Object.keys(le)){const me=le[te],F=new TextEncoder().encode(me.toCmds().toString()),G=await crypto.subtle.digest("SHA-1",F).then(oe=>[...new Uint8Array(oe)].map(fe=>fe.toString(16).padStart(2,"0")).join(""));if(f.filter(oe=>_t(oe)&&oe.metadata[`${u.EXTENSIONID}/digest`]===G).length===0?p?j.add(me,Be.PathOp.UNION):de.push({cmds:me.toCmds(),visible:!1,zIndex:3,playerId:L[te].id,digest:G}):W[G]=!0,N){const oe=I.sceneLocal.filter(fe=>fe.metadata[`${u.EXTENSIONID}/debug`]===!0).map(fe=>fe.id);oe.length>0&&(ye=ye.concat(oe)),await Bt.GreenDebugPath(me),Ne.op(me,Be.PathOp.DIFFERENCE),I.playerRole==="GM"&&(he=!0,z.add(me,Be.PathOp.UNION))}me.delete()}const xe=I.sceneMetadata[`${u.EXTENSIONID}/sceneId`];if(p){const te=j.resolve();te.setFillType(Be.FillType.EVENODD),U!==null&&te.op(U,Be.PathOp.UNION);const me=te.toCmds();T.length>0&&(T[0].commands=me,ve=ve.concat(T));try{localStorage.setItem(`${u.EXTENSIONID}/fogCache/${I.playerId}/${xe}`,JSON.stringify([{digest:"reuse",commands:me}]))}catch{console.log("Local storage is disabled")}U!==null&&U.delete(),te.delete(),j.delete()}else if(p){const te=f.filter(_t);try{localStorage.setItem(`${u.EXTENSIONID}/fogCache/${I.playerId}/${xe}`,JSON.stringify(te.map(me=>({digest:me.metadata[`${u.EXTENSIONID}/digest`],commands:me.commands}))))}catch{console.log("Local storage is disabled")}}let Ee;he&&(Ee=z.resolve()),z.delete();const He=f.filter(Kt),Fe=f.filter(te=>{const me=te.metadata[`${u.EXTENSIONID}/digest`];return _t(te)&&W[me]===void 0});if(N){let te=I.sceneMetadata[`${u.EXTENSIONID}/fowColor`]?I.sceneMetadata[`${u.EXTENSIONID}/fowColor`]:"#00000088",me=.5;te.length==9&&(me=Number.parseInt(te.substring(7),16)/255,te=te.substring(0,7));const S=ft().commands(Ne.toCmds()).locked(!0).fillRule("evenodd").visible(!0).fillColor(te).fillOpacity(me).strokeWidth(0).strokeColor("#000000").layer("DRAWING").metadata({[`${u.EXTENSIONID}/isTrailingFog`]:!0}).name("Trailing Fog").build();S.disableHit=!0,He.length>0?ue.push(C.scene.local.updateItems(Kt,F=>{for(const G of F)G.commands=S.commands},!1)):ve.push(S)}else ye=ye.concat(f.filter(Kt).map(te=>te.id));Ne.delete(),Y[4].pause(),Y[5].start();const Xe=I.sceneLocal.filter(te=>te.metadata[`${u.EXTENSIONID}/doorId`]!==void 0);M||I.playerRole=="GM"?await Pr():Xe.length>0&&(ye=ye.concat(Xe.map(te=>te.id)));for(const te of Xe){const me=te.metadata[`${u.EXTENSIONID}/doorId`],S=I.sceneItems.find(F=>F.id===me);if(S){const F=te.commands.length==u.DOOROPEN.length,G=!!S.metadata[`${u.EXTENSIONID}/doorOpen`];if(F===G)continue;ue.push(C.scene.local.updateItems([te.id],ne=>{const oe=ne[0];Sr(oe)&&(oe.commands=Di(G))}))}}t.pause(),e.resume(),await Bt.DebugBlobINeverUse(),ye=ye.concat(m.map(te=>te.id)),de.map(te=>{const me=ft().commands(te.cmds).fillRule("evenodd").locked(!0).visible(te.visible).fillColor("#000000").strokeColor("#000000").layer("FOG").name("Fog of War").metadata({[`${u.EXTENSIONID}/isVisionFog`]:!0,[`${u.EXTENSIONID}/digest`]:te.digest}).build();me.zIndex=te.zIndex,ve.push(me)}),p||(ye=ye.concat(Fe.map(te=>te.id))),ce.length>0&&(ve=ve.concat(ce)),I.fogFilled||await C.scene.fog.setFilled(!0),await Promise.all(ue),await C.scene.local.deleteItems(ye),await C.scene.local.addItems(ve);let Le=0;Y[5].pause(),Y[6].start(),he&&(await we(Ee,ue),Ee.delete()),Y[6].pause();const[Ie,Oe]=[e.stop(),t.stop()],qe={compute_time:`${Oe} ms`,communication_time:`${Ie} ms`,cache_hits:E.toString(),cache_misses:h.toString(),item_counter:Le.toString()};for(let te=1;te<=6;te++){const me=Y[te].stop();qe["stage"+te]=`${me} ms`}Zo(qe),I.busy=!1,await C.player.setMetadata({[`${u.EXTENSIONID}/processed`]:!0}),await C.action.setBadgeText(void 0)}async function we(Y,re){const ge=[],de=I.sceneItems.filter(ue=>Oi(ue)&&Yt(ue));Y.simplify();for(const ue of de){const ye=new Be.SkOpBuilder,ve=Be.NewPath(),Ne=I.gridDpi/ue.grid.dpi*(ue.image.width/2)*ue.scale.x;for(let m=0;m<6;m++){const T=m*60*Math.PI/180,j=ue.position.x+Ne*Math.cos(T),U=ue.position.y+Ne*Math.sin(T);m==0?ve.moveTo(j,U):ve.lineTo(j,U)}ve.closePath(),await Bt.BlueTokenBoundingPath(ve),ye.add(ve,Be.PathOp.UNION),ye.add(Y,Be.PathOp.INTERSECT);const W=ye.resolve(),f=!W.toCmds().length;ue.visible==f&&ge.push(ue),await Bt.RedIntersectionPath(W),ve.delete(),ye.delete(),W.delete()}re.push(C.scene.items.updateItems(ge.map(ue=>ue.id),ue=>{for(let ye=0;ye<ue.length;ye++)ue[ye].visible=!ue[ye].visible}))}}function Zo(i){for(const[e,t]of Object.entries(i)){const n=document.getElementById(e);e=="compute_time"||e=="communication_time"||e[0]=="s"?n&&(n.innerText=Number.parseFloat(t).toFixed(1)+"ms"):n&&(n.innerText=t)}}function rn(i){if(i.ctrlKey)return i.pointerPosition;const e=Math.round(I.gridDpi/I.gridSnap),t=Math.round(i.pointerPosition.x/I.gridDpi)*I.gridDpi,n=Math.round(i.pointerPosition.y/I.gridDpi)*I.gridDpi,r=Math.abs(t-i.pointerPosition.x),o=Math.abs(n-i.pointerPosition.y);let l,c;return r<=e?l=t:l=i.pointerPosition.x,o<=e?c=n:c=i.pointerPosition.y,{x:l,y:c}}let rt=null;const Jo="#000000",Qo=8,es=[];async function ji(){await C.popover.close(u.LINETOOLID),await C.player.setMetadata({[`${u.EXTENSIONID}/finishLine`]:!1})}async function Wi(){if(!rt)return;const[i,e]=rt;e(),rt=null,await ji(),await C.player.setMetadata({[`${u.EXTENSIONID}/cancelLine`]:!1})}async function qi(){if(!rt)return;const[i,e]=rt,t=i(n=>{n.visible=!1,n.metadata[`${u.EXTENSIONID}/isVisionLine`]=!0,n.points.pop()});t.points.length>=2&&await C.scene.items.addItems([t]),e(),rt=null,await ji(),await C.player.setMetadata({[`${u.EXTENSIONID}/finishLine`]:!1})}async function ts(i,e){if(!e.transformer)if(rt){const[t]=rt;t(n=>{n.points.push(e.pointerPosition)})}else{const t=rn(e),n=I.snap?t:e.pointerPosition,r=mt().tension(0).points([n,n]).strokeColor(I.sceneMetadata[`${u.EXTENSIONID}/toolColor`]??Jo).strokeDash(I.sceneMetadata[`${u.EXTENSIONID}/toolStyle`]??es).strokeWidth(I.sceneMetadata[`${u.EXTENSIONID}/toolWidth`]??Qo).fillOpacity(0).fillColor("#000000").layer("DRAWING").name("Vision Line (Line)").closed(!1).locked(!0).build();rt=await C.interaction.startItemInteraction(r),await C.popover.open({id:u.LINETOOLID,url:"/pages/line.html",height:70,width:350,disableClickAway:!0})}}function ns(i,e){if(!rt||e.transformer)return;const[t]=rt,n=rn(e);t(r=>{r.points[r.points.length-1]=I.snap?n:e.pointerPosition})}function is(i,e){rt&&(e.key=="Escape"?Wi():e.key=="Enter"&&qi())}const _n={onToolClick:ts,onToolMove:ns,onKeyDown:is};let ot=null;const rs="#000000",os=8,ss=[];async function Ki(){await C.popover.close(u.POLYTOOLID)}async function Yi(){if(!ot)return;const[i,e]=ot;e(),ot=null,Ki(),await C.player.setMetadata({[`${u.EXTENSIONID}/cancelPoly`]:!1})}async function zi(){if(!ot)return;const[i,e]=ot,t=i(n=>{n.visible=!1,n.metadata[`${u.EXTENSIONID}/isVisionLine`]=!0,n.points.pop(),n.points.push(n.points[0])});t.points.length>=4&&await C.scene.items.addItems([t]),e(),ot=null,Ki(),await C.player.setMetadata({[`${u.EXTENSIONID}/finishPoly`]:!1})}async function as(i,e){if(!e.transformer)if(ot){const[t]=ot;t(n=>{n.points.push(e.pointerPosition)})}else{const t=rn(e),n=I.snap?t:e.pointerPosition,r=mt().tension(0).points([n,n]).strokeColor(I.sceneMetadata[`${u.EXTENSIONID}/toolColor`]??rs).strokeDash(I.sceneMetadata[`${u.EXTENSIONID}/toolStyle`]??ss).strokeWidth(I.sceneMetadata[`${u.EXTENSIONID}/toolWidth`]??os).fillOpacity(.5).fillColor("#000000").layer("DRAWING").name("Vision Line (Polygon)").locked(!0).build();ot=await C.interaction.startItemInteraction(r),await C.popover.open({id:u.POLYTOOLID,url:"/pages/polygon.html",height:70,width:350,disableClickAway:!0})}}function ls(i,e){if(!ot||e.transformer)return;const[t]=ot,n=rn(e);t(r=>{r.points[r.points.length-1]=I.snap?n:e.pointerPosition})}function cs(i,e){ot&&(e.key=="Escape"?Yi():e.key=="Enter"&&zi())}const Cn={onToolClick:as,onToolMove:ls,onKeyDown:cs};function Ut(i){throw new Error('Could not dynamically require "'+i+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var Zi={exports:{}};(function(i,e){(function(t){i.exports=t()})(function(){return function t(n,r,o){function l(y,N){if(!r[y]){if(!n[y]){var x=typeof Ut=="function"&&Ut;if(!N&&x)return x(y,!0);if(c)return c(y,!0);throw new Error("Cannot find module '"+y+"'")}N=r[y]={exports:{}},n[y][0].call(N.exports,function(M){var A=n[y][1][M];return l(A||M)},N,N.exports,t,n,r,o)}return r[y].exports}for(var c=typeof Ut=="function"&&Ut,p=0;p<o.length;p++)l(o[p]);return l}({1:[function(t,n,r){(function(o,l,c,p,y,N,x,M,A){var b=t("crypto");function $(O,w){w=P(O,w);var g;return(g=w.algorithm!=="passthrough"?b.createHash(w.algorithm):new ie).write===void 0&&(g.write=g.update,g.end=g.update),H(w,g).dispatch(O),g.update||g.end(""),g.digest?g.digest(w.encoding==="buffer"?void 0:w.encoding):(O=g.read(),w.encoding!=="buffer"?O.toString(w.encoding):O)}(r=n.exports=$).sha1=function(O){return $(O)},r.keys=function(O){return $(O,{excludeValues:!0,algorithm:"sha1",encoding:"hex"})},r.MD5=function(O){return $(O,{algorithm:"md5",encoding:"hex"})},r.keysMD5=function(O){return $(O,{algorithm:"md5",encoding:"hex",excludeValues:!0})};var _=b.getHashes?b.getHashes().slice():["sha1","md5"],L=(_.push("passthrough"),["buffer","hex","binary","base64"]);function P(O,w){var g={};if(g.algorithm=(w=w||{}).algorithm||"sha1",g.encoding=w.encoding||"hex",g.excludeValues=!!w.excludeValues,g.algorithm=g.algorithm.toLowerCase(),g.encoding=g.encoding.toLowerCase(),g.ignoreUnknown=w.ignoreUnknown===!0,g.respectType=w.respectType!==!1,g.respectFunctionNames=w.respectFunctionNames!==!1,g.respectFunctionProperties=w.respectFunctionProperties!==!1,g.unorderedArrays=w.unorderedArrays===!0,g.unorderedSets=w.unorderedSets!==!1,g.unorderedObjects=w.unorderedObjects!==!1,g.replacer=w.replacer||void 0,g.excludeKeys=w.excludeKeys||void 0,O===void 0)throw new Error("Object argument required.");for(var E=0;E<_.length;++E)_[E].toLowerCase()===g.algorithm.toLowerCase()&&(g.algorithm=_[E]);if(_.indexOf(g.algorithm)===-1)throw new Error('Algorithm "'+g.algorithm+'"  not supported. supported values: '+_.join(", "));if(L.indexOf(g.encoding)===-1&&g.algorithm!=="passthrough")throw new Error('Encoding "'+g.encoding+'"  not supported. supported values: '+L.join(", "));return g}function X(O){if(typeof O=="function")return/^function\s+\w*\s*\(\s*\)\s*{\s+\[native code\]\s+}$/i.exec(Function.prototype.toString.call(O))!=null}function H(O,w,g){g=g||[];function E(h){return w.update?w.update(h,"utf8"):w.write(h,"utf8")}return{dispatch:function(h){return this["_"+((h=O.replacer?O.replacer(h):h)===null?"null":typeof h)](h)},_object:function(h){var k,R=Object.prototype.toString.call(h),ae=/\[object (.*)\]/i.exec(R);if(ae=(ae=ae?ae[1]:"unknown:["+R+"]").toLowerCase(),0<=(R=g.indexOf(h)))return this.dispatch("[CIRCULAR:"+R+"]");if(g.push(h),c!==void 0&&c.isBuffer&&c.isBuffer(h))return E("buffer:"),E(h);if(ae==="object"||ae==="function"||ae==="asyncfunction")return R=Object.keys(h),O.unorderedObjects&&(R=R.sort()),O.respectType===!1||X(h)||R.splice(0,0,"prototype","__proto__","constructor"),O.excludeKeys&&(R=R.filter(function(ce){return!O.excludeKeys(ce)})),E("object:"+R.length+":"),k=this,R.forEach(function(ce){k.dispatch(ce),E(":"),O.excludeValues||k.dispatch(h[ce]),E(",")});if(!this["_"+ae]){if(O.ignoreUnknown)return E("["+ae+"]");throw new Error('Unknown object type "'+ae+'"')}this["_"+ae](h)},_array:function(h,ce){ce=ce!==void 0?ce:O.unorderedArrays!==!1;var R=this;if(E("array:"+h.length+":"),!ce||h.length<=1)return h.forEach(function(le){return R.dispatch(le)});var ae=[],ce=h.map(function(le){var J=new ie,Te=g.slice();return H(O,J,Te).dispatch(le),ae=ae.concat(Te.slice(g.length)),J.read().toString()});return g=g.concat(ae),ce.sort(),this._array(ce,!1)},_date:function(h){return E("date:"+h.toJSON())},_symbol:function(h){return E("symbol:"+h.toString())},_error:function(h){return E("error:"+h.toString())},_boolean:function(h){return E("bool:"+h.toString())},_string:function(h){E("string:"+h.length+":"),E(h.toString())},_function:function(h){E("fn:"),X(h)?this.dispatch("[native]"):this.dispatch(h.toString()),O.respectFunctionNames!==!1&&this.dispatch("function-name:"+String(h.name)),O.respectFunctionProperties&&this._object(h)},_number:function(h){return E("number:"+h.toString())},_xml:function(h){return E("xml:"+h.toString())},_null:function(){return E("Null")},_undefined:function(){return E("Undefined")},_regexp:function(h){return E("regex:"+h.toString())},_uint8array:function(h){return E("uint8array:"),this.dispatch(Array.prototype.slice.call(h))},_uint8clampedarray:function(h){return E("uint8clampedarray:"),this.dispatch(Array.prototype.slice.call(h))},_int8array:function(h){return E("int8array:"),this.dispatch(Array.prototype.slice.call(h))},_uint16array:function(h){return E("uint16array:"),this.dispatch(Array.prototype.slice.call(h))},_int16array:function(h){return E("int16array:"),this.dispatch(Array.prototype.slice.call(h))},_uint32array:function(h){return E("uint32array:"),this.dispatch(Array.prototype.slice.call(h))},_int32array:function(h){return E("int32array:"),this.dispatch(Array.prototype.slice.call(h))},_float32array:function(h){return E("float32array:"),this.dispatch(Array.prototype.slice.call(h))},_float64array:function(h){return E("float64array:"),this.dispatch(Array.prototype.slice.call(h))},_arraybuffer:function(h){return E("arraybuffer:"),this.dispatch(new Uint8Array(h))},_url:function(h){return E("url:"+h.toString())},_map:function(h){return E("map:"),h=Array.from(h),this._array(h,O.unorderedSets!==!1)},_set:function(h){return E("set:"),h=Array.from(h),this._array(h,O.unorderedSets!==!1)},_file:function(h){return E("file:"),this.dispatch([h.name,h.size,h.type,h.lastModfied])},_blob:function(){if(O.ignoreUnknown)return E("[blob]");throw Error(`Hashing Blob objects is currently not supported
(see https://github.com/puleos/object-hash/issues/26)
Use "options.replacer" or "options.ignoreUnknown"
`)},_domwindow:function(){return E("domwindow")},_bigint:function(h){return E("bigint:"+h.toString())},_process:function(){return E("process")},_timer:function(){return E("timer")},_pipe:function(){return E("pipe")},_tcp:function(){return E("tcp")},_udp:function(){return E("udp")},_tty:function(){return E("tty")},_statwatcher:function(){return E("statwatcher")},_securecontext:function(){return E("securecontext")},_connection:function(){return E("connection")},_zlib:function(){return E("zlib")},_context:function(){return E("context")},_nodescript:function(){return E("nodescript")},_httpparser:function(){return E("httpparser")},_dataview:function(){return E("dataview")},_signal:function(){return E("signal")},_fsevent:function(){return E("fsevent")},_tlswrap:function(){return E("tlswrap")}}}function ie(){return{buf:"",write:function(O){this.buf+=O},end:function(O){this.buf+=O},read:function(){return this.buf}}}r.writeToStream=function(O,w,g){return g===void 0&&(g=w,w={}),H(w=P(O,w),g).dispatch(O)}}).call(this,t("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},t("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/fake_9a5aa49d.js","/")},{buffer:3,crypto:5,lYpoI2:11}],2:[function(t,n,r){(function(o,l,c,p,y,N,x,M,A){(function(b){var $=typeof Uint8Array<"u"?Uint8Array:Array,_="+".charCodeAt(0),L="/".charCodeAt(0),P="0".charCodeAt(0),X="a".charCodeAt(0),H="A".charCodeAt(0),ie="-".charCodeAt(0),O="_".charCodeAt(0);function w(g){return g=g.charCodeAt(0),g===_||g===ie?62:g===L||g===O?63:g<P?-1:g<P+10?g-P+26+26:g<H+26?g-H:g<X+26?g-X+26:void 0}b.toByteArray=function(g){var E,h;if(0<g.length%4)throw new Error("Invalid string. Length must be a multiple of 4");var k=g.length,k=g.charAt(k-2)==="="?2:g.charAt(k-1)==="="?1:0,R=new $(3*g.length/4-k),ae=0<k?g.length-4:g.length,ce=0;function le(J){R[ce++]=J}for(E=0;E<ae;E+=4,0)le((16711680&(h=w(g.charAt(E))<<18|w(g.charAt(E+1))<<12|w(g.charAt(E+2))<<6|w(g.charAt(E+3))))>>16),le((65280&h)>>8),le(255&h);return k==2?le(255&(h=w(g.charAt(E))<<2|w(g.charAt(E+1))>>4)):k==1&&(le((h=w(g.charAt(E))<<10|w(g.charAt(E+1))<<4|w(g.charAt(E+2))>>2)>>8&255),le(255&h)),R},b.fromByteArray=function(g){var E,h,k,R,ae=g.length%3,ce="";function le(J){return"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(J)}for(E=0,k=g.length-ae;E<k;E+=3)h=(g[E]<<16)+(g[E+1]<<8)+g[E+2],ce+=le((R=h)>>18&63)+le(R>>12&63)+le(R>>6&63)+le(63&R);switch(ae){case 1:ce=(ce+=le((h=g[g.length-1])>>2))+le(h<<4&63)+"==";break;case 2:ce=(ce=(ce+=le((h=(g[g.length-2]<<8)+g[g.length-1])>>10))+le(h>>4&63))+le(h<<2&63)+"="}return ce}})(r===void 0?this.base64js={}:r)}).call(this,t("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},t("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/base64-js/lib/b64.js","/node_modules/gulp-browserify/node_modules/base64-js/lib")},{buffer:3,lYpoI2:11}],3:[function(t,n,r){(function(o,l,_,p,y,N,x,M,A){var b=t("base64-js"),$=t("ieee754");function _(f,m,T){if(!(this instanceof _))return new _(f,m,T);var j,U,z,he,xe=typeof f;if(m==="base64"&&xe=="string")for(f=(he=f).trim?he.trim():he.replace(/^\s+|\s+$/g,"");f.length%4!=0;)f+="=";if(xe=="number")j=Ae(f);else if(xe=="string")j=_.byteLength(f,m);else{if(xe!="object")throw new Error("First argument needs to be a number, array or string.");j=Ae(f.length)}if(_._useTypedArrays?U=_._augment(new Uint8Array(j)):((U=this).length=j,U._isBuffer=!0),_._useTypedArrays&&typeof f.byteLength=="number")U._set(f);else if(we(he=f)||_.isBuffer(he)||he&&typeof he=="object"&&typeof he.length=="number")for(z=0;z<j;z++)_.isBuffer(f)?U[z]=f.readUInt8(z):U[z]=f[z];else if(xe=="string")U.write(f,0,m);else if(xe=="number"&&!_._useTypedArrays&&!T)for(z=0;z<j;z++)U[z]=0;return U}function L(f,m,T,j){return _._charsWritten=de(function(U){for(var z=[],he=0;he<U.length;he++)z.push(255&U.charCodeAt(he));return z}(m),f,T,j)}function P(f,m,T,j){return _._charsWritten=de(function(U){for(var z,he,xe=[],Ee=0;Ee<U.length;Ee++)he=U.charCodeAt(Ee),z=he>>8,he=he%256,xe.push(he),xe.push(z);return xe}(m),f,T,j)}function X(f,m,T){var j="";T=Math.min(f.length,T);for(var U=m;U<T;U++)j+=String.fromCharCode(f[U]);return j}function H(f,m,T,z){z||(W(typeof T=="boolean","missing or invalid endian"),W(m!=null,"missing offset"),W(m+1<f.length,"Trying to read beyond buffer length"));var U,z=f.length;if(!(z<=m))return T?(U=f[m],m+1<z&&(U|=f[m+1]<<8)):(U=f[m]<<8,m+1<z&&(U|=f[m+1])),U}function ie(f,m,T,z){z||(W(typeof T=="boolean","missing or invalid endian"),W(m!=null,"missing offset"),W(m+3<f.length,"Trying to read beyond buffer length"));var U,z=f.length;if(!(z<=m))return T?(m+2<z&&(U=f[m+2]<<16),m+1<z&&(U|=f[m+1]<<8),U|=f[m],m+3<z&&(U+=f[m+3]<<24>>>0)):(m+1<z&&(U=f[m+1]<<16),m+2<z&&(U|=f[m+2]<<8),m+3<z&&(U|=f[m+3]),U+=f[m]<<24>>>0),U}function O(f,m,T,j){if(j||(W(typeof T=="boolean","missing or invalid endian"),W(m!=null,"missing offset"),W(m+1<f.length,"Trying to read beyond buffer length")),!(f.length<=m))return j=H(f,m,T,!0),32768&j?-1*(65535-j+1):j}function w(f,m,T,j){if(j||(W(typeof T=="boolean","missing or invalid endian"),W(m!=null,"missing offset"),W(m+3<f.length,"Trying to read beyond buffer length")),!(f.length<=m))return j=ie(f,m,T,!0),2147483648&j?-1*(4294967295-j+1):j}function g(f,m,T,j){return j||(W(typeof T=="boolean","missing or invalid endian"),W(m+3<f.length,"Trying to read beyond buffer length")),$.read(f,m,T,23,4)}function E(f,m,T,j){return j||(W(typeof T=="boolean","missing or invalid endian"),W(m+7<f.length,"Trying to read beyond buffer length")),$.read(f,m,T,52,8)}function h(f,m,T,j,U){if(U||(W(m!=null,"missing value"),W(typeof j=="boolean","missing or invalid endian"),W(T!=null,"missing offset"),W(T+1<f.length,"trying to write beyond buffer length"),ye(m,65535)),U=f.length,!(U<=T))for(var z=0,he=Math.min(U-T,2);z<he;z++)f[T+z]=(m&255<<8*(j?z:1-z))>>>8*(j?z:1-z)}function k(f,m,T,j,U){if(U||(W(m!=null,"missing value"),W(typeof j=="boolean","missing or invalid endian"),W(T!=null,"missing offset"),W(T+3<f.length,"trying to write beyond buffer length"),ye(m,4294967295)),U=f.length,!(U<=T))for(var z=0,he=Math.min(U-T,4);z<he;z++)f[T+z]=m>>>8*(j?z:3-z)&255}function R(f,m,T,j,U){U||(W(m!=null,"missing value"),W(typeof j=="boolean","missing or invalid endian"),W(T!=null,"missing offset"),W(T+1<f.length,"Trying to write beyond buffer length"),ve(m,32767,-32768)),f.length<=T||h(f,0<=m?m:65535+m+1,T,j,U)}function ae(f,m,T,j,U){U||(W(m!=null,"missing value"),W(typeof j=="boolean","missing or invalid endian"),W(T!=null,"missing offset"),W(T+3<f.length,"Trying to write beyond buffer length"),ve(m,2147483647,-2147483648)),f.length<=T||k(f,0<=m?m:4294967295+m+1,T,j,U)}function ce(f,m,T,j,U){U||(W(m!=null,"missing value"),W(typeof j=="boolean","missing or invalid endian"),W(T!=null,"missing offset"),W(T+3<f.length,"Trying to write beyond buffer length"),Ne(m,34028234663852886e22,-34028234663852886e22)),f.length<=T||$.write(f,m,T,j,23,4)}function le(f,m,T,j,U){U||(W(m!=null,"missing value"),W(typeof j=="boolean","missing or invalid endian"),W(T!=null,"missing offset"),W(T+7<f.length,"Trying to write beyond buffer length"),Ne(m,17976931348623157e292,-17976931348623157e292)),f.length<=T||$.write(f,m,T,j,52,8)}r.Buffer=_,r.SlowBuffer=_,r.INSPECT_MAX_BYTES=50,_.poolSize=8192,_._useTypedArrays=function(){try{var f=new ArrayBuffer(0),m=new Uint8Array(f);return m.foo=function(){return 42},m.foo()===42&&typeof m.subarray=="function"}catch{return!1}}(),_.isEncoding=function(f){switch(String(f).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"binary":case"base64":case"raw":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},_.isBuffer=function(f){return!(f==null||!f._isBuffer)},_.byteLength=function(f,m){var T;switch(f+="",m||"utf8"){case"hex":T=f.length/2;break;case"utf8":case"utf-8":T=re(f).length;break;case"ascii":case"binary":case"raw":T=f.length;break;case"base64":T=ge(f).length;break;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":T=2*f.length;break;default:throw new Error("Unknown encoding")}return T},_.concat=function(f,m){if(W(we(f),`Usage: Buffer.concat(list, [totalLength])
list should be an Array.`),f.length===0)return new _(0);if(f.length===1)return f[0];if(typeof m!="number")for(U=m=0;U<f.length;U++)m+=f[U].length;for(var T=new _(m),j=0,U=0;U<f.length;U++){var z=f[U];z.copy(T,j),j+=z.length}return T},_.prototype.write=function(f,m,T,j){isFinite(m)?isFinite(T)||(j=T,T=void 0):(Ee=j,j=m,m=T,T=Ee),m=Number(m)||0;var U,z,he,xe,Ee=this.length-m;switch((!T||Ee<(T=Number(T)))&&(T=Ee),j=String(j||"utf8").toLowerCase()){case"hex":U=function(He,Fe,Xe,Le){Xe=Number(Xe)||0;var Ie=He.length-Xe;(!Le||Ie<(Le=Number(Le)))&&(Le=Ie),W((Ie=Fe.length)%2==0,"Invalid hex string"),Ie/2<Le&&(Le=Ie/2);for(var Oe=0;Oe<Le;Oe++){var qe=parseInt(Fe.substr(2*Oe,2),16);W(!isNaN(qe),"Invalid hex string"),He[Xe+Oe]=qe}return _._charsWritten=2*Oe,Oe}(this,f,m,T);break;case"utf8":case"utf-8":z=this,he=m,xe=T,U=_._charsWritten=de(re(f),z,he,xe);break;case"ascii":case"binary":U=L(this,f,m,T);break;case"base64":z=this,he=m,xe=T,U=_._charsWritten=de(ge(f),z,he,xe);break;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":U=P(this,f,m,T);break;default:throw new Error("Unknown encoding")}return U},_.prototype.toString=function(f,m,T){var j,U,z,he,xe=this;if(f=String(f||"utf8").toLowerCase(),m=Number(m)||0,(T=T!==void 0?Number(T):xe.length)===m)return"";switch(f){case"hex":j=function(Ee,He,Fe){var Xe=Ee.length;(!He||He<0)&&(He=0),(!Fe||Fe<0||Xe<Fe)&&(Fe=Xe);for(var Le="",Ie=He;Ie<Fe;Ie++)Le+=Y(Ee[Ie]);return Le}(xe,m,T);break;case"utf8":case"utf-8":j=function(Ee,He,Fe){var Xe="",Le="";Fe=Math.min(Ee.length,Fe);for(var Ie=He;Ie<Fe;Ie++)Ee[Ie]<=127?(Xe+=ue(Le)+String.fromCharCode(Ee[Ie]),Le=""):Le+="%"+Ee[Ie].toString(16);return Xe+ue(Le)}(xe,m,T);break;case"ascii":case"binary":j=X(xe,m,T);break;case"base64":U=xe,he=T,j=(z=m)===0&&he===U.length?b.fromByteArray(U):b.fromByteArray(U.slice(z,he));break;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":j=function(Ee,He,Fe){for(var Xe=Ee.slice(He,Fe),Le="",Ie=0;Ie<Xe.length;Ie+=2)Le+=String.fromCharCode(Xe[Ie]+256*Xe[Ie+1]);return Le}(xe,m,T);break;default:throw new Error("Unknown encoding")}return j},_.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}},_.prototype.copy=function(f,m,T,j){if(m=m||0,(j=j||j===0?j:this.length)!==(T=T||0)&&f.length!==0&&this.length!==0){W(T<=j,"sourceEnd < sourceStart"),W(0<=m&&m<f.length,"targetStart out of bounds"),W(0<=T&&T<this.length,"sourceStart out of bounds"),W(0<=j&&j<=this.length,"sourceEnd out of bounds"),j>this.length&&(j=this.length);var U=(j=f.length-m<j-T?f.length-m+T:j)-T;if(U<100||!_._useTypedArrays)for(var z=0;z<U;z++)f[z+m]=this[z+T];else f._set(this.subarray(T,T+U),m)}},_.prototype.slice=function(f,m){var T=this.length;if(f=Te(f,T,0),m=Te(m,T,T),_._useTypedArrays)return _._augment(this.subarray(f,m));for(var j=m-f,U=new _(j,void 0,!0),z=0;z<j;z++)U[z]=this[z+f];return U},_.prototype.get=function(f){return console.log(".get() is deprecated. Access using array indexes instead."),this.readUInt8(f)},_.prototype.set=function(f,m){return console.log(".set() is deprecated. Access using array indexes instead."),this.writeUInt8(f,m)},_.prototype.readUInt8=function(f,m){if(m||(W(f!=null,"missing offset"),W(f<this.length,"Trying to read beyond buffer length")),!(f>=this.length))return this[f]},_.prototype.readUInt16LE=function(f,m){return H(this,f,!0,m)},_.prototype.readUInt16BE=function(f,m){return H(this,f,!1,m)},_.prototype.readUInt32LE=function(f,m){return ie(this,f,!0,m)},_.prototype.readUInt32BE=function(f,m){return ie(this,f,!1,m)},_.prototype.readInt8=function(f,m){if(m||(W(f!=null,"missing offset"),W(f<this.length,"Trying to read beyond buffer length")),!(f>=this.length))return 128&this[f]?-1*(255-this[f]+1):this[f]},_.prototype.readInt16LE=function(f,m){return O(this,f,!0,m)},_.prototype.readInt16BE=function(f,m){return O(this,f,!1,m)},_.prototype.readInt32LE=function(f,m){return w(this,f,!0,m)},_.prototype.readInt32BE=function(f,m){return w(this,f,!1,m)},_.prototype.readFloatLE=function(f,m){return g(this,f,!0,m)},_.prototype.readFloatBE=function(f,m){return g(this,f,!1,m)},_.prototype.readDoubleLE=function(f,m){return E(this,f,!0,m)},_.prototype.readDoubleBE=function(f,m){return E(this,f,!1,m)},_.prototype.writeUInt8=function(f,m,T){T||(W(f!=null,"missing value"),W(m!=null,"missing offset"),W(m<this.length,"trying to write beyond buffer length"),ye(f,255)),m>=this.length||(this[m]=f)},_.prototype.writeUInt16LE=function(f,m,T){h(this,f,m,!0,T)},_.prototype.writeUInt16BE=function(f,m,T){h(this,f,m,!1,T)},_.prototype.writeUInt32LE=function(f,m,T){k(this,f,m,!0,T)},_.prototype.writeUInt32BE=function(f,m,T){k(this,f,m,!1,T)},_.prototype.writeInt8=function(f,m,T){T||(W(f!=null,"missing value"),W(m!=null,"missing offset"),W(m<this.length,"Trying to write beyond buffer length"),ve(f,127,-128)),m>=this.length||(0<=f?this.writeUInt8(f,m,T):this.writeUInt8(255+f+1,m,T))},_.prototype.writeInt16LE=function(f,m,T){R(this,f,m,!0,T)},_.prototype.writeInt16BE=function(f,m,T){R(this,f,m,!1,T)},_.prototype.writeInt32LE=function(f,m,T){ae(this,f,m,!0,T)},_.prototype.writeInt32BE=function(f,m,T){ae(this,f,m,!1,T)},_.prototype.writeFloatLE=function(f,m,T){ce(this,f,m,!0,T)},_.prototype.writeFloatBE=function(f,m,T){ce(this,f,m,!1,T)},_.prototype.writeDoubleLE=function(f,m,T){le(this,f,m,!0,T)},_.prototype.writeDoubleBE=function(f,m,T){le(this,f,m,!1,T)},_.prototype.fill=function(f,m,T){if(m=m||0,T=T||this.length,W(typeof(f=typeof(f=f||0)=="string"?f.charCodeAt(0):f)=="number"&&!isNaN(f),"value is not a number"),W(m<=T,"end < start"),T!==m&&this.length!==0){W(0<=m&&m<this.length,"start out of bounds"),W(0<=T&&T<=this.length,"end out of bounds");for(var j=m;j<T;j++)this[j]=f}},_.prototype.inspect=function(){for(var f=[],m=this.length,T=0;T<m;T++)if(f[T]=Y(this[T]),T===r.INSPECT_MAX_BYTES){f[T+1]="...";break}return"<Buffer "+f.join(" ")+">"},_.prototype.toArrayBuffer=function(){if(typeof Uint8Array>"u")throw new Error("Buffer.toArrayBuffer not supported in this browser");if(_._useTypedArrays)return new _(this).buffer;for(var f=new Uint8Array(this.length),m=0,T=f.length;m<T;m+=1)f[m]=this[m];return f.buffer};var J=_.prototype;function Te(f,m,T){return typeof f!="number"?T:m<=(f=~~f)?m:0<=f||0<=(f+=m)?f:0}function Ae(f){return(f=~~Math.ceil(+f))<0?0:f}function we(f){return(Array.isArray||function(m){return Object.prototype.toString.call(m)==="[object Array]"})(f)}function Y(f){return f<16?"0"+f.toString(16):f.toString(16)}function re(f){for(var m=[],T=0;T<f.length;T++){var j=f.charCodeAt(T);if(j<=127)m.push(f.charCodeAt(T));else for(var U=T,z=(55296<=j&&j<=57343&&T++,encodeURIComponent(f.slice(U,T+1)).substr(1).split("%")),he=0;he<z.length;he++)m.push(parseInt(z[he],16))}return m}function ge(f){return b.toByteArray(f)}function de(f,m,T,j){for(var U=0;U<j&&!(U+T>=m.length||U>=f.length);U++)m[U+T]=f[U];return U}function ue(f){try{return decodeURIComponent(f)}catch{return String.fromCharCode(65533)}}function ye(f,m){W(typeof f=="number","cannot write a non-number as a number"),W(0<=f,"specified a negative value for writing an unsigned value"),W(f<=m,"value is larger than maximum value for type"),W(Math.floor(f)===f,"value has a fractional component")}function ve(f,m,T){W(typeof f=="number","cannot write a non-number as a number"),W(f<=m,"value larger than maximum allowed value"),W(T<=f,"value smaller than minimum allowed value"),W(Math.floor(f)===f,"value has a fractional component")}function Ne(f,m,T){W(typeof f=="number","cannot write a non-number as a number"),W(f<=m,"value larger than maximum allowed value"),W(T<=f,"value smaller than minimum allowed value")}function W(f,m){if(!f)throw new Error(m||"Failed assertion")}_._augment=function(f){return f._isBuffer=!0,f._get=f.get,f._set=f.set,f.get=J.get,f.set=J.set,f.write=J.write,f.toString=J.toString,f.toLocaleString=J.toString,f.toJSON=J.toJSON,f.copy=J.copy,f.slice=J.slice,f.readUInt8=J.readUInt8,f.readUInt16LE=J.readUInt16LE,f.readUInt16BE=J.readUInt16BE,f.readUInt32LE=J.readUInt32LE,f.readUInt32BE=J.readUInt32BE,f.readInt8=J.readInt8,f.readInt16LE=J.readInt16LE,f.readInt16BE=J.readInt16BE,f.readInt32LE=J.readInt32LE,f.readInt32BE=J.readInt32BE,f.readFloatLE=J.readFloatLE,f.readFloatBE=J.readFloatBE,f.readDoubleLE=J.readDoubleLE,f.readDoubleBE=J.readDoubleBE,f.writeUInt8=J.writeUInt8,f.writeUInt16LE=J.writeUInt16LE,f.writeUInt16BE=J.writeUInt16BE,f.writeUInt32LE=J.writeUInt32LE,f.writeUInt32BE=J.writeUInt32BE,f.writeInt8=J.writeInt8,f.writeInt16LE=J.writeInt16LE,f.writeInt16BE=J.writeInt16BE,f.writeInt32LE=J.writeInt32LE,f.writeInt32BE=J.writeInt32BE,f.writeFloatLE=J.writeFloatLE,f.writeFloatBE=J.writeFloatBE,f.writeDoubleLE=J.writeDoubleLE,f.writeDoubleBE=J.writeDoubleBE,f.fill=J.fill,f.inspect=J.inspect,f.toArrayBuffer=J.toArrayBuffer,f}}).call(this,t("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},t("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/buffer/index.js","/node_modules/gulp-browserify/node_modules/buffer")},{"base64-js":2,buffer:3,ieee754:10,lYpoI2:11}],4:[function(t,n,r){(function(o,l,b,p,y,N,x,M,A){var b=t("buffer").Buffer,$=4,_=new b($);_.fill(0),n.exports={hash:function(L,P,X,H){for(var ie=P(function(h,k){h.length%$!=0&&(R=h.length+($-h.length%$),h=b.concat([h,_],R));for(var R,ae=[],ce=k?h.readInt32BE:h.readInt32LE,le=0;le<h.length;le+=$)ae.push(ce.call(h,le));return ae}(L=b.isBuffer(L)?L:new b(L),H),8*L.length),P=H,O=new b(X),w=P?O.writeInt32BE:O.writeInt32LE,g=0;g<ie.length;g++)w.call(O,ie[g],4*g,!0);return O}}}).call(this,t("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},t("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/crypto-browserify/helpers.js","/node_modules/gulp-browserify/node_modules/crypto-browserify")},{buffer:3,lYpoI2:11}],5:[function(t,n,r){(function(o,l,b,p,y,N,x,M,A){var b=t("buffer").Buffer,$=t("./sha"),_=t("./sha256"),L=t("./rng"),P={sha1:$,sha256:_,md5:t("./md5")},X=64,H=new b(X);function ie(h,k){var R=P[h=h||"sha1"],ae=[];return R||O("algorithm:",h,"is not yet supported"),{update:function(ce){return b.isBuffer(ce)||(ce=new b(ce)),ae.push(ce),ce.length,this},digest:function(ce){var le=b.concat(ae),le=k?function(J,Te,Ae){b.isBuffer(Te)||(Te=new b(Te)),b.isBuffer(Ae)||(Ae=new b(Ae)),Te.length>X?Te=J(Te):Te.length<X&&(Te=b.concat([Te,H],X));for(var we=new b(X),Y=new b(X),re=0;re<X;re++)we[re]=54^Te[re],Y[re]=92^Te[re];return Ae=J(b.concat([we,Ae])),J(b.concat([Y,Ae]))}(R,k,le):R(le);return ae=null,ce?le.toString(ce):le}}}function O(){var h=[].slice.call(arguments).join(" ");throw new Error([h,"we accept pull requests","http://github.com/dominictarr/crypto-browserify"].join(`
`))}H.fill(0),r.createHash=function(h){return ie(h)},r.createHmac=ie,r.randomBytes=function(h,k){if(!k||!k.call)return new b(L(h));try{k.call(this,void 0,new b(L(h)))}catch(R){k(R)}};var w,g=["createCredentials","createCipher","createCipheriv","createDecipher","createDecipheriv","createSign","createVerify","createDiffieHellman","pbkdf2"],E=function(h){r[h]=function(){O("sorry,",h,"is not implemented yet")}};for(w in g)E(g[w])}).call(this,t("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},t("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/crypto-browserify/index.js","/node_modules/gulp-browserify/node_modules/crypto-browserify")},{"./md5":6,"./rng":7,"./sha":8,"./sha256":9,buffer:3,lYpoI2:11}],6:[function(t,n,r){(function(o,l,c,p,y,N,x,M,A){var b=t("./helpers");function $(O,w){O[w>>5]|=128<<w%32,O[14+(w+64>>>9<<4)]=w;for(var g=1732584193,E=-271733879,h=-1732584194,k=271733878,R=0;R<O.length;R+=16){var ae=g,ce=E,le=h,J=k,g=L(g,E,h,k,O[R+0],7,-680876936),k=L(k,g,E,h,O[R+1],12,-389564586),h=L(h,k,g,E,O[R+2],17,606105819),E=L(E,h,k,g,O[R+3],22,-1044525330);g=L(g,E,h,k,O[R+4],7,-176418897),k=L(k,g,E,h,O[R+5],12,1200080426),h=L(h,k,g,E,O[R+6],17,-1473231341),E=L(E,h,k,g,O[R+7],22,-45705983),g=L(g,E,h,k,O[R+8],7,1770035416),k=L(k,g,E,h,O[R+9],12,-1958414417),h=L(h,k,g,E,O[R+10],17,-42063),E=L(E,h,k,g,O[R+11],22,-1990404162),g=L(g,E,h,k,O[R+12],7,1804603682),k=L(k,g,E,h,O[R+13],12,-40341101),h=L(h,k,g,E,O[R+14],17,-1502002290),g=P(g,E=L(E,h,k,g,O[R+15],22,1236535329),h,k,O[R+1],5,-165796510),k=P(k,g,E,h,O[R+6],9,-1069501632),h=P(h,k,g,E,O[R+11],14,643717713),E=P(E,h,k,g,O[R+0],20,-373897302),g=P(g,E,h,k,O[R+5],5,-701558691),k=P(k,g,E,h,O[R+10],9,38016083),h=P(h,k,g,E,O[R+15],14,-660478335),E=P(E,h,k,g,O[R+4],20,-405537848),g=P(g,E,h,k,O[R+9],5,568446438),k=P(k,g,E,h,O[R+14],9,-1019803690),h=P(h,k,g,E,O[R+3],14,-187363961),E=P(E,h,k,g,O[R+8],20,1163531501),g=P(g,E,h,k,O[R+13],5,-1444681467),k=P(k,g,E,h,O[R+2],9,-51403784),h=P(h,k,g,E,O[R+7],14,1735328473),g=X(g,E=P(E,h,k,g,O[R+12],20,-1926607734),h,k,O[R+5],4,-378558),k=X(k,g,E,h,O[R+8],11,-2022574463),h=X(h,k,g,E,O[R+11],16,1839030562),E=X(E,h,k,g,O[R+14],23,-35309556),g=X(g,E,h,k,O[R+1],4,-1530992060),k=X(k,g,E,h,O[R+4],11,1272893353),h=X(h,k,g,E,O[R+7],16,-155497632),E=X(E,h,k,g,O[R+10],23,-1094730640),g=X(g,E,h,k,O[R+13],4,681279174),k=X(k,g,E,h,O[R+0],11,-358537222),h=X(h,k,g,E,O[R+3],16,-722521979),E=X(E,h,k,g,O[R+6],23,76029189),g=X(g,E,h,k,O[R+9],4,-640364487),k=X(k,g,E,h,O[R+12],11,-421815835),h=X(h,k,g,E,O[R+15],16,530742520),g=H(g,E=X(E,h,k,g,O[R+2],23,-995338651),h,k,O[R+0],6,-198630844),k=H(k,g,E,h,O[R+7],10,1126891415),h=H(h,k,g,E,O[R+14],15,-1416354905),E=H(E,h,k,g,O[R+5],21,-57434055),g=H(g,E,h,k,O[R+12],6,1700485571),k=H(k,g,E,h,O[R+3],10,-1894986606),h=H(h,k,g,E,O[R+10],15,-1051523),E=H(E,h,k,g,O[R+1],21,-2054922799),g=H(g,E,h,k,O[R+8],6,1873313359),k=H(k,g,E,h,O[R+15],10,-30611744),h=H(h,k,g,E,O[R+6],15,-1560198380),E=H(E,h,k,g,O[R+13],21,1309151649),g=H(g,E,h,k,O[R+4],6,-145523070),k=H(k,g,E,h,O[R+11],10,-1120210379),h=H(h,k,g,E,O[R+2],15,718787259),E=H(E,h,k,g,O[R+9],21,-343485551),g=ie(g,ae),E=ie(E,ce),h=ie(h,le),k=ie(k,J)}return Array(g,E,h,k)}function _(O,w,g,E,h,k){return ie((w=ie(ie(w,O),ie(E,k)))<<h|w>>>32-h,g)}function L(O,w,g,E,h,k,R){return _(w&g|~w&E,O,w,h,k,R)}function P(O,w,g,E,h,k,R){return _(w&E|g&~E,O,w,h,k,R)}function X(O,w,g,E,h,k,R){return _(w^g^E,O,w,h,k,R)}function H(O,w,g,E,h,k,R){return _(g^(w|~E),O,w,h,k,R)}function ie(O,w){var g=(65535&O)+(65535&w);return(O>>16)+(w>>16)+(g>>16)<<16|65535&g}n.exports=function(O){return b.hash(O,$,16)}}).call(this,t("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},t("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/crypto-browserify/md5.js","/node_modules/gulp-browserify/node_modules/crypto-browserify")},{"./helpers":4,buffer:3,lYpoI2:11}],7:[function(t,n,r){(function(o,l,c,p,y,N,x,M,A){n.exports=function(b){for(var $,_=new Array(b),L=0;L<b;L++)!(3&L)&&($=4294967296*Math.random()),_[L]=$>>>((3&L)<<3)&255;return _}}).call(this,t("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},t("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/crypto-browserify/rng.js","/node_modules/gulp-browserify/node_modules/crypto-browserify")},{buffer:3,lYpoI2:11}],8:[function(t,n,r){(function(o,l,c,p,y,N,x,M,A){var b=t("./helpers");function $(P,X){P[X>>5]|=128<<24-X%32,P[15+(X+64>>9<<4)]=X;for(var H,ie,O,w=Array(80),g=1732584193,E=-271733879,h=-1732584194,k=271733878,R=-1009589776,ae=0;ae<P.length;ae+=16){for(var ce=g,le=E,J=h,Te=k,Ae=R,we=0;we<80;we++){w[we]=we<16?P[ae+we]:L(w[we-3]^w[we-8]^w[we-14]^w[we-16],1);var Y=_(_(L(g,5),(Y=E,ie=h,O=k,(H=we)<20?Y&ie|~Y&O:!(H<40)&&H<60?Y&ie|Y&O|ie&O:Y^ie^O)),_(_(R,w[we]),(H=we)<20?1518500249:H<40?1859775393:H<60?-1894007588:-899497514)),R=k,k=h,h=L(E,30),E=g,g=Y}g=_(g,ce),E=_(E,le),h=_(h,J),k=_(k,Te),R=_(R,Ae)}return Array(g,E,h,k,R)}function _(P,X){var H=(65535&P)+(65535&X);return(P>>16)+(X>>16)+(H>>16)<<16|65535&H}function L(P,X){return P<<X|P>>>32-X}n.exports=function(P){return b.hash(P,$,20,!0)}}).call(this,t("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},t("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/crypto-browserify/sha.js","/node_modules/gulp-browserify/node_modules/crypto-browserify")},{"./helpers":4,buffer:3,lYpoI2:11}],9:[function(t,n,r){(function(o,l,c,p,y,N,x,M,A){function b(X,H){var ie=(65535&X)+(65535&H);return(X>>16)+(H>>16)+(ie>>16)<<16|65535&ie}function $(X,H){var ie,O=new Array(1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298),w=new Array(1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225),g=new Array(64);X[H>>5]|=128<<24-H%32,X[15+(H+64>>9<<4)]=H;for(var E,h,k=0;k<X.length;k+=16){for(var R=w[0],ae=w[1],ce=w[2],le=w[3],J=w[4],Te=w[5],Ae=w[6],we=w[7],Y=0;Y<64;Y++)g[Y]=Y<16?X[Y+k]:b(b(b((h=g[Y-2],L(h,17)^L(h,19)^P(h,10)),g[Y-7]),(h=g[Y-15],L(h,7)^L(h,18)^P(h,3))),g[Y-16]),ie=b(b(b(b(we,L(h=J,6)^L(h,11)^L(h,25)),J&Te^~J&Ae),O[Y]),g[Y]),E=b(L(E=R,2)^L(E,13)^L(E,22),R&ae^R&ce^ae&ce),we=Ae,Ae=Te,Te=J,J=b(le,ie),le=ce,ce=ae,ae=R,R=b(ie,E);w[0]=b(R,w[0]),w[1]=b(ae,w[1]),w[2]=b(ce,w[2]),w[3]=b(le,w[3]),w[4]=b(J,w[4]),w[5]=b(Te,w[5]),w[6]=b(Ae,w[6]),w[7]=b(we,w[7])}return w}var _=t("./helpers"),L=function(X,H){return X>>>H|X<<32-H},P=function(X,H){return X>>>H};n.exports=function(X){return _.hash(X,$,32,!0)}}).call(this,t("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},t("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/crypto-browserify/sha256.js","/node_modules/gulp-browserify/node_modules/crypto-browserify")},{"./helpers":4,buffer:3,lYpoI2:11}],10:[function(t,n,r){(function(o,l,c,p,y,N,x,M,A){r.read=function(b,$,_,L,k){var X,H,ie=8*k-L-1,O=(1<<ie)-1,w=O>>1,g=-7,E=_?k-1:0,h=_?-1:1,k=b[$+E];for(E+=h,X=k&(1<<-g)-1,k>>=-g,g+=ie;0<g;X=256*X+b[$+E],E+=h,g-=8);for(H=X&(1<<-g)-1,X>>=-g,g+=L;0<g;H=256*H+b[$+E],E+=h,g-=8);if(X===0)X=1-w;else{if(X===O)return H?NaN:1/0*(k?-1:1);H+=Math.pow(2,L),X-=w}return(k?-1:1)*H*Math.pow(2,X-L)},r.write=function(b,$,_,L,P,R){var H,ie,O=8*R-P-1,w=(1<<O)-1,g=w>>1,E=P===23?Math.pow(2,-24)-Math.pow(2,-77):0,h=L?0:R-1,k=L?1:-1,R=$<0||$===0&&1/$<0?1:0;for($=Math.abs($),isNaN($)||$===1/0?(ie=isNaN($)?1:0,H=w):(H=Math.floor(Math.log($)/Math.LN2),$*(L=Math.pow(2,-H))<1&&(H--,L*=2),2<=($+=1<=H+g?E/L:E*Math.pow(2,1-g))*L&&(H++,L/=2),w<=H+g?(ie=0,H=w):1<=H+g?(ie=($*L-1)*Math.pow(2,P),H+=g):(ie=$*Math.pow(2,g-1)*Math.pow(2,P),H=0));8<=P;b[_+h]=255&ie,h+=k,ie/=256,P-=8);for(H=H<<P|ie,O+=P;0<O;b[_+h]=255&H,h+=k,H/=256,O-=8);b[_+h-k]|=128*R}}).call(this,t("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},t("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/ieee754/index.js","/node_modules/gulp-browserify/node_modules/ieee754")},{buffer:3,lYpoI2:11}],11:[function(t,n,r){(function(o,l,c,p,y,N,x,M,A){var b,$,_;function L(){}(o=n.exports={}).nextTick=($=typeof window<"u"&&window.setImmediate,_=typeof window<"u"&&window.postMessage&&window.addEventListener,$?function(P){return window.setImmediate(P)}:_?(b=[],window.addEventListener("message",function(P){var X=P.source;X!==window&&X!==null||P.data!=="process-tick"||(P.stopPropagation(),0<b.length&&b.shift()())},!0),function(P){b.push(P),window.postMessage("process-tick","*")}):function(P){setTimeout(P,0)}),o.title="browser",o.browser=!0,o.env={},o.argv=[],o.on=L,o.addListener=L,o.once=L,o.off=L,o.removeListener=L,o.removeAllListeners=L,o.emit=L,o.binding=function(P){throw new Error("process.binding is not supported")},o.cwd=function(){return"/"},o.chdir=function(P){throw new Error("process.chdir is not supported")}}).call(this,t("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},t("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/process/browser.js","/node_modules/gulp-browserify/node_modules/process")},{buffer:3,lYpoI2:11}]},{},[1])(1)})})(Zi);var us=Zi.exports;const Gt=Fn(us);class ds{cache;useHash;constructor(e){this.cache={},this.useHash=e}cacheValue(e,t){this.cache[this.useHash?Gt(e):String(e)]=t}deleteValue(e){delete this.cache[this.useHash?Gt(e):String(e)]}getValue(e){return this.cache[this.useHash?Gt(e):String(e)]}isCached(e){return(this.useHash?Gt(e):String(e))in this.cache}invalidate(e){e&&Object.entries(this.cache).forEach(([t,n])=>e(t,n)),this.cache={}}}function fs(){return new Worker("/assets/worker-57f2ae30.js",{type:"module"})}class Se{static PLAYER="PLAYER";static PARTY="PARTY";static SCENEITEMS="SCENEITEMS";static SCENELOCAL="SCENELOCAL";static SCENEMETA="SCENEMETADATA";static SCENEGRID="SCENEGRID";static SCENEFOG="SCENEFOG";static ROOMMETA="ROOMMETADATA";playerId;playerColor;playerName;playerMetadata;playerRole;party;lastParty;fogFilled;fogColor;fogStroke;gridDpi;gridScale;gridSnap;gridType;storedMetaItems;sceneItems;sceneLocal;sceneSelected;sceneMetadata;sceneReady;sceneInitialized;roomMetadata;theme;caches;playerShadowCache;localGhosts;snap;torchActive;previousVisionShapes;previousAutohideItems;previousPlayersWithVision;previousSize=[];previousVisionEnabled;previousMap;previousAutodetectEnabled;previousFowEnabled;previousPersistenceEnabled;previousFowColor;busy;workers;workersSetup;sceneMetadataHandler;sceneItemsHandler;sceneLocalHandler;sceneGridHandler;sceneReadyHandler;playerHandler;partyHandler;themeHandler;roomHandler;fogHandler;constructor(e){this.playerId="",this.playerName="",this.playerColor="",this.playerMetadata={},this.playerRole="PLAYER",this.party=[],this.lastParty=[],this.fogFilled=!1,this.fogColor="#000",this.fogStroke=5,this.storedMetaItems=[],this.sceneItems=[],this.sceneLocal=[],this.sceneSelected=[],this.sceneMetadata={},this.gridDpi=0,this.gridScale=5,this.gridSnap=10,this.gridType="ft",this.sceneReady=!1,this.sceneInitialized=!1,this.theme="DARK",this.roomMetadata={},this.localGhosts=[],this.snap=!1,this.busy=!1,this.torchActive=!1,this.caches=e,this.playerShadowCache=new ds(!1),this.previousVisionShapes="",this.previousAutohideItems="",this.previousPlayersWithVision="",this.previousSize=[],this.previousVisionEnabled=!1,this.previousMap="",this.previousAutodetectEnabled=!1,this.previousFowEnabled=!1,this.previousPersistenceEnabled=!1,this.previousFowColor="",this.workers=[],this.workersSetup=!1}async RefreshCache(){if(this.caches.includes(Se.PLAYER)&&(this.playerId=await C.player.getId(),this.playerName=await C.player.getName(),this.playerColor=await C.player.getColor(),this.playerMetadata=await C.player.getMetadata(),this.playerRole=await C.player.getRole()),this.caches.includes(Se.PARTY)&&(this.party=await C.party.getPlayers()),this.caches.includes(Se.SCENEFOG)&&this.sceneReady&&(this.fogColor=await C.scene.fog.getColor(),this.fogFilled=await C.scene.fog.getFilled()),this.caches.includes(Se.SCENEITEMS)&&this.sceneReady&&(this.sceneItems=await C.scene.items.getItems(),this.sceneLocal=await C.scene.local.getItems()),this.caches.includes(Se.SCENEMETA)&&this.sceneReady){this.sceneMetadata=await C.scene.getMetadata();const e=this.sceneMetadata[`${u.EXTENSIONID}/stored`];e&&(this.storedMetaItems=e)}if(this.caches.includes(Se.SCENEGRID)&&this.sceneReady){this.gridDpi=await C.scene.grid.getDpi();const e=await C.scene.grid.getScale();this.gridScale=e.parsed?.multiplier??5,this.gridType=e.parsed.unit}this.caches.includes(Se.ROOMMETA)&&this.sceneReady&&(this.roomMetadata=await C.room.getMetadata())}async InitializeCache(){if(this.CreateWorkers(),this.sceneReady=await C.scene.isReady(),this.theme=await C.theme.getTheme(),ui(this.theme,document),this.caches.includes(Se.PLAYER)&&(this.playerId=await C.player.getId(),this.playerName=await C.player.getName(),this.playerColor=await C.player.getColor(),this.playerMetadata=await C.player.getMetadata(),this.playerRole=await C.player.getRole()),this.caches.includes(Se.PARTY)&&(this.party=await C.party.getPlayers()),this.caches.includes(Se.SCENEFOG)&&this.sceneReady&&(this.fogColor=await C.scene.fog.getColor(),this.fogFilled=await C.scene.fog.getFilled()),this.caches.includes(Se.SCENEITEMS)&&this.sceneReady&&(this.sceneItems=await C.scene.items.getItems(),this.sceneLocal=await C.scene.local.getItems()),this.caches.includes(Se.SCENEMETA)&&this.sceneReady){this.sceneMetadata=await C.scene.getMetadata();const e=this.sceneMetadata[`${u.EXTENSIONID}/stored`];e&&(this.storedMetaItems=e)}if(this.caches.includes(Se.SCENEGRID)&&this.sceneReady){this.gridDpi=await C.scene.grid.getDpi();const e=await C.scene.grid.getScale();this.gridScale=e.parsed?.multiplier??5,this.gridType=e.parsed.unit}this.caches.includes(Se.ROOMMETA)&&this.sceneReady&&(this.roomMetadata=await C.room.getMetadata()),C.broadcast.onMessage(u.RESETID,async e=>{e.data&&await Z.ResetPersistence()}),await this.SaveUserToScene()}CreateWorkers(){const t=Math.min(navigator.hardwareConcurrency??1,16);for(let n=0;n<t;n++){const r=new fs;this.workers.push(r)}}async SaveUserToScene(){await C.scene.setMetadata({[`${u.EXTENSIONID}/USER-${this.playerId}`]:{role:this.playerRole,name:this.playerName,color:this.playerColor}})}KillHandlers(){this.caches.includes(Se.SCENEMETA)&&this.sceneMetadataHandler!==void 0&&this.sceneMetadataHandler(),this.caches.includes(Se.SCENEITEMS)&&this.sceneItemsHandler!==void 0&&this.sceneItemsHandler(),this.caches.includes(Se.SCENEITEMS)&&this.sceneLocalHandler!==void 0&&this.sceneLocalHandler(),this.caches.includes(Se.SCENEGRID)&&this.sceneGridHandler!==void 0&&this.sceneGridHandler(),this.caches.includes(Se.PLAYER)&&this.playerHandler!==void 0&&this.playerHandler(),this.caches.includes(Se.PARTY)&&this.partyHandler!==void 0&&this.partyHandler(),this.caches.includes(Se.ROOMMETA)&&this.roomHandler!==void 0&&this.roomHandler(),this.caches.includes(Se.SCENEFOG)&&this.fogHandler!==void 0&&this.fogHandler(),this.themeHandler!==void 0&&this.themeHandler()}SetupHandlers(){(this.sceneMetadataHandler===void 0||this.sceneMetadataHandler.length===0)&&this.caches.includes(Se.SCENEMETA)&&(this.sceneMetadataHandler=C.scene.onMetadataChange(async e=>{this.sceneMetadata=e,await this.OnSceneMetadataChanges(e)})),(this.sceneItemsHandler===void 0||this.sceneItemsHandler.length===0)&&this.caches.includes(Se.SCENEITEMS)&&(this.sceneItemsHandler=C.scene.items.onChange(async e=>{this.sceneItems=e,await this.OnSceneItemsChange(e)}),this.sceneLocalHandler=C.scene.local.onChange(async e=>{this.sceneLocal=e,await this.OnSceneLocalChange(e)})),(this.sceneGridHandler===void 0||this.sceneGridHandler.length===0)&&this.caches.includes(Se.SCENEGRID)&&(this.sceneGridHandler=C.scene.grid.onChange(async e=>{await this.OnSceneGridChange(e),this.gridDpi=e.dpi,this.gridScale=parseInt(e.scale)})),(this.playerHandler===void 0||this.playerHandler.length===0)&&this.caches.includes(Se.PLAYER)&&(this.playerHandler=C.player.onChange(async e=>{const t=this.playerRole;let n=!1;(this.playerName!==e.name||this.playerColor!==e.color||this.playerRole!==e.role)&&(n=!0),this.playerName=e.name,this.playerColor=e.color,this.playerId=e.id,this.playerRole=e.role,this.playerMetadata=e.metadata,await this.OnPlayerChange(e,t),n&&await this.SaveUserToScene()})),(this.partyHandler===void 0||this.partyHandler.length===0)&&this.caches.includes(Se.PARTY)&&(this.partyHandler=C.party.onChange(async e=>{this.party=e.filter(t=>t.id!==""),await this.OnPartyChange(e)})),(this.roomHandler===void 0||this.roomHandler.length===0)&&this.caches.includes(Se.ROOMMETA)&&(this.roomHandler=C.room.onMetadataChange(async e=>{await this.OnRoomMetadataChange(e),this.roomMetadata=e})),(this.fogHandler===void 0||this.fogHandler.length===0)&&this.caches.includes(Se.ROOMMETA)&&(this.fogHandler=C.scene.fog.onChange(async e=>{await this.OnFogChange(e),this.fogColor=e.style.color,this.fogFilled=e.filled})),this.themeHandler===void 0&&(this.themeHandler=C.theme.onChange(async e=>{this.theme=e.mode,await this.OnThemeChange(e)})),this.sceneReadyHandler===void 0&&(this.sceneReadyHandler=C.scene.onReadyChange(async e=>{this.sceneReady=e,e?(await this.SaveUserToScene(),await this.RefreshCache()):(lt.ClearGhostList(),this.KillHandlers(),this.sceneItems=[],this.sceneMetadata={}),await this.OnSceneReadyChange(e)}))}async OnSceneMetadataChanges(e){this.playerRole==="GM"&&await An(),await Et()}async OnSceneItemsChange(e){this.playerRole==="GM"?(await Z.UpdateUI(),await Mn(Z.mapAlign)):Z.UpdatePlayerVisionList(),await Et()}async OnSceneLocalChange(e){lt.debouncedLocalChanges(I.sceneLocal)}async OnSceneGridChange(e){await Et()}async OnSceneReadyChange(e){e?(await Rn(),this.SetupHandlers(),await Et(),this.playerRole==="GM"&&await An()):this.playerRole==="GM"&&(this.sceneInitialized=!1,await Z.UpdateUI())}async OnPlayerChange(e,t){this.playerRole!==t&&(await Z.SoftReset(),e.role==="GM"?(await C.action.setHeight(510),await C.action.setWidth(420)):Z.UpdatePlayerVisionList());const n=document.querySelectorAll(".token-table-entry");for(let y of n){let N=y.id.substring(3);e.selection!==void 0&&e.selection.includes(N)?y.classList.add("token-table-selected"):y.classList.remove("token-table-selected")}e.selection!==void 0&&e.selection.length===1&&Mr(e.selection[0]);const r=e.metadata;(r[`${u.EXTENSIONID}/finishLine`]??!1)===!0&&qi(),(r[`${u.EXTENSIONID}/cancelLine`]??!1)===!0&&Wi(),(r[`${u.EXTENSIONID}/finishPoly`]??!1)===!0&&zi(),(r[`${u.EXTENSIONID}/cancelPoly`]??!1)===!0&&Yi()}async OnPartyChange(e){if(this.playerRole!=="PLAYER"){const t=document.getElementById("playerListing");t.innerHTML="",t.appendChild(Z.GetEmptyContextItem());for(const n of this.party){const r=document.createElement("li");r.id=n.id,r.textContent=n.name,r.style.color=n.color,t.appendChild(r)}lt.UpdateSpectreTargets(),Z.UpdatePlayerProcessUI()}}async OnFogChange(e){}async OnRoomMetadataChange(e){}async OnThemeChange(e){ui(e,document)}}const I=new Se([Se.SCENEITEMS,Se.SCENEMETA,Se.SCENEFOG,Se.SCENEGRID,Se.PLAYER,Se.PARTY]);function hs(i){return i.layer=="MAP"&&(i.metadata[`${u.EXTENSIONID}/isBackgroundImage`]||i.metadata[`${u.ARMINDOID}/isBackgroundImage`])}function _t(i){return i.metadata[`${u.EXTENSIONID}/isVisionFog`]||i.metadata[`${u.ARMINDOID}/isVisionFog`]}function ps(i){return i.metadata[`${u.EXTENSIONID}/isIndicatorRing`]||i.metadata[`${u.ARMINDOID}/isIndicatorRing`]}function Ti(i){return i.metadata[`${u.EXTENSIONID}/isVisionLine`]||i.metadata[`${u.ARMINDOID}/isVisionLine`]}function gs(i){return i.metadata[`${u.EXTENSIONID}/isVisionLine`]&&!i.metadata[`${u.EXTENSIONID}/disabled`]||i.metadata[`${u.ARMINDOID}/isVisionLine`]&&!i.metadata[`${u.ARMINDOID}/disabled`]}function Ji(i){return(i.layer==="CHARACTER"||i.layer==="MOUNT"||i.layer==="ATTACHMENT"||i.layer==="PROP")&&(i.metadata[`${u.EXTENSIONID}/hasVision`]||i.metadata[`${u.ARMINDOID}/hasVision`])}function Ni(i){return(i.layer==="CHARACTER"||i.layer==="MOUNT"||i.layer==="ATTACHMENT"||i.layer==="PROP")&&(i.metadata[`${u.EXTENSIONID}/hasVision`]||i.metadata[`${u.ARMINDOID}/hasVision`])&&!i.metadata[`${u.EXTENSIONID}/visionBlind`]}function ms(i){return(i.layer==="CHARACTER"||i.layer==="MOUNT"||i.layer==="ATTACHMENT"||i.layer==="PROP")&&i.createdUserId==I.playerId&&(i.metadata[`${u.EXTENSIONID}/hasVision`]||i.metadata[`${u.ARMINDOID}/hasVision`])&&!i.metadata[`${u.EXTENSIONID}/visionBlind`]}function Qi(i){return(i.layer==="DRAWING"||i.layer==="MAP")&&(i.metadata[`${u.EXTENSIONID}/isBackgroundImage`]||i.metadata[`${u.ARMINDOID}/isBackgroundImage`])}function Kt(i){return i.metadata[`${u.EXTENSIONID}/isTrailingFog`]}function Bn(i){return i.metadata[`${u.EXTENSIONID}/isTrailingFog`]||i.metadata[`${u.EXTENSIONID}/isVisionFog`]||i.metadata[`${u.ARMINDOID}/isVisionFog`]||i.metadata[`${u.EXTENSIONID}/isIndicatorRing`]}function ys(i){return i.metadata[`${u.EXTENSIONID}/isBrushSquare`]}function wt(i){return i.metadata[`${u.EXTENSIONID}/visionTorch`]}function Oi(i){return(i.layer==="CHARACTER"||i.layer==="MOUNT"||i.layer==="ATTACHMENT"||i.layer==="PROP")&&!Ji(i)&&i.metadata[`${u.EXTENSIONID}/hasAutohide`]===!0}var tt=function(){/*!
* Copyright (c) 2021-2023 Momo Bassit.
* Licensed under the MIT License (MIT)
* https://github.com/mdbassit/Coloris
* Version: 0.21.1
* NPM: https://github.com/melloware/coloris-npm
*/return function(i,e,t,n){var r=e.createElement("canvas").getContext("2d"),o={r:0,g:0,b:0,h:0,s:0,v:0,a:1},l,c,p,y,N,x,M,A,b,$,_,L,P,X,H,ie,O={},w={el:"[data-coloris]",parent:"body",theme:"default",themeMode:"light",rtl:!1,wrap:!0,margin:2,format:"hex",formatToggle:!1,swatches:[],swatchesOnly:!1,alpha:!0,forceAlpha:!1,focusInput:!0,selectInput:!1,inline:!1,defaultColor:"#000000",clearButton:!1,clearLabel:"Clear",closeButton:!1,closeLabel:"Close",onChange:function(){return n},a11y:{open:"Open color picker",close:"Close color picker",clear:"Clear the selected color",marker:"Saturation: {s}. Brightness: {v}.",hueSlider:"Hue slider",alphaSlider:"Opacity slider",input:"Color value field",format:"Color format",swatch:"Color swatch",instruction:"Saturation and brightness selector. Use up, down, left and right arrow keys to select."}},g={},E="",h={},k=!1;function R(S){if(typeof S=="object"){var F=function(){switch(G){case"el":Te(S.el),S.wrap!==!1&&we(S.el);break;case"parent":l=e.querySelector(S.parent),l&&(l.appendChild(c),w.parent=S.parent,l===e.body&&(l=n));break;case"themeMode":w.themeMode=S.themeMode,S.themeMode==="auto"&&i.matchMedia&&i.matchMedia("(prefers-color-scheme: dark)").matches&&(w.themeMode="dark");case"theme":S.theme&&(w.theme=S.theme),c.className="clr-picker clr-"+w.theme+" clr-"+w.themeMode,w.inline&&Ae();break;case"rtl":w.rtl=!!S.rtl,e.querySelectorAll(".clr-field").forEach(function(Ge){return Ge.classList.toggle("clr-rtl",w.rtl)});break;case"margin":S.margin*=1,w.margin=isNaN(S.margin)?w.margin:S.margin;break;case"wrap":S.el&&S.wrap&&we(S.el);break;case"formatToggle":w.formatToggle=!!S.formatToggle,Ie("clr-format").style.display=w.formatToggle?"block":"none",w.formatToggle&&(w.format="auto");break;case"swatches":if(Array.isArray(S.swatches)){var oe=[];S.swatches.forEach(function(Ge,ke){oe.push('<button type="button" id="clr-swatch-'+ke+'" aria-labelledby="clr-swatch-label clr-swatch-'+ke+'" style="color: '+Ge+';">'+Ge+"</button>")}),Ie("clr-swatches").innerHTML=oe.length?"<div>"+oe.join("")+"</div>":"",w.swatches=S.swatches.slice()}break;case"swatchesOnly":w.swatchesOnly=!!S.swatchesOnly,c.setAttribute("data-minimal",w.swatchesOnly);break;case"alpha":w.alpha=!!S.alpha,c.setAttribute("data-alpha",w.alpha);break;case"inline":if(w.inline=!!S.inline,c.setAttribute("data-inline",w.inline),w.inline){var fe=S.defaultColor||w.defaultColor;X=ge(fe),Ae(),re(fe)}break;case"clearButton":typeof S.clearButton=="object"&&(S.clearButton.label&&(w.clearLabel=S.clearButton.label,M.innerHTML=w.clearLabel),S.clearButton=S.clearButton.show),w.clearButton=!!S.clearButton,M.style.display=w.clearButton?"block":"none";break;case"clearLabel":w.clearLabel=S.clearLabel,M.innerHTML=w.clearLabel;break;case"closeButton":w.closeButton=!!S.closeButton,w.closeButton?c.insertBefore(A,N):N.appendChild(A);break;case"closeLabel":w.closeLabel=S.closeLabel,A.innerHTML=w.closeLabel;break;case"a11y":var pe=S.a11y,Me=!1;if(typeof pe=="object")for(var be in pe)pe[be]&&w.a11y[be]&&(w.a11y[be]=pe[be],Me=!0);if(Me){var Ue=Ie("clr-open-label"),_e=Ie("clr-swatch-label");Ue.innerHTML=w.a11y.open,_e.innerHTML=w.a11y.swatch,A.setAttribute("aria-label",w.a11y.close),M.setAttribute("aria-label",w.a11y.clear),b.setAttribute("aria-label",w.a11y.hueSlider),_.setAttribute("aria-label",w.a11y.alphaSlider),x.setAttribute("aria-label",w.a11y.input),p.setAttribute("aria-label",w.a11y.instruction)}break;default:w[G]=S[G]}};for(var G in S)F()}}function ae(S,F){typeof S=="string"&&typeof F=="object"&&(g[S]=F,k=!0)}function ce(S){delete g[S],Object.keys(g).length===0&&(k=!1,S===E&&J())}function le(S){if(k){var F=["el","wrap","rtl","inline","defaultColor","a11y"],G=function(){var pe=g[ne];if(S.matches(ne)){E=ne,h={},F.forEach(function(be){return delete pe[be]});for(var Me in pe)h[Me]=Array.isArray(w[Me])?w[Me].slice():w[Me];return R(pe),"break"}};for(var ne in g){var oe=G();if(oe==="break")break}}}function J(){Object.keys(h).length>0&&(R(h),E="",h={})}function Te(S){Oe(e,"click",S,function(F){w.inline||(le(F.target),P=F.target,H=P.value,X=ge(H),c.classList.add("clr-open"),Ae(),re(H),(w.focusInput||w.selectInput)&&(x.focus({preventScroll:!0}),x.setSelectionRange(P.selectionStart,P.selectionEnd)),w.selectInput&&x.select(),(ie||w.swatchesOnly)&&Le().shift().focus(),P.dispatchEvent(new Event("open",{bubbles:!0})))}),Oe(e,"input",S,function(F){var G=F.target.parentNode;G.classList.contains("clr-field")&&(G.style.color=F.target.value)})}function Ae(){if(!(!c||!P&&!w.inline)){var S=l,F=i.scrollY,G=c.offsetWidth,ne=c.offsetHeight,oe={left:!1,top:!1},fe,pe,Me,be={x:0,y:0};if(S&&(fe=i.getComputedStyle(S),pe=parseFloat(fe.marginTop),Me=parseFloat(fe.borderTopWidth),be=S.getBoundingClientRect(),be.y+=Me+F),!w.inline){var Ue=P.getBoundingClientRect(),_e=Ue.x,Ge=F+Ue.y+Ue.height+w.margin;S?(_e-=be.x,Ge-=be.y,_e+G>S.clientWidth&&(_e+=Ue.width-G,oe.left=!0),Ge+ne>S.clientHeight-pe&&ne+w.margin<=Ue.top-(be.y-F)&&(Ge-=Ue.height+ne+w.margin*2,oe.top=!0),Ge+=S.scrollTop):(_e+G>e.documentElement.clientWidth&&(_e+=Ue.width-G,oe.left=!0),Ge+ne-F>e.documentElement.clientHeight&&ne+w.margin<=Ue.top&&(Ge=F+Ue.y-ne-w.margin,oe.top=!0)),c.classList.toggle("clr-left",oe.left),c.classList.toggle("clr-top",oe.top),c.style.left=_e+"px",c.style.top=Ge+"px",be.x+=c.offsetLeft,be.y+=c.offsetTop}O={width:p.offsetWidth,height:p.offsetHeight,x:p.offsetLeft+be.x,y:p.offsetTop+be.y}}}function we(S){e.querySelectorAll(S).forEach(function(F){var G=F.parentNode;if(!G.classList.contains("clr-field")){var ne=e.createElement("div"),oe="clr-field";(w.rtl||F.classList.contains("clr-rtl"))&&(oe+=" clr-rtl"),ne.innerHTML='<button type="button" aria-labelledby="clr-open-label"></button>',G.insertBefore(ne,F),ne.setAttribute("class",oe),ne.style.color=F.value,ne.appendChild(F)}})}function Y(S){if(P&&!w.inline){var F=P;S&&(P=n,H!==F.value&&(F.value=H,F.dispatchEvent(new Event("input",{bubbles:!0})))),setTimeout(function(){H!==F.value&&F.dispatchEvent(new Event("change",{bubbles:!0}))}),c.classList.remove("clr-open"),k&&J(),F.dispatchEvent(new Event("close",{bubbles:!0})),w.focusInput&&F.focus({preventScroll:!0}),P=n}}function re(S){var F=xe(S),G=he(F);ye(G.s,G.v),m(F,G),b.value=G.h,c.style.color="hsl("+G.h+", 100%, 50%)",$.style.left=G.h/360*100+"%",y.style.left=O.width*G.s/100+"px",y.style.top=O.height-O.height*G.v/100+"px",_.value=G.a*100,L.style.left=G.a*100+"%"}function ge(S){var F=S.substring(0,3).toLowerCase();return F==="rgb"||F==="hsl"?F:"hex"}function de(S){S=S!==n?S:x.value,P&&(P.value=S,P.dispatchEvent(new Event("input",{bubbles:!0}))),w.onChange&&w.onChange.call(i,S,P),e.dispatchEvent(new CustomEvent("coloris:pick",{detail:{color:S,currentEl:P}}))}function ue(S,F){var G={h:b.value*1,s:S/O.width*100,v:100-F/O.height*100,a:_.value/100},ne=U(G);ye(G.s,G.v),m(ne,G),de()}function ye(S,F){var G=w.a11y.marker;S=S.toFixed(1)*1,F=F.toFixed(1)*1,G=G.replace("{s}",S),G=G.replace("{v}",F),y.setAttribute("aria-label",G)}function ve(S){return{pageX:S.changedTouches?S.changedTouches[0].pageX:S.pageX,pageY:S.changedTouches?S.changedTouches[0].pageY:S.pageY}}function Ne(S){var F=ve(S),G=F.pageX-O.x,ne=F.pageY-O.y;l&&(ne+=l.scrollTop),f(G,ne),S.preventDefault(),S.stopPropagation()}function W(S,F){var G=y.style.left.replace("px","")*1+S,ne=y.style.top.replace("px","")*1+F;f(G,ne)}function f(S,F){S=S<0?0:S>O.width?O.width:S,F=F<0?0:F>O.height?O.height:F,y.style.left=S+"px",y.style.top=F+"px",ue(S,F),y.focus()}function m(S,F){S===void 0&&(S={}),F===void 0&&(F={});var G=w.format;for(var ne in S)o[ne]=S[ne];for(var oe in F)o[oe]=F[oe];var fe=Ee(o),pe=fe.substring(0,7);switch(y.style.color=pe,L.parentNode.style.color=pe,L.style.color=fe,N.style.color=fe,p.style.display="none",p.offsetHeight,p.style.display="",L.nextElementSibling.style.display="none",L.nextElementSibling.offsetHeight,L.nextElementSibling.style.display="",G==="mixed"?G=o.a===1?"hex":"rgb":G==="auto"&&(G=X),G){case"hex":x.value=fe;break;case"rgb":x.value=He(o);break;case"hsl":x.value=Fe(z(o));break}e.querySelector('.clr-format [value="'+G+'"]').checked=!0}function T(){var S=b.value*1,F=y.style.left.replace("px","")*1,G=y.style.top.replace("px","")*1;c.style.color="hsl("+S+", 100%, 50%)",$.style.left=S/360*100+"%",ue(F,G)}function j(){var S=_.value/100;L.style.left=S*100+"%",m({a:S}),de()}function U(S){var F=S.s/100,G=S.v/100,ne=F*G,oe=S.h/60,fe=ne*(1-t.abs(oe%2-1)),pe=G-ne;ne=ne+pe,fe=fe+pe;var Me=t.floor(oe)%6,be=[ne,fe,pe,pe,fe,ne][Me],Ue=[fe,ne,ne,fe,pe,pe][Me],_e=[pe,pe,fe,ne,ne,fe][Me];return{r:t.round(be*255),g:t.round(Ue*255),b:t.round(_e*255),a:S.a}}function z(S){var F=S.v/100,G=F*(1-S.s/100/2),ne;return G>0&&G<1&&(ne=t.round((F-G)/t.min(G,1-G)*100)),{h:S.h,s:ne||0,l:t.round(G*100),a:S.a}}function he(S){var F=S.r/255,G=S.g/255,ne=S.b/255,oe=t.max(F,G,ne),fe=t.min(F,G,ne),pe=oe-fe,Me=oe,be=0,Ue=0;return pe&&(oe===F&&(be=(G-ne)/pe),oe===G&&(be=2+(ne-F)/pe),oe===ne&&(be=4+(F-G)/pe),oe&&(Ue=pe/oe)),be=t.floor(be*60),{h:be<0?be+360:be,s:t.round(Ue*100),v:t.round(Me*100),a:S.a}}function xe(S){var F=/^((rgba)|rgb)[\D]+([\d.]+)[\D]+([\d.]+)[\D]+([\d.]+)[\D]*?([\d.]+|$)/i,G,ne;return r.fillStyle="#000",r.fillStyle=S,G=F.exec(r.fillStyle),G?(ne={r:G[3]*1,g:G[4]*1,b:G[5]*1,a:G[6]*1},ne.a=+ne.a.toFixed(2)):(G=r.fillStyle.replace("#","").match(/.{2}/g).map(function(oe){return parseInt(oe,16)}),ne={r:G[0],g:G[1],b:G[2],a:1}),ne}function Ee(S){var F=S.r.toString(16),G=S.g.toString(16),ne=S.b.toString(16),oe="";if(S.r<16&&(F="0"+F),S.g<16&&(G="0"+G),S.b<16&&(ne="0"+ne),w.alpha&&(S.a<1||w.forceAlpha)){var fe=S.a*255|0;oe=fe.toString(16),fe<16&&(oe="0"+oe)}return"#"+F+G+ne+oe}function He(S){return!w.alpha||S.a===1&&!w.forceAlpha?"rgb("+S.r+", "+S.g+", "+S.b+")":"rgba("+S.r+", "+S.g+", "+S.b+", "+S.a+")"}function Fe(S){return!w.alpha||S.a===1&&!w.forceAlpha?"hsl("+S.h+", "+S.s+"%, "+S.l+"%)":"hsla("+S.h+", "+S.s+"%, "+S.l+"%, "+S.a+")"}function Xe(){e.getElementById("clr-picker")||(l=n,c=e.createElement("div"),c.setAttribute("id","clr-picker"),c.className="clr-picker",c.innerHTML='<input id="clr-color-value" name="clr-color-value" class="clr-color" type="text" value="" spellcheck="false" aria-label="'+w.a11y.input+'">'+('<div id="clr-color-area" class="clr-gradient" role="application" aria-label="'+w.a11y.instruction+'">')+'<div id="clr-color-marker" class="clr-marker" tabindex="0"></div></div><div class="clr-hue">'+('<input id="clr-hue-slider" name="clr-hue-slider" type="range" min="0" max="360" step="1" aria-label="'+w.a11y.hueSlider+'">')+'<div id="clr-hue-marker"></div></div><div class="clr-alpha">'+('<input id="clr-alpha-slider" name="clr-alpha-slider" type="range" min="0" max="100" step="1" aria-label="'+w.a11y.alphaSlider+'">')+'<div id="clr-alpha-marker"></div><span></span></div><div id="clr-format" class="clr-format"><fieldset class="clr-segmented">'+("<legend>"+w.a11y.format+"</legend>")+'<input id="clr-f1" type="radio" name="clr-format" value="hex"><label for="clr-f1">Hex</label><input id="clr-f2" type="radio" name="clr-format" value="rgb"><label for="clr-f2">RGB</label><input id="clr-f3" type="radio" name="clr-format" value="hsl"><label for="clr-f3">HSL</label><span></span></fieldset></div><div id="clr-swatches" class="clr-swatches"></div>'+('<button type="button" id="clr-clear" class="clr-clear" aria-label="'+w.a11y.clear+'">'+w.clearLabel+"</button>")+'<div id="clr-color-preview" class="clr-preview">'+('<button type="button" id="clr-close" class="clr-close" aria-label="'+w.a11y.close+'">'+w.closeLabel+"</button>")+"</div>"+('<span id="clr-open-label" hidden>'+w.a11y.open+"</span>")+('<span id="clr-swatch-label" hidden>'+w.a11y.swatch+"</span>"),e.body.appendChild(c),p=Ie("clr-color-area"),y=Ie("clr-color-marker"),M=Ie("clr-clear"),A=Ie("clr-close"),N=Ie("clr-color-preview"),x=Ie("clr-color-value"),b=Ie("clr-hue-slider"),$=Ie("clr-hue-marker"),_=Ie("clr-alpha-slider"),L=Ie("clr-alpha-marker"),Te(w.el),we(w.el),Oe(c,"mousedown",function(S){c.classList.remove("clr-keyboard-nav"),S.stopPropagation()}),Oe(p,"mousedown",function(S){Oe(e,"mousemove",Ne)}),Oe(p,"touchstart",function(S){e.addEventListener("touchmove",Ne,{passive:!1})}),Oe(y,"mousedown",function(S){Oe(e,"mousemove",Ne)}),Oe(y,"touchstart",function(S){e.addEventListener("touchmove",Ne,{passive:!1})}),Oe(x,"change",function(S){var F=x.value;if(P||w.inline){var G=F===""?F:re(F);de(G)}}),Oe(M,"click",function(S){de(""),Y()}),Oe(A,"click",function(S){de(),Y()}),Oe(Ie("clr-format"),"click",".clr-format input",function(S){X=S.target.value,m(),de()}),Oe(c,"click",".clr-swatches button",function(S){re(S.target.textContent),de(),w.swatchesOnly&&Y()}),Oe(e,"mouseup",function(S){e.removeEventListener("mousemove",Ne)}),Oe(e,"touchend",function(S){e.removeEventListener("touchmove",Ne)}),Oe(e,"mousedown",function(S){ie=!1,c.classList.remove("clr-keyboard-nav"),Y()}),Oe(e,"keydown",function(S){var F=S.key,G=S.target,ne=S.shiftKey,oe=["Tab","ArrowUp","ArrowDown","ArrowLeft","ArrowRight"];if(F==="Escape"?Y(!0):oe.includes(F)&&(ie=!0,c.classList.add("clr-keyboard-nav")),F==="Tab"&&G.matches(".clr-picker *")){var fe=Le(),pe=fe.shift(),Me=fe.pop();ne&&G===pe?(Me.focus(),S.preventDefault()):!ne&&G===Me&&(pe.focus(),S.preventDefault())}}),Oe(e,"click",".clr-field button",function(S){k&&J(),S.target.nextElementSibling.dispatchEvent(new Event("click",{bubbles:!0}))}),Oe(y,"keydown",function(S){var F={ArrowUp:[0,-1],ArrowDown:[0,1],ArrowLeft:[-1,0],ArrowRight:[1,0]};Object.keys(F).includes(S.key)&&(W.apply(void 0,F[S.key]),S.preventDefault())}),Oe(p,"click",Ne),Oe(b,"input",T),Oe(_,"input",j))}function Le(){var S=Array.from(c.querySelectorAll("input, button")),F=S.filter(function(G){return!!G.offsetWidth});return F}function Ie(S){return e.getElementById(S)}function Oe(S,F,G,ne){var oe=Element.prototype.matches||Element.prototype.msMatchesSelector;typeof G=="string"?S.addEventListener(F,function(fe){oe.call(fe.target,G)&&ne.call(fe.target,fe)}):(ne=G,S.addEventListener(F,ne))}function qe(S,F){F=F!==n?F:[],e.readyState!=="loading"?S.apply(void 0,F):e.addEventListener("DOMContentLoaded",function(){S.apply(void 0,F)})}NodeList!==n&&NodeList.prototype&&!NodeList.prototype.forEach&&(NodeList.prototype.forEach=Array.prototype.forEach);function te(S,F){P=F,H=P.value,le(F),X=ge(S),Ae(),re(S),de(),H!==S&&P.dispatchEvent(new Event("change",{bubbles:!0}))}var me=function(){var S={init:Xe,set:R,wrap:we,close:Y,setInstance:ae,setColor:te,removeInstance:ce,updatePosition:Ae};function F(oe){qe(function(){oe&&(typeof oe=="string"?Te(oe):R(oe))})}var G=function(fe){F[fe]=function(){for(var pe=arguments.length,Me=new Array(pe),be=0;be<pe;be++)Me[be]=arguments[be];qe(S[fe],Me)}};for(var ne in S)G(ne);return qe(function(){i.addEventListener("resize",function(oe){F.updatePosition()}),i.addEventListener("scroll",function(oe){F.updatePosition()})}),F}();return me.coloris=me,me}(window,document,Math)}();tt.coloris;tt.init;tt.set;tt.wrap;tt.close;tt.setInstance;tt.removeInstance;tt.updatePosition;function vs(){Z.smokeViewToggle.onclick=e=>{e.preventDefault(),i(Z.smokeViewToggle,Z.smokeViewPanel)},Z.spectreViewToggle.onclick=e=>{e.preventDefault(),i(Z.spectreViewToggle,Z.spectreViewPanel)},Z.settingsViewToggle.onclick=e=>{e.preventDefault(),i(Z.settingsViewToggle,Z.settingsViewPanel)},Z.debugViewToggle.onclick=e=>{e.preventDefault(),i(Z.debugViewToggle,Z.debugViewPanel)};function i(e,t){Z.smokeViewToggle?.classList.remove("selected"),Z.spectreViewToggle?.classList.remove("selected"),Z.settingsViewToggle?.classList.remove("selected"),Z.debugViewToggle?.classList.remove("selected"),Z.smokeViewPanel.style.display="none",Z.spectreViewPanel.style.display="none",Z.settingsViewPanel.style.display="none",Z.debugViewPanel.style.display="none",e.classList.add("selected"),t.style.display="block"}}function ki(){Z.processedIndicator.onclick=async()=>{await C.popover.open({id:u.PROCESSEDID,url:"/pages/processed.html",height:300,width:320,disableClickAway:!1})},Z.hiddenListToggle.onclick=async t=>{Z.hiddenTable.style.display==="none"?(Z.hiddenTable.style.display="table-row-group",Z.hiddenListToggle.value="Out-of-Sight List: Click to Hide"):(Z.hiddenTable.style.display="none",Z.hiddenListToggle.value="Out-of-Sight List: Click to Show")},Z.visionCheckbox.onclick=async t=>{if(!I.sceneReady){t.preventDefault();return}const n=t.target;await C.scene.setMetadata({[`${u.EXTENSIONID}/visionEnabled`]:n.checked}),await C.scene.fog.setFilled(n.checked)},Z.snapCheckbox.checked=!0,Z.snapCheckbox.onclick=async t=>{if(!I.sceneReady){t.preventDefault();return}const n=t.target;I.snap=n.checked},Z.persistenceCheckbox.onclick=async t=>{if(!t||!t.target)return;const n=t.target;await C.scene.setMetadata({[`${u.EXTENSIONID}/persistenceEnabled`]:n.checked})},Z.autodetectCheckbox.onclick=async t=>{if(!t||!t.target)return;const n=t.target;await C.scene.setMetadata({[`${u.EXTENSIONID}/autodetectEnabled`]:n.checked}),Z.boundryOptions.style.display=n.checked?"none":"",await An()},Z.fowCheckbox.onclick=async t=>{if(!t||!t.target)return;const n=t.target;await Zt(n.checked),await C.scene.setMetadata({[`${u.EXTENSIONID}/fowEnabled`]:n.checked})},Z.doorCheckbox.onclick=async t=>{if(!t||!t.target)return;const n=t.target;await C.scene.setMetadata({[`${u.EXTENSIONID}/playerDoors`]:n.checked})},Z.resetButton.onclick=async t=>{!t||!t.target||C.broadcast.sendMessage(u.RESETID,!0,{destination:"ALL"})},Z.unlockFogButton.onclick=async t=>{!t||!t.target||await C.scene.items.updateItems(Ti,n=>{for(let r of n)r.locked=!1})},Z.lockFogButton.onclick=async t=>{!t||!t.target||await C.scene.items.updateItems(Ti,n=>{for(let r of n)r.locked=!0})},Z.backgroundButton.onclick=async t=>{!t||!t.target||(t.target,await C.scene.items.updateItems(n=>n.layer=="FOG"&&n.metadata[`${u.EXTENSIONID}/isBackgroundMap`]===!0,n=>{for(let r=0;r<n.length;r++)n[r].layer="MAP",n[r].disableHit=!1,n[r].locked=!1,n[r].visible=!0,delete n[r].metadata[`${u.EXTENSIONID}/isBackgroundMap`]}))};let i;Z.fowColor.onclick=()=>{tt({el:`#${Z.fowColor.id}`,alpha:!0,forceAlpha:!0})},Z.fowColor.oninput=async t=>{if(!t||!t.target)return;const n=t.target;clearTimeout(i),i=setTimeout(async()=>{if(/#[a-f0-9]{8}/.test(n.value)){await C.scene.setMetadata({[`${u.EXTENSIONID}/fowColor`]:n.value});const o=await C.scene.local.getItems(Kt);await C.scene.local.deleteItems(o.map(l=>l.id))}},500)},Z.convertButton.onclick=async t=>{if(!(!t||!t.target)&&window.confirm(`WARNING: THIS CANNOT BE UNDONE.

This operation will remove all metadata from the original dynamic fog extension, and will break fog lines and other things if you do not continue using Smoke!.

WARNING: THIS CANNOT BE UNDONE.

Are you REALLY sure?`)){for(const n in I.sceneMetadata)n.substring(0,n.indexOf("/"))==u.ARMINDOID&&await C.scene.setMetadata({[`${n}`]:void 0});await C.scene.items.updateItems(I.sceneItems,n=>{for(const r of n)r.metadata[`${u.ARMINDOID}/isVisionLine`]!==void 0&&(r.metadata[`${u.EXTENSIONID}/isVisionLine`]=r.metadata[`${u.ARMINDOID}/isVisionLine`],delete r.metadata[`${u.ARMINDOID}/isVisionLine`]),r.metadata[`${u.ARMINDOID}/disabled`]!==void 0&&(r.metadata[`${u.EXTENSIONID}/disabled`]=r.metadata[`${u.ARMINDOID}/disabled`],delete r.metadata[`${u.ARMINDOID}/disabled`])})}};var e;Z.importFile.onchange=t=>{if(Z.importButton.disabled=!0,!t||!t.target)return;const n=t.target;if(!n.files)return;const r=n.files[0];if(r.type!=="text/javascript"&&r.type,r){var o=new FileReader;o.onload=function(l){if(!l||!l.target){Z.importErrors.innerText="Invalid import event";return}const c=l.target;if(!c.result){Z.importErrors.innerText="Unable to read imported file";return}const p=c.result;e=JSON.parse(p),e&&(e.walls&&e.walls.length||e.line_of_sight&&e.line_of_sight.length||e.objects_line_of_sight&&e.objects_line_of_sight.length)?Z.importButton.disabled=!1:Z.importErrors.innerText="Imported file has no walls"},o.readAsText(r)}else Z.importErrors.innerText="Failed to load file"},Z.importButton.onclick=async t=>{!t||!t.target||(Z.importFormat.value==="scene"?Br(e,Z.importErrors):Rr(Z.importFormat.value,e,Z.dpiAutodetect.checked?0:Number.parseInt(Z.importDpi.value),Z.mapAlign.value,Z.importErrors))},Z.toolColor.onclick=async t=>{tt({el:`#${Z.toolColor.id}`,alpha:!1,forceAlpha:!1})},Z.toolColor.oninput=async t=>{if(!t||!t.target)return;const n=t.target;clearTimeout(i),i=setTimeout(async()=>{/#[a-f0-9]{6}/.test(n.value)&&await C.scene.setMetadata({[`${u.EXTENSIONID}/toolColor`]:n.value})},400)},Z.toolStyle.onchange=async t=>{const n=t.currentTarget;await C.scene.setMetadata({[`${u.EXTENSIONID}/toolStyle`]:n.value=="solid"?[]:[25,25]})},Z.toolWidth.onchange=t=>{const n=t.currentTarget;clearTimeout(i),i=setTimeout(async()=>{await C.scene.setMetadata({[`${u.EXTENSIONID}/toolWidth`]:n.value})},400)},Z.whatsNewButton.onclick=async function(){Z.whatsNewIcon?.classList.remove("new-shine"),await C.modal.open({id:u.EXTENSIONWHATSNEW,url:"/pages/whatsnew.html",height:500,width:400})},tt({themeMode:"dark",alpha:!0,forceAlpha:!0,el:"#fow_color"}),tt({themeMode:"dark",alpha:!1,forceAlpha:!1,el:"#tool_color"})}const er="#000000",Is=8,Es=[];let gt=[];async function tr(){gt=[];const i=await C.scene.local.getItems(ys);await C.scene.local.deleteItems(i.map(e=>e.id)),await C.popover.close(u.BRUSHTOOLID)}async function ws(i,e){await nr(e.pointerPosition)}async function bs(){await C.popover.open({id:u.BRUSHTOOLID,url:"/pages/brush.html",height:70,width:350,disableClickAway:!0})}async function Ss(){await C.popover.close(u.BRUSHTOOLID)}async function Ts(i,e){await nr(e.pointerPosition)}async function Ns(i,e){await ks(),await tr()}async function Os(i,e){await tr()}async function nr(i){const e={x:Math.floor(i.x/I.gridDpi),y:Math.floor(i.y/I.gridDpi)};if(!gt.some(n=>n.x===e.x&&n.y===e.y)){const n={x:e.x*I.gridDpi,y:e.y*I.gridDpi},r={x:(e.x+1)*I.gridDpi,y:e.y*I.gridDpi},o={x:e.x*I.gridDpi,y:(e.y+1)*I.gridDpi},l={x:(e.x+1)*I.gridDpi,y:(e.y+1)*I.gridDpi},c=[[xt.MOVE,n.x,n.y],[xt.LINE,r.x,r.y],[xt.LINE,l.x,l.y],[xt.LINE,o.x,o.y],[xt.CLOSE]],p=ft().commands(c).strokeOpacity(0).fillOpacity(.5).fillColor(I.sceneMetadata[`${u.EXTENSIONID}/toolColor`]??er).build();p.metadata[`${u.EXTENSIONID}/isBrushSquare`]=!0,gt.push(e),await C.scene.local.addItems([p])}}async function ks(){const i=[];for(const l of gt){const{x:c,y:p}=l,y={x:c*I.gridDpi,y:p*I.gridDpi},N={x:(c+1)*I.gridDpi,y:p*I.gridDpi},x={x:c*I.gridDpi,y:(p+1)*I.gridDpi},M={x:(c+1)*I.gridDpi,y:(p+1)*I.gridDpi};if(!gt.some(A=>A.x===c&&A.y===p-1)){const A=y,b=N;i.push({Start:A,End:b})}if(!gt.some(A=>A.x===c&&A.y===p+1)){const A=x,b=M;i.push({Start:A,End:b})}if(!gt.some(A=>A.x===c-1&&A.y===p)){const A=y,b=x;i.push({Start:A,End:b})}if(!gt.some(A=>A.x===c+1&&A.y===p)){const A=N,b=M;i.push({Start:A,End:b})}}const e=rr(i),t=ir(e),n=Cs(t),r=25,o=n.length;for(let l=0;l<o;l+=r){const c=n.slice(l,l+r);await C.scene.items.addItems(c)}}function ir(i){let e=[],t=[],n=!1;for(const r of i){const o=r.Start.x===r.End.x?i.filter(p=>p.Start.x===p.End.x):i.filter(p=>p.Start.y===p.End.y),l=r.Start.x===r.End.x?o.filter(p=>p.Start.x===r.Start.x&&p.End.x===r.End.x):o.filter(p=>p.Start.y===r.Start.y&&p.End.y===r.End.y),c=r.Start.x!==r.End.x?l.find(p=>p.Start.x>r.Start.x&&p.Start.x<r.End.x):l.find(p=>p.Start.y>r.Start.y&&p.Start.y<r.End.y);if(c){const p=_s(r,c);t.push(p),e.push(r),e.push(c),t=t.filter(y=>y!==r&&y!==c),n=!0}else e.includes(r)||t.push(r)}return n?ir(t):t}function rr(i){let e=[],t=[],n=!1;for(const r of i){const l=(r.Start.x===r.End.x?i.filter(c=>c.Start.x===c.End.x):i.filter(c=>c.Start.y===c.End.y)).find(c=>c.Start.x===r.End.x&&c.Start.y===r.End.y);if(l){const c=xs(r,l);t.push(c),e.push(r),e.push(l),t=t.filter(p=>p!==r&&p!==l),n=!0}else e.includes(r)||t.push(r)}return n?rr(t):t}function xs(i,e){return{Start:i.Start,End:e.End}}function _s(i,e){const t=Math.min(i.Start.x,e.Start.x),n=Math.min(i.Start.y,e.Start.y),r=Math.max(i.End.x,e.End.x),o=Math.max(i.End.y,e.End.y);return{Start:{x:t,y:n},End:{x:r,y:o}}}function Cs(i){const e=[];for(const t of i){const n=mt().tension(0).points([t.Start,t.End]).strokeColor(I.sceneMetadata[`${u.EXTENSIONID}/toolColor`]??er).strokeDash(I.sceneMetadata[`${u.EXTENSIONID}/toolStyle`]??Es).strokeWidth(I.sceneMetadata[`${u.EXTENSIONID}/toolWidth`]??Is).fillOpacity(0).fillColor("#000000").layer("DRAWING").name("Vision Line (Brushed)").closed(!1).locked(!0).build();n.visible=!1,n.metadata[`${u.EXTENSIONID}/isVisionLine`]=!0,e.push(n)}return e}const bt={onActivate:bs,onDeactivate:Ss,onDragStart:ws,onDragMove:Ts,onDragEnd:Ns,onDragCancel:Os};async function xi(){await C.tool.create({id:`${u.EXTENSIONID}/vision-tool`,icons:[{icon:"/icon.svg",label:"Setup Vision"}],async onClick(){await C.tool.activateTool(`${u.EXTENSIONID}/vision-tool`)}}),await C.tool.createMode({id:`${u.EXTENSIONID}/add-vision-polygon-mode`,icons:[{icon:"/object.svg",label:"Add Obstruction Object",filter:{activeTools:[`${u.EXTENSIONID}/vision-tool`]}}],onToolDown:Cn.onToolClick,onToolMove:Cn.onToolMove,onKeyDown:Cn.onKeyDown,preventDrag:{dragging:!1}}),await C.tool.createMode({id:`${u.EXTENSIONID}/add-vision-line-mode`,icons:[{icon:"/line.svg",label:"Add Obstruction Line",filter:{activeTools:[`${u.EXTENSIONID}/vision-tool`]}}],onToolDown:_n.onToolClick,onToolMove:_n.onToolMove,onKeyDown:_n.onKeyDown,preventDrag:{dragging:!1}}),await C.tool.createMode({id:`${u.EXTENSIONID}/add-vision-brush-mode`,icons:[{icon:"/brush.svg",label:"Paint Obstructions by Grid",filter:{activeTools:[`${u.EXTENSIONID}/vision-tool`]}}],onToolDown:bt.onActivate,onToolUp:bt.onDeactivate,onToolDragStart:bt.onDragStart,onToolDragMove:bt.onDragMove,onToolDragEnd:bt.onDragEnd,onToolDragCancel:bt.onDragCancel})}class Ds{mainWindow=document.getElementById("app");mainUIDiv;playerListContainer;settingsUIDiv;visionCheckbox;hiddenListToggle;snapCheckbox;table;hiddenTable;message;mapHeight;mapWidth;mapSubmit;whatsNewButton;whatsNewIcon;processedIndicator;smokeViewToggle;spectreViewToggle;settingsViewToggle;debugViewToggle;smokeViewPanel;spectreViewPanel;settingsViewPanel;debugViewPanel;persistenceCheckbox;autodetectCheckbox;fowCheckbox;doorCheckbox;fowColor;resetButton;convertButton;boundryOptions;backgroundButton;lockFogButton;unlockFogButton;toolWidth;toolColor;toolStyle;importButton;importFile;mapAlign;importErrors;dpiAutodetect;importDpi;importFormat;version;constructor(e){this.version=`SMOKEANDSPECTRE-${e}`}SetupGMElements(){this.mainWindow.innerHTML=`
            <div id="localStorageWarning"></div>
            <div id="tabControls">
                <div class="controlContainer">
                    <button class="view-button selected" id="smokeViewToggle">SMOKE</button>
                    <button class="view-button" id="spectreViewToggle">SPECTRE</button>
                    <button class="view-button" id="settingsViewToggle">SETTINGS</button>
                    <button class="view-button" id="debugViewToggle">INFO</button>
                    <div id="miniButtons">
                        <button class="circle-button" id="processedIndicator"></button>
                        <input type="checkbox" id="vision_checkbox" class="large" title="Enable Dynamic Fog">    
                        <div class="tooltip" id="whatsnewbutton" title="Whats New"><svg id="whatsNewIcon" class="svgclickable" fill="#fff" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 3a7 7 0 100 14 7 7 0 000-14zm-9 7a9 9 0 1118 0 9 9 0 01-18 0zm8-4a1 1 0 011-1h.01a1 1 0 110 2H10a1 1 0 01-1-1zm.01 8a1 1 0 102 0V9a1 1 0 10-2 0v5z"/></svg></div>
                    </div>
                </div>
            </div>
            <div id="smokeViewPanel" class="panel"></div>
            <div id="spectreViewPanel" class="panel" style="display: none;"></div>
            <div id="settingsViewPanel" class="panel" style="display: none;"></div>
            <div id="debugViewPanel" class="panel" style="display: none;"></div>
        `,this.mainWindow.parentElement.style.placeItems="start",this.smokeViewToggle=document.getElementById("smokeViewToggle"),this.spectreViewToggle=document.getElementById("spectreViewToggle"),this.settingsViewToggle=document.getElementById("settingsViewToggle"),this.debugViewToggle=document.getElementById("debugViewToggle"),this.smokeViewPanel=document.getElementById("smokeViewPanel"),this.spectreViewPanel=document.getElementById("spectreViewPanel"),this.settingsViewPanel=document.getElementById("settingsViewPanel"),this.debugViewPanel=document.getElementById("debugViewPanel"),this.smokeViewPanel.innerHTML=u.SMOKEHTML,this.spectreViewPanel.innerHTML=u.SPECTREHTML,this.settingsViewPanel.innerHTML=u.SETTINGSHTML,this.debugViewPanel.innerHTML=u.DEBUGHTML,this.mainUIDiv=document.getElementById("main-ui"),this.settingsUIDiv=document.getElementById("settings-ui"),this.visionCheckbox=document.getElementById("vision_checkbox"),this.hiddenListToggle=document.getElementById("hideListToggle"),this.snapCheckbox=document.getElementById("snap_checkbox"),this.table=document.getElementById("token_list"),this.hiddenTable=document.getElementById("hidden_list"),this.message=document.getElementById("no_tokens_message"),this.mapHeight=document.getElementById("mapHeight"),this.mapWidth=document.getElementById("mapWidth"),this.mapSubmit=document.getElementById("mapSubmit"),this.whatsNewButton=document.getElementById("whatsnewbutton"),this.whatsNewIcon=document.getElementById("whatsNewIcon"),this.processedIndicator=document.getElementById("processedIndicator"),this.persistenceCheckbox=document.getElementById("persistence_checkbox"),this.autodetectCheckbox=document.getElementById("autodetect_checkbox"),this.fowCheckbox=document.getElementById("fow_checkbox"),this.doorCheckbox=document.getElementById("door_checkbox"),this.fowColor=document.getElementById("fow_color"),this.resetButton=document.getElementById("persistence_reset"),this.convertButton=document.getElementById("convert_button"),this.boundryOptions=document.getElementById("boundry_options"),this.backgroundButton=document.getElementById("background_button"),this.lockFogButton=document.getElementById("lock_button"),this.unlockFogButton=document.getElementById("unlock_button"),this.toolWidth=document.getElementById("tool_width"),this.toolColor=document.getElementById("tool_color"),this.toolStyle=document.getElementById("tool_style"),this.importButton=document.getElementById("import_button"),this.importFile=document.getElementById("import_file"),this.mapAlign=document.getElementById("map_align"),this.importErrors=document.getElementById("import_errors"),this.dpiAutodetect=document.getElementById("dpi_autodetect"),this.importDpi=document.getElementById("import_dpi"),this.importFormat=document.getElementById("import_format");const e=document.getElementById("playerListing");e.appendChild(this.GetEmptyContextItem());for(const t of I.party){const n=document.createElement("li");n.id=t.id,n.textContent=t.name,n.style.color=t.color,e.appendChild(n)}tt.init(),vs()}async SetupPlayerElements(){this.mainWindow.innerHTML=`<div class="title">Configuration via GM.
            <div class="tooltip" id="helpButton" title="Need Help?"></div>
            </div>
            <hr><sub>You must have ownership of a token to see it.</sub></br></br>Tokens Owned By You:<div id="playerOwnedTokens"></div><div id="localStorageWarning"></div>`,await C.action.setHeight(300),await C.action.setWidth(350),this.playerListContainer=document.getElementById("playerOwnedTokens");const e=document.getElementById("helpButton"),t=document.createElement("input");t.classList.add("clickable"),t.src="/help.svg",t.height=15,t.width=15,t.type="image",t.title="Need Help?",t.onclick=async function(){await C.modal.open({id:u.EXTENSIONWHATSNEW,url:"/pages/whatsnew.html?gethelp=true",height:500,width:350})},e.appendChild(t)}GetEmptyContextItem(){const e=document.createElement("li");return e.id=I.playerId,e.textContent="Self",e}async ResetPersistence(){const e=await C.scene.local.getItems(Bn);await C.scene.local.deleteItems(e.map(n=>n.id));const t=I.sceneMetadata[`${u.EXTENSIONID}/sceneId`];localStorage.removeItem(`${u.EXTENSIONID}/fogCache/${I.playerId}/${t}`),await Et()}async UpdateUI(){const e=I.sceneItems.filter(c=>Ji(c));kr(I.sceneMetadata)||(this.visionCheckbox.checked=I.sceneMetadata[`${u.EXTENSIONID}/visionEnabled`]==!0,this.autodetectCheckbox.checked=I.sceneMetadata[`${u.EXTENSIONID}/autodetectEnabled`]==!0,this.persistenceCheckbox.checked=I.sceneMetadata[`${u.EXTENSIONID}/persistenceEnabled`]==!0,this.autodetectCheckbox.checked=I.sceneMetadata[`${u.EXTENSIONID}/autodetectEnabled`]==!0,this.fowCheckbox.checked=I.sceneMetadata[`${u.EXTENSIONID}/fowEnabled`]==!0,this.doorCheckbox.checked=I.sceneMetadata[`${u.EXTENSIONID}/playerDoors`]==!0,this.fowColor.value=I.sceneMetadata[`${u.EXTENSIONID}/fowColor`]?I.sceneMetadata[`${u.EXTENSIONID}/fowColor`]:"#00000088",I.sceneMetadata[`${u.EXTENSIONID}/debug`]==!0),this.boundryOptions.style.display=this.autodetectCheckbox.checked?"none":"";const t=I.sceneItems.filter(c=>c.layer==="FOG"&&c.metadata[`${u.EXTENSIONID}/isBackgroundMap`]===!0),n=document.querySelectorAll(".fog-background-entry");for(const c of n){const p=c.id.slice(3);t.find(y=>y.id===p)===void 0&&c.remove()}for(const c of t)if(!document.querySelector(`#bg-${c.id}`)){const y=document.createElement("div");y.id=`bg-${c.id}`,y.className="fog-background-entry grid-3 grid-main",y.style.width="300",y.innerHTML=`<div class="token-name grid-2">${c.name}</div>
                    <div><label title="Unlock this fog background and turn it back into a map"><input type="button" value="Unlock"></label></div>`,document.querySelector("#fog_background_list").appendChild(y),y.querySelector("input").addEventListener("click",async x=>{if(!x||!x.target)return;const A=x.target.parentElement.parentElement.parentElement.id.slice(3);await C.scene.items.updateItems(b=>b.id===A&&b.layer=="FOG"&&b.metadata[`${u.EXTENSIONID}/isBackgroundMap`]===!0,b=>{for(let $=0;$<b.length;$++)b[$].layer="MAP",b[$].disableHit=!1,b[$].locked=!1,b[$].visible=!0,delete b[$].metadata[`${u.EXTENSIONID}/isBackgroundMap`]})})}const r=document.querySelector("#fog_backgrounds");t.length==0?r.style.display="none":r.style.display="block";const o=document.getElementsByClassName("token-table-entry"),l=[];for(const c of o){const p=c.id.slice(3);e.find(y=>y.id===p)===void 0&&l.push(c)}for(const c of l)c.remove();for(const c of e)Dr(c)}UpdatePlayerProcessUI(){I.party.every(t=>t.metadata[`${u.EXTENSIONID}/processed`]===!0)?(this.processedIndicator.style.backgroundColor="green",this.processedIndicator.title="Everything looks good."):(this.processedIndicator.style.backgroundColor="red",this.processedIndicator.title="A player is having trouble processing/seeing.")}UpdatePlayerVisionList(){const e=[];for(const t of I.sceneItems)if(Yt(t)&&t.createdUserId===I.playerId){const n=t.metadata[`${u.EXTENSIONID}/hasVision`]!==void 0;e.push(`<li>${t.name}${n?"":": <b>Vision Disabled</b>"}</li>`)}e.length===0&&e.push("<li>None found.</li>"),this.playerListContainer.innerHTML=`<ul>${e.join("")}</ul>`}HighlightWhatsNew(){let e=localStorage.getItem(this.version);(e==="false"||!e)&&(this.whatsNewIcon?.classList.add("new-shine"),localStorage.setItem(this.version,"true"))}async SoftReset(){I.playerRole==="GM"?(this.SetupGMElements(),ki(),this.UpdatePlayerProcessUI(),Mn(this.mapAlign),await Promise.all([fi(),xi(),lt.SetupSpectreGM(),Zt(!1),this.UpdateUI()])):this.SetupPlayerElements(),I.sceneReady&&(await Rn(),await Et())}async Start(){Cr(),I.playerRole==="GM"?(this.SetupGMElements(),ki(),this.UpdatePlayerProcessUI(),Mn(this.mapAlign),await Promise.all([fi(),xi(),lt.SetupSpectreGM(),Zt(!1),this.UpdateUI()])):(await this.SetupPlayerElements(),this.UpdatePlayerVisionList()),await Rn(),await Et(),lt.SetupLocalSpecterHandlers(),I.SetupHandlers(),this.HighlightWhatsNew()}}const Z=new Ds("2.51");C.onReady(async()=>{const i=await C.scene.isReady();if(!document.getElementById("papp"))if(i===!1){const t=C.scene.onReadyChange(async n=>{n&&(t(),await _i())})}else await _i()});async function _i(){await I.InitializeCache(),await Z.Start()}export{Ni as i};
