import{C as g,O as P,b as Ot,a as Et,i as yr,c as Fn,d as Gt}from"./constants-0de41b86.js";var wn=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function Xn(i){return i&&i.__esModule&&Object.prototype.hasOwnProperty.call(i,"default")?i.default:i}function vr(i){if(i.__esModule)return i;var e=i.default;if(typeof e=="function"){var t=function n(){return this instanceof n?Reflect.construct(e,arguments,this.constructor):e.apply(this,arguments)};t.prototype=e.prototype}else t={};return Object.defineProperty(t,"__esModule",{value:!0}),Object.keys(i).forEach(function(n){var o=Object.getOwnPropertyDescriptor(i,n);Object.defineProperty(t,n,o.get?o:{enumerable:!0,get:function(){return i[n]}})}),t}function Ir(i){return i.type==="CURVE"}function on(i){return i.type==="IMAGE"}function ai(i,e){return Math.round(i/e)*e}function si(i,e){return Math.floor(i/e)*e}function Pn(i){return i*(Math.PI/180)}function Er(i){return i*(180/Math.PI)}function li(i,e,t){return i*(1-t)+e*t}class Vt{static magnitudeSquared(e){return e.x*e.x+e.y*e.y}static magnitude(e){const t=Math.sqrt(this.magnitudeSquared(e));return isNaN(t)?0:t}static normalize(e){const t=this.magnitude(e);return t===0?{x:0,y:0}:this.divide(e,t)}static dot(e,t){return e.x*t.x+e.y*t.y}static subtract(e,t){return typeof t=="number"?{x:e.x-t,y:e.y-t}:{x:e.x-t.x,y:e.y-t.y}}static add(e,t){return typeof t=="number"?{x:e.x+t,y:e.y+t}:{x:e.x+t.x,y:e.y+t.y}}static multiply(e,t){return typeof t=="number"?{x:e.x*t,y:e.y*t}:{x:e.x*t.x,y:e.y*t.y}}static divide(e,t){return typeof t=="number"?{x:e.x/t,y:e.y/t}:{x:e.x/t.x,y:e.y/t.y}}static rotate(e,t,n){const o=Math.cos(Pn(n)),r=Math.sin(Pn(n)),c=this.subtract(e,t);return{x:t.x+o*c.x-r*c.y,y:t.y+r*c.x+o*c.y}}static min(e,t){return typeof t=="number"?{x:Math.min(e.x,t),y:Math.min(e.y,t)}:{x:Math.min(e.x,t.x),y:Math.min(e.y,t.y)}}static componentMin(e){return e.x<e.y?e.x:e.y}static max(e,t){return typeof t=="number"?{x:Math.max(e.x,t),y:Math.max(e.y,t)}:{x:Math.max(e.x,t.x),y:Math.max(e.y,t.y)}}static componentMax(e){return e.x>e.y?e.x:e.y}static roundTo(e,t){return{x:ai(e.x,t.x),y:ai(e.y,t.y)}}static floorTo(e,t){return{x:si(e.x,t.x),y:si(e.y,t.y)}}static sign(e){return{x:Math.sign(e.x),y:Math.sign(e.y)}}static abs(e){return{x:Math.abs(e.x),y:Math.abs(e.y)}}static pow(e,t){return typeof t=="number"?{x:Math.pow(e.x,t),y:Math.pow(e.y,t)}:{x:Math.pow(e.x,t.x),y:Math.pow(e.y,t.y)}}static clamp(e,t,n){return{x:Math.min(Math.max(e.x,t),n),y:Math.min(Math.max(e.y,t),n)}}static boundingBox(e){let t=Number.MAX_SAFE_INTEGER,n=Number.MIN_SAFE_INTEGER,o=Number.MAX_SAFE_INTEGER,r=Number.MIN_SAFE_INTEGER;for(let E of e)t=E.x<t?E.x:t,n=E.x>n?E.x:n,o=E.y<o?E.y:o,r=E.y>r?E.y:r;let c=n-t,p=r-o,m={x:(t+n)/2,y:(o+r)/2};return{min:{x:t,y:o},max:{x:n,y:r},width:c,height:p,center:m}}static pointInPolygon(e,t){const n=this.boundingBox(t);if(e.x<n.min.x||e.x>n.max.x||e.y<n.min.y||e.y>n.max.y)return!1;let o=!1;for(let r=0,c=t.length-1;r<t.length;c=r++){const p=t[r].y>e.y,m=t[c].y>e.y;p!==m&&e.x<(t[c].x-t[r].x)*(e.y-t[r].y)/(t[c].y-t[r].y)+t[r].x&&(o=!o)}return o}static compare(e,t,n){return this.magnitudeSquared(this.subtract(e,t))<n*n}static distance(e,t){return this.magnitude(this.subtract(e,t))}static lerp(e,t,n){return{x:li(e.x,t.x,n),y:li(e.y,t.y,n)}}static centroid(e){let t={x:0,y:0};for(let n of e)t.x+=n.x,t.y+=n.y;return e.length>0&&(t={x:t.x/e.length,y:t.y/e.length}),t}}class Ue{static inverse(e){const[t,n,o,r,c,p,m,E,w]=e,k=t*(c*w-E*p)-n*(r*w-p*m)+o*(r*E-c*m);if(Math.abs(k)<1e-14)return e;const C=1/k,z=(c*w-E*p)*C,N=(o*E-n*w)*C,R=(n*p-o*c)*C,x=(p*m-r*w)*C,M=(t*w-o*m)*C,D=(r*o-t*p)*C,F=(r*E-m*c)*C,B=(m*n-t*E)*C,J=(t*c-r*n)*C;return[z,N,R,x,M,D,F,B,J]}static multiply(e,t){return[e[0]*t[0]+e[1]*t[3]+e[2]*t[6],e[0]*t[1]+e[1]*t[4]+e[2]*t[7],e[0]*t[2]+e[1]*t[5]+e[2]*t[8],e[3]*t[0]+e[4]*t[3]+e[5]*t[6],e[3]*t[1]+e[4]*t[4]+e[5]*t[7],e[3]*t[2]+e[4]*t[5]+e[5]*t[8],e[6]*t[0]+e[7]*t[3]+e[8]*t[6],e[6]*t[1]+e[7]*t[4]+e[8]*t[7],e[6]*t[2]+e[7]*t[5]+e[8]*t[8]]}static fromPosition(e){return[1,0,e.x,0,1,e.y,0,0,1]}static fromRotation(e){const t=Pn(e);return[Math.cos(t),-Math.sin(t),0,Math.sin(t),Math.cos(t),0,0,0,1]}static fromScale(e){return[e.x,0,0,0,e.y,0,0,0,1]}static fromItem(e){const t=Ue.fromPosition(e.position),n=Ue.fromScale(e.scale),o=Ue.fromRotation(e.rotation);return Ue.multiply(Ue.multiply(t,o),n)}static decompose(e){const[t,n,o,r,c,p]=e,m=t*c-r*n,E={position:{x:o,y:p},rotation:0,scale:{x:1,y:1}};if(t!=0||r!=0){var w=Math.sqrt(t*t+r*r);E.rotation=r>0?Math.acos(t/w):-Math.acos(t/w),E.scale={x:w,y:m/w}}else if(n!=0||c!=0){var k=Math.sqrt(n*n+c*c);E.rotation=Math.PI/2-(c>0?Math.acos(-n/k):-Math.acos(n/k)),E.scale={x:m/k,y:k}}return E.rotation=Er(E.rotation),E}}class wr{userId;role;items;ghosts;players;metadata;gridDpi;gridScale;gridSnap;fog;ready;snap;initialized;torchActive;lastReset;constructor(){this.userId="",this.role="PLAYER",this.items=[],this.players=[],this.ghosts=[],this.metadata={},this.gridDpi=0,this.gridScale=0,this.gridSnap=10,this.fog={filled:!1,style:{color:"white",strokeWidth:0}},this.ready=!1,this.snap=!0,this.initialized=!1,this.torchActive=!1,this.lastReset=""}}const A=new wr;function br(i){return i.layer=="MAP"&&(i.metadata[`${g.EXTENSIONID}/isBackgroundImage`]||i.metadata[`${g.ARMINDOID}/isBackgroundImage`])}function mt(i){return i.metadata[`${g.EXTENSIONID}/isVisionFog`]||i.metadata[`${g.ARMINDOID}/isVisionFog`]}function Sr(i){return i.metadata[`${g.EXTENSIONID}/isIndicatorRing`]||i.metadata[`${g.ARMINDOID}/isIndicatorRing`]}function _r(i){return i.metadata[`${g.EXTENSIONID}/isVisionLine`]&&!i.metadata[`${g.EXTENSIONID}/disabled`]||i.metadata[`${g.ARMINDOID}/isVisionLine`]&&!i.metadata[`${g.ARMINDOID}/disabled`]}function Oi(i){return(i.layer=="CHARACTER"||i.layer=="ATTACHMENT")&&(i.metadata[`${g.EXTENSIONID}/hasVision`]||i.metadata[`${g.ARMINDOID}/hasVision`])}function Tr(i){return(i.layer=="CHARACTER"||i.layer=="ATTACHMENT")&&(i.metadata[`${g.EXTENSIONID}/hasVision`]||i.metadata[`${g.ARMINDOID}/hasVision`])&&!i.metadata[`${g.EXTENSIONID}/visionBlind`]}function Or(i){return(i.layer=="CHARACTER"||i.layer=="ATTACHMENT")&&i.createdUserId==A.userId&&(i.metadata[`${g.EXTENSIONID}/hasVision`]||i.metadata[`${g.ARMINDOID}/hasVision`])&&!i.metadata[`${g.EXTENSIONID}/visionBlind`]}function Ni(i){return i.layer=="DRAWING"&&(i.metadata[`${g.EXTENSIONID}/isBackgroundImage`]||i.metadata[`${g.ARMINDOID}/isBackgroundImage`])}function Ut(i){return i.metadata[`${g.EXTENSIONID}/isTrailingFog`]}function $n(i){return i.metadata[`${g.EXTENSIONID}/isTrailingFog`]||i.metadata[`${g.EXTENSIONID}/isVisionFog`]||i.metadata[`${g.ARMINDOID}/isVisionFog`]||i.metadata[`${g.EXTENSIONID}/isIndicatorRing`]}function gt(i){return i.metadata[`${g.EXTENSIONID}/visionTorch`]}function ki(i){return i.layer=="CHARACTER"&&!Oi(i)&&i.metadata[`${g.EXTENSIONID}/hasAutohide`]===!0}var xi={exports:{}};const Nr={},kr=Object.freeze(Object.defineProperty({__proto__:null,default:Nr},Symbol.toStringTag,{value:"Module"})),bn=vr(kr);(function(i,e){var t=(()=>{var n=typeof document<"u"&&document.currentScript?document.currentScript.src:void 0;return typeof __filename<"u"&&(n=n||__filename),function(o){o=o||{};var r;r||(r=typeof o<"u"?o:{});var c=Object.assign,p,m;r.ready=new Promise(function(s,a){p=s,m=a}),function(s){var a={};s.loadCmdsTypedArray=function(V){for(var G=0,Z=0;Z<V.length;Z++)G+=V[Z].length;if(a[G])var Q=a[G];else Q=new Float32Array(G),a[G]=Q;var ie=0;for(Z=0;Z<V.length;Z++)for(var _e=0;_e<V[Z].length;_e++){var De=V[Z][_e];typeof De=="string"&&(De=s.SkBits2FloatUnsigned(parseInt(De))),Q[ie]=De,ie++}return V=s._malloc(Q.length*Q.BYTES_PER_ELEMENT),s.HEAPF32.set(Q,V/Q.BYTES_PER_ELEMENT),[V,G]},s.FromCmds=function(V){V=s.loadCmdsTypedArray(V);var G=s._FromCmds(V[0],V[1]);return s._free(V[0]),G};var u,y,O,L,W;s.cubicYFromX=function(V,G,Z,Q,ie){return u&&y===V&&O===G&&L===Z&&W===Q||(u&&u.delete(),u=new s._SkCubicMap([V,G],[Z,Q]),y=V,O=G,L=Z,W=Q),u.computeYFromX(ie)},s.cubicPtFromT=function(V,G,Z,Q,ie){return u&&y===V&&O===G&&L===Z&&W===Q||(u&&u.delete(),u=new s._SkCubicMap([V,G],[Z,Q]),y=V,O=G,L=Z,W=Q),u.computePtFromT(ie)}}(r),function(s){s.onRuntimeInitialized=function(){s.SkPath.prototype.addPath=function(){var a=arguments[0];if(arguments.length===1)this._addPath(a,1,0,0,0,1,0,0,0,1);else if(arguments.length===2){var u=arguments[1];this._addPath(a,u.a,u.c,u.e,u.b,u.d,u.f,0,0,1)}else if(arguments.length===7)u=arguments,this._addPath(a,u[1],u[3],u[5],u[2],u[4],u[6],0,0,1);else if(arguments.length===10)u=arguments,this._addPath(a,u[1],u[2],u[3],u[4],u[5],u[6],u[7],u[8],u[9]);else return console.Ma("addPath expected to take 1, 2, 7, or 10 args. Got "+arguments.length),null;return this},s.SkPath.prototype.arc=function(a,u,y,O,L,W){return this._arc(a,u,y,O,L,!!W),this},s.SkPath.prototype.arcTo=function(a,u,y,O,L){return this._arcTo(a,u,y,O,L),this},s.SkPath.prototype.bezierCurveTo=function(a,u,y,O,L,W){return this._cubicTo(a,u,y,O,L,W),this},s.SkPath.prototype.close=function(){return this._close(),this},s.SkPath.prototype.closePath=function(){return this._close(),this},s.SkPath.prototype.conicTo=function(a,u,y,O,L){return this._conicTo(a,u,y,O,L),this},s.SkPath.prototype.cubicTo=function(a,u,y,O,L,W){return this._cubicTo(a,u,y,O,L,W),this},s.SkPath.prototype.dash=function(a,u,y){return this._dash(a,u,y)?this:null},s.SkPath.prototype.ellipse=function(a,u,y,O,L,W,V,G){return this._ellipse(a,u,y,O,L,W,V,!!G),this},s.SkPath.prototype.lineTo=function(a,u){return this._lineTo(a,u),this},s.SkPath.prototype.moveTo=function(a,u){return this._moveTo(a,u),this},s.SkPath.prototype.op=function(a,u){return this._op(a,u)?this:null},s.SkPath.prototype.quadraticCurveTo=function(a,u,y,O){return this._quadTo(a,u,y,O),this},s.SkPath.prototype.quadTo=function(a,u,y,O){return this._quadTo(a,u,y,O),this},s.SkPath.prototype.rect=function(a,u,y,O){return this._rect(a,u,y,O),this},s.SkPath.prototype.simplify=function(){return this._simplify()?this:null},s.SkPath.prototype.stroke=function(a){return a=a||{},a.width=a.width||1,a.miter_limit=a.miter_limit||4,a.cap=a.cap||s.StrokeCap.BUTT,a.join=a.join||s.StrokeJoin.MITER,this._stroke(a)?this:null},s.SkPath.prototype.transform=function(){if(arguments.length===1)this._transform(arguments[0]);else if(arguments.length===9){var a=arguments;this._transform(a[0],a[1],a[2],a[3],a[4],a[5],a[6],a[7],a[8])}else return console.Ma("transform expected to take 1 or 9 arguments. Got "+arguments.length),null;return this},s.SkPath.prototype.trim=function(a,u,y){return this._trim(a,u,!!y)?this:null}}}(r);var E=c({},r),w=typeof window=="object",k=typeof importScripts=="function",C="",z,N,R,x,M,D;typeof process=="object"&&typeof process.versions=="object"&&typeof process.versions.node=="string"?(C=k?bn.dirname(C)+"/":__dirname+"/",D=()=>{M||(x=bn,M=bn)},z=function(s,a){return D(),s=M.normalize(s),x.readFileSync(s,a?null:"utf8")},R=s=>(s=z(s,!0),s.buffer||(s=new Uint8Array(s)),s),N=(s,a,u)=>{D(),s=M.normalize(s),x.readFile(s,function(y,O){y?u(y):a(O.buffer)})},1<process.argv.length&&process.argv[1].replace(/\\/g,"/"),process.argv.slice(2),process.on("uncaughtException",function(s){throw s}),process.on("unhandledRejection",function(s){throw s}),r.inspect=function(){return"[Emscripten Module object]"}):(w||k)&&(k?C=self.location.href:typeof document<"u"&&document.currentScript&&(C=document.currentScript.src),n&&(C=n),C.indexOf("blob:")!==0?C=C.substr(0,C.replace(/[?#].*/,"").lastIndexOf("/")+1):C="",z=s=>{var a=new XMLHttpRequest;return a.open("GET",s,!1),a.send(null),a.responseText},k&&(R=s=>{var a=new XMLHttpRequest;return a.open("GET",s,!1),a.responseType="arraybuffer",a.send(null),new Uint8Array(a.response)}),N=(s,a,u)=>{var y=new XMLHttpRequest;y.open("GET",s,!0),y.responseType="arraybuffer",y.onload=()=>{y.status==200||y.status==0&&y.response?a(y.response):u()},y.onerror=u,y.send(null)});var F=r.print||console.log.bind(console),B=r.printErr||console.warn.bind(console);c(r,E),E=null;var J;r.wasmBinary&&(J=r.wasmBinary),r.noExitRuntime,typeof WebAssembly!="object"&&te("no native wasm support detected");var T,v=!1,h=typeof TextDecoder<"u"?new TextDecoder("utf8"):void 0;function I(s,a,u){var y=a+u;for(u=a;s[u]&&!(u>=y);)++u;if(16<u-a&&s.subarray&&h)return h.decode(s.subarray(a,u));for(y="";a<u;){var O=s[a++];if(O&128){var L=s[a++]&63;if((O&224)==192)y+=String.fromCharCode((O&31)<<6|L);else{var W=s[a++]&63;O=(O&240)==224?(O&15)<<12|L<<6|W:(O&7)<<18|L<<12|W<<6|s[a++]&63,65536>O?y+=String.fromCharCode(O):(O-=65536,y+=String.fromCharCode(55296|O>>10,56320|O&1023))}}else y+=String.fromCharCode(O)}return y}function d(s,a,u){var y=se;if(0<u){u=a+u-1;for(var O=0;O<s.length;++O){var L=s.charCodeAt(O);if(55296<=L&&57343>=L){var W=s.charCodeAt(++O);L=65536+((L&1023)<<10)|W&1023}if(127>=L){if(a>=u)break;y[a++]=L}else{if(2047>=L){if(a+1>=u)break;y[a++]=192|L>>6}else{if(65535>=L){if(a+2>=u)break;y[a++]=224|L>>12}else{if(a+3>=u)break;y[a++]=240|L>>18,y[a++]=128|L>>12&63}y[a++]=128|L>>6&63}y[a++]=128|L&63}}y[a]=0}}var _=typeof TextDecoder<"u"?new TextDecoder("utf-16le"):void 0;function $(s,a){for(var u=s>>1,y=u+a/2;!(u>=y)&&Re[u];)++u;if(u<<=1,32<u-s&&_)return _.decode(se.subarray(s,u));for(u="",y=0;!(y>=a/2);++y){var O=Ie[s+2*y>>1];if(O==0)break;u+=String.fromCharCode(O)}return u}function re(s,a,u){if(u===void 0&&(u=2147483647),2>u)return 0;u-=2;var y=a;u=u<2*s.length?u/2:s.length;for(var O=0;O<u;++O)Ie[a>>1]=s.charCodeAt(O),a+=2;return Ie[a>>1]=0,a-y}function oe(s){return 2*s.length}function ae(s,a){for(var u=0,y="";!(u>=a/4);){var O=ve[s+4*u>>2];if(O==0)break;++u,65536<=O?(O-=65536,y+=String.fromCharCode(55296|O>>10,56320|O&1023)):y+=String.fromCharCode(O)}return y}function Y(s,a,u){if(u===void 0&&(u=2147483647),4>u)return 0;var y=a;u=y+u-4;for(var O=0;O<s.length;++O){var L=s.charCodeAt(O);if(55296<=L&&57343>=L){var W=s.charCodeAt(++O);L=65536+((L&1023)<<10)|W&1023}if(ve[a>>2]=L,a+=4,a+4>u)break}return ve[a>>2]=0,a-y}function fe(s){for(var a=0,u=0;u<s.length;++u){var y=s.charCodeAt(u);55296<=y&&57343>=y&&++u,a+=4}return a}var me,he,se,Ie,Re,ve,Me,Ee,Be;function je(){var s=T.buffer;me=s,r.HEAP8=he=new Int8Array(s),r.HEAP16=Ie=new Int16Array(s),r.HEAP32=ve=new Int32Array(s),r.HEAPU8=se=new Uint8Array(s),r.HEAPU16=Re=new Uint16Array(s),r.HEAPU32=Me=new Uint32Array(s),r.HEAPF32=Ee=new Float32Array(s),r.HEAPF64=Be=new Float64Array(s)}var K,l=[],f=[],b=[];function j(){var s=r.preRun.shift();l.unshift(s)}var X=0,q=null;r.preloadedImages={},r.preloadedAudios={};function te(s){throw r.onAbort&&r.onAbort(s),s="Aborted("+s+")",B(s),v=!0,s=new WebAssembly.RuntimeError(s+". Build with -s ASSERTIONS=1 for more info."),m(s),s}function ue(){return le.startsWith("data:application/octet-stream;base64,")}var le;if(le="pathkit.wasm",!ue()){var $e=le;le=r.locateFile?r.locateFile($e,C):C+$e}function Le(){var s=le;try{if(s==le&&J)return new Uint8Array(J);if(R)return R(s);throw"both async and sync fetching of the wasm failed"}catch(a){te(a)}}function Ce(){if(!J&&(w||k)){if(typeof fetch=="function"&&!le.startsWith("file://"))return fetch(le,{credentials:"same-origin"}).then(function(s){if(!s.ok)throw"failed to load wasm binary file at '"+le+"'";return s.arrayBuffer()}).catch(function(){return Le()});if(N)return new Promise(function(s,a){N(le,function(u){s(new Uint8Array(u))},a)})}return Promise.resolve().then(function(){return Le()})}function xe(s){for(;0<s.length;){var a=s.shift();if(typeof a=="function")a(r);else{var u=a.Wa;typeof u=="number"?a.xa===void 0?K.get(u)():K.get(u)(a.xa):u(a.xa===void 0?null:a.xa)}}}var de={};function be(s){for(;s.length;){var a=s.pop();s.pop()(a)}}function Ye(s){return this.fromWireType(Me[s>>2])}var lt={},nt={},S={};function U(s){if(s===void 0)return"_unknown";s=s.replace(/[^a-zA-Z0-9_]/g,"$");var a=s.charCodeAt(0);return 48<=a&&57>=a?"_"+s:s}function H(s,a){return s=U(s),function(){return a.apply(this,arguments)}}function ee(s){var a=Error,u=H(s,function(y){this.name=s,this.message=y,y=Error(y).stack,y!==void 0&&(this.stack=this.toString()+`
`+y.replace(/^Error(:[^\n]*)?\n/,""))});return u.prototype=Object.create(a.prototype),u.prototype.constructor=u,u.prototype.toString=function(){return this.message===void 0?this.name:this.name+": "+this.message},u}var ce=void 0;function ge(s){throw new ce(s)}function pe(s,a,u){function y(V){V=u(V),V.length!==s.length&&ge("Mismatched type converter count");for(var G=0;G<s.length;++G)rt(s[G],V[G])}s.forEach(function(V){S[V]=a});var O=Array(a.length),L=[],W=0;a.forEach(function(V,G){nt.hasOwnProperty(V)?O[G]=nt[V]:(L.push(V),lt.hasOwnProperty(V)||(lt[V]=[]),lt[V].push(function(){O[G]=nt[V],++W,W===L.length&&y(O)}))}),L.length===0&&y(O)}var Ae={};function ye(s){switch(s){case 1:return 0;case 2:return 1;case 4:return 2;case 8:return 3;default:throw new TypeError("Unknown type size: "+s)}}var Fe=void 0;function Se(s){for(var a="";se[s];)a+=Fe[se[s++]];return a}var Xe=void 0;function we(s){throw new Xe(s)}function rt(s,a,u={}){if(!("argPackAdvance"in a))throw new TypeError("registerType registeredInstance requires argPackAdvance");var y=a.name;if(s||we('type "'+y+'" must have a positive integer typeid pointer'),nt.hasOwnProperty(s)){if(u.Qa)return;we("Cannot register type '"+y+"' twice")}nt[s]=a,delete S[s],lt.hasOwnProperty(s)&&(a=lt[s],delete lt[s],a.forEach(function(O){O()}))}function sn(s){we(s.ea.ha.fa.name+" instance already deleted")}var ln=!1;function Hn(){}function Wn(s){--s.count.value,s.count.value===0&&(s.ka?s.ma.la(s.ka):s.ha.fa.la(s.ga))}function wt(s){return typeof FinalizationGroup>"u"?(wt=a=>a,s):(ln=new FinalizationGroup(function(a){for(var u=a.next();!u.done;u=a.next())u=u.value,u.ga?Wn(u):console.warn("object already deleted: "+u.ga)}),wt=a=>(ln.register(a,a.ea,a.ea),a),Hn=a=>{ln.unregister(a.ea)},wt(s))}var bt=void 0,St=[];function cn(){for(;St.length;){var s=St.pop();s.ea.pa=!1,s.delete()}}function ct(){}var Gn={};function qn(s,a,u){if(s[a].ia===void 0){var y=s[a];s[a]=function(){return s[a].ia.hasOwnProperty(arguments.length)||we("Function '"+u+"' called with an invalid number of arguments ("+arguments.length+") - expects one of ("+s[a].ia+")!"),s[a].ia[arguments.length].apply(this,arguments)},s[a].ia=[],s[a].ia[y.ua]=y}}function un(s,a,u){r.hasOwnProperty(s)?((u===void 0||r[s].ia!==void 0&&r[s].ia[u]!==void 0)&&we("Cannot register public name '"+s+"' twice"),qn(r,s,s),r.hasOwnProperty(u)&&we("Cannot register multiple overloads of a function with the same number of arguments ("+u+")!"),r[s].ia[u]=a):(r[s]=a,u!==void 0&&(r[s].Xa=u))}function nr(s,a,u,y,O,L,W,V){this.name=s,this.constructor=a,this.qa=u,this.la=y,this.na=O,this.Oa=L,this.ta=W,this.La=V,this.Ta=[]}function dn(s,a,u){for(;a!==u;)a.ta||we("Expected null or instance of "+u.name+", got an instance of "+a.name),s=a.ta(s),a=a.na;return s}function ir(s,a){return a===null?(this.Ba&&we("null is not a valid "+this.name),0):(a.ea||we('Cannot pass "'+mn(a)+'" as a '+this.name),a.ea.ga||we("Cannot pass deleted object as a pointer of type "+this.name),dn(a.ea.ga,a.ea.ha.fa,this.fa))}function rr(s,a){if(a===null){if(this.Ba&&we("null is not a valid "+this.name),this.wa){var u=this.sa();return s!==null&&s.push(this.la,u),u}return 0}if(a.ea||we('Cannot pass "'+mn(a)+'" as a '+this.name),a.ea.ga||we("Cannot pass deleted object as a pointer of type "+this.name),!this.va&&a.ea.ha.va&&we("Cannot convert argument of type "+(a.ea.ma?a.ea.ma.name:a.ea.ha.name)+" to parameter type "+this.name),u=dn(a.ea.ga,a.ea.ha.fa,this.fa),this.wa)switch(a.ea.ka===void 0&&we("Passing raw pointer to smart pointer is illegal"),this.Va){case 0:a.ea.ma===this?u=a.ea.ka:we("Cannot convert argument of type "+(a.ea.ma?a.ea.ma.name:a.ea.ha.name)+" to parameter type "+this.name);break;case 1:u=a.ea.ka;break;case 2:if(a.ea.ma===this)u=a.ea.ka;else{var y=a.clone();u=this.Ua(u,ut(function(){y.delete()})),s!==null&&s.push(this.la,u)}break;default:we("Unsupporting sharing policy")}return u}function or(s,a){return a===null?(this.Ba&&we("null is not a valid "+this.name),0):(a.ea||we('Cannot pass "'+mn(a)+'" as a '+this.name),a.ea.ga||we("Cannot pass deleted object as a pointer of type "+this.name),a.ea.ha.va&&we("Cannot convert argument of type "+a.ea.ha.name+" to parameter type "+this.name),dn(a.ea.ga,a.ea.ha.fa,this.fa))}function zn(s,a,u){return a===u?s:u.na===void 0?null:(s=zn(s,a,u.na),s===null?null:u.La(s))}var _t={};function ar(s,a){for(a===void 0&&we("ptr should not be undefined");s.na;)a=s.ta(a),s=s.na;return _t[a]}function Ct(s,a){return a.ha&&a.ga||ge("makeClassHandle requires ptr and ptrType"),!!a.ma!=!!a.ka&&ge("Both smartPtrType and smartPtr must be specified"),a.count={value:1},wt(Object.create(s,{ea:{value:a}}))}function ot(s,a,u,y){this.name=s,this.fa=a,this.Ba=u,this.va=y,this.wa=!1,this.la=this.Ua=this.sa=this.Ia=this.Va=this.Sa=void 0,a.na!==void 0?this.toWireType=rr:(this.toWireType=y?ir:or,this.ja=null)}function Kn(s,a,u){r.hasOwnProperty(s)||ge("Replacing nonexistant public symbol"),r[s].ia!==void 0&&u!==void 0?r[s].ia[u]=a:(r[s]=a,r[s].ua=u)}function sr(s,a){var u=[];return function(){u.length=arguments.length;for(var y=0;y<arguments.length;y++)u[y]=arguments[y];return s.includes("j")?(y=r["dynCall_"+s],y=u&&u.length?y.apply(null,[a].concat(u)):y.call(null,a)):y=K.get(a).apply(null,u),y}}function He(s,a){s=Se(s);var u=s.includes("j")?sr(s,a):K.get(a);return typeof u!="function"&&we("unknown function pointer with signature "+s+": "+a),u}var Yn=void 0;function Zn(s){s=ii(s);var a=Se(s);return at(s),a}function At(s,a){function u(L){O[L]||nt[L]||(S[L]?S[L].forEach(u):(y.push(L),O[L]=!0))}var y=[],O={};throw a.forEach(u),new Yn(s+": "+y.map(Zn).join([", "]))}function fn(s,a){for(var u=[],y=0;y<s;y++)u.push(ve[(a>>2)+y]);return u}function pn(s,a,u,y,O){var L=a.length;2>L&&we("argTypes array size mismatch! Must at least get return value and 'this' types!");var W=a[1]!==null&&u!==null,V=!1;for(u=1;u<a.length;++u)if(a[u]!==null&&a[u].ja===void 0){V=!0;break}var G=a[0].name!=="void",Z=L-2,Q=Array(Z),ie=[],_e=[];return function(){if(arguments.length!==Z&&we("function "+s+" called with "+arguments.length+" arguments, expected "+Z+" args!"),_e.length=0,ie.length=W?2:1,ie[0]=O,W){var De=a[1].toWireType(_e,this);ie[1]=De}for(var Te=0;Te<Z;++Te)Q[Te]=a[Te+2].toWireType(_e,arguments[Te]),ie.push(Q[Te]);if(Te=y.apply(null,ie),V)be(_e);else for(var We=W?1:2;We<a.length;We++){var Ge=We===1?De:Q[We-2];a[We].ja!==null&&a[We].ja(Ge)}return De=G?a[0].fromWireType(Te):void 0,De}}var hn=[],it=[{},{value:void 0},{value:null},{value:!0},{value:!1}];function Qn(s){4<s&&--it[s].Ca===0&&(it[s]=void 0,hn.push(s))}function gn(s){return s||we("Cannot use deleted val. handle = "+s),it[s].value}function ut(s){switch(s){case void 0:return 1;case null:return 2;case!0:return 3;case!1:return 4;default:var a=hn.length?hn.pop():it.length;return it[a]={Ca:1,value:s},a}}function lr(s,a,u){switch(a){case 0:return function(y){return this.fromWireType((u?he:se)[y])};case 1:return function(y){return this.fromWireType((u?Ie:Re)[y>>1])};case 2:return function(y){return this.fromWireType((u?ve:Me)[y>>2])};default:throw new TypeError("Unknown integer type: "+s)}}function Dt(s,a){var u=nt[s];return u===void 0&&we(a+" has unknown type "+Zn(s)),u}function mn(s){if(s===null)return"null";var a=typeof s;return a==="object"||a==="array"||a==="function"?s.toString():""+s}function cr(s,a){switch(a){case 2:return function(u){return this.fromWireType(Ee[u>>2])};case 3:return function(u){return this.fromWireType(Be[u>>3])};default:throw new TypeError("Unknown float type: "+s)}}function ur(s,a,u){switch(a){case 0:return u?function(y){return he[y]}:function(y){return se[y]};case 1:return u?function(y){return Ie[y>>1]}:function(y){return Re[y>>1]};case 2:return u?function(y){return ve[y>>2]}:function(y){return Me[y>>2]};default:throw new TypeError("Unknown integer type: "+s)}}var dr={};function yn(s){var a=dr[s];return a===void 0?Se(s):a}var vn=[];function Jn(){function s(a){a.$$$embind_global$$$=a;var u=typeof $$$embind_global$$$=="object"&&a.$$$embind_global$$$===a;return u||delete a.$$$embind_global$$$,u}if(typeof globalThis=="object")return globalThis;if(typeof $$$embind_global$$$=="object"||(typeof wn=="object"&&s(wn)?$$$embind_global$$$=wn:typeof self=="object"&&s(self)&&($$$embind_global$$$=self),typeof $$$embind_global$$$=="object"))return $$$embind_global$$$;throw Error("unable to get global object.")}function fr(s){var a=vn.length;return vn.push(s),a}function pr(s,a){for(var u=Array(s),y=0;y<s;++y)u[y]=Dt(ve[(a>>2)+y],"parameter "+y);return u}var ei=[];function hr(s){var a=Array(s+1);return function(u,y,O){a[0]=u;for(var L=0;L<s;++L){var W=Dt(ve[(y>>2)+L],"parameter "+L);a[L+1]=W.readValueFromPointer(O),O+=W.argPackAdvance}return u=new(u.bind.apply(u,a)),ut(u)}}var ti={},gr=[null,[],[]];ce=r.InternalError=ee("InternalError");for(var ni=Array(256),Pt=0;256>Pt;++Pt)ni[Pt]=String.fromCharCode(Pt);Fe=ni,Xe=r.BindingError=ee("BindingError"),ct.prototype.isAliasOf=function(s){if(!(this instanceof ct&&s instanceof ct))return!1;var a=this.ea.ha.fa,u=this.ea.ga,y=s.ea.ha.fa;for(s=s.ea.ga;a.na;)u=a.ta(u),a=a.na;for(;y.na;)s=y.ta(s),y=y.na;return a===y&&u===s},ct.prototype.clone=function(){if(this.ea.ga||sn(this),this.ea.ra)return this.ea.count.value+=1,this;var s=wt,a=Object,u=a.create,y=Object.getPrototypeOf(this),O=this.ea;return s=s(u.call(a,y,{ea:{value:{count:O.count,pa:O.pa,ra:O.ra,ga:O.ga,ha:O.ha,ka:O.ka,ma:O.ma}}})),s.ea.count.value+=1,s.ea.pa=!1,s},ct.prototype.delete=function(){this.ea.ga||sn(this),this.ea.pa&&!this.ea.ra&&we("Object already scheduled for deletion"),Hn(this),Wn(this.ea),this.ea.ra||(this.ea.ka=void 0,this.ea.ga=void 0)},ct.prototype.isDeleted=function(){return!this.ea.ga},ct.prototype.deleteLater=function(){return this.ea.ga||sn(this),this.ea.pa&&!this.ea.ra&&we("Object already scheduled for deletion"),St.push(this),St.length===1&&bt&&bt(cn),this.ea.pa=!0,this},ot.prototype.Pa=function(s){return this.Ia&&(s=this.Ia(s)),s},ot.prototype.Ga=function(s){this.la&&this.la(s)},ot.prototype.argPackAdvance=8,ot.prototype.readValueFromPointer=Ye,ot.prototype.deleteObject=function(s){s!==null&&s.delete()},ot.prototype.fromWireType=function(s){function a(){return this.wa?Ct(this.fa.qa,{ha:this.Sa,ga:u,ma:this,ka:s}):Ct(this.fa.qa,{ha:this,ga:s})}var u=this.Pa(s);if(!u)return this.Ga(s),null;var y=ar(this.fa,u);if(y!==void 0)return y.ea.count.value===0?(y.ea.ga=u,y.ea.ka=s,y.clone()):(y=y.clone(),this.Ga(s),y);if(y=this.fa.Oa(u),y=Gn[y],!y)return a.call(this);y=this.va?y.Ja:y.pointerType;var O=zn(u,this.fa,y.fa);return O===null?a.call(this):this.wa?Ct(y.fa.qa,{ha:y,ga:O,ma:this,ka:s}):Ct(y.fa.qa,{ha:y,ga:O})},r.getInheritedInstanceCount=function(){return Object.keys(_t).length},r.getLiveInheritedInstances=function(){var s=[],a;for(a in _t)_t.hasOwnProperty(a)&&s.push(_t[a]);return s},r.flushPendingDeletes=cn,r.setDelayFunction=function(s){bt=s,St.length&&bt&&bt(cn)},Yn=r.UnboundTypeError=ee("UnboundTypeError"),r.count_emval_handles=function(){for(var s=0,a=5;a<it.length;++a)it[a]!==void 0&&++s;return s},r.get_first_emval=function(){for(var s=5;s<it.length;++s)if(it[s]!==void 0)return it[s];return null};var mr={r:function(s){var a=de[s];delete de[s];var u=a.elements,y=u.length,O=u.map(function(V){return V.Aa}).concat(u.map(function(V){return V.Ea})),L=a.sa,W=a.la;pe([s],O,function(V){return u.forEach(function(G,Z){var Q=V[Z],ie=G.ya,_e=G.za,De=V[Z+y],Te=G.Da,We=G.Fa;G.read=Ge=>Q.fromWireType(ie(_e,Ge)),G.write=(Ge,ft)=>{var Qe=[];Te(We,Ge,De.toWireType(Qe,ft)),be(Qe)}}),[{name:a.name,fromWireType:function(G){for(var Z=Array(y),Q=0;Q<y;++Q)Z[Q]=u[Q].read(G);return W(G),Z},toWireType:function(G,Z){if(y!==Z.length)throw new TypeError("Incorrect number of tuple elements for "+a.name+": expected="+y+", actual="+Z.length);for(var Q=L(),ie=0;ie<y;++ie)u[ie].write(Q,Z[ie]);return G!==null&&G.push(W,Q),Q},argPackAdvance:8,readValueFromPointer:Ye,ja:W}]})},u:function(s){var a=Ae[s];delete Ae[s];var u=a.sa,y=a.la,O=a.Ha,L=O.map(function(W){return W.Aa}).concat(O.map(function(W){return W.Ea}));pe([s],L,function(W){var V={};return O.forEach(function(G,Z){var Q=W[Z],ie=G.ya,_e=G.za,De=W[Z+O.length],Te=G.Da,We=G.Fa;V[G.Na]={read:function(Ge){return Q.fromWireType(ie(_e,Ge))},write:function(Ge,ft){var Qe=[];Te(We,Ge,De.toWireType(Qe,ft)),be(Qe)}}}),[{name:a.name,fromWireType:function(G){var Z={},Q;for(Q in V)Z[Q]=V[Q].read(G);return y(G),Z},toWireType:function(G,Z){for(var Q in V)if(!(Q in Z))throw new TypeError('Missing field:  "'+Q+'"');var ie=u();for(Q in V)V[Q].write(ie,Z[Q]);return G!==null&&G.push(y,ie),ie},argPackAdvance:8,readValueFromPointer:Ye,ja:y}]})},z:function(){},F:function(s,a,u,y,O){var L=ye(u);a=Se(a),rt(s,{name:a,fromWireType:function(W){return!!W},toWireType:function(W,V){return V?y:O},argPackAdvance:8,readValueFromPointer:function(W){if(u===1)var V=he;else if(u===2)V=Ie;else if(u===4)V=ve;else throw new TypeError("Unknown boolean type size: "+a);return this.fromWireType(V[W>>L])},ja:null})},l:function(s,a,u,y,O,L,W,V,G,Z,Q,ie,_e){Q=Se(Q),L=He(O,L),V&&(V=He(W,V)),Z&&(Z=He(G,Z)),_e=He(ie,_e);var De=U(Q);un(De,function(){At("Cannot construct "+Q+" due to unbound types",[y])}),pe([s,a,u],y?[y]:[],function(Te){if(Te=Te[0],y)var We=Te.fa,Ge=We.qa;else Ge=ct.prototype;Te=H(De,function(){if(Object.getPrototypeOf(this)!==ft)throw new Xe("Use 'new' to construct "+Q);if(Qe.oa===void 0)throw new Xe(Q+" has no accessible constructor");var oi=Qe.oa[arguments.length];if(oi===void 0)throw new Xe("Tried to invoke ctor of "+Q+" with invalid number of parameters ("+arguments.length+") - expected ("+Object.keys(Qe.oa).toString()+") parameters instead!");return oi.apply(this,arguments)});var ft=Object.create(Ge,{constructor:{value:Te}});Te.prototype=ft;var Qe=new nr(Q,Te,ft,_e,We,L,V,Z);We=new ot(Q,Qe,!0,!1),Ge=new ot(Q+"*",Qe,!1,!1);var ri=new ot(Q+" const*",Qe,!1,!0);return Gn[s]={pointerType:Ge,Ja:ri},Kn(De,Te),[We,Ge,ri]})},i:function(s,a,u,y,O,L){0<a||te(void 0);var W=fn(a,u);O=He(y,O),pe([],[s],function(V){V=V[0];var G="constructor "+V.name;if(V.fa.oa===void 0&&(V.fa.oa=[]),V.fa.oa[a-1]!==void 0)throw new Xe("Cannot register multiple constructors with identical number of parameters ("+(a-1)+") for class '"+V.name+"'! Overload resolution is currently only performed using the parameter count, not actual type info!");return V.fa.oa[a-1]=()=>{At("Cannot construct "+V.name+" due to unbound types",W)},pe([],W,function(Z){return Z.splice(1,0,null),V.fa.oa[a-1]=pn(G,Z,null,O,L),[]}),[]})},a:function(s,a,u,y,O,L,W,V){var G=fn(u,y);a=Se(a),L=He(O,L),pe([],[s],function(Z){function Q(){At("Cannot call "+ie+" due to unbound types",G)}Z=Z[0];var ie=Z.name+"."+a;a.startsWith("@@")&&(a=Symbol[a.substring(2)]),V&&Z.fa.Ta.push(a);var _e=Z.fa.qa,De=_e[a];return De===void 0||De.ia===void 0&&De.className!==Z.name&&De.ua===u-2?(Q.ua=u-2,Q.className=Z.name,_e[a]=Q):(qn(_e,a,ie),_e[a].ia[u-2]=Q),pe([],G,function(Te){return Te=pn(ie,Te,Z,L,W),_e[a].ia===void 0?(Te.ua=u-2,_e[a]=Te):_e[a].ia[u-2]=Te,[]}),[]})},I:function(s,a,u){s=Se(s),pe([],[a],function(y){return y=y[0],r[s]=y.fromWireType(u),[]})},E:function(s,a){a=Se(a),rt(s,{name:a,fromWireType:function(u){var y=gn(u);return Qn(u),y},toWireType:function(u,y){return ut(y)},argPackAdvance:8,readValueFromPointer:Ye,ja:null})},h:function(s,a,u,y){function O(){}u=ye(u),a=Se(a),O.values={},rt(s,{name:a,constructor:O,fromWireType:function(L){return this.constructor.values[L]},toWireType:function(L,W){return W.value},argPackAdvance:8,readValueFromPointer:lr(a,u,y),ja:null}),un(a,O)},k:function(s,a,u){var y=Dt(s,"enum");a=Se(a),s=y.constructor,y=Object.create(y.constructor.prototype,{value:{value:u},constructor:{value:H(y.name+"_"+a,function(){})}}),s.values[u]=y,s[a]=y},q:function(s,a,u){u=ye(u),a=Se(a),rt(s,{name:a,fromWireType:function(y){return y},toWireType:function(y,O){return O},argPackAdvance:8,readValueFromPointer:cr(a,u),ja:null})},f:function(s,a,u,y,O,L){var W=fn(a,u);s=Se(s),O=He(y,O),un(s,function(){At("Cannot call "+s+" due to unbound types",W)},a-1),pe([],W,function(V){return V=[V[0],null].concat(V.slice(1)),Kn(s,pn(s,V,null,O,L),a-1),[]})},e:function(s,a,u,y,O){a=Se(a),O===-1&&(O=4294967295),O=ye(u);var L=V=>V;if(y===0){var W=32-8*u;L=V=>V<<W>>>W}u=a.includes("unsigned")?function(V,G){return G>>>0}:function(V,G){return G},rt(s,{name:a,fromWireType:L,toWireType:u,argPackAdvance:8,readValueFromPointer:ur(a,O,y!==0),ja:null})},b:function(s,a,u){function y(L){L>>=2;var W=Me;return new O(me,W[L+1],W[L])}var O=[Int8Array,Uint8Array,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array][a];u=Se(u),rt(s,{name:u,fromWireType:y,argPackAdvance:8,readValueFromPointer:y},{Qa:!0})},p:function(s,a){a=Se(a);var u=a==="std::string";rt(s,{name:a,fromWireType:function(y){var O=Me[y>>2];if(u)for(var L=y+4,W=0;W<=O;++W){var V=y+4+W;if(W==O||se[V]==0){if(L=L?I(se,L,V-L):"",G===void 0)var G=L;else G+=String.fromCharCode(0),G+=L;L=V+1}}else{for(G=Array(O),W=0;W<O;++W)G[W]=String.fromCharCode(se[y+4+W]);G=G.join("")}return at(y),G},toWireType:function(y,O){O instanceof ArrayBuffer&&(O=new Uint8Array(O));var L=typeof O=="string";L||O instanceof Uint8Array||O instanceof Uint8ClampedArray||O instanceof Int8Array||we("Cannot pass non-string to std::string");var W=(u&&L?()=>{for(var Z=0,Q=0;Q<O.length;++Q){var ie=O.charCodeAt(Q);55296<=ie&&57343>=ie&&(ie=65536+((ie&1023)<<10)|O.charCodeAt(++Q)&1023),127>=ie?++Z:Z=2047>=ie?Z+2:65535>=ie?Z+3:Z+4}return Z}:()=>O.length)(),V=In(4+W+1);if(Me[V>>2]=W,u&&L)d(O,V+4,W+1);else if(L)for(L=0;L<W;++L){var G=O.charCodeAt(L);255<G&&(at(V),we("String has UTF-16 code units that do not fit in 8 bits")),se[V+4+L]=G}else for(L=0;L<W;++L)se[V+4+L]=O[L];return y!==null&&y.push(at,V),V},argPackAdvance:8,readValueFromPointer:Ye,ja:function(y){at(y)}})},m:function(s,a,u){if(u=Se(u),a===2)var y=$,O=re,L=oe,W=()=>Re,V=1;else a===4&&(y=ae,O=Y,L=fe,W=()=>Me,V=2);rt(s,{name:u,fromWireType:function(G){for(var Z=Me[G>>2],Q=W(),ie,_e=G+4,De=0;De<=Z;++De){var Te=G+4+De*a;(De==Z||Q[Te>>V]==0)&&(_e=y(_e,Te-_e),ie===void 0?ie=_e:(ie+=String.fromCharCode(0),ie+=_e),_e=Te+a)}return at(G),ie},toWireType:function(G,Z){typeof Z!="string"&&we("Cannot pass non-string to C++ string type "+u);var Q=L(Z),ie=In(4+Q+a);return Me[ie>>2]=Q>>V,O(Z,ie+4,Q+a),G!==null&&G.push(at,ie),ie},argPackAdvance:8,readValueFromPointer:Ye,ja:function(G){at(G)}})},t:function(s,a,u,y,O,L){de[s]={name:Se(a),sa:He(u,y),la:He(O,L),elements:[]}},s:function(s,a,u,y,O,L,W,V,G){de[s].elements.push({Aa:a,ya:He(u,y),za:O,Ea:L,Da:He(W,V),Fa:G})},v:function(s,a,u,y,O,L){Ae[s]={name:Se(a),sa:He(u,y),la:He(O,L),Ha:[]}},j:function(s,a,u,y,O,L,W,V,G,Z){Ae[s].Ha.push({Na:Se(a),Aa:u,ya:He(y,O),za:L,Ea:W,Da:He(V,G),Fa:Z})},G:function(s,a){a=Se(a),rt(s,{Ra:!0,name:a,argPackAdvance:0,fromWireType:function(){},toWireType:function(){}})},d:function(s,a,u,y){s=vn[s],a=gn(a),u=yn(u),s(a,u,null,y)},J:Qn,x:function(s){return s===0?ut(Jn()):(s=yn(s),ut(Jn()[s]))},c:function(s,a){var u=pr(s,a),y=u[0];a=y.name+"_$"+u.slice(1).map(function(W){return W.name}).join("_")+"$";var O=ei[a];if(O!==void 0)return O;var L=Array(s-1);return O=fr((W,V,G,Z)=>{for(var Q=0,ie=0;ie<s-1;++ie)L[ie]=u[ie+1].readValueFromPointer(Z+Q),Q+=u[ie+1].argPackAdvance;for(W=W[V].apply(W,L),ie=0;ie<s-1;++ie)u[ie+1].Ka&&u[ie+1].Ka(L[ie]);if(!y.Ra)return y.toWireType(G,W)}),ei[a]=O},n:function(s){4<s&&(it[s].Ca+=1)},w:function(s,a,u,y){s=gn(s);var O=ti[a];return O||(O=hr(a),ti[a]=O),O(s,u,y)},K:function(){return ut([])},D:function(s){return ut(yn(s))},H:function(s,a){return s=Dt(s,"_emval_take_value"),s=s.readValueFromPointer(a),ut(s)},g:function(){te("")},B:function(s){var a=se.length;if(s>>>=0,2147483648<s)return!1;for(var u=1;4>=u;u*=2){var y=a*(1+.2/u);y=Math.min(y,s+100663296),y=Math.max(s,y),0<y%65536&&(y+=65536-y%65536);e:{try{T.grow(Math.min(2147483648,y)-me.byteLength+65535>>>16),je();var O=1;break e}catch{}O=void 0}if(O)return!0}return!1},C:function(){return 0},y:function(){},o:function(s,a,u,y){for(var O=0,L=0;L<u;L++){var W=ve[a>>2],V=ve[a+4>>2];a+=8;for(var G=0;G<V;G++){var Z=se[W+G],Q=gr[s];Z===0||Z===10?((s===1?F:B)(I(Q,0)),Q.length=0):Q.push(Z)}O+=V}return ve[y>>2]=O,0},A:function(){}};(function(){function s(O){r.asm=O.exports,T=r.asm.L,je(),K=r.asm._,f.unshift(r.asm.M),X--,r.monitorRunDependencies&&r.monitorRunDependencies(X),X==0&&q&&(O=q,q=null,O())}function a(O){s(O.instance)}function u(O){return Ce().then(function(L){return WebAssembly.instantiate(L,y)}).then(function(L){return L}).then(O,function(L){B("failed to asynchronously prepare wasm: "+L),te(L)})}var y={a:mr};if(X++,r.monitorRunDependencies&&r.monitorRunDependencies(X),r.instantiateWasm)try{return r.instantiateWasm(y,s)}catch(O){return B("Module.instantiateWasm callback failed with error: "+O),!1}return function(){return J||typeof WebAssembly.instantiateStreaming!="function"||ue()||le.startsWith("file://")||typeof fetch!="function"?u(a):fetch(le,{credentials:"same-origin"}).then(function(O){return WebAssembly.instantiateStreaming(O,y).then(a,function(L){return B("wasm streaming compile failed: "+L),B("falling back to ArrayBuffer instantiation"),u(a)})})}().catch(m),{}})(),r.___wasm_call_ctors=function(){return(r.___wasm_call_ctors=r.asm.M).apply(null,arguments)},r.__Z6ToCmdsRK6SkPath=function(){return(r.__Z6ToCmdsRK6SkPath=r.asm.N).apply(null,arguments)},r.__Z8FromCmdsmi=function(){return(r.__Z8FromCmdsmi=r.asm.O).apply(null,arguments)},r.__Z7NewPathv=function(){return(r.__Z7NewPathv=r.asm.P).apply(null,arguments)},r.__Z8CopyPathRK6SkPath=function(){return(r.__Z8CopyPathRK6SkPath=r.asm.Q).apply(null,arguments)},r.__Z6EqualsRK6SkPathS1_=function(){return(r.__Z6EqualsRK6SkPathS1_=r.asm.R).apply(null,arguments)},r.__Z11ToSVGStringRK6SkPath=function(){return(r.__Z11ToSVGStringRK6SkPath=r.asm.S).apply(null,arguments)},r.__Z13FromSVGStringNSt3__212basic_stringIcNS_11char_traitsIcEENS_9allocatorIcEEEE=function(){return(r.__Z13FromSVGStringNSt3__212basic_stringIcNS_11char_traitsIcEENS_9allocatorIcEEEE=r.asm.T).apply(null,arguments)},r.__Z13ApplySimplifyR6SkPath=function(){return(r.__Z13ApplySimplifyR6SkPath=r.asm.U).apply(null,arguments)},r.__Z11ApplyPathOpR6SkPathRKS_8SkPathOp=function(){return(r.__Z11ApplyPathOpR6SkPathRKS_8SkPathOp=r.asm.V).apply(null,arguments)},r.__Z10MakeFromOpRK6SkPathS1_8SkPathOp=function(){return(r.__Z10MakeFromOpRK6SkPathS1_8SkPathOp=r.asm.W).apply(null,arguments)},r.__Z14ResolveBuilderR11SkOpBuilder=function(){return(r.__Z14ResolveBuilderR11SkOpBuilder=r.asm.X).apply(null,arguments)},r.__Z8ToCanvasRK6SkPathN10emscripten3valE=function(){return(r.__Z8ToCanvasRK6SkPathN10emscripten3valE=r.asm.Y).apply(null,arguments)},r.__Z8ToPath2DRK6SkPath=function(){return(r.__Z8ToPath2DRK6SkPath=r.asm.Z).apply(null,arguments)};var at=r._free=function(){return(at=r._free=r.asm.$).apply(null,arguments)},In=r._malloc=function(){return(In=r._malloc=r.asm.aa).apply(null,arguments)},ii=r.___getTypeName=function(){return(ii=r.___getTypeName=r.asm.ba).apply(null,arguments)};r.___embind_register_native_and_builtin_types=function(){return(r.___embind_register_native_and_builtin_types=r.asm.ca).apply(null,arguments)},r.dynCall_jiji=function(){return(r.dynCall_jiji=r.asm.da).apply(null,arguments)};var $t;q=function s(){$t||En(),$t||(q=s)};function En(){function s(){if(!$t&&($t=!0,r.calledRun=!0,!v)){if(xe(f),p(r),r.onRuntimeInitialized&&r.onRuntimeInitialized(),r.postRun)for(typeof r.postRun=="function"&&(r.postRun=[r.postRun]);r.postRun.length;){var a=r.postRun.shift();b.unshift(a)}xe(b)}}if(!(0<X)){if(r.preRun)for(typeof r.preRun=="function"&&(r.preRun=[r.preRun]);r.preRun.length;)j();xe(l),0<X||(r.setStatus?(r.setStatus("Running..."),setTimeout(function(){setTimeout(function(){r.setStatus("")},1),s()},1)):s())}}if(r.run=En,r.preInit)for(typeof r.preInit=="function"&&(r.preInit=[r.preInit]);0<r.preInit.length;)r.preInit.pop()();return En(),o.ready}})();i.exports=t})(xi);var xr=xi.exports;const Cr=Xn(xr),Ar="/assets/pathkit-1356ccfa.wasm";class Ln{startTime;accumulatedTime;constructor(){this.startTime=-1,this.accumulatedTime=-1}start(){this.startTime=performance.now(),this.accumulatedTime=0}resume(){this.startTime=performance.now()}pause(){return this.accumulatedTime+=performance.now()-this.startTime,this.startTime=-1,this.accumulatedTime}stop(){if(this.startTime!=-1){const e=performance.now()-this.startTime+this.accumulatedTime;return this.accumulatedTime=0,e}else{const e=this.accumulatedTime;return this.accumulatedTime=0,e}}}function Lt(i){throw new Error('Could not dynamically require "'+i+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var Ci={exports:{}};(function(i,e){(function(t){i.exports=t()})(function(){return function t(n,o,r){function c(E,w){if(!o[E]){if(!n[E]){var k=typeof Lt=="function"&&Lt;if(!w&&k)return k(E,!0);if(p)return p(E,!0);throw new Error("Cannot find module '"+E+"'")}w=o[E]={exports:{}},n[E][0].call(w.exports,function(C){var z=n[E][1][C];return c(z||C)},w,w.exports,t,n,o,r)}return o[E].exports}for(var p=typeof Lt=="function"&&Lt,m=0;m<r.length;m++)c(r[m]);return c}({1:[function(t,n,o){(function(r,c,p,m,E,w,k,C,z){var N=t("crypto");function R(T,v){v=D(T,v);var h;return(h=v.algorithm!=="passthrough"?N.createHash(v.algorithm):new J).write===void 0&&(h.write=h.update,h.end=h.update),B(v,h).dispatch(T),h.update||h.end(""),h.digest?h.digest(v.encoding==="buffer"?void 0:v.encoding):(T=h.read(),v.encoding!=="buffer"?T.toString(v.encoding):T)}(o=n.exports=R).sha1=function(T){return R(T)},o.keys=function(T){return R(T,{excludeValues:!0,algorithm:"sha1",encoding:"hex"})},o.MD5=function(T){return R(T,{algorithm:"md5",encoding:"hex"})},o.keysMD5=function(T){return R(T,{algorithm:"md5",encoding:"hex",excludeValues:!0})};var x=N.getHashes?N.getHashes().slice():["sha1","md5"],M=(x.push("passthrough"),["buffer","hex","binary","base64"]);function D(T,v){var h={};if(h.algorithm=(v=v||{}).algorithm||"sha1",h.encoding=v.encoding||"hex",h.excludeValues=!!v.excludeValues,h.algorithm=h.algorithm.toLowerCase(),h.encoding=h.encoding.toLowerCase(),h.ignoreUnknown=v.ignoreUnknown===!0,h.respectType=v.respectType!==!1,h.respectFunctionNames=v.respectFunctionNames!==!1,h.respectFunctionProperties=v.respectFunctionProperties!==!1,h.unorderedArrays=v.unorderedArrays===!0,h.unorderedSets=v.unorderedSets!==!1,h.unorderedObjects=v.unorderedObjects!==!1,h.replacer=v.replacer||void 0,h.excludeKeys=v.excludeKeys||void 0,T===void 0)throw new Error("Object argument required.");for(var I=0;I<x.length;++I)x[I].toLowerCase()===h.algorithm.toLowerCase()&&(h.algorithm=x[I]);if(x.indexOf(h.algorithm)===-1)throw new Error('Algorithm "'+h.algorithm+'"  not supported. supported values: '+x.join(", "));if(M.indexOf(h.encoding)===-1&&h.algorithm!=="passthrough")throw new Error('Encoding "'+h.encoding+'"  not supported. supported values: '+M.join(", "));return h}function F(T){if(typeof T=="function")return/^function\s+\w*\s*\(\s*\)\s*{\s+\[native code\]\s+}$/i.exec(Function.prototype.toString.call(T))!=null}function B(T,v,h){h=h||[];function I(d){return v.update?v.update(d,"utf8"):v.write(d,"utf8")}return{dispatch:function(d){return this["_"+((d=T.replacer?T.replacer(d):d)===null?"null":typeof d)](d)},_object:function(d){var _,$=Object.prototype.toString.call(d),re=/\[object (.*)\]/i.exec($);if(re=(re=re?re[1]:"unknown:["+$+"]").toLowerCase(),0<=($=h.indexOf(d)))return this.dispatch("[CIRCULAR:"+$+"]");if(h.push(d),p!==void 0&&p.isBuffer&&p.isBuffer(d))return I("buffer:"),I(d);if(re==="object"||re==="function"||re==="asyncfunction")return $=Object.keys(d),T.unorderedObjects&&($=$.sort()),T.respectType===!1||F(d)||$.splice(0,0,"prototype","__proto__","constructor"),T.excludeKeys&&($=$.filter(function(oe){return!T.excludeKeys(oe)})),I("object:"+$.length+":"),_=this,$.forEach(function(oe){_.dispatch(oe),I(":"),T.excludeValues||_.dispatch(d[oe]),I(",")});if(!this["_"+re]){if(T.ignoreUnknown)return I("["+re+"]");throw new Error('Unknown object type "'+re+'"')}this["_"+re](d)},_array:function(d,oe){oe=oe!==void 0?oe:T.unorderedArrays!==!1;var $=this;if(I("array:"+d.length+":"),!oe||d.length<=1)return d.forEach(function(ae){return $.dispatch(ae)});var re=[],oe=d.map(function(ae){var Y=new J,fe=h.slice();return B(T,Y,fe).dispatch(ae),re=re.concat(fe.slice(h.length)),Y.read().toString()});return h=h.concat(re),oe.sort(),this._array(oe,!1)},_date:function(d){return I("date:"+d.toJSON())},_symbol:function(d){return I("symbol:"+d.toString())},_error:function(d){return I("error:"+d.toString())},_boolean:function(d){return I("bool:"+d.toString())},_string:function(d){I("string:"+d.length+":"),I(d.toString())},_function:function(d){I("fn:"),F(d)?this.dispatch("[native]"):this.dispatch(d.toString()),T.respectFunctionNames!==!1&&this.dispatch("function-name:"+String(d.name)),T.respectFunctionProperties&&this._object(d)},_number:function(d){return I("number:"+d.toString())},_xml:function(d){return I("xml:"+d.toString())},_null:function(){return I("Null")},_undefined:function(){return I("Undefined")},_regexp:function(d){return I("regex:"+d.toString())},_uint8array:function(d){return I("uint8array:"),this.dispatch(Array.prototype.slice.call(d))},_uint8clampedarray:function(d){return I("uint8clampedarray:"),this.dispatch(Array.prototype.slice.call(d))},_int8array:function(d){return I("int8array:"),this.dispatch(Array.prototype.slice.call(d))},_uint16array:function(d){return I("uint16array:"),this.dispatch(Array.prototype.slice.call(d))},_int16array:function(d){return I("int16array:"),this.dispatch(Array.prototype.slice.call(d))},_uint32array:function(d){return I("uint32array:"),this.dispatch(Array.prototype.slice.call(d))},_int32array:function(d){return I("int32array:"),this.dispatch(Array.prototype.slice.call(d))},_float32array:function(d){return I("float32array:"),this.dispatch(Array.prototype.slice.call(d))},_float64array:function(d){return I("float64array:"),this.dispatch(Array.prototype.slice.call(d))},_arraybuffer:function(d){return I("arraybuffer:"),this.dispatch(new Uint8Array(d))},_url:function(d){return I("url:"+d.toString())},_map:function(d){return I("map:"),d=Array.from(d),this._array(d,T.unorderedSets!==!1)},_set:function(d){return I("set:"),d=Array.from(d),this._array(d,T.unorderedSets!==!1)},_file:function(d){return I("file:"),this.dispatch([d.name,d.size,d.type,d.lastModfied])},_blob:function(){if(T.ignoreUnknown)return I("[blob]");throw Error(`Hashing Blob objects is currently not supported
(see https://github.com/puleos/object-hash/issues/26)
Use "options.replacer" or "options.ignoreUnknown"
`)},_domwindow:function(){return I("domwindow")},_bigint:function(d){return I("bigint:"+d.toString())},_process:function(){return I("process")},_timer:function(){return I("timer")},_pipe:function(){return I("pipe")},_tcp:function(){return I("tcp")},_udp:function(){return I("udp")},_tty:function(){return I("tty")},_statwatcher:function(){return I("statwatcher")},_securecontext:function(){return I("securecontext")},_connection:function(){return I("connection")},_zlib:function(){return I("zlib")},_context:function(){return I("context")},_nodescript:function(){return I("nodescript")},_httpparser:function(){return I("httpparser")},_dataview:function(){return I("dataview")},_signal:function(){return I("signal")},_fsevent:function(){return I("fsevent")},_tlswrap:function(){return I("tlswrap")}}}function J(){return{buf:"",write:function(T){this.buf+=T},end:function(T){this.buf+=T},read:function(){return this.buf}}}o.writeToStream=function(T,v,h){return h===void 0&&(h=v,v={}),B(v=D(T,v),h).dispatch(T)}}).call(this,t("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},t("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/fake_9a5aa49d.js","/")},{buffer:3,crypto:5,lYpoI2:11}],2:[function(t,n,o){(function(r,c,p,m,E,w,k,C,z){(function(N){var R=typeof Uint8Array<"u"?Uint8Array:Array,x="+".charCodeAt(0),M="/".charCodeAt(0),D="0".charCodeAt(0),F="a".charCodeAt(0),B="A".charCodeAt(0),J="-".charCodeAt(0),T="_".charCodeAt(0);function v(h){return h=h.charCodeAt(0),h===x||h===J?62:h===M||h===T?63:h<D?-1:h<D+10?h-D+26+26:h<B+26?h-B:h<F+26?h-F+26:void 0}N.toByteArray=function(h){var I,d;if(0<h.length%4)throw new Error("Invalid string. Length must be a multiple of 4");var _=h.length,_=h.charAt(_-2)==="="?2:h.charAt(_-1)==="="?1:0,$=new R(3*h.length/4-_),re=0<_?h.length-4:h.length,oe=0;function ae(Y){$[oe++]=Y}for(I=0;I<re;I+=4,0)ae((16711680&(d=v(h.charAt(I))<<18|v(h.charAt(I+1))<<12|v(h.charAt(I+2))<<6|v(h.charAt(I+3))))>>16),ae((65280&d)>>8),ae(255&d);return _==2?ae(255&(d=v(h.charAt(I))<<2|v(h.charAt(I+1))>>4)):_==1&&(ae((d=v(h.charAt(I))<<10|v(h.charAt(I+1))<<4|v(h.charAt(I+2))>>2)>>8&255),ae(255&d)),$},N.fromByteArray=function(h){var I,d,_,$,re=h.length%3,oe="";function ae(Y){return"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(Y)}for(I=0,_=h.length-re;I<_;I+=3)d=(h[I]<<16)+(h[I+1]<<8)+h[I+2],oe+=ae(($=d)>>18&63)+ae($>>12&63)+ae($>>6&63)+ae(63&$);switch(re){case 1:oe=(oe+=ae((d=h[h.length-1])>>2))+ae(d<<4&63)+"==";break;case 2:oe=(oe=(oe+=ae((d=(h[h.length-2]<<8)+h[h.length-1])>>10))+ae(d>>4&63))+ae(d<<2&63)+"="}return oe}})(o===void 0?this.base64js={}:o)}).call(this,t("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},t("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/base64-js/lib/b64.js","/node_modules/gulp-browserify/node_modules/base64-js/lib")},{buffer:3,lYpoI2:11}],3:[function(t,n,o){(function(r,c,x,m,E,w,k,C,z){var N=t("base64-js"),R=t("ieee754");function x(l,f,b){if(!(this instanceof x))return new x(l,f,b);var j,X,q,te,ue=typeof l;if(f==="base64"&&ue=="string")for(l=(te=l).trim?te.trim():te.replace(/^\s+|\s+$/g,"");l.length%4!=0;)l+="=";if(ue=="number")j=me(l);else if(ue=="string")j=x.byteLength(l,f);else{if(ue!="object")throw new Error("First argument needs to be a number, array or string.");j=me(l.length)}if(x._useTypedArrays?X=x._augment(new Uint8Array(j)):((X=this).length=j,X._isBuffer=!0),x._useTypedArrays&&typeof l.byteLength=="number")X._set(l);else if(he(te=l)||x.isBuffer(te)||te&&typeof te=="object"&&typeof te.length=="number")for(q=0;q<j;q++)x.isBuffer(l)?X[q]=l.readUInt8(q):X[q]=l[q];else if(ue=="string")X.write(l,0,f);else if(ue=="number"&&!x._useTypedArrays&&!b)for(q=0;q<j;q++)X[q]=0;return X}function M(l,f,b,j){return x._charsWritten=ve(function(X){for(var q=[],te=0;te<X.length;te++)q.push(255&X.charCodeAt(te));return q}(f),l,b,j)}function D(l,f,b,j){return x._charsWritten=ve(function(X){for(var q,te,ue=[],le=0;le<X.length;le++)te=X.charCodeAt(le),q=te>>8,te=te%256,ue.push(te),ue.push(q);return ue}(f),l,b,j)}function F(l,f,b){var j="";b=Math.min(l.length,b);for(var X=f;X<b;X++)j+=String.fromCharCode(l[X]);return j}function B(l,f,b,q){q||(K(typeof b=="boolean","missing or invalid endian"),K(f!=null,"missing offset"),K(f+1<l.length,"Trying to read beyond buffer length"));var X,q=l.length;if(!(q<=f))return b?(X=l[f],f+1<q&&(X|=l[f+1]<<8)):(X=l[f]<<8,f+1<q&&(X|=l[f+1])),X}function J(l,f,b,q){q||(K(typeof b=="boolean","missing or invalid endian"),K(f!=null,"missing offset"),K(f+3<l.length,"Trying to read beyond buffer length"));var X,q=l.length;if(!(q<=f))return b?(f+2<q&&(X=l[f+2]<<16),f+1<q&&(X|=l[f+1]<<8),X|=l[f],f+3<q&&(X+=l[f+3]<<24>>>0)):(f+1<q&&(X=l[f+1]<<16),f+2<q&&(X|=l[f+2]<<8),f+3<q&&(X|=l[f+3]),X+=l[f]<<24>>>0),X}function T(l,f,b,j){if(j||(K(typeof b=="boolean","missing or invalid endian"),K(f!=null,"missing offset"),K(f+1<l.length,"Trying to read beyond buffer length")),!(l.length<=f))return j=B(l,f,b,!0),32768&j?-1*(65535-j+1):j}function v(l,f,b,j){if(j||(K(typeof b=="boolean","missing or invalid endian"),K(f!=null,"missing offset"),K(f+3<l.length,"Trying to read beyond buffer length")),!(l.length<=f))return j=J(l,f,b,!0),2147483648&j?-1*(4294967295-j+1):j}function h(l,f,b,j){return j||(K(typeof b=="boolean","missing or invalid endian"),K(f+3<l.length,"Trying to read beyond buffer length")),R.read(l,f,b,23,4)}function I(l,f,b,j){return j||(K(typeof b=="boolean","missing or invalid endian"),K(f+7<l.length,"Trying to read beyond buffer length")),R.read(l,f,b,52,8)}function d(l,f,b,j,X){if(X||(K(f!=null,"missing value"),K(typeof j=="boolean","missing or invalid endian"),K(b!=null,"missing offset"),K(b+1<l.length,"trying to write beyond buffer length"),Ee(f,65535)),X=l.length,!(X<=b))for(var q=0,te=Math.min(X-b,2);q<te;q++)l[b+q]=(f&255<<8*(j?q:1-q))>>>8*(j?q:1-q)}function _(l,f,b,j,X){if(X||(K(f!=null,"missing value"),K(typeof j=="boolean","missing or invalid endian"),K(b!=null,"missing offset"),K(b+3<l.length,"trying to write beyond buffer length"),Ee(f,4294967295)),X=l.length,!(X<=b))for(var q=0,te=Math.min(X-b,4);q<te;q++)l[b+q]=f>>>8*(j?q:3-q)&255}function $(l,f,b,j,X){X||(K(f!=null,"missing value"),K(typeof j=="boolean","missing or invalid endian"),K(b!=null,"missing offset"),K(b+1<l.length,"Trying to write beyond buffer length"),Be(f,32767,-32768)),l.length<=b||d(l,0<=f?f:65535+f+1,b,j,X)}function re(l,f,b,j,X){X||(K(f!=null,"missing value"),K(typeof j=="boolean","missing or invalid endian"),K(b!=null,"missing offset"),K(b+3<l.length,"Trying to write beyond buffer length"),Be(f,2147483647,-2147483648)),l.length<=b||_(l,0<=f?f:4294967295+f+1,b,j,X)}function oe(l,f,b,j,X){X||(K(f!=null,"missing value"),K(typeof j=="boolean","missing or invalid endian"),K(b!=null,"missing offset"),K(b+3<l.length,"Trying to write beyond buffer length"),je(f,34028234663852886e22,-34028234663852886e22)),l.length<=b||R.write(l,f,b,j,23,4)}function ae(l,f,b,j,X){X||(K(f!=null,"missing value"),K(typeof j=="boolean","missing or invalid endian"),K(b!=null,"missing offset"),K(b+7<l.length,"Trying to write beyond buffer length"),je(f,17976931348623157e292,-17976931348623157e292)),l.length<=b||R.write(l,f,b,j,52,8)}o.Buffer=x,o.SlowBuffer=x,o.INSPECT_MAX_BYTES=50,x.poolSize=8192,x._useTypedArrays=function(){try{var l=new ArrayBuffer(0),f=new Uint8Array(l);return f.foo=function(){return 42},f.foo()===42&&typeof f.subarray=="function"}catch{return!1}}(),x.isEncoding=function(l){switch(String(l).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"binary":case"base64":case"raw":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},x.isBuffer=function(l){return!(l==null||!l._isBuffer)},x.byteLength=function(l,f){var b;switch(l+="",f||"utf8"){case"hex":b=l.length/2;break;case"utf8":case"utf-8":b=Ie(l).length;break;case"ascii":case"binary":case"raw":b=l.length;break;case"base64":b=Re(l).length;break;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":b=2*l.length;break;default:throw new Error("Unknown encoding")}return b},x.concat=function(l,f){if(K(he(l),`Usage: Buffer.concat(list, [totalLength])
list should be an Array.`),l.length===0)return new x(0);if(l.length===1)return l[0];if(typeof f!="number")for(X=f=0;X<l.length;X++)f+=l[X].length;for(var b=new x(f),j=0,X=0;X<l.length;X++){var q=l[X];q.copy(b,j),j+=q.length}return b},x.prototype.write=function(l,f,b,j){isFinite(f)?isFinite(b)||(j=b,b=void 0):(le=j,j=f,f=b,b=le),f=Number(f)||0;var X,q,te,ue,le=this.length-f;switch((!b||le<(b=Number(b)))&&(b=le),j=String(j||"utf8").toLowerCase()){case"hex":X=function($e,Le,Ce,xe){Ce=Number(Ce)||0;var de=$e.length-Ce;(!xe||de<(xe=Number(xe)))&&(xe=de),K((de=Le.length)%2==0,"Invalid hex string"),de/2<xe&&(xe=de/2);for(var be=0;be<xe;be++){var Ye=parseInt(Le.substr(2*be,2),16);K(!isNaN(Ye),"Invalid hex string"),$e[Ce+be]=Ye}return x._charsWritten=2*be,be}(this,l,f,b);break;case"utf8":case"utf-8":q=this,te=f,ue=b,X=x._charsWritten=ve(Ie(l),q,te,ue);break;case"ascii":case"binary":X=M(this,l,f,b);break;case"base64":q=this,te=f,ue=b,X=x._charsWritten=ve(Re(l),q,te,ue);break;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":X=D(this,l,f,b);break;default:throw new Error("Unknown encoding")}return X},x.prototype.toString=function(l,f,b){var j,X,q,te,ue=this;if(l=String(l||"utf8").toLowerCase(),f=Number(f)||0,(b=b!==void 0?Number(b):ue.length)===f)return"";switch(l){case"hex":j=function(le,$e,Le){var Ce=le.length;(!$e||$e<0)&&($e=0),(!Le||Le<0||Ce<Le)&&(Le=Ce);for(var xe="",de=$e;de<Le;de++)xe+=se(le[de]);return xe}(ue,f,b);break;case"utf8":case"utf-8":j=function(le,$e,Le){var Ce="",xe="";Le=Math.min(le.length,Le);for(var de=$e;de<Le;de++)le[de]<=127?(Ce+=Me(xe)+String.fromCharCode(le[de]),xe=""):xe+="%"+le[de].toString(16);return Ce+Me(xe)}(ue,f,b);break;case"ascii":case"binary":j=F(ue,f,b);break;case"base64":X=ue,te=b,j=(q=f)===0&&te===X.length?N.fromByteArray(X):N.fromByteArray(X.slice(q,te));break;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":j=function(le,$e,Le){for(var Ce=le.slice($e,Le),xe="",de=0;de<Ce.length;de+=2)xe+=String.fromCharCode(Ce[de]+256*Ce[de+1]);return xe}(ue,f,b);break;default:throw new Error("Unknown encoding")}return j},x.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}},x.prototype.copy=function(l,f,b,j){if(f=f||0,(j=j||j===0?j:this.length)!==(b=b||0)&&l.length!==0&&this.length!==0){K(b<=j,"sourceEnd < sourceStart"),K(0<=f&&f<l.length,"targetStart out of bounds"),K(0<=b&&b<this.length,"sourceStart out of bounds"),K(0<=j&&j<=this.length,"sourceEnd out of bounds"),j>this.length&&(j=this.length);var X=(j=l.length-f<j-b?l.length-f+b:j)-b;if(X<100||!x._useTypedArrays)for(var q=0;q<X;q++)l[q+f]=this[q+b];else l._set(this.subarray(b,b+X),f)}},x.prototype.slice=function(l,f){var b=this.length;if(l=fe(l,b,0),f=fe(f,b,b),x._useTypedArrays)return x._augment(this.subarray(l,f));for(var j=f-l,X=new x(j,void 0,!0),q=0;q<j;q++)X[q]=this[q+l];return X},x.prototype.get=function(l){return console.log(".get() is deprecated. Access using array indexes instead."),this.readUInt8(l)},x.prototype.set=function(l,f){return console.log(".set() is deprecated. Access using array indexes instead."),this.writeUInt8(l,f)},x.prototype.readUInt8=function(l,f){if(f||(K(l!=null,"missing offset"),K(l<this.length,"Trying to read beyond buffer length")),!(l>=this.length))return this[l]},x.prototype.readUInt16LE=function(l,f){return B(this,l,!0,f)},x.prototype.readUInt16BE=function(l,f){return B(this,l,!1,f)},x.prototype.readUInt32LE=function(l,f){return J(this,l,!0,f)},x.prototype.readUInt32BE=function(l,f){return J(this,l,!1,f)},x.prototype.readInt8=function(l,f){if(f||(K(l!=null,"missing offset"),K(l<this.length,"Trying to read beyond buffer length")),!(l>=this.length))return 128&this[l]?-1*(255-this[l]+1):this[l]},x.prototype.readInt16LE=function(l,f){return T(this,l,!0,f)},x.prototype.readInt16BE=function(l,f){return T(this,l,!1,f)},x.prototype.readInt32LE=function(l,f){return v(this,l,!0,f)},x.prototype.readInt32BE=function(l,f){return v(this,l,!1,f)},x.prototype.readFloatLE=function(l,f){return h(this,l,!0,f)},x.prototype.readFloatBE=function(l,f){return h(this,l,!1,f)},x.prototype.readDoubleLE=function(l,f){return I(this,l,!0,f)},x.prototype.readDoubleBE=function(l,f){return I(this,l,!1,f)},x.prototype.writeUInt8=function(l,f,b){b||(K(l!=null,"missing value"),K(f!=null,"missing offset"),K(f<this.length,"trying to write beyond buffer length"),Ee(l,255)),f>=this.length||(this[f]=l)},x.prototype.writeUInt16LE=function(l,f,b){d(this,l,f,!0,b)},x.prototype.writeUInt16BE=function(l,f,b){d(this,l,f,!1,b)},x.prototype.writeUInt32LE=function(l,f,b){_(this,l,f,!0,b)},x.prototype.writeUInt32BE=function(l,f,b){_(this,l,f,!1,b)},x.prototype.writeInt8=function(l,f,b){b||(K(l!=null,"missing value"),K(f!=null,"missing offset"),K(f<this.length,"Trying to write beyond buffer length"),Be(l,127,-128)),f>=this.length||(0<=l?this.writeUInt8(l,f,b):this.writeUInt8(255+l+1,f,b))},x.prototype.writeInt16LE=function(l,f,b){$(this,l,f,!0,b)},x.prototype.writeInt16BE=function(l,f,b){$(this,l,f,!1,b)},x.prototype.writeInt32LE=function(l,f,b){re(this,l,f,!0,b)},x.prototype.writeInt32BE=function(l,f,b){re(this,l,f,!1,b)},x.prototype.writeFloatLE=function(l,f,b){oe(this,l,f,!0,b)},x.prototype.writeFloatBE=function(l,f,b){oe(this,l,f,!1,b)},x.prototype.writeDoubleLE=function(l,f,b){ae(this,l,f,!0,b)},x.prototype.writeDoubleBE=function(l,f,b){ae(this,l,f,!1,b)},x.prototype.fill=function(l,f,b){if(f=f||0,b=b||this.length,K(typeof(l=typeof(l=l||0)=="string"?l.charCodeAt(0):l)=="number"&&!isNaN(l),"value is not a number"),K(f<=b,"end < start"),b!==f&&this.length!==0){K(0<=f&&f<this.length,"start out of bounds"),K(0<=b&&b<=this.length,"end out of bounds");for(var j=f;j<b;j++)this[j]=l}},x.prototype.inspect=function(){for(var l=[],f=this.length,b=0;b<f;b++)if(l[b]=se(this[b]),b===o.INSPECT_MAX_BYTES){l[b+1]="...";break}return"<Buffer "+l.join(" ")+">"},x.prototype.toArrayBuffer=function(){if(typeof Uint8Array>"u")throw new Error("Buffer.toArrayBuffer not supported in this browser");if(x._useTypedArrays)return new x(this).buffer;for(var l=new Uint8Array(this.length),f=0,b=l.length;f<b;f+=1)l[f]=this[f];return l.buffer};var Y=x.prototype;function fe(l,f,b){return typeof l!="number"?b:f<=(l=~~l)?f:0<=l||0<=(l+=f)?l:0}function me(l){return(l=~~Math.ceil(+l))<0?0:l}function he(l){return(Array.isArray||function(f){return Object.prototype.toString.call(f)==="[object Array]"})(l)}function se(l){return l<16?"0"+l.toString(16):l.toString(16)}function Ie(l){for(var f=[],b=0;b<l.length;b++){var j=l.charCodeAt(b);if(j<=127)f.push(l.charCodeAt(b));else for(var X=b,q=(55296<=j&&j<=57343&&b++,encodeURIComponent(l.slice(X,b+1)).substr(1).split("%")),te=0;te<q.length;te++)f.push(parseInt(q[te],16))}return f}function Re(l){return N.toByteArray(l)}function ve(l,f,b,j){for(var X=0;X<j&&!(X+b>=f.length||X>=l.length);X++)f[X+b]=l[X];return X}function Me(l){try{return decodeURIComponent(l)}catch{return String.fromCharCode(65533)}}function Ee(l,f){K(typeof l=="number","cannot write a non-number as a number"),K(0<=l,"specified a negative value for writing an unsigned value"),K(l<=f,"value is larger than maximum value for type"),K(Math.floor(l)===l,"value has a fractional component")}function Be(l,f,b){K(typeof l=="number","cannot write a non-number as a number"),K(l<=f,"value larger than maximum allowed value"),K(b<=l,"value smaller than minimum allowed value"),K(Math.floor(l)===l,"value has a fractional component")}function je(l,f,b){K(typeof l=="number","cannot write a non-number as a number"),K(l<=f,"value larger than maximum allowed value"),K(b<=l,"value smaller than minimum allowed value")}function K(l,f){if(!l)throw new Error(f||"Failed assertion")}x._augment=function(l){return l._isBuffer=!0,l._get=l.get,l._set=l.set,l.get=Y.get,l.set=Y.set,l.write=Y.write,l.toString=Y.toString,l.toLocaleString=Y.toString,l.toJSON=Y.toJSON,l.copy=Y.copy,l.slice=Y.slice,l.readUInt8=Y.readUInt8,l.readUInt16LE=Y.readUInt16LE,l.readUInt16BE=Y.readUInt16BE,l.readUInt32LE=Y.readUInt32LE,l.readUInt32BE=Y.readUInt32BE,l.readInt8=Y.readInt8,l.readInt16LE=Y.readInt16LE,l.readInt16BE=Y.readInt16BE,l.readInt32LE=Y.readInt32LE,l.readInt32BE=Y.readInt32BE,l.readFloatLE=Y.readFloatLE,l.readFloatBE=Y.readFloatBE,l.readDoubleLE=Y.readDoubleLE,l.readDoubleBE=Y.readDoubleBE,l.writeUInt8=Y.writeUInt8,l.writeUInt16LE=Y.writeUInt16LE,l.writeUInt16BE=Y.writeUInt16BE,l.writeUInt32LE=Y.writeUInt32LE,l.writeUInt32BE=Y.writeUInt32BE,l.writeInt8=Y.writeInt8,l.writeInt16LE=Y.writeInt16LE,l.writeInt16BE=Y.writeInt16BE,l.writeInt32LE=Y.writeInt32LE,l.writeInt32BE=Y.writeInt32BE,l.writeFloatLE=Y.writeFloatLE,l.writeFloatBE=Y.writeFloatBE,l.writeDoubleLE=Y.writeDoubleLE,l.writeDoubleBE=Y.writeDoubleBE,l.fill=Y.fill,l.inspect=Y.inspect,l.toArrayBuffer=Y.toArrayBuffer,l}}).call(this,t("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},t("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/buffer/index.js","/node_modules/gulp-browserify/node_modules/buffer")},{"base64-js":2,buffer:3,ieee754:10,lYpoI2:11}],4:[function(t,n,o){(function(r,c,N,m,E,w,k,C,z){var N=t("buffer").Buffer,R=4,x=new N(R);x.fill(0),n.exports={hash:function(M,D,F,B){for(var J=D(function(d,_){d.length%R!=0&&($=d.length+(R-d.length%R),d=N.concat([d,x],$));for(var $,re=[],oe=_?d.readInt32BE:d.readInt32LE,ae=0;ae<d.length;ae+=R)re.push(oe.call(d,ae));return re}(M=N.isBuffer(M)?M:new N(M),B),8*M.length),D=B,T=new N(F),v=D?T.writeInt32BE:T.writeInt32LE,h=0;h<J.length;h++)v.call(T,J[h],4*h,!0);return T}}}).call(this,t("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},t("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/crypto-browserify/helpers.js","/node_modules/gulp-browserify/node_modules/crypto-browserify")},{buffer:3,lYpoI2:11}],5:[function(t,n,o){(function(r,c,N,m,E,w,k,C,z){var N=t("buffer").Buffer,R=t("./sha"),x=t("./sha256"),M=t("./rng"),D={sha1:R,sha256:x,md5:t("./md5")},F=64,B=new N(F);function J(d,_){var $=D[d=d||"sha1"],re=[];return $||T("algorithm:",d,"is not yet supported"),{update:function(oe){return N.isBuffer(oe)||(oe=new N(oe)),re.push(oe),oe.length,this},digest:function(oe){var ae=N.concat(re),ae=_?function(Y,fe,me){N.isBuffer(fe)||(fe=new N(fe)),N.isBuffer(me)||(me=new N(me)),fe.length>F?fe=Y(fe):fe.length<F&&(fe=N.concat([fe,B],F));for(var he=new N(F),se=new N(F),Ie=0;Ie<F;Ie++)he[Ie]=54^fe[Ie],se[Ie]=92^fe[Ie];return me=Y(N.concat([he,me])),Y(N.concat([se,me]))}($,_,ae):$(ae);return re=null,oe?ae.toString(oe):ae}}}function T(){var d=[].slice.call(arguments).join(" ");throw new Error([d,"we accept pull requests","http://github.com/dominictarr/crypto-browserify"].join(`
`))}B.fill(0),o.createHash=function(d){return J(d)},o.createHmac=J,o.randomBytes=function(d,_){if(!_||!_.call)return new N(M(d));try{_.call(this,void 0,new N(M(d)))}catch($){_($)}};var v,h=["createCredentials","createCipher","createCipheriv","createDecipher","createDecipheriv","createSign","createVerify","createDiffieHellman","pbkdf2"],I=function(d){o[d]=function(){T("sorry,",d,"is not implemented yet")}};for(v in h)I(h[v])}).call(this,t("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},t("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/crypto-browserify/index.js","/node_modules/gulp-browserify/node_modules/crypto-browserify")},{"./md5":6,"./rng":7,"./sha":8,"./sha256":9,buffer:3,lYpoI2:11}],6:[function(t,n,o){(function(r,c,p,m,E,w,k,C,z){var N=t("./helpers");function R(T,v){T[v>>5]|=128<<v%32,T[14+(v+64>>>9<<4)]=v;for(var h=1732584193,I=-271733879,d=-1732584194,_=271733878,$=0;$<T.length;$+=16){var re=h,oe=I,ae=d,Y=_,h=M(h,I,d,_,T[$+0],7,-680876936),_=M(_,h,I,d,T[$+1],12,-389564586),d=M(d,_,h,I,T[$+2],17,606105819),I=M(I,d,_,h,T[$+3],22,-1044525330);h=M(h,I,d,_,T[$+4],7,-176418897),_=M(_,h,I,d,T[$+5],12,1200080426),d=M(d,_,h,I,T[$+6],17,-1473231341),I=M(I,d,_,h,T[$+7],22,-45705983),h=M(h,I,d,_,T[$+8],7,1770035416),_=M(_,h,I,d,T[$+9],12,-1958414417),d=M(d,_,h,I,T[$+10],17,-42063),I=M(I,d,_,h,T[$+11],22,-1990404162),h=M(h,I,d,_,T[$+12],7,1804603682),_=M(_,h,I,d,T[$+13],12,-40341101),d=M(d,_,h,I,T[$+14],17,-1502002290),h=D(h,I=M(I,d,_,h,T[$+15],22,1236535329),d,_,T[$+1],5,-165796510),_=D(_,h,I,d,T[$+6],9,-1069501632),d=D(d,_,h,I,T[$+11],14,643717713),I=D(I,d,_,h,T[$+0],20,-373897302),h=D(h,I,d,_,T[$+5],5,-701558691),_=D(_,h,I,d,T[$+10],9,38016083),d=D(d,_,h,I,T[$+15],14,-660478335),I=D(I,d,_,h,T[$+4],20,-405537848),h=D(h,I,d,_,T[$+9],5,568446438),_=D(_,h,I,d,T[$+14],9,-1019803690),d=D(d,_,h,I,T[$+3],14,-187363961),I=D(I,d,_,h,T[$+8],20,1163531501),h=D(h,I,d,_,T[$+13],5,-1444681467),_=D(_,h,I,d,T[$+2],9,-51403784),d=D(d,_,h,I,T[$+7],14,1735328473),h=F(h,I=D(I,d,_,h,T[$+12],20,-1926607734),d,_,T[$+5],4,-378558),_=F(_,h,I,d,T[$+8],11,-2022574463),d=F(d,_,h,I,T[$+11],16,1839030562),I=F(I,d,_,h,T[$+14],23,-35309556),h=F(h,I,d,_,T[$+1],4,-1530992060),_=F(_,h,I,d,T[$+4],11,1272893353),d=F(d,_,h,I,T[$+7],16,-155497632),I=F(I,d,_,h,T[$+10],23,-1094730640),h=F(h,I,d,_,T[$+13],4,681279174),_=F(_,h,I,d,T[$+0],11,-358537222),d=F(d,_,h,I,T[$+3],16,-722521979),I=F(I,d,_,h,T[$+6],23,76029189),h=F(h,I,d,_,T[$+9],4,-640364487),_=F(_,h,I,d,T[$+12],11,-421815835),d=F(d,_,h,I,T[$+15],16,530742520),h=B(h,I=F(I,d,_,h,T[$+2],23,-995338651),d,_,T[$+0],6,-198630844),_=B(_,h,I,d,T[$+7],10,1126891415),d=B(d,_,h,I,T[$+14],15,-1416354905),I=B(I,d,_,h,T[$+5],21,-57434055),h=B(h,I,d,_,T[$+12],6,1700485571),_=B(_,h,I,d,T[$+3],10,-1894986606),d=B(d,_,h,I,T[$+10],15,-1051523),I=B(I,d,_,h,T[$+1],21,-2054922799),h=B(h,I,d,_,T[$+8],6,1873313359),_=B(_,h,I,d,T[$+15],10,-30611744),d=B(d,_,h,I,T[$+6],15,-1560198380),I=B(I,d,_,h,T[$+13],21,1309151649),h=B(h,I,d,_,T[$+4],6,-145523070),_=B(_,h,I,d,T[$+11],10,-1120210379),d=B(d,_,h,I,T[$+2],15,718787259),I=B(I,d,_,h,T[$+9],21,-343485551),h=J(h,re),I=J(I,oe),d=J(d,ae),_=J(_,Y)}return Array(h,I,d,_)}function x(T,v,h,I,d,_){return J((v=J(J(v,T),J(I,_)))<<d|v>>>32-d,h)}function M(T,v,h,I,d,_,$){return x(v&h|~v&I,T,v,d,_,$)}function D(T,v,h,I,d,_,$){return x(v&I|h&~I,T,v,d,_,$)}function F(T,v,h,I,d,_,$){return x(v^h^I,T,v,d,_,$)}function B(T,v,h,I,d,_,$){return x(h^(v|~I),T,v,d,_,$)}function J(T,v){var h=(65535&T)+(65535&v);return(T>>16)+(v>>16)+(h>>16)<<16|65535&h}n.exports=function(T){return N.hash(T,R,16)}}).call(this,t("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},t("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/crypto-browserify/md5.js","/node_modules/gulp-browserify/node_modules/crypto-browserify")},{"./helpers":4,buffer:3,lYpoI2:11}],7:[function(t,n,o){(function(r,c,p,m,E,w,k,C,z){n.exports=function(N){for(var R,x=new Array(N),M=0;M<N;M++)!(3&M)&&(R=4294967296*Math.random()),x[M]=R>>>((3&M)<<3)&255;return x}}).call(this,t("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},t("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/crypto-browserify/rng.js","/node_modules/gulp-browserify/node_modules/crypto-browserify")},{buffer:3,lYpoI2:11}],8:[function(t,n,o){(function(r,c,p,m,E,w,k,C,z){var N=t("./helpers");function R(D,F){D[F>>5]|=128<<24-F%32,D[15+(F+64>>9<<4)]=F;for(var B,J,T,v=Array(80),h=1732584193,I=-271733879,d=-1732584194,_=271733878,$=-1009589776,re=0;re<D.length;re+=16){for(var oe=h,ae=I,Y=d,fe=_,me=$,he=0;he<80;he++){v[he]=he<16?D[re+he]:M(v[he-3]^v[he-8]^v[he-14]^v[he-16],1);var se=x(x(M(h,5),(se=I,J=d,T=_,(B=he)<20?se&J|~se&T:!(B<40)&&B<60?se&J|se&T|J&T:se^J^T)),x(x($,v[he]),(B=he)<20?1518500249:B<40?1859775393:B<60?-1894007588:-899497514)),$=_,_=d,d=M(I,30),I=h,h=se}h=x(h,oe),I=x(I,ae),d=x(d,Y),_=x(_,fe),$=x($,me)}return Array(h,I,d,_,$)}function x(D,F){var B=(65535&D)+(65535&F);return(D>>16)+(F>>16)+(B>>16)<<16|65535&B}function M(D,F){return D<<F|D>>>32-F}n.exports=function(D){return N.hash(D,R,20,!0)}}).call(this,t("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},t("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/crypto-browserify/sha.js","/node_modules/gulp-browserify/node_modules/crypto-browserify")},{"./helpers":4,buffer:3,lYpoI2:11}],9:[function(t,n,o){(function(r,c,p,m,E,w,k,C,z){function N(F,B){var J=(65535&F)+(65535&B);return(F>>16)+(B>>16)+(J>>16)<<16|65535&J}function R(F,B){var J,T=new Array(1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298),v=new Array(1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225),h=new Array(64);F[B>>5]|=128<<24-B%32,F[15+(B+64>>9<<4)]=B;for(var I,d,_=0;_<F.length;_+=16){for(var $=v[0],re=v[1],oe=v[2],ae=v[3],Y=v[4],fe=v[5],me=v[6],he=v[7],se=0;se<64;se++)h[se]=se<16?F[se+_]:N(N(N((d=h[se-2],M(d,17)^M(d,19)^D(d,10)),h[se-7]),(d=h[se-15],M(d,7)^M(d,18)^D(d,3))),h[se-16]),J=N(N(N(N(he,M(d=Y,6)^M(d,11)^M(d,25)),Y&fe^~Y&me),T[se]),h[se]),I=N(M(I=$,2)^M(I,13)^M(I,22),$&re^$&oe^re&oe),he=me,me=fe,fe=Y,Y=N(ae,J),ae=oe,oe=re,re=$,$=N(J,I);v[0]=N($,v[0]),v[1]=N(re,v[1]),v[2]=N(oe,v[2]),v[3]=N(ae,v[3]),v[4]=N(Y,v[4]),v[5]=N(fe,v[5]),v[6]=N(me,v[6]),v[7]=N(he,v[7])}return v}var x=t("./helpers"),M=function(F,B){return F>>>B|F<<32-B},D=function(F,B){return F>>>B};n.exports=function(F){return x.hash(F,R,32,!0)}}).call(this,t("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},t("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/crypto-browserify/sha256.js","/node_modules/gulp-browserify/node_modules/crypto-browserify")},{"./helpers":4,buffer:3,lYpoI2:11}],10:[function(t,n,o){(function(r,c,p,m,E,w,k,C,z){o.read=function(N,R,x,M,_){var F,B,J=8*_-M-1,T=(1<<J)-1,v=T>>1,h=-7,I=x?_-1:0,d=x?-1:1,_=N[R+I];for(I+=d,F=_&(1<<-h)-1,_>>=-h,h+=J;0<h;F=256*F+N[R+I],I+=d,h-=8);for(B=F&(1<<-h)-1,F>>=-h,h+=M;0<h;B=256*B+N[R+I],I+=d,h-=8);if(F===0)F=1-v;else{if(F===T)return B?NaN:1/0*(_?-1:1);B+=Math.pow(2,M),F-=v}return(_?-1:1)*B*Math.pow(2,F-M)},o.write=function(N,R,x,M,D,$){var B,J,T=8*$-D-1,v=(1<<T)-1,h=v>>1,I=D===23?Math.pow(2,-24)-Math.pow(2,-77):0,d=M?0:$-1,_=M?1:-1,$=R<0||R===0&&1/R<0?1:0;for(R=Math.abs(R),isNaN(R)||R===1/0?(J=isNaN(R)?1:0,B=v):(B=Math.floor(Math.log(R)/Math.LN2),R*(M=Math.pow(2,-B))<1&&(B--,M*=2),2<=(R+=1<=B+h?I/M:I*Math.pow(2,1-h))*M&&(B++,M/=2),v<=B+h?(J=0,B=v):1<=B+h?(J=(R*M-1)*Math.pow(2,D),B+=h):(J=R*Math.pow(2,h-1)*Math.pow(2,D),B=0));8<=D;N[x+d]=255&J,d+=_,J/=256,D-=8);for(B=B<<D|J,T+=D;0<T;N[x+d]=255&B,d+=_,B/=256,T-=8);N[x+d-_]|=128*$}}).call(this,t("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},t("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/ieee754/index.js","/node_modules/gulp-browserify/node_modules/ieee754")},{buffer:3,lYpoI2:11}],11:[function(t,n,o){(function(r,c,p,m,E,w,k,C,z){var N,R,x;function M(){}(r=n.exports={}).nextTick=(R=typeof window<"u"&&window.setImmediate,x=typeof window<"u"&&window.postMessage&&window.addEventListener,R?function(D){return window.setImmediate(D)}:x?(N=[],window.addEventListener("message",function(D){var F=D.source;F!==window&&F!==null||D.data!=="process-tick"||(D.stopPropagation(),0<N.length&&N.shift()())},!0),function(D){N.push(D),window.postMessage("process-tick","*")}):function(D){setTimeout(D,0)}),r.title="browser",r.browser=!0,r.env={},r.argv=[],r.on=M,r.addListener=M,r.once=M,r.off=M,r.removeListener=M,r.removeAllListeners=M,r.emit=M,r.binding=function(D){throw new Error("process.binding is not supported")},r.cwd=function(){return"/"},r.chdir=function(D){throw new Error("process.chdir is not supported")}}).call(this,t("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},t("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/process/browser.js","/node_modules/gulp-browserify/node_modules/process")},{buffer:3,lYpoI2:11}]},{},[1])(1)})})(Ci);var Dr=Ci.exports;const Mt=Xn(Dr);class Pr{cache;useHash;constructor(e){this.cache={},this.useHash=e}cacheValue(e,t){this.cache[this.useHash?Mt(e):String(e)]=t}deleteValue(e){delete this.cache[this.useHash?Mt(e):String(e)]}getValue(e){return this.cache[this.useHash?Mt(e):String(e)]}isCached(e){return(this.useHash?Mt(e):String(e))in this.cache}invalidate(e){e&&Object.entries(this.cache).forEach(([t,n])=>e(t,n)),this.cache={}}}function Rt(i,e){return(i.x-e.x)*(i.x-e.x)+(i.y-e.y)*(i.y-e.y)}function Ai(i,e){return i.x==e.x&&i.y==e.y}function Bt(i,e,t){return t===void 0&&(t=.01),Math.abs(i-e)<=t}function Sn(i,e){return(i%e+e)%e}async function $r(i){const e=await P.scene.local.getItems(n=>n.metadata[`${g.EXTENSIONID}/doorId`]!==void 0),t=[];for(let n of e){let o=!1;for(const r of i)n.metadata[`${g.EXTENSIONID}/doorId`]==r.id&&(o=!0);o&&t.push(n.id)}await P.scene.local.deleteItems(t)}async function qt(i){const e=[],t=await P.scene.local.getItems(n=>n.metadata[`${g.EXTENSIONID}/doorId`]!==void 0);for(const n of i){if(!Ir(n)||t.some(c=>c.metadata[`${g.EXTENSIONID}/doorId`]===n.id))continue;const o=Ue.fromItem(n),r=[];for(let c=0;c<n.points.length;c++){const p=Ue.fromPosition(n.points[c]);r.push(Ue.decompose(Ue.multiply(o,p)).position)}e.push(Ot().locked(!0).commands(Di(n.metadata[`${g.EXTENSIONID}/disabled`]===!0)).scale({x:.2,y:.2}).name("Door").position(Vt.centroid(r)).metadata({[`${g.EXTENSIONID}/doorId`]:n.id}).build())}e.length>0&&await P.scene.local.addItems(e)}async function Lr(i){const e=await P.scene.local.getItems(t=>t.id===i&&t.metadata[`${g.EXTENSIONID}/doorId`]!==void 0);if(e.length===1){const t=e[0].metadata[`${g.EXTENSIONID}/doorId`],n=A.items.filter(o=>o.id===t);await P.scene.items.updateItems(n,o=>{const r=o[0];r.metadata[`${g.EXTENSIONID}/isVisionLine`]&&r.metadata[`${g.EXTENSIONID}/disabled`]?(delete r.metadata[`${g.EXTENSIONID}/disabled`],delete r.metadata[`${g.EXTENSIONID}/doorOpen`]):r.metadata[`${g.EXTENSIONID}/isVisionLine`]&&(r.metadata[`${g.EXTENSIONID}/disabled`]=!0,r.metadata[`${g.EXTENSIONID}/doorOpen`]=!0)}),await P.player.deselect([i])}}async function Mr(){const i=await P.scene.items.getItems(e=>e.metadata[`${g.EXTENSIONID}/isDoor`]===!0);await qt(i)}function Di(i){return i?g.DOOROPEN:g.DOORCLOSED}function Rr(i){return i.filter(e=>e.points&&e.points.length>1).flatMap(e=>{const t=Ue.fromItem(e);return e.points.slice(0,-1).map((n,o)=>{const r=Ue.fromPosition(e.points[o]),c=Ue.fromPosition(e.points[o+1]),p=Ue.decompose(Ue.multiply(t,r)).position,m=Ue.decompose(Ue.multiply(t,c)).position;return{startPosition:p,endPosition:m,originalShape:e,oneSided:e.metadata[`${g.EXTENSIONID}/oneSided`]}})})}function Br(i,e,t,n,o,r){let c=[],p=[t,n];const m=A.players.filter(B=>B.role==="GM"),E=A.metadata[`${g.EXTENSIONID}/quality`]!=="accurate",w=[{x:(t+o[0])*r[0],y:o[1]*r[1]},{x:(t+o[0])*r[0],y:(n+o[1])*r[1]},{x:o[0]*r[0],y:(n+o[1])*r[1]},{x:o[0]*r[0],y:o[1]*r[1]}],k=A.gridDpi,C=g.EXTENSIONID,z=e.some(gt);if(e.length===0)return c;for(const B of e){const J=A.userId===B.createdUserId,T=m.some(d=>d.id===B.createdUserId);if(!J&&A.role!=="GM"&&!T)continue;const v=B.metadata[`${C}/visionRange`],h=yt.getValue(B.id);if(c.push([]),h!==void 0&&Ai(h.player.position,B.position)&&h.player.metadata[`${C}/visionRange`]===v)continue;let I=k*1e3;v&&(I=k*(v/A.gridScale+.5));for(const d of i){const _=(B.position.x-d.startPosition.x)*(d.endPosition.y-d.startPosition.y)-(B.position.y-d.startPosition.y)*(d.endPosition.x-d.startPosition.x);if(d.oneSided!==void 0&&(d.oneSided==="right"&&_>0||d.oneSided==="left"&&_<0))continue;let $=d.startPosition.x,re=d.startPosition.y,oe=d.endPosition.x,ae=d.endPosition.y;if($<o[0]||re<o[1]||$>o[0]+p[0]||re>o[1]+p[1]||oe<o[0]||ae<o[1]||oe>o[0]+p[0]||ae>o[1]+p[1])continue;if(E&&(!z||gt(B))){const Ee=[d.startPosition,d.endPosition],Be=Vt.distance(d.startPosition,d.endPosition),K=Math.floor(Be/(I/3));for(let f=1;f<K;f++)Ee.push(Vt.lerp(d.startPosition,d.endPosition,f/K));let l=!0;for(const f of Ee)Vt.compare(B.position,f,I)&&(l=!1);if(l)continue}const Y={x:d.startPosition.x-B.position.x,y:d.startPosition.y-B.position.y},fe={x:d.endPosition.x-B.position.x,y:d.endPosition.y-B.position.y};var N={x:0,y:0},R={x:0,y:0},x=0,M=0,D=0,F=0;//! This is probably not required if we later compute the intersection
//! (using PathKit) of these polygons with a base rectangle the size of
//! our background image
Y.x<0?x=o[0]*r[0]:x=(t+o[0])*r[0],Y.y<0?M=o[1]*r[1]:M=(n+o[1])*r[1],fe.x<0?D=o[0]*r[0]:D=(t+o[0])*r[0],fe.y<0?F=o[1]*r[1]:F=(n+o[1])*r[1];const me=[],he=[];if(Y.x!=0){const Ee=Y.y/Y.x,Be=d.startPosition.y-Ee*d.startPosition.x;me.push({x,y:Ee*x+Be})}if(Y.y!=0){const Ee=Y.x/Y.y,Be=Ee*d.startPosition.y-d.startPosition.x;me.push({x:Ee*M-Be,y:M})}if(fe.x!=0){const Ee=fe.y/fe.x,Be=d.endPosition.y-Ee*d.endPosition.x;he.push({x:D,y:Ee*D+Be})}if(fe.y!=0){const Ee=fe.x/fe.y,Be=Ee*d.endPosition.y-d.endPosition.x;he.push({x:Ee*F-Be,y:F})}me.length==1||Rt(me[0],d.startPosition)<Rt(me[1],d.startPosition)?N=me[0]:N=me[1],he.length==1||Rt(he[0],d.endPosition)<Rt(he[1],d.endPosition)?R=he[0]:R=he[1];const se=[{x:d.startPosition.x,y:d.startPosition.y},N,R,{x:d.endPosition.x,y:d.endPosition.y}],Ie=[0,0];let Re=0;for(const Ee of[N,R])Bt(Ee.y,o[1]*r[1])?Ie[Re]=0:Bt(Ee.y,(n+o[1])*r[1])?Ie[Re]=2:Bt(Ee.x,o[0]*r[0])?Ie[Re]=3:Bt(Ee.x,(t+o[0])*r[0])&&(Ie[Re]=1),Re++;let ve=Math.sign(_);ve=ve==0?1:-ve;const Me=ve==1?Ie[1]:Sn(Ie[1]-1,4);for(let Ee=Ie[0]+(ve==1?0:-1);Sn(Ee,4)!=Me;Ee+=ve)se.splice(se.length-2,0,w[Sn(Ee,4)]);c[c.length-1].push({pointset:se,fromShape:d.originalShape})}}return c}const yt=new Pr(!1);var Oe,dt=!1;async function Fr(i){if(await P.action.setBadgeText("Working.."),await P.player.setMetadata({[`${g.EXTENSIONID}/processed`]:!1}),dt=!0,Oe||(Oe=await Cr({locateFile:()=>Ar})),!await P.scene.isReady()){yt.invalidate((l,f)=>f.shadowPath.delete()),dt=!1,await P.action.setBadgeText(void 0);return}const e=[];for(let l=0;l<=6;l++)e.push(new Ln);e[1].start();const{awaitTimer:t,computeTimer:n,visionShapes:o,tokensWithVision:r,invalidateCache:c}=i;let p=i.size,m=i.offset,E=i.scale,[w,k]=p;if(A.metadata[`${g.EXTENSIONID}/autodetectEnabled`]===!0){const l=await P.scene.items.getItems(b=>b.layer==="MAP"&&on(b));let f=[];for(let b of l){let j=A.gridDpi/b.grid.dpi,X=b.position.x-j*b.grid.offset.x*b.scale.x,q=b.position.y-j*b.grid.offset.y*b.scale.y,te=X+j*b.image.width*b.scale.x,ue=q+j*b.image.height*b.scale.y;f.length?(X<f[0]&&(f[0]=X),q<f[1]&&(f[1]=q),te>f[2]&&(f[2]=te),ue>f[3]&&(f[3]=ue)):(f[0]=X,f[1]=q,f[2]=te,f[3]=ue)}m=[f[0],f[1]],p=[f[2]-f[0],f[3]-f[1]],E=[1,1],[w,k]=p}let z=0,N=0;if(c&&yt.invalidate((l,f)=>f.shadowPath.delete()),n.resume(),!(A.metadata[`${g.EXTENSIONID}/visionEnabled`]===!0)||r.length==0){const l=await P.scene.local.getItems($n);await P.scene.local.deleteItems(l.map(f=>f.id)),dt=!1,await P.action.setBadgeText(void 0);return}const x=Rr(o),M=Br(x,r,w,k,m,E);if(M.length==0){dt=!1,await P.action.setBadgeText(void 0);return}const D=[];e[1].pause(),e[2].start();const F={};for(let l=0;l<M.length;l++){const f=r[l];let b=yt.getValue(f.id);if(b!==void 0&&Ai(b.player.position,f.position)&&b.player.metadata[`${g.EXTENSIONID}/visionRange`]===f.metadata[`${g.EXTENSIONID}/visionRange`]){F[l]=b.shadowPath.copy(),z++;continue}N++;const j=M[l],X=new Oe.SkOpBuilder,q=Oe.NewPath().rect(m[0],m[1],p[0],p[1]);X.add(q,Oe.PathOp.UNION),q.delete();for(const ue of j){const le=ue.fromShape,$e=[];$e.push([Oe.MOVE_VERB,ue.pointset[0].x,ue.pointset[0].y]);for(let Ce=1;Ce<ue.pointset.length;Ce++)$e.push([Oe.LINE_VERB,ue.pointset[Ce].x,ue.pointset[Ce].y]);const Le=Oe.FromCmds($e);if(le.style.closed!=!1){const Ce=[];Ce.push([Oe.MOVE_VERB,le.points[0].x*le.scale.x+le.position.x,le.points[0].y*le.scale.y+le.position.y]);for(let de=1;de<le.points.length-1;de++)Ce.push([Oe.LINE_VERB,le.points[de].x*le.scale.x+le.position.x,le.points[de].y*le.scale.y+le.position.y]);const xe=Oe.FromCmds(Ce);Le.op(xe,Oe.PathOp.DIFFERENCE),xe.delete()}X.add(Le,Oe.PathOp.DIFFERENCE),Le.delete()}const te=X.resolve();if(!te){console.error("Couldn't compute fog"),dt=!1,await P.action.setBadgeText(void 0);return}if(X.delete(),te!==void 0){te.simplify(),F[l]=te;let ue=yt.getValue(f.id);ue!==void 0&&ue.shadowPath.delete(),yt.cacheValue(f.id,{shadowPath:te.copy(),player:f})}}e[2].pause(),e[3].start();const B=[],J=Oe.NewPath();for(let l=0;l<r.length;l++){const f=r[l],b=f.metadata[`${g.EXTENSIONID}/visionRange`],j=A.players.filter(te=>te.role=="GM"),X=A.userId===r[l].createdUserId,q=j.some(te=>te.id==r[l].createdUserId);if(gt(f)?B[l]=!0:J.op(F[l],Oe.PathOp.UNION),b){if(!X&&A.role!=="GM"&&!q)continue;const te=A.gridDpi*(b/A.gridScale+.5),ue=Oe.NewPath().ellipse(f.position.x,f.position.y,te,te,0,0,2*Math.PI);F[l]?.op(ue,Oe.PathOp.INTERSECT),ue.delete();const le=A.players.find($e=>$e.id===f.createdUserId);if(le&&A.role==="GM"&&!gt(f)){const $e=Et().strokeColor(le.color).fillOpacity(0).position({x:f.position.x,y:f.position.y}).width(te*2).height(te*2).shapeType("CIRCLE").metadata({[`${g.EXTENSIONID}/isIndicatorRing`]:!0}).build();D.push($e)}}}J.simplify();for(let l=0;l<B.length;l++)B[l]===!0&&(F[l].op(J,Oe.PathOp.INTERSECT),F[l].simplify());J.delete(),e[3].pause(),e[4].start();const T=[],v=[],h=A.metadata[`${g.EXTENSIONID}/persistenceEnabled`]===!0,I=A.metadata[`${g.EXTENSIONID}/fowEnabled`]===!0,d=A.metadata[`${g.EXTENSIONID}/playerDoors`]===!0,_=Oe.NewPath(),$={},re=await P.scene.local.getItems($n),oe=await P.scene.local.getItems(Sr);I&&_.rect(m[0],m[1],p[0],p[1]);let ae=h&&A.metadata[`${g.EXTENSIONID}/quality`]=="fast",Y=[],fe;if(ae)if(Y=re.filter(l=>mt(l)),fe=new Oe.SkOpBuilder,$.reuse=!0,Y.length===0){const l=Ot().commands([]).fillRule("evenodd").locked(!0).visible(!1).fillColor("#000000").strokeColor("#000000").layer("FOG").name("Fog of War").metadata({[`${g.EXTENSIONID}/isVisionFog`]:!0,[`${g.EXTENSIONID}/digest`]:"reuse"}).build();l.zIndex=3,await P.scene.local.addItems([l]),Y=await P.scene.local.getItems(mt)}else{let l=Oe.FromCmds(Y[0].commands);fe.add(l,Oe.PathOp.UNION),l.delete()}const me=new Oe.SkOpBuilder;let he=!1;for(const l of Object.keys(F)){const f=F[l],j=new TextEncoder().encode(f.toCmds().toString()),X=await crypto.subtle.digest("SHA-1",j).then(te=>[...new Uint8Array(te)].map(ue=>ue.toString(16).padStart(2,"0")).join(""));re.filter(te=>mt(te)&&te.metadata[`${g.EXTENSIONID}/digest`]===X).length===0?ae?fe.add(f,Oe.PathOp.UNION):T.push({cmds:f.toCmds(),visible:!1,zIndex:3,playerId:r[l].id,digest:X}):$[X]=!0,I&&(_.op(f,Oe.PathOp.DIFFERENCE),A.role==="GM"&&(he=!0,me.add(f,Oe.PathOp.UNION))),f.delete()}const se=A.metadata[`${g.EXTENSIONID}/sceneId`];if(ae){const l=fe.resolve();l.setFillType(Oe.FillType.EVENODD);const f=l.toCmds();Y.length>0&&await P.scene.local.updateItems([Y[0].id],b=>{b.length>0&&(b[0].commands=f)});try{localStorage.setItem(`${g.EXTENSIONID}/fogCache/${A.userId}/${se}`,JSON.stringify([{digest:"reuse",commands:f}]))}catch{}l.delete(),fe.delete()}else if(h){const l=re.filter(mt);try{localStorage.setItem(`${g.EXTENSIONID}/fogCache/${A.userId}/${se}`,JSON.stringify(l.map(f=>({digest:f.metadata[`${g.EXTENSIONID}/digest`],commands:f.commands}))))}catch{}}let Ie;he&&(Ie=me.resolve()),me.delete();const Re=re.filter(Ut),ve=re.filter(l=>{const f=l.metadata[`${g.EXTENSIONID}/digest`];return mt(l)&&$[f]===void 0});if(I){let l=A.metadata[`${g.EXTENSIONID}/fowColor`]?A.metadata[`${g.EXTENSIONID}/fowColor`]:"#00000088",f=.5;l.length==9&&(f=Number.parseInt(l.substring(7),16)/255,l=l.substring(0,7));const b=Ot().commands(_.toCmds()).locked(!0).fillRule("evenodd").visible(!0).fillColor(l).fillOpacity(f).strokeWidth(0).strokeColor("#000000").layer("DRAWING").metadata({[`${g.EXTENSIONID}/isTrailingFog`]:!0}).name("Trailing Fog").build();b.disableHit=!0,Re.length>0?await P.scene.local.updateItems(Ut,j=>{for(const X of j)X.commands=b.commands},!1):v.push(P.scene.local.addItems([b]))}else v.push(P.scene.local.deleteItems(re.filter(Ut).map(l=>l.id)));_.delete(),e[4].pause(),e[5].start();const Me=await P.scene.local.getItems(l=>l.metadata[`${g.EXTENSIONID}/doorId`]!==void 0);d||A.role=="GM"?await Mr():Me.length>0&&await P.scene.local.deleteItems(Me.map(l=>l.id));for(const l of Me){const f=l.metadata[`${g.EXTENSIONID}/doorId`],b=A.items.find(j=>j.id===f);if(b){const X=l.commands.length==g.DOOROPEN.length,q=!!b.metadata[`${g.EXTENSIONID}/doorOpen`];if(X===q)continue;v.push(P.scene.local.updateItems([l.id],te=>{const ue=te[0];yr(ue)&&(ue.commands=Di(q))}))}}n.pause(),t.resume(),v.push(P.scene.local.deleteItems(oe.map(l=>l.id))),v.push(P.scene.local.addItems(T.map(l=>{const f=Ot().commands(l.cmds).locked(!0).visible(l.visible).fillColor("#000000").strokeColor("#000000").layer("FOG").name("Fog of War").metadata({[`${g.EXTENSIONID}/isVisionFog`]:!0,[`${g.EXTENSIONID}/digest`]:l.digest}).build();return f.zIndex=l.zIndex,f}))),h||v.push(P.scene.local.deleteItems(ve.map(l=>l.id))),D.length>0&&v.push(P.scene.local.addItems(D)),A.fog.filled||v.push(P.scene.fog.setFilled(!0)),await Promise.all(v);let Ee=0;e[5].pause(),e[6].start(),he&&(await Xr(Ie),Ie.delete()),e[6].pause();const[Be,je]=[t.stop(),n.stop()],K={compute_time:`${je} ms`,communication_time:`${Be} ms`,cache_hits:z.toString(),cache_misses:N.toString(),item_counter:Ee.toString()};for(let l=1;l<=6;l++){const f=e[l].stop();K["stage"+l]=`${f} ms`}Ur(K),dt=!1,await P.player.setMetadata({[`${g.EXTENSIONID}/processed`]:!0}),await P.action.setBadgeText(void 0)}async function Xr(i){const e=[],t=A.items.filter(n=>ki(n)&&on(n));i.simplify();for(const n of t){const o=new Oe.SkOpBuilder,r=Oe.NewPath(),c=A.gridDpi/n.grid.dpi*(n.image.width/2)*n.scale.x;for(let E=0;E<6;E++){const w=E*60*Math.PI/180,k=n.position.x+c*Math.cos(w),C=n.position.y+c*Math.sin(w);E==0?r.moveTo(k,C):r.lineTo(k,C)}r.closePath(),o.add(r,Oe.PathOp.UNION),o.add(i,Oe.PathOp.INTERSECT);const p=o.resolve(),m=!p.toCmds().length;n.visible==m&&e.push(n),r.delete(),o.delete(),p.delete()}await P.scene.items.updateItems(e.map(n=>n.id),n=>{for(let o=0;o<n.length;o++)n[o].visible=!n[o].visible})}let _n,Vr,ci,Tt=[],ui,Tn,di,fi,pi,hi;async function vt(i){if(dt||!A.ready||!A.initialized)return;document.querySelector("#debug_div");const[e,t]=[new Ln,new Ln];e.start(),e.pause(),t.start();const n=A.players.filter(h=>h.role=="GM"),o=A.items.filter(h=>(h.layer=="CHARACTER"||h.layer=="ATTACHMENT")&&n.some(I=>h.createdUserId===I.id)&&(h.metadata[`${g.EXTENSIONID}/hasVision`]||h.metadata[`${g.ARMINDOID}/hasVision`])&&!h.metadata[`${g.EXTENSIONID}/visionBlind`]),c=(A.role=="GM"?A.items.filter(Tr):A.items.filter(Or).concat(o)).filter(h=>!gt(h)||h.visible===!0),p=A.items.filter(_r),m=A.items.filter(ki),E=A.items.filter(Ni)?.[0],w=A.metadata[`${g.EXTENSIONID}/visionEnabled`]===!0,k=A.metadata[`${g.EXTENSIONID}/persistenceEnabled`]===!0,C=A.metadata[`${g.EXTENSIONID}/autodetectEnabled`]===!0,z=A.metadata[`${g.EXTENSIONID}/fowEnabled`]===!0,N=A.metadata[`${g.EXTENSIONID}/fowColor`],R=[],x=[],M=[];if(E===void 0?(R[0]=0,R[1]=0,x[0]=1,x[1]=1,M[0]=0,M[1]=0):(R[0]=E.width*E.scale.x,R[1]=E.height*E.scale.y,x[0]=E.scale.x,x[1]=E.scale.y,M[0]=E.position.x,M[1]=E.position.y),A.role=="GM"){const h=document.getElementById("mapHeight"),I=document.getElementById("mapWidth");I.value=(Math.round(R[0])/A.gridDpi).toString(),h.value=(Math.round(R[1])/A.gridDpi).toString()}const D=JSON.stringify(p),F=JSON.stringify(m),B=JSON.stringify(c),J=JSON.stringify(E);if(J==Tn&&w==ui&&hi==N&&di==C&&fi==z&&pi==k&&_n==D&&Vr==F&&ci==B&&R[0]==Tt[0]&&R[1]==Tt[1]&&i!==!0)return;let T=!1;(J!=Tn||_n!=D||R[0]!=Tt[0]||R[1]!=Tt[1])&&(T=!0),Tn=J,ci=B,_n=D,Tt=R,ui=w,di=C,fi=z,hi=N,pi=k,t.pause();const v={awaitTimer:e,computeTimer:t,allItems:A.items,size:R,offset:M,scale:x,tokensWithVision:c,visionShapes:p,invalidateCache:T};dt||await Fr(v)}function Ur(i){for(const[e,t]of Object.entries(i)){const n=document.getElementById(e);e=="compute_time"||e=="communication_time"||e[0]=="s"?n&&(n.innerText=Number.parseFloat(t).toFixed(1)+"ms"):n&&(n.innerText=t)}}function On(i,e){i.split(/\s+/).forEach(t=>{e(t)})}class jr{constructor(){this._events=void 0,this._events={}}on(e,t){On(e,n=>{const o=this._events[n]||[];o.push(t),this._events[n]=o})}off(e,t){var n=arguments.length;if(n===0){this._events={};return}On(e,o=>{if(n===1){delete this._events[o];return}const r=this._events[o];r!==void 0&&(r.splice(r.indexOf(t),1),this._events[o]=r)})}trigger(e,...t){var n=this;On(e,o=>{const r=n._events[o];r!==void 0&&r.forEach(c=>{c.apply(n,t)})})}}function Hr(i){return i.plugins={},class extends i{constructor(...e){super(...e),this.plugins={names:[],settings:{},requested:{},loaded:{}}}static define(e,t){i.plugins[e]={name:e,fn:t}}initializePlugins(e){var t,n;const o=this,r=[];if(Array.isArray(e))e.forEach(c=>{typeof c=="string"?r.push(c):(o.plugins.settings[c.name]=c.options,r.push(c.name))});else if(e)for(t in e)e.hasOwnProperty(t)&&(o.plugins.settings[t]=e[t],r.push(t));for(;n=r.shift();)o.require(n)}loadPlugin(e){var t=this,n=t.plugins,o=i.plugins[e];if(!i.plugins.hasOwnProperty(e))throw new Error('Unable to find "'+e+'" plugin');n.requested[e]=!0,n.loaded[e]=o.fn.apply(t,[t.plugins.settings[e]||{}]),n.names.push(e)}require(e){var t=this,n=t.plugins;if(!t.plugins.loaded.hasOwnProperty(e)){if(n.requested[e])throw new Error('Plugin has circular dependency ("'+e+'")');t.loadPlugin(e)}return n.loaded[e]}}}/*! @orchidjs/unicode-variants | https://github.com/orchidjs/unicode-variants | Apache License (v2) */const an=i=>(i=i.filter(Boolean),i.length<2?i[0]||"":Gr(i)==1?"["+i.join("")+"]":"(?:"+i.join("|")+")"),Pi=i=>{if(!Wr(i))return i.join("");let e="",t=0;const n=()=>{t>1&&(e+="{"+t+"}")};return i.forEach((o,r)=>{if(o===i[r-1]){t++;return}n(),e+=o,t=1}),n(),e},$i=i=>{let e=Vn(i);return an(e)},Wr=i=>new Set(i).size!==i.length,xt=i=>(i+"").replace(/([\$\(\)\*\+\.\?\[\]\^\{\|\}\\])/gu,"\\$1"),Gr=i=>i.reduce((e,t)=>Math.max(e,qr(t)),0),qr=i=>Vn(i).length,Vn=i=>Array.from(i);/*! @orchidjs/unicode-variants | https://github.com/orchidjs/unicode-variants | Apache License (v2) */const Li=i=>{if(i.length===1)return[[i]];let e=[];const t=i.substring(1);return Li(t).forEach(function(o){let r=o.slice(0);r[0]=i.charAt(0)+r[0],e.push(r),r=o.slice(0),r.unshift(i.charAt(0)),e.push(r)}),e};/*! @orchidjs/unicode-variants | https://github.com/orchidjs/unicode-variants | Apache License (v2) */const zr=[[0,65535]],Kr="[-]";let zt,Mi;const Yr=3,Un={},gi={"/":"",0:"",a:"",aa:"",ae:"",ao:"",au:"",av:"",ay:"",b:"",c:"",d:"",e:"",f:"",g:"",h:"",i:"",j:"",k:"",l:"",m:"",n:"",o:"",oe:"",oi:"",oo:"",ou:"",p:"",q:"",r:"",s:"",t:"",th:"",tz:"",u:"",v:"",vy:"",w:"",y:"",z:"",hv:""};for(let i in gi){let e=gi[i]||"";for(let t=0;t<e.length;t++){let n=e.substring(t,t+1);Un[n]=i}}const Zr=new RegExp(Object.keys(Un).join("|")+"|"+Kr,"gu"),Qr=i=>{zt===void 0&&(zt=no(i||zr))},mi=(i,e="NFKD")=>i.normalize(e),Kt=i=>Vn(i).reduce((e,t)=>e+Jr(t),""),Jr=i=>(i=mi(i).toLowerCase().replace(Zr,e=>Un[e]||""),mi(i,"NFC"));function*eo(i){for(const[e,t]of i)for(let n=e;n<=t;n++){let o=String.fromCharCode(n),r=Kt(o);r!=o.toLowerCase()&&(r.length>Yr||r.length!=0&&(yield{folded:r,composed:o,code_point:n}))}}const to=i=>{const e={},t=(n,o)=>{const r=e[n]||new Set,c=new RegExp("^"+$i(r)+"$","iu");o.match(c)||(r.add(xt(o)),e[n]=r)};for(let n of eo(i))t(n.folded,n.folded),t(n.folded,n.composed);return e},no=i=>{const e=to(i),t={};let n=[];for(let r in e){let c=e[r];c&&(t[r]=$i(c)),r.length>1&&n.push(xt(r))}n.sort((r,c)=>c.length-r.length);const o=an(n);return Mi=new RegExp("^"+o,"u"),t},io=(i,e=1)=>{let t=0;return i=i.map(n=>(zt[n]&&(t+=n.length),zt[n]||n)),t>=e?Pi(i):""},ro=(i,e=1)=>(e=Math.max(e,i.length-1),an(Li(i).map(t=>io(t,e)))),yi=(i,e=!0)=>{let t=i.length>1?1:0;return an(i.map(n=>{let o=[];const r=e?n.length():n.length()-1;for(let c=0;c<r;c++)o.push(ro(n.substrs[c]||"",t));return Pi(o)}))},oo=(i,e)=>{for(const t of e){if(t.start!=i.start||t.end!=i.end||t.substrs.join("")!==i.substrs.join(""))continue;let n=i.parts;const o=c=>{for(const p of n){if(p.start===c.start&&p.substr===c.substr)return!1;if(!(c.length==1||p.length==1)&&(c.start<p.start&&c.end>p.start||p.start<c.start&&p.end>c.start))return!0}return!1};if(!(t.parts.filter(o).length>0))return!0}return!1};class Yt{constructor(){this.parts=[],this.substrs=[],this.start=0,this.end=0}add(e){e&&(this.parts.push(e),this.substrs.push(e.substr),this.start=Math.min(e.start,this.start),this.end=Math.max(e.end,this.end))}last(){return this.parts[this.parts.length-1]}length(){return this.parts.length}clone(e,t){let n=new Yt,o=JSON.parse(JSON.stringify(this.parts)),r=o.pop();for(const m of o)n.add(m);let c=t.substr.substring(0,e-r.start),p=c.length;return n.add({start:r.start,end:r.start+p,length:p,substr:c}),n}}const ao=i=>{Qr(),i=Kt(i);let e="",t=[new Yt];for(let n=0;n<i.length;n++){let r=i.substring(n).match(Mi);const c=i.substring(n,n+1),p=r?r[0]:null;let m=[],E=new Set;for(const w of t){const k=w.last();if(!k||k.length==1||k.end<=n)if(p){const C=p.length;w.add({start:n,end:n+C,length:C,substr:p}),E.add("1")}else w.add({start:n,end:n+1,length:1,substr:c}),E.add("2");else if(p){let C=w.clone(n,k);const z=p.length;C.add({start:n,end:n+z,length:z,substr:p}),m.push(C)}else E.add("3")}if(m.length>0){m=m.sort((w,k)=>w.length()-k.length());for(let w of m)oo(w,t)||t.push(w);continue}if(n>0&&E.size==1&&!E.has("3")){e+=yi(t,!1);let w=new Yt;const k=t[0];k&&w.add(k.last()),t=[w]}}return e+=yi(t,!0),e};/*! sifter.js | https://github.com/orchidjs/sifter.js | Apache License (v2) */const so=(i,e)=>{if(i)return i[e]},lo=(i,e)=>{if(i){for(var t,n=e.split(".");(t=n.shift())&&(i=i[t]););return i}},Nn=(i,e,t)=>{var n,o;return!i||(i=i+"",e.regex==null)||(o=i.search(e.regex),o===-1)?0:(n=e.string.length/i.length,o===0&&(n+=.5),n*t)},kn=(i,e)=>{var t=i[e];if(typeof t=="function")return t;t&&!Array.isArray(t)&&(i[e]=[t])},ze=(i,e)=>{if(Array.isArray(i))i.forEach(e);else for(var t in i)i.hasOwnProperty(t)&&e(i[t],t)},co=(i,e)=>typeof i=="number"&&typeof e=="number"?i>e?1:i<e?-1:0:(i=Kt(i+"").toLowerCase(),e=Kt(e+"").toLowerCase(),i>e?1:e>i?-1:0);/*! sifter.js | https://github.com/orchidjs/sifter.js | Apache License (v2) */class uo{constructor(e,t){this.items=void 0,this.settings=void 0,this.items=e,this.settings=t||{diacritics:!0}}tokenize(e,t,n){if(!e||!e.length)return[];const o=[],r=e.split(/\s+/);var c;return n&&(c=new RegExp("^("+Object.keys(n).map(xt).join("|")+"):(.*)$")),r.forEach(p=>{let m,E=null,w=null;c&&(m=p.match(c))&&(E=m[1],p=m[2]),p.length>0&&(this.settings.diacritics?w=ao(p)||null:w=xt(p),w&&t&&(w="\\b"+w)),o.push({string:p,regex:w?new RegExp(w,"iu"):null,field:E})}),o}getScoreFunction(e,t){var n=this.prepareSearch(e,t);return this._getScoreFunction(n)}_getScoreFunction(e){const t=e.tokens,n=t.length;if(!n)return function(){return 0};const o=e.options.fields,r=e.weights,c=o.length,p=e.getAttrFn;if(!c)return function(){return 1};const m=function(){return c===1?function(E,w){const k=o[0].field;return Nn(p(w,k),E,r[k]||1)}:function(E,w){var k=0;if(E.field){const C=p(w,E.field);!E.regex&&C?k+=1/c:k+=Nn(C,E,1)}else ze(r,(C,z)=>{k+=Nn(p(w,z),E,C)});return k/c}}();return n===1?function(E){return m(t[0],E)}:e.options.conjunction==="and"?function(E){var w,k=0;for(let C of t){if(w=m(C,E),w<=0)return 0;k+=w}return k/n}:function(E){var w=0;return ze(t,k=>{w+=m(k,E)}),w/n}}getSortFunction(e,t){var n=this.prepareSearch(e,t);return this._getSortFunction(n)}_getSortFunction(e){var t,n=[];const o=this,r=e.options,c=!e.query&&r.sort_empty?r.sort_empty:r.sort;if(typeof c=="function")return c.bind(this);const p=function(w,k){return w==="$score"?k.score:e.getAttrFn(o.items[k.id],w)};if(c)for(let E of c)(e.query||E.field!=="$score")&&n.push(E);if(e.query){t=!0;for(let E of n)if(E.field==="$score"){t=!1;break}t&&n.unshift({field:"$score",direction:"desc"})}else n=n.filter(E=>E.field!=="$score");return n.length?function(E,w){var k,C;for(let z of n)if(C=z.field,k=(z.direction==="desc"?-1:1)*co(p(C,E),p(C,w)),k)return k;return 0}:null}prepareSearch(e,t){const n={};var o=Object.assign({},t);if(kn(o,"sort"),kn(o,"sort_empty"),o.fields){kn(o,"fields");const r=[];o.fields.forEach(c=>{typeof c=="string"&&(c={field:c,weight:1}),r.push(c),n[c.field]="weight"in c?c.weight:1}),o.fields=r}return{options:o,query:e.toLowerCase().trim(),tokens:this.tokenize(e,o.respect_word_boundaries,n),total:0,items:[],weights:n,getAttrFn:o.nesting?lo:so}}search(e,t){var n=this,o,r;r=this.prepareSearch(e,t),t=r.options,e=r.query;const c=t.score||n._getScoreFunction(r);e.length?ze(n.items,(m,E)=>{o=c(m),(t.filter===!1||o>0)&&r.items.push({score:o,id:E})}):ze(n.items,(m,E)=>{r.items.push({score:1,id:E})});const p=n._getSortFunction(r);return p&&r.items.sort(p),r.total=r.items.length,typeof t.limit=="number"&&(r.items=r.items.slice(0,t.limit)),r}}const It=(i,e)=>{if(Array.isArray(i))i.forEach(e);else for(var t in i)i.hasOwnProperty(t)&&e(i[t],t)},Ve=i=>{if(i.jquery)return i[0];if(i instanceof HTMLElement)return i;if(Ri(i)){var e=document.createElement("template");return e.innerHTML=i.trim(),e.content.firstChild}return document.querySelector(i)},Ri=i=>typeof i=="string"&&i.indexOf("<")>-1,fo=i=>i.replace(/['"\\]/g,"\\$&"),xn=(i,e)=>{var t=document.createEvent("HTMLEvents");t.initEvent(e,!0,!1),i.dispatchEvent(t)},Ft=(i,e)=>{Object.assign(i.style,e)},qe=(i,...e)=>{var t=Bi(e);i=Fi(i),i.map(n=>{t.map(o=>{n.classList.add(o)})})},st=(i,...e)=>{var t=Bi(e);i=Fi(i),i.map(n=>{t.map(o=>{n.classList.remove(o)})})},Bi=i=>{var e=[];return It(i,t=>{typeof t=="string"&&(t=t.trim().split(/[\11\12\14\15\40]/)),Array.isArray(t)&&(e=e.concat(t))}),e.filter(Boolean)},Fi=i=>(Array.isArray(i)||(i=[i]),i),jt=(i,e,t)=>{if(!(t&&!t.contains(i)))for(;i&&i.matches;){if(i.matches(e))return i;i=i.parentNode}},vi=(i,e=0)=>e>0?i[i.length-1]:i[0],po=i=>Object.keys(i).length===0,Zt=(i,e)=>{if(!i)return-1;e=e||i.nodeName;for(var t=0;i=i.previousElementSibling;)i.matches(e)&&t++;return t},Pe=(i,e)=>{It(e,(t,n)=>{t==null?i.removeAttribute(n):i.setAttribute(n,""+t)})},Mn=(i,e)=>{i.parentNode&&i.parentNode.replaceChild(e,i)},ho=(i,e)=>{if(e===null)return;if(typeof e=="string"){if(!e.length)return;e=new RegExp(e,"i")}const t=r=>{var c=r.data.match(e);if(c&&r.data.length>0){var p=document.createElement("span");p.className="highlight";var m=r.splitText(c.index);m.splitText(c[0].length);var E=m.cloneNode(!0);return p.appendChild(E),Mn(m,p),1}return 0},n=r=>{r.nodeType===1&&r.childNodes&&!/(script|style)/i.test(r.tagName)&&(r.className!=="highlight"||r.tagName!=="SPAN")&&Array.from(r.childNodes).forEach(c=>{o(c)})},o=r=>r.nodeType===3?t(r):(n(r),0);o(i)},go=i=>{var e=i.querySelectorAll("span.highlight");Array.prototype.forEach.call(e,function(t){var n=t.parentNode;n.replaceChild(t.firstChild,t),n.normalize()})},mo=65,yo=13,Xi=27,Rn=37,vo=38,Vi=39,Io=40,Ii=8,Eo=46,Bn=9,wo=typeof navigator>"u"?!1:/Mac/.test(navigator.userAgent),Xt=wo?"metaKey":"ctrlKey";var Ei={options:[],optgroups:[],plugins:[],delimiter:",",splitOn:null,persist:!0,diacritics:!0,create:null,createOnBlur:!1,createFilter:null,highlight:!0,openOnFocus:!0,shouldOpen:null,maxOptions:50,maxItems:null,hideSelected:null,duplicates:!1,addPrecedence:!1,selectOnTab:!1,preload:null,allowEmptyOption:!1,refreshThrottle:300,loadThrottle:300,loadingClass:"loading",dataAttr:null,optgroupField:"optgroup",valueField:"value",labelField:"text",disabledField:"disabled",optgroupLabelField:"label",optgroupValueField:"value",lockOptgroupOrder:!1,sortField:"$order",searchField:["text"],searchConjunction:"and",mode:null,wrapperClass:"ts-wrapper",controlClass:"ts-control",dropdownClass:"ts-dropdown",dropdownContentClass:"ts-dropdown-content",itemClass:"item",optionClass:"option",dropdownParent:null,controlInput:'<input type="text" autocomplete="off" size="1" />',copyClassesToDropdown:!1,placeholder:null,hidePlaceholder:null,shouldLoad:function(i){return i.length>0},render:{}};const Je=i=>typeof i>"u"||i===null?null:Ht(i),Ht=i=>typeof i=="boolean"?i?"1":"0":i+"",Wt=i=>(i+"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;"),bo=(i,e)=>e>0?setTimeout(i,e):(i.call(null),null),So=(i,e)=>{var t;return function(n,o){var r=this;t&&(r.loading=Math.max(r.loading-1,0),clearTimeout(t)),t=setTimeout(function(){t=null,r.loadedSearches[n]=!0,i.call(r,n,o)},e)}},wi=(i,e,t)=>{var n,o=i.trigger,r={};i.trigger=function(){var c=arguments[0];if(e.indexOf(c)!==-1)r[c]=arguments;else return o.apply(i,arguments)},t.apply(i,[]),i.trigger=o;for(n of e)n in r&&o.apply(i,r[n])},_o=i=>({start:i.selectionStart||0,length:(i.selectionEnd||0)-(i.selectionStart||0)}),Ne=(i,e=!1)=>{i&&(i.preventDefault(),e&&i.stopPropagation())},ke=(i,e,t,n)=>{i.addEventListener(e,t,n)},pt=(i,e)=>{if(!e||!e[i])return!1;var t=(e.altKey?1:0)+(e.ctrlKey?1:0)+(e.shiftKey?1:0)+(e.metaKey?1:0);return t===1},Cn=(i,e)=>{const t=i.getAttribute("id");return t||(i.setAttribute("id",e),e)},bi=i=>i.replace(/[\\"']/g,"\\$&"),ht=(i,e)=>{e&&i.append(e)};function Si(i,e){var t=Object.assign({},Ei,e),n=t.dataAttr,o=t.labelField,r=t.valueField,c=t.disabledField,p=t.optgroupField,m=t.optgroupLabelField,E=t.optgroupValueField,w=i.tagName.toLowerCase(),k=i.getAttribute("placeholder")||i.getAttribute("data-placeholder");if(!k&&!t.allowEmptyOption){let R=i.querySelector('option[value=""]');R&&(k=R.textContent)}var C={placeholder:k,options:[],optgroups:[],items:[],maxItems:null},z=()=>{var R,x=C.options,M={},D=1;let F=0;var B=v=>{var h=Object.assign({},v.dataset),I=n&&h[n];return typeof I=="string"&&I.length&&(h=Object.assign(h,JSON.parse(I))),h},J=(v,h)=>{var I=Je(v.value);if(I!=null&&!(!I&&!t.allowEmptyOption)){if(M.hasOwnProperty(I)){if(h){var d=M[I][p];d?Array.isArray(d)?d.push(h):M[I][p]=[d,h]:M[I][p]=h}}else{var _=B(v);_[o]=_[o]||v.textContent,_[r]=_[r]||I,_[c]=_[c]||v.disabled,_[p]=_[p]||h,_.$option=v,_.$order=_.$order||++F,M[I]=_,x.push(_)}v.selected&&C.items.push(I)}},T=v=>{var h,I;I=B(v),I[m]=I[m]||v.getAttribute("label")||"",I[E]=I[E]||D++,I[c]=I[c]||v.disabled,I.$order=I.$order||++F,C.optgroups.push(I),h=I[E],It(v.children,d=>{J(d,h)})};C.maxItems=i.hasAttribute("multiple")?null:1,It(i.children,v=>{R=v.tagName.toLowerCase(),R==="optgroup"?T(v):R==="option"&&J(v)})},N=()=>{const R=i.getAttribute(n);if(R)C.options=JSON.parse(R),It(C.options,M=>{C.items.push(M[r])});else{var x=i.value.trim()||"";if(!t.allowEmptyOption&&!x.length)return;const M=x.split(t.delimiter);It(M,D=>{const F={};F[o]=D,F[r]=D,C.options.push(F)}),C.items=M}};return w==="select"?z():N(),Object.assign({},Ei,C,e)}var _i=0;class Ke extends Hr(jr){constructor(e,t){super(),this.control_input=void 0,this.wrapper=void 0,this.dropdown=void 0,this.control=void 0,this.dropdown_content=void 0,this.focus_node=void 0,this.order=0,this.settings=void 0,this.input=void 0,this.tabIndex=void 0,this.is_select_tag=void 0,this.rtl=void 0,this.inputId=void 0,this._destroy=void 0,this.sifter=void 0,this.isOpen=!1,this.isDisabled=!1,this.isReadOnly=!1,this.isRequired=void 0,this.isInvalid=!1,this.isValid=!0,this.isLocked=!1,this.isFocused=!1,this.isInputHidden=!1,this.isSetup=!1,this.ignoreFocus=!1,this.ignoreHover=!1,this.hasOptions=!1,this.currentResults=void 0,this.lastValue="",this.caretPos=0,this.loading=0,this.loadedSearches={},this.activeOption=null,this.activeItems=[],this.optgroups={},this.options={},this.userOptions={},this.items=[],this.refreshTimeout=null,_i++;var n,o=Ve(e);if(o.tomselect)throw new Error("Tom Select already initialized on this element");o.tomselect=this;var r=window.getComputedStyle&&window.getComputedStyle(o,null);n=r.getPropertyValue("direction");const c=Si(o,t);this.settings=c,this.input=o,this.tabIndex=o.tabIndex||0,this.is_select_tag=o.tagName.toLowerCase()==="select",this.rtl=/rtl/i.test(n),this.inputId=Cn(o,"tomselect-"+_i),this.isRequired=o.required,this.sifter=new uo(this.options,{diacritics:c.diacritics}),c.mode=c.mode||(c.maxItems===1?"single":"multi"),typeof c.hideSelected!="boolean"&&(c.hideSelected=c.mode==="multi"),typeof c.hidePlaceholder!="boolean"&&(c.hidePlaceholder=c.mode!=="multi");var p=c.createFilter;typeof p!="function"&&(typeof p=="string"&&(p=new RegExp(p)),p instanceof RegExp?c.createFilter=x=>p.test(x):c.createFilter=x=>this.settings.duplicates||!this.options[x]),this.initializePlugins(c.plugins),this.setupCallbacks(),this.setupTemplates();const m=Ve("<div>"),E=Ve("<div>"),w=this._render("dropdown"),k=Ve('<div role="listbox" tabindex="-1">'),C=this.input.getAttribute("class")||"",z=c.mode;var N;if(qe(m,c.wrapperClass,C,z),qe(E,c.controlClass),ht(m,E),qe(w,c.dropdownClass,z),c.copyClassesToDropdown&&qe(w,C),qe(k,c.dropdownContentClass),ht(w,k),Ve(c.dropdownParent||m).appendChild(w),Ri(c.controlInput)){N=Ve(c.controlInput);var R=["autocorrect","autocapitalize","autocomplete","spellcheck"];ze(R,x=>{o.getAttribute(x)&&Pe(N,{[x]:o.getAttribute(x)})}),N.tabIndex=-1,E.appendChild(N),this.focus_node=N}else c.controlInput?(N=Ve(c.controlInput),this.focus_node=N):(N=Ve("<input/>"),this.focus_node=E);this.wrapper=m,this.dropdown=w,this.dropdown_content=k,this.control=E,this.control_input=N,this.setup()}setup(){const e=this,t=e.settings,n=e.control_input,o=e.dropdown,r=e.dropdown_content,c=e.wrapper,p=e.control,m=e.input,E=e.focus_node,w={passive:!0},k=e.inputId+"-ts-dropdown";Pe(r,{id:k}),Pe(E,{role:"combobox","aria-haspopup":"listbox","aria-expanded":"false","aria-controls":k});const C=Cn(E,e.inputId+"-ts-control"),z="label[for='"+fo(e.inputId)+"']",N=document.querySelector(z),R=e.focus.bind(e);if(N){ke(N,"click",R),Pe(N,{for:C});const D=Cn(N,e.inputId+"-ts-label");Pe(E,{"aria-labelledby":D}),Pe(r,{"aria-labelledby":D})}if(c.style.width=m.style.width,e.plugins.names.length){const D="plugin-"+e.plugins.names.join(" plugin-");qe([c,o],D)}(t.maxItems===null||t.maxItems>1)&&e.is_select_tag&&Pe(m,{multiple:"multiple"}),t.placeholder&&Pe(n,{placeholder:t.placeholder}),!t.splitOn&&t.delimiter&&(t.splitOn=new RegExp("\\s*"+xt(t.delimiter)+"+\\s*")),t.load&&t.loadThrottle&&(t.load=So(t.load,t.loadThrottle)),ke(o,"mousemove",()=>{e.ignoreHover=!1}),ke(o,"mouseenter",D=>{var F=jt(D.target,"[data-selectable]",o);F&&e.onOptionHover(D,F)},{capture:!0}),ke(o,"click",D=>{const F=jt(D.target,"[data-selectable]");F&&(e.onOptionSelect(D,F),Ne(D,!0))}),ke(p,"click",D=>{var F=jt(D.target,"[data-ts-item]",p);if(F&&e.onItemSelect(D,F)){Ne(D,!0);return}n.value==""&&(e.onClick(),Ne(D,!0))}),ke(E,"keydown",D=>e.onKeyDown(D)),ke(n,"keypress",D=>e.onKeyPress(D)),ke(n,"input",D=>e.onInput(D)),ke(E,"blur",D=>e.onBlur(D)),ke(E,"focus",D=>e.onFocus(D)),ke(n,"paste",D=>e.onPaste(D));const x=D=>{const F=D.composedPath()[0];if(!c.contains(F)&&!o.contains(F)){e.isFocused&&e.blur(),e.inputState();return}F==n&&e.isOpen?D.stopPropagation():Ne(D,!0)},M=()=>{e.isOpen&&e.positionDropdown()};ke(document,"mousedown",x),ke(window,"scroll",M,w),ke(window,"resize",M,w),this._destroy=()=>{document.removeEventListener("mousedown",x),window.removeEventListener("scroll",M),window.removeEventListener("resize",M),N&&N.removeEventListener("click",R)},this.revertSettings={innerHTML:m.innerHTML,tabIndex:m.tabIndex},m.tabIndex=-1,m.insertAdjacentElement("afterend",e.wrapper),e.sync(!1),t.items=[],delete t.optgroups,delete t.options,ke(m,"invalid",()=>{e.isValid&&(e.isValid=!1,e.isInvalid=!0,e.refreshState())}),e.updateOriginalInput(),e.refreshItems(),e.close(!1),e.inputState(),e.isSetup=!0,m.disabled?e.disable():m.readOnly?e.setReadOnly(!0):e.enable(),e.on("change",this.onChange),qe(m,"tomselected","ts-hidden-accessible"),e.trigger("initialize"),t.preload===!0&&e.preload()}setupOptions(e=[],t=[]){this.addOptions(e),ze(t,n=>{this.registerOptionGroup(n)})}setupTemplates(){var e=this,t=e.settings.labelField,n=e.settings.optgroupLabelField,o={optgroup:r=>{let c=document.createElement("div");return c.className="optgroup",c.appendChild(r.options),c},optgroup_header:(r,c)=>'<div class="optgroup-header">'+c(r[n])+"</div>",option:(r,c)=>"<div>"+c(r[t])+"</div>",item:(r,c)=>"<div>"+c(r[t])+"</div>",option_create:(r,c)=>'<div class="create">Add <strong>'+c(r.input)+"</strong>&hellip;</div>",no_results:()=>'<div class="no-results">No results found</div>',loading:()=>'<div class="spinner"></div>',not_loading:()=>{},dropdown:()=>"<div></div>"};e.settings.render=Object.assign({},o,e.settings.render)}setupCallbacks(){var e,t,n={initialize:"onInitialize",change:"onChange",item_add:"onItemAdd",item_remove:"onItemRemove",item_select:"onItemSelect",clear:"onClear",option_add:"onOptionAdd",option_remove:"onOptionRemove",option_clear:"onOptionClear",optgroup_add:"onOptionGroupAdd",optgroup_remove:"onOptionGroupRemove",optgroup_clear:"onOptionGroupClear",dropdown_open:"onDropdownOpen",dropdown_close:"onDropdownClose",type:"onType",load:"onLoad",focus:"onFocus",blur:"onBlur"};for(e in n)t=this.settings[n[e]],t&&this.on(e,t)}sync(e=!0){const t=this,n=e?Si(t.input,{delimiter:t.settings.delimiter}):t.settings;t.setupOptions(n.options,n.optgroups),t.setValue(n.items||[],!0),t.lastQuery=null}onClick(){var e=this;if(e.activeItems.length>0){e.clearActiveItems(),e.focus();return}e.isFocused&&e.isOpen?e.blur():e.focus()}onMouseDown(){}onChange(){xn(this.input,"input"),xn(this.input,"change")}onPaste(e){var t=this;if(t.isInputHidden||t.isLocked){Ne(e);return}t.settings.splitOn&&setTimeout(()=>{var n=t.inputValue();if(n.match(t.settings.splitOn)){var o=n.trim().split(t.settings.splitOn);ze(o,r=>{Je(r)&&(this.options[r]?t.addItem(r):t.createItem(r))})}},0)}onKeyPress(e){var t=this;if(t.isLocked){Ne(e);return}var n=String.fromCharCode(e.keyCode||e.which);if(t.settings.create&&t.settings.mode==="multi"&&n===t.settings.delimiter){t.createItem(),Ne(e);return}}onKeyDown(e){var t=this;if(t.ignoreHover=!0,t.isLocked){e.keyCode!==Bn&&Ne(e);return}switch(e.keyCode){case mo:if(pt(Xt,e)&&t.control_input.value==""){Ne(e),t.selectAll();return}break;case Xi:t.isOpen&&(Ne(e,!0),t.close()),t.clearActiveItems();return;case Io:if(!t.isOpen&&t.hasOptions)t.open();else if(t.activeOption){let n=t.getAdjacent(t.activeOption,1);n&&t.setActiveOption(n)}Ne(e);return;case vo:if(t.activeOption){let n=t.getAdjacent(t.activeOption,-1);n&&t.setActiveOption(n)}Ne(e);return;case yo:t.canSelect(t.activeOption)?(t.onOptionSelect(e,t.activeOption),Ne(e)):(t.settings.create&&t.createItem()||document.activeElement==t.control_input&&t.isOpen)&&Ne(e);return;case Rn:t.advanceSelection(-1,e);return;case Vi:t.advanceSelection(1,e);return;case Bn:t.settings.selectOnTab&&(t.canSelect(t.activeOption)&&(t.onOptionSelect(e,t.activeOption),Ne(e)),t.settings.create&&t.createItem()&&Ne(e));return;case Ii:case Eo:t.deleteSelection(e);return}t.isInputHidden&&!pt(Xt,e)&&Ne(e)}onInput(e){if(this.isLocked)return;const t=this.inputValue();if(this.lastValue!==t){if(this.lastValue=t,t==""){this._onInput();return}this.refreshTimeout&&clearTimeout(this.refreshTimeout),this.refreshTimeout=bo(()=>{this.refreshTimeout=null,this._onInput()},this.settings.refreshThrottle)}}_onInput(){const e=this.lastValue;this.settings.shouldLoad.call(this,e)&&this.load(e),this.refreshOptions(),this.trigger("type",e)}onOptionHover(e,t){this.ignoreHover||this.setActiveOption(t,!1)}onFocus(e){var t=this,n=t.isFocused;if(t.isDisabled||t.isReadOnly){t.blur(),Ne(e);return}t.ignoreFocus||(t.isFocused=!0,t.settings.preload==="focus"&&t.preload(),n||t.trigger("focus"),t.activeItems.length||(t.inputState(),t.refreshOptions(!!t.settings.openOnFocus)),t.refreshState())}onBlur(e){if(document.hasFocus()!==!1){var t=this;if(t.isFocused){t.isFocused=!1,t.ignoreFocus=!1;var n=()=>{t.close(),t.setActiveItem(),t.setCaret(t.items.length),t.trigger("blur")};t.settings.create&&t.settings.createOnBlur?t.createItem(null,n):n()}}}onOptionSelect(e,t){var n,o=this;t.parentElement&&t.parentElement.matches("[data-disabled]")||(t.classList.contains("create")?o.createItem(null,()=>{o.settings.closeAfterSelect&&o.close()}):(n=t.dataset.value,typeof n<"u"&&(o.lastQuery=null,o.addItem(n),o.settings.closeAfterSelect&&o.close(),!o.settings.hideSelected&&e.type&&/click/.test(e.type)&&o.setActiveOption(t))))}canSelect(e){return!!(this.isOpen&&e&&this.dropdown_content.contains(e))}onItemSelect(e,t){var n=this;return!n.isLocked&&n.settings.mode==="multi"?(Ne(e),n.setActiveItem(t,e),!0):!1}canLoad(e){return!(!this.settings.load||this.loadedSearches.hasOwnProperty(e))}load(e){const t=this;if(!t.canLoad(e))return;qe(t.wrapper,t.settings.loadingClass),t.loading++;const n=t.loadCallback.bind(t);t.settings.load.call(t,e,n)}loadCallback(e,t){const n=this;n.loading=Math.max(n.loading-1,0),n.lastQuery=null,n.clearActiveOption(),n.setupOptions(e,t),n.refreshOptions(n.isFocused&&!n.isInputHidden),n.loading||st(n.wrapper,n.settings.loadingClass),n.trigger("load",e,t)}preload(){var e=this.wrapper.classList;e.contains("preloaded")||(e.add("preloaded"),this.load(""))}setTextboxValue(e=""){var t=this.control_input,n=t.value!==e;n&&(t.value=e,xn(t,"update"),this.lastValue=e)}getValue(){return this.is_select_tag&&this.input.hasAttribute("multiple")?this.items:this.items.join(this.settings.delimiter)}setValue(e,t){var n=t?[]:["change"];wi(this,n,()=>{this.clear(t),this.addItems(e,t)})}setMaxItems(e){e===0&&(e=null),this.settings.maxItems=e,this.refreshState()}setActiveItem(e,t){var n=this,o,r,c,p,m,E;if(n.settings.mode!=="single"){if(!e){n.clearActiveItems(),n.isFocused&&n.inputState();return}if(o=t&&t.type.toLowerCase(),o==="click"&&pt("shiftKey",t)&&n.activeItems.length){for(E=n.getLastActive(),c=Array.prototype.indexOf.call(n.control.children,E),p=Array.prototype.indexOf.call(n.control.children,e),c>p&&(m=c,c=p,p=m),r=c;r<=p;r++)e=n.control.children[r],n.activeItems.indexOf(e)===-1&&n.setActiveItemClass(e);Ne(t)}else o==="click"&&pt(Xt,t)||o==="keydown"&&pt("shiftKey",t)?e.classList.contains("active")?n.removeActiveItem(e):n.setActiveItemClass(e):(n.clearActiveItems(),n.setActiveItemClass(e));n.inputState(),n.isFocused||n.focus()}}setActiveItemClass(e){const t=this,n=t.control.querySelector(".last-active");n&&st(n,"last-active"),qe(e,"active last-active"),t.trigger("item_select",e),t.activeItems.indexOf(e)==-1&&t.activeItems.push(e)}removeActiveItem(e){var t=this.activeItems.indexOf(e);this.activeItems.splice(t,1),st(e,"active")}clearActiveItems(){st(this.activeItems,"active"),this.activeItems=[]}setActiveOption(e,t=!0){e!==this.activeOption&&(this.clearActiveOption(),e&&(this.activeOption=e,Pe(this.focus_node,{"aria-activedescendant":e.getAttribute("id")}),Pe(e,{"aria-selected":"true"}),qe(e,"active"),t&&this.scrollToOption(e)))}scrollToOption(e,t){if(!e)return;const n=this.dropdown_content,o=n.clientHeight,r=n.scrollTop||0,c=e.offsetHeight,p=e.getBoundingClientRect().top-n.getBoundingClientRect().top+r;p+c>o+r?this.scroll(p-o+c,t):p<r&&this.scroll(p,t)}scroll(e,t){const n=this.dropdown_content;t&&(n.style.scrollBehavior=t),n.scrollTop=e,n.style.scrollBehavior=""}clearActiveOption(){this.activeOption&&(st(this.activeOption,"active"),Pe(this.activeOption,{"aria-selected":null})),this.activeOption=null,Pe(this.focus_node,{"aria-activedescendant":null})}selectAll(){const e=this;if(e.settings.mode==="single")return;const t=e.controlChildren();t.length&&(e.inputState(),e.close(),e.activeItems=t,ze(t,n=>{e.setActiveItemClass(n)}))}inputState(){var e=this;e.control.contains(e.control_input)&&(Pe(e.control_input,{placeholder:e.settings.placeholder}),e.activeItems.length>0||!e.isFocused&&e.settings.hidePlaceholder&&e.items.length>0?(e.setTextboxValue(),e.isInputHidden=!0):(e.settings.hidePlaceholder&&e.items.length>0&&Pe(e.control_input,{placeholder:""}),e.isInputHidden=!1),e.wrapper.classList.toggle("input-hidden",e.isInputHidden))}inputValue(){return this.control_input.value.trim()}focus(){var e=this;e.isDisabled||e.isReadOnly||(e.ignoreFocus=!0,e.control_input.offsetWidth?e.control_input.focus():e.focus_node.focus(),setTimeout(()=>{e.ignoreFocus=!1,e.onFocus()},0))}blur(){this.focus_node.blur(),this.onBlur()}getScoreFunction(e){return this.sifter.getScoreFunction(e,this.getSearchOptions())}getSearchOptions(){var e=this.settings,t=e.sortField;return typeof e.sortField=="string"&&(t=[{field:e.sortField}]),{fields:e.searchField,conjunction:e.searchConjunction,sort:t,nesting:e.nesting}}search(e){var t,n,o=this,r=this.getSearchOptions();if(o.settings.score&&(n=o.settings.score.call(o,e),typeof n!="function"))throw new Error('Tom Select "score" setting must be a function that returns a function');return e!==o.lastQuery?(o.lastQuery=e,t=o.sifter.search(e,Object.assign(r,{score:n})),o.currentResults=t):t=Object.assign({},o.currentResults),o.settings.hideSelected&&(t.items=t.items.filter(c=>{let p=Je(c.id);return!(p&&o.items.indexOf(p)!==-1)})),t}refreshOptions(e=!0){var t,n,o,r,c,p,m,E,w,k;const C={},z=[];var N=this,R=N.inputValue();const x=R===N.lastQuery||R==""&&N.lastQuery==null;var M=N.search(R),D=null,F=N.settings.shouldOpen||!1,B=N.dropdown_content;x&&(D=N.activeOption,D&&(w=D.closest("[data-group]"))),r=M.items.length,typeof N.settings.maxOptions=="number"&&(r=Math.min(r,N.settings.maxOptions)),r>0&&(F=!0);const J=(v,h)=>{let I=C[v];if(I!==void 0){let _=z[I];if(_!==void 0)return[I,_.fragment]}let d=document.createDocumentFragment();return I=z.length,z.push({fragment:d,order:h,optgroup:v}),[I,d]};for(t=0;t<r;t++){let v=M.items[t];if(!v)continue;let h=v.id,I=N.options[h];if(I===void 0)continue;let d=Ht(h),_=N.getOption(d,!0);for(N.settings.hideSelected||_.classList.toggle("selected",N.items.includes(d)),c=I[N.settings.optgroupField]||"",p=Array.isArray(c)?c:[c],n=0,o=p&&p.length;n<o;n++){c=p[n];let $=I.$order,re=N.optgroups[c];re===void 0?c="":$=re.$order;const[oe,ae]=J(c,$);n>0&&(_=_.cloneNode(!0),Pe(_,{id:I.$id+"-clone-"+n,"aria-selected":null}),_.classList.add("ts-cloned"),st(_,"active"),N.activeOption&&N.activeOption.dataset.value==h&&w&&w.dataset.group===c.toString()&&(D=_)),ae.appendChild(_),c!=""&&(C[c]=oe)}}N.settings.lockOptgroupOrder&&z.sort((v,h)=>v.order-h.order),m=document.createDocumentFragment(),ze(z,v=>{let h=v.fragment,I=v.optgroup;if(!h||!h.children.length)return;let d=N.optgroups[I];if(d!==void 0){let _=document.createDocumentFragment(),$=N.render("optgroup_header",d);ht(_,$),ht(_,h);let re=N.render("optgroup",{group:d,options:_});ht(m,re)}else ht(m,h)}),B.innerHTML="",ht(B,m),N.settings.highlight&&(go(B),M.query.length&&M.tokens.length&&ze(M.tokens,v=>{ho(B,v.regex)}));var T=v=>{let h=N.render(v,{input:R});return h&&(F=!0,B.insertBefore(h,B.firstChild)),h};if(N.loading?T("loading"):N.settings.shouldLoad.call(N,R)?M.items.length===0&&T("no_results"):T("not_loading"),E=N.canCreate(R),E&&(k=T("option_create")),N.hasOptions=M.items.length>0||E,F){if(M.items.length>0){if(!D&&N.settings.mode==="single"&&N.items[0]!=null&&(D=N.getOption(N.items[0])),!B.contains(D)){let v=0;k&&!N.settings.addPrecedence&&(v=1),D=N.selectable()[v]}}else k&&(D=k);e&&!N.isOpen&&(N.open(),N.scrollToOption(D,"auto")),N.setActiveOption(D)}else N.clearActiveOption(),e&&N.isOpen&&N.close(!1)}selectable(){return this.dropdown_content.querySelectorAll("[data-selectable]")}addOption(e,t=!1){const n=this;if(Array.isArray(e))return n.addOptions(e,t),!1;const o=Je(e[n.settings.valueField]);return o===null||n.options.hasOwnProperty(o)?!1:(e.$order=e.$order||++n.order,e.$id=n.inputId+"-opt-"+e.$order,n.options[o]=e,n.lastQuery=null,t&&(n.userOptions[o]=t,n.trigger("option_add",o,e)),o)}addOptions(e,t=!1){ze(e,n=>{this.addOption(n,t)})}registerOption(e){return this.addOption(e)}registerOptionGroup(e){var t=Je(e[this.settings.optgroupValueField]);return t===null?!1:(e.$order=e.$order||++this.order,this.optgroups[t]=e,t)}addOptionGroup(e,t){var n;t[this.settings.optgroupValueField]=e,(n=this.registerOptionGroup(t))&&this.trigger("optgroup_add",n,t)}removeOptionGroup(e){this.optgroups.hasOwnProperty(e)&&(delete this.optgroups[e],this.clearCache(),this.trigger("optgroup_remove",e))}clearOptionGroups(){this.optgroups={},this.clearCache(),this.trigger("optgroup_clear")}updateOption(e,t){const n=this;var o,r;const c=Je(e),p=Je(t[n.settings.valueField]);if(c===null)return;const m=n.options[c];if(m==null)return;if(typeof p!="string")throw new Error("Value must be set in option data");const E=n.getOption(c),w=n.getItem(c);if(t.$order=t.$order||m.$order,delete n.options[c],n.uncacheValue(p),n.options[p]=t,E){if(n.dropdown_content.contains(E)){const k=n._render("option",t);Mn(E,k),n.activeOption===E&&n.setActiveOption(k)}E.remove()}w&&(r=n.items.indexOf(c),r!==-1&&n.items.splice(r,1,p),o=n._render("item",t),w.classList.contains("active")&&qe(o,"active"),Mn(w,o)),n.lastQuery=null}removeOption(e,t){const n=this;e=Ht(e),n.uncacheValue(e),delete n.userOptions[e],delete n.options[e],n.lastQuery=null,n.trigger("option_remove",e),n.removeItem(e,t)}clearOptions(e){const t=(e||this.clearFilter).bind(this);this.loadedSearches={},this.userOptions={},this.clearCache();const n={};ze(this.options,(o,r)=>{t(o,r)&&(n[r]=o)}),this.options=this.sifter.items=n,this.lastQuery=null,this.trigger("option_clear")}clearFilter(e,t){return this.items.indexOf(t)>=0}getOption(e,t=!1){const n=Je(e);if(n===null)return null;const o=this.options[n];if(o!=null){if(o.$div)return o.$div;if(t)return this._render("option",o)}return null}getAdjacent(e,t,n="option"){var o=this,r;if(!e)return null;n=="item"?r=o.controlChildren():r=o.dropdown_content.querySelectorAll("[data-selectable]");for(let c=0;c<r.length;c++)if(r[c]==e)return t>0?r[c+1]:r[c-1];return null}getItem(e){if(typeof e=="object")return e;var t=Je(e);return t!==null?this.control.querySelector(`[data-value="${bi(t)}"]`):null}addItems(e,t){var n=this,o=Array.isArray(e)?e:[e];o=o.filter(c=>n.items.indexOf(c)===-1);const r=o[o.length-1];o.forEach(c=>{n.isPending=c!==r,n.addItem(c,t)})}addItem(e,t){var n=t?[]:["change","dropdown_close"];wi(this,n,()=>{var o,r;const c=this,p=c.settings.mode,m=Je(e);if(!(m&&c.items.indexOf(m)!==-1&&(p==="single"&&c.close(),p==="single"||!c.settings.duplicates))&&!(m===null||!c.options.hasOwnProperty(m))&&(p==="single"&&c.clear(t),!(p==="multi"&&c.isFull()))){if(o=c._render("item",c.options[m]),c.control.contains(o)&&(o=o.cloneNode(!0)),r=c.isFull(),c.items.splice(c.caretPos,0,m),c.insertAtCaret(o),c.isSetup){if(!c.isPending&&c.settings.hideSelected){let E=c.getOption(m),w=c.getAdjacent(E,1);w&&c.setActiveOption(w)}!c.isPending&&!c.settings.closeAfterSelect&&c.refreshOptions(c.isFocused&&p!=="single"),c.settings.closeAfterSelect!=!1&&c.isFull()?c.close():c.isPending||c.positionDropdown(),c.trigger("item_add",m,o),c.isPending||c.updateOriginalInput({silent:t})}(!c.isPending||!r&&c.isFull())&&(c.inputState(),c.refreshState())}})}removeItem(e=null,t){const n=this;if(e=n.getItem(e),!e)return;var o,r;const c=e.dataset.value;o=Zt(e),e.remove(),e.classList.contains("active")&&(r=n.activeItems.indexOf(e),n.activeItems.splice(r,1),st(e,"active")),n.items.splice(o,1),n.lastQuery=null,!n.settings.persist&&n.userOptions.hasOwnProperty(c)&&n.removeOption(c,t),o<n.caretPos&&n.setCaret(n.caretPos-1),n.updateOriginalInput({silent:t}),n.refreshState(),n.positionDropdown(),n.trigger("item_remove",c,e)}createItem(e=null,t=()=>{}){arguments.length===3&&(t=arguments[2]),typeof t!="function"&&(t=()=>{});var n=this,o=n.caretPos,r;if(e=e||n.inputValue(),!n.canCreate(e))return t(),!1;n.lock();var c=!1,p=m=>{if(n.unlock(),!m||typeof m!="object")return t();var E=Je(m[n.settings.valueField]);if(typeof E!="string")return t();n.setTextboxValue(),n.addOption(m,!0),n.setCaret(o),n.addItem(E),t(m),c=!0};return typeof n.settings.create=="function"?r=n.settings.create.call(this,e,p):r={[n.settings.labelField]:e,[n.settings.valueField]:e},c||p(r),!0}refreshItems(){var e=this;e.lastQuery=null,e.isSetup&&e.addItems(e.items),e.updateOriginalInput(),e.refreshState()}refreshState(){const e=this;e.refreshValidityState();const t=e.isFull(),n=e.isLocked;e.wrapper.classList.toggle("rtl",e.rtl);const o=e.wrapper.classList;o.toggle("focus",e.isFocused),o.toggle("disabled",e.isDisabled),o.toggle("readonly",e.isReadOnly),o.toggle("required",e.isRequired),o.toggle("invalid",!e.isValid),o.toggle("locked",n),o.toggle("full",t),o.toggle("input-active",e.isFocused&&!e.isInputHidden),o.toggle("dropdown-active",e.isOpen),o.toggle("has-options",po(e.options)),o.toggle("has-items",e.items.length>0)}refreshValidityState(){var e=this;e.input.validity&&(e.isValid=e.input.validity.valid,e.isInvalid=!e.isValid)}isFull(){return this.settings.maxItems!==null&&this.items.length>=this.settings.maxItems}updateOriginalInput(e={}){const t=this;var n,o;const r=t.input.querySelector('option[value=""]');if(t.is_select_tag){let m=function(E,w,k){return E||(E=Ve('<option value="'+Wt(w)+'">'+Wt(k)+"</option>")),E!=r&&t.input.append(E),c.push(E),(E!=r||p>0)&&(E.selected=!0),E};const c=[],p=t.input.querySelectorAll("option:checked").length;t.input.querySelectorAll("option:checked").forEach(E=>{E.selected=!1}),t.items.length==0&&t.settings.mode=="single"?m(r,"",""):t.items.forEach(E=>{if(n=t.options[E],o=n[t.settings.labelField]||"",c.includes(n.$option)){const w=t.input.querySelector(`option[value="${bi(E)}"]:not(:checked)`);m(w,E,o)}else n.$option=m(n.$option,E,o)})}else t.input.value=t.getValue();t.isSetup&&(e.silent||t.trigger("change",t.getValue()))}open(){var e=this;e.isLocked||e.isOpen||e.settings.mode==="multi"&&e.isFull()||(e.isOpen=!0,Pe(e.focus_node,{"aria-expanded":"true"}),e.refreshState(),Ft(e.dropdown,{visibility:"hidden",display:"block"}),e.positionDropdown(),Ft(e.dropdown,{visibility:"visible",display:"block"}),e.focus(),e.trigger("dropdown_open",e.dropdown))}close(e=!0){var t=this,n=t.isOpen;e&&(t.setTextboxValue(),t.settings.mode==="single"&&t.items.length&&t.inputState()),t.isOpen=!1,Pe(t.focus_node,{"aria-expanded":"false"}),Ft(t.dropdown,{display:"none"}),t.settings.hideSelected&&t.clearActiveOption(),t.refreshState(),n&&t.trigger("dropdown_close",t.dropdown)}positionDropdown(){if(this.settings.dropdownParent==="body"){var e=this.control,t=e.getBoundingClientRect(),n=e.offsetHeight+t.top+window.scrollY,o=t.left+window.scrollX;Ft(this.dropdown,{width:t.width+"px",top:n+"px",left:o+"px"})}}clear(e){var t=this;if(t.items.length){var n=t.controlChildren();ze(n,o=>{t.removeItem(o,!0)}),t.inputState(),e||t.updateOriginalInput(),t.trigger("clear")}}insertAtCaret(e){const t=this,n=t.caretPos,o=t.control;o.insertBefore(e,o.children[n]||null),t.setCaret(n+1)}deleteSelection(e){var t,n,o,r,c=this;t=e&&e.keyCode===Ii?-1:1,n=_o(c.control_input);const p=[];if(c.activeItems.length)r=vi(c.activeItems,t),o=Zt(r),t>0&&o++,ze(c.activeItems,m=>p.push(m));else if((c.isFocused||c.settings.mode==="single")&&c.items.length){const m=c.controlChildren();let E;t<0&&n.start===0&&n.length===0?E=m[c.caretPos-1]:t>0&&n.start===c.inputValue().length&&(E=m[c.caretPos]),E!==void 0&&p.push(E)}if(!c.shouldDelete(p,e))return!1;for(Ne(e,!0),typeof o<"u"&&c.setCaret(o);p.length;)c.removeItem(p.pop());return c.inputState(),c.positionDropdown(),c.refreshOptions(!1),!0}shouldDelete(e,t){const n=e.map(o=>o.dataset.value);return!(!n.length||typeof this.settings.onDelete=="function"&&this.settings.onDelete(n,t)===!1)}advanceSelection(e,t){var n,o,r=this;r.rtl&&(e*=-1),!r.inputValue().length&&(pt(Xt,t)||pt("shiftKey",t)?(n=r.getLastActive(e),n?n.classList.contains("active")?o=r.getAdjacent(n,e,"item"):o=n:e>0?o=r.control_input.nextElementSibling:o=r.control_input.previousElementSibling,o&&(o.classList.contains("active")&&r.removeActiveItem(n),r.setActiveItemClass(o))):r.moveCaret(e))}moveCaret(e){}getLastActive(e){let t=this.control.querySelector(".last-active");if(t)return t;var n=this.control.querySelectorAll(".active");if(n)return vi(n,e)}setCaret(e){this.caretPos=this.items.length}controlChildren(){return Array.from(this.control.querySelectorAll("[data-ts-item]"))}lock(){this.setLocked(!0)}unlock(){this.setLocked(!1)}setLocked(e=this.isReadOnly||this.isDisabled){this.isLocked=e,this.refreshState()}disable(){this.setDisabled(!0),this.close()}enable(){this.setDisabled(!1)}setDisabled(e){this.focus_node.tabIndex=e?-1:this.tabIndex,this.isDisabled=e,this.input.disabled=e,this.control_input.disabled=e,this.setLocked()}setReadOnly(e){this.isReadOnly=e,this.input.readOnly=e,this.control_input.readOnly=e,this.setLocked()}destroy(){var e=this,t=e.revertSettings;e.trigger("destroy"),e.off(),e.wrapper.remove(),e.dropdown.remove(),e.input.innerHTML=t.innerHTML,e.input.tabIndex=t.tabIndex,st(e.input,"tomselected","ts-hidden-accessible"),e._destroy(),delete e.input.tomselect}render(e,t){var n,o;const r=this;if(typeof this.settings.render[e]!="function"||(o=r.settings.render[e].call(this,t,Wt),!o))return null;if(o=Ve(o),e==="option"||e==="option_create"?t[r.settings.disabledField]?Pe(o,{"aria-disabled":"true"}):Pe(o,{"data-selectable":""}):e==="optgroup"&&(n=t.group[r.settings.optgroupValueField],Pe(o,{"data-group":n}),t.group[r.settings.disabledField]&&Pe(o,{"data-disabled":""})),e==="option"||e==="item"){const c=Ht(t[r.settings.valueField]);Pe(o,{"data-value":c}),e==="item"?(qe(o,r.settings.itemClass),Pe(o,{"data-ts-item":""})):(qe(o,r.settings.optionClass),Pe(o,{role:"option",id:t.$id}),t.$div=o,r.options[c]=t)}return o}_render(e,t){const n=this.render(e,t);if(n==null)throw"HTMLElement expected";return n}clearCache(){ze(this.options,e=>{e.$div&&(e.$div.remove(),delete e.$div)})}uncacheValue(e){const t=this.getOption(e);t&&t.remove()}canCreate(e){return this.settings.create&&e.length>0&&this.settings.createFilter.call(this,e)}hook(e,t,n){var o=this,r=o[t];o[t]=function(){var c,p;return e==="after"&&(c=r.apply(o,arguments)),p=n.apply(o,arguments),e==="instead"?p:(e==="before"&&(c=r.apply(o,arguments)),c)}}}function To(){ke(this.input,"change",()=>{this.sync()})}function Oo(i){var e=this,t=e.onOptionSelect;e.settings.hideSelected=!1;const n=Object.assign({className:"tomselect-checkbox",checkedClassNames:void 0,uncheckedClassNames:void 0},i);var o=function(p,m){m?(p.checked=!0,n.uncheckedClassNames&&p.classList.remove(...n.uncheckedClassNames),n.checkedClassNames&&p.classList.add(...n.checkedClassNames)):(p.checked=!1,n.checkedClassNames&&p.classList.remove(...n.checkedClassNames),n.uncheckedClassNames&&p.classList.add(...n.uncheckedClassNames))},r=function(p){setTimeout(()=>{var m=p.querySelector("input."+n.className);m instanceof HTMLInputElement&&o(m,p.classList.contains("selected"))},1)};e.hook("after","setupTemplates",()=>{var c=e.settings.render.option;e.settings.render.option=(p,m)=>{var E=Ve(c.call(e,p,m)),w=document.createElement("input");n.className&&w.classList.add(n.className),w.addEventListener("click",function(C){Ne(C)}),w.type="checkbox";const k=Je(p[e.settings.valueField]);return o(w,!!(k&&e.items.indexOf(k)>-1)),E.prepend(w),E}}),e.on("item_remove",c=>{var p=e.getOption(c);p&&(p.classList.remove("selected"),r(p))}),e.on("item_add",c=>{var p=e.getOption(c);p&&r(p)}),e.hook("instead","onOptionSelect",(c,p)=>{if(p.classList.contains("selected")){p.classList.remove("selected"),e.removeItem(p.dataset.value),e.refreshOptions(),Ne(c,!0);return}t.call(e,c,p),r(p)})}function No(i){const e=this,t=Object.assign({className:"clear-button",title:"Clear All",html:n=>`<div class="${n.className}" title="${n.title}">&#10799;</div>`},i);e.on("initialize",()=>{var n=Ve(t.html(t));n.addEventListener("click",o=>{e.isLocked||(e.clear(),e.settings.mode==="single"&&e.settings.allowEmptyOption&&e.addItem(""),o.preventDefault(),o.stopPropagation())}),e.control.appendChild(n)})}const ko=(i,e)=>{var t;(t=i.parentNode)==null||t.insertBefore(e,i.nextSibling)},xo=(i,e)=>{var t;(t=i.parentNode)==null||t.insertBefore(e,i)},Co=(i,e)=>{do{var t;if(e=(t=e)==null?void 0:t.previousElementSibling,i==e)return!0}while(e&&e.previousElementSibling);return!1};function Ao(){var i=this;if(i.settings.mode!=="multi")return;var e=i.lock,t=i.unlock;let n=!0,o;i.hook("after","setupTemplates",()=>{var r=i.settings.render.item;i.settings.render.item=(c,p)=>{const m=Ve(r.call(i,c,p));Pe(m,{draggable:"true"});const E=R=>{n||Ne(R),R.stopPropagation()},w=R=>{o=m,setTimeout(()=>{m.classList.add("ts-dragging")},0)},k=R=>{R.preventDefault(),m.classList.add("ts-drag-over"),z(m,o)},C=()=>{m.classList.remove("ts-drag-over")},z=(R,x)=>{x!==void 0&&(Co(x,m)?ko(R,x):xo(R,x))},N=()=>{var R;document.querySelectorAll(".ts-drag-over").forEach(M=>M.classList.remove("ts-drag-over")),(R=o)==null||R.classList.remove("ts-dragging"),o=void 0;var x=[];i.control.querySelectorAll("[data-value]").forEach(M=>{if(M.dataset.value){let D=M.dataset.value;D&&x.push(D)}}),i.setValue(x)};return ke(m,"mousedown",E),ke(m,"dragstart",w),ke(m,"dragenter",k),ke(m,"dragover",k),ke(m,"dragleave",C),ke(m,"dragend",N),m}}),i.hook("instead","lock",()=>(n=!1,e.call(i))),i.hook("instead","unlock",()=>(n=!0,t.call(i)))}function Do(i){const e=this,t=Object.assign({title:"Untitled",headerClass:"dropdown-header",titleRowClass:"dropdown-header-title",labelClass:"dropdown-header-label",closeClass:"dropdown-header-close",html:n=>'<div class="'+n.headerClass+'"><div class="'+n.titleRowClass+'"><span class="'+n.labelClass+'">'+n.title+'</span><a class="'+n.closeClass+'">&times;</a></div></div>'},i);e.on("initialize",()=>{var n=Ve(t.html(t)),o=n.querySelector("."+t.closeClass);o&&o.addEventListener("click",r=>{Ne(r,!0),e.close()}),e.dropdown.insertBefore(n,e.dropdown.firstChild)})}function Po(){var i=this;i.hook("instead","setCaret",e=>{i.settings.mode==="single"||!i.control.contains(i.control_input)?e=i.items.length:(e=Math.max(0,Math.min(i.items.length,e)),e!=i.caretPos&&!i.isPending&&i.controlChildren().forEach((t,n)=>{n<e?i.control_input.insertAdjacentElement("beforebegin",t):i.control.appendChild(t)})),i.caretPos=e}),i.hook("instead","moveCaret",e=>{if(!i.isFocused)return;const t=i.getLastActive(e);if(t){const n=Zt(t);i.setCaret(e>0?n+1:n),i.setActiveItem(),st(t,"last-active")}else i.setCaret(i.caretPos+e)})}function $o(){const i=this;i.settings.shouldOpen=!0,i.hook("before","setup",()=>{i.focus_node=i.control,qe(i.control_input,"dropdown-input");const e=Ve('<div class="dropdown-input-wrap">');e.append(i.control_input),i.dropdown.insertBefore(e,i.dropdown.firstChild);const t=Ve('<input class="items-placeholder" tabindex="-1" />');t.placeholder=i.settings.placeholder||"",i.control.append(t)}),i.on("initialize",()=>{i.control_input.addEventListener("keydown",t=>{switch(t.keyCode){case Xi:i.isOpen&&(Ne(t,!0),i.close()),i.clearActiveItems();return;case Bn:i.focus_node.tabIndex=-1;break}return i.onKeyDown.call(i,t)}),i.on("blur",()=>{i.focus_node.tabIndex=i.isDisabled?-1:i.tabIndex}),i.on("dropdown_open",()=>{i.control_input.focus()});const e=i.onBlur;i.hook("instead","onBlur",t=>{if(!(t&&t.relatedTarget==i.control_input))return e.call(i)}),ke(i.control_input,"blur",()=>i.onBlur()),i.hook("before","close",()=>{i.isOpen&&i.focus_node.focus({preventScroll:!0})})})}function Lo(){var i=this;i.on("initialize",()=>{var e=document.createElement("span"),t=i.control_input;e.style.cssText="position:absolute; top:-99999px; left:-99999px; width:auto; padding:0; white-space:pre; ",i.wrapper.appendChild(e);var n=["letterSpacing","fontSize","fontFamily","fontWeight","textTransform"];for(const r of n)e.style[r]=t.style[r];var o=()=>{e.textContent=t.value,t.style.width=e.clientWidth+"px"};o(),i.on("update item_add item_remove",o),ke(t,"input",o),ke(t,"keyup",o),ke(t,"blur",o),ke(t,"update",o)})}function Mo(){var i=this,e=i.deleteSelection;this.hook("instead","deleteSelection",t=>i.activeItems.length?e.call(i,t):!1)}function Ro(){this.hook("instead","setActiveItem",()=>{}),this.hook("instead","selectAll",()=>{})}function Bo(){var i=this,e=i.onKeyDown;i.hook("instead","onKeyDown",t=>{var n,o,r,c;if(!i.isOpen||!(t.keyCode===Rn||t.keyCode===Vi))return e.call(i,t);i.ignoreHover=!0,c=jt(i.activeOption,"[data-group]"),n=Zt(i.activeOption,"[data-selectable]"),c&&(t.keyCode===Rn?c=c.previousSibling:c=c.nextSibling,c&&(r=c.querySelectorAll("[data-selectable]"),o=r[Math.min(r.length-1,n)],o&&i.setActiveOption(o)))})}function Fo(i){const e=Object.assign({label:"&times;",title:"Remove",className:"remove",append:!0},i);var t=this;if(e.append){var n='<a href="javascript:void(0)" class="'+e.className+'" tabindex="-1" title="'+Wt(e.title)+'">'+e.label+"</a>";t.hook("after","setupTemplates",()=>{var o=t.settings.render.item;t.settings.render.item=(r,c)=>{var p=Ve(o.call(t,r,c)),m=Ve(n);return p.appendChild(m),ke(m,"mousedown",E=>{Ne(E,!0)}),ke(m,"click",E=>{t.isLocked||(Ne(E,!0),!t.isLocked&&t.shouldDelete([p],E)&&(t.removeItem(p),t.refreshOptions(!1),t.inputState()))}),p}})}}function Xo(i){const e=this,t=Object.assign({text:n=>n[e.settings.labelField]},i);e.on("item_remove",function(n){if(e.isFocused&&e.control_input.value.trim()===""){var o=e.options[n];o&&e.setTextboxValue(t.text.call(e,o))}})}function Vo(){const i=this,e=i.canLoad,t=i.clearActiveOption,n=i.loadCallback;var o={},r,c=!1,p,m=[];if(i.settings.shouldLoadMore||(i.settings.shouldLoadMore=()=>{if(r.clientHeight/(r.scrollHeight-r.scrollTop)>.9)return!0;if(i.activeOption){var C=i.selectable(),z=Array.from(C).indexOf(i.activeOption);if(z>=C.length-2)return!0}return!1}),!i.settings.firstUrl)throw"virtual_scroll plugin requires a firstUrl() method";i.settings.sortField=[{field:"$order"},{field:"$score"}];const E=k=>typeof i.settings.maxOptions=="number"&&r.children.length>=i.settings.maxOptions?!1:!!(k in o&&o[k]),w=(k,C)=>i.items.indexOf(C)>=0||m.indexOf(C)>=0;i.setNextUrl=(k,C)=>{o[k]=C},i.getUrl=k=>{if(k in o){const C=o[k];return o[k]=!1,C}return i.clearPagination(),i.settings.firstUrl.call(i,k)},i.clearPagination=()=>{o={}},i.hook("instead","clearActiveOption",()=>{if(!c)return t.call(i)}),i.hook("instead","canLoad",k=>k in o?E(k):e.call(i,k)),i.hook("instead","loadCallback",(k,C)=>{if(!c)i.clearOptions(w);else if(p){const z=k[0];z!==void 0&&(p.dataset.value=z[i.settings.valueField])}n.call(i,k,C),c=!1}),i.hook("after","refreshOptions",()=>{const k=i.lastValue;var C;E(k)?(C=i.render("loading_more",{query:k}),C&&(C.setAttribute("data-selectable",""),p=C)):k in o&&!r.querySelector(".no-results")&&(C=i.render("no_more_results",{query:k})),C&&(qe(C,i.settings.optionClass),r.append(C))}),i.on("initialize",()=>{m=Object.keys(i.options),r=i.dropdown_content,i.settings.render=Object.assign({},{loading_more:()=>'<div class="loading-more-results">Loading more results ... </div>',no_more_results:()=>'<div class="no-more-results">No more results</div>'},i.settings.render),r.addEventListener("scroll",()=>{i.settings.shouldLoadMore.call(i)&&E(i.lastValue)&&(c||(c=!0,i.load.call(i,i.lastValue)))})})}Ke.define("change_listener",To);Ke.define("checkbox_options",Oo);Ke.define("clear_button",No);Ke.define("drag_drop",Ao);Ke.define("dropdown_header",Do);Ke.define("caret_position",Po);Ke.define("dropdown_input",$o);Ke.define("input_autogrow",Lo);Ke.define("no_backspace_delete",Mo);Ke.define("no_active_items",Ro);Ke.define("optgroup_columns",Bo);Ke.define("remove_button",Fo);Ke.define("restore_on_backspace",Xo);Ke.define("virtual_scroll",Vo);async function Uo(i){if(!A.ready)return;const t=(await P.scene.local.getItems(o=>o.layer==="CHARACTER"))?.map(o=>o.id);let n=!1;for(const o of i){const r=o.metadata[`${g.SPECTREID}/metadata_ghosts`];if(r?.length>0){n=!0;const c=r.map(m=>m.id);for(const m of r){const E=m.metadata[`${g.SPECTREID}/viewers`];E&&(E.includes(A.userId)?await P.scene.local.addItems([m]):t.includes(m.id)&&await P.scene.local.deleteItems([m.id]))}const p=t.filter(m=>!c.includes(m));p?.length>0&&await P.scene.local.deleteItems(p)}}n||await P.scene.local.deleteItems(t)}function jo(){const i=document.querySelectorAll(".tSelects");for(const e of i)if(e&&e.tomselect){const t=e.tomselect,n=[];for(const o of A.players)n.push({value:o.id,text:o.name});t.clearOptions(),t.addOption(n),n.length===0?(t.settings.placeholder="No Players",t.inputState()):(t.settings.placeholder="Choose..",t.inputState())}}async function Ho(){let i=A.metadata[`${g.SPECTREID}/stored`];i&&(await P.scene.local.addItems(i),i.forEach(e=>{ji(e)}))}async function Wo(){P.scene.local.onChange(async i=>{const e=i.filter(n=>n.layer=="CHARACTER");if(e.length===0)return;const t={};t[`${g.SPECTREID}/metadata_ghosts`]=e,await P.player.setMetadata(t)}),await P.contextMenu.create({id:`${g.SPECTREID}/context-menu`,icons:[{icon:"/ghost.svg",label:"Spectre",filter:{every:[{key:"layer",value:"CHARACTER"},{key:["metadata",`${g.SPECTREID}/spectred`],value:void 0,operator:"==",coordinator:"&&"}]}},{icon:"/ghost.svg",label:"Un-Spectre",filter:{every:[{key:"layer",value:"CHARACTER"},{key:["metadata",`${g.SPECTREID}/spectred`],value:void 0,operator:"!=",coordinator:"&&"}]}}],async onClick(i){if(i.items.every(t=>t.metadata[`${g.SPECTREID}/spectred`]===void 0)){document.getElementById("spectreWarning").style.display="none";for(const t of i.items)ji(t)}else for(const t of i.items){const n=t;n.metadata[`${g.SPECTREID}/spectred`]=void 0;const o=A.ghosts.findIndex(c=>c.id===n.id);A.ghosts.splice(o,1),document.getElementById(`tr-${n.id}`)?.remove(),await Ui(n),n.metadata[`${g.SPECTREID}/viewers`]=[],await P.scene.items.addItems([n])}}})}async function Ui(i){const t=A.metadata[`${g.SPECTREID}/stored`].filter(n=>n.id!==i.id);await P.scene.setMetadata({[`${g.SPECTREID}/stored`]:t}),await P.scene.local.deleteItems([i.id])}async function Go(i){let e=A.metadata[`${g.SPECTREID}/stored`];if(!e)e=[i];else{if(e.find(n=>n.id===i.id))return;e.push(i)}await P.scene.setMetadata({[`${g.SPECTREID}/stored`]:e})}async function ji(i){const e=i.text?.plainText||i.name;i.metadata[`${g.SPECTREID}/spectred`]=!0,await P.scene.items.deleteItems([i.id]),await P.scene.local.addItems([i]),await Go(i),A.ghosts.push(i);const t=document.getElementById("ghostList"),n=document.createElement("tr");n.id=`tr-${i.id}`,n.className="ghost-table-entry",n.innerHTML=`<td class="token-name">${e}</td>
        <td><select id="select-${i.id}" class="tSelects" multiple autocomplete="off" /></td>
        <td><input type="button" class="mysteryButton" id="deleteGhost-${i.id}" value="Delete"/></td>`,t.appendChild(n);const o=document.getElementById(`select-${i.id}`);for(const p of A.players){const m=document.createElement("option");m.value=p.id,m.text=p.name,o.appendChild(m)}const r={plugins:{remove_button:{title:"Remove this item"}},allowEmptyOption:!0,placeholder:A.players.length==0?"No Players":"Choose..",maxItems:null,create:!1,onDelete:async function(p,m){const E=m.currentTarget.parentElement.parentElement.parentElement.parentElement.parentElement.id.slice(3);await P.scene.local.updateItems([E],w=>{const k=w[0].metadata[`${g.SPECTREID}/viewers`],C=k.findIndex(z=>z==p);k.splice(C,1),w[0].metadata[`${g.SPECTREID}/viewers`]=k})},onItemAdd:async function(p,m){const E=m.parentElement.parentElement.parentElement.parentElement.id.slice(3);await P.scene.local.updateItems([E],w=>{const k=w[0].metadata[`${g.SPECTREID}/viewers`];k?(k.push(p),w[0].metadata[`${g.SPECTREID}/viewers`]=k):w[0].metadata[`${g.SPECTREID}/viewers`]=[p]})}};new Ke(`#select-${i.id}`,r);const c=document.getElementById(`deleteGhost-${i.id}`);c.onclick=async()=>{const p=A.ghosts.findIndex(m=>m.id===i.id);A.ghosts.splice(p,1),n.remove(),await P.scene.local.updateItems([i.id],m=>{m[0].metadata[`${g.SPECTREID}/viewers`]=[]}),await Ui(i)}}var Hi={exports:{}};(function(i){(function(){function e(p,m){var E=p.x-m.x,w=p.y-m.y;return E*E+w*w}function t(p,m,E){var w=m.x,k=m.y,C=E.x-w,z=E.y-k;if(C!==0||z!==0){var N=((p.x-w)*C+(p.y-k)*z)/(C*C+z*z);N>1?(w=E.x,k=E.y):N>0&&(w+=C*N,k+=z*N)}return C=p.x-w,z=p.y-k,C*C+z*z}function n(p,m){for(var E=p[0],w=[E],k,C=1,z=p.length;C<z;C++)k=p[C],e(k,E)>m&&(w.push(k),E=k);return E!==k&&w.push(k),w}function o(p,m,E,w,k){for(var C=w,z,N=m+1;N<E;N++){var R=t(p[N],p[m],p[E]);R>C&&(z=N,C=R)}C>w&&(z-m>1&&o(p,m,z,w,k),k.push(p[z]),E-z>1&&o(p,z,E,w,k))}function r(p,m){var E=p.length-1,w=[p[0]];return o(p,0,E,m,w),w.push(p[E]),w}function c(p,m,E){if(p.length<=2)return p;var w=m!==void 0?m*m:1;return p=E?p:n(p,w),p=r(p,w),p}i.exports=c,i.exports.default=c})()})(Hi);var qo=Hi.exports;const zo=Xn(qo);async function Wi(i){const e=await P.scene.items.getItems(o=>o.layer==="MAP"),t={};for(let o=0;o<e.length;o++){let r=i.querySelector("#map-"+e[o].id);r===null&&(r=document.createElement("option"),r.id="map-"+e[o].id,r.value=e[o].id,r.innerText=e[o].name,i.appendChild(r)),t[e[o].id]=e[o].name}let n=i.querySelectorAll("option");for(let o=0;o<n.length;o++)t[n[o].value]===void 0&&i.removeChild(n[o])}async function Ko(i,e,t,n,o){if(o.innerText="",Number.isNaN(t)||t<0){o.innerText="Invalid DPI";return}let r=A.gridDpi/t,c,p=[];if(p[0]=0,p[1]=0,n!==""){let m=await P.scene.items.getItems([n]);if(m.length>0)c=m[0],t===0&&(t=c.grid.dpi),r=A.gridDpi/t,p[0]=c.position.x-c.grid.offset.x*r,p[1]=c.position.y-c.grid.offset.y*r;else{o.innerText="Unable to find map";return}}else{o.innerText="No map selected";return}i==="foundry"?Zo(e,r,p,o):i==="uvtt"&&Yo(e,r,p,o)}function Gi(i,e,t,n,o){let r=0,c=0,p=0;const m=[];for(let E=0;E<i.length;E++){let w=[],k=!1;for(let C=0;C<i[E].length-1;C++){let z=i[E][C].x*e,N=i[E][C].y*e,R=i[E][C+1].x*e,x=i[E][C+1].y*e;w.push({x:z*t+n[0],y:N*t+n[1]}),w.push({x:R*t+n[0],y:x*t+n[1]}),c++,!k&&i[E][C].door&&(k=!0)}w.length>128&&(w.length,w=zo(w,8,!1));for(let C=0;C<w.length;C+=256){const z=w.slice(C>0?C-1:0,C+256),N=Fn().tension(0).points(z).fillColor("#000000").fillOpacity(0).layer("DRAWING").name("Vision Line (Line)").closed(!1).build();if(N.visible=!1,N.metadata[`${g.EXTENSIONID}/isVisionLine`]=!0,k&&(N.metadata[`${g.EXTENSIONID}/isDoor`]=!0),m.push(N),p+=z.length,p>512||m.length>64){r+=m.length,P.scene.items.addItems(m);const R=m.filter(x=>x.metadata[`${g.EXTENSIONID}/isDoor`]===!0);qt(R),m.length=0,p=0}}}if(m.length>0){r+=m.length,P.scene.items.addItems(m);const E=m.filter(w=>w.metadata[`${g.EXTENSIONID}/isDoor`]===!0);qt(E)}o.innerText="Finished importing "+r+" walls, "+c+" points."}function Yo(i,e,t,n){if(!i.line_of_sight||i.line_of_sight.length===0){n.innerText="No walls / los found";return}if(i.resolution.map_origin!==void 0&&(t[0]-=i.resolution.map_origin.x*i.resolution.pixels_per_grid,t[1]-=i.resolution.map_origin.y*i.resolution.pixels_per_grid),i.portals&&i.portals.length)for(let o=0;o<i.portals.length;o++){let r=i.portals[o].bounds;r[0].door=!0,r[1].door=!0,i.line_of_sight.push(r)}Gi(i.line_of_sight,i.resolution.pixels_per_grid,e,t,n)}function Zo(i,e,t,n){if(!i.walls||i.walls.length===0){n.innerText="No walls found";return}const o=[];for(var r=0;r<i.walls.length;r++)o.push([{x:i.walls[r].c[0],y:i.walls[r].c[1],door:!!i.walls[r].door},{x:i.walls[r].c[2],y:i.walls[r].c[3],door:!!i.walls[r].door}]);Gi(o,1,e,t,n)}var Ze=function(){/*!
* Copyright (c) 2021-2023 Momo Bassit.
* Licensed under the MIT License (MIT)
* https://github.com/mdbassit/Coloris
* Version: 0.21.1
* NPM: https://github.com/melloware/coloris-npm
*/return function(i,e,t,n){var o=e.createElement("canvas").getContext("2d"),r={r:0,g:0,b:0,h:0,s:0,v:0,a:1},c,p,m,E,w,k,C,z,N,R,x,M,D,F,B,J,T={},v={el:"[data-coloris]",parent:"body",theme:"default",themeMode:"light",rtl:!1,wrap:!0,margin:2,format:"hex",formatToggle:!1,swatches:[],swatchesOnly:!1,alpha:!0,forceAlpha:!1,focusInput:!0,selectInput:!1,inline:!1,defaultColor:"#000000",clearButton:!1,clearLabel:"Clear",closeButton:!1,closeLabel:"Close",onChange:function(){return n},a11y:{open:"Open color picker",close:"Close color picker",clear:"Clear the selected color",marker:"Saturation: {s}. Brightness: {v}.",hueSlider:"Hue slider",alphaSlider:"Opacity slider",input:"Color value field",format:"Color format",swatch:"Color swatch",instruction:"Saturation and brightness selector. Use up, down, left and right arrow keys to select."}},h={},I="",d={},_=!1;function $(S){if(typeof S=="object"){var U=function(){switch(H){case"el":fe(S.el),S.wrap!==!1&&he(S.el);break;case"parent":c=e.querySelector(S.parent),c&&(c.appendChild(p),v.parent=S.parent,c===e.body&&(c=n));break;case"themeMode":v.themeMode=S.themeMode,S.themeMode==="auto"&&i.matchMedia&&i.matchMedia("(prefers-color-scheme: dark)").matches&&(v.themeMode="dark");case"theme":S.theme&&(v.theme=S.theme),p.className="clr-picker clr-"+v.theme+" clr-"+v.themeMode,v.inline&&me();break;case"rtl":v.rtl=!!S.rtl,e.querySelectorAll(".clr-field").forEach(function(Xe){return Xe.classList.toggle("clr-rtl",v.rtl)});break;case"margin":S.margin*=1,v.margin=isNaN(S.margin)?v.margin:S.margin;break;case"wrap":S.el&&S.wrap&&he(S.el);break;case"formatToggle":v.formatToggle=!!S.formatToggle,de("clr-format").style.display=v.formatToggle?"block":"none",v.formatToggle&&(v.format="auto");break;case"swatches":if(Array.isArray(S.swatches)){var ce=[];S.swatches.forEach(function(Xe,we){ce.push('<button type="button" id="clr-swatch-'+we+'" aria-labelledby="clr-swatch-label clr-swatch-'+we+'" style="color: '+Xe+';">'+Xe+"</button>")}),de("clr-swatches").innerHTML=ce.length?"<div>"+ce.join("")+"</div>":"",v.swatches=S.swatches.slice()}break;case"swatchesOnly":v.swatchesOnly=!!S.swatchesOnly,p.setAttribute("data-minimal",v.swatchesOnly);break;case"alpha":v.alpha=!!S.alpha,p.setAttribute("data-alpha",v.alpha);break;case"inline":if(v.inline=!!S.inline,p.setAttribute("data-inline",v.inline),v.inline){var ge=S.defaultColor||v.defaultColor;F=Re(ge),me(),Ie(ge)}break;case"clearButton":typeof S.clearButton=="object"&&(S.clearButton.label&&(v.clearLabel=S.clearButton.label,C.innerHTML=v.clearLabel),S.clearButton=S.clearButton.show),v.clearButton=!!S.clearButton,C.style.display=v.clearButton?"block":"none";break;case"clearLabel":v.clearLabel=S.clearLabel,C.innerHTML=v.clearLabel;break;case"closeButton":v.closeButton=!!S.closeButton,v.closeButton?p.insertBefore(z,w):w.appendChild(z);break;case"closeLabel":v.closeLabel=S.closeLabel,z.innerHTML=v.closeLabel;break;case"a11y":var pe=S.a11y,Ae=!1;if(typeof pe=="object")for(var ye in pe)pe[ye]&&v.a11y[ye]&&(v.a11y[ye]=pe[ye],Ae=!0);if(Ae){var Fe=de("clr-open-label"),Se=de("clr-swatch-label");Fe.innerHTML=v.a11y.open,Se.innerHTML=v.a11y.swatch,z.setAttribute("aria-label",v.a11y.close),C.setAttribute("aria-label",v.a11y.clear),N.setAttribute("aria-label",v.a11y.hueSlider),x.setAttribute("aria-label",v.a11y.alphaSlider),k.setAttribute("aria-label",v.a11y.input),m.setAttribute("aria-label",v.a11y.instruction)}break;default:v[H]=S[H]}};for(var H in S)U()}}function re(S,U){typeof S=="string"&&typeof U=="object"&&(h[S]=U,_=!0)}function oe(S){delete h[S],Object.keys(h).length===0&&(_=!1,S===I&&Y())}function ae(S){if(_){var U=["el","wrap","rtl","inline","defaultColor","a11y"],H=function(){var pe=h[ee];if(S.matches(ee)){I=ee,d={},U.forEach(function(ye){return delete pe[ye]});for(var Ae in pe)d[Ae]=Array.isArray(v[Ae])?v[Ae].slice():v[Ae];return $(pe),"break"}};for(var ee in h){var ce=H();if(ce==="break")break}}}function Y(){Object.keys(d).length>0&&($(d),I="",d={})}function fe(S){be(e,"click",S,function(U){v.inline||(ae(U.target),D=U.target,B=D.value,F=Re(B),p.classList.add("clr-open"),me(),Ie(B),(v.focusInput||v.selectInput)&&(k.focus({preventScroll:!0}),k.setSelectionRange(D.selectionStart,D.selectionEnd)),v.selectInput&&k.select(),(J||v.swatchesOnly)&&xe().shift().focus(),D.dispatchEvent(new Event("open",{bubbles:!0})))}),be(e,"input",S,function(U){var H=U.target.parentNode;H.classList.contains("clr-field")&&(H.style.color=U.target.value)})}function me(){if(!(!p||!D&&!v.inline)){var S=c,U=i.scrollY,H=p.offsetWidth,ee=p.offsetHeight,ce={left:!1,top:!1},ge,pe,Ae,ye={x:0,y:0};if(S&&(ge=i.getComputedStyle(S),pe=parseFloat(ge.marginTop),Ae=parseFloat(ge.borderTopWidth),ye=S.getBoundingClientRect(),ye.y+=Ae+U),!v.inline){var Fe=D.getBoundingClientRect(),Se=Fe.x,Xe=U+Fe.y+Fe.height+v.margin;S?(Se-=ye.x,Xe-=ye.y,Se+H>S.clientWidth&&(Se+=Fe.width-H,ce.left=!0),Xe+ee>S.clientHeight-pe&&ee+v.margin<=Fe.top-(ye.y-U)&&(Xe-=Fe.height+ee+v.margin*2,ce.top=!0),Xe+=S.scrollTop):(Se+H>e.documentElement.clientWidth&&(Se+=Fe.width-H,ce.left=!0),Xe+ee-U>e.documentElement.clientHeight&&ee+v.margin<=Fe.top&&(Xe=U+Fe.y-ee-v.margin,ce.top=!0)),p.classList.toggle("clr-left",ce.left),p.classList.toggle("clr-top",ce.top),p.style.left=Se+"px",p.style.top=Xe+"px",ye.x+=p.offsetLeft,ye.y+=p.offsetTop}T={width:m.offsetWidth,height:m.offsetHeight,x:m.offsetLeft+ye.x,y:m.offsetTop+ye.y}}}function he(S){e.querySelectorAll(S).forEach(function(U){var H=U.parentNode;if(!H.classList.contains("clr-field")){var ee=e.createElement("div"),ce="clr-field";(v.rtl||U.classList.contains("clr-rtl"))&&(ce+=" clr-rtl"),ee.innerHTML='<button type="button" aria-labelledby="clr-open-label"></button>',H.insertBefore(ee,U),ee.setAttribute("class",ce),ee.style.color=U.value,ee.appendChild(U)}})}function se(S){if(D&&!v.inline){var U=D;S&&(D=n,B!==U.value&&(U.value=B,U.dispatchEvent(new Event("input",{bubbles:!0})))),setTimeout(function(){B!==U.value&&U.dispatchEvent(new Event("change",{bubbles:!0}))}),p.classList.remove("clr-open"),_&&Y(),U.dispatchEvent(new Event("close",{bubbles:!0})),v.focusInput&&U.focus({preventScroll:!0}),D=n}}function Ie(S){var U=ue(S),H=te(U);Ee(H.s,H.v),f(U,H),N.value=H.h,p.style.color="hsl("+H.h+", 100%, 50%)",R.style.left=H.h/360*100+"%",E.style.left=T.width*H.s/100+"px",E.style.top=T.height-T.height*H.v/100+"px",x.value=H.a*100,M.style.left=H.a*100+"%"}function Re(S){var U=S.substring(0,3).toLowerCase();return U==="rgb"||U==="hsl"?U:"hex"}function ve(S){S=S!==n?S:k.value,D&&(D.value=S,D.dispatchEvent(new Event("input",{bubbles:!0}))),v.onChange&&v.onChange.call(i,S,D),e.dispatchEvent(new CustomEvent("coloris:pick",{detail:{color:S,currentEl:D}}))}function Me(S,U){var H={h:N.value*1,s:S/T.width*100,v:100-U/T.height*100,a:x.value/100},ee=X(H);Ee(H.s,H.v),f(ee,H),ve()}function Ee(S,U){var H=v.a11y.marker;S=S.toFixed(1)*1,U=U.toFixed(1)*1,H=H.replace("{s}",S),H=H.replace("{v}",U),E.setAttribute("aria-label",H)}function Be(S){return{pageX:S.changedTouches?S.changedTouches[0].pageX:S.pageX,pageY:S.changedTouches?S.changedTouches[0].pageY:S.pageY}}function je(S){var U=Be(S),H=U.pageX-T.x,ee=U.pageY-T.y;c&&(ee+=c.scrollTop),l(H,ee),S.preventDefault(),S.stopPropagation()}function K(S,U){var H=E.style.left.replace("px","")*1+S,ee=E.style.top.replace("px","")*1+U;l(H,ee)}function l(S,U){S=S<0?0:S>T.width?T.width:S,U=U<0?0:U>T.height?T.height:U,E.style.left=S+"px",E.style.top=U+"px",Me(S,U),E.focus()}function f(S,U){S===void 0&&(S={}),U===void 0&&(U={});var H=v.format;for(var ee in S)r[ee]=S[ee];for(var ce in U)r[ce]=U[ce];var ge=le(r),pe=ge.substring(0,7);switch(E.style.color=pe,M.parentNode.style.color=pe,M.style.color=ge,w.style.color=ge,m.style.display="none",m.offsetHeight,m.style.display="",M.nextElementSibling.style.display="none",M.nextElementSibling.offsetHeight,M.nextElementSibling.style.display="",H==="mixed"?H=r.a===1?"hex":"rgb":H==="auto"&&(H=F),H){case"hex":k.value=ge;break;case"rgb":k.value=$e(r);break;case"hsl":k.value=Le(q(r));break}e.querySelector('.clr-format [value="'+H+'"]').checked=!0}function b(){var S=N.value*1,U=E.style.left.replace("px","")*1,H=E.style.top.replace("px","")*1;p.style.color="hsl("+S+", 100%, 50%)",R.style.left=S/360*100+"%",Me(U,H)}function j(){var S=x.value/100;M.style.left=S*100+"%",f({a:S}),ve()}function X(S){var U=S.s/100,H=S.v/100,ee=U*H,ce=S.h/60,ge=ee*(1-t.abs(ce%2-1)),pe=H-ee;ee=ee+pe,ge=ge+pe;var Ae=t.floor(ce)%6,ye=[ee,ge,pe,pe,ge,ee][Ae],Fe=[ge,ee,ee,ge,pe,pe][Ae],Se=[pe,pe,ge,ee,ee,ge][Ae];return{r:t.round(ye*255),g:t.round(Fe*255),b:t.round(Se*255),a:S.a}}function q(S){var U=S.v/100,H=U*(1-S.s/100/2),ee;return H>0&&H<1&&(ee=t.round((U-H)/t.min(H,1-H)*100)),{h:S.h,s:ee||0,l:t.round(H*100),a:S.a}}function te(S){var U=S.r/255,H=S.g/255,ee=S.b/255,ce=t.max(U,H,ee),ge=t.min(U,H,ee),pe=ce-ge,Ae=ce,ye=0,Fe=0;return pe&&(ce===U&&(ye=(H-ee)/pe),ce===H&&(ye=2+(ee-U)/pe),ce===ee&&(ye=4+(U-H)/pe),ce&&(Fe=pe/ce)),ye=t.floor(ye*60),{h:ye<0?ye+360:ye,s:t.round(Fe*100),v:t.round(Ae*100),a:S.a}}function ue(S){var U=/^((rgba)|rgb)[\D]+([\d.]+)[\D]+([\d.]+)[\D]+([\d.]+)[\D]*?([\d.]+|$)/i,H,ee;return o.fillStyle="#000",o.fillStyle=S,H=U.exec(o.fillStyle),H?(ee={r:H[3]*1,g:H[4]*1,b:H[5]*1,a:H[6]*1},ee.a=+ee.a.toFixed(2)):(H=o.fillStyle.replace("#","").match(/.{2}/g).map(function(ce){return parseInt(ce,16)}),ee={r:H[0],g:H[1],b:H[2],a:1}),ee}function le(S){var U=S.r.toString(16),H=S.g.toString(16),ee=S.b.toString(16),ce="";if(S.r<16&&(U="0"+U),S.g<16&&(H="0"+H),S.b<16&&(ee="0"+ee),v.alpha&&(S.a<1||v.forceAlpha)){var ge=S.a*255|0;ce=ge.toString(16),ge<16&&(ce="0"+ce)}return"#"+U+H+ee+ce}function $e(S){return!v.alpha||S.a===1&&!v.forceAlpha?"rgb("+S.r+", "+S.g+", "+S.b+")":"rgba("+S.r+", "+S.g+", "+S.b+", "+S.a+")"}function Le(S){return!v.alpha||S.a===1&&!v.forceAlpha?"hsl("+S.h+", "+S.s+"%, "+S.l+"%)":"hsla("+S.h+", "+S.s+"%, "+S.l+"%, "+S.a+")"}function Ce(){e.getElementById("clr-picker")||(c=n,p=e.createElement("div"),p.setAttribute("id","clr-picker"),p.className="clr-picker",p.innerHTML='<input id="clr-color-value" name="clr-color-value" class="clr-color" type="text" value="" spellcheck="false" aria-label="'+v.a11y.input+'">'+('<div id="clr-color-area" class="clr-gradient" role="application" aria-label="'+v.a11y.instruction+'">')+'<div id="clr-color-marker" class="clr-marker" tabindex="0"></div></div><div class="clr-hue">'+('<input id="clr-hue-slider" name="clr-hue-slider" type="range" min="0" max="360" step="1" aria-label="'+v.a11y.hueSlider+'">')+'<div id="clr-hue-marker"></div></div><div class="clr-alpha">'+('<input id="clr-alpha-slider" name="clr-alpha-slider" type="range" min="0" max="100" step="1" aria-label="'+v.a11y.alphaSlider+'">')+'<div id="clr-alpha-marker"></div><span></span></div><div id="clr-format" class="clr-format"><fieldset class="clr-segmented">'+("<legend>"+v.a11y.format+"</legend>")+'<input id="clr-f1" type="radio" name="clr-format" value="hex"><label for="clr-f1">Hex</label><input id="clr-f2" type="radio" name="clr-format" value="rgb"><label for="clr-f2">RGB</label><input id="clr-f3" type="radio" name="clr-format" value="hsl"><label for="clr-f3">HSL</label><span></span></fieldset></div><div id="clr-swatches" class="clr-swatches"></div>'+('<button type="button" id="clr-clear" class="clr-clear" aria-label="'+v.a11y.clear+'">'+v.clearLabel+"</button>")+'<div id="clr-color-preview" class="clr-preview">'+('<button type="button" id="clr-close" class="clr-close" aria-label="'+v.a11y.close+'">'+v.closeLabel+"</button>")+"</div>"+('<span id="clr-open-label" hidden>'+v.a11y.open+"</span>")+('<span id="clr-swatch-label" hidden>'+v.a11y.swatch+"</span>"),e.body.appendChild(p),m=de("clr-color-area"),E=de("clr-color-marker"),C=de("clr-clear"),z=de("clr-close"),w=de("clr-color-preview"),k=de("clr-color-value"),N=de("clr-hue-slider"),R=de("clr-hue-marker"),x=de("clr-alpha-slider"),M=de("clr-alpha-marker"),fe(v.el),he(v.el),be(p,"mousedown",function(S){p.classList.remove("clr-keyboard-nav"),S.stopPropagation()}),be(m,"mousedown",function(S){be(e,"mousemove",je)}),be(m,"touchstart",function(S){e.addEventListener("touchmove",je,{passive:!1})}),be(E,"mousedown",function(S){be(e,"mousemove",je)}),be(E,"touchstart",function(S){e.addEventListener("touchmove",je,{passive:!1})}),be(k,"change",function(S){var U=k.value;if(D||v.inline){var H=U===""?U:Ie(U);ve(H)}}),be(C,"click",function(S){ve(""),se()}),be(z,"click",function(S){ve(),se()}),be(de("clr-format"),"click",".clr-format input",function(S){F=S.target.value,f(),ve()}),be(p,"click",".clr-swatches button",function(S){Ie(S.target.textContent),ve(),v.swatchesOnly&&se()}),be(e,"mouseup",function(S){e.removeEventListener("mousemove",je)}),be(e,"touchend",function(S){e.removeEventListener("touchmove",je)}),be(e,"mousedown",function(S){J=!1,p.classList.remove("clr-keyboard-nav"),se()}),be(e,"keydown",function(S){var U=S.key,H=S.target,ee=S.shiftKey,ce=["Tab","ArrowUp","ArrowDown","ArrowLeft","ArrowRight"];if(U==="Escape"?se(!0):ce.includes(U)&&(J=!0,p.classList.add("clr-keyboard-nav")),U==="Tab"&&H.matches(".clr-picker *")){var ge=xe(),pe=ge.shift(),Ae=ge.pop();ee&&H===pe?(Ae.focus(),S.preventDefault()):!ee&&H===Ae&&(pe.focus(),S.preventDefault())}}),be(e,"click",".clr-field button",function(S){_&&Y(),S.target.nextElementSibling.dispatchEvent(new Event("click",{bubbles:!0}))}),be(E,"keydown",function(S){var U={ArrowUp:[0,-1],ArrowDown:[0,1],ArrowLeft:[-1,0],ArrowRight:[1,0]};Object.keys(U).includes(S.key)&&(K.apply(void 0,U[S.key]),S.preventDefault())}),be(m,"click",je),be(N,"input",b),be(x,"input",j))}function xe(){var S=Array.from(p.querySelectorAll("input, button")),U=S.filter(function(H){return!!H.offsetWidth});return U}function de(S){return e.getElementById(S)}function be(S,U,H,ee){var ce=Element.prototype.matches||Element.prototype.msMatchesSelector;typeof H=="string"?S.addEventListener(U,function(ge){ce.call(ge.target,H)&&ee.call(ge.target,ge)}):(ee=H,S.addEventListener(U,ee))}function Ye(S,U){U=U!==n?U:[],e.readyState!=="loading"?S.apply(void 0,U):e.addEventListener("DOMContentLoaded",function(){S.apply(void 0,U)})}NodeList!==n&&NodeList.prototype&&!NodeList.prototype.forEach&&(NodeList.prototype.forEach=Array.prototype.forEach);function lt(S,U){D=U,B=D.value,ae(U),F=Re(S),me(),Ie(S),ve(),B!==S&&D.dispatchEvent(new Event("change",{bubbles:!0}))}var nt=function(){var S={init:Ce,set:$,wrap:he,close:se,setInstance:re,setColor:lt,removeInstance:oe,updatePosition:me};function U(ce){Ye(function(){ce&&(typeof ce=="string"?fe(ce):$(ce))})}var H=function(ge){U[ge]=function(){for(var pe=arguments.length,Ae=new Array(pe),ye=0;ye<pe;ye++)Ae[ye]=arguments[ye];Ye(S[ge],Ae)}};for(var ee in S)H(ee);return Ye(function(){i.addEventListener("resize",function(ce){U.updatePosition()}),i.addEventListener("scroll",function(ce){U.updatePosition()})}),U}();return nt.coloris=nt,nt}(window,document,Math)}();Ze.coloris;Ze.init;Ze.set;Ze.wrap;Ze.close;Ze.setInstance;Ze.removeInstance;Ze.updatePosition;function Qo(i){for(const e in i)if(i.hasOwnProperty(e))return!1;return!0}function Ti(){try{localStorage.setItem("STORAGECHECK","test")}catch{const e=document.getElementById("localStorageWarning");e.innerText="Local Storage disabled. Some features will not function."}}function qi(i,e){const t=window.matchMedia("(prefers-color-scheme: dark)"),n=t.matches?"dark":"light",o=t.matches?"light":"dark";for(var r=0;r<e.styleSheets.length;r++)for(var c=0;c<e.styleSheets[r].cssRules.length;c++){let p=e.styleSheets[r].cssRules[c];p&&p.media&&p.media.mediaText.includes("prefers-color-scheme")&&(i.mode=="LIGHT"?(p.media.appendMedium(`(prefers-color-scheme: ${n})`),p.media.mediaText.includes(o)&&p.media.deleteMedium(`(prefers-color-scheme: ${o})`)):i.mode=="DARK"&&(p.media.appendMedium(`(prefers-color-scheme: ${o})`),p.media.mediaText.includes(n)&&p.media.deleteMedium(`(prefers-color-scheme: ${n})`)))}}async function jn(){const i=A.items.filter(Ni);if(!A.metadata[`${g.EXTENSIONID}/autodetectEnabled`])if(i.length==0){let e=Et().width(A.gridDpi*30).height(A.gridDpi*30).visible(!1).shapeType("RECTANGLE").visible(!0).locked(!1).strokeColor("pink").fillOpacity(0).strokeDash([200,500]).strokeWidth(50).build();e.metadata[`${g.EXTENSIONID}/isBackgroundImage`]=!0,e.id=g.GRIDID,await P.scene.items.addItems([e])}else A.items.find(e=>e.id===g.GRIDID),await P.scene.items.updateItems([g.GRIDID],e=>{e[0].visible=!1,e[0].style.strokeOpacity=1,e[0].disableHit=!1});A.metadata[`${g.EXTENSIONID}/autodetectEnabled`]===!0&&i.length>0&&await P.scene.items.updateItems([g.GRIDID],e=>{e[0].visible=!1,e[0].style.strokeOpacity=.1,e[0].disableHit=!0})}function Jo(i){const e=document.getElementById(`tr-${i.id}`);if(e){const t=e.getElementsByClassName("token-name")[0],n=e.getElementsByClassName("token-vision-range")[0],o=e.getElementsByClassName("unlimited-vision")[0],r=e.getElementsByClassName("no-vision")[0];t&&(t.innerText=i.name),n&&!o.checked&&!r.checked&&(n.value=i.metadata[`${g.EXTENSIONID}/visionRange`]?i.metadata[`${g.EXTENSIONID}/visionRange`]:g.VISIONDEFAULT),o&&(o.checked=i.metadata[`${g.EXTENSIONID}/visionRange`]===0),r&&(r.checked=i.metadata[`${g.EXTENSIONID}/visionBlind`]),o.checked||r.checked?n.setAttribute("disabled","disabled"):n.removeAttribute("disabled")}else{const t=A.items.find(m=>m.id===i.id),n=document.createElement("tr");n.id=`tr-${t.id}`,n.className="token-table-entry",n.innerHTML=`<td class="token-name">${t.name}</td>
                           <td><input class="token-vision-range" type="number" value=${g.VISIONDEFAULT}><span class="unit">ft</span></td>
                           <td>
                            <div class="cbutton"><label title="Unlimited vision range"><input type="checkbox" class="unlimited-vision"><span>&infin;</span></label></div>
                            <div class="cbutton"><label title="Turn token into a light source"><input type="checkbox" class="torch-vision"><span>&#128294;</span></label></div>
                            <div class="cbutton"><label title="Disable vision on this token"><input type="checkbox" class="no-vision"><span>None</span></label></div>
                           </td>`,ne.table.appendChild(n);const o=n.getElementsByClassName("token-vision-range")[0],r=n.getElementsByClassName("unlimited-vision")[0],c=n.getElementsByClassName("torch-vision")[0],p=n.getElementsByClassName("no-vision")[0];o&&!r.checked&&!p.checked&&(o.value=i.metadata[`${g.EXTENSIONID}/visionRange`]?i.metadata[`${g.EXTENSIONID}/visionRange`]:g.VISIONDEFAULT),r&&(r.checked=i.metadata[`${g.EXTENSIONID}/visionRange`]===0),c&&(c.checked=i.metadata[`${g.EXTENSIONID}/visionTorch`]),p&&(p.checked=i.metadata[`${g.EXTENSIONID}/visionBlind`]),r.checked||p.checked?o.setAttribute("disabled","disabled"):o.removeAttribute("disabled"),o.onchange=async m=>{if(!m||!m.target)return;const E=A.items.find(C=>C.id===i.id),w=m.target,k=parseInt(w.value);k<0&&(w.value="0"),k>999&&(w.value="999"),await P.scene.items.updateItems([E],C=>{C[0].metadata[`${g.EXTENSIONID}/visionRange`]=k})},r.onclick=async m=>{if(!m||!m.target)return;const E=A.items.find(C=>C.id===i.id);let w=0;m.target.checked?(o.setAttribute("disabled","disabled"),p.checked=!1):(w=parseInt(o.value),o.removeAttribute("disabled")),await P.scene.items.updateItems([E],C=>{C[0].metadata[`${g.EXTENSIONID}/visionRange`]=w})},p.onclick=async m=>{if(!m||!m.target)return;const E=A.items.find(k=>k.id===i.id),w=m.target;w.checked?o.setAttribute("disabled","disabled"):o.removeAttribute("disabled"),await P.scene.items.updateItems([E],k=>{k[0].metadata[`${g.EXTENSIONID}/visionBlind`]=w.checked})},c.onclick=async m=>{if(!m||!m.target)return;const E=A.items.find(k=>k.id===i.id),w=m.target;await P.scene.items.updateItems([E],k=>{k[0].metadata[`${g.EXTENSIONID}/visionTorch`]=w.checked})},o.addEventListener("mousewheel",async()=>{})}}async function zi(){let i,e;[A.items,A.metadata,A.gridDpi,A.gridScale,i,e]=await Promise.all([P.scene.items.getItems(),P.scene.getMetadata(),P.scene.grid.getDpi(),P.scene.grid.getScale(),P.scene.fog.getFilled(),P.scene.fog.getColor()]),await P.scene.items.deleteItems(A.items.filter(mt).map(n=>n.id)),A.snap=!0,A.gridScale=A.gridScale?.parsed?.multiplier??5,A.fog={filled:i,style:{color:e,strokeWidth:5}};let t;if(A.items.filter(br).length==0){const n=A.items.filter(r=>r.layer=="MAP"&&on(r)),o=n.map(r=>r.image.width*r.image.height/Math.pow(r.grid.dpi,2));t=n[o.indexOf(Math.max(...o))]}if(A.metadata[`${g.EXTENSIONID}/autodetectEnabled`]===void 0&&(A.role==="GM"&&(ne.autodetectCheckbox.checked=!0),await P.scene.setMetadata({[`${g.EXTENSIONID}/autodetectEnabled`]:!0})),jn(),A.metadata[`${g.EXTENSIONID}/sceneId`]===void 0)await P.scene.setMetadata({[`${g.EXTENSIONID}/sceneId`]:crypto.randomUUID()});else try{const n=A.metadata[`${g.EXTENSIONID}/sceneId`],o=localStorage.getItem(`${g.EXTENSIONID}/fogCache/${A.userId}/${n}`);if(o!==null&&A.metadata[`${g.EXTENSIONID}/persistenceEnabled`]===!0){const r=JSON.parse(o),c=[];for(let p=0;p<r.length;p++){const m=Ot().commands(r[p].commands).fillRule("evenodd").locked(!0).visible(!1).fillColor("#000000").strokeColor("#000000").layer("FOG").name("Fog of War").metadata({[`${g.EXTENSIONID}/isVisionFog`]:!0,[`${g.EXTENSIONID}/digest`]:r[p].digest}).build();m.zIndex=3,c.push(m)}await P.scene.local.addItems(c)}}catch{}A.role=="GM"&&(await Ho(),ne.mapSubmit.onclick=async()=>{await P.scene.items.updateItems([g.GRIDID],n=>{for(const o of n){const r=o;r.width=A.gridDpi*+ne.mapWidth.value,r.height=A.gridDpi*+ne.mapHeight.value,r.scale={x:1,y:1}}})},await ne.UpdateUI(),t!==void 0&&await P.scene.items.updateItems([t],n=>{n[0].metadata[`${g.EXTENSIONID}/isBackgroundImage`]=!0})),A.initialized=!0}async function ea(){await P.contextMenu.create({id:`${g.EXTENSIONID}/toggle-vision-menu`,icons:[{icon:"/no-vision.svg",label:"Enable Vision",filter:{every:[{key:["metadata",`${g.EXTENSIONID}/hasVision`],operator:"==",value:void 0,coordinator:"&&"},{key:["metadata",`${g.SPECTREID}/spectred`],operator:"==",value:void 0}],some:[{key:"layer",value:"CHARACTER",coordinator:"||"},{key:"layer",value:"ATTACHMENT"}]}},{icon:"/icon.svg",label:"Disable Vision",filter:{every:[{key:["metadata",`${g.SPECTREID}/spectred`],operator:"==",value:void 0}],some:[{key:"layer",value:"CHARACTER",coordinator:"||"},{key:"layer",value:"ATTACHMENT"}]}}],async onClick(i){const e=i.items.every(t=>t.metadata[`${g.EXTENSIONID}/hasVision`]===void 0);await P.scene.items.updateItems(i.items,t=>{for(const n of t)e?(n.metadata[`${g.EXTENSIONID}/hasVision`]=!0,n.metadata[`${g.EXTENSIONID}/visionRange`]===void 0&&(n.metadata[`${g.EXTENSIONID}/visionRange`]=g.VISIONDEFAULT)):delete n.metadata[`${g.EXTENSIONID}/hasVision`]})}}),await P.contextMenu.create({id:`${g.EXTENSIONID}/toggle-groupvision-menu`,icons:[{icon:"/no-vision.svg",label:"Toggle Attachments Vision",filter:{every:[{key:"layer",value:"NOTE"},{key:["metadata",`${g.EXTENSIONID}/hasVision`],value:void 0}]}}],async onClick(i){if(i.items.length>0){const e=i.items.map(n=>n.id),t=await P.scene.items.getItemAttachments(e);await P.scene.items.updateItems(t,n=>{for(const o of n)e.includes(o.attachedTo)&&(o.metadata[`${g.EXTENSIONID}/hasVision`]&&(o.layer=="CHARACTER"||o.layer=="ATTACHMENT")?delete o.metadata[`${g.EXTENSIONID}/hasVision`]:(o.layer=="CHARACTER"||o.layer=="ATTACHMENT")&&(o.metadata[`${g.EXTENSIONID}/hasVision`]=!0,o.metadata[`${g.EXTENSIONID}/visionRange`]===void 0&&(o.metadata[`${g.EXTENSIONID}/visionRange`]=g.VISIONDEFAULT)))})}}}),await P.contextMenu.create({id:`${g.EXTENSIONID}/toggle-vision-line`,icons:[{icon:"/icon.svg",label:"Disable Vision Line",filter:{some:[{key:["metadata",`${g.EXTENSIONID}/isVisionLine`],value:!0,coordinator:"&&"},{key:["metadata",`${g.EXTENSIONID}/disabled`],value:void 0,coordinator:"||"},{key:["metadata",`${g.ARMINDOID}/isVisionLine`],value:!0,coordinator:"&&"},{key:["metadata",`${g.ARMINDOID}/disabled`],value:void 0}]}},{icon:"/no-vision.svg",label:"Enable Vision Line",filter:{some:[{key:["metadata",`${g.EXTENSIONID}/isVisionLine`],value:!0,coordinator:"||"},{key:["metadata",`${g.ARMINDOID}/isVisionLine`],value:!0}]}}],async onClick(i){await P.scene.items.updateItems(i.items,e=>{for(const t of e)t.metadata[`${g.EXTENSIONID}/isVisionLine`]&&t.metadata[`${g.EXTENSIONID}/disabled`]?delete t.metadata[`${g.EXTENSIONID}/disabled`]:t.metadata[`${g.EXTENSIONID}/isVisionLine`]&&(t.metadata[`${g.EXTENSIONID}/disabled`]=!0)})}}),await P.contextMenu.create({id:`${g.EXTENSIONID}/switch-one-sided-type`,icons:[{icon:"/two-sided.svg",label:"Two-sided",filter:{some:[{key:["metadata",`${g.EXTENSIONID}/isVisionLine`],value:!0,coordinator:"&&"},{key:["metadata",`${g.EXTENSIONID}/oneSided`],value:void 0,coordinator:"||"},{key:["metadata",`${g.ARMINDOID}/isVisionLine`],value:!0,coordinator:"&&"},{key:["metadata",`${g.ARMINDOID}/oneSided`],value:void 0}]}},{icon:"/left-sided.svg",label:"One-sided left",filter:{some:[{key:["metadata",`${g.EXTENSIONID}/isVisionLine`],value:!0,coordinator:"&&"},{key:["metadata",`${g.EXTENSIONID}/oneSided`],value:"left",coordinator:"||"},{key:["metadata",`${g.ARMINDOID}/isVisionLine`],value:!0,coordinator:"&&"},{key:["metadata",`${g.ARMINDOID}/oneSided`],value:"left"}]}},{icon:"/right-sided.svg",label:"One-sided right",filter:{some:[{key:["metadata",`${g.EXTENSIONID}/isVisionLine`],value:!0,coordinator:"||"},{key:["metadata",`${g.ARMINDOID}/isVisionLine`],value:!0}]}}],async onClick(i){await P.scene.items.updateItems(i.items,e=>{for(const t of e)(t.metadata[`${g.EXTENSIONID}/isVisionLine`]||t.metadata[`${g.ARMINDOID}/isVisionLine`])&&(t.metadata[`${g.EXTENSIONID}/oneSided`]=="right"||t.metadata[`${g.ARMINDOID}/oneSided`]=="right")?(delete t.metadata[`${g.EXTENSIONID}/oneSided`],delete t.metadata[`${g.ARMINDOID}/oneSided`]):(t.metadata[`${g.EXTENSIONID}/isVisionLine`]||t.metadata[`${g.ARMINDOID}/isVisionLine`])&&(t.metadata[`${g.EXTENSIONID}/oneSided`]=="left"||t.metadata[`${g.ARMINDOID}/oneSided`]=="left")?(t.metadata[`${g.EXTENSIONID}/oneSided`]="right",t.metadata[`${g.ARMINDOID}/oneSided`]="right"):(t.metadata[`${g.EXTENSIONID}/isVisionLine`]||t.metadata[`${g.ARMINDOID}/isVisionLine`])&&(t.metadata[`${g.EXTENSIONID}/oneSided`]="left",t.metadata[`${g.ARMINDOID}/oneSided`]="left")})}}),await P.contextMenu.create({id:`${g.EXTENSIONID}/toggle-fog-background`,icons:[{icon:"/fog-background.svg",label:"Convert To Fog Background",filter:{every:[{key:"layer",value:"MAP"}]}}],async onClick(i){i.items.length>0&&await P.scene.items.updateItems(i.items,e=>{for(let t=0;t<e.length;t++)e[t].zIndex=1,e[t].layer="FOG",e[t].disableHit=!0,e[t].locked=!1,e[t].visible=!1,e[t].metadata[`${g.EXTENSIONID}/isBackgroundMap`]=!0})}}),await P.contextMenu.create({id:`${g.EXTENSIONID}/toggle-door`,icons:[{icon:"/opendoor.svg",label:"Enable Door",filter:{every:[{key:"layer",value:"DRAWING"},{key:["metadata",`${g.EXTENSIONID}/isDoor`],value:void 0},{key:["metadata",`${g.EXTENSIONID}/doorId`],value:void 0}],roles:["GM"]}},{icon:"/closedoor.svg",label:"Disable Door",filter:{every:[{key:"layer",value:"DRAWING"},{key:["metadata",`${g.EXTENSIONID}/doorId`],value:void 0}],roles:["GM"]}}],async onClick(i){const e=i.items.every(t=>t.metadata[`${g.EXTENSIONID}/isDoor`]===void 0);await P.scene.items.updateItems(i.items,t=>{for(const n of t)e?n.metadata[`${g.EXTENSIONID}/isDoor`]=!0:delete n.metadata[`${g.EXTENSIONID}/isDoor`]}),e?await qt(i.items):await $r(i.items)}})}async function ta(i){i?await P.contextMenu.create({id:`${g.EXTENSIONID}/toggle-autohide-menu`,icons:[{icon:"/autohide-off.svg",label:"Enable Autohide",filter:{every:[{key:"layer",value:"CHARACTER"},{key:["metadata",`${g.EXTENSIONID}/hasAutohide`],value:void 0}],roles:["GM"]}},{icon:"/autohide-on.svg",label:"Disable Autohide",filter:{every:[{key:"layer",value:"CHARACTER"}],roles:["GM"]}}],async onClick(e){const t=e.items.every(n=>n.metadata[`${g.EXTENSIONID}/hasAutohide`]===void 0);await P.scene.items.updateItems(e.items,n=>{for(const o of n)t?o.metadata[`${g.EXTENSIONID}/hasAutohide`]=!0:delete o.metadata[`${g.EXTENSIONID}/hasAutohide`]})}}):await P.contextMenu.remove(`${g.EXTENSIONID}/toggle-autohide-menu`)}function Ki(i){const e=P.scene.fog.onChange(w=>{A.fog=w}),t=P.scene.onReadyChange(async w=>{A.ready=w,w?(E(),await zi(),await vt(),Ki(A.role)):i=="GM"&&(A.initialized=!1,await ne.UpdateUI())}),n=P.scene.grid.onChange(async w=>{A.gridDpi=w.dpi,A.gridScale=parseInt(w.scale),A.ready&&await vt()}),o=P.scene.onMetadataChange(async w=>{A.metadata=w;const k=w[`${g.EXTENSIONID}/triggerReset`];if(k!==""&&k!==A.lastReset){A.lastReset=k;const C=await P.scene.local.getItems($n);await P.scene.local.deleteItems(C.map(N=>N.id));const z=A.metadata[`${g.EXTENSIONID}/sceneId`];localStorage.removeItem(`${g.EXTENSIONID}/fogCache/${A.userId}/${z}`),await vt()}else A.role==="GM"&&await jn(),A.ready&&await vt()}),r=P.scene.items.onChange(async w=>{A.items=w,A.torchActive=w.some(gt),A.ready&&(i=="GM"?(await ne.UpdateUI(),await Wi(ne.mapAlign),A.torchActive?(ne.qualityOption.style.display="none",ne.torchQuality.style.display="inline-block"):(ne.qualityOption.style.display="inline-block",ne.torchQuality.style.display="none")):ne.UpdatePlayerVisionList(w),await vt())}),c=P.player.onChange(async w=>{const k=document.querySelectorAll(".token-table-entry");for(let C of k){let z=C.id.substring(3);w.selection!==void 0&&w.selection.includes(z)?C.classList.add("token-table-selected"):C.classList.remove("token-table-selected")}w.selection!==void 0&&w.selection.length===1&&Lr(w.selection[0])}),p=P.party.onChange(async w=>{A.players=w,i==="PLAYER"?await Uo(w):(jo(),ne.UpdatePlayerProcessUI(w))}),m=P.theme.onChange(w=>{qi(w,document)});function E(){m(),p(),c(),r(),o(),n(),t(),e()}}function na(){ne.processedIndicator.onclick=async()=>{await P.popover.open({id:g.PROCESSEDID,url:"/pages/processed.html",height:300,width:300,disableClickAway:!1})},ne.visionCheckbox.onclick=async t=>{if(!A.ready||!t.target){t.preventDefault();return}const n=t.target;await P.scene.setMetadata({[`${g.EXTENSIONID}/visionEnabled`]:n.checked}),n.checked||await P.scene.fog.setFilled(!1)},ne.snapCheckbox.checked=!0,ne.snapCheckbox.onclick=async t=>{if(!A.ready||!t.target){t.preventDefault();return}const n=t.target;A.snap=n.checked},ne.settingsButton.onclick=async t=>{!t||!t.target||(ne.settingsUIDiv.style.display==="block"?(ne.settingsUIDiv.style.display="none",ne.mainUIDiv.style.display="block"):(ne.settingsUIDiv.style.display="block",ne.mainUIDiv.style.display="none"))},ne.persistenceCheckbox.onclick=async t=>{if(!t||!t.target)return;const n=t.target;await P.scene.setMetadata({[`${g.EXTENSIONID}/persistenceEnabled`]:n.checked})},ne.autodetectCheckbox.onclick=async t=>{if(!t||!t.target)return;const n=t.target;await P.scene.setMetadata({[`${g.EXTENSIONID}/autodetectEnabled`]:n.checked}),ne.boundryOptions.style.display=n.checked?"none":"",await jn()},ne.fowCheckbox.onclick=async t=>{if(!t||!t.target)return;const n=t.target;await ta(n.checked),await P.scene.setMetadata({[`${g.EXTENSIONID}/fowEnabled`]:n.checked})},ne.doorCheckbox.onclick=async t=>{if(!t||!t.target)return;const n=t.target;await P.scene.setMetadata({[`${g.EXTENSIONID}/playerDoors`]:n.checked})},ne.qualityOption.onchange=async t=>{if(!t||!t.target)return;const n=t.target;n.value==="fast"&&await P.notification.show("Notice: Issues can occur when using FAST Performance with PERSISTENCE, specifically with revealing inner fogged areas when traveling in a full circle around them. Use both with caution and care.","DEFAULT"),await P.scene.setMetadata({[`${g.EXTENSIONID}/quality`]:n.value})},ne.resetButton.onclick=async t=>{!t||!t.target||await P.scene.setMetadata({[`${g.EXTENSIONID}/triggerReset`]:new Date().toLocaleTimeString()})},ne.debugButton.onclick=async t=>{!t||!t.target||(ne.debugDiv.style.display=="none"?(ne.debugDiv.style.display="grid",ne.debugButton.value="Disable Debugging"):(ne.debugDiv.style.display="none",ne.debugButton.value="Enable Debugging"),await P.scene.setMetadata({[`${g.EXTENSIONID}/debug`]:ne.debugDiv.style.display==="grid"}))},ne.backgroundButton.onclick=async t=>{!t||!t.target||(t.target,await P.scene.items.updateItems(n=>n.layer=="FOG"&&n.metadata[`${g.EXTENSIONID}/isBackgroundMap`]===!0,n=>{for(let o=0;o<n.length;o++)n[o].layer="MAP",n[o].disableHit=!1,n[o].locked=!1,n[o].visible=!0,delete n[o].metadata[`${g.EXTENSIONID}/isBackgroundMap`]}))};let i;ne.fowColor.onclick=()=>{Ze({el:`#${ne.fowColor.id}`,alpha:!0,forceAlpha:!0})},ne.fowColor.oninput=async t=>{if(!t||!t.target)return;const n=t.target;clearTimeout(i),i=setTimeout(async()=>{if(/#[a-f0-9]{8}/.test(n.value)){await P.scene.setMetadata({[`${g.EXTENSIONID}/fowColor`]:n.value});const r=await P.scene.local.getItems(Ut);await P.scene.local.deleteItems(r.map(c=>c.id))}},500)},ne.convertButton.onclick=async t=>{if(!(!t||!t.target)&&window.confirm(`WARNING: THIS CANNOT BE UNDONE.

This operation will remove all metadata from the original dynamic fog extension, and will break fog lines and other things if you do not continue using Smoke!.

WARNING: THIS CANNOT BE UNDONE.

Are you REALLY sure?`)){const n=await P.scene.getMetadata();for(const r in n)r.substring(0,r.indexOf("/"))==g.ARMINDOID&&await P.scene.setMetadata({[`${r}`]:void 0});const o=await P.scene.items.getItems();await P.scene.items.updateItems(o,r=>{for(const c of r)c.metadata[`${g.ARMINDOID}/isVisionLine`]!==void 0&&(c.metadata[`${g.EXTENSIONID}/isVisionLine`]=c.metadata[`${g.ARMINDOID}/isVisionLine`],delete c.metadata[`${g.ARMINDOID}/isVisionLine`]),c.metadata[`${g.ARMINDOID}/disabled`]!==void 0&&(c.metadata[`${g.EXTENSIONID}/disabled`]=c.metadata[`${g.ARMINDOID}/disabled`],delete c.metadata[`${g.ARMINDOID}/disabled`])})}};var e;ne.importFile.onchange=t=>{if(ne.importButton.disabled=!0,!t||!t.target)return;const n=t.target;if(!n.files)return;const o=n.files[0];if(o.type!=="text/javascript"&&o.type,o){var r=new FileReader;r.onload=function(c){if(!c||!c.target){ne.importErrors.innerText="Invalid import event";return}const p=c.target;if(!p.result){ne.importErrors.innerText="Unable to read imported file";return}const m=p.result;e=JSON.parse(m),e&&(e.walls&&e.walls.length||e.line_of_sight&&e.line_of_sight.length)?ne.importButton.disabled=!1:ne.importErrors.innerText="Imported file has no walls"},r.readAsText(o)}else ne.importErrors.innerText="Failed to load file"},ne.importButton.onclick=async t=>{!t||!t.target||(t.target,Ko(ne.importFormat.value,e,ne.dpiAutodetect.checked?0:Number.parseInt(ne.importDpi.value),ne.mapAlign.value,ne.importErrors))},ne.toolColor.onclick=async t=>{Ze({el:`#${ne.toolColor.id}`,alpha:!1,forceAlpha:!1})},ne.toolColor.oninput=async t=>{if(!t||!t.target)return;const n=t.target;clearTimeout(i),i=setTimeout(async()=>{/#[a-f0-9]{6}/.test(n.value)&&await P.scene.setMetadata({[`${g.EXTENSIONID}/toolColor`]:n.value})},400)},ne.toolStyle.onchange=async t=>{const n=t.currentTarget;await P.scene.setMetadata({[`${g.EXTENSIONID}/toolStyle`]:n.value=="solid"?[]:[25,25]})},ne.toolWidth.onchange=t=>{const n=t.currentTarget;clearTimeout(i),i=setTimeout(async()=>{await P.scene.setMetadata({[`${g.EXTENSIONID}/toolWidth`]:n.value})},400)},ne.whatsNewButton.onclick=async function(){ne.whatsNewIcon?.classList.remove("new-shine"),await P.modal.open({id:g.EXTENSIONWHATSNEW,url:"/pages/whatsnew.html",height:500,width:350})},Ze({themeMode:"dark",alpha:!0,forceAlpha:!0,el:"#fow_color"}),Ze({themeMode:"dark",alpha:!1,forceAlpha:!1,el:"#tool_color"})}let et=null,Nt="",kt="",Qt="",Jt="";const ia="#000000",ra=8,oa=[];async function Yi(){await P.scene.local.deleteItems([Jt,Nt,kt,Qt]),Nt="",kt="",Jt="",Qt="",await P.popover.close(g.LINETOOLID)}async function Zi(){if(!et)return;const[i,e]=et;e(),et=null,await Yi()}async function Qi(){if(!et)return;const[i,e]=et,t=i(n=>{n.visible=!1,n.metadata[`${g.EXTENSIONID}/isVisionLine`]=!0,n.points.pop()});t.points.length>=2&&await P.scene.items.addItems([t]),e(),et=null,await Yi()}async function aa(i,e){if(!e.transformer)if(et)if(e.target&&(e.target.id===Nt||e.target.id===kt))await Qi();else if(e.target&&(e.target.id===Jt||e.target.id===Qt))await Zi();else{const[t]=et;t(n=>{n.points.push(e.pointerPosition)}),await P.scene.local.updateItems(n=>n.id==kt||n.id==Nt,n=>{for(const o of n)o.position=e.pointerPosition})}else{const t=Gt().plainText("Finish [Enter]").position({x:e.pointerPosition.x,y:e.pointerPosition.y-50}).fillOpacity(.95).backgroundOpacity(.5).layer("POPOVER").build(),n=Fn().tension(0).points([e.pointerPosition,e.pointerPosition]).strokeColor(A.metadata[`${g.EXTENSIONID}/toolColor`]??ia).strokeDash(A.metadata[`${g.EXTENSIONID}/toolStyle`]??oa).strokeWidth(A.metadata[`${g.EXTENSIONID}/toolWidth`]??ra).fillOpacity(0).fillColor("#000000").layer("DRAWING").name("Vision Line (Line)").closed(!1).build();et=await P.interaction.startItemInteraction(n);const o=Et().shapeType("CIRCLE").strokeColor("#FFFFFF").width(8).height(8).strokeWidth(2).position(e.pointerPosition).layer("POPOVER").build(),r=Et().shapeType("CIRCLE").strokeColor("#FFFFFF").width(8).height(8).strokeWidth(2).position(e.pointerPosition).layer("POPOVER").visible(!1).build(),c=Gt().plainText("Cancel [Escape]").position(e.pointerPosition).fillOpacity(.95).backgroundOpacity(.5).layer("POPOVER").pointerDirection("UP").build();await P.scene.local.addItems([t,o,r,c]),Nt=t.id,kt=o.id,Jt=c.id,Qt=r.id,await P.popover.open({id:g.LINETOOLID,url:"/pages/line.html",height:40,width:400,disableClickAway:!0})}}function sa(i,e){if(!et||e.transformer)return;const[t]=et,n=Math.round(A.gridDpi/A.gridSnap),o=Math.round(e.pointerPosition.x/A.gridDpi)*A.gridDpi,r=Math.round(e.pointerPosition.y/A.gridDpi)*A.gridDpi,c=Math.abs(o-e.pointerPosition.x),p=Math.abs(r-e.pointerPosition.y);let m,E;c<=n?m=o:m=e.pointerPosition.x,p<=n?E=r:E=e.pointerPosition.y,t(w=>{w.points[w.points.length-1]=A.snap?{x:m,y:E}:e.pointerPosition})}function la(i,e){et&&(e.key=="Escape"?Zi():e.key=="Enter"&&Qi())}const An={onToolClick:aa,onToolMove:sa,onKeyDown:la};let tt=null,en="",tn="",nn="",rn="";const ca="#000000",ua=8,da=[];async function Ji(){await P.scene.local.deleteItems([rn,en,tn,nn]),en="",tn="",rn="",nn="",await P.popover.close(g.POLYTOOLID)}async function er(){if(!tt)return;const[i,e]=tt;e(),tt=null,Ji()}async function tr(){if(!tt)return;const[i,e]=tt,t=i(n=>{n.visible=!1,n.metadata[`${g.EXTENSIONID}/isVisionLine`]=!0,n.points.pop(),n.points.push(n.points[0])});t.points.length>=4&&await P.scene.items.addItems([t]),e(),tt=null,Ji()}async function fa(i,e){if(!e.transformer)if(tt)if(e.target&&(e.target.id===en||e.target.id===tn))tr();else if(e.target&&(e.target.id===rn||e.target.id===nn))er();else{const[t]=tt;t(n=>{n.points.push(e.pointerPosition)})}else{const t=Gt().plainText("Finish [Enter]").position({x:e.pointerPosition.x,y:e.pointerPosition.y-50}).fillOpacity(.95).backgroundOpacity(.5).layer("POPOVER").build(),n=Fn().tension(0).points([e.pointerPosition,e.pointerPosition]).strokeColor(A.metadata[`${g.EXTENSIONID}/toolColor`]??ca).strokeDash(A.metadata[`${g.EXTENSIONID}/toolStyle`]??da).strokeWidth(A.metadata[`${g.EXTENSIONID}/toolWidth`]??ua).fillOpacity(.5).fillColor("#000000").layer("DRAWING").name("Vision Line (Polygon)").build();tt=await P.interaction.startItemInteraction(n);const o=Et().shapeType("CIRCLE").strokeColor("#FFFFFF").width(8).height(8).strokeWidth(2).position(e.pointerPosition).layer("POPOVER").build(),r=Et().shapeType("CIRCLE").strokeColor("#FFFFFF").width(8).height(8).strokeWidth(2).position(e.pointerPosition).layer("POPOVER").visible(!1).build(),c=Gt().plainText("Cancel [Escape]").position(e.pointerPosition).fillOpacity(.95).backgroundOpacity(.5).layer("POPOVER").pointerDirection("UP").build();await P.scene.local.addItems([t,o,r,c]),en=t.id,tn=o.id,rn=c.id,nn=r.id,await P.popover.open({id:g.POLYTOOLID,url:"/pages/polygon.html",height:40,width:400,disableClickAway:!0})}}function pa(i,e){if(!tt||e.transformer)return;const[t]=tt,n=Math.round(A.gridDpi/A.gridSnap),o=Math.round(e.pointerPosition.x/A.gridDpi)*A.gridDpi,r=Math.round(e.pointerPosition.y/A.gridDpi)*A.gridDpi,c=Math.abs(o-e.pointerPosition.x),p=Math.abs(r-e.pointerPosition.y);let m,E;c<=n?m=o:m=e.pointerPosition.x,p<=n?E=r:E=e.pointerPosition.y,t(w=>{w.points[w.points.length-1]=A.snap?{x:m,y:E}:e.pointerPosition})}function ha(i,e){tt&&(e.key=="Escape"?er():e.key=="Enter"&&tr())}const Dn={onToolClick:fa,onToolMove:pa,onKeyDown:ha};async function ga(){await P.tool.create({id:`${g.EXTENSIONID}/vision-tool`,icons:[{icon:"/icon.svg",label:"Setup Vision"}],async onClick(){await P.tool.activateTool(`${g.EXTENSIONID}/vision-tool`)}}),await P.tool.createMode({id:`${g.EXTENSIONID}/add-vision-polygon-mode`,icons:[{icon:"/object.svg",label:"Add Obstruction Object",filter:{activeTools:[`${g.EXTENSIONID}/vision-tool`]}}],onToolClick:Dn.onToolClick,onToolMove:Dn.onToolMove,onKeyDown:Dn.onKeyDown}),await P.tool.createMode({id:`${g.EXTENSIONID}/add-vision-line-mode`,icons:[{icon:"/line.svg",label:"Add Obstruction Line",filter:{activeTools:[`${g.EXTENSIONID}/vision-tool`]}}],onToolClick:An.onToolClick,onToolMove:An.onToolMove,onKeyDown:An.onKeyDown})}class ma{mainWindow=document.getElementById("app");mainUIDiv;playerListContainer;settingsUIDiv;visionCheckbox;snapCheckbox;table;message;mapHeight;mapWidth;mapSubmit;whatsNewButton;whatsNewIcon;processedIndicator;persistenceCheckbox;autodetectCheckbox;fowCheckbox;doorCheckbox;fowColor;qualityOption;torchQuality;resetButton;convertButton;settingsButton;boundryOptions;debugDiv;debugButton;backgroundButton;toolWidth;toolColor;toolStyle;importButton;importFile;mapAlign;importErrors;dpiAutodetect;importDpi;importFormat;version;constructor(e){this.version=`SMOKEANDSPECTRE-${e}`}SetupGMElements(){this.mainWindow.innerHTML=`
        <div>
            <div>
                <div id="localStorageWarning"></div>
                <div class="title">
                <button class="circle-button" id="processedIndicator"></button>
                    Smoke!
                    <input type="checkbox" id="vision_checkbox" class="large" title="Enable Dynamic Fog">
                    <div class="tooltip" id="settings_button" title="Settings"><svg class="svgclickable" fill="#fff" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><path d="M.63 11.08zm.21.41v-.1zm.23.38L1 11.68zM1 11.68l-.11-.19zm-.21-.29c-.06-.1-.11-.21-.16-.31.05.1.1.21.16.31zm.32.54v-.06z"/><path d="m11.26 12.63 1.83 1.09a7.34 7.34 0 0 0 1-.94 7.48 7.48 0 0 0 1.56-2.86l-1.74-1A5.29 5.29 0 0 0 14 8a5.29 5.29 0 0 0-.08-.9l1.74-1a7.45 7.45 0 0 0-1.33-2.58 7.54 7.54 0 0 0-1.24-1.22l-1.83 1.04a6 6 0 0 0-1.11-.53v-2A8.55 8.55 0 0 0 7.94.53a8.39 8.39 0 0 0-2.26.3v2a7.23 7.23 0 0 0-1.12.54L2.78 2.28A7.46 7.46 0 0 0 .2 6.06l1.72 1a5.29 5.29 0 0 0-.08.9 5.29 5.29 0 0 0 .08.9l-1.73 1a8 8 0 0 0 .43 1.15c.05.1.1.21.16.31v.1l.11.19.12.19v.06a7.69 7.69 0 0 0 1.64 1.78l1.81-1.08a7.23 7.23 0 0 0 1.12.54v2a8.39 8.39 0 0 0 2.26.31 8.56 8.56 0 0 0 2.22-.3v-2a6 6 0 0 0 1.2-.48zm-2.39 1.52a7.57 7.57 0 0 1-.95.06 7.73 7.73 0 0 1-1-.06v-1.69a4.92 4.92 0 0 1-2.53-1.27l-1.54.92a6.22 6.22 0 0 1-1.08-1.61l1.56-.93a4.27 4.27 0 0 1 0-3.17l-1.56-.92a6.11 6.11 0 0 1 1.12-1.62l1.56.93A5 5 0 0 1 7 3.53V1.82a7.73 7.73 0 0 1 1-.06 7.57 7.57 0 0 1 .95.06v1.72a4.9 4.9 0 0 1 2.4 1.26l1.59-.94a6.31 6.31 0 0 1 1.11 1.62l-1.6.94a4.35 4.35 0 0 1 .3 1.58 4.44 4.44 0 0 1-.29 1.55l1.56.93a6.43 6.43 0 0 1-1.11 1.61l-1.58-.93a5 5 0 0 1-2.49 1.28z"/><path d="M7.92 5.49A2.59 2.59 0 0 0 5.25 8a2.59 2.59 0 0 0 2.67 2.51A2.6 2.6 0 0 0 10.6 8a2.6 2.6 0 0 0-2.68-2.51zM8 9.2A1.35 1.35 0 0 1 6.55 8 1.35 1.35 0 0 1 8 6.7 1.35 1.35 0 0 1 9.39 8 1.35 1.35 0 0 1 8 9.2z"/></svg></div>
                    <div class="tooltip" id="whatsnewbutton" title="Whats New"><svg id="whatsNewIcon" class="svgclickable" fill="#fff" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 3a7 7 0 100 14 7 7 0 000-14zm-9 7a9 9 0 1118 0 9 9 0 01-18 0zm8-4a1 1 0 011-1h.01a1 1 0 110 2H10a1 1 0 01-1-1zm.01 8a1 1 0 102 0V9a1 1 0 10-2 0v5z"/></svg></div>
                </div>
                <hr>
                ${g.SETTINGSPAGE}
                ${g.MAINPAGE}
                ${g.DEBUGPAGE}
            </div>
        </div>
        `,this.mainWindow.parentElement.style.placeItems="start",this.mainUIDiv=document.getElementById("main-ui"),this.settingsUIDiv=document.getElementById("settings-ui"),this.visionCheckbox=document.getElementById("vision_checkbox"),this.snapCheckbox=document.getElementById("snap_checkbox"),this.table=document.getElementById("token_list"),this.message=document.getElementById("no_tokens_message"),this.mapHeight=document.getElementById("mapHeight"),this.mapWidth=document.getElementById("mapWidth"),this.mapSubmit=document.getElementById("mapSubmit"),this.whatsNewButton=document.getElementById("whatsnewbutton"),this.whatsNewIcon=document.getElementById("whatsNewIcon"),this.processedIndicator=document.getElementById("processedIndicator"),this.persistenceCheckbox=document.getElementById("persistence_checkbox"),this.autodetectCheckbox=document.getElementById("autodetect_checkbox"),this.fowCheckbox=document.getElementById("fow_checkbox"),this.doorCheckbox=document.getElementById("door_checkbox"),this.fowColor=document.getElementById("fow_color"),this.qualityOption=document.getElementById("quality"),this.torchQuality=document.getElementById("forceAccurate"),this.resetButton=document.getElementById("persistence_reset"),this.convertButton=document.getElementById("convert_button"),this.settingsButton=document.getElementById("settings_button"),this.boundryOptions=document.getElementById("boundry_options"),this.debugDiv=document.getElementById("debug_div"),this.debugButton=document.getElementById("debug_button"),this.backgroundButton=document.getElementById("background_button"),this.toolWidth=document.getElementById("tool_width"),this.toolColor=document.getElementById("tool_color"),this.toolStyle=document.getElementById("tool_style"),this.importButton=document.getElementById("import_button"),this.importFile=document.getElementById("import_file"),this.mapAlign=document.getElementById("map_align"),this.importErrors=document.getElementById("import_errors"),this.dpiAutodetect=document.getElementById("dpi_autodetect"),this.importDpi=document.getElementById("import_dpi"),this.importFormat=document.getElementById("import_format"),Ze.init()}async SetupPlayerElements(){this.mainWindow.innerHTML=`<div class="title">Configuration via GM.
            <div class="tooltip" id="helpButton" title="Need Help?"></div>
            </div>
            <hr><sub>You must have ownership of a token to see it.</sub></br></br>Tokens Owned By You:<div id="playerOwnedTokens"></div><div id="localStorageWarning"></div>`,await P.action.setHeight(300),await P.action.setWidth(350),this.playerListContainer=document.getElementById("playerOwnedTokens");const e=document.getElementById("helpButton"),t=document.createElement("input");t.classList.add("clickable"),t.src="/help.svg",t.height=15,t.width=15,t.type="image",t.title="Need Help?",t.onclick=async function(){await P.modal.open({id:g.EXTENSIONWHATSNEW,url:"/pages/whatsnew.html?gethelp=true",height:500,width:350})},e.appendChild(t)}async BuildUserCache(){const[e,t,n]=await Promise.all([P.player.getId(),P.party.getPlayers(),P.scene.isReady()]);A.userId=e,A.players=t,A.ready=n}async UpdateUI(){const e=A.items.filter(m=>Oi(m));let t=!1;Qo(A.metadata)||(this.visionCheckbox.checked=A.metadata[`${g.EXTENSIONID}/visionEnabled`]==!0,this.autodetectCheckbox.checked=A.metadata[`${g.EXTENSIONID}/autodetectEnabled`]==!0,this.persistenceCheckbox.checked=A.metadata[`${g.EXTENSIONID}/persistenceEnabled`]==!0,this.autodetectCheckbox.checked=A.metadata[`${g.EXTENSIONID}/autodetectEnabled`]==!0,this.fowCheckbox.checked=A.metadata[`${g.EXTENSIONID}/fowEnabled`]==!0,this.doorCheckbox.checked=A.metadata[`${g.EXTENSIONID}/playerDoors`]==!0,this.fowColor.value=A.metadata[`${g.EXTENSIONID}/fowColor`]?A.metadata[`${g.EXTENSIONID}/fowColor`]:"#00000088",this.qualityOption.value=A.metadata[`${g.EXTENSIONID}/quality`]??"accurate",t=A.metadata[`${g.EXTENSIONID}/debug`]==!0),this.debugDiv.style.display=t?"grid":"none",this.boundryOptions.style.display=this.autodetectCheckbox.checked?"none":"",this.message.style.display=e.length>0?"none":"block";const n=A.items.filter(m=>m.layer==="FOG"&&m.metadata[`${g.EXTENSIONID}/isBackgroundMap`]===!0),o=document.querySelectorAll(".fog-background-entry");for(const m of o){const E=m.id.slice(3);n.find(w=>w.id===E)===void 0&&m.remove()}for(const m of n)if(!document.querySelector(`#bg-${m.id}`)){const w=document.createElement("div");w.id=`bg-${m.id}`,w.className="fog-background-entry grid-3 grid-main",w.style.width="300",w.innerHTML=`<div class="token-name grid-2">${m.name}</div>
                    <div><label title="Unlock this fog background and turn it back into a map"><input type="button" value="Unlock"></label></div>`,document.querySelector("#fog_background_list").appendChild(w),w.querySelector("input").addEventListener("click",async C=>{if(!C||!C.target)return;const N=C.target.parentElement.parentElement.parentElement.id.slice(3);await P.scene.items.updateItems(R=>R.id===N&&R.layer=="FOG"&&R.metadata[`${g.EXTENSIONID}/isBackgroundMap`]===!0,R=>{for(let x=0;x<R.length;x++)R[x].layer="MAP",R[x].disableHit=!1,R[x].locked=!1,R[x].visible=!0,delete R[x].metadata[`${g.EXTENSIONID}/isBackgroundMap`]})})}const r=document.querySelector("#fog_backgrounds");n.length==0?r.style.display="none":r.style.display="block";const c=document.getElementsByClassName("token-table-entry"),p=[];for(const m of c){const E=m.id.slice(3);e.find(w=>w.id===E)===void 0&&p.push(m)}for(const m of p)m.remove();for(const m of e)Jo(m);A.torchActive=A.items.some(gt),A.torchActive?(ne.qualityOption.style.display="none",ne.torchQuality.style.display="inline-block"):(ne.qualityOption.style.display="inline-block",ne.torchQuality.style.display="none")}UpdatePlayerProcessUI(e){e.every(n=>n.metadata[`${g.EXTENSIONID}/processed`]===!0)?(this.processedIndicator.style.backgroundColor="green",this.processedIndicator.title="Everything looks good."):(this.processedIndicator.style.backgroundColor="red",this.processedIndicator.title="A player is having trouble processing/seeing.")}UpdatePlayerVisionList(e){const t=[];for(const n of e)if(on(n)&&n.createdUserId===A.userId){const o=n.metadata[`${g.EXTENSIONID}/hasVision`]!==void 0;t.push(`<li>${n.name}${o?"":": <b>Vision Disabled</b>"}</li>`)}t.length===0&&t.push("<li>None found.</li>"),this.playerListContainer.innerHTML=`<ul>${t.join("")}</ul>`}HighlightWhatsNew(){let e=localStorage.getItem(this.version);(e==="false"||!e)&&(this.whatsNewIcon?.classList.add("new-shine"),localStorage.setItem(this.version,"true"))}async Start(e){await this.BuildUserCache(),e==="GM"?(this.SetupGMElements(),na(),this.UpdatePlayerProcessUI(A.players),await Promise.all([ea(),ga(),Wo()]),Ti()):(this.SetupPlayerElements(),Ti()),A.ready?(await zi(),await vt(),e=="GM"&&await Wi(this.mapAlign)):e=="GM"&&await this.UpdateUI(),Ki(e),this.HighlightWhatsNew()}}const ne=new ma("2.1");P.onReady(async()=>{const[i,e]=await Promise.all([P.theme.getTheme(),P.player.getRole()]);A.role=e,qi(i,document),await ne.Start(A.role)});
