/* empty css              */import{C as o,P as me,c as Ne,O as w,d as Ge,b as un,a as sr,e as or,f as fa,g as dr,h as lr,i as xt,j as cr,k as ur}from"./bsConstants-6VmLKWN5.js";const Fe=(()=>{/*!
* Copyright (c) 2021-2024 Momo Bassit.
* Licensed under the MIT License (MIT)
* https://github.com/mdbassit/Coloris
* Version: 0.24.0
* NPM: https://github.com/melloware/coloris-npm
*/return((n,e,t,a)=>{const i=e.createElement("canvas").getContext("2d"),d={r:0,g:0,b:0,h:0,s:0,v:0,a:1};let s,l,c,h,v,I,S,_,O,X,F,x,C,G,r,f,u={};const p={el:"[data-coloris]",parent:"body",theme:"default",themeMode:"light",rtl:!1,wrap:!0,margin:2,format:"hex",formatToggle:!1,swatches:[],swatchesOnly:!1,alpha:!0,forceAlpha:!1,focusInput:!0,selectInput:!1,inline:!1,defaultColor:"#000000",clearButton:!1,clearLabel:"Clear",closeButton:!1,closeLabel:"Close",onChange:()=>a,a11y:{open:"Open color picker",close:"Close color picker",clear:"Clear the selected color",marker:"Saturation: {s}. Brightness: {v}.",hueSlider:"Hue slider",alphaSlider:"Opacity slider",input:"Color value field",format:"Color format",swatch:"Color swatch",instruction:"Saturation and brightness selector. Use up, down, left and right arrow keys to select."}},y={};let m="",g={},T=!1;function M(N){if(typeof N=="object")for(const V in N)switch(V){case"el":A(N.el),N.wrap!==!1&&Q(N.el);break;case"parent":s=N.parent instanceof HTMLElement?N.parent:e.querySelector(N.parent),s&&(s.appendChild(l),p.parent=N.parent,s===e.body&&(s=a));break;case"themeMode":p.themeMode=N.themeMode,N.themeMode==="auto"&&n.matchMedia&&n.matchMedia("(prefers-color-scheme: dark)").matches&&(p.themeMode="dark");case"theme":N.theme&&(p.theme=N.theme),l.className="clr-picker clr-"+p.theme+" clr-"+p.themeMode,p.inline&&j();break;case"rtl":p.rtl=!!N.rtl,Array.from(e.getElementsByClassName("clr-field")).forEach(D=>D.classList.toggle("clr-rtl",p.rtl));break;case"margin":N.margin*=1,p.margin=isNaN(N.margin)?p.margin:N.margin;break;case"wrap":N.el&&N.wrap&&Q(N.el);break;case"formatToggle":p.formatToggle=!!N.formatToggle,he("clr-format").style.display=p.formatToggle?"block":"none",p.formatToggle&&(p.format="auto");break;case"swatches":if(Array.isArray(N.swatches)){const D=he("clr-swatches"),B=e.createElement("div");D.textContent="",N.swatches.forEach((W,Z)=>{const q=e.createElement("button");q.setAttribute("type","button"),q.setAttribute("id","clr-swatch-"+Z),q.setAttribute("aria-labelledby","clr-swatch-label clr-swatch-"+Z),q.style.color=W,q.textContent=W,B.appendChild(q)}),N.swatches.length&&D.appendChild(B),p.swatches=N.swatches.slice()}break;case"swatchesOnly":p.swatchesOnly=!!N.swatchesOnly,l.setAttribute("data-minimal",p.swatchesOnly);break;case"alpha":p.alpha=!!N.alpha,l.setAttribute("data-alpha",p.alpha);break;case"inline":if(p.inline=!!N.inline,l.setAttribute("data-inline",p.inline),p.inline){const D=N.defaultColor||p.defaultColor;G=ne(D),j(),se(D)}break;case"clearButton":typeof N.clearButton=="object"&&(N.clearButton.label&&(p.clearLabel=N.clearButton.label,S.innerHTML=p.clearLabel),N.clearButton=N.clearButton.show),p.clearButton=!!N.clearButton,S.style.display=p.clearButton?"block":"none";break;case"clearLabel":p.clearLabel=N.clearLabel,S.innerHTML=p.clearLabel;break;case"closeButton":p.closeButton=!!N.closeButton,p.closeButton?l.insertBefore(_,v):v.appendChild(_);break;case"closeLabel":p.closeLabel=N.closeLabel,_.innerHTML=p.closeLabel;break;case"a11y":const H=N.a11y;let K=!1;if(typeof H=="object")for(const D in H)H[D]&&p.a11y[D]&&(p.a11y[D]=H[D],K=!0);if(K){const D=he("clr-open-label"),B=he("clr-swatch-label");D.innerHTML=p.a11y.open,B.innerHTML=p.a11y.swatch,_.setAttribute("aria-label",p.a11y.close),S.setAttribute("aria-label",p.a11y.clear),O.setAttribute("aria-label",p.a11y.hueSlider),F.setAttribute("aria-label",p.a11y.alphaSlider),I.setAttribute("aria-label",p.a11y.input),c.setAttribute("aria-label",p.a11y.instruction)}break;default:p[V]=N[V]}}function k(N,V){typeof N=="string"&&typeof V=="object"&&(y[N]=V,T=!0)}function $(N){delete y[N],Object.keys(y).length===0&&(T=!1,N===m&&b())}function R(N){if(T){const V=["el","wrap","rtl","inline","defaultColor","a11y"];for(let H in y){const K=y[H];if(N.matches(H)){m=H,g={},V.forEach(D=>delete K[D]);for(let D in K)g[D]=Array.isArray(p[D])?p[D].slice():p[D];M(K);break}}}}function b(){Object.keys(g).length>0&&(M(g),m="",g={})}function A(N){N instanceof HTMLElement&&(N=[N]),Array.isArray(N)?N.forEach(V=>{de(V,"click",z),de(V,"input",te)}):(de(e,"click",N,z),de(e,"input",N,te))}function z(N){p.inline||(R(N.target),C=N.target,r=C.value,G=ne(r),l.classList.add("clr-open"),j(),se(r),(p.focusInput||p.selectInput)&&(I.focus({preventScroll:!0}),I.setSelectionRange(C.selectionStart,C.selectionEnd)),p.selectInput&&I.select(),(f||p.swatchesOnly)&&tt().shift().focus(),C.dispatchEvent(new Event("open",{bubbles:!0})))}function j(){if(!l||!C&&!p.inline)return;const N=s,V=n.scrollY,H=l.offsetWidth,K=l.offsetHeight,D={left:!1,top:!1};let B,W,Z,q={x:0,y:0};if(N&&(B=n.getComputedStyle(N),W=parseFloat(B.marginTop),Z=parseFloat(B.borderTopWidth),q=N.getBoundingClientRect(),q.y+=Z+V),!p.inline){const le=C.getBoundingClientRect();let pe=le.x,Te=V+le.y+le.height+p.margin;N?(pe-=q.x,Te-=q.y,pe+H>N.clientWidth&&(pe+=le.width-H,D.left=!0),Te+K>N.clientHeight-W&&K+p.margin<=le.top-(q.y-V)&&(Te-=le.height+K+p.margin*2,D.top=!0),Te+=N.scrollTop):(pe+H>e.documentElement.clientWidth&&(pe+=le.width-H,D.left=!0),Te+K-V>e.documentElement.clientHeight&&K+p.margin<=le.top&&(Te=V+le.y-K-p.margin,D.top=!0)),l.classList.toggle("clr-left",D.left),l.classList.toggle("clr-top",D.top),l.style.left=pe+"px",l.style.top=Te+"px",q.x+=l.offsetLeft,q.y+=l.offsetTop}u={width:c.offsetWidth,height:c.offsetHeight,x:c.offsetLeft+q.x,y:c.offsetTop+q.y}}function Q(N){N instanceof HTMLElement?Y(N):Array.isArray(N)?N.forEach(Y):e.querySelectorAll(N).forEach(Y)}function Y(N){const V=N.parentNode;if(!V.classList.contains("clr-field")){const H=e.createElement("div");let K="clr-field";(p.rtl||N.classList.contains("clr-rtl"))&&(K+=" clr-rtl"),H.innerHTML='<button type="button" aria-labelledby="clr-open-label"></button>',V.insertBefore(H,N),H.className=K,H.style.color=N.value,H.appendChild(N)}}function te(N){const V=N.target.parentNode;V.classList.contains("clr-field")&&(V.style.color=N.target.value)}function oe(N){if(C&&!p.inline){const V=C;N&&(C=a,r!==V.value&&(V.value=r,V.dispatchEvent(new Event("input",{bubbles:!0})))),setTimeout(()=>{r!==V.value&&V.dispatchEvent(new Event("change",{bubbles:!0}))}),l.classList.remove("clr-open"),T&&b(),V.dispatchEvent(new Event("close",{bubbles:!0})),p.focusInput&&V.focus({preventScroll:!0}),C=a}}function se(N){const V=yt(N),H=vt(V);P(H.s,H.v),ve(V,H),O.value=H.h,l.style.color="hsl("+H.h+", 100%, 50%)",X.style.left=H.h/360*100+"%",h.style.left=u.width*H.s/100+"px",h.style.top=u.height-u.height*H.v/100+"px",F.value=H.a*100,x.style.left=H.a*100+"%"}function ne(N){const V=N.substring(0,3).toLowerCase();return V==="rgb"||V==="hsl"?V:"hex"}function J(N){N=N!==a?N:I.value,C&&(C.value=N,C.dispatchEvent(new Event("input",{bubbles:!0}))),p.onChange&&p.onChange.call(n,N,C),e.dispatchEvent(new CustomEvent("coloris:pick",{detail:{color:N,currentEl:C}}))}function L(N,V){const H={h:O.value*1,s:N/u.width*100,v:100-V/u.height*100,a:F.value/100},K=ot(H);P(H.s,H.v),ve(K,H),J()}function P(N,V){let H=p.a11y.marker;N=N.toFixed(1)*1,V=V.toFixed(1)*1,H=H.replace("{s}",N),H=H.replace("{v}",V),h.setAttribute("aria-label",H)}function U(N){return{pageX:N.changedTouches?N.changedTouches[0].pageX:N.pageX,pageY:N.changedTouches?N.changedTouches[0].pageY:N.pageY}}function re(N){const V=U(N);let H=V.pageX-u.x,K=V.pageY-u.y;s&&(K+=s.scrollTop),ce(H,K),N.preventDefault(),N.stopPropagation()}function ae(N,V){let H=h.style.left.replace("px","")*1+N,K=h.style.top.replace("px","")*1+V;ce(H,K)}function ce(N,V){N=N<0?0:N>u.width?u.width:N,V=V<0?0:V>u.height?u.height:V,h.style.left=N+"px",h.style.top=V+"px",L(N,V),h.focus()}function ve(N,V){N===void 0&&(N={}),V===void 0&&(V={});let H=p.format;for(const B in N)d[B]=N[B];for(const B in V)d[B]=V[B];const K=Re(d),D=K.substring(0,7);switch(h.style.color=D,x.parentNode.style.color=D,x.style.color=K,v.style.color=K,c.style.display="none",c.offsetHeight,c.style.display="",x.nextElementSibling.style.display="none",x.nextElementSibling.offsetHeight,x.nextElementSibling.style.display="",H==="mixed"?H=d.a===1?"hex":"rgb":H==="auto"&&(H=G),H){case"hex":I.value=K;break;case"rgb":I.value=Be(d);break;case"hsl":I.value=lt(dt(d));break}e.querySelector('.clr-format [value="'+H+'"]').checked=!0}function et(){const N=O.value*1,V=h.style.left.replace("px","")*1,H=h.style.top.replace("px","")*1;l.style.color="hsl("+N+", 100%, 50%)",X.style.left=N/360*100+"%",L(V,H)}function gt(){const N=F.value/100;x.style.left=N*100+"%",ve({a:N}),J()}function ot(N){const V=N.s/100,H=N.v/100;let K=V*H,D=N.h/60,B=K*(1-t.abs(D%2-1)),W=H-K;K=K+W,B=B+W;const Z=t.floor(D)%6,q=[K,B,W,W,B,K][Z],le=[B,K,K,B,W,W][Z],pe=[W,W,B,K,K,B][Z];return{r:t.round(q*255),g:t.round(le*255),b:t.round(pe*255),a:N.a}}function dt(N){const V=N.v/100,H=V*(1-N.s/100/2);let K;return H>0&&H<1&&(K=t.round((V-H)/t.min(H,1-H)*100)),{h:N.h,s:K||0,l:t.round(H*100),a:N.a}}function vt(N){const V=N.r/255,H=N.g/255,K=N.b/255,D=t.max(V,H,K),B=t.min(V,H,K),W=D-B,Z=D;let q=0,le=0;return W&&(D===V&&(q=(H-K)/W),D===H&&(q=2+(K-V)/W),D===K&&(q=4+(V-H)/W),D&&(le=W/D)),q=t.floor(q*60),{h:q<0?q+360:q,s:t.round(le*100),v:t.round(Z*100),a:N.a}}function yt(N){const V=/^((rgba)|rgb)[\D]+([\d.]+)[\D]+([\d.]+)[\D]+([\d.]+)[\D]*?([\d.]+|$)/i;let H,K;return i.fillStyle="#000",i.fillStyle=N,H=V.exec(i.fillStyle),H?K={r:H[3]*1,g:H[4]*1,b:H[5]*1,a:H[6]*1}:(H=i.fillStyle.replace("#","").match(/.{2}/g).map(D=>parseInt(D,16)),K={r:H[0],g:H[1],b:H[2],a:1}),K}function Re(N){let V=N.r.toString(16),H=N.g.toString(16),K=N.b.toString(16),D="";if(N.r<16&&(V="0"+V),N.g<16&&(H="0"+H),N.b<16&&(K="0"+K),p.alpha&&(N.a<1||p.forceAlpha)){const B=N.a*255|0;D=B.toString(16),B<16&&(D="0"+D)}return"#"+V+H+K+D}function Be(N){return!p.alpha||N.a===1&&!p.forceAlpha?"rgb("+N.r+", "+N.g+", "+N.b+")":"rgba("+N.r+", "+N.g+", "+N.b+", "+N.a+")"}function lt(N){return!p.alpha||N.a===1&&!p.forceAlpha?"hsl("+N.h+", "+N.s+"%, "+N.l+"%)":"hsla("+N.h+", "+N.s+"%, "+N.l+"%, "+N.a+")"}function qe(){e.getElementById("clr-picker")||(s=a,l=e.createElement("div"),l.setAttribute("id","clr-picker"),l.className="clr-picker",l.innerHTML='<input id="clr-color-value" name="clr-color-value" class="clr-color" type="text" value="" spellcheck="false" aria-label="'+p.a11y.input+'">'+('<div id="clr-color-area" class="clr-gradient" role="application" aria-label="'+p.a11y.instruction+'">')+'<div id="clr-color-marker" class="clr-marker" tabindex="0"></div></div><div class="clr-hue">'+('<input id="clr-hue-slider" name="clr-hue-slider" type="range" min="0" max="360" step="1" aria-label="'+p.a11y.hueSlider+'">')+'<div id="clr-hue-marker"></div></div><div class="clr-alpha">'+('<input id="clr-alpha-slider" name="clr-alpha-slider" type="range" min="0" max="100" step="1" aria-label="'+p.a11y.alphaSlider+'">')+'<div id="clr-alpha-marker"></div><span></span></div><div id="clr-format" class="clr-format"><fieldset class="clr-segmented">'+("<legend>"+p.a11y.format+"</legend>")+'<input id="clr-f1" type="radio" name="clr-format" value="hex"><label for="clr-f1">Hex</label><input id="clr-f2" type="radio" name="clr-format" value="rgb"><label for="clr-f2">RGB</label><input id="clr-f3" type="radio" name="clr-format" value="hsl"><label for="clr-f3">HSL</label><span></span></fieldset></div><div id="clr-swatches" class="clr-swatches"></div>'+('<button type="button" id="clr-clear" class="clr-clear" aria-label="'+p.a11y.clear+'">'+p.clearLabel+"</button>")+'<div id="clr-color-preview" class="clr-preview">'+('<button type="button" id="clr-close" class="clr-close" aria-label="'+p.a11y.close+'">'+p.closeLabel+"</button>")+"</div>"+('<span id="clr-open-label" hidden>'+p.a11y.open+"</span>")+('<span id="clr-swatch-label" hidden>'+p.a11y.swatch+"</span>"),e.body.appendChild(l),c=he("clr-color-area"),h=he("clr-color-marker"),S=he("clr-clear"),_=he("clr-close"),v=he("clr-color-preview"),I=he("clr-color-value"),O=he("clr-hue-slider"),X=he("clr-hue-marker"),F=he("clr-alpha-slider"),x=he("clr-alpha-marker"),A(p.el),Q(p.el),de(l,"mousedown",N=>{l.classList.remove("clr-keyboard-nav"),N.stopPropagation()}),de(c,"mousedown",N=>{de(e,"mousemove",re)}),de(c,"contextmenu",N=>{N.preventDefault()}),de(c,"touchstart",N=>{e.addEventListener("touchmove",re,{passive:!1})}),de(h,"mousedown",N=>{de(e,"mousemove",re)}),de(h,"touchstart",N=>{e.addEventListener("touchmove",re,{passive:!1})}),de(I,"change",N=>{const V=I.value;if(C||p.inline){const H=V===""?V:se(V);J(H)}}),de(S,"click",N=>{J(""),oe()}),de(_,"click",N=>{J(),oe()}),de(he("clr-format"),"click",".clr-format input",N=>{G=N.target.value,ve(),J()}),de(l,"click",".clr-swatches button",N=>{se(N.target.textContent),J(),p.swatchesOnly&&oe()}),de(e,"mouseup",N=>{e.removeEventListener("mousemove",re)}),de(e,"touchend",N=>{e.removeEventListener("touchmove",re)}),de(e,"mousedown",N=>{f=!1,l.classList.remove("clr-keyboard-nav"),oe()}),de(e,"keydown",N=>{const V=N.key,H=N.target,K=N.shiftKey;if(V==="Escape"?oe(!0):["Tab","ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(V)&&(f=!0,l.classList.add("clr-keyboard-nav")),V==="Tab"&&H.matches(".clr-picker *")){const B=tt(),W=B.shift(),Z=B.pop();K&&H===W?(Z.focus(),N.preventDefault()):!K&&H===Z&&(W.focus(),N.preventDefault())}}),de(e,"click",".clr-field button",N=>{T&&b(),N.target.nextElementSibling.dispatchEvent(new Event("click",{bubbles:!0}))}),de(h,"keydown",N=>{const V={ArrowUp:[0,-1],ArrowDown:[0,1],ArrowLeft:[-1,0],ArrowRight:[1,0]};Object.keys(V).includes(N.key)&&(ae(...V[N.key]),N.preventDefault())}),de(c,"click",re),de(O,"input",et),de(F,"input",gt))}function tt(){return Array.from(l.querySelectorAll("input, button")).filter(H=>!!H.offsetWidth)}function he(N){return e.getElementById(N)}function de(N,V,H,K){const D=Element.prototype.matches||Element.prototype.msMatchesSelector;typeof H=="string"?N.addEventListener(V,B=>{D.call(B.target,H)&&K.call(B.target,B)}):(K=H,N.addEventListener(V,K))}function Qe(N,V){V=V!==a?V:[],e.readyState!=="loading"?N(...V):e.addEventListener("DOMContentLoaded",()=>{N(...V)})}NodeList!==a&&NodeList.prototype&&!NodeList.prototype.forEach&&(NodeList.prototype.forEach=Array.prototype.forEach);function Et(N,V){C=V,r=C.value,R(V),G=ne(N),j(),se(N),J(),r!==N&&C.dispatchEvent(new Event("change",{bubbles:!0}))}const Pt=(()=>{const N={init:qe,set:M,wrap:Q,close:oe,setInstance:k,setColor:Et,removeInstance:$,updatePosition:j,ready:Qe};function V(H){Qe(()=>{H&&(typeof H=="string"?A(H):M(H))})}for(const H in N)V[H]=function(){for(var K=arguments.length,D=new Array(K),B=0;B<K;B++)D[B]=arguments[B];Qe(N[H],D)};return Qe(()=>{n.addEventListener("resize",H=>{V.updatePosition()}),n.addEventListener("scroll",H=>{V.updatePosition()})}),V})();return Pt.coloris=Pt,Pt})(window,document,Math)})();Fe.coloris;Fe.init;Fe.set;Fe.wrap;Fe.close;Fe.setInstance;Fe.removeInstance;Fe.updatePosition;var fr=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function pr(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}var ci={exports:{}};(function(n){(function(){function e(r){var f={omitExtraWLInCodeBlocks:{defaultValue:!1,describe:"Omit the default extra whiteline added to code blocks",type:"boolean"},noHeaderId:{defaultValue:!1,describe:"Turn on/off generated header id",type:"boolean"},prefixHeaderId:{defaultValue:!1,describe:"Add a prefix to the generated header ids. Passing a string will prefix that string to the header id. Setting to true will add a generic 'section-' prefix",type:"string"},rawPrefixHeaderId:{defaultValue:!1,describe:'Setting this option to true will prevent showdown from modifying the prefix. This might result in malformed IDs (if, for instance, the " char is used in the prefix)',type:"boolean"},ghCompatibleHeaderId:{defaultValue:!1,describe:"Generate header ids compatible with github style (spaces are replaced with dashes, a bunch of non alphanumeric chars are removed)",type:"boolean"},rawHeaderId:{defaultValue:!1,describe:`Remove only spaces, ' and " from generated header ids (including prefixes), replacing them with dashes (-). WARNING: This might result in malformed ids`,type:"boolean"},headerLevelStart:{defaultValue:!1,describe:"The header blocks level start",type:"integer"},parseImgDimensions:{defaultValue:!1,describe:"Turn on/off image dimension parsing",type:"boolean"},simplifiedAutoLink:{defaultValue:!1,describe:"Turn on/off GFM autolink style",type:"boolean"},excludeTrailingPunctuationFromURLs:{defaultValue:!1,describe:"Excludes trailing punctuation from links generated with autoLinking",type:"boolean"},literalMidWordUnderscores:{defaultValue:!1,describe:"Parse midword underscores as literal underscores",type:"boolean"},literalMidWordAsterisks:{defaultValue:!1,describe:"Parse midword asterisks as literal asterisks",type:"boolean"},strikethrough:{defaultValue:!1,describe:"Turn on/off strikethrough support",type:"boolean"},tables:{defaultValue:!1,describe:"Turn on/off tables support",type:"boolean"},tablesHeaderId:{defaultValue:!1,describe:"Add an id to table headers",type:"boolean"},ghCodeBlocks:{defaultValue:!0,describe:"Turn on/off GFM fenced code blocks support",type:"boolean"},tasklists:{defaultValue:!1,describe:"Turn on/off GFM tasklist support",type:"boolean"},smoothLivePreview:{defaultValue:!1,describe:"Prevents weird effects in live previews due to incomplete input",type:"boolean"},smartIndentationFix:{defaultValue:!1,describe:"Tries to smartly fix indentation in es6 strings",type:"boolean"},disableForced4SpacesIndentedSublists:{defaultValue:!1,describe:"Disables the requirement of indenting nested sublists by 4 spaces",type:"boolean"},simpleLineBreaks:{defaultValue:!1,describe:"Parses simple line breaks as <br> (GFM Style)",type:"boolean"},requireSpaceBeforeHeadingText:{defaultValue:!1,describe:"Makes adding a space between `#` and the header text mandatory (GFM Style)",type:"boolean"},ghMentions:{defaultValue:!1,describe:"Enables github @mentions",type:"boolean"},ghMentionsLink:{defaultValue:"https://github.com/{u}",describe:"Changes the link generated by @mentions. Only applies if ghMentions option is enabled.",type:"string"},encodeEmails:{defaultValue:!0,describe:"Encode e-mail addresses through the use of Character Entities, transforming ASCII e-mail addresses into its equivalent decimal entities",type:"boolean"},openLinksInNewWindow:{defaultValue:!1,describe:"Open all links in new windows",type:"boolean"},backslashEscapesHTMLTags:{defaultValue:!1,describe:"Support for HTML Tag escaping. ex: <div>foo</div>",type:"boolean"},emoji:{defaultValue:!1,describe:"Enable emoji support. Ex: `this is a :smile: emoji`",type:"boolean"},underline:{defaultValue:!1,describe:"Enable support for underline. Syntax is double or triple underscores: `__underline word__`. With this option enabled, underscores no longer parses into `<em>` and `<strong>`",type:"boolean"},ellipsis:{defaultValue:!0,describe:"Replaces three dots with the ellipsis unicode character",type:"boolean"},completeHTMLDocument:{defaultValue:!1,describe:"Outputs a complete html document, including `<html>`, `<head>` and `<body>` tags",type:"boolean"},metadata:{defaultValue:!1,describe:"Enable support for document metadata (defined at the top of the document between `«««` and `»»»` or between `---` and `---`).",type:"boolean"},splitAdjacentBlockquotes:{defaultValue:!1,describe:"Split adjacent blockquote blocks",type:"boolean"}};if(r===!1)return JSON.parse(JSON.stringify(f));var u={};for(var p in f)f.hasOwnProperty(p)&&(u[p]=f[p].defaultValue);return u}function t(){var r=e(!0),f={};for(var u in r)r.hasOwnProperty(u)&&(f[u]=!0);return f}var a={},i={},d={},s=e(!0),l="vanilla",c={github:{omitExtraWLInCodeBlocks:!0,simplifiedAutoLink:!0,excludeTrailingPunctuationFromURLs:!0,literalMidWordUnderscores:!0,strikethrough:!0,tables:!0,tablesHeaderId:!0,ghCodeBlocks:!0,tasklists:!0,disableForced4SpacesIndentedSublists:!0,simpleLineBreaks:!0,requireSpaceBeforeHeadingText:!0,ghCompatibleHeaderId:!0,ghMentions:!0,backslashEscapesHTMLTags:!0,emoji:!0,splitAdjacentBlockquotes:!0},original:{noHeaderId:!0,ghCodeBlocks:!1},ghost:{omitExtraWLInCodeBlocks:!0,parseImgDimensions:!0,simplifiedAutoLink:!0,excludeTrailingPunctuationFromURLs:!0,literalMidWordUnderscores:!0,strikethrough:!0,tables:!0,tablesHeaderId:!0,ghCodeBlocks:!0,tasklists:!0,smoothLivePreview:!0,simpleLineBreaks:!0,requireSpaceBeforeHeadingText:!0,ghMentions:!1,encodeEmails:!0},vanilla:e(!0),allOn:t()};a.helper={},a.extensions={},a.setOption=function(r,f){return s[r]=f,this},a.getOption=function(r){return s[r]},a.getOptions=function(){return s},a.resetOptions=function(){s=e(!0)},a.setFlavor=function(r){if(!c.hasOwnProperty(r))throw Error(r+" flavor was not found");a.resetOptions();var f=c[r];l=r;for(var u in f)f.hasOwnProperty(u)&&(s[u]=f[u])},a.getFlavor=function(){return l},a.getFlavorOptions=function(r){if(c.hasOwnProperty(r))return c[r]},a.getDefaultOptions=function(r){return e(r)},a.subParser=function(r,f){if(a.helper.isString(r))if(typeof f<"u")i[r]=f;else{if(i.hasOwnProperty(r))return i[r];throw Error("SubParser named "+r+" not registered!")}},a.extension=function(r,f){if(!a.helper.isString(r))throw Error("Extension 'name' must be a string");if(r=a.helper.stdExtName(r),a.helper.isUndefined(f)){if(!d.hasOwnProperty(r))throw Error("Extension named "+r+" is not registered!");return d[r]}else{typeof f=="function"&&(f=f()),a.helper.isArray(f)||(f=[f]);var u=h(f,r);if(u.valid)d[r]=f;else throw Error(u.error)}},a.getAllExtensions=function(){return d},a.removeExtension=function(r){delete d[r]},a.resetExtensions=function(){d={}};function h(r,f){var u=f?"Error in "+f+" extension->":"Error in unnamed extension",p={valid:!0,error:""};a.helper.isArray(r)||(r=[r]);for(var y=0;y<r.length;++y){var m=u+" sub-extension "+y+": ",g=r[y];if(typeof g!="object")return p.valid=!1,p.error=m+"must be an object, but "+typeof g+" given",p;if(!a.helper.isString(g.type))return p.valid=!1,p.error=m+'property "type" must be a string, but '+typeof g.type+" given",p;var T=g.type=g.type.toLowerCase();if(T==="language"&&(T=g.type="lang"),T==="html"&&(T=g.type="output"),T!=="lang"&&T!=="output"&&T!=="listener")return p.valid=!1,p.error=m+"type "+T+' is not recognized. Valid values: "lang/language", "output/html" or "listener"',p;if(T==="listener"){if(a.helper.isUndefined(g.listeners))return p.valid=!1,p.error=m+'. Extensions of type "listener" must have a property called "listeners"',p}else if(a.helper.isUndefined(g.filter)&&a.helper.isUndefined(g.regex))return p.valid=!1,p.error=m+T+' extensions must define either a "regex" property or a "filter" method',p;if(g.listeners){if(typeof g.listeners!="object")return p.valid=!1,p.error=m+'"listeners" property must be an object but '+typeof g.listeners+" given",p;for(var M in g.listeners)if(g.listeners.hasOwnProperty(M)&&typeof g.listeners[M]!="function")return p.valid=!1,p.error=m+'"listeners" property must be an hash of [event name]: [callback]. listeners.'+M+" must be a function but "+typeof g.listeners[M]+" given",p}if(g.filter){if(typeof g.filter!="function")return p.valid=!1,p.error=m+'"filter" must be a function, but '+typeof g.filter+" given",p}else if(g.regex){if(a.helper.isString(g.regex)&&(g.regex=new RegExp(g.regex,"g")),!(g.regex instanceof RegExp))return p.valid=!1,p.error=m+'"regex" property must either be a string or a RegExp object, but '+typeof g.regex+" given",p;if(a.helper.isUndefined(g.replace))return p.valid=!1,p.error=m+'"regex" extensions must implement a replace string or function',p}}return p}a.validateExtension=function(r){var f=h(r,null);return f.valid?!0:(console.warn(f.error),!1)},a.hasOwnProperty("helper")||(a.helper={}),a.helper.isString=function(r){return typeof r=="string"||r instanceof String},a.helper.isFunction=function(r){var f={};return r&&f.toString.call(r)==="[object Function]"},a.helper.isArray=function(r){return Array.isArray(r)},a.helper.isUndefined=function(r){return typeof r>"u"},a.helper.forEach=function(r,f){if(a.helper.isUndefined(r))throw new Error("obj param is required");if(a.helper.isUndefined(f))throw new Error("callback param is required");if(!a.helper.isFunction(f))throw new Error("callback param must be a function/closure");if(typeof r.forEach=="function")r.forEach(f);else if(a.helper.isArray(r))for(var u=0;u<r.length;u++)f(r[u],u,r);else if(typeof r=="object")for(var p in r)r.hasOwnProperty(p)&&f(r[p],p,r);else throw new Error("obj does not seem to be an array or an iterable object")},a.helper.stdExtName=function(r){return r.replace(/[_?*+\/\\.^-]/g,"").replace(/\s/g,"").toLowerCase()};function v(r,f){var u=f.charCodeAt(0);return"¨E"+u+"E"}a.helper.escapeCharactersCallback=v,a.helper.escapeCharacters=function(r,f,u){var p="(["+f.replace(/([\[\]\\])/g,"\\$1")+"])";u&&(p="\\\\"+p);var y=new RegExp(p,"g");return r=r.replace(y,v),r},a.helper.unescapeHTMLEntities=function(r){return r.replace(/&quot;/g,'"').replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&amp;/g,"&")};var I=function(r,f,u,p){var y=p||"",m=y.indexOf("g")>-1,g=new RegExp(f+"|"+u,"g"+y.replace(/g/g,"")),T=new RegExp(f,y.replace(/g/g,"")),M=[],k,$,R,b,A;do for(k=0;R=g.exec(r);)if(T.test(R[0]))k++||($=g.lastIndex,b=$-R[0].length);else if(k&&!--k){A=R.index+R[0].length;var z={left:{start:b,end:$},match:{start:$,end:R.index},right:{start:R.index,end:A},wholeMatch:{start:b,end:A}};if(M.push(z),!m)return M}while(k&&(g.lastIndex=$));return M};a.helper.matchRecursiveRegExp=function(r,f,u,p){for(var y=I(r,f,u,p),m=[],g=0;g<y.length;++g)m.push([r.slice(y[g].wholeMatch.start,y[g].wholeMatch.end),r.slice(y[g].match.start,y[g].match.end),r.slice(y[g].left.start,y[g].left.end),r.slice(y[g].right.start,y[g].right.end)]);return m},a.helper.replaceRecursiveRegExp=function(r,f,u,p,y){if(!a.helper.isFunction(f)){var m=f;f=function(){return m}}var g=I(r,u,p,y),T=r,M=g.length;if(M>0){var k=[];g[0].wholeMatch.start!==0&&k.push(r.slice(0,g[0].wholeMatch.start));for(var $=0;$<M;++$)k.push(f(r.slice(g[$].wholeMatch.start,g[$].wholeMatch.end),r.slice(g[$].match.start,g[$].match.end),r.slice(g[$].left.start,g[$].left.end),r.slice(g[$].right.start,g[$].right.end))),$<M-1&&k.push(r.slice(g[$].wholeMatch.end,g[$+1].wholeMatch.start));g[M-1].wholeMatch.end<r.length&&k.push(r.slice(g[M-1].wholeMatch.end)),T=k.join("")}return T},a.helper.regexIndexOf=function(r,f,u){if(!a.helper.isString(r))throw"InvalidArgumentError: first parameter of showdown.helper.regexIndexOf function must be a string";if(!(f instanceof RegExp))throw"InvalidArgumentError: second parameter of showdown.helper.regexIndexOf function must be an instance of RegExp";var p=r.substring(u||0).search(f);return p>=0?p+(u||0):p},a.helper.splitAtIndex=function(r,f){if(!a.helper.isString(r))throw"InvalidArgumentError: first parameter of showdown.helper.regexIndexOf function must be a string";return[r.substring(0,f),r.substring(f)]},a.helper.encodeEmailAddress=function(r){var f=[function(u){return"&#"+u.charCodeAt(0)+";"},function(u){return"&#x"+u.charCodeAt(0).toString(16)+";"},function(u){return u}];return r=r.replace(/./g,function(u){if(u==="@")u=f[Math.floor(Math.random()*2)](u);else{var p=Math.random();u=p>.9?f[2](u):p>.45?f[1](u):f[0](u)}return u}),r},a.helper.padEnd=function(f,u,p){return u=u>>0,p=String(p||" "),f.length>u?String(f):(u=u-f.length,u>p.length&&(p+=p.repeat(u/p.length)),String(f)+p.slice(0,u))},typeof console>"u"&&(console={warn:function(r){alert(r)},log:function(r){alert(r)},error:function(r){throw r}}),a.helper.regexes={asteriskDashAndColon:/([*_:~])/g},a.helper.emojis={"+1":"👍","-1":"👎",100:"💯",1234:"🔢","1st_place_medal":"🥇","2nd_place_medal":"🥈","3rd_place_medal":"🥉","8ball":"🎱",a:"🅰️",ab:"🆎",abc:"🔤",abcd:"🔡",accept:"🉑",aerial_tramway:"🚡",airplane:"✈️",alarm_clock:"⏰",alembic:"⚗️",alien:"👽",ambulance:"🚑",amphora:"🏺",anchor:"⚓️",angel:"👼",anger:"💢",angry:"😠",anguished:"😧",ant:"🐜",apple:"🍎",aquarius:"♒️",aries:"♈️",arrow_backward:"◀️",arrow_double_down:"⏬",arrow_double_up:"⏫",arrow_down:"⬇️",arrow_down_small:"🔽",arrow_forward:"▶️",arrow_heading_down:"⤵️",arrow_heading_up:"⤴️",arrow_left:"⬅️",arrow_lower_left:"↙️",arrow_lower_right:"↘️",arrow_right:"➡️",arrow_right_hook:"↪️",arrow_up:"⬆️",arrow_up_down:"↕️",arrow_up_small:"🔼",arrow_upper_left:"↖️",arrow_upper_right:"↗️",arrows_clockwise:"🔃",arrows_counterclockwise:"🔄",art:"🎨",articulated_lorry:"🚛",artificial_satellite:"🛰",astonished:"😲",athletic_shoe:"👟",atm:"🏧",atom_symbol:"⚛️",avocado:"🥑",b:"🅱️",baby:"👶",baby_bottle:"🍼",baby_chick:"🐤",baby_symbol:"🚼",back:"🔙",bacon:"🥓",badminton:"🏸",baggage_claim:"🛄",baguette_bread:"🥖",balance_scale:"⚖️",balloon:"🎈",ballot_box:"🗳",ballot_box_with_check:"☑️",bamboo:"🎍",banana:"🍌",bangbang:"‼️",bank:"🏦",bar_chart:"📊",barber:"💈",baseball:"⚾️",basketball:"🏀",basketball_man:"⛹️",basketball_woman:"⛹️&zwj;♀️",bat:"🦇",bath:"🛀",bathtub:"🛁",battery:"🔋",beach_umbrella:"🏖",bear:"🐻",bed:"🛏",bee:"🐝",beer:"🍺",beers:"🍻",beetle:"🐞",beginner:"🔰",bell:"🔔",bellhop_bell:"🛎",bento:"🍱",biking_man:"🚴",bike:"🚲",biking_woman:"🚴&zwj;♀️",bikini:"👙",biohazard:"☣️",bird:"🐦",birthday:"🎂",black_circle:"⚫️",black_flag:"🏴",black_heart:"🖤",black_joker:"🃏",black_large_square:"⬛️",black_medium_small_square:"◾️",black_medium_square:"◼️",black_nib:"✒️",black_small_square:"▪️",black_square_button:"🔲",blonde_man:"👱",blonde_woman:"👱&zwj;♀️",blossom:"🌼",blowfish:"🐡",blue_book:"📘",blue_car:"🚙",blue_heart:"💙",blush:"😊",boar:"🐗",boat:"⛵️",bomb:"💣",book:"📖",bookmark:"🔖",bookmark_tabs:"📑",books:"📚",boom:"💥",boot:"👢",bouquet:"💐",bowing_man:"🙇",bow_and_arrow:"🏹",bowing_woman:"🙇&zwj;♀️",bowling:"🎳",boxing_glove:"🥊",boy:"👦",bread:"🍞",bride_with_veil:"👰",bridge_at_night:"🌉",briefcase:"💼",broken_heart:"💔",bug:"🐛",building_construction:"🏗",bulb:"💡",bullettrain_front:"🚅",bullettrain_side:"🚄",burrito:"🌯",bus:"🚌",business_suit_levitating:"🕴",busstop:"🚏",bust_in_silhouette:"👤",busts_in_silhouette:"👥",butterfly:"🦋",cactus:"🌵",cake:"🍰",calendar:"📆",call_me_hand:"🤙",calling:"📲",camel:"🐫",camera:"📷",camera_flash:"📸",camping:"🏕",cancer:"♋️",candle:"🕯",candy:"🍬",canoe:"🛶",capital_abcd:"🔠",capricorn:"♑️",car:"🚗",card_file_box:"🗃",card_index:"📇",card_index_dividers:"🗂",carousel_horse:"🎠",carrot:"🥕",cat:"🐱",cat2:"🐈",cd:"💿",chains:"⛓",champagne:"🍾",chart:"💹",chart_with_downwards_trend:"📉",chart_with_upwards_trend:"📈",checkered_flag:"🏁",cheese:"🧀",cherries:"🍒",cherry_blossom:"🌸",chestnut:"🌰",chicken:"🐔",children_crossing:"🚸",chipmunk:"🐿",chocolate_bar:"🍫",christmas_tree:"🎄",church:"⛪️",cinema:"🎦",circus_tent:"🎪",city_sunrise:"🌇",city_sunset:"🌆",cityscape:"🏙",cl:"🆑",clamp:"🗜",clap:"👏",clapper:"🎬",classical_building:"🏛",clinking_glasses:"🥂",clipboard:"📋",clock1:"🕐",clock10:"🕙",clock1030:"🕥",clock11:"🕚",clock1130:"🕦",clock12:"🕛",clock1230:"🕧",clock130:"🕜",clock2:"🕑",clock230:"🕝",clock3:"🕒",clock330:"🕞",clock4:"🕓",clock430:"🕟",clock5:"🕔",clock530:"🕠",clock6:"🕕",clock630:"🕡",clock7:"🕖",clock730:"🕢",clock8:"🕗",clock830:"🕣",clock9:"🕘",clock930:"🕤",closed_book:"📕",closed_lock_with_key:"🔐",closed_umbrella:"🌂",cloud:"☁️",cloud_with_lightning:"🌩",cloud_with_lightning_and_rain:"⛈",cloud_with_rain:"🌧",cloud_with_snow:"🌨",clown_face:"🤡",clubs:"♣️",cocktail:"🍸",coffee:"☕️",coffin:"⚰️",cold_sweat:"😰",comet:"☄️",computer:"💻",computer_mouse:"🖱",confetti_ball:"🎊",confounded:"😖",confused:"😕",congratulations:"㊗️",construction:"🚧",construction_worker_man:"👷",construction_worker_woman:"👷&zwj;♀️",control_knobs:"🎛",convenience_store:"🏪",cookie:"🍪",cool:"🆒",policeman:"👮",copyright:"©️",corn:"🌽",couch_and_lamp:"🛋",couple:"👫",couple_with_heart_woman_man:"💑",couple_with_heart_man_man:"👨&zwj;❤️&zwj;👨",couple_with_heart_woman_woman:"👩&zwj;❤️&zwj;👩",couplekiss_man_man:"👨&zwj;❤️&zwj;💋&zwj;👨",couplekiss_man_woman:"💏",couplekiss_woman_woman:"👩&zwj;❤️&zwj;💋&zwj;👩",cow:"🐮",cow2:"🐄",cowboy_hat_face:"🤠",crab:"🦀",crayon:"🖍",credit_card:"💳",crescent_moon:"🌙",cricket:"🏏",crocodile:"🐊",croissant:"🥐",crossed_fingers:"🤞",crossed_flags:"🎌",crossed_swords:"⚔️",crown:"👑",cry:"😢",crying_cat_face:"😿",crystal_ball:"🔮",cucumber:"🥒",cupid:"💘",curly_loop:"➰",currency_exchange:"💱",curry:"🍛",custard:"🍮",customs:"🛃",cyclone:"🌀",dagger:"🗡",dancer:"💃",dancing_women:"👯",dancing_men:"👯&zwj;♂️",dango:"🍡",dark_sunglasses:"🕶",dart:"🎯",dash:"💨",date:"📅",deciduous_tree:"🌳",deer:"🦌",department_store:"🏬",derelict_house:"🏚",desert:"🏜",desert_island:"🏝",desktop_computer:"🖥",male_detective:"🕵️",diamond_shape_with_a_dot_inside:"💠",diamonds:"♦️",disappointed:"😞",disappointed_relieved:"😥",dizzy:"💫",dizzy_face:"😵",do_not_litter:"🚯",dog:"🐶",dog2:"🐕",dollar:"💵",dolls:"🎎",dolphin:"🐬",door:"🚪",doughnut:"🍩",dove:"🕊",dragon:"🐉",dragon_face:"🐲",dress:"👗",dromedary_camel:"🐪",drooling_face:"🤤",droplet:"💧",drum:"🥁",duck:"🦆",dvd:"📀","e-mail":"📧",eagle:"🦅",ear:"👂",ear_of_rice:"🌾",earth_africa:"🌍",earth_americas:"🌎",earth_asia:"🌏",egg:"🥚",eggplant:"🍆",eight_pointed_black_star:"✴️",eight_spoked_asterisk:"✳️",electric_plug:"🔌",elephant:"🐘",email:"✉️",end:"🔚",envelope_with_arrow:"📩",euro:"💶",european_castle:"🏰",european_post_office:"🏤",evergreen_tree:"🌲",exclamation:"❗️",expressionless:"😑",eye:"👁",eye_speech_bubble:"👁&zwj;🗨",eyeglasses:"👓",eyes:"👀",face_with_head_bandage:"🤕",face_with_thermometer:"🤒",fist_oncoming:"👊",factory:"🏭",fallen_leaf:"🍂",family_man_woman_boy:"👪",family_man_boy:"👨&zwj;👦",family_man_boy_boy:"👨&zwj;👦&zwj;👦",family_man_girl:"👨&zwj;👧",family_man_girl_boy:"👨&zwj;👧&zwj;👦",family_man_girl_girl:"👨&zwj;👧&zwj;👧",family_man_man_boy:"👨&zwj;👨&zwj;👦",family_man_man_boy_boy:"👨&zwj;👨&zwj;👦&zwj;👦",family_man_man_girl:"👨&zwj;👨&zwj;👧",family_man_man_girl_boy:"👨&zwj;👨&zwj;👧&zwj;👦",family_man_man_girl_girl:"👨&zwj;👨&zwj;👧&zwj;👧",family_man_woman_boy_boy:"👨&zwj;👩&zwj;👦&zwj;👦",family_man_woman_girl:"👨&zwj;👩&zwj;👧",family_man_woman_girl_boy:"👨&zwj;👩&zwj;👧&zwj;👦",family_man_woman_girl_girl:"👨&zwj;👩&zwj;👧&zwj;👧",family_woman_boy:"👩&zwj;👦",family_woman_boy_boy:"👩&zwj;👦&zwj;👦",family_woman_girl:"👩&zwj;👧",family_woman_girl_boy:"👩&zwj;👧&zwj;👦",family_woman_girl_girl:"👩&zwj;👧&zwj;👧",family_woman_woman_boy:"👩&zwj;👩&zwj;👦",family_woman_woman_boy_boy:"👩&zwj;👩&zwj;👦&zwj;👦",family_woman_woman_girl:"👩&zwj;👩&zwj;👧",family_woman_woman_girl_boy:"👩&zwj;👩&zwj;👧&zwj;👦",family_woman_woman_girl_girl:"👩&zwj;👩&zwj;👧&zwj;👧",fast_forward:"⏩",fax:"📠",fearful:"😨",feet:"🐾",female_detective:"🕵️&zwj;♀️",ferris_wheel:"🎡",ferry:"⛴",field_hockey:"🏑",file_cabinet:"🗄",file_folder:"📁",film_projector:"📽",film_strip:"🎞",fire:"🔥",fire_engine:"🚒",fireworks:"🎆",first_quarter_moon:"🌓",first_quarter_moon_with_face:"🌛",fish:"🐟",fish_cake:"🍥",fishing_pole_and_fish:"🎣",fist_raised:"✊",fist_left:"🤛",fist_right:"🤜",flags:"🎏",flashlight:"🔦",fleur_de_lis:"⚜️",flight_arrival:"🛬",flight_departure:"🛫",floppy_disk:"💾",flower_playing_cards:"🎴",flushed:"😳",fog:"🌫",foggy:"🌁",football:"🏈",footprints:"👣",fork_and_knife:"🍴",fountain:"⛲️",fountain_pen:"🖋",four_leaf_clover:"🍀",fox_face:"🦊",framed_picture:"🖼",free:"🆓",fried_egg:"🍳",fried_shrimp:"🍤",fries:"🍟",frog:"🐸",frowning:"😦",frowning_face:"☹️",frowning_man:"🙍&zwj;♂️",frowning_woman:"🙍",middle_finger:"🖕",fuelpump:"⛽️",full_moon:"🌕",full_moon_with_face:"🌝",funeral_urn:"⚱️",game_die:"🎲",gear:"⚙️",gem:"💎",gemini:"♊️",ghost:"👻",gift:"🎁",gift_heart:"💝",girl:"👧",globe_with_meridians:"🌐",goal_net:"🥅",goat:"🐐",golf:"⛳️",golfing_man:"🏌️",golfing_woman:"🏌️&zwj;♀️",gorilla:"🦍",grapes:"🍇",green_apple:"🍏",green_book:"📗",green_heart:"💚",green_salad:"🥗",grey_exclamation:"❕",grey_question:"❔",grimacing:"😬",grin:"😁",grinning:"😀",guardsman:"💂",guardswoman:"💂&zwj;♀️",guitar:"🎸",gun:"🔫",haircut_woman:"💇",haircut_man:"💇&zwj;♂️",hamburger:"🍔",hammer:"🔨",hammer_and_pick:"⚒",hammer_and_wrench:"🛠",hamster:"🐹",hand:"✋",handbag:"👜",handshake:"🤝",hankey:"💩",hatched_chick:"🐥",hatching_chick:"🐣",headphones:"🎧",hear_no_evil:"🙉",heart:"❤️",heart_decoration:"💟",heart_eyes:"😍",heart_eyes_cat:"😻",heartbeat:"💓",heartpulse:"💗",hearts:"♥️",heavy_check_mark:"✔️",heavy_division_sign:"➗",heavy_dollar_sign:"💲",heavy_heart_exclamation:"❣️",heavy_minus_sign:"➖",heavy_multiplication_x:"✖️",heavy_plus_sign:"➕",helicopter:"🚁",herb:"🌿",hibiscus:"🌺",high_brightness:"🔆",high_heel:"👠",hocho:"🔪",hole:"🕳",honey_pot:"🍯",horse:"🐴",horse_racing:"🏇",hospital:"🏥",hot_pepper:"🌶",hotdog:"🌭",hotel:"🏨",hotsprings:"♨️",hourglass:"⌛️",hourglass_flowing_sand:"⏳",house:"🏠",house_with_garden:"🏡",houses:"🏘",hugs:"🤗",hushed:"😯",ice_cream:"🍨",ice_hockey:"🏒",ice_skate:"⛸",icecream:"🍦",id:"🆔",ideograph_advantage:"🉐",imp:"👿",inbox_tray:"📥",incoming_envelope:"📨",tipping_hand_woman:"💁",information_source:"ℹ️",innocent:"😇",interrobang:"⁉️",iphone:"📱",izakaya_lantern:"🏮",jack_o_lantern:"🎃",japan:"🗾",japanese_castle:"🏯",japanese_goblin:"👺",japanese_ogre:"👹",jeans:"👖",joy:"😂",joy_cat:"😹",joystick:"🕹",kaaba:"🕋",key:"🔑",keyboard:"⌨️",keycap_ten:"🔟",kick_scooter:"🛴",kimono:"👘",kiss:"💋",kissing:"😗",kissing_cat:"😽",kissing_closed_eyes:"😚",kissing_heart:"😘",kissing_smiling_eyes:"😙",kiwi_fruit:"🥝",koala:"🐨",koko:"🈁",label:"🏷",large_blue_circle:"🔵",large_blue_diamond:"🔷",large_orange_diamond:"🔶",last_quarter_moon:"🌗",last_quarter_moon_with_face:"🌜",latin_cross:"✝️",laughing:"😆",leaves:"🍃",ledger:"📒",left_luggage:"🛅",left_right_arrow:"↔️",leftwards_arrow_with_hook:"↩️",lemon:"🍋",leo:"♌️",leopard:"🐆",level_slider:"🎚",libra:"♎️",light_rail:"🚈",link:"🔗",lion:"🦁",lips:"👄",lipstick:"💄",lizard:"🦎",lock:"🔒",lock_with_ink_pen:"🔏",lollipop:"🍭",loop:"➿",loud_sound:"🔊",loudspeaker:"📢",love_hotel:"🏩",love_letter:"💌",low_brightness:"🔅",lying_face:"🤥",m:"Ⓜ️",mag:"🔍",mag_right:"🔎",mahjong:"🀄️",mailbox:"📫",mailbox_closed:"📪",mailbox_with_mail:"📬",mailbox_with_no_mail:"📭",man:"👨",man_artist:"👨&zwj;🎨",man_astronaut:"👨&zwj;🚀",man_cartwheeling:"🤸&zwj;♂️",man_cook:"👨&zwj;🍳",man_dancing:"🕺",man_facepalming:"🤦&zwj;♂️",man_factory_worker:"👨&zwj;🏭",man_farmer:"👨&zwj;🌾",man_firefighter:"👨&zwj;🚒",man_health_worker:"👨&zwj;⚕️",man_in_tuxedo:"🤵",man_judge:"👨&zwj;⚖️",man_juggling:"🤹&zwj;♂️",man_mechanic:"👨&zwj;🔧",man_office_worker:"👨&zwj;💼",man_pilot:"👨&zwj;✈️",man_playing_handball:"🤾&zwj;♂️",man_playing_water_polo:"🤽&zwj;♂️",man_scientist:"👨&zwj;🔬",man_shrugging:"🤷&zwj;♂️",man_singer:"👨&zwj;🎤",man_student:"👨&zwj;🎓",man_teacher:"👨&zwj;🏫",man_technologist:"👨&zwj;💻",man_with_gua_pi_mao:"👲",man_with_turban:"👳",tangerine:"🍊",mans_shoe:"👞",mantelpiece_clock:"🕰",maple_leaf:"🍁",martial_arts_uniform:"🥋",mask:"😷",massage_woman:"💆",massage_man:"💆&zwj;♂️",meat_on_bone:"🍖",medal_military:"🎖",medal_sports:"🏅",mega:"📣",melon:"🍈",memo:"📝",men_wrestling:"🤼&zwj;♂️",menorah:"🕎",mens:"🚹",metal:"🤘",metro:"🚇",microphone:"🎤",microscope:"🔬",milk_glass:"🥛",milky_way:"🌌",minibus:"🚐",minidisc:"💽",mobile_phone_off:"📴",money_mouth_face:"🤑",money_with_wings:"💸",moneybag:"💰",monkey:"🐒",monkey_face:"🐵",monorail:"🚝",moon:"🌔",mortar_board:"🎓",mosque:"🕌",motor_boat:"🛥",motor_scooter:"🛵",motorcycle:"🏍",motorway:"🛣",mount_fuji:"🗻",mountain:"⛰",mountain_biking_man:"🚵",mountain_biking_woman:"🚵&zwj;♀️",mountain_cableway:"🚠",mountain_railway:"🚞",mountain_snow:"🏔",mouse:"🐭",mouse2:"🐁",movie_camera:"🎥",moyai:"🗿",mrs_claus:"🤶",muscle:"💪",mushroom:"🍄",musical_keyboard:"🎹",musical_note:"🎵",musical_score:"🎼",mute:"🔇",nail_care:"💅",name_badge:"📛",national_park:"🏞",nauseated_face:"🤢",necktie:"👔",negative_squared_cross_mark:"❎",nerd_face:"🤓",neutral_face:"😐",new:"🆕",new_moon:"🌑",new_moon_with_face:"🌚",newspaper:"📰",newspaper_roll:"🗞",next_track_button:"⏭",ng:"🆖",no_good_man:"🙅&zwj;♂️",no_good_woman:"🙅",night_with_stars:"🌃",no_bell:"🔕",no_bicycles:"🚳",no_entry:"⛔️",no_entry_sign:"🚫",no_mobile_phones:"📵",no_mouth:"😶",no_pedestrians:"🚷",no_smoking:"🚭","non-potable_water":"🚱",nose:"👃",notebook:"📓",notebook_with_decorative_cover:"📔",notes:"🎶",nut_and_bolt:"🔩",o:"⭕️",o2:"🅾️",ocean:"🌊",octopus:"🐙",oden:"🍢",office:"🏢",oil_drum:"🛢",ok:"🆗",ok_hand:"👌",ok_man:"🙆&zwj;♂️",ok_woman:"🙆",old_key:"🗝",older_man:"👴",older_woman:"👵",om:"🕉",on:"🔛",oncoming_automobile:"🚘",oncoming_bus:"🚍",oncoming_police_car:"🚔",oncoming_taxi:"🚖",open_file_folder:"📂",open_hands:"👐",open_mouth:"😮",open_umbrella:"☂️",ophiuchus:"⛎",orange_book:"📙",orthodox_cross:"☦️",outbox_tray:"📤",owl:"🦉",ox:"🐂",package:"📦",page_facing_up:"📄",page_with_curl:"📃",pager:"📟",paintbrush:"🖌",palm_tree:"🌴",pancakes:"🥞",panda_face:"🐼",paperclip:"📎",paperclips:"🖇",parasol_on_ground:"⛱",parking:"🅿️",part_alternation_mark:"〽️",partly_sunny:"⛅️",passenger_ship:"🛳",passport_control:"🛂",pause_button:"⏸",peace_symbol:"☮️",peach:"🍑",peanuts:"🥜",pear:"🍐",pen:"🖊",pencil2:"✏️",penguin:"🐧",pensive:"😔",performing_arts:"🎭",persevere:"😣",person_fencing:"🤺",pouting_woman:"🙎",phone:"☎️",pick:"⛏",pig:"🐷",pig2:"🐖",pig_nose:"🐽",pill:"💊",pineapple:"🍍",ping_pong:"🏓",pisces:"♓️",pizza:"🍕",place_of_worship:"🛐",plate_with_cutlery:"🍽",play_or_pause_button:"⏯",point_down:"👇",point_left:"👈",point_right:"👉",point_up:"☝️",point_up_2:"👆",police_car:"🚓",policewoman:"👮&zwj;♀️",poodle:"🐩",popcorn:"🍿",post_office:"🏣",postal_horn:"📯",postbox:"📮",potable_water:"🚰",potato:"🥔",pouch:"👝",poultry_leg:"🍗",pound:"💷",rage:"😡",pouting_cat:"😾",pouting_man:"🙎&zwj;♂️",pray:"🙏",prayer_beads:"📿",pregnant_woman:"🤰",previous_track_button:"⏮",prince:"🤴",princess:"👸",printer:"🖨",purple_heart:"💜",purse:"👛",pushpin:"📌",put_litter_in_its_place:"🚮",question:"❓",rabbit:"🐰",rabbit2:"🐇",racehorse:"🐎",racing_car:"🏎",radio:"📻",radio_button:"🔘",radioactive:"☢️",railway_car:"🚃",railway_track:"🛤",rainbow:"🌈",rainbow_flag:"🏳️&zwj;🌈",raised_back_of_hand:"🤚",raised_hand_with_fingers_splayed:"🖐",raised_hands:"🙌",raising_hand_woman:"🙋",raising_hand_man:"🙋&zwj;♂️",ram:"🐏",ramen:"🍜",rat:"🐀",record_button:"⏺",recycle:"♻️",red_circle:"🔴",registered:"®️",relaxed:"☺️",relieved:"😌",reminder_ribbon:"🎗",repeat:"🔁",repeat_one:"🔂",rescue_worker_helmet:"⛑",restroom:"🚻",revolving_hearts:"💞",rewind:"⏪",rhinoceros:"🦏",ribbon:"🎀",rice:"🍚",rice_ball:"🍙",rice_cracker:"🍘",rice_scene:"🎑",right_anger_bubble:"🗯",ring:"💍",robot:"🤖",rocket:"🚀",rofl:"🤣",roll_eyes:"🙄",roller_coaster:"🎢",rooster:"🐓",rose:"🌹",rosette:"🏵",rotating_light:"🚨",round_pushpin:"📍",rowing_man:"🚣",rowing_woman:"🚣&zwj;♀️",rugby_football:"🏉",running_man:"🏃",running_shirt_with_sash:"🎽",running_woman:"🏃&zwj;♀️",sa:"🈂️",sagittarius:"♐️",sake:"🍶",sandal:"👡",santa:"🎅",satellite:"📡",saxophone:"🎷",school:"🏫",school_satchel:"🎒",scissors:"✂️",scorpion:"🦂",scorpius:"♏️",scream:"😱",scream_cat:"🙀",scroll:"📜",seat:"💺",secret:"㊙️",see_no_evil:"🙈",seedling:"🌱",selfie:"🤳",shallow_pan_of_food:"🥘",shamrock:"☘️",shark:"🦈",shaved_ice:"🍧",sheep:"🐑",shell:"🐚",shield:"🛡",shinto_shrine:"⛩",ship:"🚢",shirt:"👕",shopping:"🛍",shopping_cart:"🛒",shower:"🚿",shrimp:"🦐",signal_strength:"📶",six_pointed_star:"🔯",ski:"🎿",skier:"⛷",skull:"💀",skull_and_crossbones:"☠️",sleeping:"😴",sleeping_bed:"🛌",sleepy:"😪",slightly_frowning_face:"🙁",slightly_smiling_face:"🙂",slot_machine:"🎰",small_airplane:"🛩",small_blue_diamond:"🔹",small_orange_diamond:"🔸",small_red_triangle:"🔺",small_red_triangle_down:"🔻",smile:"😄",smile_cat:"😸",smiley:"😃",smiley_cat:"😺",smiling_imp:"😈",smirk:"😏",smirk_cat:"😼",smoking:"🚬",snail:"🐌",snake:"🐍",sneezing_face:"🤧",snowboarder:"🏂",snowflake:"❄️",snowman:"⛄️",snowman_with_snow:"☃️",sob:"😭",soccer:"⚽️",soon:"🔜",sos:"🆘",sound:"🔉",space_invader:"👾",spades:"♠️",spaghetti:"🍝",sparkle:"❇️",sparkler:"🎇",sparkles:"✨",sparkling_heart:"💖",speak_no_evil:"🙊",speaker:"🔈",speaking_head:"🗣",speech_balloon:"💬",speedboat:"🚤",spider:"🕷",spider_web:"🕸",spiral_calendar:"🗓",spiral_notepad:"🗒",spoon:"🥄",squid:"🦑",stadium:"🏟",star:"⭐️",star2:"🌟",star_and_crescent:"☪️",star_of_david:"✡️",stars:"🌠",station:"🚉",statue_of_liberty:"🗽",steam_locomotive:"🚂",stew:"🍲",stop_button:"⏹",stop_sign:"🛑",stopwatch:"⏱",straight_ruler:"📏",strawberry:"🍓",stuck_out_tongue:"😛",stuck_out_tongue_closed_eyes:"😝",stuck_out_tongue_winking_eye:"😜",studio_microphone:"🎙",stuffed_flatbread:"🥙",sun_behind_large_cloud:"🌥",sun_behind_rain_cloud:"🌦",sun_behind_small_cloud:"🌤",sun_with_face:"🌞",sunflower:"🌻",sunglasses:"😎",sunny:"☀️",sunrise:"🌅",sunrise_over_mountains:"🌄",surfing_man:"🏄",surfing_woman:"🏄&zwj;♀️",sushi:"🍣",suspension_railway:"🚟",sweat:"😓",sweat_drops:"💦",sweat_smile:"😅",sweet_potato:"🍠",swimming_man:"🏊",swimming_woman:"🏊&zwj;♀️",symbols:"🔣",synagogue:"🕍",syringe:"💉",taco:"🌮",tada:"🎉",tanabata_tree:"🎋",taurus:"♉️",taxi:"🚕",tea:"🍵",telephone_receiver:"📞",telescope:"🔭",tennis:"🎾",tent:"⛺️",thermometer:"🌡",thinking:"🤔",thought_balloon:"💭",ticket:"🎫",tickets:"🎟",tiger:"🐯",tiger2:"🐅",timer_clock:"⏲",tipping_hand_man:"💁&zwj;♂️",tired_face:"😫",tm:"™️",toilet:"🚽",tokyo_tower:"🗼",tomato:"🍅",tongue:"👅",top:"🔝",tophat:"🎩",tornado:"🌪",trackball:"🖲",tractor:"🚜",traffic_light:"🚥",train:"🚋",train2:"🚆",tram:"🚊",triangular_flag_on_post:"🚩",triangular_ruler:"📐",trident:"🔱",triumph:"😤",trolleybus:"🚎",trophy:"🏆",tropical_drink:"🍹",tropical_fish:"🐠",truck:"🚚",trumpet:"🎺",tulip:"🌷",tumbler_glass:"🥃",turkey:"🦃",turtle:"🐢",tv:"📺",twisted_rightwards_arrows:"🔀",two_hearts:"💕",two_men_holding_hands:"👬",two_women_holding_hands:"👭",u5272:"🈹",u5408:"🈴",u55b6:"🈺",u6307:"🈯️",u6708:"🈷️",u6709:"🈶",u6e80:"🈵",u7121:"🈚️",u7533:"🈸",u7981:"🈲",u7a7a:"🈳",umbrella:"☔️",unamused:"😒",underage:"🔞",unicorn:"🦄",unlock:"🔓",up:"🆙",upside_down_face:"🙃",v:"✌️",vertical_traffic_light:"🚦",vhs:"📼",vibration_mode:"📳",video_camera:"📹",video_game:"🎮",violin:"🎻",virgo:"♍️",volcano:"🌋",volleyball:"🏐",vs:"🆚",vulcan_salute:"🖖",walking_man:"🚶",walking_woman:"🚶&zwj;♀️",waning_crescent_moon:"🌘",waning_gibbous_moon:"🌖",warning:"⚠️",wastebasket:"🗑",watch:"⌚️",water_buffalo:"🐃",watermelon:"🍉",wave:"👋",wavy_dash:"〰️",waxing_crescent_moon:"🌒",wc:"🚾",weary:"😩",wedding:"💒",weight_lifting_man:"🏋️",weight_lifting_woman:"🏋️&zwj;♀️",whale:"🐳",whale2:"🐋",wheel_of_dharma:"☸️",wheelchair:"♿️",white_check_mark:"✅",white_circle:"⚪️",white_flag:"🏳️",white_flower:"💮",white_large_square:"⬜️",white_medium_small_square:"◽️",white_medium_square:"◻️",white_small_square:"▫️",white_square_button:"🔳",wilted_flower:"🥀",wind_chime:"🎐",wind_face:"🌬",wine_glass:"🍷",wink:"😉",wolf:"🐺",woman:"👩",woman_artist:"👩&zwj;🎨",woman_astronaut:"👩&zwj;🚀",woman_cartwheeling:"🤸&zwj;♀️",woman_cook:"👩&zwj;🍳",woman_facepalming:"🤦&zwj;♀️",woman_factory_worker:"👩&zwj;🏭",woman_farmer:"👩&zwj;🌾",woman_firefighter:"👩&zwj;🚒",woman_health_worker:"👩&zwj;⚕️",woman_judge:"👩&zwj;⚖️",woman_juggling:"🤹&zwj;♀️",woman_mechanic:"👩&zwj;🔧",woman_office_worker:"👩&zwj;💼",woman_pilot:"👩&zwj;✈️",woman_playing_handball:"🤾&zwj;♀️",woman_playing_water_polo:"🤽&zwj;♀️",woman_scientist:"👩&zwj;🔬",woman_shrugging:"🤷&zwj;♀️",woman_singer:"👩&zwj;🎤",woman_student:"👩&zwj;🎓",woman_teacher:"👩&zwj;🏫",woman_technologist:"👩&zwj;💻",woman_with_turban:"👳&zwj;♀️",womans_clothes:"👚",womans_hat:"👒",women_wrestling:"🤼&zwj;♀️",womens:"🚺",world_map:"🗺",worried:"😟",wrench:"🔧",writing_hand:"✍️",x:"❌",yellow_heart:"💛",yen:"💴",yin_yang:"☯️",yum:"😋",zap:"⚡️",zipper_mouth_face:"🤐",zzz:"💤",octocat:'<img alt=":octocat:" height="20" width="20" align="absmiddle" src="https://assets-cdn.github.com/images/icons/emoji/octocat.png">',showdown:`<span style="font-family: 'Anonymous Pro', monospace; text-decoration: underline; text-decoration-style: dashed; text-decoration-color: #3e8b8a;text-underline-position: under;">S</span>`},a.Converter=function(r){var f={},u=[],p=[],y={},m=l,g={parsed:{},raw:"",format:""};T();function T(){r=r||{};for(var b in s)s.hasOwnProperty(b)&&(f[b]=s[b]);if(typeof r=="object")for(var A in r)r.hasOwnProperty(A)&&(f[A]=r[A]);else throw Error("Converter expects the passed parameter to be an object, but "+typeof r+" was passed instead.");f.extensions&&a.helper.forEach(f.extensions,M)}function M(b,A){if(A=A||null,a.helper.isString(b))if(b=a.helper.stdExtName(b),A=b,a.extensions[b]){console.warn("DEPRECATION WARNING: "+b+" is an old extension that uses a deprecated loading method.Please inform the developer that the extension should be updated!"),k(a.extensions[b],b);return}else if(!a.helper.isUndefined(d[b]))b=d[b];else throw Error('Extension "'+b+'" could not be loaded. It was either not found or is not a valid extension.');typeof b=="function"&&(b=b()),a.helper.isArray(b)||(b=[b]);var z=h(b,A);if(!z.valid)throw Error(z.error);for(var j=0;j<b.length;++j){switch(b[j].type){case"lang":u.push(b[j]);break;case"output":p.push(b[j]);break}if(b[j].hasOwnProperty("listeners"))for(var Q in b[j].listeners)b[j].listeners.hasOwnProperty(Q)&&$(Q,b[j].listeners[Q])}}function k(b,A){typeof b=="function"&&(b=b(new a.Converter)),a.helper.isArray(b)||(b=[b]);var z=h(b,A);if(!z.valid)throw Error(z.error);for(var j=0;j<b.length;++j)switch(b[j].type){case"lang":u.push(b[j]);break;case"output":p.push(b[j]);break;default:throw Error("Extension loader error: Type unrecognized!!!")}}function $(b,A){if(!a.helper.isString(b))throw Error("Invalid argument in converter.listen() method: name must be a string, but "+typeof b+" given");if(typeof A!="function")throw Error("Invalid argument in converter.listen() method: callback must be a function, but "+typeof A+" given");y.hasOwnProperty(b)||(y[b]=[]),y[b].push(A)}function R(b){var A=b.match(/^\s*/)[0].length,z=new RegExp("^\\s{0,"+A+"}","gm");return b.replace(z,"")}this._dispatch=function(A,z,j,Q){if(y.hasOwnProperty(A))for(var Y=0;Y<y[A].length;++Y){var te=y[A][Y](A,z,this,j,Q);te&&typeof te<"u"&&(z=te)}return z},this.listen=function(b,A){return $(b,A),this},this.makeHtml=function(b){if(!b)return b;var A={gHtmlBlocks:[],gHtmlMdBlocks:[],gHtmlSpans:[],gUrls:{},gTitles:{},gDimensions:{},gListLevel:0,hashLinkCounts:{},langExtensions:u,outputModifiers:p,converter:this,ghCodeBlocks:[],metadata:{parsed:{},raw:"",format:""}};return b=b.replace(/¨/g,"¨T"),b=b.replace(/\$/g,"¨D"),b=b.replace(/\r\n/g,`
`),b=b.replace(/\r/g,`
`),b=b.replace(/\u00A0/g,"&nbsp;"),f.smartIndentationFix&&(b=R(b)),b=`

`+b+`

`,b=a.subParser("detab")(b,f,A),b=b.replace(/^[ \t]+$/mg,""),a.helper.forEach(u,function(z){b=a.subParser("runExtension")(z,b,f,A)}),b=a.subParser("metadata")(b,f,A),b=a.subParser("hashPreCodeTags")(b,f,A),b=a.subParser("githubCodeBlocks")(b,f,A),b=a.subParser("hashHTMLBlocks")(b,f,A),b=a.subParser("hashCodeTags")(b,f,A),b=a.subParser("stripLinkDefinitions")(b,f,A),b=a.subParser("blockGamut")(b,f,A),b=a.subParser("unhashHTMLSpans")(b,f,A),b=a.subParser("unescapeSpecialChars")(b,f,A),b=b.replace(/¨D/g,"$$"),b=b.replace(/¨T/g,"¨"),b=a.subParser("completeHTMLDocument")(b,f,A),a.helper.forEach(p,function(z){b=a.subParser("runExtension")(z,b,f,A)}),g=A.metadata,b},this.makeMarkdown=this.makeMd=function(b,A){if(b=b.replace(/\r\n/g,`
`),b=b.replace(/\r/g,`
`),b=b.replace(/>[ \t]+</,">¨NBSP;<"),!A)if(window&&window.document)A=window.document;else throw new Error("HTMLParser is undefined. If in a webworker or nodejs environment, you need to provide a WHATWG DOM and HTML such as JSDOM");var z=A.createElement("div");z.innerHTML=b;var j={preList:se(z)};oe(z);for(var Q=z.childNodes,Y="",te=0;te<Q.length;te++)Y+=a.subParser("makeMarkdown.node")(Q[te],j);function oe(ne){for(var J=0;J<ne.childNodes.length;++J){var L=ne.childNodes[J];L.nodeType===3?!/\S/.test(L.nodeValue)&&!/^[ ]+$/.test(L.nodeValue)?(ne.removeChild(L),--J):(L.nodeValue=L.nodeValue.split(`
`).join(" "),L.nodeValue=L.nodeValue.replace(/(\s)+/g,"$1")):L.nodeType===1&&oe(L)}}function se(ne){for(var J=ne.querySelectorAll("pre"),L=[],P=0;P<J.length;++P)if(J[P].childElementCount===1&&J[P].firstChild.tagName.toLowerCase()==="code"){var U=J[P].firstChild.innerHTML.trim(),re=J[P].firstChild.getAttribute("data-language")||"";if(re==="")for(var ae=J[P].firstChild.className.split(" "),ce=0;ce<ae.length;++ce){var ve=ae[ce].match(/^language-(.+)$/);if(ve!==null){re=ve[1];break}}U=a.helper.unescapeHTMLEntities(U),L.push(U),J[P].outerHTML='<precode language="'+re+'" precodenum="'+P.toString()+'"></precode>'}else L.push(J[P].innerHTML),J[P].innerHTML="",J[P].setAttribute("prenum",P.toString());return L}return Y},this.setOption=function(b,A){f[b]=A},this.getOption=function(b){return f[b]},this.getOptions=function(){return f},this.addExtension=function(b,A){A=A||null,M(b,A)},this.useExtension=function(b){M(b)},this.setFlavor=function(b){if(!c.hasOwnProperty(b))throw Error(b+" flavor was not found");var A=c[b];m=b;for(var z in A)A.hasOwnProperty(z)&&(f[z]=A[z])},this.getFlavor=function(){return m},this.removeExtension=function(b){a.helper.isArray(b)||(b=[b]);for(var A=0;A<b.length;++A){for(var z=b[A],j=0;j<u.length;++j)u[j]===z&&u.splice(j,1);for(var Q=0;Q<p.length;++Q)p[Q]===z&&p.splice(Q,1)}},this.getAllExtensions=function(){return{language:u,output:p}},this.getMetadata=function(b){return b?g.raw:g.parsed},this.getMetadataFormat=function(){return g.format},this._setMetadataPair=function(b,A){g.parsed[b]=A},this._setMetadataFormat=function(b){g.format=b},this._setMetadataRaw=function(b){g.raw=b}},a.subParser("anchors",function(r,f,u){r=u.converter._dispatch("anchors.before",r,f,u);var p=function(y,m,g,T,M,k,$){if(a.helper.isUndefined($)&&($=""),g=g.toLowerCase(),y.search(/\(<?\s*>? ?(['"].*['"])?\)$/m)>-1)T="";else if(!T)if(g||(g=m.toLowerCase().replace(/ ?\n/g," ")),T="#"+g,!a.helper.isUndefined(u.gUrls[g]))T=u.gUrls[g],a.helper.isUndefined(u.gTitles[g])||($=u.gTitles[g]);else return y;T=T.replace(a.helper.regexes.asteriskDashAndColon,a.helper.escapeCharactersCallback);var R='<a href="'+T+'"';return $!==""&&$!==null&&($=$.replace(/"/g,"&quot;"),$=$.replace(a.helper.regexes.asteriskDashAndColon,a.helper.escapeCharactersCallback),R+=' title="'+$+'"'),f.openLinksInNewWindow&&!/^#/.test(T)&&(R+=' rel="noopener noreferrer" target="¨E95Eblank"'),R+=">"+m+"</a>",R};return r=r.replace(/\[((?:\[[^\]]*]|[^\[\]])*)] ?(?:\n *)?\[(.*?)]()()()()/g,p),r=r.replace(/\[((?:\[[^\]]*]|[^\[\]])*)]()[ \t]*\([ \t]?<([^>]*)>(?:[ \t]*((["'])([^"]*?)\5))?[ \t]?\)/g,p),r=r.replace(/\[((?:\[[^\]]*]|[^\[\]])*)]()[ \t]*\([ \t]?<?([\S]+?(?:\([\S]*?\)[\S]*?)?)>?(?:[ \t]*((["'])([^"]*?)\5))?[ \t]?\)/g,p),r=r.replace(/\[([^\[\]]+)]()()()()()/g,p),f.ghMentions&&(r=r.replace(/(^|\s)(\\)?(@([a-z\d]+(?:[a-z\d.-]+?[a-z\d]+)*))/gmi,function(y,m,g,T,M){if(g==="\\")return m+T;if(!a.helper.isString(f.ghMentionsLink))throw new Error("ghMentionsLink option must be a string");var k=f.ghMentionsLink.replace(/\{u}/g,M),$="";return f.openLinksInNewWindow&&($=' rel="noopener noreferrer" target="¨E95Eblank"'),m+'<a href="'+k+'"'+$+">"+T+"</a>"})),r=u.converter._dispatch("anchors.after",r,f,u),r});var S=/([*~_]+|\b)(((https?|ftp|dict):\/\/|www\.)[^'">\s]+?\.[^'">\s]+?)()(\1)?(?=\s|$)(?!["<>])/gi,_=/([*~_]+|\b)(((https?|ftp|dict):\/\/|www\.)[^'">\s]+\.[^'">\s]+?)([.!?,()\[\]])?(\1)?(?=\s|$)(?!["<>])/gi,O=/()<(((https?|ftp|dict):\/\/|www\.)[^'">\s]+)()>()/gi,X=/(^|\s)(?:mailto:)?([A-Za-z0-9!#$%&'*+-/=?^_`{|}~.]+@[-a-z0-9]+(\.[-a-z0-9]+)*\.[a-z]+)(?=$|\s)/gmi,F=/<()(?:mailto:)?([-.\w]+@[-a-z0-9]+(\.[-a-z0-9]+)*\.[a-z]+)>/gi,x=function(r){return function(f,u,p,y,m,g,T){p=p.replace(a.helper.regexes.asteriskDashAndColon,a.helper.escapeCharactersCallback);var M=p,k="",$="",R=u||"",b=T||"";return/^www\./i.test(p)&&(p=p.replace(/^www\./i,"http://www.")),r.excludeTrailingPunctuationFromURLs&&g&&(k=g),r.openLinksInNewWindow&&($=' rel="noopener noreferrer" target="¨E95Eblank"'),R+'<a href="'+p+'"'+$+">"+M+"</a>"+k+b}},C=function(r,f){return function(u,p,y){var m="mailto:";return p=p||"",y=a.subParser("unescapeSpecialChars")(y,r,f),r.encodeEmails?(m=a.helper.encodeEmailAddress(m+y),y=a.helper.encodeEmailAddress(y)):m=m+y,p+'<a href="'+m+'">'+y+"</a>"}};a.subParser("autoLinks",function(r,f,u){return r=u.converter._dispatch("autoLinks.before",r,f,u),r=r.replace(O,x(f)),r=r.replace(F,C(f,u)),r=u.converter._dispatch("autoLinks.after",r,f,u),r}),a.subParser("simplifiedAutoLinks",function(r,f,u){return f.simplifiedAutoLink&&(r=u.converter._dispatch("simplifiedAutoLinks.before",r,f,u),f.excludeTrailingPunctuationFromURLs?r=r.replace(_,x(f)):r=r.replace(S,x(f)),r=r.replace(X,C(f,u)),r=u.converter._dispatch("simplifiedAutoLinks.after",r,f,u)),r}),a.subParser("blockGamut",function(r,f,u){return r=u.converter._dispatch("blockGamut.before",r,f,u),r=a.subParser("blockQuotes")(r,f,u),r=a.subParser("headers")(r,f,u),r=a.subParser("horizontalRule")(r,f,u),r=a.subParser("lists")(r,f,u),r=a.subParser("codeBlocks")(r,f,u),r=a.subParser("tables")(r,f,u),r=a.subParser("hashHTMLBlocks")(r,f,u),r=a.subParser("paragraphs")(r,f,u),r=u.converter._dispatch("blockGamut.after",r,f,u),r}),a.subParser("blockQuotes",function(r,f,u){r=u.converter._dispatch("blockQuotes.before",r,f,u),r=r+`

`;var p=/(^ {0,3}>[ \t]?.+\n(.+\n)*\n*)+/gm;return f.splitAdjacentBlockquotes&&(p=/^ {0,3}>[\s\S]*?(?:\n\n)/gm),r=r.replace(p,function(y){return y=y.replace(/^[ \t]*>[ \t]?/gm,""),y=y.replace(/¨0/g,""),y=y.replace(/^[ \t]+$/gm,""),y=a.subParser("githubCodeBlocks")(y,f,u),y=a.subParser("blockGamut")(y,f,u),y=y.replace(/(^|\n)/g,"$1  "),y=y.replace(/(\s*<pre>[^\r]+?<\/pre>)/gm,function(m,g){var T=g;return T=T.replace(/^  /mg,"¨0"),T=T.replace(/¨0/g,""),T}),a.subParser("hashBlock")(`<blockquote>
`+y+`
</blockquote>`,f,u)}),r=u.converter._dispatch("blockQuotes.after",r,f,u),r}),a.subParser("codeBlocks",function(r,f,u){r=u.converter._dispatch("codeBlocks.before",r,f,u),r+="¨0";var p=/(?:\n\n|^)((?:(?:[ ]{4}|\t).*\n+)+)(\n*[ ]{0,3}[^ \t\n]|(?=¨0))/g;return r=r.replace(p,function(y,m,g){var T=m,M=g,k=`
`;return T=a.subParser("outdent")(T,f,u),T=a.subParser("encodeCode")(T,f,u),T=a.subParser("detab")(T,f,u),T=T.replace(/^\n+/g,""),T=T.replace(/\n+$/g,""),f.omitExtraWLInCodeBlocks&&(k=""),T="<pre><code>"+T+k+"</code></pre>",a.subParser("hashBlock")(T,f,u)+M}),r=r.replace(/¨0/,""),r=u.converter._dispatch("codeBlocks.after",r,f,u),r}),a.subParser("codeSpans",function(r,f,u){return r=u.converter._dispatch("codeSpans.before",r,f,u),typeof r>"u"&&(r=""),r=r.replace(/(^|[^\\])(`+)([^\r]*?[^`])\2(?!`)/gm,function(p,y,m,g){var T=g;return T=T.replace(/^([ \t]*)/g,""),T=T.replace(/[ \t]*$/g,""),T=a.subParser("encodeCode")(T,f,u),T=y+"<code>"+T+"</code>",T=a.subParser("hashHTMLSpans")(T,f,u),T}),r=u.converter._dispatch("codeSpans.after",r,f,u),r}),a.subParser("completeHTMLDocument",function(r,f,u){if(!f.completeHTMLDocument)return r;r=u.converter._dispatch("completeHTMLDocument.before",r,f,u);var p="html",y=`<!DOCTYPE HTML>
`,m="",g=`<meta charset="utf-8">
`,T="",M="";typeof u.metadata.parsed.doctype<"u"&&(y="<!DOCTYPE "+u.metadata.parsed.doctype+`>
`,p=u.metadata.parsed.doctype.toString().toLowerCase(),(p==="html"||p==="html5")&&(g='<meta charset="utf-8">'));for(var k in u.metadata.parsed)if(u.metadata.parsed.hasOwnProperty(k))switch(k.toLowerCase()){case"doctype":break;case"title":m="<title>"+u.metadata.parsed.title+`</title>
`;break;case"charset":p==="html"||p==="html5"?g='<meta charset="'+u.metadata.parsed.charset+`">
`:g='<meta name="charset" content="'+u.metadata.parsed.charset+`">
`;break;case"language":case"lang":T=' lang="'+u.metadata.parsed[k]+'"',M+='<meta name="'+k+'" content="'+u.metadata.parsed[k]+`">
`;break;default:M+='<meta name="'+k+'" content="'+u.metadata.parsed[k]+`">
`}return r=y+"<html"+T+`>
<head>
`+m+g+M+`</head>
<body>
`+r.trim()+`
</body>
</html>`,r=u.converter._dispatch("completeHTMLDocument.after",r,f,u),r}),a.subParser("detab",function(r,f,u){return r=u.converter._dispatch("detab.before",r,f,u),r=r.replace(/\t(?=\t)/g,"    "),r=r.replace(/\t/g,"¨A¨B"),r=r.replace(/¨B(.+?)¨A/g,function(p,y){for(var m=y,g=4-m.length%4,T=0;T<g;T++)m+=" ";return m}),r=r.replace(/¨A/g,"    "),r=r.replace(/¨B/g,""),r=u.converter._dispatch("detab.after",r,f,u),r}),a.subParser("ellipsis",function(r,f,u){return f.ellipsis&&(r=u.converter._dispatch("ellipsis.before",r,f,u),r=r.replace(/\.\.\./g,"…"),r=u.converter._dispatch("ellipsis.after",r,f,u)),r}),a.subParser("emoji",function(r,f,u){if(!f.emoji)return r;r=u.converter._dispatch("emoji.before",r,f,u);var p=/:([\S]+?):/g;return r=r.replace(p,function(y,m){return a.helper.emojis.hasOwnProperty(m)?a.helper.emojis[m]:y}),r=u.converter._dispatch("emoji.after",r,f,u),r}),a.subParser("encodeAmpsAndAngles",function(r,f,u){return r=u.converter._dispatch("encodeAmpsAndAngles.before",r,f,u),r=r.replace(/&(?!#?[xX]?(?:[0-9a-fA-F]+|\w+);)/g,"&amp;"),r=r.replace(/<(?![a-z\/?$!])/gi,"&lt;"),r=r.replace(/</g,"&lt;"),r=r.replace(/>/g,"&gt;"),r=u.converter._dispatch("encodeAmpsAndAngles.after",r,f,u),r}),a.subParser("encodeBackslashEscapes",function(r,f,u){return r=u.converter._dispatch("encodeBackslashEscapes.before",r,f,u),r=r.replace(/\\(\\)/g,a.helper.escapeCharactersCallback),r=r.replace(/\\([`*_{}\[\]()>#+.!~=|:-])/g,a.helper.escapeCharactersCallback),r=u.converter._dispatch("encodeBackslashEscapes.after",r,f,u),r}),a.subParser("encodeCode",function(r,f,u){return r=u.converter._dispatch("encodeCode.before",r,f,u),r=r.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/([*_{}\[\]\\=~-])/g,a.helper.escapeCharactersCallback),r=u.converter._dispatch("encodeCode.after",r,f,u),r}),a.subParser("escapeSpecialCharsWithinTagAttributes",function(r,f,u){r=u.converter._dispatch("escapeSpecialCharsWithinTagAttributes.before",r,f,u);var p=/<\/?[a-z\d_:-]+(?:[\s]+[\s\S]+?)?>/gi,y=/<!(--(?:(?:[^>-]|-[^>])(?:[^-]|-[^-])*)--)>/gi;return r=r.replace(p,function(m){return m.replace(/(.)<\/?code>(?=.)/g,"$1`").replace(/([\\`*_~=|])/g,a.helper.escapeCharactersCallback)}),r=r.replace(y,function(m){return m.replace(/([\\`*_~=|])/g,a.helper.escapeCharactersCallback)}),r=u.converter._dispatch("escapeSpecialCharsWithinTagAttributes.after",r,f,u),r}),a.subParser("githubCodeBlocks",function(r,f,u){return f.ghCodeBlocks?(r=u.converter._dispatch("githubCodeBlocks.before",r,f,u),r+="¨0",r=r.replace(/(?:^|\n)(?: {0,3})(```+|~~~+)(?: *)([^\s`~]*)\n([\s\S]*?)\n(?: {0,3})\1/g,function(p,y,m,g){var T=f.omitExtraWLInCodeBlocks?"":`
`;return g=a.subParser("encodeCode")(g,f,u),g=a.subParser("detab")(g,f,u),g=g.replace(/^\n+/g,""),g=g.replace(/\n+$/g,""),g="<pre><code"+(m?' class="'+m+" language-"+m+'"':"")+">"+g+T+"</code></pre>",g=a.subParser("hashBlock")(g,f,u),`

¨G`+(u.ghCodeBlocks.push({text:p,codeblock:g})-1)+`G

`}),r=r.replace(/¨0/,""),u.converter._dispatch("githubCodeBlocks.after",r,f,u)):r}),a.subParser("hashBlock",function(r,f,u){return r=u.converter._dispatch("hashBlock.before",r,f,u),r=r.replace(/(^\n+|\n+$)/g,""),r=`

¨K`+(u.gHtmlBlocks.push(r)-1)+`K

`,r=u.converter._dispatch("hashBlock.after",r,f,u),r}),a.subParser("hashCodeTags",function(r,f,u){r=u.converter._dispatch("hashCodeTags.before",r,f,u);var p=function(y,m,g,T){var M=g+a.subParser("encodeCode")(m,f,u)+T;return"¨C"+(u.gHtmlSpans.push(M)-1)+"C"};return r=a.helper.replaceRecursiveRegExp(r,p,"<code\\b[^>]*>","</code>","gim"),r=u.converter._dispatch("hashCodeTags.after",r,f,u),r}),a.subParser("hashElement",function(r,f,u){return function(p,y){var m=y;return m=m.replace(/\n\n/g,`
`),m=m.replace(/^\n/,""),m=m.replace(/\n+$/g,""),m=`

¨K`+(u.gHtmlBlocks.push(m)-1)+`K

`,m}}),a.subParser("hashHTMLBlocks",function(r,f,u){r=u.converter._dispatch("hashHTMLBlocks.before",r,f,u);var p=["pre","div","h1","h2","h3","h4","h5","h6","blockquote","table","dl","ol","ul","script","noscript","form","fieldset","iframe","math","style","section","header","footer","nav","article","aside","address","audio","canvas","figure","hgroup","output","video","p"],y=function(b,A,z,j){var Q=b;return z.search(/\bmarkdown\b/)!==-1&&(Q=z+u.converter.makeHtml(A)+j),`

¨K`+(u.gHtmlBlocks.push(Q)-1)+`K

`};f.backslashEscapesHTMLTags&&(r=r.replace(/\\<(\/?[^>]+?)>/g,function(b,A){return"&lt;"+A+"&gt;"}));for(var m=0;m<p.length;++m)for(var g,T=new RegExp("^ {0,3}(<"+p[m]+"\\b[^>]*>)","im"),M="<"+p[m]+"\\b[^>]*>",k="</"+p[m]+">";(g=a.helper.regexIndexOf(r,T))!==-1;){var $=a.helper.splitAtIndex(r,g),R=a.helper.replaceRecursiveRegExp($[1],y,M,k,"im");if(R===$[1])break;r=$[0].concat(R)}return r=r.replace(/(\n {0,3}(<(hr)\b([^<>])*?\/?>)[ \t]*(?=\n{2,}))/g,a.subParser("hashElement")(r,f,u)),r=a.helper.replaceRecursiveRegExp(r,function(b){return`

¨K`+(u.gHtmlBlocks.push(b)-1)+`K

`},"^ {0,3}<!--","-->","gm"),r=r.replace(/(?:\n\n)( {0,3}(?:<([?%])[^\r]*?\2>)[ \t]*(?=\n{2,}))/g,a.subParser("hashElement")(r,f,u)),r=u.converter._dispatch("hashHTMLBlocks.after",r,f,u),r}),a.subParser("hashHTMLSpans",function(r,f,u){r=u.converter._dispatch("hashHTMLSpans.before",r,f,u);function p(y){return"¨C"+(u.gHtmlSpans.push(y)-1)+"C"}return r=r.replace(/<[^>]+?\/>/gi,function(y){return p(y)}),r=r.replace(/<([^>]+?)>[\s\S]*?<\/\1>/g,function(y){return p(y)}),r=r.replace(/<([^>]+?)\s[^>]+?>[\s\S]*?<\/\1>/g,function(y){return p(y)}),r=r.replace(/<[^>]+?>/gi,function(y){return p(y)}),r=u.converter._dispatch("hashHTMLSpans.after",r,f,u),r}),a.subParser("unhashHTMLSpans",function(r,f,u){r=u.converter._dispatch("unhashHTMLSpans.before",r,f,u);for(var p=0;p<u.gHtmlSpans.length;++p){for(var y=u.gHtmlSpans[p],m=0;/¨C(\d+)C/.test(y);){var g=RegExp.$1;if(y=y.replace("¨C"+g+"C",u.gHtmlSpans[g]),m===10){console.error("maximum nesting of 10 spans reached!!!");break}++m}r=r.replace("¨C"+p+"C",y)}return r=u.converter._dispatch("unhashHTMLSpans.after",r,f,u),r}),a.subParser("hashPreCodeTags",function(r,f,u){r=u.converter._dispatch("hashPreCodeTags.before",r,f,u);var p=function(y,m,g,T){var M=g+a.subParser("encodeCode")(m,f,u)+T;return`

¨G`+(u.ghCodeBlocks.push({text:y,codeblock:M})-1)+`G

`};return r=a.helper.replaceRecursiveRegExp(r,p,"^ {0,3}<pre\\b[^>]*>\\s*<code\\b[^>]*>","^ {0,3}</code>\\s*</pre>","gim"),r=u.converter._dispatch("hashPreCodeTags.after",r,f,u),r}),a.subParser("headers",function(r,f,u){r=u.converter._dispatch("headers.before",r,f,u);var p=isNaN(parseInt(f.headerLevelStart))?1:parseInt(f.headerLevelStart),y=f.smoothLivePreview?/^(.+)[ \t]*\n={2,}[ \t]*\n+/gm:/^(.+)[ \t]*\n=+[ \t]*\n+/gm,m=f.smoothLivePreview?/^(.+)[ \t]*\n-{2,}[ \t]*\n+/gm:/^(.+)[ \t]*\n-+[ \t]*\n+/gm;r=r.replace(y,function(M,k){var $=a.subParser("spanGamut")(k,f,u),R=f.noHeaderId?"":' id="'+T(k)+'"',b=p,A="<h"+b+R+">"+$+"</h"+b+">";return a.subParser("hashBlock")(A,f,u)}),r=r.replace(m,function(M,k){var $=a.subParser("spanGamut")(k,f,u),R=f.noHeaderId?"":' id="'+T(k)+'"',b=p+1,A="<h"+b+R+">"+$+"</h"+b+">";return a.subParser("hashBlock")(A,f,u)});var g=f.requireSpaceBeforeHeadingText?/^(#{1,6})[ \t]+(.+?)[ \t]*#*\n+/gm:/^(#{1,6})[ \t]*(.+?)[ \t]*#*\n+/gm;r=r.replace(g,function(M,k,$){var R=$;f.customizedHeaderId&&(R=$.replace(/\s?\{([^{]+?)}\s*$/,""));var b=a.subParser("spanGamut")(R,f,u),A=f.noHeaderId?"":' id="'+T($)+'"',z=p-1+k.length,j="<h"+z+A+">"+b+"</h"+z+">";return a.subParser("hashBlock")(j,f,u)});function T(M){var k,$;if(f.customizedHeaderId){var R=M.match(/\{([^{]+?)}\s*$/);R&&R[1]&&(M=R[1])}return k=M,a.helper.isString(f.prefixHeaderId)?$=f.prefixHeaderId:f.prefixHeaderId===!0?$="section-":$="",f.rawPrefixHeaderId||(k=$+k),f.ghCompatibleHeaderId?k=k.replace(/ /g,"-").replace(/&amp;/g,"").replace(/¨T/g,"").replace(/¨D/g,"").replace(/[&+$,\/:;=?@"#{}|^¨~\[\]`\\*)(%.!'<>]/g,"").toLowerCase():f.rawHeaderId?k=k.replace(/ /g,"-").replace(/&amp;/g,"&").replace(/¨T/g,"¨").replace(/¨D/g,"$").replace(/["']/g,"-").toLowerCase():k=k.replace(/[^\w]/g,"").toLowerCase(),f.rawPrefixHeaderId&&(k=$+k),u.hashLinkCounts[k]?k=k+"-"+u.hashLinkCounts[k]++:u.hashLinkCounts[k]=1,k}return r=u.converter._dispatch("headers.after",r,f,u),r}),a.subParser("horizontalRule",function(r,f,u){r=u.converter._dispatch("horizontalRule.before",r,f,u);var p=a.subParser("hashBlock")("<hr />",f,u);return r=r.replace(/^ {0,2}( ?-){3,}[ \t]*$/gm,p),r=r.replace(/^ {0,2}( ?\*){3,}[ \t]*$/gm,p),r=r.replace(/^ {0,2}( ?_){3,}[ \t]*$/gm,p),r=u.converter._dispatch("horizontalRule.after",r,f,u),r}),a.subParser("images",function(r,f,u){r=u.converter._dispatch("images.before",r,f,u);var p=/!\[([^\]]*?)][ \t]*()\([ \t]?<?([\S]+?(?:\([\S]*?\)[\S]*?)?)>?(?: =([*\d]+[A-Za-z%]{0,4})x([*\d]+[A-Za-z%]{0,4}))?[ \t]*(?:(["'])([^"]*?)\6)?[ \t]?\)/g,y=/!\[([^\]]*?)][ \t]*()\([ \t]?<([^>]*)>(?: =([*\d]+[A-Za-z%]{0,4})x([*\d]+[A-Za-z%]{0,4}))?[ \t]*(?:(?:(["'])([^"]*?)\6))?[ \t]?\)/g,m=/!\[([^\]]*?)][ \t]*()\([ \t]?<?(data:.+?\/.+?;base64,[A-Za-z0-9+/=\n]+?)>?(?: =([*\d]+[A-Za-z%]{0,4})x([*\d]+[A-Za-z%]{0,4}))?[ \t]*(?:(["'])([^"]*?)\6)?[ \t]?\)/g,g=/!\[([^\]]*?)] ?(?:\n *)?\[([\s\S]*?)]()()()()()/g,T=/!\[([^\[\]]+)]()()()()()/g;function M($,R,b,A,z,j,Q,Y){return A=A.replace(/\s/g,""),k($,R,b,A,z,j,Q,Y)}function k($,R,b,A,z,j,Q,Y){var te=u.gUrls,oe=u.gTitles,se=u.gDimensions;if(b=b.toLowerCase(),Y||(Y=""),$.search(/\(<?\s*>? ?(['"].*['"])?\)$/m)>-1)A="";else if(A===""||A===null)if((b===""||b===null)&&(b=R.toLowerCase().replace(/ ?\n/g," ")),A="#"+b,!a.helper.isUndefined(te[b]))A=te[b],a.helper.isUndefined(oe[b])||(Y=oe[b]),a.helper.isUndefined(se[b])||(z=se[b].width,j=se[b].height);else return $;R=R.replace(/"/g,"&quot;").replace(a.helper.regexes.asteriskDashAndColon,a.helper.escapeCharactersCallback),A=A.replace(a.helper.regexes.asteriskDashAndColon,a.helper.escapeCharactersCallback);var ne='<img src="'+A+'" alt="'+R+'"';return Y&&a.helper.isString(Y)&&(Y=Y.replace(/"/g,"&quot;").replace(a.helper.regexes.asteriskDashAndColon,a.helper.escapeCharactersCallback),ne+=' title="'+Y+'"'),z&&j&&(z=z==="*"?"auto":z,j=j==="*"?"auto":j,ne+=' width="'+z+'"',ne+=' height="'+j+'"'),ne+=" />",ne}return r=r.replace(g,k),r=r.replace(m,M),r=r.replace(y,k),r=r.replace(p,k),r=r.replace(T,k),r=u.converter._dispatch("images.after",r,f,u),r}),a.subParser("italicsAndBold",function(r,f,u){r=u.converter._dispatch("italicsAndBold.before",r,f,u);function p(y,m,g){return m+y+g}return f.literalMidWordUnderscores?(r=r.replace(/\b___(\S[\s\S]*?)___\b/g,function(y,m){return p(m,"<strong><em>","</em></strong>")}),r=r.replace(/\b__(\S[\s\S]*?)__\b/g,function(y,m){return p(m,"<strong>","</strong>")}),r=r.replace(/\b_(\S[\s\S]*?)_\b/g,function(y,m){return p(m,"<em>","</em>")})):(r=r.replace(/___(\S[\s\S]*?)___/g,function(y,m){return/\S$/.test(m)?p(m,"<strong><em>","</em></strong>"):y}),r=r.replace(/__(\S[\s\S]*?)__/g,function(y,m){return/\S$/.test(m)?p(m,"<strong>","</strong>"):y}),r=r.replace(/_([^\s_][\s\S]*?)_/g,function(y,m){return/\S$/.test(m)?p(m,"<em>","</em>"):y})),f.literalMidWordAsterisks?(r=r.replace(/([^*]|^)\B\*\*\*(\S[\s\S]*?)\*\*\*\B(?!\*)/g,function(y,m,g){return p(g,m+"<strong><em>","</em></strong>")}),r=r.replace(/([^*]|^)\B\*\*(\S[\s\S]*?)\*\*\B(?!\*)/g,function(y,m,g){return p(g,m+"<strong>","</strong>")}),r=r.replace(/([^*]|^)\B\*(\S[\s\S]*?)\*\B(?!\*)/g,function(y,m,g){return p(g,m+"<em>","</em>")})):(r=r.replace(/\*\*\*(\S[\s\S]*?)\*\*\*/g,function(y,m){return/\S$/.test(m)?p(m,"<strong><em>","</em></strong>"):y}),r=r.replace(/\*\*(\S[\s\S]*?)\*\*/g,function(y,m){return/\S$/.test(m)?p(m,"<strong>","</strong>"):y}),r=r.replace(/\*([^\s*][\s\S]*?)\*/g,function(y,m){return/\S$/.test(m)?p(m,"<em>","</em>"):y})),r=u.converter._dispatch("italicsAndBold.after",r,f,u),r}),a.subParser("lists",function(r,f,u){function p(g,T){u.gListLevel++,g=g.replace(/\n{2,}$/,`
`),g+="¨0";var M=/(\n)?(^ {0,3})([*+-]|\d+[.])[ \t]+((\[(x|X| )?])?[ \t]*[^\r]+?(\n{1,2}))(?=\n*(¨0| {0,3}([*+-]|\d+[.])[ \t]+))/gm,k=/\n[ \t]*\n(?!¨0)/.test(g);return f.disableForced4SpacesIndentedSublists&&(M=/(\n)?(^ {0,3})([*+-]|\d+[.])[ \t]+((\[(x|X| )?])?[ \t]*[^\r]+?(\n{1,2}))(?=\n*(¨0|\2([*+-]|\d+[.])[ \t]+))/gm),g=g.replace(M,function($,R,b,A,z,j,Q){Q=Q&&Q.trim()!=="";var Y=a.subParser("outdent")(z,f,u),te="";return j&&f.tasklists&&(te=' class="task-list-item" style="list-style-type: none;"',Y=Y.replace(/^[ \t]*\[(x|X| )?]/m,function(){var oe='<input type="checkbox" disabled style="margin: 0px 0.35em 0.25em -1.6em; vertical-align: middle;"';return Q&&(oe+=" checked"),oe+=">",oe})),Y=Y.replace(/^([-*+]|\d\.)[ \t]+[\S\n ]*/g,function(oe){return"¨A"+oe}),R||Y.search(/\n{2,}/)>-1?(Y=a.subParser("githubCodeBlocks")(Y,f,u),Y=a.subParser("blockGamut")(Y,f,u)):(Y=a.subParser("lists")(Y,f,u),Y=Y.replace(/\n$/,""),Y=a.subParser("hashHTMLBlocks")(Y,f,u),Y=Y.replace(/\n\n+/g,`

`),k?Y=a.subParser("paragraphs")(Y,f,u):Y=a.subParser("spanGamut")(Y,f,u)),Y=Y.replace("¨A",""),Y="<li"+te+">"+Y+`</li>
`,Y}),g=g.replace(/¨0/g,""),u.gListLevel--,T&&(g=g.replace(/\s+$/,"")),g}function y(g,T){if(T==="ol"){var M=g.match(/^ *(\d+)\./);if(M&&M[1]!=="1")return' start="'+M[1]+'"'}return""}function m(g,T,M){var k=f.disableForced4SpacesIndentedSublists?/^ ?\d+\.[ \t]/gm:/^ {0,3}\d+\.[ \t]/gm,$=f.disableForced4SpacesIndentedSublists?/^ ?[*+-][ \t]/gm:/^ {0,3}[*+-][ \t]/gm,R=T==="ul"?k:$,b="";if(g.search(R)!==-1)(function z(j){var Q=j.search(R),Y=y(g,T);Q!==-1?(b+=`

<`+T+Y+`>
`+p(j.slice(0,Q),!!M)+"</"+T+`>
`,T=T==="ul"?"ol":"ul",R=T==="ul"?k:$,z(j.slice(Q))):b+=`

<`+T+Y+`>
`+p(j,!!M)+"</"+T+`>
`})(g);else{var A=y(g,T);b=`

<`+T+A+`>
`+p(g,!!M)+"</"+T+`>
`}return b}return r=u.converter._dispatch("lists.before",r,f,u),r+="¨0",u.gListLevel?r=r.replace(/^(( {0,3}([*+-]|\d+[.])[ \t]+)[^\r]+?(¨0|\n{2,}(?=\S)(?![ \t]*(?:[*+-]|\d+[.])[ \t]+)))/gm,function(g,T,M){var k=M.search(/[*+-]/g)>-1?"ul":"ol";return m(T,k,!0)}):r=r.replace(/(\n\n|^\n?)(( {0,3}([*+-]|\d+[.])[ \t]+)[^\r]+?(¨0|\n{2,}(?=\S)(?![ \t]*(?:[*+-]|\d+[.])[ \t]+)))/gm,function(g,T,M,k){var $=k.search(/[*+-]/g)>-1?"ul":"ol";return m(M,$,!1)}),r=r.replace(/¨0/,""),r=u.converter._dispatch("lists.after",r,f,u),r}),a.subParser("metadata",function(r,f,u){if(!f.metadata)return r;r=u.converter._dispatch("metadata.before",r,f,u);function p(y){u.metadata.raw=y,y=y.replace(/&/g,"&amp;").replace(/"/g,"&quot;"),y=y.replace(/\n {4}/g," "),y.replace(/^([\S ]+): +([\s\S]+?)$/gm,function(m,g,T){return u.metadata.parsed[g]=T,""})}return r=r.replace(/^\s*«««+(\S*?)\n([\s\S]+?)\n»»»+\n/,function(y,m,g){return p(g),"¨M"}),r=r.replace(/^\s*---+(\S*?)\n([\s\S]+?)\n---+\n/,function(y,m,g){return m&&(u.metadata.format=m),p(g),"¨M"}),r=r.replace(/¨M/g,""),r=u.converter._dispatch("metadata.after",r,f,u),r}),a.subParser("outdent",function(r,f,u){return r=u.converter._dispatch("outdent.before",r,f,u),r=r.replace(/^(\t|[ ]{1,4})/gm,"¨0"),r=r.replace(/¨0/g,""),r=u.converter._dispatch("outdent.after",r,f,u),r}),a.subParser("paragraphs",function(r,f,u){r=u.converter._dispatch("paragraphs.before",r,f,u),r=r.replace(/^\n+/g,""),r=r.replace(/\n+$/g,"");for(var p=r.split(/\n{2,}/g),y=[],m=p.length,g=0;g<m;g++){var T=p[g];T.search(/¨(K|G)(\d+)\1/g)>=0?y.push(T):T.search(/\S/)>=0&&(T=a.subParser("spanGamut")(T,f,u),T=T.replace(/^([ \t]*)/g,"<p>"),T+="</p>",y.push(T))}for(m=y.length,g=0;g<m;g++){for(var M="",k=y[g],$=!1;/¨(K|G)(\d+)\1/.test(k);){var R=RegExp.$1,b=RegExp.$2;R==="K"?M=u.gHtmlBlocks[b]:$?M=a.subParser("encodeCode")(u.ghCodeBlocks[b].text,f,u):M=u.ghCodeBlocks[b].codeblock,M=M.replace(/\$/g,"$$$$"),k=k.replace(/(\n\n)?¨(K|G)\d+\2(\n\n)?/,M),/^<pre\b[^>]*>\s*<code\b[^>]*>/.test(k)&&($=!0)}y[g]=k}return r=y.join(`
`),r=r.replace(/^\n+/g,""),r=r.replace(/\n+$/g,""),u.converter._dispatch("paragraphs.after",r,f,u)}),a.subParser("runExtension",function(r,f,u,p){if(r.filter)f=r.filter(f,p.converter,u);else if(r.regex){var y=r.regex;y instanceof RegExp||(y=new RegExp(y,"g")),f=f.replace(y,r.replace)}return f}),a.subParser("spanGamut",function(r,f,u){return r=u.converter._dispatch("spanGamut.before",r,f,u),r=a.subParser("codeSpans")(r,f,u),r=a.subParser("escapeSpecialCharsWithinTagAttributes")(r,f,u),r=a.subParser("encodeBackslashEscapes")(r,f,u),r=a.subParser("images")(r,f,u),r=a.subParser("anchors")(r,f,u),r=a.subParser("autoLinks")(r,f,u),r=a.subParser("simplifiedAutoLinks")(r,f,u),r=a.subParser("emoji")(r,f,u),r=a.subParser("underline")(r,f,u),r=a.subParser("italicsAndBold")(r,f,u),r=a.subParser("strikethrough")(r,f,u),r=a.subParser("ellipsis")(r,f,u),r=a.subParser("hashHTMLSpans")(r,f,u),r=a.subParser("encodeAmpsAndAngles")(r,f,u),f.simpleLineBreaks?/\n\n¨K/.test(r)||(r=r.replace(/\n+/g,`<br />
`)):r=r.replace(/  +\n/g,`<br />
`),r=u.converter._dispatch("spanGamut.after",r,f,u),r}),a.subParser("strikethrough",function(r,f,u){function p(y){return f.simplifiedAutoLink&&(y=a.subParser("simplifiedAutoLinks")(y,f,u)),"<del>"+y+"</del>"}return f.strikethrough&&(r=u.converter._dispatch("strikethrough.before",r,f,u),r=r.replace(/(?:~){2}([\s\S]+?)(?:~){2}/g,function(y,m){return p(m)}),r=u.converter._dispatch("strikethrough.after",r,f,u)),r}),a.subParser("stripLinkDefinitions",function(r,f,u){var p=/^ {0,3}\[([^\]]+)]:[ \t]*\n?[ \t]*<?([^>\s]+)>?(?: =([*\d]+[A-Za-z%]{0,4})x([*\d]+[A-Za-z%]{0,4}))?[ \t]*\n?[ \t]*(?:(\n*)["|'(](.+?)["|')][ \t]*)?(?:\n+|(?=¨0))/gm,y=/^ {0,3}\[([^\]]+)]:[ \t]*\n?[ \t]*<?(data:.+?\/.+?;base64,[A-Za-z0-9+/=\n]+?)>?(?: =([*\d]+[A-Za-z%]{0,4})x([*\d]+[A-Za-z%]{0,4}))?[ \t]*\n?[ \t]*(?:(\n*)["|'(](.+?)["|')][ \t]*)?(?:\n\n|(?=¨0)|(?=\n\[))/gm;r+="¨0";var m=function(g,T,M,k,$,R,b){return T=T.toLowerCase(),r.toLowerCase().split(T).length-1<2?g:(M.match(/^data:.+?\/.+?;base64,/)?u.gUrls[T]=M.replace(/\s/g,""):u.gUrls[T]=a.subParser("encodeAmpsAndAngles")(M,f,u),R?R+b:(b&&(u.gTitles[T]=b.replace(/"|'/g,"&quot;")),f.parseImgDimensions&&k&&$&&(u.gDimensions[T]={width:k,height:$}),""))};return r=r.replace(y,m),r=r.replace(p,m),r=r.replace(/¨0/,""),r}),a.subParser("tables",function(r,f,u){if(!f.tables)return r;var p=/^ {0,3}\|?.+\|.+\n {0,3}\|?[ \t]*:?[ \t]*(?:[-=]){2,}[ \t]*:?[ \t]*\|[ \t]*:?[ \t]*(?:[-=]){2,}[\s\S]+?(?:\n\n|¨0)/gm,y=/^ {0,3}\|.+\|[ \t]*\n {0,3}\|[ \t]*:?[ \t]*(?:[-=]){2,}[ \t]*:?[ \t]*\|[ \t]*\n( {0,3}\|.+\|[ \t]*\n)*(?:\n|¨0)/gm;function m($){return/^:[ \t]*--*$/.test($)?' style="text-align:left;"':/^--*[ \t]*:[ \t]*$/.test($)?' style="text-align:right;"':/^:[ \t]*--*[ \t]*:$/.test($)?' style="text-align:center;"':""}function g($,R){var b="";return $=$.trim(),(f.tablesHeaderId||f.tableHeaderId)&&(b=' id="'+$.replace(/ /g,"_").toLowerCase()+'"'),$=a.subParser("spanGamut")($,f,u),"<th"+b+R+">"+$+`</th>
`}function T($,R){var b=a.subParser("spanGamut")($,f,u);return"<td"+R+">"+b+`</td>
`}function M($,R){for(var b=`<table>
<thead>
<tr>
`,A=$.length,z=0;z<A;++z)b+=$[z];for(b+=`</tr>
</thead>
<tbody>
`,z=0;z<R.length;++z){b+=`<tr>
`;for(var j=0;j<A;++j)b+=R[z][j];b+=`</tr>
`}return b+=`</tbody>
</table>
`,b}function k($){var R,b=$.split(`
`);for(R=0;R<b.length;++R)/^ {0,3}\|/.test(b[R])&&(b[R]=b[R].replace(/^ {0,3}\|/,"")),/\|[ \t]*$/.test(b[R])&&(b[R]=b[R].replace(/\|[ \t]*$/,"")),b[R]=a.subParser("codeSpans")(b[R],f,u);var A=b[0].split("|").map(function(ne){return ne.trim()}),z=b[1].split("|").map(function(ne){return ne.trim()}),j=[],Q=[],Y=[],te=[];for(b.shift(),b.shift(),R=0;R<b.length;++R)b[R].trim()!==""&&j.push(b[R].split("|").map(function(ne){return ne.trim()}));if(A.length<z.length)return $;for(R=0;R<z.length;++R)Y.push(m(z[R]));for(R=0;R<A.length;++R)a.helper.isUndefined(Y[R])&&(Y[R]=""),Q.push(g(A[R],Y[R]));for(R=0;R<j.length;++R){for(var oe=[],se=0;se<Q.length;++se)a.helper.isUndefined(j[R][se]),oe.push(T(j[R][se],Y[se]));te.push(oe)}return M(Q,te)}return r=u.converter._dispatch("tables.before",r,f,u),r=r.replace(/\\(\|)/g,a.helper.escapeCharactersCallback),r=r.replace(p,k),r=r.replace(y,k),r=u.converter._dispatch("tables.after",r,f,u),r}),a.subParser("underline",function(r,f,u){return f.underline&&(r=u.converter._dispatch("underline.before",r,f,u),f.literalMidWordUnderscores?(r=r.replace(/\b___(\S[\s\S]*?)___\b/g,function(p,y){return"<u>"+y+"</u>"}),r=r.replace(/\b__(\S[\s\S]*?)__\b/g,function(p,y){return"<u>"+y+"</u>"})):(r=r.replace(/___(\S[\s\S]*?)___/g,function(p,y){return/\S$/.test(y)?"<u>"+y+"</u>":p}),r=r.replace(/__(\S[\s\S]*?)__/g,function(p,y){return/\S$/.test(y)?"<u>"+y+"</u>":p})),r=r.replace(/(_)/g,a.helper.escapeCharactersCallback),r=u.converter._dispatch("underline.after",r,f,u)),r}),a.subParser("unescapeSpecialChars",function(r,f,u){return r=u.converter._dispatch("unescapeSpecialChars.before",r,f,u),r=r.replace(/¨E(\d+)E/g,function(p,y){var m=parseInt(y);return String.fromCharCode(m)}),r=u.converter._dispatch("unescapeSpecialChars.after",r,f,u),r}),a.subParser("makeMarkdown.blockquote",function(r,f){var u="";if(r.hasChildNodes())for(var p=r.childNodes,y=p.length,m=0;m<y;++m){var g=a.subParser("makeMarkdown.node")(p[m],f);g!==""&&(u+=g)}return u=u.trim(),u="> "+u.split(`
`).join(`
> `),u}),a.subParser("makeMarkdown.codeBlock",function(r,f){var u=r.getAttribute("language"),p=r.getAttribute("precodenum");return"```"+u+`
`+f.preList[p]+"\n```"}),a.subParser("makeMarkdown.codeSpan",function(r){return"`"+r.innerHTML+"`"}),a.subParser("makeMarkdown.emphasis",function(r,f){var u="";if(r.hasChildNodes()){u+="*";for(var p=r.childNodes,y=p.length,m=0;m<y;++m)u+=a.subParser("makeMarkdown.node")(p[m],f);u+="*"}return u}),a.subParser("makeMarkdown.header",function(r,f,u){var p=new Array(u+1).join("#"),y="";if(r.hasChildNodes()){y=p+" ";for(var m=r.childNodes,g=m.length,T=0;T<g;++T)y+=a.subParser("makeMarkdown.node")(m[T],f)}return y}),a.subParser("makeMarkdown.hr",function(){return"---"}),a.subParser("makeMarkdown.image",function(r){var f="";return r.hasAttribute("src")&&(f+="!["+r.getAttribute("alt")+"](",f+="<"+r.getAttribute("src")+">",r.hasAttribute("width")&&r.hasAttribute("height")&&(f+=" ="+r.getAttribute("width")+"x"+r.getAttribute("height")),r.hasAttribute("title")&&(f+=' "'+r.getAttribute("title")+'"'),f+=")"),f}),a.subParser("makeMarkdown.links",function(r,f){var u="";if(r.hasChildNodes()&&r.hasAttribute("href")){var p=r.childNodes,y=p.length;u="[";for(var m=0;m<y;++m)u+=a.subParser("makeMarkdown.node")(p[m],f);u+="](",u+="<"+r.getAttribute("href")+">",r.hasAttribute("title")&&(u+=' "'+r.getAttribute("title")+'"'),u+=")"}return u}),a.subParser("makeMarkdown.list",function(r,f,u){var p="";if(!r.hasChildNodes())return"";for(var y=r.childNodes,m=y.length,g=r.getAttribute("start")||1,T=0;T<m;++T)if(!(typeof y[T].tagName>"u"||y[T].tagName.toLowerCase()!=="li")){var M="";u==="ol"?M=g.toString()+". ":M="- ",p+=M+a.subParser("makeMarkdown.listItem")(y[T],f),++g}return p+=`
<!-- -->
`,p.trim()}),a.subParser("makeMarkdown.listItem",function(r,f){for(var u="",p=r.childNodes,y=p.length,m=0;m<y;++m)u+=a.subParser("makeMarkdown.node")(p[m],f);return/\n$/.test(u)?u=u.split(`
`).join(`
    `).replace(/^ {4}$/gm,"").replace(/\n\n+/g,`

`):u+=`
`,u}),a.subParser("makeMarkdown.node",function(r,f,u){u=u||!1;var p="";if(r.nodeType===3)return a.subParser("makeMarkdown.txt")(r,f);if(r.nodeType===8)return"<!--"+r.data+`-->

`;if(r.nodeType!==1)return"";var y=r.tagName.toLowerCase();switch(y){case"h1":u||(p=a.subParser("makeMarkdown.header")(r,f,1)+`

`);break;case"h2":u||(p=a.subParser("makeMarkdown.header")(r,f,2)+`

`);break;case"h3":u||(p=a.subParser("makeMarkdown.header")(r,f,3)+`

`);break;case"h4":u||(p=a.subParser("makeMarkdown.header")(r,f,4)+`

`);break;case"h5":u||(p=a.subParser("makeMarkdown.header")(r,f,5)+`

`);break;case"h6":u||(p=a.subParser("makeMarkdown.header")(r,f,6)+`

`);break;case"p":u||(p=a.subParser("makeMarkdown.paragraph")(r,f)+`

`);break;case"blockquote":u||(p=a.subParser("makeMarkdown.blockquote")(r,f)+`

`);break;case"hr":u||(p=a.subParser("makeMarkdown.hr")(r,f)+`

`);break;case"ol":u||(p=a.subParser("makeMarkdown.list")(r,f,"ol")+`

`);break;case"ul":u||(p=a.subParser("makeMarkdown.list")(r,f,"ul")+`

`);break;case"precode":u||(p=a.subParser("makeMarkdown.codeBlock")(r,f)+`

`);break;case"pre":u||(p=a.subParser("makeMarkdown.pre")(r,f)+`

`);break;case"table":u||(p=a.subParser("makeMarkdown.table")(r,f)+`

`);break;case"code":p=a.subParser("makeMarkdown.codeSpan")(r,f);break;case"em":case"i":p=a.subParser("makeMarkdown.emphasis")(r,f);break;case"strong":case"b":p=a.subParser("makeMarkdown.strong")(r,f);break;case"del":p=a.subParser("makeMarkdown.strikethrough")(r,f);break;case"a":p=a.subParser("makeMarkdown.links")(r,f);break;case"img":p=a.subParser("makeMarkdown.image")(r,f);break;default:p=r.outerHTML+`

`}return p}),a.subParser("makeMarkdown.paragraph",function(r,f){var u="";if(r.hasChildNodes())for(var p=r.childNodes,y=p.length,m=0;m<y;++m)u+=a.subParser("makeMarkdown.node")(p[m],f);return u=u.trim(),u}),a.subParser("makeMarkdown.pre",function(r,f){var u=r.getAttribute("prenum");return"<pre>"+f.preList[u]+"</pre>"}),a.subParser("makeMarkdown.strikethrough",function(r,f){var u="";if(r.hasChildNodes()){u+="~~";for(var p=r.childNodes,y=p.length,m=0;m<y;++m)u+=a.subParser("makeMarkdown.node")(p[m],f);u+="~~"}return u}),a.subParser("makeMarkdown.strong",function(r,f){var u="";if(r.hasChildNodes()){u+="**";for(var p=r.childNodes,y=p.length,m=0;m<y;++m)u+=a.subParser("makeMarkdown.node")(p[m],f);u+="**"}return u}),a.subParser("makeMarkdown.table",function(r,f){var u="",p=[[],[]],y=r.querySelectorAll("thead>tr>th"),m=r.querySelectorAll("tbody>tr"),g,T;for(g=0;g<y.length;++g){var M=a.subParser("makeMarkdown.tableCell")(y[g],f),k="---";if(y[g].hasAttribute("style")){var $=y[g].getAttribute("style").toLowerCase().replace(/\s/g,"");switch($){case"text-align:left;":k=":---";break;case"text-align:right;":k="---:";break;case"text-align:center;":k=":---:";break}}p[0][g]=M.trim(),p[1][g]=k}for(g=0;g<m.length;++g){var R=p.push([])-1,b=m[g].getElementsByTagName("td");for(T=0;T<y.length;++T){var A=" ";typeof b[T]<"u"&&(A=a.subParser("makeMarkdown.tableCell")(b[T],f)),p[R].push(A)}}var z=3;for(g=0;g<p.length;++g)for(T=0;T<p[g].length;++T){var j=p[g][T].length;j>z&&(z=j)}for(g=0;g<p.length;++g){for(T=0;T<p[g].length;++T)g===1?p[g][T].slice(-1)===":"?p[g][T]=a.helper.padEnd(p[g][T].slice(-1),z-1,"-")+":":p[g][T]=a.helper.padEnd(p[g][T],z,"-"):p[g][T]=a.helper.padEnd(p[g][T],z);u+="| "+p[g].join(" | ")+` |
`}return u.trim()}),a.subParser("makeMarkdown.tableCell",function(r,f){var u="";if(!r.hasChildNodes())return"";for(var p=r.childNodes,y=p.length,m=0;m<y;++m)u+=a.subParser("makeMarkdown.node")(p[m],f,!0);return u.trim()}),a.subParser("makeMarkdown.txt",function(r){var f=r.nodeValue;return f=f.replace(/ +/g," "),f=f.replace(/¨NBSP;/g," "),f=a.helper.unescapeHTMLEntities(f),f=f.replace(/([*_~|`])/g,"\\$1"),f=f.replace(/^(\s*)>/g,"\\$1>"),f=f.replace(/^#/gm,"\\#"),f=f.replace(/^(\s*)([-=]{3,})(\s*)$/,"$1\\$2$3"),f=f.replace(/^( {0,3}\d+)\./gm,"$1\\."),f=f.replace(/^( {0,3})([+-])/gm,"$1\\$2"),f=f.replace(/]([\s]*)\(/g,"\\]$1\\("),f=f.replace(/^ {0,3}\[([\S \t]*?)]:/gm,"\\[$1]:"),f});var G=this;n.exports?n.exports=a:G.showdown=a}).call(fr)})(ci);var hr=ci.exports;function mr(n){return n.type==="CURVE"}function gr(n){return n.type==="IMAGE"}function pa(n,e){return Math.round(n/e)*e}function ha(n,e){return Math.floor(n/e)*e}function jn(n){return n*(Math.PI/180)}function vr(n){return n*(180/Math.PI)}function ma(n,e,t){return n*(1-t)+e*t}class at{static magnitudeSquared(e){return e.x*e.x+e.y*e.y}static magnitude(e){const t=Math.sqrt(this.magnitudeSquared(e));return isNaN(t)?0:t}static normalize(e){const t=this.magnitude(e);return t===0?{x:0,y:0}:this.divide(e,t)}static dot(e,t){return e.x*t.x+e.y*t.y}static subtract(e,t){return typeof t=="number"?{x:e.x-t,y:e.y-t}:{x:e.x-t.x,y:e.y-t.y}}static add(e,t){return typeof t=="number"?{x:e.x+t,y:e.y+t}:{x:e.x+t.x,y:e.y+t.y}}static multiply(e,t){return typeof t=="number"?{x:e.x*t,y:e.y*t}:{x:e.x*t.x,y:e.y*t.y}}static divide(e,t){return typeof t=="number"?{x:e.x/t,y:e.y/t}:{x:e.x/t.x,y:e.y/t.y}}static rotate(e,t,a){const i=Math.cos(jn(a)),d=Math.sin(jn(a)),s=this.subtract(e,t);return{x:t.x+i*s.x-d*s.y,y:t.y+d*s.x+i*s.y}}static min(e,t){return typeof t=="number"?{x:Math.min(e.x,t),y:Math.min(e.y,t)}:{x:Math.min(e.x,t.x),y:Math.min(e.y,t.y)}}static componentMin(e){return e.x<e.y?e.x:e.y}static max(e,t){return typeof t=="number"?{x:Math.max(e.x,t),y:Math.max(e.y,t)}:{x:Math.max(e.x,t.x),y:Math.max(e.y,t.y)}}static componentMax(e){return e.x>e.y?e.x:e.y}static roundTo(e,t){return{x:pa(e.x,t.x),y:pa(e.y,t.y)}}static floorTo(e,t){return{x:ha(e.x,t.x),y:ha(e.y,t.y)}}static sign(e){return{x:Math.sign(e.x),y:Math.sign(e.y)}}static abs(e){return{x:Math.abs(e.x),y:Math.abs(e.y)}}static pow(e,t){return typeof t=="number"?{x:Math.pow(e.x,t),y:Math.pow(e.y,t)}:{x:Math.pow(e.x,t.x),y:Math.pow(e.y,t.y)}}static clamp(e,t,a){return{x:Math.min(Math.max(e.x,t),a),y:Math.min(Math.max(e.y,t),a)}}static boundingBox(e){let t=Number.MAX_SAFE_INTEGER,a=Number.MIN_SAFE_INTEGER,i=Number.MAX_SAFE_INTEGER,d=Number.MIN_SAFE_INTEGER;for(let h of e)t=h.x<t?h.x:t,a=h.x>a?h.x:a,i=h.y<i?h.y:i,d=h.y>d?h.y:d;let s=a-t,l=d-i,c={x:(t+a)/2,y:(i+d)/2};return{min:{x:t,y:i},max:{x:a,y:d},width:s,height:l,center:c}}static pointInPolygon(e,t){const a=this.boundingBox(t);if(e.x<a.min.x||e.x>a.max.x||e.y<a.min.y||e.y>a.max.y)return!1;let i=!1;for(let d=0,s=t.length-1;d<t.length;s=d++){const l=t[d].y>e.y,c=t[s].y>e.y;l!==c&&e.x<(t[s].x-t[d].x)*(e.y-t[d].y)/(t[s].y-t[d].y)+t[d].x&&(i=!i)}return i}static compare(e,t,a){return this.magnitudeSquared(this.subtract(e,t))<a*a}static distance(e,t){return this.magnitude(this.subtract(e,t))}static lerp(e,t,a){return{x:ma(e.x,t.x,a),y:ma(e.y,t.y,a)}}static centroid(e){let t={x:0,y:0};for(let a of e)t.x+=a.x,t.y+=a.y;return e.length>0&&(t={x:t.x/e.length,y:t.y/e.length}),t}}class Ue{static inverse(e){const[t,a,i,d,s,l,c,h,v]=e,I=t*(s*v-h*l)-a*(d*v-l*c)+i*(d*h-s*c);if(Math.abs(I)<1e-14)return e;const S=1/I,_=(s*v-h*l)*S,O=(i*h-a*v)*S,X=(a*l-i*s)*S,F=(l*c-d*v)*S,x=(t*v-i*c)*S,C=(d*i-t*l)*S,G=(d*h-c*s)*S,r=(c*a-t*h)*S,f=(t*s-d*a)*S;return[_,O,X,F,x,C,G,r,f]}static multiply(e,t){return[e[0]*t[0]+e[1]*t[3]+e[2]*t[6],e[0]*t[1]+e[1]*t[4]+e[2]*t[7],e[0]*t[2]+e[1]*t[5]+e[2]*t[8],e[3]*t[0]+e[4]*t[3]+e[5]*t[6],e[3]*t[1]+e[4]*t[4]+e[5]*t[7],e[3]*t[2]+e[4]*t[5]+e[5]*t[8],e[6]*t[0]+e[7]*t[3]+e[8]*t[6],e[6]*t[1]+e[7]*t[4]+e[8]*t[7],e[6]*t[2]+e[7]*t[5]+e[8]*t[8]]}static fromPosition(e){return[1,0,e.x,0,1,e.y,0,0,1]}static fromRotation(e){const t=jn(e);return[Math.cos(t),-Math.sin(t),0,Math.sin(t),Math.cos(t),0,0,0,1]}static fromScale(e){return[e.x,0,0,0,e.y,0,0,0,1]}static fromItem(e){const t=Ue.fromPosition(e.position),a=Ue.fromScale(e.scale),i=Ue.fromRotation(e.rotation);return Ue.multiply(Ue.multiply(t,i),a)}static decompose(e){const[t,a,i,d,s,l]=e,c=t*s-d*a,h={position:{x:i,y:l},rotation:0,scale:{x:1,y:1}};if(t!=0||d!=0){var v=Math.sqrt(t*t+d*d);h.rotation=d>0?Math.acos(t/v):-Math.acos(t/v),h.scale={x:v,y:c/v}}else if(a!=0||s!=0){var I=Math.sqrt(a*a+s*s);h.rotation=Math.PI/2-(s>0?Math.acos(-a/I):-Math.acos(a/I)),h.scale={x:c/I,y:I}}return h.rotation=vr(h.rotation),h}}var ui={exports:{}};(function(n){(function(){function e(l,c){var h=l.x-c.x,v=l.y-c.y;return h*h+v*v}function t(l,c,h){var v=c.x,I=c.y,S=h.x-v,_=h.y-I;if(S!==0||_!==0){var O=((l.x-v)*S+(l.y-I)*_)/(S*S+_*_);O>1?(v=h.x,I=h.y):O>0&&(v+=S*O,I+=_*O)}return S=l.x-v,_=l.y-I,S*S+_*_}function a(l,c){for(var h=l[0],v=[h],I,S=1,_=l.length;S<_;S++)I=l[S],e(I,h)>c&&(v.push(I),h=I);return h!==I&&v.push(I),v}function i(l,c,h,v,I){for(var S=v,_,O=c+1;O<h;O++){var X=t(l[O],l[c],l[h]);X>S&&(_=O,S=X)}S>v&&(_-c>1&&i(l,c,_,v,I),I.push(l[_]),h-_>1&&i(l,_,h,v,I))}function d(l,c){var h=l.length-1,v=[l[0]];return i(l,0,h,c,v),v.push(l[h]),v}function s(l,c,h){if(l.length<=2)return l;var v=c!==void 0?c*c:1;return l=h?l:a(l,v),l=d(l,v),l}n.exports=s,n.exports.default=s})()})(ui);var yr=ui.exports;const fi=pr(yr);function _n(){return`${o.EXTENSIONID}/Persistence/${E.playerId}/${E.sceneId}`}function Er(){const n=document.createElement("img");return n.id="PatreonButton",n.setAttribute("class","icon"),n.classList.add("patreon-clickable"),n.setAttribute("title",E.USER_REGISTERED?"Thanks for subscribing!":"Get the news on updates on the Battle-System Patreon"),n.setAttribute("src",E.USER_REGISTERED?"/w-thankyou.svg":"/w-patreon-2.png"),n.onclick=async function(e){e.preventDefault(),window.open("https://www.patreon.com/battlesystem","_blank")},n}function On(n,e,t={curveSegments:10}){const a=[],{curveSegments:i}=t,d=n.length*i;a.length=d;let s=0;function l(c,h){s<d?(a[s]={x:c+e.x,y:h+e.y},s++):a.push({x:c+e.x,y:h+e.y})}for(const c of n){if(c.length<1)throw new Error("Invalid command array: empty array");const h=c[0],v={[me.MOVE]:3,[me.LINE]:3,[me.QUAD]:5,[me.CONIC]:6,[me.CUBIC]:7,[me.CLOSE]:1}[h];if(v===void 0)throw new Error(`Unknown command type: ${h}`);if(c.length!==v)throw new Error(`Invalid command length for type ${h}: expected ${v}, got ${c.length}`);switch(h){case me.MOVE:{const[I,S,_]=c;l(S,_);break}case me.LINE:{const[I,S,_]=c;l(S,_);break}case me.QUAD:{const[I,S,_,O,X]=c,F=a[s-1];if(!F)throw new Error("No starting point for QUAD command");const x={x:F.x-e.x,y:F.y-e.y},C={x:S,y:_},G={x:O,y:X};for(let r=1;r<=i;r++){const f=r/i,u=Ir(f,x,C,G);l(u.x,u.y)}break}case me.CONIC:{const[I,S,_,O,X,F]=c,x=a[s-1];if(!x)throw new Error("No starting point for CONIC command");const C={x:x.x-e.x,y:x.y-e.y},G={x:S,y:_},r={x:O,y:X};for(let f=1;f<=i;f++){const u=f/i,p=wr(u,C,G,r,F);l(p.x,p.y)}break}case me.CUBIC:{const[I,S,_,O,X,F,x]=c,C=a[s-1];if(!C)throw new Error("No starting point for CUBIC command");const G={x:C.x-e.x,y:C.y-e.y},r={x:S,y:_},f={x:O,y:X},u={x:F,y:x};for(let p=1;p<=i;p++){const y=p/i,m=br(y,G,r,f,u);l(m.x,m.y)}break}case me.CLOSE:{if(s>0){const I=a[0];l(I.x-e.x,I.y-e.y)}break}}}return a.length=s,fi(a)}const Ir=(n,e,t,a)=>{const i=1-n,d=n*n,s=i*i;return{x:s*e.x+2*i*n*t.x+d*a.x,y:s*e.y+2*i*n*t.y+d*a.y}},wr=(n,e,t,a,i)=>{const d=1-n,s=d*d+2*d*n*i+n*n;return{x:(d*d*e.x+2*d*n*i*t.x+n*n*a.x)/s,y:(d*d*e.y+2*d*n*i*t.y+n*n*a.y)/s}},br=(n,e,t,a,i)=>{const d=1-n,s=n*n,l=d*d,c=l*d,h=s*n;return{x:c*e.x+3*l*n*t.x+3*d*s*a.x+h*i.x,y:c*e.y+3*l*n*t.y+3*d*s*a.y+h*i.y}};function fn(n,e){const t=n.x-e.x,a=n.y-e.y;return Math.sqrt(t*t+a*a)}function ga(n,e){let t=!1;const a=e.length;let i=e[0];for(let d=1;d<=a;d++){const s=e[d%a];if(n.y>Math.min(i.y,s.y)&&n.y<=Math.max(i.y,s.y)&&n.x<=Math.max(i.x,s.x)&&i.y!=s.y){const l=(n.y-i.y)*(s.x-i.x)/(s.y-i.y)+i.x;(i.x==s.x||n.x<=l)&&(t=!t)}i=s}return t}function Tr(n,e){const t=n.points,a=e.points;if(t.length!==a.length)return!1;for(let i=0;i<t.length;i++)if(t[i].x!==a[i].x||t[i].y!==a[i].y)return!1;return!0}function Dn(n){n=n.replace(/^#/,"");let e=parseInt(n,16),t=e>>16&255,a=e>>8&255,i=e&255;return{x:t/255,y:a/255,z:i/255}}function Nr(n,e=!1){if(n.indexOf("#")===0&&(n=n.slice(1)),n.length===3&&(n=n[0]+n[0]+n[1]+n[1]+n[2]+n[2]),n.length!==6)throw new Error("Invalid HEX color.");var t=parseInt(n.slice(0,2),16),a=parseInt(n.slice(2,4),16),i=parseInt(n.slice(4,6),16);return e?t*.299+a*.587+i*.114>186?"#000000":"#FFFFFF":(t=(255-t).toString(16),a=(255-a).toString(16),i=(255-i).toString(16),"#"+kn(t)+kn(a)+kn(i))}function kn(n,e=0){e=e||2;var t=new Array(e).join("0");return(t+n).slice(-e)}function va(n,e){const t=window.matchMedia("(prefers-color-scheme: dark)"),a=t.matches?"dark":"light",i=t.matches?"light":"dark";for(var d=0;d<e.styleSheets.length;d++)for(var s=0;s<e.styleSheets[d].cssRules.length;s++){let l=e.styleSheets[d].cssRules[s];l&&l.media&&l.media.mediaText.includes("prefers-color-scheme")&&(n.mode=="LIGHT"?(l.media.appendMedium(`(prefers-color-scheme: ${a})`),l.media.mediaText.includes(i)&&l.media.deleteMedium(`(prefers-color-scheme: ${i})`)):n.mode=="DARK"&&(l.media.appendMedium(`(prefers-color-scheme: ${i})`),l.media.mediaText.includes(a)&&l.media.deleteMedium(`(prefers-color-scheme: ${a})`)))}}function we(){const n=E.sceneMetadata[`${o.EXTENSIONID}/toolWidth`],e=n!==void 0?parseInt(n):NaN;return Number.isNaN(e)?o.DEFAULTLINEWIDTH:e}function Ae(){const n=E.sceneMetadata[`${o.EXTENSIONID}/visionRangeDefault`];return n||o.ATTENUATIONDEFAULT}function Ve(){const n=E.sceneMetadata[`${o.EXTENSIONID}/visionSourceDefault`];return n||o.SOURCEDEFAULT}function Ze(){const n=E.sceneMetadata[`${o.EXTENSIONID}/visionFallOffDefault`];return n||o.FALLOFFDEFAULT}function pn(){const n=E.sceneMetadata[`${o.EXTENSIONID}/visionDarkDefault`];return n||o.DARKVISIONDEFAULT}function rt(){const n=E.sceneMetadata[`${o.EXTENSIONID}/visionInAngleDefault`];return n||o.INANGLEDEFAULT}function We(){const n=E.sceneMetadata[`${o.EXTENSIONID}/visionOutAngleDefault`];return n||o.OUTANGLEDEFAULT}function Sr(n,e,t,a,i){const d=[[],[]];let s={x:0,y:0},l={x:0,y:0},c=-1,h=-1,v=1/0,I=1/0;const S=Ia(n,a,i);for(let x=0;x<S.length-1;x++){const C=S[x],G=S[x+1],r=ya(C,G,e),f=ya(C,G,t),u=fn(e,r),p=fn(t,f);u<v&&(c=x,s=r,v=u),p<I&&(h=x,l=f,I=p)}(c>h||c===h&&Ea(s,S[c],S[c+1])>Ea(l,S[h],S[h+1]))&&([c,h]=[h,c],[s,l]=[l,s]);let O=[...S];c<=h?(O.splice(c+1,0,s),O.splice(h+2,0,l),d[0]=Rt(O,0,c+1),d[1]=Rt(O,h+2,O.length)):(O.splice(h+1,0,l),O.splice(c+2,0,s),d[0]=Rt(O,0,h+1),d[1]=Rt(O,c+2,O.length));const X=Rt(O,c+1,h+2),F=d.map(x=>Ia(x,-a,i));return{extracted:X,remaining:F}}function Rt(n,e,t){return n.slice(e,t+1)}function ya(n,e,t){const a={x:e.x-n.x,y:e.y-n.y},i={x:t.x-n.x,y:t.y-n.y},d=i.x*a.x+i.y*a.y,s=a.x*a.x+a.y*a.y,l=d/s,c=Math.max(0,Math.min(1,l));return{x:n.x+c*a.x,y:n.y+c*a.y}}function Ea(n,e,t){const a={x:n.x-e.x,y:n.y-e.y},i={x:t.x-e.x,y:t.y-e.y};return(a.x*i.x+a.y*i.y)/(i.x*i.x+i.y*i.y)}function _r(n,e,t){const a=e*(Math.PI/180),i=Math.cos(a),d=Math.sin(a),s=n.x-t.x,l=n.y-t.y;return{x:i*s-d*l+t.x,y:d*s+i*l+t.y}}function Ia(n,e,t){return n.map(a=>_r(a,e,t))}function Mt(n){if(n.ctrlKey)return n.pointerPosition;const e=Math.round(E.gridDpi/E.gridSnap),t=Math.round(n.pointerPosition.x/E.gridDpi)*E.gridDpi,a=Math.round(n.pointerPosition.y/E.gridDpi)*E.gridDpi,i=Math.abs(t-n.pointerPosition.x),d=Math.abs(a-n.pointerPosition.y);let s,l;return i<=e?s=t:s=n.pointerPosition.x,d<=e?l=a:l=n.pointerPosition.y,{x:s,y:l}}const Or=100;let Ht=0,Se=null;async function pi(){Ht=0,await w.popover.close(o.LINETOOLID)}async function Un(){if(!Se)return;const[n,e]=Se;e(),Se=null,await pi()}async function hn(){if(!Se)return;const[n,e]=Se,t=n(a=>{a.visible=!1,a.layer=o.LINELAYER,a.metadata[`${o.EXTENSIONID}/isVisionLine`]=!0,a.metadata[`${o.EXTENSIONID}/blocking`]=!0,a.metadata[`${o.EXTENSIONID}/doubleSided`]=!0,a.points.pop()});t.points.length>=2&&await w.scene.items.addItems([t]),e(),Se=null,await pi()}async function hi(){if(!Se)return;const[n]=Se;n(e=>{e.points.length>2&&(e.points.pop(),Ht--)})}async function mi(n,e){if(!e.transformer)if(Se){if(Ht>=Or){await w.notification.show("Maximum line length reached.","ERROR");return}const[t]=Se;t(a=>{a.points.push(e.pointerPosition),Ht++})}else{const t=Mt(e),a=E.snap?t:e.pointerPosition,i=Ne().tension(0).points([a,a]).strokeColor(E.sceneMetadata[`${o.EXTENSIONID}/toolColor`]??o.DEFAULTLINECOLOR).strokeDash(E.sceneMetadata[`${o.EXTENSIONID}/toolStyle`]??o.DEFAULTLINESTROKE).strokeWidth(we()).fillOpacity(0).fillColor("#000000").layer(o.LINELAYER).name("Vision Line (Line)").closed(!1).locked(!0).build();Se=await w.interaction.startItemInteraction(i),Ht=i.points.length;const d=await w.viewport.getWidth();await w.popover.open({id:o.LINETOOLID,url:"/pages/line.html",height:75,width:350,disableClickAway:!0,hidePaper:!0,anchorPosition:{top:50,left:d/2},anchorReference:"POSITION",anchorOrigin:{vertical:"CENTER",horizontal:"CENTER"},transformOrigin:{vertical:"TOP",horizontal:"CENTER"}})}}function Dr(n,e){if(!Se||e.transformer)return;const[t]=Se,a=Mt(e);t(i=>{i.points[i.points.length-1]=E.snap?a:e.pointerPosition})}async function kr(n,e){await mi(n,e),await hn()}function Cr(n,e){Se&&(e.key=="Escape"?Un():e.key=="Enter"?hn():e.key==="z"&&hi())}const Jt={onToolClick:mi,onToolDouble:kr,onToolMove:Dr,onKeyDown:Cr},Lr=100;let Ft=0,_e=null;async function gi(){Ft=0,await w.popover.close(o.POLYTOOLID)}async function Gn(){if(!_e)return;const[n,e]=_e;e(),_e=null,gi(),await w.player.setMetadata({[`${o.EXTENSIONID}/cancelPoly`]:!1})}async function mn(){if(!_e)return;const[n,e]=_e,t=n(a=>{a.visible=!1,a.layer=o.LINELAYER,a.style.fillOpacity=0,a.metadata[`${o.EXTENSIONID}/isVisionLine`]=!0,a.metadata[`${o.EXTENSIONID}/blocking`]=!0,a.metadata[`${o.EXTENSIONID}/doubleSided`]=!0,a.points.pop(),a.points.push(a.points[0])});t.points.length>=4&&await w.scene.items.addItems([t]),e(),_e=null,gi(),await w.player.setMetadata({[`${o.EXTENSIONID}/finishPoly`]:!1})}async function vi(){if(!_e)return;const[n]=_e;n(e=>{e.points.length>2&&(e.points.pop(),Ft--)})}async function yi(n,e){if(!e.transformer)if(_e){if(Ft>=Lr){await w.notification.show("Maximum line length reached.","ERROR");return}const[t]=_e;t(a=>{a.points.push(e.pointerPosition),Ft++})}else{const t=Mt(e),a=E.snap?t:e.pointerPosition,i=Ne().tension(0).points([a,a]).strokeColor(E.sceneMetadata[`${o.EXTENSIONID}/toolColor`]??o.DEFAULTLINECOLOR).strokeDash(E.sceneMetadata[`${o.EXTENSIONID}/toolStyle`]??o.DEFAULTLINESTROKE).strokeWidth(we()).fillOpacity(.5).fillColor("#000000").layer(o.LINELAYER).name("Vision Line (Polygon)").locked(!0).build();_e=await w.interaction.startItemInteraction(i),Ft=i.points.length;const d=await w.viewport.getWidth();await w.popover.open({id:o.POLYTOOLID,url:"/pages/polygon.html",height:75,width:400,disableClickAway:!0,hidePaper:!0,anchorPosition:{top:50,left:d/2},anchorReference:"POSITION",anchorOrigin:{vertical:"CENTER",horizontal:"CENTER"},transformOrigin:{vertical:"TOP",horizontal:"CENTER"}})}}function Ar(n,e){if(!_e||e.transformer)return;const[t]=_e,a=Mt(e);t(i=>{i.points[i.points.length-1]=E.snap?a:e.pointerPosition})}async function $r(n,e){await yi(n,e),await mn()}function Mr(n,e){_e&&(e.key=="Escape"?Gn():e.key=="Enter"?mn():e.key==="z"&&vi())}const en={onToolClick:yi,onToolDouble:$r,onToolMove:Ar,onKeyDown:Mr};let Oe=null;const Ei=[];async function Ii(){await w.popover.close(o.ELEVATIONTOOLID)}async function ta(){if(!Oe)return;const[n,e]=Oe;e(),Oe=null,Ii()}async function wi(){if(!Oe)return;const[n,e]=Oe,t=n(a=>{a.visible=!1,a.points.pop(),a.points.push(a.points[0])});if(t.points.length>=4){await w.scene.local.addItems([t]);let a=E.sceneMetadata[`${o.EXTENSIONID}/elevationMapping`];a||(a=[]);const i=t.metadata[`${o.EXTENSIONID}/elevation`]??0,d={Points:t.points,Depth:i};a.push(d),await w.scene.setMetadata({[`${o.EXTENSIONID}/elevationMapping`]:a})}e(),Oe=null,Ii()}async function bi(){if(!Oe)return;const[n]=Oe;n(e=>{e.points.length>2&&e.points.pop()})}async function Pr(n,e,t){if(!e.transformer)if(Oe){const[a]=Oe;a(i=>{i.points.push(e.pointerPosition)})}else{const a=Mt(e),i=E.snap?a:e.pointerPosition,d=Ne().tension(0).points([i,i]).strokeColor(Ti(t)).strokeDash(E.sceneMetadata[`${o.EXTENSIONID}/toolStyle`]??Ei).strokeWidth(we()).fillOpacity(.5).fillColor(Ni(t)).layer(o.LINELAYER).metadata({[`${o.EXTENSIONID}/elevation`]:t}).name(`Elevation-${t} Area`).zIndex(t).locked(!0).build();Oe=await w.interaction.startItemInteraction(d);const s=await w.viewport.getWidth();await w.popover.open({id:o.ELEVATIONTOOLID,url:"/pages/elevation.html",height:75,width:400,disableClickAway:!0,hidePaper:!0,anchorPosition:{top:60,left:s/2},anchorReference:"POSITION",anchorOrigin:{vertical:"CENTER",horizontal:"CENTER"},transformOrigin:{vertical:"TOP",horizontal:"CENTER"}})}}function xr(n,e){if(!Oe||e.transformer)return;const[t]=Oe,a=Mt(e);t(i=>{i.points[i.points.length-1]=E.snap?a:e.pointerPosition})}function Rr(n,e,t){Oe&&(e.key=="Escape"?ta():e.key=="Enter"?wi():e.key==="z"&&bi())}async function Xr(n){const e=n.metadata[`${o.EXTENSIONID}/elevationEditor`]??!1;if(await w.tool.setMetadata(`${o.EXTENSIONID}/vision-tool`,{[`${o.EXTENSIONID}/elevationEditor`]:!e}),e)await w.popover.close(o.ELEVATIONWARNID),await Hr();else{const t=await w.viewport.getWidth();await w.popover.open({id:o.ELEVATIONWARNID,url:"/pages/ewarning.html",height:45,width:430,disableClickAway:!0,anchorPosition:{top:120,left:t/2},anchorReference:"POSITION",anchorOrigin:{vertical:"CENTER",horizontal:"CENTER"},transformOrigin:{vertical:"TOP",horizontal:"CENTER"}}),await Vr()}}async function Vr(n){const t=(await w.scene.getMetadata())[`${o.EXTENSIONID}/elevationMapping`]??[];if(t&&t.length>0){const a=[];for(const i of t){const d=Ne().tension(0).points(i.Points).strokeColor(Ti(i.Depth)).strokeDash(E.sceneMetadata[`${o.EXTENSIONID}/toolStyle`]??Ei).strokeWidth(we()).fillOpacity(.5).fillColor(Ni(i.Depth)).layer(o.LINELAYER).name("Elevation-1 Area").locked(!0).visible(!1).metadata({[`${o.EXTENSIONID}/elevation`]:i.Depth}).zIndex(i.Depth).build();a.push(d)}await w.scene.local.addItems(a)}}async function Hr(n){const e=E.sceneLocal.filter(t=>t.metadata[`${o.EXTENSIONID}/elevation`]!==void 0);if(e.length>0){const t=[];for(const a of e){let i=a.points;(a.position.x!==0||a.position.y!==0)&&(i=a.points.map(s=>{const l=s.x+a.position.x,c=s.y+a.position.y;return{x:l,y:c}}));const d={Points:i,Depth:a.metadata[`${o.EXTENSIONID}/elevation`]??0};t.push(d)}await w.scene.setMetadata({[`${o.EXTENSIONID}/elevationMapping`]:t}),await w.scene.local.deleteItems(e.map(a=>a.id))}else await w.scene.setMetadata({[`${o.EXTENSIONID}/elevationMapping`]:[]})}function Ti(n){switch(n){case 1:return"#6454ac";case 2:return"#029658";case 3:return"#fcd444";case 4:return"#fc6404";case 5:return"#ff0000";default:return"#000000"}}function Ni(n){switch(n){case 1:return"#6454ac4F";case 2:return"#0296584F";case 3:return"#fcd4444F";case 4:return"#fc64044F";case 5:return"#ff00004F";default:return"#0000004F"}}const ye={onToolClick:Pr,onToolMove:xr,onKeyDown:Rr,enterEditMode:Xr,cancelDrawing:ta};function wa(n){return n.metadata[`${o.EXTENSIONID}/isIndicatorRing`]}function Xt(n){return n.metadata[`${o.EXTENSIONID}/isVisionLine`]}function Fr(n){return n.metadata[`${o.EXTENSIONID}/isVisionLine`]&&!n.metadata[`${o.EXTENSIONID}/disabled`]}function Br(n){return n.metadata[`${o.SPECTREID}/isLocalSpectre`]}function zr(n){return n.metadata[`${o.EXTENSIONID}/isVisionWall`]}function jr(n){return n.metadata[`${o.EXTENSIONID}/isVisionLight`]}function Ur(n){return n.metadata[`${o.EXTENSIONID}/isPersistentLight`]}function Gr(n){return n.metadata[`${o.EXTENSIONID}/isLocalDecal`]}function Wr(n){return n.metadata[`${o.EXTENSIONID}/isDarkVision`]}function wt(n){return n.metadata[`${o.EXTENSIONID}/isTorch`]}function Cn(n){return(n.layer==="CHARACTER"||n.layer==="MOUNT"||n.layer==="ATTACHMENT"||n.layer==="PROP")&&n.metadata[`${o.EXTENSIONID}/hasVision`]}function Ce(n){return(n.layer==="CHARACTER"||n.layer==="MOUNT"||n.layer==="ATTACHMENT"||n.layer==="PROP")&&n.metadata[`${o.EXTENSIONID}/hasVision`]}function Yr(n){return(n.layer==="CHARACTER"||n.layer==="MOUNT"||n.layer==="ATTACHMENT"||n.layer==="PROP")&&n.createdUserId==E.playerId&&n.metadata[`${o.EXTENSIONID}/hasVision`]}function Kr(n){return n.metadata[`${o.EXTENSIONID}/isBrushSquare`]}async function Si(n,e){const t=await w.scene.local.getItems(a=>a.metadata[`${o.EXTENSIONID}/isFogEffect`]===n.id);t.length>0&&await w.scene.local.deleteItems(t.map(a=>a.id)),e===o.SPOOKYSTYLE?await Qr(n):e===o.FOGGYSTYLE?await Zr(n):e===o.COSMICSTYLE?await qr(n):e===o.WEIRDSTYLE?await Jr(n):e===o.FLESHSTYLE?await es(n):e===o.DRIPSTYLE?await ts(n):e===o.WATERSTYLE&&await ns(n)}async function qr(n){const e=Ge().scale(n.scale).rotation(n.rotation).attachedTo(n.id).effectType("ATTACHMENT").layer("FOG").metadata({[`${o.EXTENSIONID}/isFogEffect`]:n.id}).sksl(o.COSMICSHADER).disableHit(!0).zIndex(-.5).build();await w.scene.local.addItems([e])}async function Qr(n){const e=Ge().scale(n.scale).rotation(n.rotation).attachedTo(n.id).blendMode("MULTIPLY").effectType("ATTACHMENT").layer("FOG").metadata({[`${o.EXTENSIONID}/isFogEffect`]:n.id}).sksl(o.SPOOKYSHADER).disableHit(!0).zIndex(-.5).build();await w.scene.local.addItems([e])}async function Zr(n){const e=Ge().scale(n.scale).rotation(n.rotation).attachedTo(n.id).effectType("ATTACHMENT").layer("FOG").metadata({[`${o.EXTENSIONID}/isFogEffect`]:n.id}).sksl(o.FOGGYSHADER).disableHit(!0).zIndex(-.5).build();await w.scene.local.addItems([e])}async function Jr(n){const e=Ge().scale(n.scale).rotation(n.rotation).attachedTo(n.id).effectType("ATTACHMENT").layer("FOG").metadata({[`${o.EXTENSIONID}/isFogEffect`]:n.id}).sksl(o.WEIRDSHADER).disableHit(!0).zIndex(-.5).build();await w.scene.local.addItems([e])}async function es(n){const e=Ge().scale(n.scale).rotation(n.rotation).attachedTo(n.id).effectType("ATTACHMENT").layer("FOG").metadata({[`${o.EXTENSIONID}/isFogEffect`]:n.id}).sksl(o.FLESHSHADER).disableHit(!0).zIndex(-.5).build();await w.scene.local.addItems([e])}async function ts(n){const e=Ge().scale(n.scale).rotation(n.rotation).attachedTo(n.id).effectType("ATTACHMENT").layer("FOG").metadata({[`${o.EXTENSIONID}/isFogEffect`]:n.id}).sksl(o.ANNIHILATIONSHADER).disableHit(!0).zIndex(-.5).build();await w.scene.local.addItems([e])}async function ns(n){const e=Ge().scale(n.scale).rotation(n.rotation).attachedTo(n.id).effectType("ATTACHMENT").layer("FOG").metadata({[`${o.EXTENSIONID}/isFogEffect`]:n.id}).sksl(o.WATERSHADER).disableHit(!0).zIndex(-.5).build();await w.scene.local.addItems([e])}class as{cachedWallSegments=[];constructor(){}distanceSquared(e,t){const a=t.x-e.x,i=t.y-e.y;return a*a+i*i}rotatePoint(e,t,a){const i=a*Math.PI/180,d=Math.cos(i),s=Math.sin(i),l=e.x-t.x,c=e.y-t.y;return{x:t.x+(l*d-c*s),y:t.y+(l*s+c*d)}}async UpdateWallSegments(){const e=await w.scene.local.getItems(t=>t.metadata[`${o.EXTENSIONID}/isVisionWall`]===!0);this.cachedWallSegments=[];for(const t of e){const a=new Array(t.points.length);for(let i=0;i<t.points.length;i++){const d=t.points[i];a[i]=this.rotatePoint({x:d.x+t.position.x,y:d.y+t.position.y},t.position,t.rotation)}for(let i=0;i<a.length-1;i++)this.cachedWallSegments.push({start:a[i],end:a[i+1]})}}lineIntersects(e,t,a,i){function d(I,S,_){const O=(S.y-I.y)*(_.x-S.x)-(S.x-I.x)*(_.y-S.y);return O===0?0:O>0?1:2}function s(I,S,_){return S.x<=Math.max(I.x,_.x)&&S.x>=Math.min(I.x,_.x)&&S.y<=Math.max(I.y,_.y)&&S.y>=Math.min(I.y,_.y)}const l=d(e,t,a),c=d(e,t,i),h=d(a,i,e),v=d(a,i,t);return!!(l!==c&&h!==v||l===0&&s(e,a,t)||c===0&&s(e,i,t)||h===0&&s(a,e,i)||v===0&&s(a,t,i))}isLineOfSightBlocked(e,t){const a=Math.min(e.x,t.x),i=Math.max(e.x,t.x),d=Math.min(e.y,t.y),s=Math.max(e.y,t.y);for(const l of this.cachedWallSegments)if(!(Math.max(l.start.x,l.end.x)<a||Math.min(l.start.x,l.end.x)>i||Math.max(l.start.y,l.end.y)<d||Math.min(l.start.y,l.end.y)>s)&&this.lineIntersects(e,t,l.start,l.end))return!0;return!1}async HideEnemies(e,t){const a=[],i=[];for(const d of t)for(const s of e){const l=s.attenuationRadius,c=l*l;if(this.distanceSquared(s.position,d.position)<=c&&!this.isLineOfSightBlocked(s.position,d.position)){i.push(d.id);continue}a.push(d.id)}await w.scene.items.updateItems(t.map(d=>d.id),d=>{for(let s of d)a.includes(s.id)&&!i.includes(s.id)?s.visible&&(s.visible=!1):s.visible||(s.visible=!0)})}}class is{VisibilityChecker;wallsToCreate=[];wallsToUpdate=[];wallsToDelete=[];wallsToError=[];wallsNotOwner=[];lightsToCreate=[];lightsToUpdate=[];lightsToDelete=[];ringsToCreate=[];ringsToUpdate=[];ringsToDelete=[];decalsToCreate=[];decalsToUpdate=[];decalsToDelete=[];darkVisionToCreate=[];darkVisionToUpdate=[];darkVisionToDelete=[];revealersToCreate=[];revealersToUpdate=[];revealersToDelete=[];persistentLights=[];persistenceCullingDistance=1;persistenceLimit=50;trailingFoggedMaps=[];trailingFogTokens=[];constructor(){this.VisibilityChecker=new as}async Initialize(){if(E.sceneMetadata[`${o.EXTENSIONID}/persistence`]===!0){const t=localStorage.getItem(_n());if(t){const a=JSON.parse(t);if(a.length>0)for(let i of a)i.id=i.metadata[`${o.EXTENSIONID}/isPersistentLight`],this.AddPersistentLightToQueue(i,i.zIndex)}}const e=E.sceneItems.filter(t=>t.metadata[`${o.EXTENSIONID}/FogBackgroundId`]!==void 0);for(const t of e){const a=t.metadata[`${o.EXTENSIONID}/FogBackgroundId`],i=t.metadata[`${o.EXTENSIONID}/hasFogBackground`],d=E.sceneItems.filter(s=>s.id===a);if(d.length>0){const s=d[0];await Si(s,i)}}}async Reset(){this.persistentLights=[],this.trailingFogTokens=[],this.trailingFoggedMaps=[]}async Run(e=!1){!E.fogFilled&&e===!1||(await this.UpdateTrailingFogMaps(),await this.UpdateWalls(),await this.UpdateDoors(),await this.UpdateLights(),await this.UpdateOwnershipHighlights(),await this.UpdateTrailingFogTokens(),await this.UpdateAutoHideTokens(),E.sceneMetadata[`${o.EXTENSIONID}/persistence`]===!0&&localStorage.setItem(_n(),JSON.stringify(this.persistentLights)))}async UpdateAutoHideTokens(){if(E.sceneMetadata[`${o.EXTENSIONID}/autoHide`]===!0&&E.playerRole==="GM"){const e=(await w.scene.local.getItems(a=>a.metadata[`${o.EXTENSIONID}/isVisionLight`]===!0)).filter(a=>a.lightType==="PRIMARY"),t=await w.scene.items.getItems(a=>a.metadata[`${o.EXTENSIONID}/isAutoHidden`]===!0);await this.VisibilityChecker.HideEnemies(e,t)}}async UpdateTrailingFogMaps(){E.sceneMetadata[`${o.EXTENSIONID}/trailingFog`]===!0&&E.fogFilled&&await this.CreateTrailingFogOverlay()}async UpdateTrailingFogTokens(){if(E.sceneMetadata[`${o.EXTENSIONID}/trailingFog`]===!0&&E.fogFilled)this.revealersToCreate.length>0&&(await w.scene.local.addItems(this.revealersToCreate),this.revealersToCreate=[]);else if(this.trailingFogTokens.length>0||this.trailingFoggedMaps.length>0){const e=E.sceneLocal.filter(a=>a.metadata[`${o.EXTENSIONID}/isTrailingFogLight`]!==void 0),t=E.sceneLocal.filter(a=>a.metadata[`${o.EXTENSIONID}/isTrailingFogger`]!==void 0);t.length>0&&await w.scene.local.deleteItems(t.map(a=>a.id)),e.length>0&&await w.scene.local.deleteItems(e.map(a=>a.id)),this.trailingFogTokens=[],this.trailingFoggedMaps=[]}}async UpdateTrailingFogColor(e){const t=E.sceneLocal.filter(i=>i.metadata[`${o.EXTENSIONID}/isTrailingFogLight`]!==void 0);await w.scene.local.updateItems(t.map(i=>i.id),i=>{for(let d of i)d.uniforms=[{name:"darknessLevel",value:.65},{name:"darknessColor",value:Dn(e)},{name:"radiusRatio",value:1}]});const a=E.sceneLocal.filter(i=>i.metadata[`${o.EXTENSIONID}/isTrailingFogger`]!==void 0);await w.scene.local.updateItems(a.map(i=>i.id),i=>{for(let d of i)d.uniforms=[{name:"darknessLevel",value:.65},{name:"darknessColor",value:Dn(e)}]})}CreateTrailingFogRevealer(e){if(E.sceneMetadata[`${o.EXTENSIONID}/trailingFog`]===!0&&!this.trailingFogTokens.includes(e.id)){const t=Ge().position(e.position).attachedTo(e.id).rotation(e.rotation).scale(e.scale).width(200).height(200).effectType("ATTACHMENT").layer("POST_PROCESS").sksl(o.TRAILINGFOGREVEALSHADER).uniforms([{name:"radiusRatio",value:1},{name:"rotation",value:e.rotation}]).metadata({[`${o.EXTENSIONID}/isTrailingFogLight`]:e.id}).disableHit(!0).disableAutoZIndex(!0).zIndex(200).build();this.revealersToCreate.push(t),this.trailingFogTokens.push(e.id)}}async CreateTrailingFogOverlay(){const e=[],t=E.sceneItems.filter(a=>a.layer==="MAP"&&a.type==="IMAGE");for(const a of t)if(!this.trailingFoggedMaps.includes(a.id)){const i=Ge().position(a.position).attachedTo(a.id).scale(a.scale).width(a.image.width).height(a.image.height).effectType("ATTACHMENT").layer("POST_PROCESS").sksl(o.TRAILINGFOGSHADER).uniforms([{name:"darknessLevel",value:.65},{name:"darknessColor",value:Dn(E.fogColor)}]).metadata({[`${o.EXTENSIONID}/isTrailingFogger`]:a.id}).disableHit(!0).disableAutoZIndex(!0).zIndex(100).build();e.push(i),this.trailingFoggedMaps.push(a.id)}e.length>0&&await w.scene.local.addItems(e)}async ClearDoors(){if(E.playerRole!=="PLAYER")return;const e=E.sceneLocal.filter(t=>t.metadata[`${o.EXTENSIONID}/localDoor`]===!0);await w.scene.local.deleteItems(e.map(t=>t.id))}async UpdateDoors(){if(E.playerRole==="PLAYER"&&E.sceneMetadata[`${o.EXTENSIONID}/playerDoors`]!==!0)return;const e=await w.scene.items.getItems(a=>a.type==="CURVE"&&a.metadata[`${o.EXTENSIONID}/isDoor`]===!0),t=E.sceneLocal.filter(a=>a.metadata[`${o.EXTENSIONID}/localDoor`]===!0);if(e.length>0){const a=[];for(const i of e)if(!t.some(d=>d.attachedTo===i.id)){const d=i.metadata[`${o.EXTENSIONID}/doorOpen`]===!0,s=i.metadata[`${o.EXTENSIONID}/isDoorLocked`]===!0,l=Ue.fromItem(i),c=[];for(let S=0;S<i.points.length;S++){const _=Ue.fromPosition(i.points[S]);c.push(Ue.decompose(Ue.multiply(l,_)).position)}let h=o.DOOROPEN,v="Opened Door";E.playerRole==="GM"&&s?(h=o.DOORLOCKED,v="Locked Door"):d||(h=o.DOORCLOSED,v="Closed Door");const I=at.centroid(c);a.push(un({height:100,width:100,url:h,mime:"image/svg+xml"},{dpi:150,offset:{x:50,y:50}}).scale({x:.75,y:.75}).attachedTo(i.id).layer(E.playerRole==="GM"?o.LINELAYER:"DRAWING").zIndex(i.zIndex+10).locked(!0).name(v).position({x:I.x,y:I.y}).metadata({[`${o.EXTENSIONID}/localDoor`]:!0}).build())}a.length>0&&await w.scene.local.addItems(a)}else t.length>0&&await w.scene.local.deleteItems(t.map(a=>a.id));if(t.length>0){const a=[],i=[],d=[],s=[];for(const l of t){const c=E.sceneItems.find(h=>h.id===l.attachedTo&&h.metadata[`${o.EXTENSIONID}/isDoor`]===!0);c?E.playerRole==="GM"&&l.image.url!==o.DOORLOCKED&&c.metadata[`${o.EXTENSIONID}/isDoorLocked`]===!0?d.push(l.id):l.image.url!==o.DOOROPEN&&c.metadata[`${o.EXTENSIONID}/doorOpen`]===!0?a.push(l.id):l.image.url!==o.DOORCLOSED&&c.metadata[`${o.EXTENSIONID}/doorOpen`]!==!0&&(E.playerRole==="GM"&&c.metadata[`${o.EXTENSIONID}/isDoorLocked`]!==!0||E.playerRole==="PLAYER")&&i.push(l.id):s.push(l.id)}d.length>0&&await w.scene.local.updateItems(l=>d.includes(l.id),l=>{for(let c of l)c.image.url=o.DOORLOCKED,c.name="Locked Door"}),a.length>0&&await w.scene.local.updateItems(l=>a.includes(l.id),l=>{for(let c of l)c.image.url=o.DOOROPEN,c.name="Opened Door"}),i.length>0&&await w.scene.local.updateItems(l=>i.includes(l.id),l=>{for(let c of l)c.image.url=o.DOORCLOSED,c.name="Closed Door"}),s.length>0&&await w.scene.local.deleteItems(s)}}async ClearPersistence(){const e=await w.scene.local.getItems(t=>t.metadata[`${o.EXTENSIONID}/getPersistentLight`]===!0);await w.scene.local.deleteItems(e.map(t=>t.id)),this.persistentLights=[],localStorage.setItem(_n(),JSON.stringify(this.persistentLights))}async TogglePersistentLightVisibility(e){await w.scene.local.updateItems(t=>Ur(t)!==void 0,t=>{for(let a of t)a.visible=!e})}async ClearOwnershipHighlights(){const e=E.sceneLocal.filter(t=>wa(t));await w.scene.local.deleteItems(e.map(t=>t.id))}async InitiateOwnerHighlight(){if(E.playerRole!=="GM"||E.fogFilled===!1)return;const e=E.sceneItems.filter(t=>Cn(t));for(const t of e)this.CreateOwnerHighlight(t,!0)}CreateOwnerHighlight(e,t=!1){if((E.playerRole!=="GM"||E.sceneMetadata[`${o.EXTENSIONID}/toggleOwnerLines`]!==!0)&&!t)return;const a=parseInt(e.metadata[`${o.EXTENSIONID}/visionDark`])>parseInt(e.metadata[`${o.EXTENSIONID}/visionRange`]),i=this.GetLightRange(e.metadata[`${o.EXTENSIONID}/visionDark`]);if(E.sceneLocal.find(s=>s.metadata[`${o.EXTENSIONID}/isIndicatorRing`]===!0&&s.attachedTo===e.id))this.UpdateOwnerHightlight(e);else{const s=E.sceneMetadata[`${o.EXTENSIONID}/USER-${e.createdUserId}`],l=this.GetLightRange(e.metadata[`${o.EXTENSIONID}/visionRange`]??Ae()),c=sr().strokeColor(s.color).fillOpacity(0).position({x:e.position.x,y:e.position.y}).width(a?i*2:l*2).height(a?i*2:l*2).shapeType("CIRCLE").metadata({[`${o.EXTENSIONID}/isIndicatorRing`]:!0}).attachedTo(e.id).locked(!0).layer(o.LINELAYER).disableAttachmentBehavior(["SCALE"]).zIndex(1).build();this.ringsToCreate.push(c)}}UpdateDarkVision(e){const t=this.GetLightRange(e.metadata[`${o.EXTENSIONID}/visionRange`])*2,a=this.GetLightRange(e.metadata[`${o.EXTENSIONID}/visionDark`])*2,i=t*.9/a/2,d={x:e.position.x-a/2,y:e.position.y-a/2},s=[{name:"center",value:{x:.5,y:.5}},{name:"radius",value:.5},{name:"clear",value:i},{name:"smoothwidth",value:.075}],l=E.sceneLocal.find(c=>c.attachedTo===e.id&&c.metadata[`${o.EXTENSIONID}/isDarkVision`]===!0);if(l){const c={id:l.id,size:a,position:d,uniforms:s};this.darkVisionToUpdate.push(c)}}UpdateOwnerHightlight(e){if(E.playerRole!=="GM"||E.sceneMetadata[`${o.EXTENSIONID}/toggleOwnerLines`]!==!0)return;const t=parseInt(e.metadata[`${o.EXTENSIONID}/visionDark`])>parseInt(e.metadata[`${o.EXTENSIONID}/visionRange`]),a=this.GetLightRange(e.metadata[`${o.EXTENSIONID}/visionDark`]),i=this.GetLightRange(e.metadata[`${o.EXTENSIONID}/visionRange`]??Ae()),d=E.sceneLocal.find(s=>s.attachedTo===e.id&&s.metadata[`${o.EXTENSIONID}/isIndicatorRing`]===!0);if(d){const s={id:d.id,height:t?a*2:i*2,width:t?a*2:i*2};this.ringsToUpdate.push(s)}}async UpdateOwnershipHighlights(){if(E.sceneMetadata[`${o.EXTENSIONID}/toggleOwnerLines`]===!0){if(this.ringsToCreate.length>0&&await w.scene.local.addItems(this.ringsToCreate),this.ringsToDelete.length>0&&await w.scene.local.deleteItems(this.ringsToDelete),this.ringsToUpdate.length>0){const e=E.sceneLocal.filter(t=>wa(t));await w.scene.local.updateItems(e.filter(t=>!this.ringsToDelete.includes(t.id)),t=>{for(let a of t){const i=this.ringsToUpdate.find(d=>d.id===a.id);i&&(a.height=i.height,a.width=i.width)}})}this.ringsToCreate=[],this.ringsToUpdate=[],this.ringsToDelete=[]}}async UpdateLights(){let e=[];if(E.playerRole==="GM"){const s=document.getElementById("preview_select");s&&s?.value!==E.playerId?e=E.sceneItems.filter(l=>(l.layer==="CHARACTER"||l.layer==="MOUNT"||l.layer==="ATTACHMENT"||l.layer==="PROP")&&l.createdUserId===s.value&&l.metadata[`${o.EXTENSIONID}/hasVision`]):e=E.sceneItems.filter(l=>Cn(l))}else{const s=E.sceneItems.filter(h=>Cn(h)),l=[],c=[];for(const h of s)h.createdUserId===E.playerId?l.push(h):E.sceneMetadata[`${o.EXTENSIONID}/USER-${h.createdUserId}`]?.role==="GM"&&c.push(h);e=[...l,...c]}E.sceneMetadata[`${o.EXTENSIONID}/disableVision`]===!0&&(e=[]);const t=E.sceneMetadata[`${o.EXTENSIONID}/elevationMapping`]??[];for(const s of e){let l=-10;for(const h of t){const v=ga(s.position,h.Points),I=s.metadata[`${o.EXTENSIONID}/unitDepth`];I?l=parseInt(I):v&&h.Depth>l&&(l=h.Depth)}const c=E.sceneLocal.find(h=>h.attachedTo===s.id&&h.metadata[`${o.EXTENSIONID}/isVisionLight`]===!0);if(!c)this.CreateLightToQueue(s,l);else{let h=this.GetLightRange(s.metadata[`${o.EXTENSIONID}/visionRange`])===c.attenuationRadius;parseInt(s.metadata[`${o.EXTENSIONID}/visionDark`])>parseInt(s.metadata[`${o.EXTENSIONID}/visionRange`])&&h&&(h=this.GetLightRange(s.metadata[`${o.EXTENSIONID}/visionDark`])===c.attenuationRadius);const v=this.GetLightRange(s.metadata[`${o.EXTENSIONID}/visionSourceRange`])===c.sourceRadius,I=s.metadata[`${o.EXTENSIONID}/visionFallOff`]===c.falloff?.toString(),S=s.metadata[`${o.EXTENSIONID}/visionInAngle`]===c.innerAngle?.toString(),_=s.metadata[`${o.EXTENSIONID}/visionOutAngle`]===c.outerAngle?.toString(),O=s.metadata[`${o.EXTENSIONID}/visionBlind`]===!0===c.metadata[`${o.EXTENSIONID}/visionBlind`],X=this.GetDepth(l,!1)===c.zIndex;let F=!1;(!h||!v||!I||!S||!_||!O||!X)&&(this.UpdateLightToQueue(s,c,l),F=!0);const x=E.sceneLocal.find(C=>C.metadata[`${o.EXTENSIONID}/isDarkVision`]===!0&&C.attachedTo===s.id);x?(!(this.GetLightRange(s.metadata[`${o.EXTENSIONID}/visionDark`])*2===x.width)||F)&&this.UpdateDarkVision(s):this.CreateDarkVisionToQueue(s),c.lightType==="PRIMARY"&&this.CreateTrailingFogRevealer(c)}s.layer==="CHARACTER"&&(s.metadata[`${o.EXTENSIONID}/visionInAngle`]!=="360"||s.metadata[`${o.EXTENSIONID}/visionOutAngle`]!=="360")&&(E.sceneLocal.find(v=>v.metadata[`${o.EXTENSIONID}/isLocalDecal`]===s.id)||this.CreateDecalToQueue(s)),E.sceneMetadata[`${o.EXTENSIONID}/persistence`]===!0&&s.metadata[`${o.EXTENSIONID}/visionBlind`]!==!0&&(this.persistentLights.find(v=>v.position.x===s.position.x&&v.position.y===s.position.y)?(s.metadata[`${o.EXTENSIONID}/visionInAngle`]!==360||s.metadata[`${o.EXTENSIONID}/visionInAngle`]!==360)&&this.IsPositionAndRotationClear(s.rotation,s.position)&&this.AddPersistentLightToQueue(s,l):this.IsPositionClear(s.position)&&this.AddPersistentLightToQueue(s,l))}const a=E.sceneLocal.filter(s=>jr(s));for(const s of a)if(!e.find(c=>c.id===s.attachedTo)){this.lightsToDelete.push(s.id);const c=E.sceneLocal.find(h=>h.metadata[`${o.EXTENSIONID}/isIndicatorRing`]===!0&&h.attachedTo===s.attachedTo);c&&this.ringsToDelete.push(c.id)}const i=E.sceneLocal.filter(s=>Gr(s));for(const s of i){const l=e.find(c=>c.id===s.metadata[`${o.EXTENSIONID}/isLocalDecal`]);l?l.metadata[`${o.EXTENSIONID}/visionInAngle`]==="360"||l.metadata[`${o.EXTENSIONID}/visionOutAngle`]==="360"?this.decalsToDelete.push(s.id):l.image.url!==s.image.url&&this.decalsToUpdate.push({id:s.id,imageUrl:l.image.url}):this.decalsToDelete.push(s.id)}const d=E.sceneLocal.filter(s=>Wr(s));for(const s of d){const l=e.find(c=>s.metadata[`${o.EXTENSIONID}/isDarkVision`]===!0&&s.attachedTo===c.id);l?parseInt(l.metadata[`${o.EXTENSIONID}/visionDark`])<parseInt(l.metadata[`${o.EXTENSIONID}/visionRange`])&&this.decalsToDelete.push(s.id):this.decalsToDelete.push(s.id)}this.lightsToCreate.length>0&&await w.scene.local.addItems(this.lightsToCreate),this.lightsToDelete.length>0&&await w.scene.local.deleteItems(this.lightsToDelete),this.lightsToUpdate.length>0&&await w.scene.local.updateItems(a.filter(s=>!this.lightsToDelete.includes(s.id)),s=>{for(let l of s){const c=this.lightsToUpdate.find(h=>h.id===l.id);c&&(l.attenuationRadius=c.attenuationRadius,l.sourceRadius=c.sourceRadius,l.falloff=c.falloff,l.innerAngle=c.innerAngle,l.outerAngle=c.outerAngle,l.metadata[`${o.EXTENSIONID}/visionBlind`]=c.blind,l.zIndex=c.zIndex)}}),this.decalsToCreate.length>0&&await w.scene.local.addItems(this.decalsToCreate),this.decalsToDelete.length>0&&await w.scene.local.deleteItems(this.decalsToDelete),this.decalsToUpdate.length>0&&await w.scene.local.updateItems(i.filter(s=>!this.decalsToDelete.includes(s.id)),s=>{for(let l of s){const c=this.decalsToUpdate.find(h=>h.id===l.id);c&&(l.image.url=c.imageUrl)}}),this.darkVisionToCreate.length>0&&await w.scene.local.addItems(this.darkVisionToCreate),this.darkVisionToDelete.length>0&&await w.scene.local.deleteItems(this.darkVisionToDelete),this.darkVisionToUpdate.length>0&&await w.scene.local.updateItems(d.filter(s=>!this.darkVisionToDelete.includes(s.id)),s=>{for(let l of s){const c=this.darkVisionToUpdate.find(h=>h.id===l.id);c&&(l.width=c.size,l.height=c.size,l.position=c.position,l.uniforms=c.uniforms)}}),this.lightsToCreate=[],this.lightsToUpdate=[],this.lightsToDelete=[],this.decalsToCreate=[],this.decalsToDelete=[],this.decalsToUpdate=[],this.darkVisionToCreate=[],this.darkVisionToUpdate=[],this.darkVisionToDelete=[]}async UpdateWalls(){const e=E.sceneMetadata[`${o.EXTENSIONID}/elevationMapping`]??[],t=E.sceneMetadata[`${o.EXTENSIONID}/passWallsGM`]===!0&&E.playerRole==="GM",a=E.sceneItems.filter(s=>Fr(s));for(const s of a){if(s.type!=="CURVE"||s.points===void 0){this.wallsToError.push(s.id);continue}const l=s.metadata[`${o.EXTENSIONID}/wallViewers`];if(!l||l&&l.length>0&&l[0]===E.playerId||E.playerRole==="GM"){let c=-10;for(const v of e){const I={x:s.points[0].x+s.position.x,y:s.points[0].y+s.position.y},S=ga(I,v.Points),_=s.metadata[`${o.EXTENSIONID}/wallDepth`];_?c=parseInt(_):S&&v.Depth>c&&(c=v.Depth)}const h=E.sceneLocal.find(v=>v.attachedTo===s.id&&v.metadata[`${o.EXTENSIONID}/isVisionWall`]===!0);if(!h)this.CreateWallToQueue(s,c);else{const v=Tr(s,h),I=s.rotation===h.rotation,S=s.scale.x===h.scale.x&&s.scale.y===h.scale.y,_=s.position.x===h.position.x&&s.position.y===h.position.y,O=s.metadata[`${o.EXTENSIONID}/doubleSided`]===h.doubleSided,X=this.GetDepth(c,!0)===h.zIndex,F=s.metadata[`${o.EXTENSIONID}/isWindow`]===h.metadata[`${o.EXTENSIONID}/isWindow`];let x=(t?!1:s.metadata[`${o.EXTENSIONID}/blocking`])===h.blocking;(!v||!_||!I||!S||!x||!O||!X||!F)&&this.UpdateWallToQueue(s,h,c)}}else this.wallsNotOwner.push(s.id)}const i=E.sceneLocal.filter(s=>zr(s));for(const s of i){if(!a.find(c=>c.id===s.attachedTo)){this.wallsToDelete.push(s.id);continue}this.wallsNotOwner.includes(s.attachedTo)&&this.wallsToDelete.push(s.id)}let d=!1;this.wallsToCreate.length>0&&(await w.scene.local.addItems(this.wallsToCreate),d=!0),this.wallsToDelete.length>0&&(await w.scene.local.deleteItems(this.wallsToDelete),d=!0),this.wallsToUpdate.length>0&&(await w.scene.local.updateItems(i.filter(s=>!this.wallsToDelete.includes(s.id)),s=>{for(let l of s){const c=this.wallsToUpdate.find(h=>h.id===l.id);c&&(l.points=c.points,l.position=c.position,l.rotation=c.rotation,l.scale=c.scale,l.blocking=c.blocking,l.visible=c.visible,l.doubleSided=c.doubleSided,l.zIndex=c.zIndex)}}),d=!0),this.wallsToError.length>0&&(await w.scene.items.updateItems(this.wallsToError,s=>{for(let l of s)l.style.strokeDash=[10,30],l.style.strokeColor="red",delete l.metadata[`${o.EXTENSIONID}/isDoorLocked`],delete l.metadata[`${o.EXTENSIONID}/doorOpen`],delete l.metadata[`${o.EXTENSIONID}/disabled`],delete l.metadata[`${o.EXTENSIONID}/isDoor`],delete l.metadata[`${o.EXTENSIONID}/doubleSided`],delete l.metadata[`${o.EXTENSIONID}/disabled`],delete l.metadata[`${o.EXTENSIONID}/isVisionLine`],delete l.metadata[`${o.EXTENSIONID}/blocking`]}),d=!0),this.wallsToCreate=[],this.wallsToUpdate=[],this.wallsToDelete=[],this.wallsToError=[],this.wallsNotOwner=[],E.playerRole==="GM"&&d&&(await this.VisibilityChecker.UpdateWallSegments(),d=!1)}CreateWallToQueue(e,t){if(!e.points)return;let a=e.metadata[`${o.EXTENSIONID}/blocking`]===!0;const i=e.metadata[`${o.EXTENSIONID}/isWindow`]===!0,d=e.metadata[`${o.EXTENSIONID}/doubleSided`]===!0;E.playerRole==="GM"&&E.sceneMetadata[`${o.EXTENSIONID}/passWallsGM`]===!0&&(a=!1);const s=or().points(e.points).attachedTo(e.id).rotation(e.rotation).position(e.position).locked(!0).scale(e.scale).blocking(a).doubleSided(d).visible(!i).disableAttachmentBehavior(["VISIBLE"]).zIndex(this.GetDepth(t,!0)).metadata({[`${o.EXTENSIONID}/isVisionWall`]:!0}).build();this.wallsToCreate.push(s)}AddPersistentLightToQueue(e,t){if((e.metadata[`${o.EXTENSIONID}/isTorch`]===!0?"SECONDARY":"PRIMARY")==="SECONDARY")return;const i=fa().position(e.position).lightType("AUXILIARY").rotation(e.rotation).attenuationRadius(this.GetLightRange(e.metadata[`${o.EXTENSIONID}/visionRange`]??Ae())).sourceRadius(this.GetLightRange(e.metadata[`${o.EXTENSIONID}/visionSourceRange`]??Ve(),!0)).falloff(parseFloat(e.metadata[`${o.EXTENSIONID}/visionFallOff`]??Ze())).innerAngle(parseInt(e.metadata[`${o.EXTENSIONID}/visionInAngle`]??rt())).outerAngle(parseInt(e.metadata[`${o.EXTENSIONID}/visionOutAngle`]??We())).zIndex(this.GetDepth(t,!1)).metadata({[`${o.EXTENSIONID}/isPersistentLight`]:e.id,[`${o.EXTENSIONID}/getPersistentLight`]:!0}).build();if(this.lightsToCreate.push(i),this.persistentLights.push({id:i.id,position:i.position,rotation:i.rotation,zIndex:t,metadata:e.metadata}),this.persistenceLimit===this.persistentLights.length){const d=this.persistentLights.shift();this.lightsToDelete.push(d.id)}}CreateLightToQueue(e,t){const a=e.metadata[`${o.EXTENSIONID}/isTorch`]===!0?"SECONDARY":"PRIMARY",i=e.metadata[`${o.EXTENSIONID}/visionBlind`]===!0?0:this.GetLightRange(e.metadata[`${o.EXTENSIONID}/visionRange`]??Ae()),d=parseInt(e.metadata[`${o.EXTENSIONID}/visionDark`])>parseInt(e.metadata[`${o.EXTENSIONID}/visionRange`]),s=this.GetLightRange(e.metadata[`${o.EXTENSIONID}/visionDark`]),l=fa().position(e.position).rotation(e.rotation).lightType(a).attenuationRadius(d?s:i).sourceRadius(this.GetLightRange(e.metadata[`${o.EXTENSIONID}/visionSourceRange`]??Ve(),!0)).falloff(parseFloat(e.metadata[`${o.EXTENSIONID}/visionFallOff`]??Ze())).innerAngle(parseInt(e.metadata[`${o.EXTENSIONID}/visionInAngle`]??rt())).outerAngle(parseInt(e.metadata[`${o.EXTENSIONID}/visionOutAngle`]??We())).zIndex(this.GetDepth(t,!1)).metadata({[`${o.EXTENSIONID}/isVisionLight`]:!0,[`${o.EXTENSIONID}/visionBlind`]:e.metadata[`${o.EXTENSIONID}/visionBlind`]===!0}).attachedTo(e.id).disableAttachmentBehavior(["SCALE","VISIBLE"]).build();this.lightsToCreate.push(l),a==="PRIMARY"&&(this.CreateTrailingFogRevealer(l),this.CreateDarkVisionToQueue(e),this.CreateOwnerHighlight(e))}CreateDarkVisionToQueue(e){const t=parseInt(e.metadata[`${o.EXTENSIONID}/visionDark`]),a=parseInt(e.metadata[`${o.EXTENSIONID}/visionRange`]);if(!t||!a||t<a)return;const i=this.GetLightRange(e.metadata[`${o.EXTENSIONID}/visionRange`])*2,d=this.GetLightRange(e.metadata[`${o.EXTENSIONID}/visionDark`])*2,s=i*.9/d/2,l=Ge().position({x:e.position.x-d/2,y:e.position.y-d/2}).attachedTo(e.id).width(d).height(d).blendMode("SATURATION").effectType("STANDALONE").attachedTo(e.id).sksl(o.DARKVISIONSHADER).metadata({[`${o.EXTENSIONID}/isDarkVision`]:!0}).disableHit(!0).disableAttachmentBehavior(["SCALE"]).uniforms([{name:"center",value:{x:.5,y:.5}},{name:"radius",value:.5},{name:"clear",value:s},{name:"smoothwidth",value:.075}]).build();this.darkVisionToCreate.push(l)}CreateDecalToQueue(e){const t=un({height:e.image.height,width:e.image.width,url:e.image.url,mime:e.image.mime},{dpi:e.grid.dpi,offset:e.grid.offset}).rotation(e.rotation).scale(e.scale).position(e.position).attachedTo(e.id).layer("FOG").locked(!0).visible(!1).metadata({[`${o.EXTENSIONID}/isLocalDecal`]:e.id}).build();this.decalsToCreate.push(t)}UpdateWallToQueue(e,t,a){if(!e.points)return;let i=e.metadata[`${o.EXTENSIONID}/blocking`]===!0;E.playerRole==="GM"&&E.sceneMetadata[`${o.EXTENSIONID}/passWallsGM`]===!0&&(i=!1);const d={id:t.id,points:e.points,rotation:e.rotation,position:e.position,scale:e.scale,blocking:i,visible:!e.metadata[`${o.EXTENSIONID}/isWindow`],doubleSided:e.metadata[`${o.EXTENSIONID}/doubleSided`]===!0,zIndex:this.GetDepth(a,!0)};this.wallsToUpdate.push(d)}UpdateLightToQueue(e,t,a){const i=e.metadata[`${o.EXTENSIONID}/isTorch`]===!0?"SECONDARY":"PRIMARY",d=e.metadata[`${o.EXTENSIONID}/visionBlind`]===!0?0:this.GetLightRange(e.metadata[`${o.EXTENSIONID}/visionRange`]??Ae()),s=parseInt(e.metadata[`${o.EXTENSIONID}/visionDark`])>parseInt(e.metadata[`${o.EXTENSIONID}/visionRange`]),l=this.GetLightRange(e.metadata[`${o.EXTENSIONID}/visionDark`]),c={id:t.id,attenuationRadius:s?l:d,sourceRadius:this.GetLightRange(e.metadata[`${o.EXTENSIONID}/visionSourceRange`]??Ve(),!0),falloff:parseFloat(e.metadata[`${o.EXTENSIONID}/visionFallOff`]??Ze()),innerAngle:parseInt(e.metadata[`${o.EXTENSIONID}/visionInAngle`]??rt()),outerAngle:parseInt(e.metadata[`${o.EXTENSIONID}/visionOutAngle`]??We()),blind:e.metadata[`${o.EXTENSIONID}/visionBlind`]===!0,zIndex:this.GetDepth(a,!1)};this.lightsToUpdate.push(c),i==="PRIMARY"&&this.UpdateOwnerHightlight(e)}GetLightRange(e,t=!1){return(t?parseFloat(e):parseInt(e))/E.gridScale*E.gridDpi}GetDepth(e,t){if(e===-10){const i=E.sceneMetadata[`${o.EXTENSIONID}/defaultElevation`];typeof i=="string"&&(e=parseInt(i))}if(E.sceneMetadata[`${o.EXTENSIONID}/elevationComplex`]===!0)switch(e){case 1:return-5;case 2:return-6;case 3:return-7;case 4:return-8;case 5:return-9;case 6:return-10;default:return-1}else switch(e){case 1:return t?-4:-5;case 2:return t?-5:-6;case 3:return t?-6:-7;case 4:return t?-7:-8;case 5:return t?-8:-9;case 6:return t?-9:-10;default:return-1}}IsPositionClear(e){const t=(E.gridDpi-10)*this.persistenceCullingDistance;for(const a of this.persistentLights)if(fn(e,a.position)<=t)return!1;return!0}IsPositionAndRotationClear(e,t){const a=(E.gridDpi-10)*this.persistenceCullingDistance;for(const i of this.persistentLights)if(fn(t,i.position)<=a&&e===i.rotation)return!1;return!0}async ToggleDoor(e){const t=E.sceneLocal.filter(a=>a.id===e&&a.metadata[`${o.EXTENSIONID}/localDoor`]===!0);if(t.length===1){const a=E.sceneItems.filter(i=>i.id===t[0].attachedTo);if(a.length===1){const i=a[0];if(E.playerRole!=="GM"&&i.metadata[`${o.EXTENSIONID}/isDoorLocked`])return;await w.scene.items.updateItems(a,d=>{for(let s of d)s.metadata[`${o.EXTENSIONID}/isVisionLine`]&&s.metadata[`${o.EXTENSIONID}/disabled`]?(delete s.metadata[`${o.EXTENSIONID}/disabled`],delete s.metadata[`${o.EXTENSIONID}/doorOpen`]):s.metadata[`${o.EXTENSIONID}/isVisionLine`]&&(s.metadata[`${o.EXTENSIONID}/disabled`]=!0,s.metadata[`${o.EXTENSIONID}/doorOpen`]=!0,delete s.metadata[`${o.EXTENSIONID}/isDoorLocked`])}),await w.player.deselect([e])}}}}const Ee=new is;function Ln(n,e){n.split(/\s+/).forEach(t=>{e(t)})}class rs{constructor(){this._events={}}on(e,t){Ln(e,a=>{const i=this._events[a]||[];i.push(t),this._events[a]=i})}off(e,t){var a=arguments.length;if(a===0){this._events={};return}Ln(e,i=>{if(a===1){delete this._events[i];return}const d=this._events[i];d!==void 0&&(d.splice(d.indexOf(t),1),this._events[i]=d)})}trigger(e,...t){var a=this;Ln(e,i=>{const d=a._events[i];d!==void 0&&d.forEach(s=>{s.apply(a,t)})})}}function ss(n){return n.plugins={},class extends n{constructor(){super(...arguments),this.plugins={names:[],settings:{},requested:{},loaded:{}}}static define(e,t){n.plugins[e]={name:e,fn:t}}initializePlugins(e){var t,a;const i=this,d=[];if(Array.isArray(e))e.forEach(s=>{typeof s=="string"?d.push(s):(i.plugins.settings[s.name]=s.options,d.push(s.name))});else if(e)for(t in e)e.hasOwnProperty(t)&&(i.plugins.settings[t]=e[t],d.push(t));for(;a=d.shift();)i.require(a)}loadPlugin(e){var t=this,a=t.plugins,i=n.plugins[e];if(!n.plugins.hasOwnProperty(e))throw new Error('Unable to find "'+e+'" plugin');a.requested[e]=!0,a.loaded[e]=i.fn.apply(t,[t.plugins.settings[e]||{}]),a.names.push(e)}require(e){var t=this,a=t.plugins;if(!t.plugins.loaded.hasOwnProperty(e)){if(a.requested[e])throw new Error('Plugin has circular dependency ("'+e+'")');t.loadPlugin(e)}return a.loaded[e]}}}const wn=n=>(n=n.filter(Boolean),n.length<2?n[0]||"":ds(n)==1?"["+n.join("")+"]":"(?:"+n.join("|")+")"),_i=n=>{if(!os(n))return n.join("");let e="",t=0;const a=()=>{t>1&&(e+="{"+t+"}")};return n.forEach((i,d)=>{if(i===n[d-1]){t++;return}a(),e+=i,t=1}),a(),e},Oi=n=>{let e=Array.from(n);return wn(e)},os=n=>new Set(n).size!==n.length,Ut=n=>(n+"").replace(/([\$\(\)\*\+\.\?\[\]\^\{\|\}\\])/gu,"\\$1"),ds=n=>n.reduce((e,t)=>Math.max(e,ls(t)),0),ls=n=>Array.from(n).length,Di=n=>{if(n.length===1)return[[n]];let e=[];const t=n.substring(1);return Di(t).forEach(function(i){let d=i.slice(0);d[0]=n.charAt(0)+d[0],e.push(d),d=i.slice(0),d.unshift(n.charAt(0)),e.push(d)}),e},cs=[[0,65535]],us="[̀-ͯ·ʾʼ]";let gn,ki;const fs=3,na={},ba={"/":"⁄∕",0:"߀",a:"ⱥɐɑ",aa:"ꜳ",ae:"æǽǣ",ao:"ꜵ",au:"ꜷ",av:"ꜹꜻ",ay:"ꜽ",b:"ƀɓƃ",c:"ꜿƈȼↄ",d:"đɗɖᴅƌꮷԁɦ",e:"ɛǝᴇɇ",f:"ꝼƒ",g:"ǥɠꞡᵹꝿɢ",h:"ħⱨⱶɥ",i:"ɨı",j:"ɉȷ",k:"ƙⱪꝁꝃꝅꞣ",l:"łƚɫⱡꝉꝇꞁɭ",m:"ɱɯϻ",n:"ꞥƞɲꞑᴎлԉ",o:"øǿɔɵꝋꝍᴑ",oe:"œ",oi:"ƣ",oo:"ꝏ",ou:"ȣ",p:"ƥᵽꝑꝓꝕρ",q:"ꝗꝙɋ",r:"ɍɽꝛꞧꞃ",s:"ßȿꞩꞅʂ",t:"ŧƭʈⱦꞇ",th:"þ",tz:"ꜩ",u:"ʉ",v:"ʋꝟʌ",vy:"ꝡ",w:"ⱳ",y:"ƴɏỿ",z:"ƶȥɀⱬꝣ",hv:"ƕ"};for(let n in ba){let e=ba[n]||"";for(let t=0;t<e.length;t++){let a=e.substring(t,t+1);na[a]=n}}const ps=new RegExp(Object.keys(na).join("|")+"|"+us,"gu"),hs=n=>{gn===void 0&&(gn=ys(cs))},Ta=(n,e="NFKD")=>n.normalize(e),vn=n=>Array.from(n).reduce((e,t)=>e+ms(t),""),ms=n=>(n=Ta(n).toLowerCase().replace(ps,e=>na[e]||""),Ta(n,"NFC"));function*gs(n){for(const[e,t]of n)for(let a=e;a<=t;a++){let i=String.fromCharCode(a),d=vn(i);d!=i.toLowerCase()&&(d.length>fs||d.length!=0&&(yield{folded:d,composed:i,code_point:a}))}}const vs=n=>{const e={},t=(a,i)=>{const d=e[a]||new Set,s=new RegExp("^"+Oi(d)+"$","iu");i.match(s)||(d.add(Ut(i)),e[a]=d)};for(let a of gs(n))t(a.folded,a.folded),t(a.folded,a.composed);return e},ys=n=>{const e=vs(n),t={};let a=[];for(let d in e){let s=e[d];s&&(t[d]=Oi(s)),d.length>1&&a.push(Ut(d))}a.sort((d,s)=>s.length-d.length);const i=wn(a);return ki=new RegExp("^"+i,"u"),t},Es=(n,e=1)=>{let t=0;return n=n.map(a=>(gn[a]&&(t+=a.length),gn[a]||a)),t>=e?_i(n):""},Is=(n,e=1)=>(e=Math.max(e,n.length-1),wn(Di(n).map(t=>Es(t,e)))),Na=(n,e=!0)=>{let t=n.length>1?1:0;return wn(n.map(a=>{let i=[];const d=e?a.length():a.length()-1;for(let s=0;s<d;s++)i.push(Is(a.substrs[s]||"",t));return _i(i)}))},ws=(n,e)=>{for(const t of e){if(t.start!=n.start||t.end!=n.end||t.substrs.join("")!==n.substrs.join(""))continue;let a=n.parts;const i=s=>{for(const l of a){if(l.start===s.start&&l.substr===s.substr)return!1;if(!(s.length==1||l.length==1)&&(s.start<l.start&&s.end>l.start||l.start<s.start&&l.end>s.start))return!0}return!1};if(!(t.parts.filter(i).length>0))return!0}return!1};class yn{parts;substrs;start;end;constructor(){this.parts=[],this.substrs=[],this.start=0,this.end=0}add(e){e&&(this.parts.push(e),this.substrs.push(e.substr),this.start=Math.min(e.start,this.start),this.end=Math.max(e.end,this.end))}last(){return this.parts[this.parts.length-1]}length(){return this.parts.length}clone(e,t){let a=new yn,i=JSON.parse(JSON.stringify(this.parts)),d=i.pop();for(const c of i)a.add(c);let s=t.substr.substring(0,e-d.start),l=s.length;return a.add({start:d.start,end:d.start+l,length:l,substr:s}),a}}const bs=n=>{hs(),n=vn(n);let e="",t=[new yn];for(let a=0;a<n.length;a++){let d=n.substring(a).match(ki);const s=n.substring(a,a+1),l=d?d[0]:null;let c=[],h=new Set;for(const v of t){const I=v.last();if(!I||I.length==1||I.end<=a)if(l){const S=l.length;v.add({start:a,end:a+S,length:S,substr:l}),h.add("1")}else v.add({start:a,end:a+1,length:1,substr:s}),h.add("2");else if(l){let S=v.clone(a,I);const _=l.length;S.add({start:a,end:a+_,length:_,substr:l}),c.push(S)}else h.add("3")}if(c.length>0){c=c.sort((v,I)=>v.length()-I.length());for(let v of c)ws(v,t)||t.push(v);continue}if(a>0&&h.size==1&&!h.has("3")){e+=Na(t,!1);let v=new yn;const I=t[0];I&&v.add(I.last()),t=[v]}}return e+=Na(t,!0),e},Ts=(n,e)=>{if(n)return n[e]},Ns=(n,e)=>{if(n){for(var t,a=e.split(".");(t=a.shift())&&(n=n[t]););return n}},An=(n,e,t)=>{var a,i;return!n||(n=n+"",e.regex==null)||(i=n.search(e.regex),i===-1)?0:(a=e.string.length/n.length,i===0&&(a+=.5),a*t)},$n=(n,e)=>{var t=n[e];if(typeof t=="function")return t;t&&!Array.isArray(t)&&(n[e]=[t])},tn=(n,e)=>{if(Array.isArray(n))n.forEach(e);else for(var t in n)n.hasOwnProperty(t)&&e(n[t],t)},Ss=(n,e)=>typeof n=="number"&&typeof e=="number"?n>e?1:n<e?-1:0:(n=vn(n+"").toLowerCase(),e=vn(e+"").toLowerCase(),n>e?1:e>n?-1:0);class _s{items;settings;constructor(e,t){this.items=e,this.settings=t||{diacritics:!0}}tokenize(e,t,a){if(!e||!e.length)return[];const i=[],d=e.split(/\s+/);var s;return a&&(s=new RegExp("^("+Object.keys(a).map(Ut).join("|")+"):(.*)$")),d.forEach(l=>{let c,h=null,v=null;s&&(c=l.match(s))&&(h=c[1],l=c[2]),l.length>0&&(this.settings.diacritics?v=bs(l)||null:v=Ut(l),v&&t&&(v="\\b"+v)),i.push({string:l,regex:v?new RegExp(v,"iu"):null,field:h})}),i}getScoreFunction(e,t){var a=this.prepareSearch(e,t);return this._getScoreFunction(a)}_getScoreFunction(e){const t=e.tokens,a=t.length;if(!a)return function(){return 0};const i=e.options.fields,d=e.weights,s=i.length,l=e.getAttrFn;if(!s)return function(){return 1};const c=function(){return s===1?function(h,v){const I=i[0].field;return An(l(v,I),h,d[I]||1)}:function(h,v){var I=0;if(h.field){const S=l(v,h.field);!h.regex&&S?I+=1/s:I+=An(S,h,1)}else tn(d,(S,_)=>{I+=An(l(v,_),h,S)});return I/s}}();return a===1?function(h){return c(t[0],h)}:e.options.conjunction==="and"?function(h){var v,I=0;for(let S of t){if(v=c(S,h),v<=0)return 0;I+=v}return I/a}:function(h){var v=0;return tn(t,I=>{v+=c(I,h)}),v/a}}getSortFunction(e,t){var a=this.prepareSearch(e,t);return this._getSortFunction(a)}_getSortFunction(e){var t,a=[];const i=this,d=e.options,s=!e.query&&d.sort_empty?d.sort_empty:d.sort;if(typeof s=="function")return s.bind(this);const l=function(h,v){return h==="$score"?v.score:e.getAttrFn(i.items[v.id],h)};if(s)for(let h of s)(e.query||h.field!=="$score")&&a.push(h);if(e.query){t=!0;for(let h of a)if(h.field==="$score"){t=!1;break}t&&a.unshift({field:"$score",direction:"desc"})}else a=a.filter(h=>h.field!=="$score");return a.length?function(h,v){var I,S;for(let _ of a)if(S=_.field,I=(_.direction==="desc"?-1:1)*Ss(l(S,h),l(S,v)),I)return I;return 0}:null}prepareSearch(e,t){const a={};var i=Object.assign({},t);if($n(i,"sort"),$n(i,"sort_empty"),i.fields){$n(i,"fields");const d=[];i.fields.forEach(s=>{typeof s=="string"&&(s={field:s,weight:1}),d.push(s),a[s.field]="weight"in s?s.weight:1}),i.fields=d}return{options:i,query:e.toLowerCase().trim(),tokens:this.tokenize(e,i.respect_word_boundaries,a),total:0,items:[],weights:a,getAttrFn:i.nesting?Ns:Ts}}search(e,t){var a=this,i,d;d=this.prepareSearch(e,t),t=d.options,e=d.query;const s=t.score||a._getScoreFunction(d);e.length?tn(a.items,(c,h)=>{i=s(c),(t.filter===!1||i>0)&&d.items.push({score:i,id:h})}):tn(a.items,(c,h)=>{d.items.push({score:1,id:h})});const l=a._getSortFunction(d);return l&&d.items.sort(l),d.total=d.items.length,typeof t.limit=="number"&&(d.items=d.items.slice(0,t.limit)),d}}const Xe=n=>typeof n>"u"||n===null?null:ln(n),ln=n=>typeof n=="boolean"?n?"1":"0":n+"",Mn=n=>(n+"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;"),Os=(n,e)=>e>0?window.setTimeout(n,e):(n.call(null),null),Ds=(n,e)=>{var t;return function(a,i){var d=this;t&&(d.loading=Math.max(d.loading-1,0),clearTimeout(t)),t=setTimeout(function(){t=null,d.loadedSearches[a]=!0,n.call(d,a,i)},e)}},Sa=(n,e,t)=>{var a,i=n.trigger,d={};n.trigger=function(){var s=arguments[0];if(e.indexOf(s)!==-1)d[s]=arguments;else return i.apply(n,arguments)},t.apply(n,[]),n.trigger=i;for(a of e)a in d&&i.apply(n,d[a])},ks=n=>({start:n.selectionStart||0,length:(n.selectionEnd||0)-(n.selectionStart||0)}),fe=(n,e=!1)=>{n&&(n.preventDefault(),e&&n.stopPropagation())},Ie=(n,e,t,a)=>{n.addEventListener(e,t,a)},ut=(n,e)=>{if(!e||!e[n])return!1;var t=(e.altKey?1:0)+(e.ctrlKey?1:0)+(e.shiftKey?1:0)+(e.metaKey?1:0);return t===1},Pn=(n,e)=>{const t=n.getAttribute("id");return t||(n.setAttribute("id",e),e)},_a=n=>n.replace(/[\\"']/g,"\\$&"),ft=(n,e)=>{e&&n.append(e)},ge=(n,e)=>{if(Array.isArray(n))n.forEach(e);else for(var t in n)n.hasOwnProperty(t)&&e(n[t],t)},ze=n=>{if(n.jquery)return n[0];if(n instanceof HTMLElement)return n;if(Ci(n)){var e=document.createElement("template");return e.innerHTML=n.trim(),e.content.firstChild}return document.querySelector(n)},Ci=n=>typeof n=="string"&&n.indexOf("<")>-1,Cs=n=>n.replace(/['"\\]/g,"\\$&"),xn=(n,e)=>{var t=document.createEvent("HTMLEvents");t.initEvent(e,!0,!1),n.dispatchEvent(t)},nn=(n,e)=>{Object.assign(n.style,e)},Le=(n,...e)=>{var t=Li(e);n=Ai(n),n.map(a=>{t.map(i=>{a.classList.add(i)})})},nt=(n,...e)=>{var t=Li(e);n=Ai(n),n.map(a=>{t.map(i=>{a.classList.remove(i)})})},Li=n=>{var e=[];return ge(n,t=>{typeof t=="string"&&(t=t.trim().split(/[\t\n\f\r\s]/)),Array.isArray(t)&&(e=e.concat(t))}),e.filter(Boolean)},Ai=n=>(Array.isArray(n)||(n=[n]),n),Rn=(n,e,t)=>{if(!(t&&!t.contains(n)))for(;n&&n.matches;){if(n.matches(e))return n;n=n.parentNode}},Oa=(n,e=0)=>e>0?n[n.length-1]:n[0],Ls=n=>Object.keys(n).length===0,Da=(n,e)=>{if(!n)return-1;e=e||n.nodeName;for(var t=0;n=n.previousElementSibling;)n.matches(e)&&t++;return t},ue=(n,e)=>{ge(e,(t,a)=>{t==null?n.removeAttribute(a):n.setAttribute(a,""+t)})},Wn=(n,e)=>{n.parentNode&&n.parentNode.replaceChild(e,n)},As=(n,e)=>{if(e===null)return;if(typeof e=="string"){if(!e.length)return;e=new RegExp(e,"i")}const t=d=>{var s=d.data.match(e);if(s&&d.data.length>0){var l=document.createElement("span");l.className="highlight";var c=d.splitText(s.index);c.splitText(s[0].length);var h=c.cloneNode(!0);return l.appendChild(h),Wn(c,l),1}return 0},a=d=>{d.nodeType===1&&d.childNodes&&!/(script|style)/i.test(d.tagName)&&(d.className!=="highlight"||d.tagName!=="SPAN")&&Array.from(d.childNodes).forEach(s=>{i(s)})},i=d=>d.nodeType===3?t(d):(a(d),0);i(n)},$s=n=>{var e=n.querySelectorAll("span.highlight");Array.prototype.forEach.call(e,function(t){var a=t.parentNode;a.replaceChild(t.firstChild,t),a.normalize()})},Ms=65,Ps=13,xs=27,Rs=37,Xs=38,Vs=39,Hs=40,ka=8,Fs=46,Ca=9,Bs=typeof navigator>"u"?!1:/Mac/.test(navigator.userAgent),an=Bs?"metaKey":"ctrlKey",La={options:[],optgroups:[],plugins:[],delimiter:",",splitOn:null,persist:!0,diacritics:!0,create:null,createOnBlur:!1,createFilter:null,highlight:!0,openOnFocus:!0,shouldOpen:null,maxOptions:50,maxItems:null,hideSelected:null,duplicates:!1,addPrecedence:!1,selectOnTab:!1,preload:null,allowEmptyOption:!1,refreshThrottle:300,loadThrottle:300,loadingClass:"loading",dataAttr:null,optgroupField:"optgroup",valueField:"value",labelField:"text",disabledField:"disabled",optgroupLabelField:"label",optgroupValueField:"value",lockOptgroupOrder:!1,sortField:"$order",searchField:["text"],searchConjunction:"and",mode:null,wrapperClass:"ts-wrapper",controlClass:"ts-control",dropdownClass:"ts-dropdown",dropdownContentClass:"ts-dropdown-content",itemClass:"item",optionClass:"option",dropdownParent:null,controlInput:'<input type="text" autocomplete="off" size="1" />',copyClassesToDropdown:!1,placeholder:null,hidePlaceholder:null,shouldLoad:function(n){return n.length>0},render:{}};function Aa(n,e){var t=Object.assign({},La,e),a=t.dataAttr,i=t.labelField,d=t.valueField,s=t.disabledField,l=t.optgroupField,c=t.optgroupLabelField,h=t.optgroupValueField,v=n.tagName.toLowerCase(),I=n.getAttribute("placeholder")||n.getAttribute("data-placeholder");if(!I&&!t.allowEmptyOption){let X=n.querySelector('option[value=""]');X&&(I=X.textContent)}var S={placeholder:I,options:[],optgroups:[],items:[],maxItems:null},_=()=>{var X,F=S.options,x={},C=1;let G=0;var r=p=>{var y=Object.assign({},p.dataset),m=a&&y[a];return typeof m=="string"&&m.length&&(y=Object.assign(y,JSON.parse(m))),y},f=(p,y)=>{var m=Xe(p.value);if(m!=null&&!(!m&&!t.allowEmptyOption)){if(x.hasOwnProperty(m)){if(y){var g=x[m][l];g?Array.isArray(g)?g.push(y):x[m][l]=[g,y]:x[m][l]=y}}else{var T=r(p);T[i]=T[i]||p.textContent,T[d]=T[d]||m,T[s]=T[s]||p.disabled,T[l]=T[l]||y,T.$option=p,T.$order=T.$order||++G,x[m]=T,F.push(T)}p.selected&&S.items.push(m)}},u=p=>{var y,m;m=r(p),m[c]=m[c]||p.getAttribute("label")||"",m[h]=m[h]||C++,m[s]=m[s]||p.disabled,m.$order=m.$order||++G,S.optgroups.push(m),y=m[h],ge(p.children,g=>{f(g,y)})};S.maxItems=n.hasAttribute("multiple")?null:1,ge(n.children,p=>{X=p.tagName.toLowerCase(),X==="optgroup"?u(p):X==="option"&&f(p)})},O=()=>{const X=n.getAttribute(a);if(X)S.options=JSON.parse(X),ge(S.options,x=>{S.items.push(x[d])});else{var F=n.value.trim()||"";if(!t.allowEmptyOption&&!F.length)return;const x=F.split(t.delimiter);ge(x,C=>{const G={};G[i]=C,G[d]=C,S.options.push(G)}),S.items=x}};return v==="select"?_():O(),Object.assign({},La,S,e)}var $a=0;class be extends ss(rs){constructor(e,t){super(),this.order=0,this.isOpen=!1,this.isDisabled=!1,this.isReadOnly=!1,this.isInvalid=!1,this.isValid=!0,this.isLocked=!1,this.isFocused=!1,this.isInputHidden=!1,this.isSetup=!1,this.ignoreFocus=!1,this.ignoreHover=!1,this.hasOptions=!1,this.lastValue="",this.caretPos=0,this.loading=0,this.loadedSearches={},this.activeOption=null,this.activeItems=[],this.optgroups={},this.options={},this.userOptions={},this.items=[],this.refreshTimeout=null,$a++;var a,i=ze(e);if(i.tomselect)throw new Error("Tom Select already initialized on this element");i.tomselect=this;var d=window.getComputedStyle&&window.getComputedStyle(i,null);a=d.getPropertyValue("direction");const s=Aa(i,t);this.settings=s,this.input=i,this.tabIndex=i.tabIndex||0,this.is_select_tag=i.tagName.toLowerCase()==="select",this.rtl=/rtl/i.test(a),this.inputId=Pn(i,"tomselect-"+$a),this.isRequired=i.required,this.sifter=new _s(this.options,{diacritics:s.diacritics}),s.mode=s.mode||(s.maxItems===1?"single":"multi"),typeof s.hideSelected!="boolean"&&(s.hideSelected=s.mode==="multi"),typeof s.hidePlaceholder!="boolean"&&(s.hidePlaceholder=s.mode!=="multi");var l=s.createFilter;typeof l!="function"&&(typeof l=="string"&&(l=new RegExp(l)),l instanceof RegExp?s.createFilter=F=>l.test(F):s.createFilter=F=>this.settings.duplicates||!this.options[F]),this.initializePlugins(s.plugins),this.setupCallbacks(),this.setupTemplates();const c=ze("<div>"),h=ze("<div>"),v=this._render("dropdown"),I=ze('<div role="listbox" tabindex="-1">'),S=this.input.getAttribute("class")||"",_=s.mode;var O;if(Le(c,s.wrapperClass,S,_),Le(h,s.controlClass),ft(c,h),Le(v,s.dropdownClass,_),s.copyClassesToDropdown&&Le(v,S),Le(I,s.dropdownContentClass),ft(v,I),ze(s.dropdownParent||c).appendChild(v),Ci(s.controlInput)){O=ze(s.controlInput);var X=["autocorrect","autocapitalize","autocomplete","spellcheck"];ge(X,F=>{i.getAttribute(F)&&ue(O,{[F]:i.getAttribute(F)})}),O.tabIndex=-1,h.appendChild(O),this.focus_node=O}else s.controlInput?(O=ze(s.controlInput),this.focus_node=O):(O=ze("<input/>"),this.focus_node=h);this.wrapper=c,this.dropdown=v,this.dropdown_content=I,this.control=h,this.control_input=O,this.setup()}setup(){const e=this,t=e.settings,a=e.control_input,i=e.dropdown,d=e.dropdown_content,s=e.wrapper,l=e.control,c=e.input,h=e.focus_node,v={passive:!0},I=e.inputId+"-ts-dropdown";ue(d,{id:I}),ue(h,{role:"combobox","aria-haspopup":"listbox","aria-expanded":"false","aria-controls":I});const S=Pn(h,e.inputId+"-ts-control"),_="label[for='"+Cs(e.inputId)+"']",O=document.querySelector(_),X=e.focus.bind(e);if(O){Ie(O,"click",X),ue(O,{for:S});const C=Pn(O,e.inputId+"-ts-label");ue(h,{"aria-labelledby":C}),ue(d,{"aria-labelledby":C})}if(s.style.width=c.style.width,e.plugins.names.length){const C="plugin-"+e.plugins.names.join(" plugin-");Le([s,i],C)}(t.maxItems===null||t.maxItems>1)&&e.is_select_tag&&ue(c,{multiple:"multiple"}),t.placeholder&&ue(a,{placeholder:t.placeholder}),!t.splitOn&&t.delimiter&&(t.splitOn=new RegExp("\\s*"+Ut(t.delimiter)+"+\\s*")),t.load&&t.loadThrottle&&(t.load=Ds(t.load,t.loadThrottle)),Ie(i,"mousemove",()=>{e.ignoreHover=!1}),Ie(i,"mouseenter",C=>{var G=Rn(C.target,"[data-selectable]",i);G&&e.onOptionHover(C,G)},{capture:!0}),Ie(i,"click",C=>{const G=Rn(C.target,"[data-selectable]");G&&(e.onOptionSelect(C,G),fe(C,!0))}),Ie(l,"click",C=>{var G=Rn(C.target,"[data-ts-item]",l);if(G&&e.onItemSelect(C,G)){fe(C,!0);return}a.value==""&&(e.onClick(),fe(C,!0))}),Ie(h,"keydown",C=>e.onKeyDown(C)),Ie(a,"keypress",C=>e.onKeyPress(C)),Ie(a,"input",C=>e.onInput(C)),Ie(h,"blur",C=>e.onBlur(C)),Ie(h,"focus",C=>e.onFocus(C)),Ie(a,"paste",C=>e.onPaste(C));const F=C=>{const G=C.composedPath()[0];if(!s.contains(G)&&!i.contains(G)){e.isFocused&&e.blur(),e.inputState();return}G==a&&e.isOpen?C.stopPropagation():fe(C,!0)},x=()=>{e.isOpen&&e.positionDropdown()};Ie(document,"mousedown",F),Ie(window,"scroll",x,v),Ie(window,"resize",x,v),this._destroy=()=>{document.removeEventListener("mousedown",F),window.removeEventListener("scroll",x),window.removeEventListener("resize",x),O&&O.removeEventListener("click",X)},this.revertSettings={innerHTML:c.innerHTML,tabIndex:c.tabIndex},c.tabIndex=-1,c.insertAdjacentElement("afterend",e.wrapper),e.sync(!1),t.items=[],delete t.optgroups,delete t.options,Ie(c,"invalid",()=>{e.isValid&&(e.isValid=!1,e.isInvalid=!0,e.refreshState())}),e.updateOriginalInput(),e.refreshItems(),e.close(!1),e.inputState(),e.isSetup=!0,c.disabled?e.disable():c.readOnly?e.setReadOnly(!0):e.enable(),e.on("change",this.onChange),Le(c,"tomselected","ts-hidden-accessible"),e.trigger("initialize"),t.preload===!0&&e.preload()}setupOptions(e=[],t=[]){this.addOptions(e),ge(t,a=>{this.registerOptionGroup(a)})}setupTemplates(){var e=this,t=e.settings.labelField,a=e.settings.optgroupLabelField,i={optgroup:d=>{let s=document.createElement("div");return s.className="optgroup",s.appendChild(d.options),s},optgroup_header:(d,s)=>'<div class="optgroup-header">'+s(d[a])+"</div>",option:(d,s)=>"<div>"+s(d[t])+"</div>",item:(d,s)=>"<div>"+s(d[t])+"</div>",option_create:(d,s)=>'<div class="create">Add <strong>'+s(d.input)+"</strong>&hellip;</div>",no_results:()=>'<div class="no-results">No results found</div>',loading:()=>'<div class="spinner"></div>',not_loading:()=>{},dropdown:()=>"<div></div>"};e.settings.render=Object.assign({},i,e.settings.render)}setupCallbacks(){var e,t,a={initialize:"onInitialize",change:"onChange",item_add:"onItemAdd",item_remove:"onItemRemove",item_select:"onItemSelect",clear:"onClear",option_add:"onOptionAdd",option_remove:"onOptionRemove",option_clear:"onOptionClear",optgroup_add:"onOptionGroupAdd",optgroup_remove:"onOptionGroupRemove",optgroup_clear:"onOptionGroupClear",dropdown_open:"onDropdownOpen",dropdown_close:"onDropdownClose",type:"onType",load:"onLoad",focus:"onFocus",blur:"onBlur"};for(e in a)t=this.settings[a[e]],t&&this.on(e,t)}sync(e=!0){const t=this,a=e?Aa(t.input,{delimiter:t.settings.delimiter}):t.settings;t.setupOptions(a.options,a.optgroups),t.setValue(a.items||[],!0),t.lastQuery=null}onClick(){var e=this;if(e.activeItems.length>0){e.clearActiveItems(),e.focus();return}e.isFocused&&e.isOpen?e.blur():e.focus()}onMouseDown(){}onChange(){xn(this.input,"input"),xn(this.input,"change")}onPaste(e){var t=this;if(t.isInputHidden||t.isLocked){fe(e);return}t.settings.splitOn&&setTimeout(()=>{var a=t.inputValue();if(a.match(t.settings.splitOn)){var i=a.trim().split(t.settings.splitOn);ge(i,d=>{Xe(d)&&(this.options[d]?t.addItem(d):t.createItem(d))})}},0)}onKeyPress(e){var t=this;if(t.isLocked){fe(e);return}var a=String.fromCharCode(e.keyCode||e.which);if(t.settings.create&&t.settings.mode==="multi"&&a===t.settings.delimiter){t.createItem(),fe(e);return}}onKeyDown(e){var t=this;if(t.ignoreHover=!0,t.isLocked){e.keyCode!==Ca&&fe(e);return}switch(e.keyCode){case Ms:if(ut(an,e)&&t.control_input.value==""){fe(e),t.selectAll();return}break;case xs:t.isOpen&&(fe(e,!0),t.close()),t.clearActiveItems();return;case Hs:if(!t.isOpen&&t.hasOptions)t.open();else if(t.activeOption){let a=t.getAdjacent(t.activeOption,1);a&&t.setActiveOption(a)}fe(e);return;case Xs:if(t.activeOption){let a=t.getAdjacent(t.activeOption,-1);a&&t.setActiveOption(a)}fe(e);return;case Ps:t.canSelect(t.activeOption)?(t.onOptionSelect(e,t.activeOption),fe(e)):(t.settings.create&&t.createItem()||document.activeElement==t.control_input&&t.isOpen)&&fe(e);return;case Rs:t.advanceSelection(-1,e);return;case Vs:t.advanceSelection(1,e);return;case Ca:t.settings.selectOnTab&&(t.canSelect(t.activeOption)&&(t.onOptionSelect(e,t.activeOption),fe(e)),t.settings.create&&t.createItem()&&fe(e));return;case ka:case Fs:t.deleteSelection(e);return}t.isInputHidden&&!ut(an,e)&&fe(e)}onInput(e){if(this.isLocked)return;const t=this.inputValue();if(this.lastValue!==t){if(this.lastValue=t,t==""){this._onInput();return}this.refreshTimeout&&window.clearTimeout(this.refreshTimeout),this.refreshTimeout=Os(()=>{this.refreshTimeout=null,this._onInput()},this.settings.refreshThrottle)}}_onInput(){const e=this.lastValue;this.settings.shouldLoad.call(this,e)&&this.load(e),this.refreshOptions(),this.trigger("type",e)}onOptionHover(e,t){this.ignoreHover||this.setActiveOption(t,!1)}onFocus(e){var t=this,a=t.isFocused;if(t.isDisabled||t.isReadOnly){t.blur(),fe(e);return}t.ignoreFocus||(t.isFocused=!0,t.settings.preload==="focus"&&t.preload(),a||t.trigger("focus"),t.activeItems.length||(t.inputState(),t.refreshOptions(!!t.settings.openOnFocus)),t.refreshState())}onBlur(e){if(document.hasFocus()!==!1){var t=this;if(t.isFocused){t.isFocused=!1,t.ignoreFocus=!1;var a=()=>{t.close(),t.setActiveItem(),t.setCaret(t.items.length),t.trigger("blur")};t.settings.create&&t.settings.createOnBlur?t.createItem(null,a):a()}}}onOptionSelect(e,t){var a,i=this;t.parentElement&&t.parentElement.matches("[data-disabled]")||(t.classList.contains("create")?i.createItem(null,()=>{i.settings.closeAfterSelect&&i.close()}):(a=t.dataset.value,typeof a<"u"&&(i.lastQuery=null,i.addItem(a),i.settings.closeAfterSelect&&i.close(),!i.settings.hideSelected&&e.type&&/click/.test(e.type)&&i.setActiveOption(t))))}canSelect(e){return!!(this.isOpen&&e&&this.dropdown_content.contains(e))}onItemSelect(e,t){var a=this;return!a.isLocked&&a.settings.mode==="multi"?(fe(e),a.setActiveItem(t,e),!0):!1}canLoad(e){return!(!this.settings.load||this.loadedSearches.hasOwnProperty(e))}load(e){const t=this;if(!t.canLoad(e))return;Le(t.wrapper,t.settings.loadingClass),t.loading++;const a=t.loadCallback.bind(t);t.settings.load.call(t,e,a)}loadCallback(e,t){const a=this;a.loading=Math.max(a.loading-1,0),a.lastQuery=null,a.clearActiveOption(),a.setupOptions(e,t),a.refreshOptions(a.isFocused&&!a.isInputHidden),a.loading||nt(a.wrapper,a.settings.loadingClass),a.trigger("load",e,t)}preload(){var e=this.wrapper.classList;e.contains("preloaded")||(e.add("preloaded"),this.load(""))}setTextboxValue(e=""){var t=this.control_input,a=t.value!==e;a&&(t.value=e,xn(t,"update"),this.lastValue=e)}getValue(){return this.is_select_tag&&this.input.hasAttribute("multiple")?this.items:this.items.join(this.settings.delimiter)}setValue(e,t){var a=t?[]:["change"];Sa(this,a,()=>{this.clear(t),this.addItems(e,t)})}setMaxItems(e){e===0&&(e=null),this.settings.maxItems=e,this.refreshState()}setActiveItem(e,t){var a=this,i,d,s,l,c,h;if(a.settings.mode!=="single"){if(!e){a.clearActiveItems(),a.isFocused&&a.inputState();return}if(i=t&&t.type.toLowerCase(),i==="click"&&ut("shiftKey",t)&&a.activeItems.length){for(h=a.getLastActive(),s=Array.prototype.indexOf.call(a.control.children,h),l=Array.prototype.indexOf.call(a.control.children,e),s>l&&(c=s,s=l,l=c),d=s;d<=l;d++)e=a.control.children[d],a.activeItems.indexOf(e)===-1&&a.setActiveItemClass(e);fe(t)}else i==="click"&&ut(an,t)||i==="keydown"&&ut("shiftKey",t)?e.classList.contains("active")?a.removeActiveItem(e):a.setActiveItemClass(e):(a.clearActiveItems(),a.setActiveItemClass(e));a.inputState(),a.isFocused||a.focus()}}setActiveItemClass(e){const t=this,a=t.control.querySelector(".last-active");a&&nt(a,"last-active"),Le(e,"active last-active"),t.trigger("item_select",e),t.activeItems.indexOf(e)==-1&&t.activeItems.push(e)}removeActiveItem(e){var t=this.activeItems.indexOf(e);this.activeItems.splice(t,1),nt(e,"active")}clearActiveItems(){nt(this.activeItems,"active"),this.activeItems=[]}setActiveOption(e,t=!0){e!==this.activeOption&&(this.clearActiveOption(),e&&(this.activeOption=e,ue(this.focus_node,{"aria-activedescendant":e.getAttribute("id")}),ue(e,{"aria-selected":"true"}),Le(e,"active"),t&&this.scrollToOption(e)))}scrollToOption(e,t){if(!e)return;const a=this.dropdown_content,i=a.clientHeight,d=a.scrollTop||0,s=e.offsetHeight,l=e.getBoundingClientRect().top-a.getBoundingClientRect().top+d;l+s>i+d?this.scroll(l-i+s,t):l<d&&this.scroll(l,t)}scroll(e,t){const a=this.dropdown_content;t&&(a.style.scrollBehavior=t),a.scrollTop=e,a.style.scrollBehavior=""}clearActiveOption(){this.activeOption&&(nt(this.activeOption,"active"),ue(this.activeOption,{"aria-selected":null})),this.activeOption=null,ue(this.focus_node,{"aria-activedescendant":null})}selectAll(){const e=this;if(e.settings.mode==="single")return;const t=e.controlChildren();t.length&&(e.inputState(),e.close(),e.activeItems=t,ge(t,a=>{e.setActiveItemClass(a)}))}inputState(){var e=this;e.control.contains(e.control_input)&&(ue(e.control_input,{placeholder:e.settings.placeholder}),e.activeItems.length>0||!e.isFocused&&e.settings.hidePlaceholder&&e.items.length>0?(e.setTextboxValue(),e.isInputHidden=!0):(e.settings.hidePlaceholder&&e.items.length>0&&ue(e.control_input,{placeholder:""}),e.isInputHidden=!1),e.wrapper.classList.toggle("input-hidden",e.isInputHidden))}inputValue(){return this.control_input.value.trim()}focus(){var e=this;e.isDisabled||e.isReadOnly||(e.ignoreFocus=!0,e.control_input.offsetWidth?e.control_input.focus():e.focus_node.focus(),setTimeout(()=>{e.ignoreFocus=!1,e.onFocus()},0))}blur(){this.focus_node.blur(),this.onBlur()}getScoreFunction(e){return this.sifter.getScoreFunction(e,this.getSearchOptions())}getSearchOptions(){var e=this.settings,t=e.sortField;return typeof e.sortField=="string"&&(t=[{field:e.sortField}]),{fields:e.searchField,conjunction:e.searchConjunction,sort:t,nesting:e.nesting}}search(e){var t,a,i=this,d=this.getSearchOptions();if(i.settings.score&&(a=i.settings.score.call(i,e),typeof a!="function"))throw new Error('Tom Select "score" setting must be a function that returns a function');return e!==i.lastQuery?(i.lastQuery=e,t=i.sifter.search(e,Object.assign(d,{score:a})),i.currentResults=t):t=Object.assign({},i.currentResults),i.settings.hideSelected&&(t.items=t.items.filter(s=>{let l=Xe(s.id);return!(l&&i.items.indexOf(l)!==-1)})),t}refreshOptions(e=!0){var t,a,i,d,s,l,c,h,v,I;const S={},_=[];var O=this,X=O.inputValue();const F=X===O.lastQuery||X==""&&O.lastQuery==null;var x=O.search(X),C=null,G=O.settings.shouldOpen||!1,r=O.dropdown_content;F&&(C=O.activeOption,C&&(v=C.closest("[data-group]"))),d=x.items.length,typeof O.settings.maxOptions=="number"&&(d=Math.min(d,O.settings.maxOptions)),d>0&&(G=!0);const f=(p,y)=>{let m=S[p];if(m!==void 0){let T=_[m];if(T!==void 0)return[m,T.fragment]}let g=document.createDocumentFragment();return m=_.length,_.push({fragment:g,order:y,optgroup:p}),[m,g]};for(t=0;t<d;t++){let p=x.items[t];if(!p)continue;let y=p.id,m=O.options[y];if(m===void 0)continue;let g=ln(y),T=O.getOption(g,!0);for(O.settings.hideSelected||T.classList.toggle("selected",O.items.includes(g)),s=m[O.settings.optgroupField]||"",l=Array.isArray(s)?s:[s],a=0,i=l&&l.length;a<i;a++){s=l[a];let M=m.$order,k=O.optgroups[s];k===void 0?s="":M=k.$order;const[$,R]=f(s,M);a>0&&(T=T.cloneNode(!0),ue(T,{id:m.$id+"-clone-"+a,"aria-selected":null}),T.classList.add("ts-cloned"),nt(T,"active"),O.activeOption&&O.activeOption.dataset.value==y&&v&&v.dataset.group===s.toString()&&(C=T)),R.appendChild(T),s!=""&&(S[s]=$)}}O.settings.lockOptgroupOrder&&_.sort((p,y)=>p.order-y.order),c=document.createDocumentFragment(),ge(_,p=>{let y=p.fragment,m=p.optgroup;if(!y||!y.children.length)return;let g=O.optgroups[m];if(g!==void 0){let T=document.createDocumentFragment(),M=O.render("optgroup_header",g);ft(T,M),ft(T,y);let k=O.render("optgroup",{group:g,options:T});ft(c,k)}else ft(c,y)}),r.innerHTML="",ft(r,c),O.settings.highlight&&($s(r),x.query.length&&x.tokens.length&&ge(x.tokens,p=>{As(r,p.regex)}));var u=p=>{let y=O.render(p,{input:X});return y&&(G=!0,r.insertBefore(y,r.firstChild)),y};if(O.loading?u("loading"):O.settings.shouldLoad.call(O,X)?x.items.length===0&&u("no_results"):u("not_loading"),h=O.canCreate(X),h&&(I=u("option_create")),O.hasOptions=x.items.length>0||h,G){if(x.items.length>0){if(!C&&O.settings.mode==="single"&&O.items[0]!=null&&(C=O.getOption(O.items[0])),!r.contains(C)){let p=0;I&&!O.settings.addPrecedence&&(p=1),C=O.selectable()[p]}}else I&&(C=I);e&&!O.isOpen&&(O.open(),O.scrollToOption(C,"auto")),O.setActiveOption(C)}else O.clearActiveOption(),e&&O.isOpen&&O.close(!1)}selectable(){return this.dropdown_content.querySelectorAll("[data-selectable]")}addOption(e,t=!1){const a=this;if(Array.isArray(e))return a.addOptions(e,t),!1;const i=Xe(e[a.settings.valueField]);return i===null||a.options.hasOwnProperty(i)?!1:(e.$order=e.$order||++a.order,e.$id=a.inputId+"-opt-"+e.$order,a.options[i]=e,a.lastQuery=null,t&&(a.userOptions[i]=t,a.trigger("option_add",i,e)),i)}addOptions(e,t=!1){ge(e,a=>{this.addOption(a,t)})}registerOption(e){return this.addOption(e)}registerOptionGroup(e){var t=Xe(e[this.settings.optgroupValueField]);return t===null?!1:(e.$order=e.$order||++this.order,this.optgroups[t]=e,t)}addOptionGroup(e,t){var a;t[this.settings.optgroupValueField]=e,(a=this.registerOptionGroup(t))&&this.trigger("optgroup_add",a,t)}removeOptionGroup(e){this.optgroups.hasOwnProperty(e)&&(delete this.optgroups[e],this.clearCache(),this.trigger("optgroup_remove",e))}clearOptionGroups(){this.optgroups={},this.clearCache(),this.trigger("optgroup_clear")}updateOption(e,t){const a=this;var i,d;const s=Xe(e),l=Xe(t[a.settings.valueField]);if(s===null)return;const c=a.options[s];if(c==null)return;if(typeof l!="string")throw new Error("Value must be set in option data");const h=a.getOption(s),v=a.getItem(s);if(t.$order=t.$order||c.$order,delete a.options[s],a.uncacheValue(l),a.options[l]=t,h){if(a.dropdown_content.contains(h)){const I=a._render("option",t);Wn(h,I),a.activeOption===h&&a.setActiveOption(I)}h.remove()}v&&(d=a.items.indexOf(s),d!==-1&&a.items.splice(d,1,l),i=a._render("item",t),v.classList.contains("active")&&Le(i,"active"),Wn(v,i)),a.lastQuery=null}removeOption(e,t){const a=this;e=ln(e),a.uncacheValue(e),delete a.userOptions[e],delete a.options[e],a.lastQuery=null,a.trigger("option_remove",e),a.removeItem(e,t)}clearOptions(e){const t=(e||this.clearFilter).bind(this);this.loadedSearches={},this.userOptions={},this.clearCache();const a={};ge(this.options,(i,d)=>{t(i,d)&&(a[d]=i)}),this.options=this.sifter.items=a,this.lastQuery=null,this.trigger("option_clear")}clearFilter(e,t){return this.items.indexOf(t)>=0}getOption(e,t=!1){const a=Xe(e);if(a===null)return null;const i=this.options[a];if(i!=null){if(i.$div)return i.$div;if(t)return this._render("option",i)}return null}getAdjacent(e,t,a="option"){var i=this,d;if(!e)return null;a=="item"?d=i.controlChildren():d=i.dropdown_content.querySelectorAll("[data-selectable]");for(let s=0;s<d.length;s++)if(d[s]==e)return t>0?d[s+1]:d[s-1];return null}getItem(e){if(typeof e=="object")return e;var t=Xe(e);return t!==null?this.control.querySelector(`[data-value="${_a(t)}"]`):null}addItems(e,t){var a=this,i=Array.isArray(e)?e:[e];i=i.filter(s=>a.items.indexOf(s)===-1);const d=i[i.length-1];i.forEach(s=>{a.isPending=s!==d,a.addItem(s,t)})}addItem(e,t){var a=t?[]:["change","dropdown_close"];Sa(this,a,()=>{var i,d;const s=this,l=s.settings.mode,c=Xe(e);if(!(c&&s.items.indexOf(c)!==-1&&(l==="single"&&s.close(),l==="single"||!s.settings.duplicates))&&!(c===null||!s.options.hasOwnProperty(c))&&(l==="single"&&s.clear(t),!(l==="multi"&&s.isFull()))){if(i=s._render("item",s.options[c]),s.control.contains(i)&&(i=i.cloneNode(!0)),d=s.isFull(),s.items.splice(s.caretPos,0,c),s.insertAtCaret(i),s.isSetup){if(!s.isPending&&s.settings.hideSelected){let h=s.getOption(c),v=s.getAdjacent(h,1);v&&s.setActiveOption(v)}!s.isPending&&!s.settings.closeAfterSelect&&s.refreshOptions(s.isFocused&&l!=="single"),s.settings.closeAfterSelect!=!1&&s.isFull()?s.close():s.isPending||s.positionDropdown(),s.trigger("item_add",c,i),s.isPending||s.updateOriginalInput({silent:t})}(!s.isPending||!d&&s.isFull())&&(s.inputState(),s.refreshState())}})}removeItem(e=null,t){const a=this;if(e=a.getItem(e),!e)return;var i,d;const s=e.dataset.value;i=Da(e),e.remove(),e.classList.contains("active")&&(d=a.activeItems.indexOf(e),a.activeItems.splice(d,1),nt(e,"active")),a.items.splice(i,1),a.lastQuery=null,!a.settings.persist&&a.userOptions.hasOwnProperty(s)&&a.removeOption(s,t),i<a.caretPos&&a.setCaret(a.caretPos-1),a.updateOriginalInput({silent:t}),a.refreshState(),a.positionDropdown(),a.trigger("item_remove",s,e)}createItem(e=null,t=()=>{}){arguments.length===3&&(t=arguments[2]),typeof t!="function"&&(t=()=>{});var a=this,i=a.caretPos,d;if(e=e||a.inputValue(),!a.canCreate(e))return t(),!1;a.lock();var s=!1,l=c=>{if(a.unlock(),!c||typeof c!="object")return t();var h=Xe(c[a.settings.valueField]);if(typeof h!="string")return t();a.setTextboxValue(),a.addOption(c,!0),a.setCaret(i),a.addItem(h),t(c),s=!0};return typeof a.settings.create=="function"?d=a.settings.create.call(this,e,l):d={[a.settings.labelField]:e,[a.settings.valueField]:e},s||l(d),!0}refreshItems(){var e=this;e.lastQuery=null,e.isSetup&&e.addItems(e.items),e.updateOriginalInput(),e.refreshState()}refreshState(){const e=this;e.refreshValidityState();const t=e.isFull(),a=e.isLocked;e.wrapper.classList.toggle("rtl",e.rtl);const i=e.wrapper.classList;i.toggle("focus",e.isFocused),i.toggle("disabled",e.isDisabled),i.toggle("readonly",e.isReadOnly),i.toggle("required",e.isRequired),i.toggle("invalid",!e.isValid),i.toggle("locked",a),i.toggle("full",t),i.toggle("input-active",e.isFocused&&!e.isInputHidden),i.toggle("dropdown-active",e.isOpen),i.toggle("has-options",Ls(e.options)),i.toggle("has-items",e.items.length>0)}refreshValidityState(){var e=this;e.input.validity&&(e.isValid=e.input.validity.valid,e.isInvalid=!e.isValid)}isFull(){return this.settings.maxItems!==null&&this.items.length>=this.settings.maxItems}updateOriginalInput(e={}){const t=this;var a,i;const d=t.input.querySelector('option[value=""]');if(t.is_select_tag){let c=function(h,v,I){return h||(h=ze('<option value="'+Mn(v)+'">'+Mn(I)+"</option>")),h!=d&&t.input.append(h),s.push(h),(h!=d||l>0)&&(h.selected=!0),h};const s=[],l=t.input.querySelectorAll("option:checked").length;t.input.querySelectorAll("option:checked").forEach(h=>{h.selected=!1}),t.items.length==0&&t.settings.mode=="single"?c(d,"",""):t.items.forEach(h=>{if(a=t.options[h],i=a[t.settings.labelField]||"",s.includes(a.$option)){const v=t.input.querySelector(`option[value="${_a(h)}"]:not(:checked)`);c(v,h,i)}else a.$option=c(a.$option,h,i)})}else t.input.value=t.getValue();t.isSetup&&(e.silent||t.trigger("change",t.getValue()))}open(){var e=this;e.isLocked||e.isOpen||e.settings.mode==="multi"&&e.isFull()||(e.isOpen=!0,ue(e.focus_node,{"aria-expanded":"true"}),e.refreshState(),nn(e.dropdown,{visibility:"hidden",display:"block"}),e.positionDropdown(),nn(e.dropdown,{visibility:"visible",display:"block"}),e.focus(),e.trigger("dropdown_open",e.dropdown))}close(e=!0){var t=this,a=t.isOpen;e&&(t.setTextboxValue(),t.settings.mode==="single"&&t.items.length&&t.inputState()),t.isOpen=!1,ue(t.focus_node,{"aria-expanded":"false"}),nn(t.dropdown,{display:"none"}),t.settings.hideSelected&&t.clearActiveOption(),t.refreshState(),a&&t.trigger("dropdown_close",t.dropdown)}positionDropdown(){if(this.settings.dropdownParent==="body"){var e=this.control,t=e.getBoundingClientRect(),a=e.offsetHeight+t.top+window.scrollY,i=t.left+window.scrollX;nn(this.dropdown,{width:t.width+"px",top:a+"px",left:i+"px"})}}clear(e){var t=this;if(t.items.length){var a=t.controlChildren();ge(a,i=>{t.removeItem(i,!0)}),t.inputState(),e||t.updateOriginalInput(),t.trigger("clear")}}insertAtCaret(e){const t=this,a=t.caretPos,i=t.control;i.insertBefore(e,i.children[a]||null),t.setCaret(a+1)}deleteSelection(e){var t,a,i,d,s=this;t=e&&e.keyCode===ka?-1:1,a=ks(s.control_input);const l=[];if(s.activeItems.length)d=Oa(s.activeItems,t),i=Da(d),t>0&&i++,ge(s.activeItems,c=>l.push(c));else if((s.isFocused||s.settings.mode==="single")&&s.items.length){const c=s.controlChildren();let h;t<0&&a.start===0&&a.length===0?h=c[s.caretPos-1]:t>0&&a.start===s.inputValue().length&&(h=c[s.caretPos]),h!==void 0&&l.push(h)}if(!s.shouldDelete(l,e))return!1;for(fe(e,!0),typeof i<"u"&&s.setCaret(i);l.length;)s.removeItem(l.pop());return s.inputState(),s.positionDropdown(),s.refreshOptions(!1),!0}shouldDelete(e,t){const a=e.map(i=>i.dataset.value);return!(!a.length||typeof this.settings.onDelete=="function"&&this.settings.onDelete(a,t)===!1)}advanceSelection(e,t){var a,i,d=this;d.rtl&&(e*=-1),!d.inputValue().length&&(ut(an,t)||ut("shiftKey",t)?(a=d.getLastActive(e),a?a.classList.contains("active")?i=d.getAdjacent(a,e,"item"):i=a:e>0?i=d.control_input.nextElementSibling:i=d.control_input.previousElementSibling,i&&(i.classList.contains("active")&&d.removeActiveItem(a),d.setActiveItemClass(i))):d.moveCaret(e))}moveCaret(e){}getLastActive(e){let t=this.control.querySelector(".last-active");if(t)return t;var a=this.control.querySelectorAll(".active");if(a)return Oa(a,e)}setCaret(e){this.caretPos=this.items.length}controlChildren(){return Array.from(this.control.querySelectorAll("[data-ts-item]"))}lock(){this.setLocked(!0)}unlock(){this.setLocked(!1)}setLocked(e=this.isReadOnly||this.isDisabled){this.isLocked=e,this.refreshState()}disable(){this.setDisabled(!0),this.close()}enable(){this.setDisabled(!1)}setDisabled(e){this.focus_node.tabIndex=e?-1:this.tabIndex,this.isDisabled=e,this.input.disabled=e,this.control_input.disabled=e,this.setLocked()}setReadOnly(e){this.isReadOnly=e,this.input.readOnly=e,this.control_input.readOnly=e,this.setLocked()}destroy(){var e=this,t=e.revertSettings;e.trigger("destroy"),e.off(),e.wrapper.remove(),e.dropdown.remove(),e.input.innerHTML=t.innerHTML,e.input.tabIndex=t.tabIndex,nt(e.input,"tomselected","ts-hidden-accessible"),e._destroy(),delete e.input.tomselect}render(e,t){var a,i;const d=this;if(typeof this.settings.render[e]!="function"||(i=d.settings.render[e].call(this,t,Mn),!i))return null;if(i=ze(i),e==="option"||e==="option_create"?t[d.settings.disabledField]?ue(i,{"aria-disabled":"true"}):ue(i,{"data-selectable":""}):e==="optgroup"&&(a=t.group[d.settings.optgroupValueField],ue(i,{"data-group":a}),t.group[d.settings.disabledField]&&ue(i,{"data-disabled":""})),e==="option"||e==="item"){const s=ln(t[d.settings.valueField]);ue(i,{"data-value":s}),e==="item"?(Le(i,d.settings.itemClass),ue(i,{"data-ts-item":""})):(Le(i,d.settings.optionClass),ue(i,{role:"option",id:t.$id}),t.$div=i,d.options[s]=t)}return i}_render(e,t){const a=this.render(e,t);if(a==null)throw"HTMLElement expected";return a}clearCache(){ge(this.options,e=>{e.$div&&(e.$div.remove(),delete e.$div)})}uncacheValue(e){const t=this.getOption(e);t&&t.remove()}canCreate(e){return this.settings.create&&e.length>0&&this.settings.createFilter.call(this,e)}hook(e,t,a){var i=this,d=i[t];i[t]=function(){var s,l;return e==="after"&&(s=d.apply(i,arguments)),l=a.apply(i,arguments),e==="instead"?l:(e==="before"&&(s=d.apply(i,arguments)),s)}}}const zs=(n,e,t,a)=>{n.addEventListener(e,t,a)};function js(){zs(this.input,"change",()=>{this.sync()})}const Us=n=>typeof n>"u"||n===null?null:Gs(n),Gs=n=>typeof n=="boolean"?n?"1":"0":n+"",Ma=(n,e=!1)=>{n&&(n.preventDefault(),e&&n.stopPropagation())},Ws=n=>{if(n.jquery)return n[0];if(n instanceof HTMLElement)return n;if(Ys(n)){var e=document.createElement("template");return e.innerHTML=n.trim(),e.content.firstChild}return document.querySelector(n)},Ys=n=>typeof n=="string"&&n.indexOf("<")>-1;function Ks(n){var e=this,t=e.onOptionSelect;e.settings.hideSelected=!1;const a=Object.assign({className:"tomselect-checkbox",checkedClassNames:void 0,uncheckedClassNames:void 0},n);var i=function(l,c){c?(l.checked=!0,a.uncheckedClassNames&&l.classList.remove(...a.uncheckedClassNames),a.checkedClassNames&&l.classList.add(...a.checkedClassNames)):(l.checked=!1,a.checkedClassNames&&l.classList.remove(...a.checkedClassNames),a.uncheckedClassNames&&l.classList.add(...a.uncheckedClassNames))},d=function(l){setTimeout(()=>{var c=l.querySelector("input."+a.className);c instanceof HTMLInputElement&&i(c,l.classList.contains("selected"))},1)};e.hook("after","setupTemplates",()=>{var s=e.settings.render.option;e.settings.render.option=(l,c)=>{var h=Ws(s.call(e,l,c)),v=document.createElement("input");a.className&&v.classList.add(a.className),v.addEventListener("click",function(S){Ma(S)}),v.type="checkbox";const I=Us(l[e.settings.valueField]);return i(v,!!(I&&e.items.indexOf(I)>-1)),h.prepend(v),h}}),e.on("item_remove",s=>{var l=e.getOption(s);l&&(l.classList.remove("selected"),d(l))}),e.on("item_add",s=>{var l=e.getOption(s);l&&d(l)}),e.hook("instead","onOptionSelect",(s,l)=>{if(l.classList.contains("selected")){l.classList.remove("selected"),e.removeItem(l.dataset.value),e.refreshOptions(),Ma(s,!0);return}t.call(e,s,l),d(l)})}const qs=n=>{if(n.jquery)return n[0];if(n instanceof HTMLElement)return n;if(Qs(n)){var e=document.createElement("template");return e.innerHTML=n.trim(),e.content.firstChild}return document.querySelector(n)},Qs=n=>typeof n=="string"&&n.indexOf("<")>-1;function Zs(n){const e=this,t=Object.assign({className:"clear-button",title:"Clear All",html:a=>`<div class="${a.className}" title="${a.title}">&#10799;</div>`},n);e.on("initialize",()=>{var a=qs(t.html(t));a.addEventListener("click",i=>{e.isLocked||(e.clear(),e.settings.mode==="single"&&e.settings.allowEmptyOption&&e.addItem(""),i.preventDefault(),i.stopPropagation())}),e.control.appendChild(a)})}const Js=(n,e=!1)=>{n&&(n.preventDefault(),e&&n.stopPropagation())},bt=(n,e,t,a)=>{n.addEventListener(e,t,a)},eo=(n,e)=>{if(Array.isArray(n))n.forEach(e);else for(var t in n)n.hasOwnProperty(t)&&e(n[t],t)},to=n=>{if(n.jquery)return n[0];if(n instanceof HTMLElement)return n;if(no(n)){var e=document.createElement("template");return e.innerHTML=n.trim(),e.content.firstChild}return document.querySelector(n)},no=n=>typeof n=="string"&&n.indexOf("<")>-1,ao=(n,e)=>{eo(e,(t,a)=>{t==null?n.removeAttribute(a):n.setAttribute(a,""+t)})},io=(n,e)=>{var t;(t=n.parentNode)==null||t.insertBefore(e,n.nextSibling)},ro=(n,e)=>{var t;(t=n.parentNode)==null||t.insertBefore(e,n)},so=(n,e)=>{do{var t;if(e=(t=e)==null?void 0:t.previousElementSibling,n==e)return!0}while(e&&e.previousElementSibling);return!1};function oo(){var n=this;if(n.settings.mode!=="multi")return;var e=n.lock,t=n.unlock;let a=!0,i;n.hook("after","setupTemplates",()=>{var d=n.settings.render.item;n.settings.render.item=(s,l)=>{const c=to(d.call(n,s,l));ao(c,{draggable:"true"});const h=X=>{a||Js(X),X.stopPropagation()},v=X=>{i=c,setTimeout(()=>{c.classList.add("ts-dragging")},0)},I=X=>{X.preventDefault(),c.classList.add("ts-drag-over"),_(c,i)},S=()=>{c.classList.remove("ts-drag-over")},_=(X,F)=>{F!==void 0&&(so(F,c)?io(X,F):ro(X,F))},O=()=>{var X;document.querySelectorAll(".ts-drag-over").forEach(x=>x.classList.remove("ts-drag-over")),(X=i)==null||X.classList.remove("ts-dragging"),i=void 0;var F=[];n.control.querySelectorAll("[data-value]").forEach(x=>{if(x.dataset.value){let C=x.dataset.value;C&&F.push(C)}}),n.setValue(F)};return bt(c,"mousedown",h),bt(c,"dragstart",v),bt(c,"dragenter",I),bt(c,"dragover",I),bt(c,"dragleave",S),bt(c,"dragend",O),c}}),n.hook("instead","lock",()=>(a=!1,e.call(n))),n.hook("instead","unlock",()=>(a=!0,t.call(n)))}const lo=(n,e=!1)=>{n&&(n.preventDefault(),e&&n.stopPropagation())},co=n=>{if(n.jquery)return n[0];if(n instanceof HTMLElement)return n;if(uo(n)){var e=document.createElement("template");return e.innerHTML=n.trim(),e.content.firstChild}return document.querySelector(n)},uo=n=>typeof n=="string"&&n.indexOf("<")>-1;function fo(n){const e=this,t=Object.assign({title:"Untitled",headerClass:"dropdown-header",titleRowClass:"dropdown-header-title",labelClass:"dropdown-header-label",closeClass:"dropdown-header-close",html:a=>'<div class="'+a.headerClass+'"><div class="'+a.titleRowClass+'"><span class="'+a.labelClass+'">'+a.title+'</span><a class="'+a.closeClass+'">&times;</a></div></div>'},n);e.on("initialize",()=>{var a=co(t.html(t)),i=a.querySelector("."+t.closeClass);i&&i.addEventListener("click",d=>{lo(d,!0),e.close()}),e.dropdown.insertBefore(a,e.dropdown.firstChild)})}const po=(n,e)=>{if(Array.isArray(n))n.forEach(e);else for(var t in n)n.hasOwnProperty(t)&&e(n[t],t)},ho=(n,...e)=>{var t=mo(e);n=go(n),n.map(a=>{t.map(i=>{a.classList.remove(i)})})},mo=n=>{var e=[];return po(n,t=>{typeof t=="string"&&(t=t.trim().split(/[\t\n\f\r\s]/)),Array.isArray(t)&&(e=e.concat(t))}),e.filter(Boolean)},go=n=>(Array.isArray(n)||(n=[n]),n),vo=(n,e)=>{if(!n)return-1;e=e||n.nodeName;for(var t=0;n=n.previousElementSibling;)n.matches(e)&&t++;return t};function yo(){var n=this;n.hook("instead","setCaret",e=>{n.settings.mode==="single"||!n.control.contains(n.control_input)?e=n.items.length:(e=Math.max(0,Math.min(n.items.length,e)),e!=n.caretPos&&!n.isPending&&n.controlChildren().forEach((t,a)=>{a<e?n.control_input.insertAdjacentElement("beforebegin",t):n.control.appendChild(t)})),n.caretPos=e}),n.hook("instead","moveCaret",e=>{if(!n.isFocused)return;const t=n.getLastActive(e);if(t){const a=vo(t);n.setCaret(e>0?a+1:a),n.setActiveItem(),ho(t,"last-active")}else n.setCaret(n.caretPos+e)})}const Eo=27,Io=9,wo=(n,e=!1)=>{n&&(n.preventDefault(),e&&n.stopPropagation())},bo=(n,e,t,a)=>{n.addEventListener(e,t,a)},To=(n,e)=>{if(Array.isArray(n))n.forEach(e);else for(var t in n)n.hasOwnProperty(t)&&e(n[t],t)},Pa=n=>{if(n.jquery)return n[0];if(n instanceof HTMLElement)return n;if(No(n)){var e=document.createElement("template");return e.innerHTML=n.trim(),e.content.firstChild}return document.querySelector(n)},No=n=>typeof n=="string"&&n.indexOf("<")>-1,So=(n,...e)=>{var t=_o(e);n=Oo(n),n.map(a=>{t.map(i=>{a.classList.add(i)})})},_o=n=>{var e=[];return To(n,t=>{typeof t=="string"&&(t=t.trim().split(/[\t\n\f\r\s]/)),Array.isArray(t)&&(e=e.concat(t))}),e.filter(Boolean)},Oo=n=>(Array.isArray(n)||(n=[n]),n);function Do(){const n=this;n.settings.shouldOpen=!0,n.hook("before","setup",()=>{n.focus_node=n.control,So(n.control_input,"dropdown-input");const e=Pa('<div class="dropdown-input-wrap">');e.append(n.control_input),n.dropdown.insertBefore(e,n.dropdown.firstChild);const t=Pa('<input class="items-placeholder" tabindex="-1" />');t.placeholder=n.settings.placeholder||"",n.control.append(t)}),n.on("initialize",()=>{n.control_input.addEventListener("keydown",t=>{switch(t.keyCode){case Eo:n.isOpen&&(wo(t,!0),n.close()),n.clearActiveItems();return;case Io:n.focus_node.tabIndex=-1;break}return n.onKeyDown.call(n,t)}),n.on("blur",()=>{n.focus_node.tabIndex=n.isDisabled?-1:n.tabIndex}),n.on("dropdown_open",()=>{n.control_input.focus()});const e=n.onBlur;n.hook("instead","onBlur",t=>{if(!(t&&t.relatedTarget==n.control_input))return e.call(n)}),bo(n.control_input,"blur",()=>n.onBlur()),n.hook("before","close",()=>{n.isOpen&&n.focus_node.focus({preventScroll:!0})})})}const rn=(n,e,t,a)=>{n.addEventListener(e,t,a)};function ko(){var n=this;n.on("initialize",()=>{var e=document.createElement("span"),t=n.control_input;e.style.cssText="position:absolute; top:-99999px; left:-99999px; width:auto; padding:0; white-space:pre; ",n.wrapper.appendChild(e);var a=["letterSpacing","fontSize","fontFamily","fontWeight","textTransform"];for(const d of a)e.style[d]=t.style[d];var i=()=>{e.textContent=t.value,t.style.width=e.clientWidth+"px"};i(),n.on("update item_add item_remove",i),rn(t,"input",i),rn(t,"keyup",i),rn(t,"blur",i),rn(t,"update",i)})}function Co(){var n=this,e=n.deleteSelection;this.hook("instead","deleteSelection",t=>n.activeItems.length?e.call(n,t):!1)}function Lo(){this.hook("instead","setActiveItem",()=>{}),this.hook("instead","selectAll",()=>{})}const xa=37,Ao=39,$o=(n,e,t)=>{for(;n&&n.matches;){if(n.matches(e))return n;n=n.parentNode}},Mo=(n,e)=>{if(!n)return-1;e=e||n.nodeName;for(var t=0;n=n.previousElementSibling;)n.matches(e)&&t++;return t};function Po(){var n=this,e=n.onKeyDown;n.hook("instead","onKeyDown",t=>{var a,i,d,s;if(!n.isOpen||!(t.keyCode===xa||t.keyCode===Ao))return e.call(n,t);n.ignoreHover=!0,s=$o(n.activeOption,"[data-group]"),a=Mo(n.activeOption,"[data-selectable]"),s&&(t.keyCode===xa?s=s.previousSibling:s=s.nextSibling,s&&(d=s.querySelectorAll("[data-selectable]"),i=d[Math.min(d.length-1,a)],i&&n.setActiveOption(i)))})}const xo=n=>(n+"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;"),Ra=(n,e=!1)=>{n&&(n.preventDefault(),e&&n.stopPropagation())},Xa=(n,e,t,a)=>{n.addEventListener(e,t,a)},Va=n=>{if(n.jquery)return n[0];if(n instanceof HTMLElement)return n;if(Ro(n)){var e=document.createElement("template");return e.innerHTML=n.trim(),e.content.firstChild}return document.querySelector(n)},Ro=n=>typeof n=="string"&&n.indexOf("<")>-1;function Xo(n){const e=Object.assign({label:"&times;",title:"Remove",className:"remove",append:!0},n);var t=this;if(e.append){var a='<a href="javascript:void(0)" class="'+e.className+'" tabindex="-1" title="'+xo(e.title)+'">'+e.label+"</a>";t.hook("after","setupTemplates",()=>{var i=t.settings.render.item;t.settings.render.item=(d,s)=>{var l=Va(i.call(t,d,s)),c=Va(a);return l.appendChild(c),Xa(c,"mousedown",h=>{Ra(h,!0)}),Xa(c,"click",h=>{t.isLocked||(Ra(h,!0),!t.isLocked&&t.shouldDelete([l],h)&&(t.removeItem(l),t.refreshOptions(!1),t.inputState()))}),l}})}}function Vo(n){const e=this,t=Object.assign({text:a=>a[e.settings.labelField]},n);e.on("item_remove",function(a){if(e.isFocused&&e.control_input.value.trim()===""){var i=e.options[a];i&&e.setTextboxValue(t.text.call(e,i))}})}const Ho=(n,e)=>{if(Array.isArray(n))n.forEach(e);else for(var t in n)n.hasOwnProperty(t)&&e(n[t],t)},Fo=(n,...e)=>{var t=Bo(e);n=zo(n),n.map(a=>{t.map(i=>{a.classList.add(i)})})},Bo=n=>{var e=[];return Ho(n,t=>{typeof t=="string"&&(t=t.trim().split(/[\t\n\f\r\s]/)),Array.isArray(t)&&(e=e.concat(t))}),e.filter(Boolean)},zo=n=>(Array.isArray(n)||(n=[n]),n);function jo(){const n=this,e=n.canLoad,t=n.clearActiveOption,a=n.loadCallback;var i={},d,s=!1,l,c=[];if(n.settings.shouldLoadMore||(n.settings.shouldLoadMore=()=>{if(d.clientHeight/(d.scrollHeight-d.scrollTop)>.9)return!0;if(n.activeOption){var S=n.selectable(),_=Array.from(S).indexOf(n.activeOption);if(_>=S.length-2)return!0}return!1}),!n.settings.firstUrl)throw"virtual_scroll plugin requires a firstUrl() method";n.settings.sortField=[{field:"$order"},{field:"$score"}];const h=I=>typeof n.settings.maxOptions=="number"&&d.children.length>=n.settings.maxOptions?!1:!!(I in i&&i[I]),v=(I,S)=>n.items.indexOf(S)>=0||c.indexOf(S)>=0;n.setNextUrl=(I,S)=>{i[I]=S},n.getUrl=I=>{if(I in i){const S=i[I];return i[I]=!1,S}return n.clearPagination(),n.settings.firstUrl.call(n,I)},n.clearPagination=()=>{i={}},n.hook("instead","clearActiveOption",()=>{if(!s)return t.call(n)}),n.hook("instead","canLoad",I=>I in i?h(I):e.call(n,I)),n.hook("instead","loadCallback",(I,S)=>{if(!s)n.clearOptions(v);else if(l){const _=I[0];_!==void 0&&(l.dataset.value=_[n.settings.valueField])}a.call(n,I,S),s=!1}),n.hook("after","refreshOptions",()=>{const I=n.lastValue;var S;h(I)?(S=n.render("loading_more",{query:I}),S&&(S.setAttribute("data-selectable",""),l=S)):I in i&&!d.querySelector(".no-results")&&(S=n.render("no_more_results",{query:I})),S&&(Fo(S,n.settings.optionClass),d.append(S))}),n.on("initialize",()=>{c=Object.keys(n.options),d=n.dropdown_content,n.settings.render=Object.assign({},{loading_more:()=>'<div class="loading-more-results">Loading more results ... </div>',no_more_results:()=>'<div class="no-more-results">No more results</div>'},n.settings.render),d.addEventListener("scroll",()=>{n.settings.shouldLoadMore.call(n)&&h(n.lastValue)&&(s||(s=!0,n.load.call(n,n.lastValue)))})})}be.define("change_listener",js);be.define("checkbox_options",Ks);be.define("clear_button",Zs);be.define("drag_drop",oo);be.define("dropdown_header",fo);be.define("caret_position",yo);be.define("dropdown_input",Do);be.define("input_autogrow",ko);be.define("no_backspace_delete",Co);be.define("no_active_items",Lo);be.define("optgroup_columns",Po);be.define("remove_button",Xo);be.define("restore_on_backspace",Vo);be.define("virtual_scroll",jo);class Uo{spectresToCreate=[];spectresToDelete=[];spectresToUpdate=[];constructor(){}async Initialize(){const e=E.sceneItems.filter(t=>t.metadata[`${o.SPECTREID}/isSpectre`]===!0);for(const t of e)await this.SetupGhostSelect(t)}async Run(){const t=E.sceneItems.filter(a=>a.metadata[`${o.SPECTREID}/isSpectre`]===!0).filter(a=>a.metadata[`${o.SPECTREID}/spectreViewers`].includes(E.playerId));if(t.length>0){for(const i of t){const d=E.sceneLocal.find(s=>s.metadata[`${o.SPECTREID}/isLocalSpectre`]===i.id);if(!d)this.CreateSpectreToQueue(i);else{const s=i.position.x===d.position.x&&i.position.y===d.position.y,l=i.scale.x===d.scale.x&&i.scale.y===d.scale.y,c=i.rotation===d.rotation,h=i.layer===d.layer;(!c||!l||!h||!s)&&this.UpdateSpectreToQueue(i,d)}}const a=E.sceneLocal.filter(i=>Br(i));for(const i of a)t.find(s=>s.id===i.metadata[`${o.SPECTREID}/isLocalSpectre`])||this.spectresToDelete.push(i.id);this.spectresToCreate.length>0&&await w.scene.local.addItems(this.spectresToCreate),this.spectresToDelete.length>0&&await w.scene.local.deleteItems(this.spectresToDelete),this.spectresToUpdate.length>0&&await w.scene.local.updateItems(a.filter(i=>!this.spectresToDelete.includes(i.id)),i=>{for(let d of i){const s=this.spectresToUpdate.find(l=>l.id===d.id);s&&(d.layer=s.layer,d.scale=s.scale,d.rotation=s.rotation,d.position=s.position)}}),this.spectresToCreate=[],this.spectresToUpdate=[],this.spectresToDelete=[]}else{const a=E.sceneLocal.filter(i=>i.metadata[`${o.SPECTREID}/isLocalSpectre`]!==void 0);a.length>0&&await w.scene.local.deleteItems(a.map(i=>i.id))}}CreateSpectreToQueue(e){const t=un({height:e.image.height,width:e.image.width,url:e.image.url,mime:e.image.mime},{dpi:e.grid.dpi,offset:e.grid.offset}).position(e.position).scale(e.scale).text(e.text).rotation(e.rotation).attachedTo(e.id).layer(e.layer).metadata({[`${o.SPECTREID}/isLocalSpectre`]:e.id}).disableHit(!1).build();E.playerRole==="GM"&&(t.attachedTo=e.id,t.disableHit=!0),this.spectresToCreate.push(t)}UpdateSpectreToQueue(e,t){const a={id:t.id,position:e.position,rotation:e.rotation,scale:e.scale,layer:e.layer};this.spectresToUpdate.push(a)}async HandleLocalMovement(e){const t=e.filter(a=>a.metadata[`${o.SPECTREID}/isLocalSpectre`]!==void 0);if(t.length>0){const a=[];for(const i of t){const d=E.sceneLocal.find(h=>h.id===i.id);if(!d)continue;const s=i.position.x===d.position.x&&i.position.y===d.position.y,l=i.scale.x===d.scale.x&&i.scale.y===d.scale.y,c=i.rotation===d.rotation;if(!s||!l||!c){const h=E.sceneItems.find(v=>v.id===d.metadata[`${o.SPECTREID}/isLocalSpectre`]);if(h){const v={id:h.id,position:d.position,scale:d.scale,rotation:d.rotation};a.push(v)}}}a.length>0&&await w.scene.items.updateItems(a.map(i=>i.id),i=>{for(let d of i){const s=a.find(l=>l.id===d.id);s&&(d.position=s.position,d.scale=s.scale,d.rotation=s.rotation)}})}}async SetupGhostSelect(e){const t=e.text?.plainText||e.name,a=document.getElementById("ghostList"),i=document.createElement("tr");i.id=`tr-${e.id}`,i.className="ghost-table-entry",i.innerHTML=`<td class="token-name">${t}</td>
            <td><select id="select-${e.id}" class="tSelects" multiple autocomplete="off" /></td>
            <td><input type="button" class="mysteryButton" id="deleteGhost-${e.id}" value="Delete"/></td>`,a.appendChild(i);const d=document.getElementById(`select-${e.id}`),l=Object.keys(E.sceneMetadata).filter(_=>_.startsWith(`${o.EXTENSIONID}/USER-`)).map(_=>{const O=E.sceneMetadata[_];return O.id=_.replace(`${o.EXTENSIONID}/USER-`,""),O});for(const _ of l){if(_.id===E.playerId)continue;const O=document.createElement("option");O.value=_.id,O.text=_.name,d.appendChild(O)}let c=e.metadata[`${o.SPECTREID}/spectreViewers`];c||(c=[E.playerId]);let h=c.filter(_=>_!==E.playerId);console.log("CurrentViewers: "+c.toString());const v={plugins:{remove_button:{title:"Remove this item"}},allowEmptyOption:!0,placeholder:E.party.length===0?"No Players Present":"Choose..",maxItems:null,items:h,create:!1,onDelete:async function(_,O){const X=O.currentTarget.parentElement.parentElement.parentElement.parentElement.parentElement.id.slice(3);await w.scene.items.updateItems([X],F=>{const x=F[0].metadata[`${o.SPECTREID}/spectreViewers`],C=x.findIndex(G=>G===_);x.splice(C,1),F[0].metadata[`${o.SPECTREID}/spectreViewers`]=x})},onItemAdd:async function(_,O){const X=O.parentElement.parentElement.parentElement.parentElement.id.slice(3);await w.scene.items.updateItems([X],F=>{const x=F[0].metadata[`${o.SPECTREID}/spectreViewers`];x.push(_),F[0].metadata[`${o.SPECTREID}/spectreViewers`]=x})}};new be(`#select-${e.id}`,v);const I=document.getElementById(`deleteGhost-${e.id}`);I.onclick=async()=>{const _=E.sceneLocal.findIndex(O=>O.id===e.id);E.sceneLocal.splice(_,1),i.remove(),await w.scene.items.deleteItems([e.id])};const S=document.getElementsByClassName("ts-control");for(let _ of S){const O=_;O.style.backgroundColor=E.theme.mode==="DARK"?"rgb(49, 49, 65)":"rgb(210, 210, 223)",O.style.borderRadius="6px"}}UpdateSpectreTargets(){const e=document.querySelectorAll(".tSelects");for(const t of e)if(t&&t.tomselect){const a=t.tomselect,i=[];for(const d of E.party)i.push({value:d.id,text:d.name});a.addOption(i),i.length===0?(a.settings.placeholder="No Players Present",a.inputState()):(a.settings.placeholder="Choose..",a.inputState())}}}const Ot=new Uo;class Ha{static CreateSkPath(e,t=0,a=!0){if(e.length===0)return[[0]];const i=[];if(i.push([me.MOVE,e[0].x,e[0].y]),t!==0&&e.length>2){const d=this.getTensionPoints(e,t,a),s=d.length;!a&&s>1&&i.push([me.QUAD,d[0].x,d[0].y,d[1].x,d[1].y]);for(let l=a?0:2;l<s-1;l+=3){const c=d[l],h=d[l+1],v=d[l+2];this.bezierCurveTo(i,c.x,c.y,h.x,h.y,v.x,v.y)}!a&&s>0&&i.push([me.QUAD,d[s-1].x,d[s-1].y,e[e.length-1].x,e[e.length-1].y])}else for(let d=1;d<e.length;d++)i.push([me.LINE,e[d].x,e[d].y]);return a&&i.push([me.CLOSE]),i}static allAreFinite(e){for(var t=0;t<e.length;t++)if(e[t]!==void 0&&!Number.isFinite(e[t]))return!1;return!0}static bezierCurveTo(e,t,a,i,d,s,l){this.allAreFinite([t,a,i,d,s,l])&&(e.length===0&&e.push([me.MOVE,t,a]),e.push([me.CUBIC,t,a,i,d,s,l]))}static getTensionPoints(e,t,a){return a?this.getTensionPointsClosed(e,t):this.expandPoints(e,t)}static getTensionPointsClosed(e,t){const a=e.length,i=this.getControlPoints(e[a-1],e[0],e[1],t),d=this.getControlPoints(e[a-2],e[a-1],e[0],t),s=this.expandPoints(e,t);return[i[1]].concat(s).concat([d[0],e[a-1],d[1],i[0],e[0]])}static expandPoints(e,t){const a=[];for(let i=1;i<e.length-1;i++){const[d,s]=this.getControlPoints(e[i-1],e[i],e[i+1],t);isNaN(d.x)||a.push(d,e[i],s)}return a}static getControlPoints(e,t,a,i){const d=at.distance(e,t),s=at.distance(t,a),l=d+s;if(l<=0)return[{...e},{...e}];const c=i*d/l,h=i*s/l,v=at.subtract(a,e),I=at.subtract(t,at.multiply(v,c)),S=at.add(t,at.multiply(v,h));return[I,S]}}async function Go(){await w.contextMenu.create({id:`${o.EXTENSIONID}/convert-curve`,icons:[{icon:"/opendoor.svg",label:"Convert to Obstruction",filter:{every:[{key:["metadata",`${o.EXTENSIONID}/elevation`],value:void 0},{key:["metadata",`${o.EXTENSIONID}/isVisionLine`],value:void 0},{key:["metadata",`${o.EXTENSIONID}/isFogEffect`],value:void 0}],some:[{key:"layer",value:"DRAWING",coordinator:"||"},{key:"layer",value:"FOG"}],roles:["GM"]}}],async onClick(n){const e=[],t=[];for(const a of n.items)if(a.type==="CURVE"){const i=a;if(i.points.length>2){const d=i.style.tension??0,s=i.style.closed===!0||i.style.fillOpacity!==0;s&&i.points.push(i.points[0]);const l=Ha.CreateSkPath(i.points,d,s),c=On(l,{x:0,y:0},{curveSegments:20}),h=Ne().tension(0).points(c).strokeColor(E.sceneMetadata[`${o.EXTENSIONID}/toolColor`]??o.DEFAULTLINECOLOR).strokeDash(E.sceneMetadata[`${o.EXTENSIONID}/toolStyle`]??o.DEFAULTLINESTROKE).strokeWidth(we()).tension(d).fillOpacity(0).fillColor("#000000").layer(o.LINELAYER).name("Vision Line (Line)").closed(s).locked(!0).visible(!1).metadata({[`${o.EXTENSIONID}/isVisionLine`]:!0,[`${o.EXTENSIONID}/blocking`]:!0,[`${o.EXTENSIONID}/doubleSided`]:!0}).build();e.push(h),t.push(i.id)}}else if(a.type==="PATH"){const i=a;if(i.commands.length>2){const d=Ne().tension(0).points(On(i.commands,i.position)).strokeColor(E.sceneMetadata[`${o.EXTENSIONID}/toolColor`]??o.DEFAULTLINECOLOR).strokeDash(E.sceneMetadata[`${o.EXTENSIONID}/toolStyle`]??o.DEFAULTLINESTROKE).strokeWidth(we()).fillOpacity(0).fillColor("#000000").layer(o.LINELAYER).name("Vision Line (Line)").closed(!1).locked(!0).visible(!1).metadata({[`${o.EXTENSIONID}/isVisionLine`]:!0,[`${o.EXTENSIONID}/blocking`]:!0,[`${o.EXTENSIONID}/doubleSided`]:!0}).build();e.push(d),t.push(i.id)}}else if(a.type==="LINE"){const i=a,d=Ne().tension(0).points(Wo([i.startPosition,i.endPosition],i.position)).strokeColor(E.sceneMetadata[`${o.EXTENSIONID}/toolColor`]??o.DEFAULTLINECOLOR).strokeDash(E.sceneMetadata[`${o.EXTENSIONID}/toolStyle`]??o.DEFAULTLINESTROKE).strokeWidth(we()).fillOpacity(0).fillColor("#000000").layer(o.LINELAYER).name("Vision Line (Line)").closed(!1).locked(!0).visible(!1).metadata({[`${o.EXTENSIONID}/isVisionLine`]:!0,[`${o.EXTENSIONID}/blocking`]:!0,[`${o.EXTENSIONID}/doubleSided`]:!0}).build();e.push(d),t.push(i.id)}else if(a.type==="SHAPE"){const i=a,d=[];if(i.shapeType==="CIRCLE"){const s=Math.min(i.width,i.height)/2,l=2*Math.PI/20;for(let c=0;c<20;c++){const h=c*l,v=s*Math.cos(h),I=s*Math.sin(h);d.push({x:v,y:I})}}else if(i.shapeType==="RECTANGLE"){const c=0+i.width,h=0+i.height;d.push({x:0,y:0}),d.push({x:c,y:0}),d.push({x:c,y:h}),d.push({x:0,y:h})}else if(i.shapeType==="HEXAGON"){const s=i.width/2,l=[Math.PI/2,Math.PI/6,11*Math.PI/6,3*Math.PI/2,7*Math.PI/6,5*Math.PI/6];for(let c=0;c<6;c++){const h=l[c],v=s*Math.cos(h),I=s*Math.sin(h);d.push({x:v,y:I})}}else i.shapeType==="TRIANGLE"&&(d.push({x:0,y:0}),d.push({x:0-i.width/2,y:0+i.height}),d.push({x:0+i.width/2,y:0+i.height}));if(d.length>0){d.push(d[0]);let s=d;if(i.shapeType==="CIRCLE"){const c=Ha.CreateSkPath(d,.25,!0);s=On(c,{x:0,y:0},{curveSegments:20})}const l=Ne().tension(0).points(s).position(i.position).rotation(i.rotation).strokeColor(E.sceneMetadata[`${o.EXTENSIONID}/toolColor`]??o.DEFAULTLINECOLOR).strokeDash(E.sceneMetadata[`${o.EXTENSIONID}/toolStyle`]??o.DEFAULTLINESTROKE).strokeWidth(we()).fillOpacity(0).fillColor("#000000").layer(o.LINELAYER).name("Vision Line (Line)").closed(!1).locked(!0).visible(!1).metadata({[`${o.EXTENSIONID}/isVisionLine`]:!0,[`${o.EXTENSIONID}/blocking`]:!0,[`${o.EXTENSIONID}/doubleSided`]:!0}).build();e.push(l),t.push(i.id)}}if(e.length>0){for(let i=0;i<e.length;i+=5){const d=e.slice(i,i+5);await w.scene.items.addItems(d)}await w.scene.items.deleteItems(t)}}}),await w.contextMenu.create({id:`${o.EXTENSIONID}/toggle-vision-menu`,icons:[{icon:"/no-vision.svg",label:"Enable Vision",filter:{every:[{key:["metadata",`${o.EXTENSIONID}/hasVision`],operator:"==",value:void 0,coordinator:"&&"},{key:["metadata",`${o.SPECTREID}/isSpectre`],operator:"==",value:void 0}],some:[{key:"layer",value:"CHARACTER",coordinator:"||"},{key:"layer",value:"ATTACHMENT"}]}},{icon:"/icon.svg",label:"Disable Vision",filter:{every:[{key:["metadata",`${o.SPECTREID}/isSpectre`],operator:"==",value:void 0}],some:[{key:"layer",value:"CHARACTER",coordinator:"||"},{key:"layer",value:"ATTACHMENT"}]}}],async onClick(n){const e=n.items.every(t=>t.metadata[`${o.EXTENSIONID}/hasVision`]===void 0);await w.scene.items.updateItems(n.items,t=>{for(const a of t)e?(a.metadata[`${o.EXTENSIONID}/hasVision`]=!0,a.metadata[`${o.EXTENSIONID}/visionRange`]===void 0&&(a.metadata[`${o.EXTENSIONID}/visionRange`]=Ae(),a.metadata[`${o.EXTENSIONID}/visionSourceRange`]=Ve(),a.metadata[`${o.EXTENSIONID}/visionFallOff`]=Ze(),a.metadata[`${o.EXTENSIONID}/visionInAngle`]=rt(),a.metadata[`${o.EXTENSIONID}/visionOutAngle`]=We(),a.metadata[`${o.EXTENSIONID}/visionDark`]=pn())):delete a.metadata[`${o.EXTENSIONID}/hasVision`]})}}),await w.contextMenu.create({id:`${o.EXTENSIONID}/toggle-vision-line`,icons:[{icon:"/icon.svg",label:"Disable Vision Line",filter:{every:[{key:["metadata",`${o.EXTENSIONID}/isVisionLine`],value:!0,coordinator:"&&"},{key:["metadata",`${o.EXTENSIONID}/disabled`],value:void 0}]}},{icon:"/no-vision.svg",label:"Enable Vision Line",filter:{every:[{key:["metadata",`${o.EXTENSIONID}/isVisionLine`],value:!0}]}}],async onClick(n){await w.scene.items.updateItems(n.items,e=>{for(const t of e)t.metadata[`${o.EXTENSIONID}/isVisionLine`]&&t.metadata[`${o.EXTENSIONID}/disabled`]?delete t.metadata[`${o.EXTENSIONID}/disabled`]:t.metadata[`${o.EXTENSIONID}/isVisionLine`]&&(t.metadata[`${o.EXTENSIONID}/disabled`]=!0)})}}),await w.contextMenu.create({id:`${o.EXTENSIONID}/switch-one-sided-type`,icons:[{icon:"/two-sided.svg",label:"Swap to Double-sided",filter:{every:[{key:["metadata",`${o.EXTENSIONID}/isVisionLine`],value:!0,coordinator:"&&"},{key:["metadata",`${o.EXTENSIONID}/isWindow`],value:void 0},{key:["metadata",`${o.EXTENSIONID}/doubleSided`],value:void 0}]}},{icon:"/left-sided.svg",label:"Swap to One-sided",filter:{every:[{key:["metadata",`${o.EXTENSIONID}/isVisionLine`],value:!0,coordinator:"&&"},{key:["metadata",`${o.EXTENSIONID}/isWindow`],value:void 0},{key:["metadata",`${o.EXTENSIONID}/doubleSided`],value:!0}]}}],async onClick(n){await w.scene.items.updateItems(n.items,e=>{for(const t of e)t.metadata[`${o.EXTENSIONID}/isVisionLine`]&&t.metadata[`${o.EXTENSIONID}/doubleSided`]?delete t.metadata[`${o.EXTENSIONID}/doubleSided`]:t.metadata[`${o.EXTENSIONID}/isVisionLine`]&&(t.metadata[`${o.EXTENSIONID}/doubleSided`]=!0)})}}),await w.contextMenu.create({id:`${o.EXTENSIONID}/switch-obstructing-side`,icons:[{icon:"/flip.svg",label:"Swap Obstructing Side",filter:{every:[{key:["metadata",`${o.EXTENSIONID}/isVisionLine`],value:!0,coordinator:"&&"},{key:"type",value:"CURVE",coordinator:"&&"},{key:["metadata",`${o.EXTENSIONID}/doubleSided`],value:void 0}]}}],async onClick(n){await w.scene.items.updateItems(n.items,e=>{for(const t of e){const a=t.points.reverse();t.points=a}})}}),await w.contextMenu.create({id:`${o.EXTENSIONID}/switch-blockage`,icons:[{icon:"/blocked.svg",label:"Swap to Unpassable",filter:{every:[{key:["metadata",`${o.EXTENSIONID}/isVisionLine`],value:!0,coordinator:"&&"},{key:["metadata",`${o.EXTENSIONID}/isWindow`],value:void 0},{key:["metadata",`${o.EXTENSIONID}/blocking`],value:void 0}]}},{icon:"/unblock.svg",label:"Swap to Passable",filter:{every:[{key:["metadata",`${o.EXTENSIONID}/isVisionLine`],value:!0,coordinator:"&&"},{key:["metadata",`${o.EXTENSIONID}/isWindow`],value:void 0},{key:["metadata",`${o.EXTENSIONID}/blocking`],value:!0}]}}],async onClick(n){await w.scene.items.updateItems(n.items,e=>{for(const t of e)t.metadata[`${o.EXTENSIONID}/isVisionLine`]&&t.metadata[`${o.EXTENSIONID}/blocking`]?delete t.metadata[`${o.EXTENSIONID}/blocking`]:t.metadata[`${o.EXTENSIONID}/isVisionLine`]&&(t.metadata[`${o.EXTENSIONID}/blocking`]=!0)})}}),await w.contextMenu.create({id:`${o.EXTENSIONID}/auto-fog-background`,icons:[{icon:"/fog-background.svg",label:"Auto Fog Map",filter:{every:[{key:"layer",value:"MAP"},{key:"type",value:"IMAGE"}],max:1}}],async onClick(n,e){await w.popover.open({id:o.CONTEXTID,url:"/pages/mapcontextembed.html",height:80,width:200,anchorElementId:e})},embed:{url:"/pages/mapcontextembed.html?contextmenu=true",height:80}}),await w.contextMenu.create({id:`${o.EXTENSIONID}/toggle-fog-map`,icons:[{icon:"/fog-background.svg",label:"Convert To Fog Map",filter:{every:[{key:"layer",value:"MAP"},{key:["metadata",`${o.EXTENSIONID}/isFogMap`],value:void 0}]}},{icon:"/fog-background.svg",label:"Convert To Normal Map",filter:{every:[{key:"layer",value:"FOG"},{key:["metadata",`${o.EXTENSIONID}/isFogMap`],value:!0}]}}],async onClick(n){const e=n.items.every(t=>t.metadata[`${o.EXTENSIONID}/isFogMap`]===void 0);await w.scene.items.updateItems(n.items,t=>{for(const a of t)e?(a.layer="FOG",a.zIndex=-1.00000001,a.disableAutoZIndex=!0,a.metadata[`${o.EXTENSIONID}/isFogMap`]=!0):(a.layer="MAP",a.zIndex=-1.00000001,a.disableAutoZIndex=!1,delete a.metadata[`${o.EXTENSIONID}/isFogMap`])})}}),await w.contextMenu.create({id:`${o.EXTENSIONID}/create-window`,icons:[{icon:"/window.svg",label:"Enable Window",filter:{every:[{key:["metadata",`${o.EXTENSIONID}/isVisionLine`],value:!0},{key:["metadata",`${o.EXTENSIONID}/isWindow`],value:void 0}],some:[{key:"layer",value:o.LINELAYER,coordinator:"||"},{key:"layer",value:"DRAWING"}],roles:["GM"]}},{icon:"/window.svg",label:"Disable Window",filter:{every:[{key:["metadata",`${o.EXTENSIONID}/isVisionLine`],value:!0},{key:["metadata",`${o.EXTENSIONID}/isWindow`],value:!0}],some:[{key:"layer",value:o.LINELAYER,coordinator:"||"},{key:"layer",value:"DRAWING"}],roles:["GM"]}}],async onClick(n){const e=n.items.every(t=>t.metadata[`${o.EXTENSIONID}/isWindow`]===void 0);await w.scene.items.updateItems(n.items,t=>{for(const a of t)e?(a.metadata[`${o.EXTENSIONID}/isWindow`]=!0,a.style.strokeDash=[20,20]):(delete a.metadata[`${o.EXTENSIONID}/isWindow`],a.style.strokeDash=o.DEFAULTLINESTROKE)})}}),await w.contextMenu.create({id:`${o.EXTENSIONID}/create-door`,icons:[{icon:"/opendoor.svg",label:"Enable Door",filter:{every:[{key:["metadata",`${o.EXTENSIONID}/isVisionLine`],value:!0},{key:["metadata",`${o.EXTENSIONID}/isDoor`],value:void 0}],some:[{key:"layer",value:o.LINELAYER,coordinator:"||"},{key:"layer",value:"DRAWING"}],roles:["GM"]}},{icon:"/closedoor.svg",label:"Disable Door",filter:{every:[{key:["metadata",`${o.EXTENSIONID}/isVisionLine`],value:!0},{key:["metadata",`${o.EXTENSIONID}/isDoor`],value:!0}],some:[{key:"layer",value:o.LINELAYER,coordinator:"||"},{key:"layer",value:"DRAWING"}],roles:["GM"]}}],async onClick(n){const e=n.items.every(t=>t.metadata[`${o.EXTENSIONID}/isDoor`]===void 0);await w.scene.items.updateItems(n.items,t=>{for(const a of t)e?(a.metadata[`${o.EXTENSIONID}/isDoor`]=!0,a.style.strokeColor=o.DOORCOLOR):(delete a.metadata[`${o.EXTENSIONID}/isDoorLocked`],delete a.metadata[`${o.EXTENSIONID}/doorOpen`],delete a.metadata[`${o.EXTENSIONID}/disabled`],delete a.metadata[`${o.EXTENSIONID}/isDoor`],a.style.strokeColor=E.sceneMetadata[`${o.EXTENSIONID}/toolColor`]??o.DEFAULTLINECOLOR)})}}),await w.contextMenu.create({id:`${o.EXTENSIONID}/open-door`,icons:[{icon:"/opendoor.svg",label:"Open Door",filter:{every:[{key:["metadata",`${o.EXTENSIONID}/isVisionLine`],value:!0},{key:["metadata",`${o.EXTENSIONID}/isDoor`],value:!0},{key:["metadata",`${o.EXTENSIONID}/doorOpen`],value:void 0},{key:["metadata",`${o.EXTENSIONID}/isDoorLocked`],value:void 0}],some:[{key:"layer",value:o.LINELAYER,coordinator:"||"},{key:"layer",value:"DRAWING"}]}},{icon:"/closedoor.svg",label:"Close Door",filter:{every:[{key:["metadata",`${o.EXTENSIONID}/isVisionLine`],value:!0},{key:["metadata",`${o.EXTENSIONID}/isDoor`],value:!0},{key:["metadata",`${o.EXTENSIONID}/doorOpen`],value:!0},{key:["metadata",`${o.EXTENSIONID}/isDoorLocked`],value:void 0}],some:[{key:"layer",value:o.LINELAYER,coordinator:"||"},{key:"layer",value:"DRAWING"}]}}],async onClick(n){await w.scene.items.updateItems(n.items,e=>{for(let t of e)t.metadata[`${o.EXTENSIONID}/isVisionLine`]&&t.metadata[`${o.EXTENSIONID}/disabled`]?(delete t.metadata[`${o.EXTENSIONID}/disabled`],delete t.metadata[`${o.EXTENSIONID}/doorOpen`]):t.metadata[`${o.EXTENSIONID}/isVisionLine`]&&(t.metadata[`${o.EXTENSIONID}/disabled`]=!0,t.metadata[`${o.EXTENSIONID}/doorOpen`]=!0)})}}),await w.contextMenu.create({id:`${o.EXTENSIONID}/toggle-door-lock`,icons:[{icon:"/locked-door.svg",label:"Lock Door",filter:{every:[{key:["metadata",`${o.EXTENSIONID}/isDoorLocked`],value:void 0},{key:["metadata",`${o.EXTENSIONID}/isDoor`],value:!0},{key:["metadata",`${o.EXTENSIONID}/doorOpen`],value:void 0}],some:[{key:"layer",value:o.LINELAYER,coordinator:"||"},{key:"layer",value:"DRAWING"}],roles:["GM"]}},{icon:"/unlocked-door.svg",label:"Unlock Door",filter:{every:[{key:["metadata",`${o.EXTENSIONID}/isVisionLine`],value:!0},{key:["metadata",`${o.EXTENSIONID}/isDoor`],value:!0},{key:["metadata",`${o.EXTENSIONID}/doorOpen`],value:void 0}],some:[{key:"layer",value:o.LINELAYER,coordinator:"||"},{key:"layer",value:"DRAWING"}],roles:["GM"]}}],async onClick(n){const e=n.items.every(t=>t.metadata[`${o.EXTENSIONID}/isDoorLocked`]===void 0);await w.scene.items.updateItems(n.items,t=>{for(const a of t)e?a.metadata[`${o.EXTENSIONID}/isDoorLocked`]=!0:delete a.metadata[`${o.EXTENSIONID}/isDoorLocked`]})}}),await w.contextMenu.create({id:`${o.EXTENSIONID}/toggle-torch`,icons:[{icon:"/light.svg",label:"Enable Torchlight",filter:{every:[{key:["metadata",`${o.EXTENSIONID}/isTorch`],operator:"==",value:void 0},{key:["metadata",`${o.SPECTREID}/isSpectre`],operator:"==",value:void 0}],some:[{key:"layer",value:"PROP",coordinator:"||"},{key:"layer",value:"ATTACHMENT"}]}},{icon:"/no-light.svg",label:"Disable Torchlight",filter:{every:[{key:["metadata",`${o.EXTENSIONID}/isTorch`],operator:"==",value:!0},{key:["metadata",`${o.SPECTREID}/isSpectre`],operator:"==",value:void 0}],some:[{key:"layer",value:"PROP",coordinator:"||"},{key:"layer",value:"ATTACHMENT"}]}}],async onClick(n){const e=n.items.every(t=>t.metadata[`${o.EXTENSIONID}/isTorch`]===void 0);await w.scene.items.updateItems(n.items,t=>{for(const a of t)e?(a.metadata[`${o.EXTENSIONID}/isTorch`]=!0,a.metadata[`${o.EXTENSIONID}/hasVision`]=!0):(delete a.metadata[`${o.EXTENSIONID}/isTorch`],delete a.metadata[`${o.EXTENSIONID}/hasVision`])})}}),await w.contextMenu.create({id:`${o.SPECTREID}/context-menu`,icons:[{icon:"/ghost.svg",label:"Spectre",filter:{every:[{key:"type",value:"IMAGE"},{key:["metadata",`${o.SPECTREID}/isSpectre`],value:void 0,operator:"==",coordinator:"&&"},{key:["metadata",`${o.EXTENSIONID}/hasVision`],operator:"==",value:void 0}]}},{icon:"/ghost.svg",label:"Un-Spectre",filter:{every:[{key:"type",value:"IMAGE"},{key:["metadata",`${o.SPECTREID}/isSpectre`],value:void 0,operator:"!=",coordinator:"&&"},{key:["metadata",`${o.EXTENSIONID}/hasVision`],operator:"==",value:void 0}]}}],async onClick(n){const e=n.items.every(t=>t.metadata[`${o.SPECTREID}/isSpectre`]===!0);if(await w.scene.items.updateItems(n.items,t=>{for(const a of t)e?(delete a.metadata[`${o.SPECTREID}/isSpectre`],delete a.metadata[`${o.SPECTREID}/spectreViewers`],a.visible=!0):(a.metadata[`${o.SPECTREID}/isSpectre`]=!0,a.metadata[`${o.SPECTREID}/spectreViewers`]=[E.playerId],a.visible=!1)}),!e)for(const t of n.items)await Ot.SetupGhostSelect(t)}}),E.sceneMetadata[`${o.EXTENSIONID}/unitContextMenu`]===!0&&await qn(!0),E.sceneMetadata[`${o.EXTENSIONID}/wallContextMenu`]===!0&&await Kn(!0),E.sceneMetadata[`${o.EXTENSIONID}/autoHide`]===!0&&await Yn(!0)}async function Yn(n){n?await w.contextMenu.create({id:`${o.EXTENSIONID}/autohide-toggle`,icons:[{icon:"/autohide-off.svg",label:"Enable Autohide",filter:{every:[{key:["metadata",`${o.EXTENSIONID}/hasVision`],operator:"==",value:void 0,coordinator:"&&"},{key:["metadata",`${o.EXTENSIONID}/isAutoHidden`],operator:"==",value:void 0,coordinator:"&&"},{key:["metadata",`${o.SPECTREID}/isSpectre`],operator:"==",value:void 0}],some:[{key:"layer",value:"CHARACTER",coordinator:"||"},{key:"layer",value:"PROP",coordinator:"||"},{key:"layer",value:"ATTACHMENT"}]}},{icon:"/autohide-on.svg",label:"Disable Autohide",filter:{every:[{key:["metadata",`${o.EXTENSIONID}/isAutoHidden`],operator:"==",value:!0,coordinator:"&&"}],some:[{key:"layer",value:"CHARACTER",coordinator:"||"},{key:"layer",value:"PROP",coordinator:"||"},{key:"layer",value:"ATTACHMENT"}]}}],async onClick(e){const t=e.items.every(a=>a.metadata[`${o.EXTENSIONID}/isAutoHidden`]===void 0);await w.scene.items.updateItems(e.items,a=>{for(const i of a)t?i.metadata[`${o.EXTENSIONID}/isAutoHidden`]=!0:delete i.metadata[`${o.EXTENSIONID}/isAutoHidden`]})}}):await w.contextMenu.remove(`${o.EXTENSIONID}/autohide-toggle`)}async function Kn(n){n?await w.contextMenu.create({id:`${o.EXTENSIONID}/switch-advanced-wall`,icons:[{icon:"/advancedwall.svg",label:"Advanced Settings",filter:{every:[{key:["metadata",`${o.EXTENSIONID}/isVisionLine`],value:!0}]}}],async onClick(e,t){await w.popover.open({id:o.CONTEXTID,url:"/pages/wallcontextembed.html",height:80,width:200,anchorElementId:t})},embed:{url:"/pages/wallcontextembed.html?contextmenu=true",height:80}}):await w.contextMenu.remove(`${o.EXTENSIONID}/switch-advanced-wall`)}async function qn(n){n?await w.contextMenu.create({id:`${o.EXTENSIONID}/context-menu-embed`,icons:[{icon:"/icon.svg",label:"Vision Settings",filter:{every:[{key:["metadata",`${o.EXTENSIONID}/hasVision`],operator:"==",value:!0,coordinator:"&&"},{key:["metadata",`${o.SPECTREID}/isSpectre`],operator:"==",value:void 0}],some:[{key:"layer",value:"CHARACTER",coordinator:"||"},{key:"layer",value:"PROP",coordinator:"||"},{key:"layer",value:"ATTACHMENT"}]}}],async onClick(e,t){await w.popover.open({id:o.CONTEXTID,url:"/pages/unitcontextembed.html",height:170,width:200,anchorElementId:t})},embed:{url:"/pages/unitcontextembed.html?contextmenu=true",height:170}}):await w.contextMenu.remove(`${o.EXTENSIONID}/context-menu-embed`)}function Wo(n,e){return n.map(t=>({x:t.x+e.x,y:t.y+e.y}))}class ee{static PLAYER="PLAYER";static PARTY="PARTY";static SCENEITEMS="SCENEITEMS";static SCENELOCAL="SCENELOCAL";static SCENEMETA="SCENEMETADATA";static SCENEGRID="SCENEGRID";static SCENEFOG="SCENEFOG";static ROOMMETA="ROOMMETADATA";playerId;playerColor;playerName;playerMetadata;playerRole;party;lastParty;fogFilled;fogColor;fogStroke;gridDpi;gridScale;gridSnap;gridType;storedMetaItems;sceneId;sceneItems;sceneLocal;sceneSelected;sceneMetadata;sceneReady;roomMetadata;theme;caches;snap;torchActive;busy;USER_REGISTERED;toolStarted;expectedFogMapId;expectedFogStyle;expectedFogEffect;sceneMetadataHandler;sceneItemsHandler;sceneLocalHandler;sceneGridHandler;sceneReadyHandler;playerHandler;partyHandler;themeHandler;roomHandler;fogHandler;constructor(e){this.playerId="",this.playerName="",this.playerColor="",this.playerMetadata={},this.playerRole="PLAYER",this.party=[],this.lastParty=[],this.fogFilled=!1,this.fogColor="#000",this.fogStroke=5,this.storedMetaItems=[],this.sceneId="",this.sceneItems=[],this.sceneLocal=[],this.sceneSelected=[],this.sceneMetadata={},this.gridDpi=0,this.gridScale=5,this.gridSnap=10,this.gridType="ft",this.sceneReady=!1,this.theme={},this.roomMetadata={},this.snap=!1,this.busy=!1,this.torchActive=!1,this.toolStarted=!1,this.expectedFogMapId="",this.expectedFogStyle="",this.expectedFogEffect="",this.USER_REGISTERED=!1,this.caches=e}async RefreshCache(){if(this.caches.includes(ee.PLAYER)&&(this.playerId=await w.player.getId(),this.playerName=await w.player.getName(),this.playerColor=await w.player.getColor(),this.playerMetadata=await w.player.getMetadata(),this.playerRole=await w.player.getRole()),this.caches.includes(ee.PARTY)&&(this.party=await w.party.getPlayers()),this.caches.includes(ee.SCENEFOG)&&this.sceneReady&&(this.fogColor=await w.scene.fog.getColor(),this.fogFilled=await w.scene.fog.getFilled()),this.caches.includes(ee.SCENEITEMS)&&this.sceneReady&&(this.sceneItems=await w.scene.items.getItems(),this.sceneLocal=await w.scene.local.getItems()),this.caches.includes(ee.SCENEMETA)&&this.sceneReady){this.sceneMetadata=await w.scene.getMetadata();const e=this.sceneMetadata[`${o.EXTENSIONID}/stored`];e&&(this.storedMetaItems=e),this.sceneId=this.sceneMetadata[`${o.EXTENSIONID}/sceneId`],(this.sceneId===""||this.sceneId===void 0)&&await w.scene.setMetadata({[`${o.EXTENSIONID}/sceneId`]:crypto.randomUUID()})}if(this.caches.includes(ee.SCENEGRID)&&this.sceneReady){this.gridDpi=await w.scene.grid.getDpi();const e=await w.scene.grid.getScale();this.gridScale=e.parsed?.multiplier??5,this.gridType=e.parsed.unit}this.caches.includes(ee.ROOMMETA)&&this.sceneReady&&(this.roomMetadata=await w.room.getMetadata())}async InitializeCache(){if(this.sceneReady=await w.scene.isReady(),this.theme=await w.theme.getTheme(),va(this.theme,document),this.caches.includes(ee.PLAYER)&&(this.playerId=await w.player.getId(),this.playerName=await w.player.getName(),this.playerColor=await w.player.getColor(),this.playerMetadata=await w.player.getMetadata(),this.playerRole=await w.player.getRole()),this.caches.includes(ee.PARTY)&&(this.party=await w.party.getPlayers()),this.caches.includes(ee.SCENEFOG)&&this.sceneReady&&(this.fogColor=await w.scene.fog.getColor(),this.fogFilled=await w.scene.fog.getFilled()),this.caches.includes(ee.SCENEITEMS)&&this.sceneReady&&(this.sceneItems=await w.scene.items.getItems(),this.sceneLocal=await w.scene.local.getItems()),this.caches.includes(ee.SCENEMETA)&&this.sceneReady){this.sceneMetadata=await w.scene.getMetadata();const e=this.sceneMetadata[`${o.EXTENSIONID}/stored`];e&&(this.storedMetaItems=e)}if(this.caches.includes(ee.SCENEGRID)&&this.sceneReady){this.gridDpi=await w.scene.grid.getDpi();const e=await w.scene.grid.getScale();this.gridScale=e.parsed?.multiplier??5,this.gridType=e.parsed.unit}this.caches.includes(ee.ROOMMETA)&&this.sceneReady&&(this.roomMetadata=await w.room.getMetadata()),w.broadcast.onMessage(`${o.EXTENSIONID}/ELEVATIONEVENT`,e=>{switch(e.data){case"CANCEL":ta();break;case"FINISH":wi();break;case"UNDO":bi();break}}),w.broadcast.onMessage(`${o.EXTENSIONID}/LINEEVENT`,e=>{switch(e.data){case"CANCEL":Un();break;case"FINISH":hn();break;case"UNDO":hi();break}}),w.broadcast.onMessage(`${o.EXTENSIONID}/POLYGONEVENT`,e=>{switch(e.data){case"CANCEL":Gn();break;case"FINISH":mn();break;case"UNDO":vi();break}}),w.broadcast.onMessage(o.RESETPERSISTID,async e=>{await Ee.ClearPersistence()}),w.broadcast.onMessage(`${o.EXTENSIONID}/FOGBACKGROUNDEVENT`,async e=>{const t=e.data;this.expectedFogMapId=t.MapId,this.expectedFogStyle=t.FogStyle,this.expectedFogEffect=t.FogEffect}),await this.CheckRegistration(),await this.SaveUserToScene()}async SaveUserToScene(){await w.scene.setMetadata({[`${o.EXTENSIONID}/USER-${this.playerId}`]:{role:this.playerRole,name:this.playerName,color:this.playerColor}})}KillHandlers(){this.caches.includes(ee.SCENEMETA)&&this.sceneMetadataHandler!==void 0&&this.sceneMetadataHandler(),this.caches.includes(ee.SCENEITEMS)&&this.sceneItemsHandler!==void 0&&this.sceneItemsHandler(),this.caches.includes(ee.SCENEITEMS)&&this.sceneLocalHandler!==void 0&&this.sceneLocalHandler(),this.caches.includes(ee.SCENEGRID)&&this.sceneGridHandler!==void 0&&this.sceneGridHandler(),this.caches.includes(ee.PLAYER)&&this.playerHandler!==void 0&&this.playerHandler(),this.caches.includes(ee.PARTY)&&this.partyHandler!==void 0&&this.partyHandler(),this.caches.includes(ee.ROOMMETA)&&this.roomHandler!==void 0&&this.roomHandler(),this.caches.includes(ee.SCENEFOG)&&this.fogHandler!==void 0&&this.fogHandler(),this.themeHandler!==void 0&&this.themeHandler()}SetupHandlers(){(this.sceneMetadataHandler===void 0||this.sceneMetadataHandler.length===0)&&this.caches.includes(ee.SCENEMETA)&&(this.sceneMetadataHandler=w.scene.onMetadataChange(async e=>{this.sceneMetadata[`${o.EXTENSIONID}/playerDoors`]===!0&&e[`${o.EXTENSIONID}/playerDoors`]!==!0&&Ee.ClearDoors(),E.playerRole==="GM"&&(this.sceneMetadata[`${o.EXTENSIONID}/unitContextMenu`]!==!0&&e[`${o.EXTENSIONID}/unitContextMenu`]===!0?await qn(!0):this.sceneMetadata[`${o.EXTENSIONID}/unitContextMenu`]===!0&&e[`${o.EXTENSIONID}/unitContextMenu`]!==!0&&await qn(!1),this.sceneMetadata[`${o.EXTENSIONID}/wallContextMenu`]!==!0&&e[`${o.EXTENSIONID}/wallContextMenu`]===!0?await Kn(!0):this.sceneMetadata[`${o.EXTENSIONID}/wallContextMenu`]===!0&&e[`${o.EXTENSIONID}/wallContextMenu`]!==!0&&await Kn(!1),this.sceneMetadata[`${o.EXTENSIONID}/autoHide`]!==!0&&e[`${o.EXTENSIONID}/autoHide`]===!0?await Yn(!0):this.sceneMetadata[`${o.EXTENSIONID}/autoHide`]===!0&&e[`${o.EXTENSIONID}/autoHide`]!==!0&&await Yn(!1)),this.sceneMetadata[`${o.EXTENSIONID}/persistence`]===!0&&e[`${o.EXTENSIONID}/persistence`]!==!0&&Ee.ClearPersistence(),this.sceneMetadata[`${o.EXTENSIONID}/toggleOwnerLines`]!==!0&&e[`${o.EXTENSIONID}/toggleOwnerLines`]===!0?Ee.InitiateOwnerHighlight():this.sceneMetadata[`${o.EXTENSIONID}/toggleOwnerLines`]===!0&&e[`${o.EXTENSIONID}/toggleOwnerLines`]!==!0&&Ee.ClearOwnershipHighlights();const t=e[`${o.EXTENSIONID}/disableVision`];t!==void 0&&(this.sceneMetadata[`${o.EXTENSIONID}/disableVision`]===!0&&e[`${o.EXTENSIONID}/disableVision`]!==!0||this.sceneMetadata[`${o.EXTENSIONID}/disableVision`]!==!0&&e[`${o.EXTENSIONID}/disableVision`]===!0)&&Ee.TogglePersistentLightVisibility(t),this.sceneMetadata=e,await this.OnSceneMetadataChanges(e)})),(this.sceneItemsHandler===void 0||this.sceneItemsHandler.length===0)&&this.caches.includes(ee.SCENEITEMS)&&(this.sceneItemsHandler=w.scene.items.onChange(async e=>{this.sceneItems=e,await this.OnSceneItemsChange(e)}),this.sceneLocalHandler=w.scene.local.onChange(async e=>{const t=[...this.sceneLocal];this.sceneLocal=e,await this.OnSceneLocalChange(t)})),(this.sceneGridHandler===void 0||this.sceneGridHandler.length===0)&&this.caches.includes(ee.SCENEGRID)&&(this.sceneGridHandler=w.scene.grid.onChange(async e=>{await this.OnSceneGridChange(e),this.gridDpi=e.dpi,this.gridScale=parseInt(e.scale)})),(this.playerHandler===void 0||this.playerHandler.length===0)&&this.caches.includes(ee.PLAYER)&&(this.playerHandler=w.player.onChange(async e=>{const t=this.playerRole;let a=!1;(this.playerName!==e.name||this.playerColor!==e.color||this.playerRole!==e.role)&&(a=!0),this.playerName=e.name,this.playerColor=e.color,this.playerId=e.id,this.playerRole=e.role,this.playerMetadata=e.metadata,await this.OnPlayerChange(e,t),a&&await this.SaveUserToScene()})),(this.partyHandler===void 0||this.partyHandler.length===0)&&this.caches.includes(ee.PARTY)&&(this.partyHandler=w.party.onChange(async e=>{this.party=e.filter(t=>t.id!==""),await this.OnPartyChange(e)})),(this.roomHandler===void 0||this.roomHandler.length===0)&&this.caches.includes(ee.ROOMMETA)&&(this.roomHandler=w.room.onMetadataChange(async e=>{await this.OnRoomMetadataChange(e),this.roomMetadata=e})),(this.fogHandler===void 0||this.fogHandler.length===0)&&this.caches.includes(ee.SCENEFOG)&&(this.fogHandler=w.scene.fog.onChange(async e=>{this.fogColor=e.style.color,this.fogFilled=e.filled,await this.OnFogChange(e)})),this.themeHandler===void 0&&(this.themeHandler=w.theme.onChange(async e=>{this.theme=e,await this.OnThemeChange(e)})),this.sceneReadyHandler===void 0&&(this.sceneReadyHandler=w.scene.onReadyChange(async e=>{this.sceneReady=e,await this.OnSceneReadyChange(e)}))}async OnSceneMetadataChanges(e){this.playerRole,await ie.OnDataChange()}async OnSceneItemsChange(e){if(this.expectedFogMapId!==""){const t=e.filter(a=>a.id===this.expectedFogMapId);if(t.length>0){const a=t[0];await Si(a,this.expectedFogEffect),this.expectedFogMapId="",this.expectedFogStyle="",this.expectedFogEffect=""}}await ie.OnDataChange()}async OnSceneLocalChange(e){await Ot.HandleLocalMovement(e)}async OnSceneGridChange(e){await ie.OnDataChange()}async OnSceneReadyChange(e){e?(await this.SaveUserToScene(),await this.RefreshCache(),await Ee.Reset(),await ie.Start(),this.SetupHandlers()):(this.KillHandlers(),await ie.Stop(),this.sceneItems=[],this.sceneMetadata={},this.playerRole==="GM"&&(this.toolStarted=!1),await w.tool.setMetadata(`${o.EXTENSIONID}/vision-tool`,{[`${o.EXTENSIONID}/elevationEditor`]:!1}))}async OnPlayerChange(e,t){if(this.playerRole!==t&&(await ie.Stop(),await Ee.Reset(),await ie.Start()),e.role==="GM"){const a=document.querySelectorAll(".token-table-entry");for(let h of a){let v=h.id.substring(3);e.selection!==void 0&&e.selection.includes(v)?h.classList.add("token-table-selected"):h.classList.remove("token-table-selected")}const i=e.metadata;(i[`${o.EXTENSIONID}/finishLine`]??!1)===!0&&hn(),(i[`${o.EXTENSIONID}/cancelLine`]??!1)===!0&&Un(),(i[`${o.EXTENSIONID}/finishPoly`]??!1)===!0&&mn(),(i[`${o.EXTENSIONID}/cancelPoly`]??!1)===!0&&Gn()}e.selection!==void 0&&e.selection.length===1&&Ee.ToggleDoor(e.selection[0])}async OnPartyChange(e){if(this.playerRole!=="PLAYER"){const t=document.getElementById("playerListing");t.innerHTML="",t.appendChild(ie.GetEmptyContextItem("Self"));const a=document.getElementById("preview_select");a.innerHTML="";const i=document.createElement("option");i.value=E.playerId,i.textContent="View As: Self",a.appendChild(i);for(const d of this.party){const s=document.createElement("li");s.id=d.id,s.textContent=d.name,s.style.color=d.color,t.appendChild(s);const l=document.createElement("option");l.value=d.id,l.textContent=`View As: ${d.name}`,l.style.color=d.color,a.appendChild(l)}Ot.UpdateSpectreTargets()}}async OnFogChange(e){const t=document.getElementById("toggle_fogfill");t&&(t.checked=e.filled),this.fogColor!==e.style.color&&await Ee.UpdateTrailingFogColor(e.style.color),await Ee.Run(!0)}async OnRoomMetadataChange(e){}async OnThemeChange(e){va(e,document)}async ToggleBusy(e){const t=document.getElementById("preview_select");if(t.value!==E.playerId&&!e){const a=E.party.find(i=>i.id===t.value);a&&await w.action.setBadgeText(`Viewing as: ${a.name}`)}else await w.action.setBadgeText(e?"⏱️":void 0),E.busy=e}async CheckRegistration(){try{const e=window.location.origin.includes("localhost")?"eternaldream":"",t={owlbearid:E.playerId},a={method:"POST",headers:new Headers({"Content-Type":"application/json",Authorization:o.ANONAUTH,"x-manuel":e}),body:JSON.stringify(t)},i=await fetch(o.CHECKREGISTRATION,a);if(!i.ok){const s=await i.json();console.error("Error:",s);return}(await i.json()).Data==="OK"?(this.USER_REGISTERED=!0,console.log("Connected")):console.log("Not Registered")}catch(e){console.error("Error:",e)}}}const E=new ee([ee.SCENEITEMS,ee.SCENEMETA,ee.SCENEFOG,ee.SCENEGRID,ee.PLAYER,ee.PARTY]);function Fa(){const n=document.getElementById("map_align");if(!n)return;const e=E.sceneItems.filter(i=>i.layer==="MAP"),t={};for(let i=0;i<e.length;i++){let d=n.querySelector("#map-"+e[i].id);d===null&&(d=document.createElement("option"),d.id="map-"+e[i].id,d.value=e[i].id,d.innerText=e[i].name,n.appendChild(d)),t[e[i].id]=e[i].name}let a=n.querySelectorAll("option");for(let i=0;i<a.length;i++)t[a[i].value]===void 0&&n.removeChild(a[i])}async function Yo(n,e,t,a,i){if(i.innerText="",Number.isNaN(t)||t<0){i.innerText="Invalid DPI";return}let d=E.gridDpi/t,s,l=[];if(l[0]=0,l[1]=0,a!==""){let c=await w.scene.items.getItems([a]);if(c.length>0)s=c[0],t===0&&(t=s.grid.dpi),d=E.gridDpi/t,l[0]=s.position.x-s.grid.offset.x*d,l[1]=s.position.y-s.grid.offset.y*d;else{i.innerText="Unable to find map";return}}else{i.innerText="No map selected";return}n==="foundry"?Zo(e,d,l,i):n==="uvtt"&&Qo(e,d,l,i)}function Ba(n){const e=[];for(const t of n){const a=[];for(const d of t)a.push({x:d.x*E.gridDpi,y:d.y*E.gridDpi});const i=Ne().tension(0).points(a).strokeColor(E.sceneMetadata[`${o.EXTENSIONID}/toolColor`]??o.DEFAULTLINECOLOR).strokeDash(E.sceneMetadata[`${o.EXTENSIONID}/toolStyle`]??o.DEFAULTLINESTROKE).strokeWidth(we()).fillOpacity(0).fillColor("#000000").layer(o.LINELAYER).name("Vision Line (Line)").closed(!1).locked(!0).visible(!1).metadata({[`${o.EXTENSIONID}/isVisionLine`]:!0,[`${o.EXTENSIONID}/blocking`]:!0,[`${o.EXTENSIONID}/doubleSided`]:!0}).build();e.push(i)}return e}function Ko(n){const e=[];for(const t of n){const a=[];for(const d of t.bounds)a.push({x:d.x*E.gridDpi,y:d.y*E.gridDpi});const i=Ne().tension(0).points(a).strokeColor(o.DOORCOLOR).strokeDash(E.sceneMetadata[`${o.EXTENSIONID}/toolStyle`]??o.DEFAULTLINESTROKE).strokeWidth(we()).fillOpacity(0).fillColor("#000000").layer(o.LINELAYER).name("Vision Line (Door)").closed(!1).locked(!0).visible(!1).metadata({[`${o.EXTENSIONID}/isVisionLine`]:!0,[`${o.EXTENSIONID}/blocking`]:!0,[`${o.EXTENSIONID}/doubleSided`]:!0,[`${o.EXTENSIONID}/isDoor`]:!0}).build();t.closed||(i.metadata[`${o.EXTENSIONID}/disabled`]=!0,i.metadata[`${o.EXTENSIONID}/doorOpen`]=!0),e.push(i)}return e}async function qo(n,e){let t=[];n.objects_line_of_sight?.length>0&&(t=t.concat(Ba(n.objects_line_of_sight))),n.line_of_sight?.length>0&&(t=t.concat(Ba(n.line_of_sight))),n.portals?.length>0&&(t=t.concat(Ko(n.portals)));try{if(n.lights?.length>0){let I=function(_){if(!_)return"0";const O=1,X=5,F=2,x=.1,C=(_-O)/(X-O);return(F+(x-F)*(1-C)).toString()};const S=[];for(const _ of n.lights){const O=un({height:150,width:150,url:"https://upload.wikimedia.org/wikipedia/commons/5/59/Empty.png",mime:"image/png"},{dpi:300,offset:{x:150,y:150}}).position({x:_.position.x*E.gridDpi,y:_.position.y*E.gridDpi}).layer("PROP").metadata({[`${o.EXTENSIONID}/hasVision`]:!0,[`${o.EXTENSIONID}/isTorch`]:!0,[`${o.EXTENSIONID}/visionFallOff`]:I(_.intensity),[`${o.EXTENSIONID}/hiddenToken`]:!0,[`${o.EXTENSIONID}/visionRange`]:_.range.toString()}).name("Imported Light Source").build();S.push(O)}t=t.concat(S)}const a=atob(n.image),i=new Uint8Array(a.length),s=n.resolution.map_size.x*n.resolution.map_size.y*Math.pow(n.resolution.pixels_per_grid,2);for(let I=0;I<a.length;I++)i[I]=a.charCodeAt(I);const l=new Blob([i],{type:"image/png"}),c=s>6e7?await za(l,.8,!0):await za(l,.8);if(!c)throw new Error("Unable to convert to WebP");const h=dr(c).grid({dpi:n.resolution.pixels_per_grid,offset:{x:0,y:0}}).build();s>6e7&&(h.scale={x:2,y:2});const v=lr().baseMap(h).fogFilled(!0).name("New UVTT Scene").items(t).build();await w.assets.uploadScenes([v],!0)}catch(a){await w.notification.show("There was an error: "+a.error.message,"ERROR")}}async function $i(n,e,t,a,i){let d=0,s=0,l=0;const c=[];for(let h=0;h<n.length;h++){let v=[],I=!1;for(let S=0;S<n[h].length-1;S++){let _=n[h][S].x*e,O=n[h][S].y*e,X=n[h][S+1].x*e,F=n[h][S+1].y*e;v.push({x:_*t+a[0],y:O*t+a[1]}),v.push({x:X*t+a[0],y:F*t+a[1]}),s++,!I&&n[h][S].door&&(I=!0)}v.length>128&&(v=fi(v,8,!1));for(let S=0;S<v.length;S+=256){const _=v.slice(S>0?S-1:0,S+256),O=Ne().tension(0).points(_).strokeColor(E.sceneMetadata[`${o.EXTENSIONID}/toolColor`]??o.DEFAULTLINECOLOR).strokeDash(E.sceneMetadata[`${o.EXTENSIONID}/toolStyle`]??o.DEFAULTLINESTROKE).strokeWidth(we()).fillOpacity(0).fillColor("#000000").layer(o.LINELAYER).name("Vision Line (Import)").metadata({[`${o.EXTENSIONID}/isVisionLine`]:!0,[`${o.EXTENSIONID}/blocking`]:!0,[`${o.EXTENSIONID}/doubleSided`]:!0}).closed(!1).visible(!1).locked(!0).build();I&&(O.metadata[`${o.EXTENSIONID}/isDoor`]=!0),c.push(O),l+=_.length,(l>512||c.length>64)&&(d+=c.length,await w.scene.items.addItems(c),c.length=0,l=0)}}c.length>0&&(d+=c.length,await w.scene.items.addItems(c)),i.innerText="Finished importing "+d+" walls, "+s+" points."}function Qo(n,e,t,a){if(n.resolution.map_origin!==void 0&&(t[0]-=n.resolution.map_origin.x*n.resolution.pixels_per_grid,t[1]-=n.resolution.map_origin.y*n.resolution.pixels_per_grid),n.portals&&n.portals.length)for(let d=0;d<n.portals.length;d++){let s=n.portals[d].bounds;s[0].door=!0,s[1].door=!0,n.line_of_sight.push(s)}const i=n.line_of_sight.concat(n.objects_line_of_sight);$i(i,n.resolution.pixels_per_grid,e,t,a)}function Zo(n,e,t,a){if(!n.walls||n.walls.length===0){a.innerText="No walls found";return}const i=[];for(var d=0;d<n.walls.length;d++)i.push([{x:n.walls[d].c[0],y:n.walls[d].c[1],door:!!n.walls[d].door},{x:n.walls[d].c[2],y:n.walls[d].c[3],door:!!n.walls[d].door}]);$i(i,1,e,t,a)}async function za(n,e=.8,t=!1){const a=await createImageBitmap(n),i=document.createElement("canvas");return i.width=t?Math.floor(a.width/2):a.width,i.height=t?Math.floor(a.height/2):a.height,i.getContext("2d").drawImage(a,0,0,a.width,a.height,0,0,i.width,i.height),new Promise(s=>{i.toBlob(l=>{s(l)},"image/webp",e)})}function Jo(n=!1){const e=document.getElementById("hideListToggle");ie.hiddenList=document.getElementById("hidden_list"),ie.tokenList=document.getElementById("token_list"),e.onclick=async()=>{ie.hiddenList.style.display==="none"?(ie.hiddenList&&(ie.hiddenList.style.display="table-row-group"),e&&(e.value=n?"Tap to Hide List":"Out-of-Sight List: Click to Hide")):(ie.hiddenList&&(ie.hiddenList.style.display="none"),e&&(e.value=n?"Tap to Show List":"Out-of-Sight List: Click to Show"))};const t=document.getElementById("snap_checkbox");E.snap=!0,t.checked=!0,t.onclick=async L=>{if(!E.sceneReady){L.preventDefault();return}const P=L.target;E.snap=P.checked};const a=document.getElementById("disable_vision");a.checked=E.sceneMetadata[`${o.EXTENSIONID}/disableVision`]===!0,a.onclick=async L=>{{if(!L||!L.target)return;const P=L.target;await w.scene.setMetadata({[`${o.EXTENSIONID}/disableVision`]:P.checked})}};const i=document.getElementById("toggle_fogfill");i.checked=E.fogFilled,i.onclick=async L=>{if(!L||!L.target)return;const P=L.target;await w.scene.fog.setFilled(P.checked)};const d=document.getElementById("toggle_trailingfog");d.checked=E.sceneMetadata[`${o.EXTENSIONID}/trailingFog`]===!0,d.onclick=async L=>{if(!L||!L.target)return;const P=L.target;await w.scene.setMetadata({[`${o.EXTENSIONID}/trailingFog`]:P.checked})};const s=document.getElementById("toggle_autohide");s.checked=E.sceneMetadata[`${o.EXTENSIONID}/autoHide`]===!0,s.onclick=async L=>{if(!L||!L.target)return;const P=L.target;await w.scene.setMetadata({[`${o.EXTENSIONID}/autoHide`]:P.checked})};const l=document.getElementById("toggle_persistence");l.checked=E.sceneMetadata[`${o.EXTENSIONID}/persistence`]===!0,E.sceneMetadata[`${o.EXTENSIONID}/persistence`]!==!0&&(d.disabled=!0,d.checked=!1),l.onclick=async L=>{if(!L||!L.target)return;const P=L.target;await w.scene.setMetadata({[`${o.EXTENSIONID}/persistence`]:P.checked}),P.checked?d.disabled=!1:(d.disabled=!0,d.checked=!1,await w.scene.setMetadata({[`${o.EXTENSIONID}/trailingFog`]:!1}))};const c=document.getElementById("reset_persistence");c.onclick=async L=>{!L||!L.target||await w.broadcast.sendMessage(o.RESETPERSISTID,!0,{destination:"ALL"})};const h=document.getElementById("toggle_ownerlines");h.checked=E.sceneMetadata[`${o.EXTENSIONID}/toggleOwnerLines`]===!0,h.onclick=async L=>{if(!L||!L.target)return;const P=L.target;await w.scene.setMetadata({[`${o.EXTENSIONID}/toggleOwnerLines`]:P.checked})};const v=document.getElementById("door_checkbox");v.checked=E.sceneMetadata[`${o.EXTENSIONID}/playerDoors`]===!0,v.onclick=async L=>{if(!L||!L.target)return;const P=L.target;await w.scene.setMetadata({[`${o.EXTENSIONID}/playerDoors`]:P.checked})};const I=document.getElementById("toggle_unitcontextmenu");I.checked=E.sceneMetadata[`${o.EXTENSIONID}/unitContextMenu`]===!0,I.onclick=async L=>{if(!L||!L.target)return;const P=L.target;await w.scene.setMetadata({[`${o.EXTENSIONID}/unitContextMenu`]:P.checked})};const S=document.getElementById("toggle_wallcontextmenu");S.checked=E.sceneMetadata[`${o.EXTENSIONID}/wallContextMenu`]===!0,S.onclick=async L=>{if(!L||!L.target)return;const P=L.target;await w.scene.setMetadata({[`${o.EXTENSIONID}/wallContextMenu`]:P.checked})};const _=document.getElementById("default_elevation_select"),O=E.sceneMetadata[`${o.EXTENSIONID}/defaultElevation`];_.value=typeof O=="string"?O:"-10",_.onchange=async L=>{const P=L.currentTarget;await w.scene.setMetadata({[`${o.EXTENSIONID}/defaultElevation`]:P.value})};const X=document.getElementById("elevation_style_select"),F=E.sceneMetadata[`${o.EXTENSIONID}/elevationComplex`];X.value=F==="true"?"true":"false",X.onchange=async L=>{const P=L.currentTarget;await w.scene.setMetadata({[`${o.EXTENSIONID}/elevationComplex`]:P.value==="true"})};const x=document.getElementById("toggle_gmwalls");x.checked=E.sceneMetadata[`${o.EXTENSIONID}/passWallsGM`]===!0,x.onclick=async L=>{if(!L||!L.target)return;const P=L.target;await w.scene.setMetadata({[`${o.EXTENSIONID}/passWallsGM`]:P.checked}),E.fogFilled||await Ee.Run(!0)};const C=document.getElementById("lock_button"),G=document.getElementById("unlock_button");G.onclick=async L=>{if(!L||!L.target)return;const P=E.sceneItems.filter(U=>Xt(U));await E.ToggleBusy(!0);for(let U=0;U<P.length;U+=64){const re=P.slice(U,U+64);await w.scene.items.updateItems(re.map(ae=>ae.id),ae=>{for(let ce of ae)ce.locked=!1})}E.ToggleBusy(!1)},C.onclick=async L=>{if(!L||!L.target)return;const P=E.sceneItems.filter(U=>Xt(U));await E.ToggleBusy(!0);for(let U=0;U<P.length;U+=64){const re=P.slice(U,U+64);await w.scene.items.updateItems(re.map(ae=>ae.id),ae=>{for(let ce of ae)ce.locked=!0})}await E.ToggleBusy(!1)};const r=document.getElementById("doublewall_button");r.onclick=async L=>{if(!L||!L.target)return;const P=E.sceneItems.filter(U=>Xt(U));await E.ToggleBusy(!0);for(let U=0;U<P.length;U+=64){const re=P.slice(U,U+64);await w.scene.items.updateItems(re.map(ae=>ae.id),ae=>{for(let ce of ae)ce.metadata[`${o.EXTENSIONID}/doubleSided`]=!0})}E.ToggleBusy(!1)};const f=document.getElementById("block_button"),u=document.getElementById("unblock_button");u.onclick=async L=>{if(!L||!L.target)return;const P=E.sceneItems.filter(U=>Xt(U));await E.ToggleBusy(!0);for(let U=0;U<P.length;U+=64){const re=P.slice(U,U+64);await w.scene.items.updateItems(re.map(ae=>ae.id),ae=>{for(let ce of ae)ce.metadata[`${o.EXTENSIONID}/blocking`]=void 0})}E.ToggleBusy(!1)},f.onclick=async L=>{if(!L||!L.target)return;const P=E.sceneItems.filter(U=>Xt(U));await E.ToggleBusy(!0);for(let U=0;U<P.length;U+=64){const re=P.slice(U,U+64);await w.scene.items.updateItems(re.map(ae=>ae.id),ae=>{for(let ce of ae)ce.metadata[`${o.EXTENSIONID}/blocking`]=!0})}await E.ToggleBusy(!1)};const p=document.getElementById("visionDefaultInput");p.value=E.sceneMetadata[`${o.EXTENSIONID}/visionRangeDefault`]??Ae(),p.onchange=async L=>{if(!L||!L.target)return;const P=L.target,U=parseInt(P.value);U<0&&(P.value="0"),U>999&&(P.value="999"),isNaN(U)&&(P.value=Ve()),await w.scene.setMetadata({[`${o.EXTENSIONID}/visionRangeDefault`]:P.value})};const y=document.getElementById("collisionDefaultInput");y.value=E.sceneMetadata[`${o.EXTENSIONID}/visionSourceDefault`]??Ve().toString(),y.onchange=async L=>{if(!L||!L.target)return;const P=L.target,U=parseFloat(P.value);U<0&&(P.value="0"),U>999&&(P.value="999"),isNaN(U)&&(P.value=Ve()),await w.scene.setMetadata({[`${o.EXTENSIONID}/visionSourceDefault`]:P.value})};const m=document.getElementById("greyscaleDefaultInput");m.value=E.sceneMetadata[`${o.EXTENSIONID}/visionDarkDefault`]??pn().toString(),m.onchange=async L=>{if(!L||!L.target)return;const P=L.target,U=parseInt(P.value);U<0&&(P.value="0"),U>999&&(P.value="999"),isNaN(U)&&(P.value=Ve()),await w.scene.setMetadata({[`${o.EXTENSIONID}/visionDarkDefault`]:P.value})};const g=document.getElementById("innerAngleDefaultInput");g.value=E.sceneMetadata[`${o.EXTENSIONID}/visionInAngleDefault`]??rt().toString(),g.onchange=async L=>{if(!L||!L.target)return;const P=L.target,U=parseInt(P.value);U<0&&(P.value="0"),U>360&&(P.value="360"),isNaN(U)&&(P.value=We()),await w.scene.setMetadata({[`${o.EXTENSIONID}/visionInAngleDefault`]:P.value})};const T=document.getElementById("outerAngleDefaultInput");T.value=E.sceneMetadata[`${o.EXTENSIONID}/visionOutAngleDefault`]??We().toString(),T.onchange=async L=>{if(!L||!L.target)return;const P=L.target,U=parseInt(P.value);U<0&&(P.value="0"),U>360&&(P.value="360"),isNaN(U)&&(P.value=We()),await w.scene.setMetadata({[`${o.EXTENSIONID}/visionOutAngleDefault`]:P.value})};const M=document.getElementById("falloffDefaultInput");M.value=E.sceneMetadata[`${o.EXTENSIONID}/visionFallOffDefault`]??Ze().toString(),M.onchange=async L=>{if(!L||!L.target)return;const P=L.target,U=parseFloat(P.value);U<0&&(P.value="0"),U>10&&(P.value="10"),isNaN(U)&&(P.value=Ze()),await w.scene.setMetadata({[`${o.EXTENSIONID}/visionFallOffDefault`]:P.value})};var k;const $=document.getElementById("import_button"),R=document.getElementById("import_file"),b=document.getElementById("import_errors"),A=document.getElementById("import_dpi"),z=document.getElementById("import_format"),j=document.getElementById("dpi_autodetect"),Q=document.getElementById("map_align");R.onchange=L=>{if($.disabled=!0,!L||!L.target)return;const P=L.target;if(!P.files)return;const U=P.files[0];if(U.type!=="text/javascript"&&U.type,U){const ae=document.getElementById("import_file_name");ae&&(ae.textContent=U.name);var re=new FileReader;re.onload=function(ce){if(!ce||!ce.target){b.innerText="Invalid import event";return}const ve=ce.target;if(!ve.result){b.innerText="Unable to read imported file";return}const et=ve.result;k=JSON.parse(et),k&&(k.walls&&k.walls.length||k.line_of_sight&&k.line_of_sight.length||k.objects_line_of_sight&&k.objects_line_of_sight.length)?$.disabled=!1:b.innerText="Imported file has no walls"},re.readAsText(U)}else b.innerText="Failed to load file"},j.onclick=async L=>{!L||!L.target||(A.disabled=j.checked)},$.onclick=async L=>{!L||!L.target||(await E.ToggleBusy(!0),z.value==="scene"?await qo(k):await Yo(z.value,k,j.checked?0:Number.parseInt(A.value),Q.value,b),await E.ToggleBusy(!1))};const Y=document.getElementById("tool_width"),te=document.getElementById("tool_color"),oe=document.getElementById("tool_style");let se;const ne=document.getElementById("preview_select");ne.onchange=async L=>{L.currentTarget,await E.ToggleBusy(!1),await Ee.Run()},te.onclick=async L=>{Fe({el:`#${te.id}`,alpha:!1,forceAlpha:!1})},te.oninput=async L=>{if(!L||!L.target)return;const P=L.target;clearTimeout(se),se=setTimeout(async()=>{/#[a-f0-9]{6}/.test(P.value)&&await w.scene.setMetadata({[`${o.EXTENSIONID}/toolColor`]:P.value})},400)},oe.onchange=async L=>{const P=L.currentTarget;await w.scene.setMetadata({[`${o.EXTENSIONID}/toolStyle`]:P.value=="solid"?[]:[25,25]})},Y.onchange=L=>{const P=L.currentTarget;clearTimeout(se);try{const U=parseInt(P.value);(U<1||U>100)&&(P.value="8")}catch{console.log("Tool Width value set out of range, swapping to default"),P.value="8"}se=setTimeout(async()=>{await w.scene.setMetadata({[`${o.EXTENSIONID}/toolWidth`]:P.value})},400)};const J=E.sceneMetadata[`${o.EXTENSIONID}/toolColor`]??"#000000";te&&(te.value=J),Fe({themeMode:"dark",alpha:!1,forceAlpha:!1,el:"#tool_color",defaultColor:J})}let it=[];async function Mi(){it=[];const n=await w.scene.local.getItems(Kr);await w.scene.local.deleteItems(n.map(e=>e.id)),await w.popover.close(o.BRUSHTOOLID)}async function ed(n,e){await Pi(e.pointerPosition)}async function td(){const n=await w.viewport.getWidth();await w.popover.open({id:o.BRUSHTOOLID,url:"/pages/brush.html",height:80,width:350,disableClickAway:!0,anchorPosition:{top:60,left:n/2},anchorReference:"POSITION",anchorOrigin:{vertical:"CENTER",horizontal:"CENTER"},transformOrigin:{vertical:"TOP",horizontal:"CENTER"}})}async function nd(){await w.popover.close(o.BRUSHTOOLID)}async function ad(n,e){await Pi(e.pointerPosition)}async function id(n,e){await sd(),await Mi()}async function rd(n,e){await Mi()}async function Pi(n){const e={x:Math.floor(n.x/E.gridDpi),y:Math.floor(n.y/E.gridDpi)};if(!it.some(a=>a.x===e.x&&a.y===e.y)){const a={x:e.x*E.gridDpi,y:e.y*E.gridDpi},i={x:(e.x+1)*E.gridDpi,y:e.y*E.gridDpi},d={x:e.x*E.gridDpi,y:(e.y+1)*E.gridDpi},s={x:(e.x+1)*E.gridDpi,y:(e.y+1)*E.gridDpi},l=[[xt.MOVE,a.x,a.y],[xt.LINE,i.x,i.y],[xt.LINE,s.x,s.y],[xt.LINE,d.x,d.y],[xt.CLOSE]],c=cr().commands(l).strokeOpacity(0).fillOpacity(.5).fillColor(E.sceneMetadata[`${o.EXTENSIONID}/toolColor`]??o.DEFAULTLINECOLOR).build();c.metadata[`${o.EXTENSIONID}/isBrushSquare`]=!0,c.layer="POINTER",it.push(e),await w.scene.local.addItems([c])}}async function sd(){const n=[];for(const s of it){const{x:l,y:c}=s,h={x:l*E.gridDpi,y:c*E.gridDpi},v={x:(l+1)*E.gridDpi,y:c*E.gridDpi},I={x:l*E.gridDpi,y:(c+1)*E.gridDpi},S={x:(l+1)*E.gridDpi,y:(c+1)*E.gridDpi};if(!it.some(_=>_.x===l&&_.y===c-1)){const _=h,O=v;n.push({Start:_,End:O})}if(!it.some(_=>_.x===l&&_.y===c+1)){const _=I,O=S;n.push({Start:_,End:O})}if(!it.some(_=>_.x===l-1&&_.y===c)){const _=h,O=I;n.push({Start:_,End:O})}if(!it.some(_=>_.x===l+1&&_.y===c)){const _=v,O=S;n.push({Start:_,End:O})}}const e=Ri(n),t=xi(e),a=ld(t),i=25,d=a.length;for(let s=0;s<d;s+=i){const l=a.slice(s,s+i);await w.scene.items.addItems(l)}}function xi(n){let e=[],t=[],a=!1;for(const i of n){const d=i.Start.x===i.End.x?n.filter(c=>c.Start.x===c.End.x):n.filter(c=>c.Start.y===c.End.y),s=i.Start.x===i.End.x?d.filter(c=>c.Start.x===i.Start.x&&c.End.x===i.End.x):d.filter(c=>c.Start.y===i.Start.y&&c.End.y===i.End.y),l=i.Start.x!==i.End.x?s.find(c=>c.Start.x>i.Start.x&&c.Start.x<i.End.x):s.find(c=>c.Start.y>i.Start.y&&c.Start.y<i.End.y);if(l){const c=dd(i,l);t.push(c),e.push(i),e.push(l),t=t.filter(h=>h!==i&&h!==l),a=!0}else e.includes(i)||t.push(i)}return a?xi(t):t}function Ri(n){let e=[],t=[],a=!1;for(const i of n){const s=(i.Start.x===i.End.x?n.filter(l=>l.Start.x===l.End.x):n.filter(l=>l.Start.y===l.End.y)).find(l=>l.Start.x===i.End.x&&l.Start.y===i.End.y);if(s){const l=od(i,s);t.push(l),e.push(i),e.push(s),t=t.filter(c=>c!==i&&c!==s),a=!0}else e.includes(i)||t.push(i)}return a?Ri(t):t}function od(n,e){return{Start:n.Start,End:e.End}}function dd(n,e){const t=Math.min(n.Start.x,e.Start.x),a=Math.min(n.Start.y,e.Start.y),i=Math.max(n.End.x,e.End.x),d=Math.max(n.End.y,e.End.y);return{Start:{x:t,y:a},End:{x:i,y:d}}}function ld(n){const e=[];for(const t of n){const a=Ne().tension(0).points([t.Start,t.End]).strokeColor(E.sceneMetadata[`${o.EXTENSIONID}/toolColor`]??o.DEFAULTLINECOLOR).strokeDash(E.sceneMetadata[`${o.EXTENSIONID}/toolStyle`]??o.DEFAULTLINESTROKE).strokeWidth(we()).fillOpacity(0).fillColor("#000000").layer(o.LINELAYER).name("Vision Line (Brushed)").closed(!1).locked(!0).build();a.visible=!1,a.metadata[`${o.EXTENSIONID}/isVisionLine`]=!0,a.metadata[`${o.EXTENSIONID}/blocking`]=!0,a.metadata[`${o.EXTENSIONID}/doubleSided`]=!0,e.push(a)}return e}const Tt={onActivate:td,onDeactivate:nd,onDragStart:ed,onDragMove:ad,onDragEnd:id,onDragCancel:rd};let Dt=[],Xi="",kt="",Nt=null,sn=!1,Xn=!1;async function Vi(){Dt=[],kt="",await w.scene.local.deleteItems([Xi])}async function cd(n){const e=n.position.x!==0&&n.position.y!==0,t=e?ja(n.points,n.position,!0):n.points,a=Sr(t,Dt[0],Dt[1],n.rotation,n.position),i=[],d=Ne().tension(0).points(a.extracted).strokeColor(Nr(E.sceneMetadata[`${o.EXTENSIONID}/toolColor`]??o.DEFAULTLINECOLOR)).strokeDash(E.sceneMetadata[`${o.EXTENSIONID}/toolStyle`]??o.DEFAULTLINESTROKE).strokeWidth(we()).fillOpacity(0).fillColor("#000000").layer(o.LINELAYER).name("Vision Line (Line)").metadata({[`${o.EXTENSIONID}/isVisionLine`]:!0,[`${o.EXTENSIONID}/doubleSided`]:!0,[`${o.EXTENSIONID}/blocking`]:!0}).closed(!1).visible(!1).locked(!0).build();i.push(d);for(const s of a.remaining){const l=Ne().tension(0).position(n.position).strokeColor(E.sceneMetadata[`${o.EXTENSIONID}/toolColor`]??o.DEFAULTLINECOLOR).strokeDash(E.sceneMetadata[`${o.EXTENSIONID}/toolStyle`]??o.DEFAULTLINESTROKE).strokeWidth(we()).fillOpacity(0).rotation(n.rotation).fillColor("#000000").layer(o.LINELAYER).name("Vision Line (Line)").metadata({[`${o.EXTENSIONID}/isVisionLine`]:!0,[`${o.EXTENSIONID}/doubleSided`]:!0,[`${o.EXTENSIONID}/blocking`]:!0}).closed(!1).visible(!1).locked(!0).build();l.points=e?ja(s,n.position,!1):s,i.push(l)}await w.scene.items.deleteItems([n.id]),await w.scene.items.addItems(i),Vi()}async function ud(n,e){if(!e.transformer&&!(!e.target||e.target.type!=="CURVE"||kt!==""&&kt!==e.target.id)){if(kt=e.target.id,Dt.push(e.pointerPosition),Dt.length===1){const t=Hi();t.position=e.pointerPosition,Xi=t.id,await w.scene.local.addItems([t])}Dt.length===2&&cd(e.target)}}async function fd(n,e){if(e.target&&e.target.type==="CURVE"&&(kt===""||kt===e.target.id)){if(!sn&&!Xn){Nt||(Xn=!0,Nt=await w.interaction.startItemInteraction(Hi()));const[t]=Nt;t(a=>{a.position=e.pointerPosition}),Xn=!1}}else if(Nt&&(!e.target||e.target&&e.target.type!=="CURVE")){const[t,a]=Nt;a(),Nt=null,sn||(setTimeout(()=>{sn=!1},50),sn=!0)}}function pd(n,e){e.key=="Escape"&&Vi()}function Hi(){const n=we();return ur().color("red").radius(n+4).disableHit(!0).build()}function ja(n,e,t){return n.map(a=>({x:t?a.x+e.x:a.x-e.x,y:t?a.y+e.y:a.y-e.y}))}const Vn={onToolClick:ud,onToolMove:fd,onKeyDown:pd};async function hd(){await w.tool.create({id:`${o.EXTENSIONID}/vision-tool`,icons:[{icon:"/icon.svg",label:"Setup Vision"}],defaultMetadata:{[`${o.EXTENSIONID}/elevationEditor`]:!1},async onClick(){await w.tool.activateTool(`${o.EXTENSIONID}/vision-tool`),E.toolStarted||(E.toolStarted=!0,await w.tool.setMetadata(`${o.EXTENSIONID}/vision-tool`,{[`${o.EXTENSIONID}/elevationEditor`]:!1}))}}),await w.tool.createMode({id:`${o.EXTENSIONID}/add-vision-line-mode`,icons:[{icon:"/line.svg",label:"Add Obstruction Line",filter:{activeTools:[`${o.EXTENSIONID}/vision-tool`]}}],onToolDown:Jt.onToolClick,onToolMove:Jt.onToolMove,onToolDoubleClick:Jt.onToolDouble,onKeyDown:Jt.onKeyDown,preventDrag:{dragging:!1}}),await w.tool.createMode({id:`${o.EXTENSIONID}/add-vision-polygon-mode`,icons:[{icon:"/object.svg",label:"Add Obstruction Object",filter:{activeTools:[`${o.EXTENSIONID}/vision-tool`]}}],onToolDown:en.onToolClick,onToolMove:en.onToolMove,onToolDoubleClick:en.onToolDouble,onKeyDown:en.onKeyDown,preventDrag:{dragging:!1}}),await w.tool.createMode({id:`${o.EXTENSIONID}/add-vision-brush-mode`,icons:[{icon:"/brush.svg",label:"Paint Obstructions by Grid",filter:{activeTools:[`${o.EXTENSIONID}/vision-tool`]}}],onToolDown:Tt.onActivate,onToolUp:Tt.onDeactivate,onToolDragStart:Tt.onDragStart,onToolDragMove:Tt.onDragMove,onToolDragEnd:Tt.onDragEnd,onToolDragCancel:Tt.onDragCancel}),await w.tool.createMode({id:`${o.EXTENSIONID}/add-line-cutter-mode`,icons:[{icon:"/cutter.svg",label:"Trim Line",filter:{activeTools:[`${o.EXTENSIONID}/vision-tool`]}}],onToolDown:Vn.onToolClick,onToolMove:Vn.onToolMove,onKeyDown:Vn.onKeyDown,preventDrag:{dragging:!1},cursors:[{cursor:"crosshair"}]}),await w.tool.createMode({id:`${o.EXTENSIONID}/enter-elevation-mode-1`,icons:[{icon:"/mountain1.svg",label:"Create Map Elevation Layer-1",filter:{activeTools:[`${o.EXTENSIONID}/vision-tool`]}}],disabled:{metadata:[{key:[`${o.EXTENSIONID}/elevationEditor`],value:!1}]},onToolDown:(n,e)=>{ye.onToolClick(n,e,1)},onToolMove:ye.onToolMove,onKeyDown:(n,e)=>{ye.onKeyDown(n,e,1)},preventDrag:{dragging:!0}}),await w.tool.createMode({id:`${o.EXTENSIONID}/enter-elevation-mode-2`,icons:[{icon:"/mountain2.svg",label:"Create Map Elevation Layer-2",filter:{activeTools:[`${o.EXTENSIONID}/vision-tool`]}}],disabled:{metadata:[{key:[`${o.EXTENSIONID}/elevationEditor`],value:!1}]},onToolDown:(n,e)=>{ye.onToolClick(n,e,2)},onToolMove:ye.onToolMove,onKeyDown:(n,e)=>{ye.onKeyDown(n,e,2)},preventDrag:{dragging:!0}}),await w.tool.createMode({id:`${o.EXTENSIONID}/enter-elevation-mode-3`,icons:[{icon:"/mountain3.svg",label:"Create Map Elevation Layer-3",filter:{activeTools:[`${o.EXTENSIONID}/vision-tool`]}}],disabled:{metadata:[{key:[`${o.EXTENSIONID}/elevationEditor`],value:!1}]},onToolDown:(n,e)=>{ye.onToolClick(n,e,3)},onToolMove:ye.onToolMove,onKeyDown:(n,e)=>{ye.onKeyDown(n,e,3)},preventDrag:{dragging:!0}}),await w.tool.createMode({id:`${o.EXTENSIONID}/enter-elevation-mode-4`,icons:[{icon:"/mountain4.svg",label:"Create Map Elevation Layer-4",filter:{activeTools:[`${o.EXTENSIONID}/vision-tool`]}}],disabled:{metadata:[{key:[`${o.EXTENSIONID}/elevationEditor`],value:!1}]},onToolDown:(n,e)=>{ye.onToolClick(n,e,4)},onToolMove:ye.onToolMove,onKeyDown:(n,e)=>{ye.onKeyDown(n,e,4)},preventDrag:{dragging:!0}}),await w.tool.createMode({id:`${o.EXTENSIONID}/enter-elevation-mode-5`,icons:[{icon:"/mountain5.svg",label:"Create Map Elevation Layer-5",filter:{activeTools:[`${o.EXTENSIONID}/vision-tool`]}}],disabled:{metadata:[{key:[`${o.EXTENSIONID}/elevationEditor`],value:!1}]},onToolDown:(n,e)=>{ye.onToolClick(n,e,5)},onToolMove:ye.onToolMove,onKeyDown:(n,e)=>{ye.onKeyDown(n,e,5)},preventDrag:{dragging:!0}}),await w.tool.createMode({id:`${o.EXTENSIONID}/enter-elevation-mode-select`,icons:[{icon:"/mountain-select.svg",label:"Selector",filter:{activeTools:[`${o.EXTENSIONID}/vision-tool`]}}],disabled:{metadata:[{key:[`${o.EXTENSIONID}/elevationEditor`],value:!1}]},onToolDown:(n,e)=>!0,preventDrag:{dragging:!0}}),await w.tool.createAction({id:`${o.EXTENSIONID}/enter-elevation-mode`,icons:[{icon:"/eyeclosed.svg",label:"Activate Elevation Editor",filter:{activeTools:[`${o.EXTENSIONID}/vision-tool`],metadata:[{key:[`${o.EXTENSIONID}/elevationEditor`],value:!0,operator:"!="}]}},{icon:"/eyeopen.svg",label:"De-Activate Elevation Editor",filter:{activeTools:[`${o.EXTENSIONID}/vision-tool`],metadata:[{key:[`${o.EXTENSIONID}/elevationEditor`],value:!0,operator:"=="}]}}],onClick:ye.enterEditMode})}var De="top",Pe="bottom",xe="right",ke="left",aa="auto",Yt=[De,Pe,xe,ke],Ct="start",Gt="end",md="clippingParents",Fi="viewport",Vt="popper",gd="reference",Ua=Yt.reduce(function(n,e){return n.concat([e+"-"+Ct,e+"-"+Gt])},[]),Bi=[].concat(Yt,[aa]).reduce(function(n,e){return n.concat([e,e+"-"+Ct,e+"-"+Gt])},[]),vd="beforeRead",yd="read",Ed="afterRead",Id="beforeMain",wd="main",bd="afterMain",Td="beforeWrite",Nd="write",Sd="afterWrite",_d=[vd,yd,Ed,Id,wd,bd,Td,Nd,Sd];function Ke(n){return n?(n.nodeName||"").toLowerCase():null}function $e(n){if(n==null)return window;if(n.toString()!=="[object Window]"){var e=n.ownerDocument;return e&&e.defaultView||window}return n}function mt(n){var e=$e(n).Element;return n instanceof e||n instanceof Element}function Me(n){var e=$e(n).HTMLElement;return n instanceof e||n instanceof HTMLElement}function ia(n){if(typeof ShadowRoot>"u")return!1;var e=$e(n).ShadowRoot;return n instanceof e||n instanceof ShadowRoot}function Od(n){var e=n.state;Object.keys(e.elements).forEach(function(t){var a=e.styles[t]||{},i=e.attributes[t]||{},d=e.elements[t];!Me(d)||!Ke(d)||(Object.assign(d.style,a),Object.keys(i).forEach(function(s){var l=i[s];l===!1?d.removeAttribute(s):d.setAttribute(s,l===!0?"":l)}))})}function Dd(n){var e=n.state,t={popper:{position:e.options.strategy,left:"0",top:"0",margin:"0"},arrow:{position:"absolute"},reference:{}};return Object.assign(e.elements.popper.style,t.popper),e.styles=t,e.elements.arrow&&Object.assign(e.elements.arrow.style,t.arrow),function(){Object.keys(e.elements).forEach(function(a){var i=e.elements[a],d=e.attributes[a]||{},s=Object.keys(e.styles.hasOwnProperty(a)?e.styles[a]:t[a]),l=s.reduce(function(c,h){return c[h]="",c},{});!Me(i)||!Ke(i)||(Object.assign(i.style,l),Object.keys(d).forEach(function(c){i.removeAttribute(c)}))})}}const zi={name:"applyStyles",enabled:!0,phase:"write",fn:Od,effect:Dd,requires:["computeStyles"]};function Ye(n){return n.split("-")[0]}var ht=Math.max,En=Math.min,Lt=Math.round;function Qn(){var n=navigator.userAgentData;return n!=null&&n.brands&&Array.isArray(n.brands)?n.brands.map(function(e){return e.brand+"/"+e.version}).join(" "):navigator.userAgent}function ji(){return!/^((?!chrome|android).)*safari/i.test(Qn())}function At(n,e,t){e===void 0&&(e=!1),t===void 0&&(t=!1);var a=n.getBoundingClientRect(),i=1,d=1;e&&Me(n)&&(i=n.offsetWidth>0&&Lt(a.width)/n.offsetWidth||1,d=n.offsetHeight>0&&Lt(a.height)/n.offsetHeight||1);var s=mt(n)?$e(n):window,l=s.visualViewport,c=!ji()&&t,h=(a.left+(c&&l?l.offsetLeft:0))/i,v=(a.top+(c&&l?l.offsetTop:0))/d,I=a.width/i,S=a.height/d;return{width:I,height:S,top:v,right:h+I,bottom:v+S,left:h,x:h,y:v}}function ra(n){var e=At(n),t=n.offsetWidth,a=n.offsetHeight;return Math.abs(e.width-t)<=1&&(t=e.width),Math.abs(e.height-a)<=1&&(a=e.height),{x:n.offsetLeft,y:n.offsetTop,width:t,height:a}}function Ui(n,e){var t=e.getRootNode&&e.getRootNode();if(n.contains(e))return!0;if(t&&ia(t)){var a=e;do{if(a&&n.isSameNode(a))return!0;a=a.parentNode||a.host}while(a)}return!1}function Je(n){return $e(n).getComputedStyle(n)}function kd(n){return["table","td","th"].indexOf(Ke(n))>=0}function st(n){return((mt(n)?n.ownerDocument:n.document)||window.document).documentElement}function bn(n){return Ke(n)==="html"?n:n.assignedSlot||n.parentNode||(ia(n)?n.host:null)||st(n)}function Ga(n){return!Me(n)||Je(n).position==="fixed"?null:n.offsetParent}function Cd(n){var e=/firefox/i.test(Qn()),t=/Trident/i.test(Qn());if(t&&Me(n)){var a=Je(n);if(a.position==="fixed")return null}var i=bn(n);for(ia(i)&&(i=i.host);Me(i)&&["html","body"].indexOf(Ke(i))<0;){var d=Je(i);if(d.transform!=="none"||d.perspective!=="none"||d.contain==="paint"||["transform","perspective"].indexOf(d.willChange)!==-1||e&&d.willChange==="filter"||e&&d.filter&&d.filter!=="none")return i;i=i.parentNode}return null}function Kt(n){for(var e=$e(n),t=Ga(n);t&&kd(t)&&Je(t).position==="static";)t=Ga(t);return t&&(Ke(t)==="html"||Ke(t)==="body"&&Je(t).position==="static")?e:t||Cd(n)||e}function sa(n){return["top","bottom"].indexOf(n)>=0?"x":"y"}function Bt(n,e,t){return ht(n,En(e,t))}function Ld(n,e,t){var a=Bt(n,e,t);return a>t?t:a}function Gi(){return{top:0,right:0,bottom:0,left:0}}function Wi(n){return Object.assign({},Gi(),n)}function Yi(n,e){return e.reduce(function(t,a){return t[a]=n,t},{})}var Ad=function(e,t){return e=typeof e=="function"?e(Object.assign({},t.rects,{placement:t.placement})):e,Wi(typeof e!="number"?e:Yi(e,Yt))};function $d(n){var e,t=n.state,a=n.name,i=n.options,d=t.elements.arrow,s=t.modifiersData.popperOffsets,l=Ye(t.placement),c=sa(l),h=[ke,xe].indexOf(l)>=0,v=h?"height":"width";if(!(!d||!s)){var I=Ad(i.padding,t),S=ra(d),_=c==="y"?De:ke,O=c==="y"?Pe:xe,X=t.rects.reference[v]+t.rects.reference[c]-s[c]-t.rects.popper[v],F=s[c]-t.rects.reference[c],x=Kt(d),C=x?c==="y"?x.clientHeight||0:x.clientWidth||0:0,G=X/2-F/2,r=I[_],f=C-S[v]-I[O],u=C/2-S[v]/2+G,p=Bt(r,u,f),y=c;t.modifiersData[a]=(e={},e[y]=p,e.centerOffset=p-u,e)}}function Md(n){var e=n.state,t=n.options,a=t.element,i=a===void 0?"[data-popper-arrow]":a;i!=null&&(typeof i=="string"&&(i=e.elements.popper.querySelector(i),!i)||Ui(e.elements.popper,i)&&(e.elements.arrow=i))}const Pd={name:"arrow",enabled:!0,phase:"main",fn:$d,effect:Md,requires:["popperOffsets"],requiresIfExists:["preventOverflow"]};function $t(n){return n.split("-")[1]}var xd={top:"auto",right:"auto",bottom:"auto",left:"auto"};function Rd(n,e){var t=n.x,a=n.y,i=e.devicePixelRatio||1;return{x:Lt(t*i)/i||0,y:Lt(a*i)/i||0}}function Wa(n){var e,t=n.popper,a=n.popperRect,i=n.placement,d=n.variation,s=n.offsets,l=n.position,c=n.gpuAcceleration,h=n.adaptive,v=n.roundOffsets,I=n.isFixed,S=s.x,_=S===void 0?0:S,O=s.y,X=O===void 0?0:O,F=typeof v=="function"?v({x:_,y:X}):{x:_,y:X};_=F.x,X=F.y;var x=s.hasOwnProperty("x"),C=s.hasOwnProperty("y"),G=ke,r=De,f=window;if(h){var u=Kt(t),p="clientHeight",y="clientWidth";if(u===$e(t)&&(u=st(t),Je(u).position!=="static"&&l==="absolute"&&(p="scrollHeight",y="scrollWidth")),u=u,i===De||(i===ke||i===xe)&&d===Gt){r=Pe;var m=I&&u===f&&f.visualViewport?f.visualViewport.height:u[p];X-=m-a.height,X*=c?1:-1}if(i===ke||(i===De||i===Pe)&&d===Gt){G=xe;var g=I&&u===f&&f.visualViewport?f.visualViewport.width:u[y];_-=g-a.width,_*=c?1:-1}}var T=Object.assign({position:l},h&&xd),M=v===!0?Rd({x:_,y:X},$e(t)):{x:_,y:X};if(_=M.x,X=M.y,c){var k;return Object.assign({},T,(k={},k[r]=C?"0":"",k[G]=x?"0":"",k.transform=(f.devicePixelRatio||1)<=1?"translate("+_+"px, "+X+"px)":"translate3d("+_+"px, "+X+"px, 0)",k))}return Object.assign({},T,(e={},e[r]=C?X+"px":"",e[G]=x?_+"px":"",e.transform="",e))}function Xd(n){var e=n.state,t=n.options,a=t.gpuAcceleration,i=a===void 0?!0:a,d=t.adaptive,s=d===void 0?!0:d,l=t.roundOffsets,c=l===void 0?!0:l,h={placement:Ye(e.placement),variation:$t(e.placement),popper:e.elements.popper,popperRect:e.rects.popper,gpuAcceleration:i,isFixed:e.options.strategy==="fixed"};e.modifiersData.popperOffsets!=null&&(e.styles.popper=Object.assign({},e.styles.popper,Wa(Object.assign({},h,{offsets:e.modifiersData.popperOffsets,position:e.options.strategy,adaptive:s,roundOffsets:c})))),e.modifiersData.arrow!=null&&(e.styles.arrow=Object.assign({},e.styles.arrow,Wa(Object.assign({},h,{offsets:e.modifiersData.arrow,position:"absolute",adaptive:!1,roundOffsets:c})))),e.attributes.popper=Object.assign({},e.attributes.popper,{"data-popper-placement":e.placement})}const Vd={name:"computeStyles",enabled:!0,phase:"beforeWrite",fn:Xd,data:{}};var on={passive:!0};function Hd(n){var e=n.state,t=n.instance,a=n.options,i=a.scroll,d=i===void 0?!0:i,s=a.resize,l=s===void 0?!0:s,c=$e(e.elements.popper),h=[].concat(e.scrollParents.reference,e.scrollParents.popper);return d&&h.forEach(function(v){v.addEventListener("scroll",t.update,on)}),l&&c.addEventListener("resize",t.update,on),function(){d&&h.forEach(function(v){v.removeEventListener("scroll",t.update,on)}),l&&c.removeEventListener("resize",t.update,on)}}const Fd={name:"eventListeners",enabled:!0,phase:"write",fn:function(){},effect:Hd,data:{}};var Bd={left:"right",right:"left",bottom:"top",top:"bottom"};function cn(n){return n.replace(/left|right|bottom|top/g,function(e){return Bd[e]})}var zd={start:"end",end:"start"};function Ya(n){return n.replace(/start|end/g,function(e){return zd[e]})}function oa(n){var e=$e(n),t=e.pageXOffset,a=e.pageYOffset;return{scrollLeft:t,scrollTop:a}}function da(n){return At(st(n)).left+oa(n).scrollLeft}function jd(n,e){var t=$e(n),a=st(n),i=t.visualViewport,d=a.clientWidth,s=a.clientHeight,l=0,c=0;if(i){d=i.width,s=i.height;var h=ji();(h||!h&&e==="fixed")&&(l=i.offsetLeft,c=i.offsetTop)}return{width:d,height:s,x:l+da(n),y:c}}function Ud(n){var e,t=st(n),a=oa(n),i=(e=n.ownerDocument)==null?void 0:e.body,d=ht(t.scrollWidth,t.clientWidth,i?i.scrollWidth:0,i?i.clientWidth:0),s=ht(t.scrollHeight,t.clientHeight,i?i.scrollHeight:0,i?i.clientHeight:0),l=-a.scrollLeft+da(n),c=-a.scrollTop;return Je(i||t).direction==="rtl"&&(l+=ht(t.clientWidth,i?i.clientWidth:0)-d),{width:d,height:s,x:l,y:c}}function la(n){var e=Je(n),t=e.overflow,a=e.overflowX,i=e.overflowY;return/auto|scroll|overlay|hidden/.test(t+i+a)}function Ki(n){return["html","body","#document"].indexOf(Ke(n))>=0?n.ownerDocument.body:Me(n)&&la(n)?n:Ki(bn(n))}function zt(n,e){var t;e===void 0&&(e=[]);var a=Ki(n),i=a===((t=n.ownerDocument)==null?void 0:t.body),d=$e(a),s=i?[d].concat(d.visualViewport||[],la(a)?a:[]):a,l=e.concat(s);return i?l:l.concat(zt(bn(s)))}function Zn(n){return Object.assign({},n,{left:n.x,top:n.y,right:n.x+n.width,bottom:n.y+n.height})}function Gd(n,e){var t=At(n,!1,e==="fixed");return t.top=t.top+n.clientTop,t.left=t.left+n.clientLeft,t.bottom=t.top+n.clientHeight,t.right=t.left+n.clientWidth,t.width=n.clientWidth,t.height=n.clientHeight,t.x=t.left,t.y=t.top,t}function Ka(n,e,t){return e===Fi?Zn(jd(n,t)):mt(e)?Gd(e,t):Zn(Ud(st(n)))}function Wd(n){var e=zt(bn(n)),t=["absolute","fixed"].indexOf(Je(n).position)>=0,a=t&&Me(n)?Kt(n):n;return mt(a)?e.filter(function(i){return mt(i)&&Ui(i,a)&&Ke(i)!=="body"}):[]}function Yd(n,e,t,a){var i=e==="clippingParents"?Wd(n):[].concat(e),d=[].concat(i,[t]),s=d[0],l=d.reduce(function(c,h){var v=Ka(n,h,a);return c.top=ht(v.top,c.top),c.right=En(v.right,c.right),c.bottom=En(v.bottom,c.bottom),c.left=ht(v.left,c.left),c},Ka(n,s,a));return l.width=l.right-l.left,l.height=l.bottom-l.top,l.x=l.left,l.y=l.top,l}function qi(n){var e=n.reference,t=n.element,a=n.placement,i=a?Ye(a):null,d=a?$t(a):null,s=e.x+e.width/2-t.width/2,l=e.y+e.height/2-t.height/2,c;switch(i){case De:c={x:s,y:e.y-t.height};break;case Pe:c={x:s,y:e.y+e.height};break;case xe:c={x:e.x+e.width,y:l};break;case ke:c={x:e.x-t.width,y:l};break;default:c={x:e.x,y:e.y}}var h=i?sa(i):null;if(h!=null){var v=h==="y"?"height":"width";switch(d){case Ct:c[h]=c[h]-(e[v]/2-t[v]/2);break;case Gt:c[h]=c[h]+(e[v]/2-t[v]/2);break}}return c}function Wt(n,e){e===void 0&&(e={});var t=e,a=t.placement,i=a===void 0?n.placement:a,d=t.strategy,s=d===void 0?n.strategy:d,l=t.boundary,c=l===void 0?md:l,h=t.rootBoundary,v=h===void 0?Fi:h,I=t.elementContext,S=I===void 0?Vt:I,_=t.altBoundary,O=_===void 0?!1:_,X=t.padding,F=X===void 0?0:X,x=Wi(typeof F!="number"?F:Yi(F,Yt)),C=S===Vt?gd:Vt,G=n.rects.popper,r=n.elements[O?C:S],f=Yd(mt(r)?r:r.contextElement||st(n.elements.popper),c,v,s),u=At(n.elements.reference),p=qi({reference:u,element:G,strategy:"absolute",placement:i}),y=Zn(Object.assign({},G,p)),m=S===Vt?y:u,g={top:f.top-m.top+x.top,bottom:m.bottom-f.bottom+x.bottom,left:f.left-m.left+x.left,right:m.right-f.right+x.right},T=n.modifiersData.offset;if(S===Vt&&T){var M=T[i];Object.keys(g).forEach(function(k){var $=[xe,Pe].indexOf(k)>=0?1:-1,R=[De,Pe].indexOf(k)>=0?"y":"x";g[k]+=M[R]*$})}return g}function Kd(n,e){e===void 0&&(e={});var t=e,a=t.placement,i=t.boundary,d=t.rootBoundary,s=t.padding,l=t.flipVariations,c=t.allowedAutoPlacements,h=c===void 0?Bi:c,v=$t(a),I=v?l?Ua:Ua.filter(function(O){return $t(O)===v}):Yt,S=I.filter(function(O){return h.indexOf(O)>=0});S.length===0&&(S=I);var _=S.reduce(function(O,X){return O[X]=Wt(n,{placement:X,boundary:i,rootBoundary:d,padding:s})[Ye(X)],O},{});return Object.keys(_).sort(function(O,X){return _[O]-_[X]})}function qd(n){if(Ye(n)===aa)return[];var e=cn(n);return[Ya(n),e,Ya(e)]}function Qd(n){var e=n.state,t=n.options,a=n.name;if(!e.modifiersData[a]._skip){for(var i=t.mainAxis,d=i===void 0?!0:i,s=t.altAxis,l=s===void 0?!0:s,c=t.fallbackPlacements,h=t.padding,v=t.boundary,I=t.rootBoundary,S=t.altBoundary,_=t.flipVariations,O=_===void 0?!0:_,X=t.allowedAutoPlacements,F=e.options.placement,x=Ye(F),C=x===F,G=c||(C||!O?[cn(F)]:qd(F)),r=[F].concat(G).reduce(function(se,ne){return se.concat(Ye(ne)===aa?Kd(e,{placement:ne,boundary:v,rootBoundary:I,padding:h,flipVariations:O,allowedAutoPlacements:X}):ne)},[]),f=e.rects.reference,u=e.rects.popper,p=new Map,y=!0,m=r[0],g=0;g<r.length;g++){var T=r[g],M=Ye(T),k=$t(T)===Ct,$=[De,Pe].indexOf(M)>=0,R=$?"width":"height",b=Wt(e,{placement:T,boundary:v,rootBoundary:I,altBoundary:S,padding:h}),A=$?k?xe:ke:k?Pe:De;f[R]>u[R]&&(A=cn(A));var z=cn(A),j=[];if(d&&j.push(b[M]<=0),l&&j.push(b[A]<=0,b[z]<=0),j.every(function(se){return se})){m=T,y=!1;break}p.set(T,j)}if(y)for(var Q=O?3:1,Y=function(ne){var J=r.find(function(L){var P=p.get(L);if(P)return P.slice(0,ne).every(function(U){return U})});if(J)return m=J,"break"},te=Q;te>0;te--){var oe=Y(te);if(oe==="break")break}e.placement!==m&&(e.modifiersData[a]._skip=!0,e.placement=m,e.reset=!0)}}const Zd={name:"flip",enabled:!0,phase:"main",fn:Qd,requiresIfExists:["offset"],data:{_skip:!1}};function qa(n,e,t){return t===void 0&&(t={x:0,y:0}),{top:n.top-e.height-t.y,right:n.right-e.width+t.x,bottom:n.bottom-e.height+t.y,left:n.left-e.width-t.x}}function Qa(n){return[De,xe,Pe,ke].some(function(e){return n[e]>=0})}function Jd(n){var e=n.state,t=n.name,a=e.rects.reference,i=e.rects.popper,d=e.modifiersData.preventOverflow,s=Wt(e,{elementContext:"reference"}),l=Wt(e,{altBoundary:!0}),c=qa(s,a),h=qa(l,i,d),v=Qa(c),I=Qa(h);e.modifiersData[t]={referenceClippingOffsets:c,popperEscapeOffsets:h,isReferenceHidden:v,hasPopperEscaped:I},e.attributes.popper=Object.assign({},e.attributes.popper,{"data-popper-reference-hidden":v,"data-popper-escaped":I})}const el={name:"hide",enabled:!0,phase:"main",requiresIfExists:["preventOverflow"],fn:Jd};function tl(n,e,t){var a=Ye(n),i=[ke,De].indexOf(a)>=0?-1:1,d=typeof t=="function"?t(Object.assign({},e,{placement:n})):t,s=d[0],l=d[1];return s=s||0,l=(l||0)*i,[ke,xe].indexOf(a)>=0?{x:l,y:s}:{x:s,y:l}}function nl(n){var e=n.state,t=n.options,a=n.name,i=t.offset,d=i===void 0?[0,0]:i,s=Bi.reduce(function(v,I){return v[I]=tl(I,e.rects,d),v},{}),l=s[e.placement],c=l.x,h=l.y;e.modifiersData.popperOffsets!=null&&(e.modifiersData.popperOffsets.x+=c,e.modifiersData.popperOffsets.y+=h),e.modifiersData[a]=s}const al={name:"offset",enabled:!0,phase:"main",requires:["popperOffsets"],fn:nl};function il(n){var e=n.state,t=n.name;e.modifiersData[t]=qi({reference:e.rects.reference,element:e.rects.popper,strategy:"absolute",placement:e.placement})}const rl={name:"popperOffsets",enabled:!0,phase:"read",fn:il,data:{}};function sl(n){return n==="x"?"y":"x"}function ol(n){var e=n.state,t=n.options,a=n.name,i=t.mainAxis,d=i===void 0?!0:i,s=t.altAxis,l=s===void 0?!1:s,c=t.boundary,h=t.rootBoundary,v=t.altBoundary,I=t.padding,S=t.tether,_=S===void 0?!0:S,O=t.tetherOffset,X=O===void 0?0:O,F=Wt(e,{boundary:c,rootBoundary:h,padding:I,altBoundary:v}),x=Ye(e.placement),C=$t(e.placement),G=!C,r=sa(x),f=sl(r),u=e.modifiersData.popperOffsets,p=e.rects.reference,y=e.rects.popper,m=typeof X=="function"?X(Object.assign({},e.rects,{placement:e.placement})):X,g=typeof m=="number"?{mainAxis:m,altAxis:m}:Object.assign({mainAxis:0,altAxis:0},m),T=e.modifiersData.offset?e.modifiersData.offset[e.placement]:null,M={x:0,y:0};if(u){if(d){var k,$=r==="y"?De:ke,R=r==="y"?Pe:xe,b=r==="y"?"height":"width",A=u[r],z=A+F[$],j=A-F[R],Q=_?-y[b]/2:0,Y=C===Ct?p[b]:y[b],te=C===Ct?-y[b]:-p[b],oe=e.elements.arrow,se=_&&oe?ra(oe):{width:0,height:0},ne=e.modifiersData["arrow#persistent"]?e.modifiersData["arrow#persistent"].padding:Gi(),J=ne[$],L=ne[R],P=Bt(0,p[b],se[b]),U=G?p[b]/2-Q-P-J-g.mainAxis:Y-P-J-g.mainAxis,re=G?-p[b]/2+Q+P+L+g.mainAxis:te+P+L+g.mainAxis,ae=e.elements.arrow&&Kt(e.elements.arrow),ce=ae?r==="y"?ae.clientTop||0:ae.clientLeft||0:0,ve=(k=T?.[r])!=null?k:0,et=A+U-ve-ce,gt=A+re-ve,ot=Bt(_?En(z,et):z,A,_?ht(j,gt):j);u[r]=ot,M[r]=ot-A}if(l){var dt,vt=r==="x"?De:ke,yt=r==="x"?Pe:xe,Re=u[f],Be=f==="y"?"height":"width",lt=Re+F[vt],qe=Re-F[yt],tt=[De,ke].indexOf(x)!==-1,he=(dt=T?.[f])!=null?dt:0,de=tt?lt:Re-p[Be]-y[Be]-he+g.altAxis,Qe=tt?Re+p[Be]+y[Be]-he-g.altAxis:qe,Et=_&&tt?Ld(de,Re,Qe):Bt(_?de:lt,Re,_?Qe:qe);u[f]=Et,M[f]=Et-Re}e.modifiersData[a]=M}}const dl={name:"preventOverflow",enabled:!0,phase:"main",fn:ol,requiresIfExists:["offset"]};function ll(n){return{scrollLeft:n.scrollLeft,scrollTop:n.scrollTop}}function cl(n){return n===$e(n)||!Me(n)?oa(n):ll(n)}function ul(n){var e=n.getBoundingClientRect(),t=Lt(e.width)/n.offsetWidth||1,a=Lt(e.height)/n.offsetHeight||1;return t!==1||a!==1}function fl(n,e,t){t===void 0&&(t=!1);var a=Me(e),i=Me(e)&&ul(e),d=st(e),s=At(n,i,t),l={scrollLeft:0,scrollTop:0},c={x:0,y:0};return(a||!a&&!t)&&((Ke(e)!=="body"||la(d))&&(l=cl(e)),Me(e)?(c=At(e,!0),c.x+=e.clientLeft,c.y+=e.clientTop):d&&(c.x=da(d))),{x:s.left+l.scrollLeft-c.x,y:s.top+l.scrollTop-c.y,width:s.width,height:s.height}}function pl(n){var e=new Map,t=new Set,a=[];n.forEach(function(d){e.set(d.name,d)});function i(d){t.add(d.name);var s=[].concat(d.requires||[],d.requiresIfExists||[]);s.forEach(function(l){if(!t.has(l)){var c=e.get(l);c&&i(c)}}),a.push(d)}return n.forEach(function(d){t.has(d.name)||i(d)}),a}function hl(n){var e=pl(n);return _d.reduce(function(t,a){return t.concat(e.filter(function(i){return i.phase===a}))},[])}function ml(n){var e;return function(){return e||(e=new Promise(function(t){Promise.resolve().then(function(){e=void 0,t(n())})})),e}}function gl(n){var e=n.reduce(function(t,a){var i=t[a.name];return t[a.name]=i?Object.assign({},i,a,{options:Object.assign({},i.options,a.options),data:Object.assign({},i.data,a.data)}):a,t},{});return Object.keys(e).map(function(t){return e[t]})}var Za={placement:"bottom",modifiers:[],strategy:"absolute"};function Ja(){for(var n=arguments.length,e=new Array(n),t=0;t<n;t++)e[t]=arguments[t];return!e.some(function(a){return!(a&&typeof a.getBoundingClientRect=="function")})}function vl(n){n===void 0&&(n={});var e=n,t=e.defaultModifiers,a=t===void 0?[]:t,i=e.defaultOptions,d=i===void 0?Za:i;return function(l,c,h){h===void 0&&(h=d);var v={placement:"bottom",orderedModifiers:[],options:Object.assign({},Za,d),modifiersData:{},elements:{reference:l,popper:c},attributes:{},styles:{}},I=[],S=!1,_={state:v,setOptions:function(x){var C=typeof x=="function"?x(v.options):x;X(),v.options=Object.assign({},d,v.options,C),v.scrollParents={reference:mt(l)?zt(l):l.contextElement?zt(l.contextElement):[],popper:zt(c)};var G=hl(gl([].concat(a,v.options.modifiers)));return v.orderedModifiers=G.filter(function(r){return r.enabled}),O(),_.update()},forceUpdate:function(){if(!S){var x=v.elements,C=x.reference,G=x.popper;if(Ja(C,G)){v.rects={reference:fl(C,Kt(G),v.options.strategy==="fixed"),popper:ra(G)},v.reset=!1,v.placement=v.options.placement,v.orderedModifiers.forEach(function(g){return v.modifiersData[g.name]=Object.assign({},g.data)});for(var r=0;r<v.orderedModifiers.length;r++){if(v.reset===!0){v.reset=!1,r=-1;continue}var f=v.orderedModifiers[r],u=f.fn,p=f.options,y=p===void 0?{}:p,m=f.name;typeof u=="function"&&(v=u({state:v,options:y,name:m,instance:_})||v)}}}},update:ml(function(){return new Promise(function(F){_.forceUpdate(),F(v)})}),destroy:function(){X(),S=!0}};if(!Ja(l,c))return _;_.setOptions(h).then(function(F){!S&&h.onFirstUpdate&&h.onFirstUpdate(F)});function O(){v.orderedModifiers.forEach(function(F){var x=F.name,C=F.options,G=C===void 0?{}:C,r=F.effect;if(typeof r=="function"){var f=r({state:v,name:x,instance:_,options:G}),u=function(){};I.push(f||u)}})}function X(){I.forEach(function(F){return F()}),I=[]}return _}}var yl=[Fd,rl,Vd,zi,al,Zd,dl,Pd,el],El=vl({defaultModifiers:yl}),Il="tippy-box",Qi="tippy-content",wl="tippy-backdrop",Zi="tippy-arrow",Ji="tippy-svg-arrow",pt={passive:!0,capture:!0},er=function(){return document.body};function Hn(n,e,t){if(Array.isArray(n)){var a=n[e];return a??(Array.isArray(t)?t[e]:t)}return n}function ca(n,e){var t={}.toString.call(n);return t.indexOf("[object")===0&&t.indexOf(e+"]")>-1}function tr(n,e){return typeof n=="function"?n.apply(void 0,e):n}function ei(n,e){if(e===0)return n;var t;return function(a){clearTimeout(t),t=setTimeout(function(){n(a)},e)}}function bl(n){return n.split(/\s+/).filter(Boolean)}function _t(n){return[].concat(n)}function ti(n,e){n.indexOf(e)===-1&&n.push(e)}function Tl(n){return n.filter(function(e,t){return n.indexOf(e)===t})}function Nl(n){return n.split("-")[0]}function In(n){return[].slice.call(n)}function ni(n){return Object.keys(n).reduce(function(e,t){return n[t]!==void 0&&(e[t]=n[t]),e},{})}function jt(){return document.createElement("div")}function Tn(n){return["Element","Fragment"].some(function(e){return ca(n,e)})}function Sl(n){return ca(n,"NodeList")}function _l(n){return ca(n,"MouseEvent")}function Ol(n){return!!(n&&n._tippy&&n._tippy.reference===n)}function Dl(n){return Tn(n)?[n]:Sl(n)?In(n):Array.isArray(n)?n:In(document.querySelectorAll(n))}function Fn(n,e){n.forEach(function(t){t&&(t.style.transitionDuration=e+"ms")})}function ai(n,e){n.forEach(function(t){t&&t.setAttribute("data-state",e)})}function kl(n){var e,t=_t(n),a=t[0];return a!=null&&(e=a.ownerDocument)!=null&&e.body?a.ownerDocument:document}function Cl(n,e){var t=e.clientX,a=e.clientY;return n.every(function(i){var d=i.popperRect,s=i.popperState,l=i.props,c=l.interactiveBorder,h=Nl(s.placement),v=s.modifiersData.offset;if(!v)return!0;var I=h==="bottom"?v.top.y:0,S=h==="top"?v.bottom.y:0,_=h==="right"?v.left.x:0,O=h==="left"?v.right.x:0,X=d.top-a+I>c,F=a-d.bottom-S>c,x=d.left-t+_>c,C=t-d.right-O>c;return X||F||x||C})}function Bn(n,e,t){var a=e+"EventListener";["transitionend","webkitTransitionEnd"].forEach(function(i){n[a](i,t)})}function ii(n,e){for(var t=e;t;){var a;if(n.contains(t))return!0;t=t.getRootNode==null||(a=t.getRootNode())==null?void 0:a.host}return!1}var je={isTouch:!1},ri=0;function Ll(){je.isTouch||(je.isTouch=!0,window.performance&&document.addEventListener("mousemove",nr))}function nr(){var n=performance.now();n-ri<20&&(je.isTouch=!1,document.removeEventListener("mousemove",nr)),ri=n}function Al(){var n=document.activeElement;if(Ol(n)){var e=n._tippy;n.blur&&!e.state.isVisible&&n.blur()}}function $l(){document.addEventListener("touchstart",Ll,pt),window.addEventListener("blur",Al)}var Ml=typeof window<"u"&&typeof document<"u",Pl=Ml?!!window.msCrypto:!1,xl={animateFill:!1,followCursor:!1,inlinePositioning:!1,sticky:!1},Rl={allowHTML:!1,animation:"fade",arrow:!0,content:"",inertia:!1,maxWidth:350,role:"tooltip",theme:"",zIndex:9999},He=Object.assign({appendTo:er,aria:{content:"auto",expanded:"auto"},delay:0,duration:[300,250],getReferenceClientRect:null,hideOnClick:!0,ignoreAttributes:!1,interactive:!1,interactiveBorder:2,interactiveDebounce:0,moveTransition:"",offset:[0,10],onAfterUpdate:function(){},onBeforeUpdate:function(){},onCreate:function(){},onDestroy:function(){},onHidden:function(){},onHide:function(){},onMount:function(){},onShow:function(){},onShown:function(){},onTrigger:function(){},onUntrigger:function(){},onClickOutside:function(){},placement:"top",plugins:[],popperOptions:{},render:null,showOnCreate:!1,touch:!0,trigger:"mouseenter focus",triggerTarget:null},xl,Rl),Xl=Object.keys(He),Vl=function(e){var t=Object.keys(e);t.forEach(function(a){He[a]=e[a]})};function ar(n){var e=n.plugins||[],t=e.reduce(function(a,i){var d=i.name,s=i.defaultValue;if(d){var l;a[d]=n[d]!==void 0?n[d]:(l=He[d])!=null?l:s}return a},{});return Object.assign({},n,t)}function Hl(n,e){var t=e?Object.keys(ar(Object.assign({},He,{plugins:e}))):Xl,a=t.reduce(function(i,d){var s=(n.getAttribute("data-tippy-"+d)||"").trim();if(!s)return i;if(d==="content")i[d]=s;else try{i[d]=JSON.parse(s)}catch{i[d]=s}return i},{});return a}function si(n,e){var t=Object.assign({},e,{content:tr(e.content,[n])},e.ignoreAttributes?{}:Hl(n,e.plugins));return t.aria=Object.assign({},He.aria,t.aria),t.aria={expanded:t.aria.expanded==="auto"?e.interactive:t.aria.expanded,content:t.aria.content==="auto"?e.interactive?null:"describedby":t.aria.content},t}var Fl=function(){return"innerHTML"};function Jn(n,e){n[Fl()]=e}function oi(n){var e=jt();return n===!0?e.className=Zi:(e.className=Ji,Tn(n)?e.appendChild(n):Jn(e,n)),e}function di(n,e){Tn(e.content)?(Jn(n,""),n.appendChild(e.content)):typeof e.content!="function"&&(e.allowHTML?Jn(n,e.content):n.textContent=e.content)}function ea(n){var e=n.firstElementChild,t=In(e.children);return{box:e,content:t.find(function(a){return a.classList.contains(Qi)}),arrow:t.find(function(a){return a.classList.contains(Zi)||a.classList.contains(Ji)}),backdrop:t.find(function(a){return a.classList.contains(wl)})}}function ir(n){var e=jt(),t=jt();t.className=Il,t.setAttribute("data-state","hidden"),t.setAttribute("tabindex","-1");var a=jt();a.className=Qi,a.setAttribute("data-state","hidden"),di(a,n.props),e.appendChild(t),t.appendChild(a),i(n.props,n.props);function i(d,s){var l=ea(e),c=l.box,h=l.content,v=l.arrow;s.theme?c.setAttribute("data-theme",s.theme):c.removeAttribute("data-theme"),typeof s.animation=="string"?c.setAttribute("data-animation",s.animation):c.removeAttribute("data-animation"),s.inertia?c.setAttribute("data-inertia",""):c.removeAttribute("data-inertia"),c.style.maxWidth=typeof s.maxWidth=="number"?s.maxWidth+"px":s.maxWidth,s.role?c.setAttribute("role",s.role):c.removeAttribute("role"),(d.content!==s.content||d.allowHTML!==s.allowHTML)&&di(h,n.props),s.arrow?v?d.arrow!==s.arrow&&(c.removeChild(v),c.appendChild(oi(s.arrow))):c.appendChild(oi(s.arrow)):v&&c.removeChild(v)}return{popper:e,onUpdate:i}}ir.$$tippy=!0;var Bl=1,dn=[],zn=[];function zl(n,e){var t=si(n,Object.assign({},He,ar(ni(e)))),a,i,d,s=!1,l=!1,c=!1,h=!1,v,I,S,_=[],O=ei(et,t.interactiveDebounce),X,F=Bl++,x=null,C=Tl(t.plugins),G={isEnabled:!0,isVisible:!1,isDestroyed:!1,isMounted:!1,isShown:!1},r={id:F,reference:n,popper:jt(),popperInstance:x,props:t,state:G,plugins:C,clearDelayTimeouts:de,setProps:Qe,setContent:Et,show:Pt,hide:N,hideWithInteractivity:V,enable:tt,disable:he,unmount:H,destroy:K};if(!t.render)return r;var f=t.render(r),u=f.popper,p=f.onUpdate;u.setAttribute("data-tippy-root",""),u.id="tippy-"+r.id,r.popper=u,n._tippy=r,u._tippy=r;var y=C.map(function(D){return D.fn(r)}),m=n.hasAttribute("aria-expanded");return ae(),Q(),A(),z("onCreate",[r]),t.showOnCreate&&lt(),u.addEventListener("mouseenter",function(){r.props.interactive&&r.state.isVisible&&r.clearDelayTimeouts()}),u.addEventListener("mouseleave",function(){r.props.interactive&&r.props.trigger.indexOf("mouseenter")>=0&&$().addEventListener("mousemove",O)}),r;function g(){var D=r.props.touch;return Array.isArray(D)?D:[D,0]}function T(){return g()[0]==="hold"}function M(){var D;return!!((D=r.props.render)!=null&&D.$$tippy)}function k(){return X||n}function $(){var D=k().parentNode;return D?kl(D):document}function R(){return ea(u)}function b(D){return r.state.isMounted&&!r.state.isVisible||je.isTouch||v&&v.type==="focus"?0:Hn(r.props.delay,D?0:1,He.delay)}function A(D){D===void 0&&(D=!1),u.style.pointerEvents=r.props.interactive&&!D?"":"none",u.style.zIndex=""+r.props.zIndex}function z(D,B,W){if(W===void 0&&(W=!0),y.forEach(function(q){q[D]&&q[D].apply(q,B)}),W){var Z;(Z=r.props)[D].apply(Z,B)}}function j(){var D=r.props.aria;if(D.content){var B="aria-"+D.content,W=u.id,Z=_t(r.props.triggerTarget||n);Z.forEach(function(q){var le=q.getAttribute(B);if(r.state.isVisible)q.setAttribute(B,le?le+" "+W:W);else{var pe=le&&le.replace(W,"").trim();pe?q.setAttribute(B,pe):q.removeAttribute(B)}})}}function Q(){if(!(m||!r.props.aria.expanded)){var D=_t(r.props.triggerTarget||n);D.forEach(function(B){r.props.interactive?B.setAttribute("aria-expanded",r.state.isVisible&&B===k()?"true":"false"):B.removeAttribute("aria-expanded")})}}function Y(){$().removeEventListener("mousemove",O),dn=dn.filter(function(D){return D!==O})}function te(D){if(!(je.isTouch&&(c||D.type==="mousedown"))){var B=D.composedPath&&D.composedPath()[0]||D.target;if(!(r.props.interactive&&ii(u,B))){if(_t(r.props.triggerTarget||n).some(function(W){return ii(W,B)})){if(je.isTouch||r.state.isVisible&&r.props.trigger.indexOf("click")>=0)return}else z("onClickOutside",[r,D]);r.props.hideOnClick===!0&&(r.clearDelayTimeouts(),r.hide(),l=!0,setTimeout(function(){l=!1}),r.state.isMounted||J())}}}function oe(){c=!0}function se(){c=!1}function ne(){var D=$();D.addEventListener("mousedown",te,!0),D.addEventListener("touchend",te,pt),D.addEventListener("touchstart",se,pt),D.addEventListener("touchmove",oe,pt)}function J(){var D=$();D.removeEventListener("mousedown",te,!0),D.removeEventListener("touchend",te,pt),D.removeEventListener("touchstart",se,pt),D.removeEventListener("touchmove",oe,pt)}function L(D,B){U(D,function(){!r.state.isVisible&&u.parentNode&&u.parentNode.contains(u)&&B()})}function P(D,B){U(D,B)}function U(D,B){var W=R().box;function Z(q){q.target===W&&(Bn(W,"remove",Z),B())}if(D===0)return B();Bn(W,"remove",I),Bn(W,"add",Z),I=Z}function re(D,B,W){W===void 0&&(W=!1);var Z=_t(r.props.triggerTarget||n);Z.forEach(function(q){q.addEventListener(D,B,W),_.push({node:q,eventType:D,handler:B,options:W})})}function ae(){T()&&(re("touchstart",ve,{passive:!0}),re("touchend",gt,{passive:!0})),bl(r.props.trigger).forEach(function(D){if(D!=="manual")switch(re(D,ve),D){case"mouseenter":re("mouseleave",gt);break;case"focus":re(Pl?"focusout":"blur",ot);break;case"focusin":re("focusout",ot);break}})}function ce(){_.forEach(function(D){var B=D.node,W=D.eventType,Z=D.handler,q=D.options;B.removeEventListener(W,Z,q)}),_=[]}function ve(D){var B,W=!1;if(!(!r.state.isEnabled||dt(D)||l)){var Z=((B=v)==null?void 0:B.type)==="focus";v=D,X=D.currentTarget,Q(),!r.state.isVisible&&_l(D)&&dn.forEach(function(q){return q(D)}),D.type==="click"&&(r.props.trigger.indexOf("mouseenter")<0||s)&&r.props.hideOnClick!==!1&&r.state.isVisible?W=!0:lt(D),D.type==="click"&&(s=!W),W&&!Z&&qe(D)}}function et(D){var B=D.target,W=k().contains(B)||u.contains(B);if(!(D.type==="mousemove"&&W)){var Z=Be().concat(u).map(function(q){var le,pe=q._tippy,Te=(le=pe.popperInstance)==null?void 0:le.state;return Te?{popperRect:q.getBoundingClientRect(),popperState:Te,props:t}:null}).filter(Boolean);Cl(Z,D)&&(Y(),qe(D))}}function gt(D){var B=dt(D)||r.props.trigger.indexOf("click")>=0&&s;if(!B){if(r.props.interactive){r.hideWithInteractivity(D);return}qe(D)}}function ot(D){r.props.trigger.indexOf("focusin")<0&&D.target!==k()||r.props.interactive&&D.relatedTarget&&u.contains(D.relatedTarget)||qe(D)}function dt(D){return je.isTouch?T()!==D.type.indexOf("touch")>=0:!1}function vt(){yt();var D=r.props,B=D.popperOptions,W=D.placement,Z=D.offset,q=D.getReferenceClientRect,le=D.moveTransition,pe=M()?ea(u).arrow:null,Te=q?{getBoundingClientRect:q,contextElement:q.contextElement||k()}:n,ua={name:"$$tippy",enabled:!0,phase:"beforeWrite",requires:["computeStyles"],fn:function(Qt){var It=Qt.state;if(M()){var rr=R(),Sn=rr.box;["placement","reference-hidden","escaped"].forEach(function(Zt){Zt==="placement"?Sn.setAttribute("data-placement",It.placement):It.attributes.popper["data-popper-"+Zt]?Sn.setAttribute("data-"+Zt,""):Sn.removeAttribute("data-"+Zt)}),It.attributes.popper={}}}},ct=[{name:"offset",options:{offset:Z}},{name:"preventOverflow",options:{padding:{top:2,bottom:2,left:5,right:5}}},{name:"flip",options:{padding:5}},{name:"computeStyles",options:{adaptive:!le}},ua];M()&&pe&&ct.push({name:"arrow",options:{element:pe,padding:3}}),ct.push.apply(ct,B?.modifiers||[]),r.popperInstance=El(Te,u,Object.assign({},B,{placement:W,onFirstUpdate:S,modifiers:ct}))}function yt(){r.popperInstance&&(r.popperInstance.destroy(),r.popperInstance=null)}function Re(){var D=r.props.appendTo,B,W=k();r.props.interactive&&D===er||D==="parent"?B=W.parentNode:B=tr(D,[W]),B.contains(u)||B.appendChild(u),r.state.isMounted=!0,vt()}function Be(){return In(u.querySelectorAll("[data-tippy-root]"))}function lt(D){r.clearDelayTimeouts(),D&&z("onTrigger",[r,D]),ne();var B=b(!0),W=g(),Z=W[0],q=W[1];je.isTouch&&Z==="hold"&&q&&(B=q),B?a=setTimeout(function(){r.show()},B):r.show()}function qe(D){if(r.clearDelayTimeouts(),z("onUntrigger",[r,D]),!r.state.isVisible){J();return}if(!(r.props.trigger.indexOf("mouseenter")>=0&&r.props.trigger.indexOf("click")>=0&&["mouseleave","mousemove"].indexOf(D.type)>=0&&s)){var B=b(!1);B?i=setTimeout(function(){r.state.isVisible&&r.hide()},B):d=requestAnimationFrame(function(){r.hide()})}}function tt(){r.state.isEnabled=!0}function he(){r.hide(),r.state.isEnabled=!1}function de(){clearTimeout(a),clearTimeout(i),cancelAnimationFrame(d)}function Qe(D){if(!r.state.isDestroyed){z("onBeforeUpdate",[r,D]),ce();var B=r.props,W=si(n,Object.assign({},B,ni(D),{ignoreAttributes:!0}));r.props=W,ae(),B.interactiveDebounce!==W.interactiveDebounce&&(Y(),O=ei(et,W.interactiveDebounce)),B.triggerTarget&&!W.triggerTarget?_t(B.triggerTarget).forEach(function(Z){Z.removeAttribute("aria-expanded")}):W.triggerTarget&&n.removeAttribute("aria-expanded"),Q(),A(),p&&p(B,W),r.popperInstance&&(vt(),Be().forEach(function(Z){requestAnimationFrame(Z._tippy.popperInstance.forceUpdate)})),z("onAfterUpdate",[r,D])}}function Et(D){r.setProps({content:D})}function Pt(){var D=r.state.isVisible,B=r.state.isDestroyed,W=!r.state.isEnabled,Z=je.isTouch&&!r.props.touch,q=Hn(r.props.duration,0,He.duration);if(!(D||B||W||Z)&&!k().hasAttribute("disabled")&&(z("onShow",[r],!1),r.props.onShow(r)!==!1)){if(r.state.isVisible=!0,M()&&(u.style.visibility="visible"),A(),ne(),r.state.isMounted||(u.style.transition="none"),M()){var le=R(),pe=le.box,Te=le.content;Fn([pe,Te],0)}S=function(){var ct;if(!(!r.state.isVisible||h)){if(h=!0,u.offsetHeight,u.style.transition=r.props.moveTransition,M()&&r.props.animation){var Nn=R(),Qt=Nn.box,It=Nn.content;Fn([Qt,It],q),ai([Qt,It],"visible")}j(),Q(),ti(zn,r),(ct=r.popperInstance)==null||ct.forceUpdate(),z("onMount",[r]),r.props.animation&&M()&&P(q,function(){r.state.isShown=!0,z("onShown",[r])})}},Re()}}function N(){var D=!r.state.isVisible,B=r.state.isDestroyed,W=!r.state.isEnabled,Z=Hn(r.props.duration,1,He.duration);if(!(D||B||W)&&(z("onHide",[r],!1),r.props.onHide(r)!==!1)){if(r.state.isVisible=!1,r.state.isShown=!1,h=!1,s=!1,M()&&(u.style.visibility="hidden"),Y(),J(),A(!0),M()){var q=R(),le=q.box,pe=q.content;r.props.animation&&(Fn([le,pe],Z),ai([le,pe],"hidden"))}j(),Q(),r.props.animation?M()&&L(Z,r.unmount):r.unmount()}}function V(D){$().addEventListener("mousemove",O),ti(dn,O),O(D)}function H(){r.state.isVisible&&r.hide(),r.state.isMounted&&(yt(),Be().forEach(function(D){D._tippy.unmount()}),u.parentNode&&u.parentNode.removeChild(u),zn=zn.filter(function(D){return D!==r}),r.state.isMounted=!1,z("onHidden",[r]))}function K(){r.state.isDestroyed||(r.clearDelayTimeouts(),r.unmount(),ce(),delete n._tippy,r.state.isDestroyed=!0,z("onDestroy",[r]))}}function qt(n,e){e===void 0&&(e={});var t=He.plugins.concat(e.plugins||[]);$l();var a=Object.assign({},e,{plugins:t}),i=Dl(n),d=i.reduce(function(s,l){var c=l&&zl(l,a);return c&&s.push(c),s},[]);return Tn(n)?d[0]:d}qt.defaultProps=He;qt.setDefaultProps=Vl;qt.currentInput=je;Object.assign({},zi,{effect:function(e){var t=e.state,a={popper:{position:t.options.strategy,left:"0",top:"0",margin:"0"},arrow:{position:"absolute"},reference:{}};Object.assign(t.elements.popper.style,a.popper),t.styles=a,t.elements.arrow&&Object.assign(t.elements.arrow.style,a.arrow)}});qt.setDefaultProps({render:ir});function jl(n,e){const t=document.getElementById(`${n}`);t&&qt(t,{content:e,theme:"battlesystem"})}function Ul(){const n=new Map;n.set("tip_gmtokens","Note: GM-owned tokens give universal vision."),n.set("visionRangeHeader","Range: How far this token can see. Click to Mass Edit"),n.set("visionFalloffHeader","Falloff: The blurred edge of the vision range. Click to Mass Edit"),n.set("visionBlindHeader","Blind: If this token is temporarily without sight."),n.set("visionHideHeader","Move token to the 'Out-of-Sight' list"),n.set("visionBumperHeader","Collision Distance: How close this token can get to an active wall. Click to Mass Edit"),n.set("visionInAngleHeader","Inner Angle: Inner angle of token vision, for hard edge, match with Outer Angle. Click to Mass Edit"),n.set("visionOutAngleHeader","Outer Angle:  Outer angle of token vision, for hard edge, match with Inner Angle. Click to Mass Edit"),n.set("visionDarkHeader","Greyscale: Add an 'outer-ring' of visible greyscale outside of your vision (Darkvision-Esque). Click to Mass Edit"),n.set("tip_spectretokens","Spectre tokens are only visible to specific players. Enable vision here after it has been Spectred."),n.set("tip_fogfill","Toggle to enable/disable fog fill for the scene."),n.set("tip_disablevision","Toggle to enable/disable vision for all tokens in scene."),n.set("tip_persistence","Toggle to enable/disable persistence vision for tokens. This will leave the map revealed as they travel."),n.set("tip_playerdoors","Toggle to enable/disable players being able to see and use doors on their own."),n.set("tip_ownerrings","Toggle to enable/disable the colored rings seen around a player to indicate their vision radius. GM-Only."),n.set("tip_gridsnap","Toggle to enable/disable grid snapping when drawing Obstruction Lines and Objects. This is separate from the default OBR Snap setting."),n.set("tip_unitcontextmenu","Enable to show the Unit Vision Settings on the Context Menu for tokens"),n.set("tip_wallcontextmenu","Enable to show the Advanced Wall Settings on the Context Menu for Obstructions"),n.set("tip_autohide","Enable to show the Autohide Option on tokens as well as enable Autohide functionality"),n.set("tip_trailingfog","Enable to 'fog' areas that have been revealed by Persistence, but a token is not currently in."),n.set("tip_gmwalls","Toggle to enable/disable the blocking of walls for the GM only."),n.set("tip_defaultelevation","Toggle the Default Elevation Layer. This is the layer a token/wall is set at when it's not on a specific mapping."),n.set("tip_elevationstyle","Toggle to change how Elevations treat walls. Mesa will allow tokens to see over walls at elevations above 0. City will have them all behave the same."),n.set("doublewall_button","This will change ALL walls within the scene to be double-sided, so they cannot be passed from either side."),n.set("block_button","This will set all walls to be Blocking walls, so that tokens cannot move past them."),n.set("unblock_button","This will set all walls to be Passable walls, so that tokens can move through them."),n.set("lock_button","This will lock all obstruction lines, so they cannot be accidentally (or purposefully) moved."),n.set("unlock_button","This will unlock all obstruction lines so they can be moved and/or editted."),n.set("reset_persistence","This will reset all persistence on a map, for all players in the room."),n.set("preview_select","This will allow you to view fog as the selected Player would see it."),n.set("tip_visionDefault","Set the default vision distance for new tokens."),n.set("tip_collisionDefault","Set the default collision range for new tokens."),n.set("tip_falloffDefault","Set the default falloff range for new tokens (having this on by default will increase GPU usage)."),n.set("tip_greyscaleDefault","Set the default greyscale vision range (should be higher than token Vision to take effect)."),n.set("tip_innerAngleDefault","Set the default inner angle radius."),n.set("tip_outerAngleDefault","Set the default outer angle radius."),n.forEach((e,t)=>{jl(t,e)})}class Gl{static async CenterViewportOnImage(e){const t=await w.scene.grid.getDpi(),a=await w.viewport.getScale(),i=await w.viewport.getWidth(),d=await w.viewport.getHeight(),s={x:i/2,y:d/2},l={x:s.x/a,y:s.y/a},c=await this.GetImageCenter(e,t),h={x:c.x-l.x,y:c.y-l.y},v={x:h.x*a*-1,y:h.y*a*-1};await w.viewport.animateTo({position:v,scale:a})}static async GetImageCenter(e,t){if(gr(e)){const a=t/e.grid.dpi,i=e.image.width*a,d=e.image.height*a,s=e.grid.offset.x/e.image.width*i,l=e.grid.offset.y/e.image.height*d;return{x:e.position.x-s+i/2,y:e.position.y-l+d/2}}else return mr(e)&&e.points.length>0?{x:e.points[0].x,y:e.points[0].y}:{x:e.position.x,y:e.position.y}}}class St{headerName;element;popover;input;checkboxButton;okButton;onSubmitCallback;constructor(e,t,a,i="200px"){const d=document.querySelector(e);if(!d||!(d instanceof HTMLElement))throw new Error(`Element with selector "${e}" not found or is not an HTMLElement`);this.element=d,this.headerName=a,this.onSubmitCallback=t,this.createPopover(i),this.addEventListeners()}createPopover(e){this.popover=document.createElement("div"),this.popover.classList.add("mass-editor-popover"),this.popover.style.width=e,this.input=document.createElement("input"),this.input.type="number",this.input.style.cssText=`
        margin-right: 5px;
        `;const t=document.createElement("div");t.innerText=`Set All ${this.headerName} to`;const a=document.createElement("div");a.style.display="flex",a.style.width="100%",a.style.placeContent="center";const i=document.createElement("div");i.style.display="flex",i.style.width="100%",i.style.placeContent="center",this.okButton=document.createElement("button"),this.okButton.classList.add("popover-button"),this.okButton.textContent="OK",this.okButton.style.width="40px";const d=document.createElement("div");d.style.paddingLeft="4px",d.style.paddingRight="4px",d.textContent="Include Torches:",this.checkboxButton=document.createElement("input"),this.checkboxButton.type="checkbox",this.popover.appendChild(t),this.popover.appendChild(i),this.popover.appendChild(a),i.appendChild(this.input),i.appendChild(this.okButton),a.appendChild(d),a.appendChild(this.checkboxButton),document.body.appendChild(this.popover)}addEventListeners(){this.element.addEventListener("click",this.handleClick.bind(this)),this.okButton.addEventListener("click",this.handleSubmit.bind(this)),document.addEventListener("click",this.handleOutsideClick.bind(this))}handleClick(e){const t=this.element.getBoundingClientRect(),{left:a,top:i}=this.calculatePopoverPosition(t);this.popover.style.display="block",this.popover.style.left="calc(50% - 100px)",this.popover.style.top=`${i}px`,this.input.focus(),e.stopPropagation()}calculatePopoverPosition(e){const t=this.popover.getBoundingClientRect(),a=window.innerWidth;let i=e.left,d=e.top-t.height-5;return i+t.width>a&&(i=a-t.width-50),d<0&&(d=e.bottom+5),{left:i,top:d}}handleSubmit(){const e=Number(this.input.value),t=this.checkboxButton.checked;isNaN(e)||(this.onSubmitCallback(e,t),this.hidePopover())}handleOutsideClick(e){e.target instanceof Node&&!this.popover.contains(e.target)&&e.target!==this.element&&this.hidePopover()}hidePopover(){this.popover.style.display="none",this.input.value=""}}class Wl{mainWindow=document.getElementById("app");smokeViewToggle;spectreViewToggle;settingsViewToggle;helpViewToggle;smokeViewPanel;spectreViewPanel;settingsViewPanel;helpViewPanel;patreonContainer;onVisionPanelMain=!0;visionPanelMain;visionPanelSub;smokeUnitTablePrime;smokeUnitTableSub;tokenList;hiddenList;version;constructor(e){this.version=`SMOKEANDSPECTRE-${e}`}async Stop(){await w.action.setHeight(100),await w.action.setWidth(300),this.mainWindow.innerHTML=`
        <div id="stopScreen">
            Awaiting Scene...
        </div>
        `}async Start(){function e(){const t="test";try{return localStorage.setItem(t,"1"),localStorage.removeItem(t),!0}catch{return!1}}if(e()?localStorage.getItem("NOTICED")!=="true"&&(await w.modal.open({id:o.EXTENSIONNOTICE,url:`/src/notice/notice.html?subscriber=${E.USER_REGISTERED}`,height:400,width:500}),localStorage.setItem("NOTICED","true")):console.log("localStorage is disabled, not showing the notice. You should definitely check the Patreon."),E.playerRole==="GM"){await w.action.setHeight(530),await w.action.setWidth(420);const a=await w.viewport.getWidth()<400;this.mainWindow.innerHTML=a?o.SMOKEMOBILEMAIN:o.SMOKEMAIN,this.smokeViewToggle=document.getElementById("smokeViewToggle"),this.spectreViewToggle=document.getElementById("spectreViewToggle"),this.settingsViewToggle=document.getElementById("settingsViewToggle"),this.helpViewToggle=document.getElementById("helpViewToggle"),this.smokeViewPanel=document.getElementById("smokeViewPanel"),this.spectreViewPanel=document.getElementById("spectreViewPanel"),this.settingsViewPanel=document.getElementById("settingsViewPanel"),this.helpViewPanel=document.getElementById("helpViewPanel"),this.patreonContainer=document.getElementById("patreonContainer"),this.smokeViewPanel.innerHTML=a?o.SMOKEMOBILEHTML:o.SMOKEHTML,this.spectreViewPanel.innerHTML=o.SPECTREHTML,this.settingsViewPanel.innerHTML=a?o.SETTINGSMOBILEHTML:o.SETTINGSHTML;const i=document.getElementById("playerListing");i.appendChild(this.GetEmptyContextItem("Self"));const d=document.getElementById("preview_select");d.innerHTML="";const s=document.createElement("option");s.value=E.playerId,s.textContent="View As: Self",d.appendChild(s);for(const l of E.party){const c=document.createElement("li");c.id=l.id,c.textContent=l.name,c.style.color=l.color,i.appendChild(c);const h=document.createElement("option");h.value=l.id,h.textContent=`View As: ${l.name}`,h.style.color=l.color,d.appendChild(h)}Fe.init(),await Go(),this.SetupHelpDocuments(),this.SetupGMPanelHandlers(),this.UpdateVisionList(),Jo(a),Fa(),hd(),Ul(),await Ot.Initialize()}else await w.action.setHeight(300),await w.action.setWidth(300),this.mainWindow.innerHTML=`
                <div id="titleHolder" style="display: flex; width: 100%;">
                    <div style="width:60%;">Tokens You Own</div>
                    <div style="width:30%;">Vision</div>
                    <div style="width:10%;" id="patreonContainer"></div>
                </div>
                <div id="playerView" class="scrollable-table">
                    <table id="playerViewTable">
                    <thead>
                        <tr id="playerViewTableHeader">
                            <th style="width: 70%;"></th>
                            <th style="width: 20%;"></th>
                            <th style="width: 10%;"></th>
                        </tr>
                    </thead>
                        <tbody id="playerViewTableBody">
                        </tbody>
                    </table>
                </div>
            `,this.UpdatePlayerView(),this.patreonContainer=document.getElementById("patreonContainer");await this.InitializeScene(),this.patreonContainer?.appendChild(Er())}UpdatePlayerView(){const e=E.sceneItems.filter(i=>Yr(i)),t=document.getElementsByClassName("token-table-entry");this.CleanVisionList(e,t);const a=document.getElementById("playerViewTable");for(const i of e){const d=document.getElementById(`pl-${i.id}`);if(d){const s=d.getElementsByClassName("token-name")[0],l=d.getElementsByClassName("token-aradius")[0],c=d.getElementsByClassName("token-distancetype")[0];s&&(s.textContent=i.text?.plainText||i.name),l&&(l.textContent=i.metadata[`${o.EXTENSIONID}/visionRange`]!==void 0?i.metadata[`${o.EXTENSIONID}/visionRange`]:Ae()),c&&(c.textContent=E.gridType)}else{const s=document.createElement("tr");s.id=`pl-${i.id}`,s.classList.add("token-table-entry");const l=document.createElement("td");l.textContent=i.text?.plainText||i.name,l.classList.add("player-token-name"),s.appendChild(l);const c=document.createElement("td");c.textContent=i.metadata[`${o.EXTENSIONID}/visionRange`]!==void 0?i.metadata[`${o.EXTENSIONID}/visionRange`]:Ae(),s.appendChild(c);const h=document.createElement("td");h.textContent=E.gridType,s.appendChild(h),a.appendChild(s)}}}GetEmptyContextItem(e){const t=document.createElement("li");return t.id=E.playerId,t.textContent=e,t}SetupGMPanelHandlers(){this.SetupViewPanel(),this.smokeViewToggle.onclick=t=>{t.preventDefault(),e(ie.smokeViewToggle,ie.smokeViewPanel)},this.spectreViewToggle.onclick=t=>{t.preventDefault(),e(ie.spectreViewToggle,ie.spectreViewPanel)},this.settingsViewToggle.onclick=t=>{t.preventDefault(),e(ie.settingsViewToggle,ie.settingsViewPanel)},this.helpViewToggle.onclick=t=>{t.preventDefault(),e(ie.helpViewToggle,ie.helpViewPanel)};function e(t,a){ie.smokeViewToggle?.classList.remove("selected"),ie.spectreViewToggle?.classList.remove("selected"),ie.settingsViewToggle?.classList.remove("selected"),ie.helpViewToggle?.classList.remove("selected"),ie.smokeViewPanel.style.display="none",ie.spectreViewPanel.style.display="none",ie.settingsViewPanel.style.display="none",ie.helpViewPanel.style.display="none",t.classList.add("selected"),a.style.display="block"}}async OnDataChange(){await Ee.Run(),await Ot.Run(),E.playerRole==="GM"?(this.UpdateVisionList(),Fa()):this.UpdatePlayerView()}async InitializeScene(){await Ee.Initialize(),await Ee.Run(!0),await Ot.Run()}UpdateVisionList(){if(!document.getElementById("token_list"))return;const t=E.sceneItems.filter(i=>Ce(i)),a=document.getElementsByClassName("token-table-entry");this.CleanVisionList(t,a);for(const i of t){const d=document.getElementById(`tr-${i.id}`);d?this.UpdateTokenOnVisionList(i,d):this.AddTokenToVisionList(i)}}SetupMassEditors(){const e=async(l,c)=>{let h=l;l<0&&(h=0),l>999&&(h=999);const v=c?E.sceneItems.filter(I=>Ce(I)):E.sceneItems.filter(I=>!wt(I)&&Ce(I));await w.scene.items.updateItems(v.map(I=>I.id),I=>{for(let S of I)S.metadata[`${o.EXTENSIONID}/visionRange`]=h.toString()})},t=async(l,c)=>{let h=l;l<0&&(h=0),l>10&&(h=10);const v=c?E.sceneItems.filter(I=>Ce(I)):E.sceneItems.filter(I=>!wt(I)&&Ce(I));await w.scene.items.updateItems(v.map(I=>I.id),I=>{for(let S of I)S.metadata[`${o.EXTENSIONID}/visionFallOff`]=h.toString()})},a=async(l,c)=>{let h=l;l<0&&(h=0),l>999&&(h=999);const v=c?E.sceneItems.filter(I=>Ce(I)):E.sceneItems.filter(I=>!wt(I)&&Ce(I));await w.scene.items.updateItems(v.map(I=>I.id),I=>{for(let S of I)S.metadata[`${o.EXTENSIONID}/visionSourceRange`]=h.toString()})},i=async(l,c)=>{let h=l;l<0&&(h=0),l>360&&(h=360);const v=c?E.sceneItems.filter(I=>Ce(I)):E.sceneItems.filter(I=>!wt(I)&&Ce(I));await w.scene.items.updateItems(v.map(I=>I.id),I=>{for(let S of I)S.metadata[`${o.EXTENSIONID}/visionInAngle`]=h.toString()})},d=async(l,c)=>{let h=l;l<0&&(h=0),l>360&&(h=360);const v=c?E.sceneItems.filter(I=>Ce(I)):E.sceneItems.filter(I=>!wt(I)&&Ce(I));await w.scene.items.updateItems(v.map(I=>I.id),I=>{for(let S of I)S.metadata[`${o.EXTENSIONID}/visionOutAngle`]=h.toString()})},s=async(l,c)=>{let h=l;l<0&&(h=0),l>999&&(h=999);const v=c?E.sceneItems.filter(I=>Ce(I)):E.sceneItems.filter(I=>!wt(I)&&Ce(I));await w.scene.items.updateItems(v.map(I=>I.id),I=>{for(let S of I)S.metadata[`${o.EXTENSIONID}/visionDark`]=h.toString()})};new St("#visionRangeSvg",e,"Vision Range"),new St("#visionFalloffSvg",t,"Falloff Range"),new St("#visionBumperSvg",a,"Collision Range"),new St("#visionInnerSvg",i,"Inner Angle"),new St("#visionOuterSvg",d,"Outer Angle"),new St("#visionDarkSvg",s,"Greyscale")}SetupViewPanel(){const e=document.getElementById("visionPanelToggleContainer");this.visionPanelMain=document.getElementById("visionPanelMain"),this.visionPanelSub=document.getElementById("visionPanelSub"),this.smokeUnitTablePrime=document.getElementById("smokeUnitTablePrime"),this.smokeUnitTableSub=document.getElementById("smokeUnitTableSub"),this.SetupMassEditors();const t=document.createElement("input");t.type="button",t.value="Show Advanced",t.classList.add("view-panel-toggle"),t.onclick=()=>{this.visionPanelMain.style.display=this.onVisionPanelMain?"none":"table-row",this.visionPanelSub.style.display=this.onVisionPanelMain?"table-row":"none";const a=document.getElementsByClassName("vision-panel-main-input"),i=document.getElementsByClassName("vision-panel-sub-input");for(let d=0;d<a.length;d++)this.onVisionPanelMain?this.fadeOut(a[d],()=>this.fadeIn(i[d],"inline-block")):this.fadeOut(i[d],()=>this.fadeIn(a[d],"inline-block"));t.value=this.onVisionPanelMain?"Show Basic":"Show Advanced",this.onVisionPanelMain=!this.onVisionPanelMain},e.appendChild(t)}AddTokenToVisionList(e){let t=E.sceneMetadata[`${o.EXTENSIONID}/USER-${e.createdUserId}`],a=t?.color,i=t?.name?`This token is owned by ${t.name}.`:"This token is owned by you.";!a&&e.createdUserId!==E.playerId&&(a="#aeb0af",i="This tokens owner is not in the room currently.");const d=document.getElementById("token_list"),s=document.getElementById("hidden_list"),l=e.metadata[`${o.EXTENSIONID}/isTorch`]===!0,c=document.createElement("tr");c.id=`tr-${e.id}`,c.className="token-table-entry",c.classList.add("slide-row");const h=document.createElement("td");h.id=`name-${e.id}`,l?(h.innerText=`🔦${e.name} `,h.title="This is a torch, which can be seen by other tokens with vision when in range."):(h.innerText=e.name,h.title=i,h.setAttribute("data-color",a),h.style.textShadow=`
                -2px -2px 2px ${a},
                2px -2px 2px ${a},
                -2px 2px 2px ${a},
                2px 2px 2px ${a}`),h.classList.add("token-name"),a==="#aeb0af"&&(h.style.color="black !important",h.style.fontStyle="italic"),h.onclick=async()=>{Gl.CenterViewportOnImage(e),await w.player.select([e.id])};const v=document.createElement("td"),I=document.createElement("input");I.type="number",I.value=e.metadata[`${o.EXTENSIONID}/visionRange`]!==void 0?e.metadata[`${o.EXTENSIONID}/visionRange`]:Ae(),I.classList.add("token-aradius"),I.classList.add("vision-panel-main-input"),I.style.display=this.onVisionPanelMain?"inline-block":"none",I.onchange=async p=>{if(!p||!p.target)return;const y=E.sceneItems.find(T=>T.id===e.id),m=p.target,g=parseInt(m.value);g<0&&(m.value="0"),g>999&&(m.value="999"),isNaN(g)&&(m.value=Ae()),await w.scene.items.updateItems([y.id],T=>{T[0].metadata[`${o.EXTENSIONID}/visionRange`]=m.value})};const S=document.createElement("input");S.type="number",S.style.display="none",S.value=e.metadata[`${o.EXTENSIONID}/visionSourceRange`]!==void 0?e.metadata[`${o.EXTENSIONID}/visionSourceRange`]:Ve(),S.classList.add("token-sradius"),S.classList.add("vision-panel-sub-input"),S.style.display=this.onVisionPanelMain?"none":"inline-block",S.onchange=async p=>{if(!p||!p.target)return;const y=E.sceneItems.find(T=>T.id===e.id),m=p.target,g=parseFloat(m.value);g<0&&(m.value="0"),g>999&&(m.value="999"),isNaN(g)&&(m.value=Ve()),await w.scene.items.updateItems([y.id],T=>{T[0].metadata[`${o.EXTENSIONID}/visionSourceRange`]=m.value})},v.appendChild(I),v.appendChild(S);const _=document.createElement("td"),O=document.createElement("input");O.type="number",O.value=e.metadata[`${o.EXTENSIONID}/visionFallOff`]!==void 0?e.metadata[`${o.EXTENSIONID}/visionFallOff`]:Ze(),O.classList.add("token-falloff"),O.classList.add("vision-panel-main-input"),O.style.display=this.onVisionPanelMain?"inline-block":"none",O.onchange=async p=>{if(!p||!p.target)return;const y=E.sceneItems.find(T=>T.id===e.id),m=p.target,g=parseFloat(m.value);g<0&&(m.value="0"),g>10&&(m.value="10"),isNaN(g)&&(m.value=Ze()),await w.scene.items.updateItems([y.id],T=>{T[0].metadata[`${o.EXTENSIONID}/visionFallOff`]=m.value})};const X=document.createElement("input");X.type="number",X.style.display="none",X.value=e.metadata[`${o.EXTENSIONID}/visionInAngle`]!==void 0?e.metadata[`${o.EXTENSIONID}/visionInAngle`]:rt(),X.classList.add("token-innerang"),X.classList.add("vision-panel-sub-input"),X.style.display=this.onVisionPanelMain?"none":"inline-block",X.onchange=async p=>{if(!p||!p.target)return;const y=E.sceneItems.find(T=>T.id===e.id),m=p.target,g=parseInt(m.value);g<0&&(m.value="0"),g>360&&(m.value="360"),isNaN(g)&&(m.value=rt()),await w.scene.items.updateItems([y.id],T=>{T[0].metadata[`${o.EXTENSIONID}/visionInAngle`]=m.value})},_.appendChild(O),_.appendChild(X);const F=document.createElement("td"),x=document.createElement("input");x.type="checkbox",x.checked=e.metadata[`${o.EXTENSIONID}/visionBlind`]!==void 0?e.metadata[`${o.EXTENSIONID}/visionBlind`]:!1,x.classList.add("token-blind"),x.classList.add("vision-panel-main-input"),x.style.display=this.onVisionPanelMain?"inline-block":"none",x.onchange=async p=>{if(!p||!p.target)return;const y=p.target,m=E.sceneItems.find(g=>g.id===e.id);await w.scene.items.updateItems([m.id],g=>{g[0].metadata[`${o.EXTENSIONID}/visionBlind`]=y.checked})};const C=document.createElement("input");C.type="number",C.style.display="none",C.value=e.metadata[`${o.EXTENSIONID}/visionOutAngle`]!==void 0?e.metadata[`${o.EXTENSIONID}/visionOutAngle`]:We(),C.classList.add("token-outerang"),C.classList.add("vision-panel-sub-input"),C.style.display=this.onVisionPanelMain?"none":"inline-block",C.onchange=async p=>{if(!p||!p.target)return;const y=E.sceneItems.find(T=>T.id===e.id),m=p.target,g=parseInt(m.value);g<0&&(m.value="0"),g>360&&(m.value="360"),isNaN(g)&&(m.value=We()),await w.scene.items.updateItems([y.id],T=>{T[0].metadata[`${o.EXTENSIONID}/visionOutAngle`]=m.value})},F.appendChild(x),F.appendChild(C);const G=document.createElement("td"),r=document.createElement("input");r.type="image",r.src="/swap.svg",r.checked=e.metadata[`${o.EXTENSIONID}/hiddenToken`]!==void 0?e.metadata[`${o.EXTENSIONID}/hiddenToken`]:!1,r.classList.add("token-hide"),r.classList.add("vision-panel-main-input"),r.style.display=this.onVisionPanelMain?"inline-block":"none",r.onclick=async p=>{if(!p||!p.target)return;const y=E.sceneItems.find(T=>T.id===e.id),m=p.target;m.checked=!m.checked;const g=document.getElementById(`tr-${e.id}`);m.checked?(g.classList.add("slide-out"),setTimeout(()=>{ie.hiddenList.prepend(g),g.classList.remove("slide-out"),g.classList.add("slide-in"),setTimeout(async()=>{g.classList.remove("slide-in"),await w.scene.items.updateItems([y.id],T=>{T[0].metadata[`${o.EXTENSIONID}/hiddenToken`]=m.checked})},10)},250)):(g.classList.add("slide-out"),setTimeout(()=>{ie.tokenList.appendChild(g),g.classList.remove("slide-out"),g.classList.add("slide-in"),setTimeout(async()=>{g.classList.remove("slide-in"),await w.scene.items.updateItems([y.id],T=>{T[0].metadata[`${o.EXTENSIONID}/hiddenToken`]=m.checked})},10)},250))};const f=document.createElement("input");f.type="number",f.value=e.metadata[`${o.EXTENSIONID}/visionDark`]!==void 0?e.metadata[`${o.EXTENSIONID}/visionDark`]:pn(),f.classList.add("token-darkvision"),f.classList.add("vision-panel-sub-input"),f.style.display=this.onVisionPanelMain?"none":"inline-block",f.onchange=async p=>{if(!p||!p.target)return;const y=E.sceneItems.find(T=>T.id===e.id),m=p.target,g=parseInt(m.value);g<0&&(m.value="0"),g>999&&(m.value="999"),isNaN(g)&&(m.value=Ae()),await w.scene.items.updateItems([y.id],T=>{T[0].metadata[`${o.EXTENSIONID}/visionDark`]=m.value})},G.appendChild(r),G.appendChild(f),c.appendChild(h),c.appendChild(v),c.appendChild(_),c.appendChild(F),c.appendChild(G),e.metadata[`${o.EXTENSIONID}/hiddenToken`]===!0?s.prepend(c):d.appendChild(c);function u(){document.getElementById("contextMenu").style.display="none"}c.oncontextmenu=async function(p){p.preventDefault();const y=p.currentTarget,m=document.getElementById("contextMenu"),g=k=>{k.preventDefault()},T=async k=>{const $=[...E.party,{id:E.playerId,color:E.playerColor,name:E.playerName}],R=k.target,b=m.getAttribute("currentUnit"),z=document.getElementById(`tr-${b}`).getElementsByClassName("token-name")[0],j=$.find(Q=>R.id===Q.id);if(j){const Q=j.name!==E.playerName?`This token is owned by ${j.name}.`:"This token is owned by you.";z.title=Q,z.setAttribute("data-color",a),z.style.textShadow=`
                    -2px -2px 2px ${j.color},
                    2px -2px 2px ${j.color},
                    -2px 2px 2px ${j.color},
                    2px 2px 2px ${j.color}`}else z.title="Unable to update owner name",z.style.textShadow="";await w.scene.items.updateItems([b],Q=>{for(const Y of Q)Y.createdUserId=R.id}),m.style.display="none",k.stopPropagation(),window.removeEventListener("click",M),m.removeEventListener("click",T),m.removeEventListener("contextmenu",g)};m.setAttribute("currentUnit",y.id.substring(3));const M=()=>{m.style.display="none",window.removeEventListener("click",M),m.removeEventListener("click",T),m.removeEventListener("contextmenu",g)};if(m.addEventListener("click",T),m.addEventListener("contextmenu",g),window.addEventListener("click",M),m.style.display=="block")u();else{const $=(document.getElementById("playerListing").children.length+1)*34,R=Math.min(p.pageX,window.innerWidth-150);let b=Math.min(p.pageY,(window.innerHeight>300?window.innerHeight-50:window.innerHeight)-120);window.innerHeight<$+b&&(b=window.innerHeight-$),m.style.display="block",m.style.left=R+"px",m.style.top=b+"px"}}}UpdateTokenOnVisionList(e,t){const a=E.sceneMetadata[`${o.EXTENSIONID}/USER-${e.createdUserId}`];let i=a?.color,d=a?.name?`This token is owned by ${a.name}.`:"This token is owned by you.";const s=e.metadata[`${o.EXTENSIONID}/isTorch`]===!0;!i&&e.createdUserId!==E.playerId&&(i="#aeb0af",d="This tokens owner is not in the room currently.");const l=t.getElementsByClassName("token-name")[0],c=t.getElementsByClassName("token-aradius")[0],h=t.getElementsByClassName("token-sradius")[0],v=t.getElementsByClassName("token-falloff")[0],I=t.getElementsByClassName("token-innerang")[0],S=t.getElementsByClassName("token-outerang")[0],_=t.getElementsByClassName("token-blind")[0],O=t.getElementsByClassName("token-darkvision")[0];l&&(s?(l.innerText=`🔦${e.name} `,l.title="This is a torch, which can be seen by other tokens with vision when in range."):(l.innerText=e.name,l.title=d,l.setAttribute("data-color",i),l.style.textShadow=`
                    -2px -2px 2px ${i},
                    2px -2px 2px ${i},
                    -2px 2px 2px ${i},
                    2px 2px 2px ${i}`)),c&&(c.value=e.metadata[`${o.EXTENSIONID}/visionRange`]!==void 0?e.metadata[`${o.EXTENSIONID}/visionRange`]:Ae()),h&&(h.value=e.metadata[`${o.EXTENSIONID}/visionSourceRange`]!==void 0?e.metadata[`${o.EXTENSIONID}/visionSourceRange`]:Ve()),v&&(v.value=e.metadata[`${o.EXTENSIONID}/visionFallOff`]!==void 0?e.metadata[`${o.EXTENSIONID}/visionFallOff`]:Ze()),I&&(I.value=e.metadata[`${o.EXTENSIONID}/visionInAngle`]!==void 0?e.metadata[`${o.EXTENSIONID}/visionInAngle`]:rt()),S&&(S.value=e.metadata[`${o.EXTENSIONID}/visionOutAngle`]!==void 0?e.metadata[`${o.EXTENSIONID}/visionOutAngle`]:We()),_&&(_.checked=e.metadata[`${o.EXTENSIONID}/visionBlind`]!==void 0?e.metadata[`${o.EXTENSIONID}/visionBlind`]:!1),O&&(O.value=e.metadata[`${o.EXTENSIONID}/visionDark`]!==void 0?e.metadata[`${o.EXTENSIONID}/visionDark`]:pn())}CleanVisionList(e,t){for(const a of t){const i=a.id.slice(3);e.some(d=>d.id===i)||a.remove()}}SetupHelpDocuments(){const t=new hr.Converter().makeHtml(o.MARKDOWNHELP),a=document.getElementById("markdownHelpContainer");a.innerHTML=t}fadeOut=(e,t)=>{e.style.opacity="0",setTimeout(()=>{e.style.display="none",t()},300)};fadeIn=(e,t)=>{e.style.opacity="0",e.style.display=t,setTimeout(()=>{e.style.opacity="1"},10)}}const ie=new Wl("3.30");w.onReady(async()=>{const n=await w.scene.isReady(),e=document.getElementById("papp"),t=document.getElementById("contextmenu");if(!(e||t))if(n===!1){const a=w.scene.onReadyChange(async i=>{i&&(a(),await li())})}else await li()});async function li(){await E.InitializeCache(),E.SetupHandlers(),await ie.Start()}export{E as B};
