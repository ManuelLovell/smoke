import{C as c,b as Vi,O as b,a as gt,c as Ro,d as Xo,e as Fo,f as ct,i as Bo,g as _t}from"./bsConstants-c1908764.js";/* empty css              */var wn=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function Wn(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}function Vo(n){if(n.__esModule)return n;var e=n.default;if(typeof e=="function"){var t=function i(){return this instanceof i?Reflect.construct(e,arguments,this.constructor):e.apply(this,arguments)};t.prototype=e.prototype}else t={};return Object.defineProperty(t,"__esModule",{value:!0}),Object.keys(n).forEach(function(i){var o=Object.getOwnPropertyDescriptor(n,i);Object.defineProperty(t,i,o.get?o:{enumerable:!0,get:function(){return n[i]}})}),t}function Ho(n){return n.type==="CURVE"}function Jt(n){return n.type==="IMAGE"}function gi(n,e){return Math.round(n/e)*e}function mi(n,e){return Math.floor(n/e)*e}function Mn(n){return n*(Math.PI/180)}function Uo(n){return n*(180/Math.PI)}function yi(n,e,t){return n*(1-t)+e*t}class ze{static magnitudeSquared(e){return e.x*e.x+e.y*e.y}static magnitude(e){const t=Math.sqrt(this.magnitudeSquared(e));return isNaN(t)?0:t}static normalize(e){const t=this.magnitude(e);return t===0?{x:0,y:0}:this.divide(e,t)}static dot(e,t){return e.x*t.x+e.y*t.y}static subtract(e,t){return typeof t=="number"?{x:e.x-t,y:e.y-t}:{x:e.x-t.x,y:e.y-t.y}}static add(e,t){return typeof t=="number"?{x:e.x+t,y:e.y+t}:{x:e.x+t.x,y:e.y+t.y}}static multiply(e,t){return typeof t=="number"?{x:e.x*t,y:e.y*t}:{x:e.x*t.x,y:e.y*t.y}}static divide(e,t){return typeof t=="number"?{x:e.x/t,y:e.y/t}:{x:e.x/t.x,y:e.y/t.y}}static rotate(e,t,i){const o=Math.cos(Mn(i)),r=Math.sin(Mn(i)),a=this.subtract(e,t);return{x:t.x+o*a.x-r*a.y,y:t.y+r*a.x+o*a.y}}static min(e,t){return typeof t=="number"?{x:Math.min(e.x,t),y:Math.min(e.y,t)}:{x:Math.min(e.x,t.x),y:Math.min(e.y,t.y)}}static componentMin(e){return e.x<e.y?e.x:e.y}static max(e,t){return typeof t=="number"?{x:Math.max(e.x,t),y:Math.max(e.y,t)}:{x:Math.max(e.x,t.x),y:Math.max(e.y,t.y)}}static componentMax(e){return e.x>e.y?e.x:e.y}static roundTo(e,t){return{x:gi(e.x,t.x),y:gi(e.y,t.y)}}static floorTo(e,t){return{x:mi(e.x,t.x),y:mi(e.y,t.y)}}static sign(e){return{x:Math.sign(e.x),y:Math.sign(e.y)}}static abs(e){return{x:Math.abs(e.x),y:Math.abs(e.y)}}static pow(e,t){return typeof t=="number"?{x:Math.pow(e.x,t),y:Math.pow(e.y,t)}:{x:Math.pow(e.x,t.x),y:Math.pow(e.y,t.y)}}static clamp(e,t,i){return{x:Math.min(Math.max(e.x,t),i),y:Math.min(Math.max(e.y,t),i)}}static boundingBox(e){let t=Number.MAX_SAFE_INTEGER,i=Number.MIN_SAFE_INTEGER,o=Number.MAX_SAFE_INTEGER,r=Number.MIN_SAFE_INTEGER;for(let y of e)t=y.x<t?y.x:t,i=y.x>i?y.x:i,o=y.y<o?y.y:o,r=y.y>r?y.y:r;let a=i-t,u=r-o,h={x:(t+i)/2,y:(o+r)/2};return{min:{x:t,y:o},max:{x:i,y:r},width:a,height:u,center:h}}static pointInPolygon(e,t){const i=this.boundingBox(t);if(e.x<i.min.x||e.x>i.max.x||e.y<i.min.y||e.y>i.max.y)return!1;let o=!1;for(let r=0,a=t.length-1;r<t.length;a=r++){const u=t[r].y>e.y,h=t[a].y>e.y;u!==h&&e.x<(t[a].x-t[r].x)*(e.y-t[r].y)/(t[a].y-t[r].y)+t[r].x&&(o=!o)}return o}static compare(e,t,i){return this.magnitudeSquared(this.subtract(e,t))<i*i}static distance(e,t){return this.magnitude(this.subtract(e,t))}static lerp(e,t,i){return{x:yi(e.x,t.x,i),y:yi(e.y,t.y,i)}}static centroid(e){let t={x:0,y:0};for(let i of e)t.x+=i.x,t.y+=i.y;return e.length>0&&(t={x:t.x/e.length,y:t.y/e.length}),t}}class je{static inverse(e){const[t,i,o,r,a,u,h,y,O]=e,D=t*(a*O-y*u)-i*(r*O-u*h)+o*(r*y-a*h);if(Math.abs(D)<1e-14)return e;const M=1/D,A=(a*O-y*u)*M,T=(o*y-i*O)*M,$=(i*u-o*a)*M,x=(u*h-r*O)*M,L=(t*O-o*h)*M,P=(r*o-t*u)*M,V=(r*y-h*a)*M,F=(h*i-t*y)*M,oe=(t*a-r*i)*M;return[A,T,$,x,L,P,V,F,oe]}static multiply(e,t){return[e[0]*t[0]+e[1]*t[3]+e[2]*t[6],e[0]*t[1]+e[1]*t[4]+e[2]*t[7],e[0]*t[2]+e[1]*t[5]+e[2]*t[8],e[3]*t[0]+e[4]*t[3]+e[5]*t[6],e[3]*t[1]+e[4]*t[4]+e[5]*t[7],e[3]*t[2]+e[4]*t[5]+e[5]*t[8],e[6]*t[0]+e[7]*t[3]+e[8]*t[6],e[6]*t[1]+e[7]*t[4]+e[8]*t[7],e[6]*t[2]+e[7]*t[5]+e[8]*t[8]]}static fromPosition(e){return[1,0,e.x,0,1,e.y,0,0,1]}static fromRotation(e){const t=Mn(e);return[Math.cos(t),-Math.sin(t),0,Math.sin(t),Math.cos(t),0,0,0,1]}static fromScale(e){return[e.x,0,0,0,e.y,0,0,0,1]}static fromItem(e){const t=je.fromPosition(e.position),i=je.fromScale(e.scale),o=je.fromRotation(e.rotation);return je.multiply(je.multiply(t,o),i)}static decompose(e){const[t,i,o,r,a,u]=e,h=t*a-r*i,y={position:{x:o,y:u},rotation:0,scale:{x:1,y:1}};if(t!=0||r!=0){var O=Math.sqrt(t*t+r*r);y.rotation=r>0?Math.acos(t/O):-Math.acos(t/O),y.scale={x:O,y:h/O}}else if(i!=0||a!=0){var D=Math.sqrt(i*i+a*a);y.rotation=Math.PI/2-(a>0?Math.acos(-i/D):-Math.acos(i/D)),y.scale={x:h/D,y:D}}return y.rotation=Uo(y.rotation),y}}function vi(n,e){let t=!1;const i=e.length;let o=e[0];for(let r=1;r<=i;r++){const a=e[r%i];if(n.y>Math.min(o.y,a.y)&&n.y<=Math.max(o.y,a.y)&&n.x<=Math.max(o.x,a.x)&&o.y!=a.y){const u=(n.y-o.y)*(a.x-o.x)/(a.y-o.y)+o.x;(o.x==a.x||n.x<=u)&&(t=!t)}o=a}return t}function Ei(n,e){let t;return function(...o){t&&clearTimeout(t),t=setTimeout(()=>{n(...o),t=void 0},e)}}function Go(n){for(const e in n)if(n.hasOwnProperty(e))return!1;return!0}function jn(n,e,t=[]){if(n===e)return!0;if(typeof n!="object"||typeof e!="object"||n===null||e===null)return!1;const i=Object.keys(n).filter(r=>!t.includes(r)),o=Object.keys(e).filter(r=>!t.includes(r));if(i.length!==o.length)return!1;for(const r of i)if(!o.includes(r)||!jn(n[r],e[r],t))return!1;return!0}function Wo(n,e){return jn(n,e,["lastModified","lastModifiedUserId"])}function Ii(n,e){let t=JSON.stringify(n);if(e){const o=JSON.stringify(e);t=t+o}return new TextEncoder().encode(t).length>14384}function Tn(n,e){const t=["lastModified","lastModifiedUserId"];if(n.length!==e.length)return!1;for(let i=0;i<n.length;i++)if(!jn(n[i],e[i],t))return!1;return!0}function jo(n,e){e.forEach(t=>{const i=n.findIndex(o=>o.id===t.id);i!==-1?n[i]=t:n.push(t)})}function qo(){try{localStorage.setItem("STORAGECHECK","test")}catch{const e=document.getElementById("localStorageWarning");e.innerText="Local Storage disabled. Some features will not function."}}function wi(n,e){const t=window.matchMedia("(prefers-color-scheme: dark)"),i=t.matches?"dark":"light",o=t.matches?"light":"dark";for(var r=0;r<e.styleSheets.length;r++)for(var a=0;a<e.styleSheets[r].cssRules.length;a++){let u=e.styleSheets[r].cssRules[a];u&&u.media&&u.media.mediaText.includes("prefers-color-scheme")&&(n.mode=="LIGHT"?(u.media.appendMedium(`(prefers-color-scheme: ${i})`),u.media.mediaText.includes(o)&&u.media.deleteMedium(`(prefers-color-scheme: ${o})`)):n.mode=="DARK"&&(u.media.appendMedium(`(prefers-color-scheme: ${o})`),u.media.mediaText.includes(i)&&u.media.deleteMedium(`(prefers-color-scheme: ${i})`)))}}async function $n(){const n=p.sceneItems.filter(mo);if(!p.sceneMetadata[`${c.EXTENSIONID}/autodetectEnabled`]&&n.length==0){let e=Vi().width(p.gridDpi*30).height(p.gridDpi*30).visible(!1).shapeType("RECTANGLE").visible(!0).locked(!1).strokeColor("pink").strokeOpacity(.5).fillOpacity(0).strokeDash([200,500]).strokeWidth(50).build();e.metadata[`${c.EXTENSIONID}/isBackgroundImage`]=!0,e.metadata[`${c.EXTENSIONID}/grid`]=!0,e.id=c.GRIDID,await b.scene.items.addItems([e])}p.sceneMetadata[`${c.EXTENSIONID}/autodetectEnabled`]===!0&&n.length>0&&await b.scene.items.deleteItems([c.GRIDID])}function Ko(n){function e(){document.getElementById("contextMenu").style.display="none"}const t=document.getElementById(`tr-${n.id}`);if(t){const i=t.getElementsByClassName("token-name")[0],o=t.getElementsByClassName("token-vision-range")[0],r=t.getElementsByClassName("unlimited-vision")[0],a=t.getElementsByClassName("no-vision")[0],u=t.getElementsByClassName("hidden-token")[0];i&&(i.innerText=n.name),o&&!r.checked&&!a.checked&&(o.value=n.metadata[`${c.EXTENSIONID}/visionRange`]!==void 0?n.metadata[`${c.EXTENSIONID}/visionRange`]:c.VISIONDEFAULT),r&&(r.checked=n.metadata[`${c.EXTENSIONID}/visionRange`]===0),a&&(a.checked=n.metadata[`${c.EXTENSIONID}/visionBlind`]),u&&(u.checked=n.metadata[`${c.EXTENSIONID}/hiddenToken`]),r.checked||a.checked?o.setAttribute("disabled","disabled"):o.removeAttribute("disabled")}else{const i=p.sceneMetadata[`${c.EXTENSIONID}/USER-${n.createdUserId}`];let o=i?.color,r=i?.name?`This token is owned by ${i.name}.`:"This token is owned by you.";!o&&n.createdUserId!==p.playerId&&(o="#aeb0af",r="This tokens owner is not in the room currently.");const a=p.sceneItems.find(A=>A.id===n.id),u=document.createElement("tr");u.id=`tr-${a.id}`,u.className="token-table-entry",u.innerHTML=`<td id="contextLocator" title="${r}" ${o==="#aeb0af"?'style="color:black !important; font-style: italic;" ':""}data-color="${o}" class="token-name">${a.name}</td>
                           <td class="token-vision-container" title="The unit of measurement for your grid"><input class="token-vision-range" type="number" value=${c.VISIONDEFAULT}><span class="unit">${p.gridType}</span></td>
                           <td class="token-vision-container-grid">
                            <div class="vision-container-div">
                                <label class="cbutton" title="Unlimited vision range"><input type="checkbox" class="unlimited-vision"><span class="emoji">&infin;</span></label>
                                <label class="cbutton" title="Turn token into a light source"><input type="checkbox" class="torch-vision"><span class="emoji">&#128294;</span></label>
                                <label class="cbutton" title="Disable vision on this token"><input type="checkbox" class="no-vision"><span class="emoji">&#8856;</span></label>
                                <label class="cbutton" title="Move to Out-of-Sight List"><input type="checkbox" class="hidden-token"><span class="emoji">&#128065;</span></label>
                            </div>
                           </td>`,n.metadata[`${c.EXTENSIONID}/hiddenToken`]===!0?Z.hiddenTable.prepend(u):Z.table.appendChild(u),u.getElementsByClassName("token-name")[0].style.textShadow=`
        -2px -2px 2px ${o},
        2px -2px 2px ${o},
        -2px 2px 2px ${o},
        2px 2px 2px ${o}`;const h=u.getElementsByClassName("token-vision-range")[0],y=u.getElementsByClassName("unlimited-vision")[0],O=u.getElementsByClassName("torch-vision")[0],D=u.getElementsByClassName("no-vision")[0],M=u.getElementsByClassName("hidden-token")[0];h&&!y.checked&&!D.checked&&(h.value=n.metadata[`${c.EXTENSIONID}/visionRange`]?n.metadata[`${c.EXTENSIONID}/visionRange`]:c.VISIONDEFAULT),y&&(y.checked=n.metadata[`${c.EXTENSIONID}/visionRange`]===0),O&&(O.checked=n.metadata[`${c.EXTENSIONID}/visionTorch`]),D&&(D.checked=n.metadata[`${c.EXTENSIONID}/visionBlind`]),M&&(M.checked=n.metadata[`${c.EXTENSIONID}/hiddenToken`]),y.checked||D.checked?h.setAttribute("disabled","disabled"):h.removeAttribute("disabled"),h.onchange=async A=>{if(!A||!A.target)return;const T=p.sceneItems.find(L=>L.id===n.id),$=A.target,x=parseInt($.value);x<0&&($.value="0"),x>999&&($.value="999"),await b.scene.items.updateItems([T],L=>{L[0].metadata[`${c.EXTENSIONID}/visionRange`]=x})},M.onclick=async A=>{if(!A||!A.target)return;const T=p.sceneItems.find(L=>L.id===n.id),$=A.target,x=document.getElementById(`tr-${n.id}`);$.checked?Z.hiddenTable.prepend(x):Z.table.appendChild(x),await b.scene.items.updateItems([T],L=>{L[0].metadata[`${c.EXTENSIONID}/hiddenToken`]=$.checked})},y.onclick=async A=>{if(!A||!A.target)return;const T=p.sceneItems.find(L=>L.id===n.id);let $=0;A.target.checked?(h.setAttribute("disabled","disabled"),D.checked=!1):($=parseInt(h.value),h.removeAttribute("disabled")),await b.scene.items.updateItems([T],L=>{L[0].metadata[`${c.EXTENSIONID}/visionRange`]=$})},D.onclick=async A=>{if(!A||!A.target)return;const T=p.sceneItems.find(x=>x.id===n.id),$=A.target;$.checked?h.setAttribute("disabled","disabled"):h.removeAttribute("disabled"),await b.scene.items.updateItems([T],x=>{x[0].metadata[`${c.EXTENSIONID}/visionBlind`]=$.checked})},O.onclick=async A=>{if(!A||!A.target)return;const T=p.sceneItems.find(x=>x.id===n.id),$=A.target;await b.scene.items.updateItems([T],x=>{x[0].metadata[`${c.EXTENSIONID}/visionTorch`]=$.checked})},h.addEventListener("mousewheel",async()=>{}),u.oncontextmenu=async function(A){A.preventDefault();const T=A.currentTarget,$=document.getElementById("contextMenu"),x=V=>{V.preventDefault()},L=async V=>{const F=V.target,oe=$.getAttribute("currentUnit"),C=p.party.find(E=>F.id===E.id)?.color,g=document.getElementById(`tr-${oe}`).getElementsByClassName("token-name")[0];C?g.style.textShadow=`
                    -2px -2px 2px ${C},
                    2px -2px 2px ${C},
                    -2px 2px 2px ${C},
                    2px 2px 2px ${C}`:g.style.textShadow="",await b.scene.items.updateItems([oe],E=>{for(const m of E)m.createdUserId=F.id}),$.style.display="none",V.stopPropagation(),window.removeEventListener("click",P),$.removeEventListener("click",L),$.removeEventListener("contextmenu",x)};$.setAttribute("currentUnit",T.id.substring(3));const P=()=>{$.style.display="none",window.removeEventListener("click",P),$.removeEventListener("click",L),$.removeEventListener("contextmenu",x)};if($.addEventListener("click",L),$.addEventListener("contextmenu",x),window.addEventListener("click",P),$.style.display=="block")e();else{const V=Math.min(A.pageX,window.innerWidth-150),F=Math.min(A.pageY,(window.innerHeight>300?window.innerHeight-50:window.innerHeight)-120);$.style.display="block",$.style.left=V+"px",$.style.top=F+"px"}}}}async function zo(n){const e=await b.scene.local.getItems(i=>i.metadata[`${c.EXTENSIONID}/doorId`]!==void 0),t=[];for(let i of e){let o=!1;for(const r of n)i.metadata[`${c.EXTENSIONID}/doorId`]==r.id&&(o=!0);o&&t.push(i.id)}await b.scene.local.deleteItems(t)}async function Qt(n){const e=[],t=await b.scene.local.getItems(i=>i.metadata[`${c.EXTENSIONID}/doorId`]!==void 0);for(const i of n){if(!Ho(i)||t.some(a=>a.metadata[`${c.EXTENSIONID}/doorId`]===i.id))continue;const o=je.fromItem(i),r=[];for(let a=0;a<i.points.length;a++){const u=je.fromPosition(i.points[a]);r.push(je.decompose(je.multiply(o,u)).position)}e.push(gt().locked(!0).commands(Hi(i.metadata[`${c.EXTENSIONID}/disabled`]===!0)).scale({x:.2,y:.2}).name("Door").position(ze.centroid(r)).metadata({[`${c.EXTENSIONID}/doorId`]:i.id}).build())}e.length>0&&await b.scene.local.addItems(e)}async function Yo(n){const e=await b.scene.local.getItems(t=>t.id===n&&t.metadata[`${c.EXTENSIONID}/doorId`]!==void 0);if(e.length===1){const t=e[0].metadata[`${c.EXTENSIONID}/doorId`],i=p.sceneItems.filter(o=>o.id===t);await b.scene.items.updateItems(i,o=>{const r=o[0];r.metadata[`${c.EXTENSIONID}/isVisionLine`]&&r.metadata[`${c.EXTENSIONID}/disabled`]?(delete r.metadata[`${c.EXTENSIONID}/disabled`],delete r.metadata[`${c.EXTENSIONID}/doorOpen`]):r.metadata[`${c.EXTENSIONID}/isVisionLine`]&&(r.metadata[`${c.EXTENSIONID}/disabled`]=!0,r.metadata[`${c.EXTENSIONID}/doorOpen`]=!0)}),await b.player.deselect([n])}}async function Zo(){const n=p.sceneItems.filter(e=>e.metadata[`${c.EXTENSIONID}/isDoor`]===!0);await Qt(n)}function Hi(n){return n?c.DOOROPEN:c.DOORCLOSED}var Ui={exports:{}};(function(n){(function(){function e(u,h){var y=u.x-h.x,O=u.y-h.y;return y*y+O*O}function t(u,h,y){var O=h.x,D=h.y,M=y.x-O,A=y.y-D;if(M!==0||A!==0){var T=((u.x-O)*M+(u.y-D)*A)/(M*M+A*A);T>1?(O=y.x,D=y.y):T>0&&(O+=M*T,D+=A*T)}return M=u.x-O,A=u.y-D,M*M+A*A}function i(u,h){for(var y=u[0],O=[y],D,M=1,A=u.length;M<A;M++)D=u[M],e(D,y)>h&&(O.push(D),y=D);return y!==D&&O.push(D),O}function o(u,h,y,O,D){for(var M=O,A,T=h+1;T<y;T++){var $=t(u[T],u[h],u[y]);$>M&&(A=T,M=$)}M>O&&(A-h>1&&o(u,h,A,O,D),D.push(u[A]),y-A>1&&o(u,A,y,O,D))}function r(u,h){var y=u.length-1,O=[u[0]];return o(u,0,y,h,O),O.push(u[y]),O}function a(u,h,y){if(u.length<=2)return u;var O=h!==void 0?h*h:1;return u=y?u:i(u,O),u=r(u,O),u}n.exports=a,n.exports.default=a})()})(Ui);var Jo=Ui.exports;const Qo=Wn(Jo),qn="#000000",Kn=8,zn=[];function Pn(n){const e=p.sceneItems.filter(o=>o.layer==="MAP"),t={};for(let o=0;o<e.length;o++){let r=n.querySelector("#map-"+e[o].id);r===null&&(r=document.createElement("option"),r.id="map-"+e[o].id,r.value=e[o].id,r.innerText=e[o].name,n.appendChild(r)),t[e[o].id]=e[o].name}let i=n.querySelectorAll("option");for(let o=0;o<i.length;o++)t[i[o].value]===void 0&&n.removeChild(i[o])}async function er(n,e,t,i,o){if(o.innerText="",Number.isNaN(t)||t<0){o.innerText="Invalid DPI";return}let r=p.gridDpi/t,a,u=[];if(u[0]=0,u[1]=0,i!==""){let h=await b.scene.items.getItems([i]);if(h.length>0)a=h[0],t===0&&(t=a.grid.dpi),r=p.gridDpi/t,u[0]=a.position.x-a.grid.offset.x*r,u[1]=a.position.y-a.grid.offset.y*r;else{o.innerText="Unable to find map";return}}else{o.innerText="No map selected";return}n==="foundry"?or(e,r,u,o):n==="uvtt"&&ir(e,r,u,o)}function Ti(n){const e=[];for(const t of n){const i=[];for(const r of t)i.push({x:r.x*p.gridDpi,y:r.y*p.gridDpi});const o=ct().tension(0).points(i).strokeColor(p.sceneMetadata[`${c.EXTENSIONID}/toolColor`]??qn).strokeDash(p.sceneMetadata[`${c.EXTENSIONID}/toolStyle`]??zn).strokeWidth(p.sceneMetadata[`${c.EXTENSIONID}/toolWidth`]??Kn).fillOpacity(0).fillColor("#000000").layer("DRAWING").name("Vision Line (Line)").closed(!1).locked(!0).visible(!1).metadata({[`${c.EXTENSIONID}/isVisionLine`]:!0}).build();e.push(o)}return e}function tr(n){const e=[];for(const t of n){const i=[];for(const r of t.bounds)i.push({x:r.x*p.gridDpi,y:r.y*p.gridDpi});const o=ct().tension(0).points(i).strokeColor(p.sceneMetadata[`${c.EXTENSIONID}/toolColor`]??qn).strokeDash(p.sceneMetadata[`${c.EXTENSIONID}/toolStyle`]??zn).strokeWidth(p.sceneMetadata[`${c.EXTENSIONID}/toolWidth`]??Kn).fillOpacity(0).fillColor("#000000").layer("DRAWING").name("Vision Line (Door)").closed(!1).locked(!0).visible(!1).metadata({[`${c.EXTENSIONID}/isVisionLine`]:!0,[`${c.EXTENSIONID}/isDoor`]:!0}).build();e.push(o)}return e}async function nr(n,e){let t=[];n.objects_line_of_sight?.length>0&&(t=t.concat(Ti(n.objects_line_of_sight))),n.line_of_sight?.length>0&&(t=t.concat(Ti(n.line_of_sight))),n.portals?.length>0&&(t=t.concat(tr(n.portals)));try{if(n.lights?.length>0){const h=[];for(const y of n.lights){const O=Ro({height:150,width:150,url:"https://battle-system.com/blank.png",mime:"image/png"},{dpi:300,offset:{x:150,y:150}}).position({x:y.position.x*p.gridDpi,y:y.position.y*p.gridDpi}).layer("CHARACTER").metadata({[`${c.EXTENSIONID}/hasVision`]:!0,[`${c.EXTENSIONID}/visionRange`]:y.range.toString(),[`${c.EXTENSIONID}/visionTorch`]:!0,[`${c.EXTENSIONID}/hiddenToken`]:!0}).name("Imported Light Source").build();h.push(O)}t=t.concat(h)}const i=atob(n.image),o=new Uint8Array(i.length);for(let h=0;h<i.length;h++)o[h]=i.charCodeAt(h);const r=new Blob([o],{type:"image/png"}),a=Xo(r).grid({dpi:n.resolution.pixels_per_grid,offset:{x:0,y:0}}).build(),u=Fo().baseMap(a).name("New UVTT Scene").items(t).build();await b.assets.uploadScenes([u],!0),await b.notification.show("Toggle Smoke Off then On when opening the new Scene","DEFAULT")}catch(i){await b.notification.show("There was an error: "+i,"ERROR")}}async function Gi(n,e,t,i,o){let r=0,a=0,u=0;const h=[];for(let y=0;y<n.length;y++){let O=[],D=!1;for(let M=0;M<n[y].length-1;M++){let A=n[y][M].x*e,T=n[y][M].y*e,$=n[y][M+1].x*e,x=n[y][M+1].y*e;O.push({x:A*t+i[0],y:T*t+i[1]}),O.push({x:$*t+i[0],y:x*t+i[1]}),a++,!D&&n[y][M].door&&(D=!0)}O.length>128&&(O.length,O=Qo(O,8,!1));for(let M=0;M<O.length;M+=256){const A=O.slice(M>0?M-1:0,M+256),T=ct().tension(0).points(A).strokeColor(p.sceneMetadata[`${c.EXTENSIONID}/toolColor`]??qn).strokeDash(p.sceneMetadata[`${c.EXTENSIONID}/toolStyle`]??zn).strokeWidth(p.sceneMetadata[`${c.EXTENSIONID}/toolWidth`]??Kn).fillOpacity(0).fillColor("#000000").layer("DRAWING").name("Vision Line (Import)").closed(!1).locked(!0).build();if(T.visible=!1,T.metadata[`${c.EXTENSIONID}/isVisionLine`]=!0,D&&(T.metadata[`${c.EXTENSIONID}/isDoor`]=!0),h.push(T),u+=A.length,u>512||h.length>64){r+=h.length,await b.scene.items.addItems(h);const $=h.filter(x=>x.metadata[`${c.EXTENSIONID}/isDoor`]===!0);await Qt($),h.length=0,u=0}}}if(h.length>0){r+=h.length,await b.scene.items.addItems(h);const y=h.filter(O=>O.metadata[`${c.EXTENSIONID}/isDoor`]===!0);await Qt(y)}o.innerText="Finished importing "+r+" walls, "+a+" points."}function ir(n,e,t,i){if(n.resolution.map_origin!==void 0&&(t[0]-=n.resolution.map_origin.x*n.resolution.pixels_per_grid,t[1]-=n.resolution.map_origin.y*n.resolution.pixels_per_grid),n.portals&&n.portals.length)for(let r=0;r<n.portals.length;r++){let a=n.portals[r].bounds;a[0].door=!0,a[1].door=!0,n.line_of_sight.push(a)}const o=n.line_of_sight.concat(n.objects_line_of_sight);Gi(o,n.resolution.pixels_per_grid,e,t,i)}function or(n,e,t,i){if(!n.walls||n.walls.length===0){i.innerText="No walls found";return}const o=[];for(var r=0;r<n.walls.length;r++)o.push([{x:n.walls[r].c[0],y:n.walls[r].c[1],door:!!n.walls[r].door},{x:n.walls[r].c[2],y:n.walls[r].c[3],door:!!n.walls[r].door}]);Gi(o,1,e,t,i)}async function Si(){await b.contextMenu.create({id:`${c.EXTENSIONID}/convert-curve`,icons:[{icon:"/opendoor.svg",label:"Convert to Obstruction",filter:{every:[{key:"layer",value:"DRAWING"},{key:["metadata",`${c.EXTENSIONID}/elevation`],value:void 0},{key:["metadata",`${c.EXTENSIONID}/isVisionLine`],value:void 0}],roles:["GM"]}}],async onClick(n){const e="#000000",i=[],o=[],r=[];for(const a of n.items){if(a.type==="CURVE"){const u=a;if(u.points.length>2){const h=ct().tension(0).points(u.points).strokeColor(p.sceneMetadata[`${c.EXTENSIONID}/toolColor`]??e).strokeDash(p.sceneMetadata[`${c.EXTENSIONID}/toolStyle`]??i).strokeWidth(p.sceneMetadata[`${c.EXTENSIONID}/toolWidth`]??8).fillOpacity(0).fillColor("#000000").layer("DRAWING").name("Vision Line (Line)").closed(!1).locked(!0).visible(!1).position(u.position).metadata({[`${c.EXTENSIONID}/isVisionLine`]:!0}).build();u.style.closed&&h.points.push(u.points[0]),o.push(h),r.push(u.id)}}else if(a.type==="LINE"){const u=a,h=ct().tension(0).points([u.startPosition,u.endPosition]).strokeColor(p.sceneMetadata[`${c.EXTENSIONID}/toolColor`]??e).strokeDash(p.sceneMetadata[`${c.EXTENSIONID}/toolStyle`]??i).strokeWidth(p.sceneMetadata[`${c.EXTENSIONID}/toolWidth`]??8).fillOpacity(0).fillColor("#000000").layer("DRAWING").name("Vision Line (Line)").closed(!1).locked(!0).visible(!1).position(u.position).metadata({[`${c.EXTENSIONID}/isVisionLine`]:!0}).build();o.push(h),r.push(u.id)}else if(a.type==="SHAPE"){const u=a,h=[];if(u.shapeType==="CIRCLE"){const y=Math.min(u.width,u.height)/2,O=2*Math.PI/20;for(let D=0;D<20;D++){const M=D*O,A=y*Math.cos(M),T=y*Math.sin(M);h.push({x:A,y:T})}}else if(u.shapeType==="RECTANGLE"){const D=0+u.width,M=0+u.height;h.push({x:0,y:0}),h.push({x:D,y:0}),h.push({x:D,y:M}),h.push({x:0,y:M})}else if(u.shapeType==="HEXAGON"){const y=u.width/2,O=[Math.PI/2,Math.PI/6,11*Math.PI/6,3*Math.PI/2,7*Math.PI/6,5*Math.PI/6];for(let D=0;D<6;D++){const M=O[D],A=y*Math.cos(M),T=y*Math.sin(M);h.push({x:A,y:T})}}else u.shapeType==="TRIANGLE"&&(h.push({x:0,y:0}),h.push({x:0-u.width/2,y:0+u.height}),h.push({x:0+u.width/2,y:0+u.height}));if(h.length>0){const y=ct().tension(0).points(h).position(u.position).rotation(u.rotation).strokeColor(p.sceneMetadata[`${c.EXTENSIONID}/toolColor`]??e).strokeDash(p.sceneMetadata[`${c.EXTENSIONID}/toolStyle`]??i).strokeWidth(p.sceneMetadata[`${c.EXTENSIONID}/toolWidth`]??8).fillOpacity(0).fillColor("#000000").layer("DRAWING").name("Vision Line (Line)").closed(!1).locked(!0).visible(!1).metadata({[`${c.EXTENSIONID}/isVisionLine`]:!0}).build();y.points.push(h[0]),o.push(y),r.push(u.id)}}o.length>0&&(await b.scene.items.addItems(o),await b.scene.items.deleteItems(r))}}}),await b.contextMenu.create({id:`${c.EXTENSIONID}/toggle-vision-menu`,icons:[{icon:"/no-vision.svg",label:"Enable Vision",filter:{every:[{key:["metadata",`${c.EXTENSIONID}/hasVision`],operator:"==",value:void 0,coordinator:"&&"},{key:["metadata",`${c.SPECTREID}/spectred`],operator:"==",value:void 0}],some:[{key:"layer",value:"CHARACTER",coordinator:"||"},{key:"layer",value:"ATTACHMENT"}]}},{icon:"/icon.svg",label:"Disable Vision",filter:{every:[{key:["metadata",`${c.SPECTREID}/spectred`],operator:"==",value:void 0}],some:[{key:"layer",value:"CHARACTER",coordinator:"||"},{key:"layer",value:"ATTACHMENT"}]}}],async onClick(n){const e=n.items.every(t=>t.metadata[`${c.EXTENSIONID}/hasVision`]===void 0);await b.scene.items.updateItems(n.items,t=>{for(const i of t)e?(i.metadata[`${c.EXTENSIONID}/hasVision`]=!0,i.metadata[`${c.EXTENSIONID}/visionRange`]===void 0&&(i.metadata[`${c.EXTENSIONID}/visionRange`]=c.VISIONDEFAULT)):delete i.metadata[`${c.EXTENSIONID}/hasVision`]})}}),await b.contextMenu.create({id:`${c.EXTENSIONID}/toggle-groupvision-menu`,icons:[{icon:"/no-vision.svg",label:"Toggle Attachments Vision",filter:{every:[{key:"layer",value:"NOTE"},{key:["metadata",`${c.EXTENSIONID}/hasVision`],value:void 0}]}}],async onClick(n){if(n.items.length>0){const e=n.items.map(i=>i.id),t=await b.scene.items.getItemAttachments(e);await b.scene.items.updateItems(t,i=>{for(const o of i)e.includes(o.attachedTo)&&(o.metadata[`${c.EXTENSIONID}/hasVision`]&&(o.layer=="CHARACTER"||o.layer=="ATTACHMENT")?delete o.metadata[`${c.EXTENSIONID}/hasVision`]:(o.layer=="CHARACTER"||o.layer=="ATTACHMENT")&&(o.metadata[`${c.EXTENSIONID}/hasVision`]=!0,o.metadata[`${c.EXTENSIONID}/visionRange`]===void 0&&(o.metadata[`${c.EXTENSIONID}/visionRange`]=c.VISIONDEFAULT)))})}}}),await b.contextMenu.create({id:`${c.EXTENSIONID}/toggle-vision-line`,icons:[{icon:"/icon.svg",label:"Disable Vision Line",filter:{some:[{key:["metadata",`${c.EXTENSIONID}/isVisionLine`],value:!0,coordinator:"&&"},{key:["metadata",`${c.EXTENSIONID}/disabled`],value:void 0,coordinator:"||"},{key:["metadata",`${c.ARMINDOID}/isVisionLine`],value:!0,coordinator:"&&"},{key:["metadata",`${c.ARMINDOID}/disabled`],value:void 0}]}},{icon:"/no-vision.svg",label:"Enable Vision Line",filter:{some:[{key:["metadata",`${c.EXTENSIONID}/isVisionLine`],value:!0,coordinator:"||"},{key:["metadata",`${c.ARMINDOID}/isVisionLine`],value:!0}]}}],async onClick(n){await b.scene.items.updateItems(n.items,e=>{for(const t of e)t.metadata[`${c.EXTENSIONID}/isVisionLine`]&&t.metadata[`${c.EXTENSIONID}/disabled`]?delete t.metadata[`${c.EXTENSIONID}/disabled`]:t.metadata[`${c.EXTENSIONID}/isVisionLine`]&&(t.metadata[`${c.EXTENSIONID}/disabled`]=!0)})}}),await b.contextMenu.create({id:`${c.EXTENSIONID}/switch-one-sided-type`,icons:[{icon:"/two-sided.svg",label:"Two-sided",filter:{some:[{key:["metadata",`${c.EXTENSIONID}/isVisionLine`],value:!0,coordinator:"&&"},{key:["metadata",`${c.EXTENSIONID}/oneSided`],value:void 0,coordinator:"||"},{key:["metadata",`${c.ARMINDOID}/isVisionLine`],value:!0,coordinator:"&&"},{key:["metadata",`${c.ARMINDOID}/oneSided`],value:void 0}]}},{icon:"/left-sided.svg",label:"One-sided left",filter:{some:[{key:["metadata",`${c.EXTENSIONID}/isVisionLine`],value:!0,coordinator:"&&"},{key:["metadata",`${c.EXTENSIONID}/oneSided`],value:"left",coordinator:"||"},{key:["metadata",`${c.ARMINDOID}/isVisionLine`],value:!0,coordinator:"&&"},{key:["metadata",`${c.ARMINDOID}/oneSided`],value:"left"}]}},{icon:"/right-sided.svg",label:"One-sided right",filter:{some:[{key:["metadata",`${c.EXTENSIONID}/isVisionLine`],value:!0,coordinator:"||"},{key:["metadata",`${c.ARMINDOID}/isVisionLine`],value:!0}]}}],async onClick(n){await b.scene.items.updateItems(n.items,e=>{for(const t of e)(t.metadata[`${c.EXTENSIONID}/isVisionLine`]||t.metadata[`${c.ARMINDOID}/isVisionLine`])&&(t.metadata[`${c.EXTENSIONID}/oneSided`]=="right"||t.metadata[`${c.ARMINDOID}/oneSided`]=="right")?(delete t.metadata[`${c.EXTENSIONID}/oneSided`],delete t.metadata[`${c.ARMINDOID}/oneSided`]):(t.metadata[`${c.EXTENSIONID}/isVisionLine`]||t.metadata[`${c.ARMINDOID}/isVisionLine`])&&(t.metadata[`${c.EXTENSIONID}/oneSided`]=="left"||t.metadata[`${c.ARMINDOID}/oneSided`]=="left")?(t.metadata[`${c.EXTENSIONID}/oneSided`]="right",t.metadata[`${c.ARMINDOID}/oneSided`]="right"):(t.metadata[`${c.EXTENSIONID}/isVisionLine`]||t.metadata[`${c.ARMINDOID}/isVisionLine`])&&(t.metadata[`${c.EXTENSIONID}/oneSided`]="left",t.metadata[`${c.ARMINDOID}/oneSided`]="left")})}}),await b.contextMenu.create({id:`${c.EXTENSIONID}/toggle-fog-background`,icons:[{icon:"/fog-background.svg",label:"Convert To Fog Background",filter:{every:[{key:"layer",value:"MAP"}]}}],async onClick(n){n.items.length>0&&await b.scene.items.updateItems(n.items,e=>{for(let t=0;t<e.length;t++)e[t].zIndex=1,e[t].layer="FOG",e[t].disableHit=!0,e[t].locked=!1,e[t].visible=!1,e[t].metadata[`${c.EXTENSIONID}/isBackgroundMap`]=!0})}}),await b.contextMenu.create({id:`${c.EXTENSIONID}/bounding-grid`,icons:[{icon:"/icon.svg",label:"Smoke Bounding Grid",filter:{every:[{key:["metadata",`${c.EXTENSIONID}/grid`],value:!0}]}}],async onClick(n){await b.notification.show("This is the Smoke&Spectre Bounding Grid. It contains the area your fog can be drawn in. To remove this and have fog contained dynamically by the size of your map(s), turn on AutoDetect Maps in Settings.","INFO")}}),await b.contextMenu.create({id:`${c.EXTENSIONID}/toggle-door`,icons:[{icon:"/opendoor.svg",label:"Enable Door",filter:{every:[{key:"layer",value:"DRAWING"},{key:["metadata",`${c.EXTENSIONID}/isVisionLine`],value:!0},{key:["metadata",`${c.EXTENSIONID}/isDoor`],value:void 0},{key:["metadata",`${c.EXTENSIONID}/doorId`],value:void 0},{key:["metadata",`${c.EXTENSIONID}/grid`],value:void 0}],roles:["GM"]}},{icon:"/closedoor.svg",label:"Disable Door",filter:{every:[{key:"layer",value:"DRAWING"},{key:["metadata",`${c.EXTENSIONID}/isVisionLine`],value:!0},{key:["metadata",`${c.EXTENSIONID}/doorId`],value:void 0},{key:["metadata",`${c.EXTENSIONID}/grid`],value:void 0}],roles:["GM"]}}],async onClick(n){const e=n.items.every(t=>t.metadata[`${c.EXTENSIONID}/isDoor`]===void 0);await b.scene.items.updateItems(n.items,t=>{for(const i of t)e?i.metadata[`${c.EXTENSIONID}/isDoor`]=!0:delete i.metadata[`${c.EXTENSIONID}/isDoor`]}),e?await Qt(n.items):await zo(n.items)}})}async function en(n){n?await b.contextMenu.create({id:`${c.EXTENSIONID}/toggle-autohide-menu`,icons:[{icon:"/autohide-off.svg",label:"Enable Autohide",filter:{every:[{key:"layer",value:"CHARACTER"},{key:["metadata",`${c.EXTENSIONID}/hasAutohide`],value:void 0}],roles:["GM"]}},{icon:"/autohide-on.svg",label:"Disable Autohide",filter:{every:[{key:"layer",value:"CHARACTER"}],roles:["GM"]}}],async onClick(e){const t=e.items.every(i=>i.metadata[`${c.EXTENSIONID}/hasAutohide`]===void 0);await b.scene.items.updateItems(e.items,i=>{for(const o of i)t?o.metadata[`${c.EXTENSIONID}/hasAutohide`]=!0:delete o.metadata[`${c.EXTENSIONID}/hasAutohide`]})}}):await b.contextMenu.remove(`${c.EXTENSIONID}/toggle-autohide-menu`)}function Sn(n,e){n.split(/\s+/).forEach(t=>{e(t)})}class rr{constructor(){this._events=void 0,this._events={}}on(e,t){Sn(e,i=>{const o=this._events[i]||[];o.push(t),this._events[i]=o})}off(e,t){var i=arguments.length;if(i===0){this._events={};return}Sn(e,o=>{if(i===1){delete this._events[o];return}const r=this._events[o];r!==void 0&&(r.splice(r.indexOf(t),1),this._events[o]=r)})}trigger(e,...t){var i=this;Sn(e,o=>{const r=i._events[o];r!==void 0&&r.forEach(a=>{a.apply(i,t)})})}}function ar(n){return n.plugins={},class extends n{constructor(...e){super(...e),this.plugins={names:[],settings:{},requested:{},loaded:{}}}static define(e,t){n.plugins[e]={name:e,fn:t}}initializePlugins(e){var t,i;const o=this,r=[];if(Array.isArray(e))e.forEach(a=>{typeof a=="string"?r.push(a):(o.plugins.settings[a.name]=a.options,r.push(a.name))});else if(e)for(t in e)e.hasOwnProperty(t)&&(o.plugins.settings[t]=e[t],r.push(t));for(;i=r.shift();)o.require(i)}loadPlugin(e){var t=this,i=t.plugins,o=n.plugins[e];if(!n.plugins.hasOwnProperty(e))throw new Error('Unable to find "'+e+'" plugin');i.requested[e]=!0,i.loaded[e]=o.fn.apply(t,[t.plugins.settings[e]||{}]),i.names.push(e)}require(e){var t=this,i=t.plugins;if(!t.plugins.loaded.hasOwnProperty(e)){if(i.requested[e])throw new Error('Plugin has circular dependency ("'+e+'")');t.loadPlugin(e)}return i.loaded[e]}}}/*! @orchidjs/unicode-variants | https://github.com/orchidjs/unicode-variants | Apache License (v2) */const an=n=>(n=n.filter(Boolean),n.length<2?n[0]||"":lr(n)==1?"["+n.join("")+"]":"(?:"+n.join("|")+")"),Wi=n=>{if(!sr(n))return n.join("");let e="",t=0;const i=()=>{t>1&&(e+="{"+t+"}")};return n.forEach((o,r)=>{if(o===n[r-1]){t++;return}i(),e+=o,t=1}),i(),e},ji=n=>{let e=Yn(n);return an(e)},sr=n=>new Set(n).size!==n.length,Mt=n=>(n+"").replace(/([\$\(\)\*\+\.\?\[\]\^\{\|\}\\])/gu,"\\$1"),lr=n=>n.reduce((e,t)=>Math.max(e,cr(t)),0),cr=n=>Yn(n).length,Yn=n=>Array.from(n);/*! @orchidjs/unicode-variants | https://github.com/orchidjs/unicode-variants | Apache License (v2) */const qi=n=>{if(n.length===1)return[[n]];let e=[];const t=n.substring(1);return qi(t).forEach(function(o){let r=o.slice(0);r[0]=n.charAt(0)+r[0],e.push(r),r=o.slice(0),r.unshift(n.charAt(0)),e.push(r)}),e};/*! @orchidjs/unicode-variants | https://github.com/orchidjs/unicode-variants | Apache License (v2) */const ur=[[0,65535]],dr="[̀-ͯ·ʾʼ]";let tn,Ki;const fr=3,Zn={},bi={"/":"⁄∕",0:"߀",a:"ⱥɐɑ",aa:"ꜳ",ae:"æǽǣ",ao:"ꜵ",au:"ꜷ",av:"ꜹꜻ",ay:"ꜽ",b:"ƀɓƃ",c:"ꜿƈȼↄ",d:"đɗɖᴅƌꮷԁɦ",e:"ɛǝᴇɇ",f:"ꝼƒ",g:"ǥɠꞡᵹꝿɢ",h:"ħⱨⱶɥ",i:"ɨı",j:"ɉȷ",k:"ƙⱪꝁꝃꝅꞣ",l:"łƚɫⱡꝉꝇꞁɭ",m:"ɱɯϻ",n:"ꞥƞɲꞑᴎлԉ",o:"øǿɔɵꝋꝍᴑ",oe:"œ",oi:"ƣ",oo:"ꝏ",ou:"ȣ",p:"ƥᵽꝑꝓꝕρ",q:"ꝗꝙɋ",r:"ɍɽꝛꞧꞃ",s:"ßȿꞩꞅʂ",t:"ŧƭʈⱦꞇ",th:"þ",tz:"ꜩ",u:"ʉ",v:"ʋꝟʌ",vy:"ꝡ",w:"ⱳ",y:"ƴɏỿ",z:"ƶȥɀⱬꝣ",hv:"ƕ"};for(let n in bi){let e=bi[n]||"";for(let t=0;t<e.length;t++){let i=e.substring(t,t+1);Zn[i]=n}}const hr=new RegExp(Object.keys(Zn).join("|")+"|"+dr,"gu"),pr=n=>{tn===void 0&&(tn=vr(n||ur))},Ni=(n,e="NFKD")=>n.normalize(e),nn=n=>Yn(n).reduce((e,t)=>e+gr(t),""),gr=n=>(n=Ni(n).toLowerCase().replace(hr,e=>Zn[e]||""),Ni(n,"NFC"));function*mr(n){for(const[e,t]of n)for(let i=e;i<=t;i++){let o=String.fromCharCode(i),r=nn(o);r!=o.toLowerCase()&&(r.length>fr||r.length!=0&&(yield{folded:r,composed:o,code_point:i}))}}const yr=n=>{const e={},t=(i,o)=>{const r=e[i]||new Set,a=new RegExp("^"+ji(r)+"$","iu");o.match(a)||(r.add(Mt(o)),e[i]=r)};for(let i of mr(n))t(i.folded,i.folded),t(i.folded,i.composed);return e},vr=n=>{const e=yr(n),t={};let i=[];for(let r in e){let a=e[r];a&&(t[r]=ji(a)),r.length>1&&i.push(Mt(r))}i.sort((r,a)=>a.length-r.length);const o=an(i);return Ki=new RegExp("^"+o,"u"),t},Er=(n,e=1)=>{let t=0;return n=n.map(i=>(tn[i]&&(t+=i.length),tn[i]||i)),t>=e?Wi(n):""},Ir=(n,e=1)=>(e=Math.max(e,n.length-1),an(qi(n).map(t=>Er(t,e)))),Oi=(n,e=!0)=>{let t=n.length>1?1:0;return an(n.map(i=>{let o=[];const r=e?i.length():i.length()-1;for(let a=0;a<r;a++)o.push(Ir(i.substrs[a]||"",t));return Wi(o)}))},wr=(n,e)=>{for(const t of e){if(t.start!=n.start||t.end!=n.end||t.substrs.join("")!==n.substrs.join(""))continue;let i=n.parts;const o=a=>{for(const u of i){if(u.start===a.start&&u.substr===a.substr)return!1;if(!(a.length==1||u.length==1)&&(a.start<u.start&&a.end>u.start||u.start<a.start&&u.end>a.start))return!0}return!1};if(!(t.parts.filter(o).length>0))return!0}return!1};class on{constructor(){this.parts=[],this.substrs=[],this.start=0,this.end=0}add(e){e&&(this.parts.push(e),this.substrs.push(e.substr),this.start=Math.min(e.start,this.start),this.end=Math.max(e.end,this.end))}last(){return this.parts[this.parts.length-1]}length(){return this.parts.length}clone(e,t){let i=new on,o=JSON.parse(JSON.stringify(this.parts)),r=o.pop();for(const h of o)i.add(h);let a=t.substr.substring(0,e-r.start),u=a.length;return i.add({start:r.start,end:r.start+u,length:u,substr:a}),i}}const Tr=n=>{pr(),n=nn(n);let e="",t=[new on];for(let i=0;i<n.length;i++){let r=n.substring(i).match(Ki);const a=n.substring(i,i+1),u=r?r[0]:null;let h=[],y=new Set;for(const O of t){const D=O.last();if(!D||D.length==1||D.end<=i)if(u){const M=u.length;O.add({start:i,end:i+M,length:M,substr:u}),y.add("1")}else O.add({start:i,end:i+1,length:1,substr:a}),y.add("2");else if(u){let M=O.clone(i,D);const A=u.length;M.add({start:i,end:i+A,length:A,substr:u}),h.push(M)}else y.add("3")}if(h.length>0){h=h.sort((O,D)=>O.length()-D.length());for(let O of h)wr(O,t)||t.push(O);continue}if(i>0&&y.size==1&&!y.has("3")){e+=Oi(t,!1);let O=new on;const D=t[0];D&&O.add(D.last()),t=[O]}}return e+=Oi(t,!0),e};/*! sifter.js | https://github.com/orchidjs/sifter.js | Apache License (v2) */const Sr=(n,e)=>{if(n)return n[e]},br=(n,e)=>{if(n){for(var t,i=e.split(".");(t=i.shift())&&(n=n[t]););return n}},bn=(n,e,t)=>{var i,o;return!n||(n=n+"",e.regex==null)||(o=n.search(e.regex),o===-1)?0:(i=e.string.length/n.length,o===0&&(i+=.5),i*t)},Nn=(n,e)=>{var t=n[e];if(typeof t=="function")return t;t&&!Array.isArray(t)&&(n[e]=[t])},et=(n,e)=>{if(Array.isArray(n))n.forEach(e);else for(var t in n)n.hasOwnProperty(t)&&e(n[t],t)},Nr=(n,e)=>typeof n=="number"&&typeof e=="number"?n>e?1:n<e?-1:0:(n=nn(n+"").toLowerCase(),e=nn(e+"").toLowerCase(),n>e?1:e>n?-1:0);/*! sifter.js | https://github.com/orchidjs/sifter.js | Apache License (v2) */class Or{constructor(e,t){this.items=void 0,this.settings=void 0,this.items=e,this.settings=t||{diacritics:!0}}tokenize(e,t,i){if(!e||!e.length)return[];const o=[],r=e.split(/\s+/);var a;return i&&(a=new RegExp("^("+Object.keys(i).map(Mt).join("|")+"):(.*)$")),r.forEach(u=>{let h,y=null,O=null;a&&(h=u.match(a))&&(y=h[1],u=h[2]),u.length>0&&(this.settings.diacritics?O=Tr(u)||null:O=Mt(u),O&&t&&(O="\\b"+O)),o.push({string:u,regex:O?new RegExp(O,"iu"):null,field:y})}),o}getScoreFunction(e,t){var i=this.prepareSearch(e,t);return this._getScoreFunction(i)}_getScoreFunction(e){const t=e.tokens,i=t.length;if(!i)return function(){return 0};const o=e.options.fields,r=e.weights,a=o.length,u=e.getAttrFn;if(!a)return function(){return 1};const h=function(){return a===1?function(y,O){const D=o[0].field;return bn(u(O,D),y,r[D]||1)}:function(y,O){var D=0;if(y.field){const M=u(O,y.field);!y.regex&&M?D+=1/a:D+=bn(M,y,1)}else et(r,(M,A)=>{D+=bn(u(O,A),y,M)});return D/a}}();return i===1?function(y){return h(t[0],y)}:e.options.conjunction==="and"?function(y){var O,D=0;for(let M of t){if(O=h(M,y),O<=0)return 0;D+=O}return D/i}:function(y){var O=0;return et(t,D=>{O+=h(D,y)}),O/i}}getSortFunction(e,t){var i=this.prepareSearch(e,t);return this._getSortFunction(i)}_getSortFunction(e){var t,i=[];const o=this,r=e.options,a=!e.query&&r.sort_empty?r.sort_empty:r.sort;if(typeof a=="function")return a.bind(this);const u=function(O,D){return O==="$score"?D.score:e.getAttrFn(o.items[D.id],O)};if(a)for(let y of a)(e.query||y.field!=="$score")&&i.push(y);if(e.query){t=!0;for(let y of i)if(y.field==="$score"){t=!1;break}t&&i.unshift({field:"$score",direction:"desc"})}else i=i.filter(y=>y.field!=="$score");return i.length?function(y,O){var D,M;for(let A of i)if(M=A.field,D=(A.direction==="desc"?-1:1)*Nr(u(M,y),u(M,O)),D)return D;return 0}:null}prepareSearch(e,t){const i={};var o=Object.assign({},t);if(Nn(o,"sort"),Nn(o,"sort_empty"),o.fields){Nn(o,"fields");const r=[];o.fields.forEach(a=>{typeof a=="string"&&(a={field:a,weight:1}),r.push(a),i[a.field]="weight"in a?a.weight:1}),o.fields=r}return{options:o,query:e.toLowerCase().trim(),tokens:this.tokenize(e,o.respect_word_boundaries,i),total:0,items:[],weights:i,getAttrFn:o.nesting?br:Sr}}search(e,t){var i=this,o,r;r=this.prepareSearch(e,t),t=r.options,e=r.query;const a=t.score||i._getScoreFunction(r);e.length?et(i.items,(h,y)=>{o=a(h),(t.filter===!1||o>0)&&r.items.push({score:o,id:y})}):et(i.items,(h,y)=>{r.items.push({score:1,id:y})});const u=i._getSortFunction(r);return u&&r.items.sort(u),r.total=r.items.length,typeof t.limit=="number"&&(r.items=r.items.slice(0,t.limit)),r}}const Nt=(n,e)=>{if(Array.isArray(n))n.forEach(e);else for(var t in n)n.hasOwnProperty(t)&&e(n[t],t)},We=n=>{if(n.jquery)return n[0];if(n instanceof HTMLElement)return n;if(zi(n)){var e=document.createElement("template");return e.innerHTML=n.trim(),e.content.firstChild}return document.querySelector(n)},zi=n=>typeof n=="string"&&n.indexOf("<")>-1,kr=n=>n.replace(/['"\\]/g,"\\$&"),On=(n,e)=>{var t=document.createEvent("HTMLEvents");t.initEvent(e,!0,!1),n.dispatchEvent(t)},Ft=(n,e)=>{Object.assign(n.style,e)},Qe=(n,...e)=>{var t=Yi(e);n=Zi(n),n.map(i=>{t.map(o=>{i.classList.add(o)})})},pt=(n,...e)=>{var t=Yi(e);n=Zi(n),n.map(i=>{t.map(o=>{i.classList.remove(o)})})},Yi=n=>{var e=[];return Nt(n,t=>{typeof t=="string"&&(t=t.trim().split(/[\11\12\14\15\40]/)),Array.isArray(t)&&(e=e.concat(t))}),e.filter(Boolean)},Zi=n=>(Array.isArray(n)||(n=[n]),n),Kt=(n,e,t)=>{if(!(t&&!t.contains(n)))for(;n&&n.matches;){if(n.matches(e))return n;n=n.parentNode}},ki=(n,e=0)=>e>0?n[n.length-1]:n[0],Dr=n=>Object.keys(n).length===0,rn=(n,e)=>{if(!n)return-1;e=e||n.nodeName;for(var t=0;n=n.previousElementSibling;)n.matches(e)&&t++;return t},Ve=(n,e)=>{Nt(e,(t,i)=>{t==null?n.removeAttribute(i):n.setAttribute(i,""+t)})},Ln=(n,e)=>{n.parentNode&&n.parentNode.replaceChild(e,n)},Cr=(n,e)=>{if(e===null)return;if(typeof e=="string"){if(!e.length)return;e=new RegExp(e,"i")}const t=r=>{var a=r.data.match(e);if(a&&r.data.length>0){var u=document.createElement("span");u.className="highlight";var h=r.splitText(a.index);h.splitText(a[0].length);var y=h.cloneNode(!0);return u.appendChild(y),Ln(h,u),1}return 0},i=r=>{r.nodeType===1&&r.childNodes&&!/(script|style)/i.test(r.tagName)&&(r.className!=="highlight"||r.tagName!=="SPAN")&&Array.from(r.childNodes).forEach(a=>{o(a)})},o=r=>r.nodeType===3?t(r):(i(r),0);o(n)},xr=n=>{var e=n.querySelectorAll("span.highlight");Array.prototype.forEach.call(e,function(t){var i=t.parentNode;i.replaceChild(t.firstChild,t),i.normalize()})},_r=65,Ar=13,Ji=27,Rn=37,Mr=38,Qi=39,$r=40,Di=8,Pr=46,Xn=9,Lr=typeof navigator>"u"?!1:/Mac/.test(navigator.userAgent),Bt=Lr?"metaKey":"ctrlKey";var Ci={options:[],optgroups:[],plugins:[],delimiter:",",splitOn:null,persist:!0,diacritics:!0,create:null,createOnBlur:!1,createFilter:null,highlight:!0,openOnFocus:!0,shouldOpen:null,maxOptions:50,maxItems:null,hideSelected:null,duplicates:!1,addPrecedence:!1,selectOnTab:!1,preload:null,allowEmptyOption:!1,refreshThrottle:300,loadThrottle:300,loadingClass:"loading",dataAttr:null,optgroupField:"optgroup",valueField:"value",labelField:"text",disabledField:"disabled",optgroupLabelField:"label",optgroupValueField:"value",lockOptgroupOrder:!1,sortField:"$order",searchField:["text"],searchConjunction:"and",mode:null,wrapperClass:"ts-wrapper",controlClass:"ts-control",dropdownClass:"ts-dropdown",dropdownContentClass:"ts-dropdown-content",itemClass:"item",optionClass:"option",dropdownParent:null,controlInput:'<input type="text" autocomplete="off" size="1" />',copyClassesToDropdown:!1,placeholder:null,hidePlaceholder:null,shouldLoad:function(n){return n.length>0},render:{}};const st=n=>typeof n>"u"||n===null?null:zt(n),zt=n=>typeof n=="boolean"?n?"1":"0":n+"",Yt=n=>(n+"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;"),Rr=(n,e)=>e>0?setTimeout(n,e):(n.call(null),null),Xr=(n,e)=>{var t;return function(i,o){var r=this;t&&(r.loading=Math.max(r.loading-1,0),clearTimeout(t)),t=setTimeout(function(){t=null,r.loadedSearches[i]=!0,n.call(r,i,o)},e)}},xi=(n,e,t)=>{var i,o=n.trigger,r={};n.trigger=function(){var a=arguments[0];if(e.indexOf(a)!==-1)r[a]=arguments;else return o.apply(n,arguments)},t.apply(n,[]),n.trigger=o;for(i of e)i in r&&o.apply(n,r[i])},Fr=n=>({start:n.selectionStart||0,length:(n.selectionEnd||0)-(n.selectionStart||0)}),Pe=(n,e=!1)=>{n&&(n.preventDefault(),e&&n.stopPropagation())},Le=(n,e,t,i)=>{n.addEventListener(e,t,i)},It=(n,e)=>{if(!e||!e[n])return!1;var t=(e.altKey?1:0)+(e.ctrlKey?1:0)+(e.shiftKey?1:0)+(e.metaKey?1:0);return t===1},kn=(n,e)=>{const t=n.getAttribute("id");return t||(n.setAttribute("id",e),e)},_i=n=>n.replace(/[\\"']/g,"\\$&"),wt=(n,e)=>{e&&n.append(e)};function Ai(n,e){var t=Object.assign({},Ci,e),i=t.dataAttr,o=t.labelField,r=t.valueField,a=t.disabledField,u=t.optgroupField,h=t.optgroupLabelField,y=t.optgroupValueField,O=n.tagName.toLowerCase(),D=n.getAttribute("placeholder")||n.getAttribute("data-placeholder");if(!D&&!t.allowEmptyOption){let $=n.querySelector('option[value=""]');$&&(D=$.textContent)}var M={placeholder:D,options:[],optgroups:[],items:[],maxItems:null},A=()=>{var $,x=M.options,L={},P=1;let V=0;var F=w=>{var g=Object.assign({},w.dataset),E=i&&g[i];return typeof E=="string"&&E.length&&(g=Object.assign(g,JSON.parse(E))),g},oe=(w,g)=>{var E=st(w.value);if(E!=null&&!(!E&&!t.allowEmptyOption)){if(L.hasOwnProperty(E)){if(g){var m=L[E][u];m?Array.isArray(m)?m.push(g):L[E][u]=[m,g]:L[E][u]=g}}else{var k=F(w);k[o]=k[o]||w.textContent,k[r]=k[r]||E,k[a]=k[a]||w.disabled,k[u]=k[u]||g,k.$option=w,k.$order=k.$order||++V,L[E]=k,x.push(k)}w.selected&&M.items.push(E)}},C=w=>{var g,E;E=F(w),E[h]=E[h]||w.getAttribute("label")||"",E[y]=E[y]||P++,E[a]=E[a]||w.disabled,E.$order=E.$order||++V,M.optgroups.push(E),g=E[y],Nt(w.children,m=>{oe(m,g)})};M.maxItems=n.hasAttribute("multiple")?null:1,Nt(n.children,w=>{$=w.tagName.toLowerCase(),$==="optgroup"?C(w):$==="option"&&oe(w)})},T=()=>{const $=n.getAttribute(i);if($)M.options=JSON.parse($),Nt(M.options,L=>{M.items.push(L[r])});else{var x=n.value.trim()||"";if(!t.allowEmptyOption&&!x.length)return;const L=x.split(t.delimiter);Nt(L,P=>{const V={};V[o]=P,V[r]=P,M.options.push(V)}),M.items=L}};return O==="select"?A():T(),Object.assign({},Ci,M,e)}var Mi=0;class tt extends ar(rr){constructor(e,t){super(),this.control_input=void 0,this.wrapper=void 0,this.dropdown=void 0,this.control=void 0,this.dropdown_content=void 0,this.focus_node=void 0,this.order=0,this.settings=void 0,this.input=void 0,this.tabIndex=void 0,this.is_select_tag=void 0,this.rtl=void 0,this.inputId=void 0,this._destroy=void 0,this.sifter=void 0,this.isOpen=!1,this.isDisabled=!1,this.isReadOnly=!1,this.isRequired=void 0,this.isInvalid=!1,this.isValid=!0,this.isLocked=!1,this.isFocused=!1,this.isInputHidden=!1,this.isSetup=!1,this.ignoreFocus=!1,this.ignoreHover=!1,this.hasOptions=!1,this.currentResults=void 0,this.lastValue="",this.caretPos=0,this.loading=0,this.loadedSearches={},this.activeOption=null,this.activeItems=[],this.optgroups={},this.options={},this.userOptions={},this.items=[],this.refreshTimeout=null,Mi++;var i,o=We(e);if(o.tomselect)throw new Error("Tom Select already initialized on this element");o.tomselect=this;var r=window.getComputedStyle&&window.getComputedStyle(o,null);i=r.getPropertyValue("direction");const a=Ai(o,t);this.settings=a,this.input=o,this.tabIndex=o.tabIndex||0,this.is_select_tag=o.tagName.toLowerCase()==="select",this.rtl=/rtl/i.test(i),this.inputId=kn(o,"tomselect-"+Mi),this.isRequired=o.required,this.sifter=new Or(this.options,{diacritics:a.diacritics}),a.mode=a.mode||(a.maxItems===1?"single":"multi"),typeof a.hideSelected!="boolean"&&(a.hideSelected=a.mode==="multi"),typeof a.hidePlaceholder!="boolean"&&(a.hidePlaceholder=a.mode!=="multi");var u=a.createFilter;typeof u!="function"&&(typeof u=="string"&&(u=new RegExp(u)),u instanceof RegExp?a.createFilter=x=>u.test(x):a.createFilter=x=>this.settings.duplicates||!this.options[x]),this.initializePlugins(a.plugins),this.setupCallbacks(),this.setupTemplates();const h=We("<div>"),y=We("<div>"),O=this._render("dropdown"),D=We('<div role="listbox" tabindex="-1">'),M=this.input.getAttribute("class")||"",A=a.mode;var T;if(Qe(h,a.wrapperClass,M,A),Qe(y,a.controlClass),wt(h,y),Qe(O,a.dropdownClass,A),a.copyClassesToDropdown&&Qe(O,M),Qe(D,a.dropdownContentClass),wt(O,D),We(a.dropdownParent||h).appendChild(O),zi(a.controlInput)){T=We(a.controlInput);var $=["autocorrect","autocapitalize","autocomplete","spellcheck"];et($,x=>{o.getAttribute(x)&&Ve(T,{[x]:o.getAttribute(x)})}),T.tabIndex=-1,y.appendChild(T),this.focus_node=T}else a.controlInput?(T=We(a.controlInput),this.focus_node=T):(T=We("<input/>"),this.focus_node=y);this.wrapper=h,this.dropdown=O,this.dropdown_content=D,this.control=y,this.control_input=T,this.setup()}setup(){const e=this,t=e.settings,i=e.control_input,o=e.dropdown,r=e.dropdown_content,a=e.wrapper,u=e.control,h=e.input,y=e.focus_node,O={passive:!0},D=e.inputId+"-ts-dropdown";Ve(r,{id:D}),Ve(y,{role:"combobox","aria-haspopup":"listbox","aria-expanded":"false","aria-controls":D});const M=kn(y,e.inputId+"-ts-control"),A="label[for='"+kr(e.inputId)+"']",T=document.querySelector(A),$=e.focus.bind(e);if(T){Le(T,"click",$),Ve(T,{for:M});const P=kn(T,e.inputId+"-ts-label");Ve(y,{"aria-labelledby":P}),Ve(r,{"aria-labelledby":P})}if(a.style.width=h.style.width,e.plugins.names.length){const P="plugin-"+e.plugins.names.join(" plugin-");Qe([a,o],P)}(t.maxItems===null||t.maxItems>1)&&e.is_select_tag&&Ve(h,{multiple:"multiple"}),t.placeholder&&Ve(i,{placeholder:t.placeholder}),!t.splitOn&&t.delimiter&&(t.splitOn=new RegExp("\\s*"+Mt(t.delimiter)+"+\\s*")),t.load&&t.loadThrottle&&(t.load=Xr(t.load,t.loadThrottle)),Le(o,"mousemove",()=>{e.ignoreHover=!1}),Le(o,"mouseenter",P=>{var V=Kt(P.target,"[data-selectable]",o);V&&e.onOptionHover(P,V)},{capture:!0}),Le(o,"click",P=>{const V=Kt(P.target,"[data-selectable]");V&&(e.onOptionSelect(P,V),Pe(P,!0))}),Le(u,"click",P=>{var V=Kt(P.target,"[data-ts-item]",u);if(V&&e.onItemSelect(P,V)){Pe(P,!0);return}i.value==""&&(e.onClick(),Pe(P,!0))}),Le(y,"keydown",P=>e.onKeyDown(P)),Le(i,"keypress",P=>e.onKeyPress(P)),Le(i,"input",P=>e.onInput(P)),Le(y,"blur",P=>e.onBlur(P)),Le(y,"focus",P=>e.onFocus(P)),Le(i,"paste",P=>e.onPaste(P));const x=P=>{const V=P.composedPath()[0];if(!a.contains(V)&&!o.contains(V)){e.isFocused&&e.blur(),e.inputState();return}V==i&&e.isOpen?P.stopPropagation():Pe(P,!0)},L=()=>{e.isOpen&&e.positionDropdown()};Le(document,"mousedown",x),Le(window,"scroll",L,O),Le(window,"resize",L,O),this._destroy=()=>{document.removeEventListener("mousedown",x),window.removeEventListener("scroll",L),window.removeEventListener("resize",L),T&&T.removeEventListener("click",$)},this.revertSettings={innerHTML:h.innerHTML,tabIndex:h.tabIndex},h.tabIndex=-1,h.insertAdjacentElement("afterend",e.wrapper),e.sync(!1),t.items=[],delete t.optgroups,delete t.options,Le(h,"invalid",()=>{e.isValid&&(e.isValid=!1,e.isInvalid=!0,e.refreshState())}),e.updateOriginalInput(),e.refreshItems(),e.close(!1),e.inputState(),e.isSetup=!0,h.disabled?e.disable():h.readOnly?e.setReadOnly(!0):e.enable(),e.on("change",this.onChange),Qe(h,"tomselected","ts-hidden-accessible"),e.trigger("initialize"),t.preload===!0&&e.preload()}setupOptions(e=[],t=[]){this.addOptions(e),et(t,i=>{this.registerOptionGroup(i)})}setupTemplates(){var e=this,t=e.settings.labelField,i=e.settings.optgroupLabelField,o={optgroup:r=>{let a=document.createElement("div");return a.className="optgroup",a.appendChild(r.options),a},optgroup_header:(r,a)=>'<div class="optgroup-header">'+a(r[i])+"</div>",option:(r,a)=>"<div>"+a(r[t])+"</div>",item:(r,a)=>"<div>"+a(r[t])+"</div>",option_create:(r,a)=>'<div class="create">Add <strong>'+a(r.input)+"</strong>&hellip;</div>",no_results:()=>'<div class="no-results">No results found</div>',loading:()=>'<div class="spinner"></div>',not_loading:()=>{},dropdown:()=>"<div></div>"};e.settings.render=Object.assign({},o,e.settings.render)}setupCallbacks(){var e,t,i={initialize:"onInitialize",change:"onChange",item_add:"onItemAdd",item_remove:"onItemRemove",item_select:"onItemSelect",clear:"onClear",option_add:"onOptionAdd",option_remove:"onOptionRemove",option_clear:"onOptionClear",optgroup_add:"onOptionGroupAdd",optgroup_remove:"onOptionGroupRemove",optgroup_clear:"onOptionGroupClear",dropdown_open:"onDropdownOpen",dropdown_close:"onDropdownClose",type:"onType",load:"onLoad",focus:"onFocus",blur:"onBlur"};for(e in i)t=this.settings[i[e]],t&&this.on(e,t)}sync(e=!0){const t=this,i=e?Ai(t.input,{delimiter:t.settings.delimiter}):t.settings;t.setupOptions(i.options,i.optgroups),t.setValue(i.items||[],!0),t.lastQuery=null}onClick(){var e=this;if(e.activeItems.length>0){e.clearActiveItems(),e.focus();return}e.isFocused&&e.isOpen?e.blur():e.focus()}onMouseDown(){}onChange(){On(this.input,"input"),On(this.input,"change")}onPaste(e){var t=this;if(t.isInputHidden||t.isLocked){Pe(e);return}t.settings.splitOn&&setTimeout(()=>{var i=t.inputValue();if(i.match(t.settings.splitOn)){var o=i.trim().split(t.settings.splitOn);et(o,r=>{st(r)&&(this.options[r]?t.addItem(r):t.createItem(r))})}},0)}onKeyPress(e){var t=this;if(t.isLocked){Pe(e);return}var i=String.fromCharCode(e.keyCode||e.which);if(t.settings.create&&t.settings.mode==="multi"&&i===t.settings.delimiter){t.createItem(),Pe(e);return}}onKeyDown(e){var t=this;if(t.ignoreHover=!0,t.isLocked){e.keyCode!==Xn&&Pe(e);return}switch(e.keyCode){case _r:if(It(Bt,e)&&t.control_input.value==""){Pe(e),t.selectAll();return}break;case Ji:t.isOpen&&(Pe(e,!0),t.close()),t.clearActiveItems();return;case $r:if(!t.isOpen&&t.hasOptions)t.open();else if(t.activeOption){let i=t.getAdjacent(t.activeOption,1);i&&t.setActiveOption(i)}Pe(e);return;case Mr:if(t.activeOption){let i=t.getAdjacent(t.activeOption,-1);i&&t.setActiveOption(i)}Pe(e);return;case Ar:t.canSelect(t.activeOption)?(t.onOptionSelect(e,t.activeOption),Pe(e)):(t.settings.create&&t.createItem()||document.activeElement==t.control_input&&t.isOpen)&&Pe(e);return;case Rn:t.advanceSelection(-1,e);return;case Qi:t.advanceSelection(1,e);return;case Xn:t.settings.selectOnTab&&(t.canSelect(t.activeOption)&&(t.onOptionSelect(e,t.activeOption),Pe(e)),t.settings.create&&t.createItem()&&Pe(e));return;case Di:case Pr:t.deleteSelection(e);return}t.isInputHidden&&!It(Bt,e)&&Pe(e)}onInput(e){if(this.isLocked)return;const t=this.inputValue();if(this.lastValue!==t){if(this.lastValue=t,t==""){this._onInput();return}this.refreshTimeout&&clearTimeout(this.refreshTimeout),this.refreshTimeout=Rr(()=>{this.refreshTimeout=null,this._onInput()},this.settings.refreshThrottle)}}_onInput(){const e=this.lastValue;this.settings.shouldLoad.call(this,e)&&this.load(e),this.refreshOptions(),this.trigger("type",e)}onOptionHover(e,t){this.ignoreHover||this.setActiveOption(t,!1)}onFocus(e){var t=this,i=t.isFocused;if(t.isDisabled||t.isReadOnly){t.blur(),Pe(e);return}t.ignoreFocus||(t.isFocused=!0,t.settings.preload==="focus"&&t.preload(),i||t.trigger("focus"),t.activeItems.length||(t.inputState(),t.refreshOptions(!!t.settings.openOnFocus)),t.refreshState())}onBlur(e){if(document.hasFocus()!==!1){var t=this;if(t.isFocused){t.isFocused=!1,t.ignoreFocus=!1;var i=()=>{t.close(),t.setActiveItem(),t.setCaret(t.items.length),t.trigger("blur")};t.settings.create&&t.settings.createOnBlur?t.createItem(null,i):i()}}}onOptionSelect(e,t){var i,o=this;t.parentElement&&t.parentElement.matches("[data-disabled]")||(t.classList.contains("create")?o.createItem(null,()=>{o.settings.closeAfterSelect&&o.close()}):(i=t.dataset.value,typeof i<"u"&&(o.lastQuery=null,o.addItem(i),o.settings.closeAfterSelect&&o.close(),!o.settings.hideSelected&&e.type&&/click/.test(e.type)&&o.setActiveOption(t))))}canSelect(e){return!!(this.isOpen&&e&&this.dropdown_content.contains(e))}onItemSelect(e,t){var i=this;return!i.isLocked&&i.settings.mode==="multi"?(Pe(e),i.setActiveItem(t,e),!0):!1}canLoad(e){return!(!this.settings.load||this.loadedSearches.hasOwnProperty(e))}load(e){const t=this;if(!t.canLoad(e))return;Qe(t.wrapper,t.settings.loadingClass),t.loading++;const i=t.loadCallback.bind(t);t.settings.load.call(t,e,i)}loadCallback(e,t){const i=this;i.loading=Math.max(i.loading-1,0),i.lastQuery=null,i.clearActiveOption(),i.setupOptions(e,t),i.refreshOptions(i.isFocused&&!i.isInputHidden),i.loading||pt(i.wrapper,i.settings.loadingClass),i.trigger("load",e,t)}preload(){var e=this.wrapper.classList;e.contains("preloaded")||(e.add("preloaded"),this.load(""))}setTextboxValue(e=""){var t=this.control_input,i=t.value!==e;i&&(t.value=e,On(t,"update"),this.lastValue=e)}getValue(){return this.is_select_tag&&this.input.hasAttribute("multiple")?this.items:this.items.join(this.settings.delimiter)}setValue(e,t){var i=t?[]:["change"];xi(this,i,()=>{this.clear(t),this.addItems(e,t)})}setMaxItems(e){e===0&&(e=null),this.settings.maxItems=e,this.refreshState()}setActiveItem(e,t){var i=this,o,r,a,u,h,y;if(i.settings.mode!=="single"){if(!e){i.clearActiveItems(),i.isFocused&&i.inputState();return}if(o=t&&t.type.toLowerCase(),o==="click"&&It("shiftKey",t)&&i.activeItems.length){for(y=i.getLastActive(),a=Array.prototype.indexOf.call(i.control.children,y),u=Array.prototype.indexOf.call(i.control.children,e),a>u&&(h=a,a=u,u=h),r=a;r<=u;r++)e=i.control.children[r],i.activeItems.indexOf(e)===-1&&i.setActiveItemClass(e);Pe(t)}else o==="click"&&It(Bt,t)||o==="keydown"&&It("shiftKey",t)?e.classList.contains("active")?i.removeActiveItem(e):i.setActiveItemClass(e):(i.clearActiveItems(),i.setActiveItemClass(e));i.inputState(),i.isFocused||i.focus()}}setActiveItemClass(e){const t=this,i=t.control.querySelector(".last-active");i&&pt(i,"last-active"),Qe(e,"active last-active"),t.trigger("item_select",e),t.activeItems.indexOf(e)==-1&&t.activeItems.push(e)}removeActiveItem(e){var t=this.activeItems.indexOf(e);this.activeItems.splice(t,1),pt(e,"active")}clearActiveItems(){pt(this.activeItems,"active"),this.activeItems=[]}setActiveOption(e,t=!0){e!==this.activeOption&&(this.clearActiveOption(),e&&(this.activeOption=e,Ve(this.focus_node,{"aria-activedescendant":e.getAttribute("id")}),Ve(e,{"aria-selected":"true"}),Qe(e,"active"),t&&this.scrollToOption(e)))}scrollToOption(e,t){if(!e)return;const i=this.dropdown_content,o=i.clientHeight,r=i.scrollTop||0,a=e.offsetHeight,u=e.getBoundingClientRect().top-i.getBoundingClientRect().top+r;u+a>o+r?this.scroll(u-o+a,t):u<r&&this.scroll(u,t)}scroll(e,t){const i=this.dropdown_content;t&&(i.style.scrollBehavior=t),i.scrollTop=e,i.style.scrollBehavior=""}clearActiveOption(){this.activeOption&&(pt(this.activeOption,"active"),Ve(this.activeOption,{"aria-selected":null})),this.activeOption=null,Ve(this.focus_node,{"aria-activedescendant":null})}selectAll(){const e=this;if(e.settings.mode==="single")return;const t=e.controlChildren();t.length&&(e.inputState(),e.close(),e.activeItems=t,et(t,i=>{e.setActiveItemClass(i)}))}inputState(){var e=this;e.control.contains(e.control_input)&&(Ve(e.control_input,{placeholder:e.settings.placeholder}),e.activeItems.length>0||!e.isFocused&&e.settings.hidePlaceholder&&e.items.length>0?(e.setTextboxValue(),e.isInputHidden=!0):(e.settings.hidePlaceholder&&e.items.length>0&&Ve(e.control_input,{placeholder:""}),e.isInputHidden=!1),e.wrapper.classList.toggle("input-hidden",e.isInputHidden))}inputValue(){return this.control_input.value.trim()}focus(){var e=this;e.isDisabled||e.isReadOnly||(e.ignoreFocus=!0,e.control_input.offsetWidth?e.control_input.focus():e.focus_node.focus(),setTimeout(()=>{e.ignoreFocus=!1,e.onFocus()},0))}blur(){this.focus_node.blur(),this.onBlur()}getScoreFunction(e){return this.sifter.getScoreFunction(e,this.getSearchOptions())}getSearchOptions(){var e=this.settings,t=e.sortField;return typeof e.sortField=="string"&&(t=[{field:e.sortField}]),{fields:e.searchField,conjunction:e.searchConjunction,sort:t,nesting:e.nesting}}search(e){var t,i,o=this,r=this.getSearchOptions();if(o.settings.score&&(i=o.settings.score.call(o,e),typeof i!="function"))throw new Error('Tom Select "score" setting must be a function that returns a function');return e!==o.lastQuery?(o.lastQuery=e,t=o.sifter.search(e,Object.assign(r,{score:i})),o.currentResults=t):t=Object.assign({},o.currentResults),o.settings.hideSelected&&(t.items=t.items.filter(a=>{let u=st(a.id);return!(u&&o.items.indexOf(u)!==-1)})),t}refreshOptions(e=!0){var t,i,o,r,a,u,h,y,O,D;const M={},A=[];var T=this,$=T.inputValue();const x=$===T.lastQuery||$==""&&T.lastQuery==null;var L=T.search($),P=null,V=T.settings.shouldOpen||!1,F=T.dropdown_content;x&&(P=T.activeOption,P&&(O=P.closest("[data-group]"))),r=L.items.length,typeof T.settings.maxOptions=="number"&&(r=Math.min(r,T.settings.maxOptions)),r>0&&(V=!0);const oe=(w,g)=>{let E=M[w];if(E!==void 0){let k=A[E];if(k!==void 0)return[E,k.fragment]}let m=document.createDocumentFragment();return E=A.length,A.push({fragment:m,order:g,optgroup:w}),[E,m]};for(t=0;t<r;t++){let w=L.items[t];if(!w)continue;let g=w.id,E=T.options[g];if(E===void 0)continue;let m=zt(g),k=T.getOption(m,!0);for(T.settings.hideSelected||k.classList.toggle("selected",T.items.includes(m)),a=E[T.settings.optgroupField]||"",u=Array.isArray(a)?a:[a],i=0,o=u&&u.length;i<o;i++){a=u[i];let R=E.$order,j=T.optgroups[a];j===void 0?a="":R=j.$order;const[re,le]=oe(a,R);i>0&&(k=k.cloneNode(!0),Ve(k,{id:E.$id+"-clone-"+i,"aria-selected":null}),k.classList.add("ts-cloned"),pt(k,"active"),T.activeOption&&T.activeOption.dataset.value==g&&O&&O.dataset.group===a.toString()&&(P=k)),le.appendChild(k),a!=""&&(M[a]=re)}}T.settings.lockOptgroupOrder&&A.sort((w,g)=>w.order-g.order),h=document.createDocumentFragment(),et(A,w=>{let g=w.fragment,E=w.optgroup;if(!g||!g.children.length)return;let m=T.optgroups[E];if(m!==void 0){let k=document.createDocumentFragment(),R=T.render("optgroup_header",m);wt(k,R),wt(k,g);let j=T.render("optgroup",{group:m,options:k});wt(h,j)}else wt(h,g)}),F.innerHTML="",wt(F,h),T.settings.highlight&&(xr(F),L.query.length&&L.tokens.length&&et(L.tokens,w=>{Cr(F,w.regex)}));var C=w=>{let g=T.render(w,{input:$});return g&&(V=!0,F.insertBefore(g,F.firstChild)),g};if(T.loading?C("loading"):T.settings.shouldLoad.call(T,$)?L.items.length===0&&C("no_results"):C("not_loading"),y=T.canCreate($),y&&(D=C("option_create")),T.hasOptions=L.items.length>0||y,V){if(L.items.length>0){if(!P&&T.settings.mode==="single"&&T.items[0]!=null&&(P=T.getOption(T.items[0])),!F.contains(P)){let w=0;D&&!T.settings.addPrecedence&&(w=1),P=T.selectable()[w]}}else D&&(P=D);e&&!T.isOpen&&(T.open(),T.scrollToOption(P,"auto")),T.setActiveOption(P)}else T.clearActiveOption(),e&&T.isOpen&&T.close(!1)}selectable(){return this.dropdown_content.querySelectorAll("[data-selectable]")}addOption(e,t=!1){const i=this;if(Array.isArray(e))return i.addOptions(e,t),!1;const o=st(e[i.settings.valueField]);return o===null||i.options.hasOwnProperty(o)?!1:(e.$order=e.$order||++i.order,e.$id=i.inputId+"-opt-"+e.$order,i.options[o]=e,i.lastQuery=null,t&&(i.userOptions[o]=t,i.trigger("option_add",o,e)),o)}addOptions(e,t=!1){et(e,i=>{this.addOption(i,t)})}registerOption(e){return this.addOption(e)}registerOptionGroup(e){var t=st(e[this.settings.optgroupValueField]);return t===null?!1:(e.$order=e.$order||++this.order,this.optgroups[t]=e,t)}addOptionGroup(e,t){var i;t[this.settings.optgroupValueField]=e,(i=this.registerOptionGroup(t))&&this.trigger("optgroup_add",i,t)}removeOptionGroup(e){this.optgroups.hasOwnProperty(e)&&(delete this.optgroups[e],this.clearCache(),this.trigger("optgroup_remove",e))}clearOptionGroups(){this.optgroups={},this.clearCache(),this.trigger("optgroup_clear")}updateOption(e,t){const i=this;var o,r;const a=st(e),u=st(t[i.settings.valueField]);if(a===null)return;const h=i.options[a];if(h==null)return;if(typeof u!="string")throw new Error("Value must be set in option data");const y=i.getOption(a),O=i.getItem(a);if(t.$order=t.$order||h.$order,delete i.options[a],i.uncacheValue(u),i.options[u]=t,y){if(i.dropdown_content.contains(y)){const D=i._render("option",t);Ln(y,D),i.activeOption===y&&i.setActiveOption(D)}y.remove()}O&&(r=i.items.indexOf(a),r!==-1&&i.items.splice(r,1,u),o=i._render("item",t),O.classList.contains("active")&&Qe(o,"active"),Ln(O,o)),i.lastQuery=null}removeOption(e,t){const i=this;e=zt(e),i.uncacheValue(e),delete i.userOptions[e],delete i.options[e],i.lastQuery=null,i.trigger("option_remove",e),i.removeItem(e,t)}clearOptions(e){const t=(e||this.clearFilter).bind(this);this.loadedSearches={},this.userOptions={},this.clearCache();const i={};et(this.options,(o,r)=>{t(o,r)&&(i[r]=o)}),this.options=this.sifter.items=i,this.lastQuery=null,this.trigger("option_clear")}clearFilter(e,t){return this.items.indexOf(t)>=0}getOption(e,t=!1){const i=st(e);if(i===null)return null;const o=this.options[i];if(o!=null){if(o.$div)return o.$div;if(t)return this._render("option",o)}return null}getAdjacent(e,t,i="option"){var o=this,r;if(!e)return null;i=="item"?r=o.controlChildren():r=o.dropdown_content.querySelectorAll("[data-selectable]");for(let a=0;a<r.length;a++)if(r[a]==e)return t>0?r[a+1]:r[a-1];return null}getItem(e){if(typeof e=="object")return e;var t=st(e);return t!==null?this.control.querySelector(`[data-value="${_i(t)}"]`):null}addItems(e,t){var i=this,o=Array.isArray(e)?e:[e];o=o.filter(a=>i.items.indexOf(a)===-1);const r=o[o.length-1];o.forEach(a=>{i.isPending=a!==r,i.addItem(a,t)})}addItem(e,t){var i=t?[]:["change","dropdown_close"];xi(this,i,()=>{var o,r;const a=this,u=a.settings.mode,h=st(e);if(!(h&&a.items.indexOf(h)!==-1&&(u==="single"&&a.close(),u==="single"||!a.settings.duplicates))&&!(h===null||!a.options.hasOwnProperty(h))&&(u==="single"&&a.clear(t),!(u==="multi"&&a.isFull()))){if(o=a._render("item",a.options[h]),a.control.contains(o)&&(o=o.cloneNode(!0)),r=a.isFull(),a.items.splice(a.caretPos,0,h),a.insertAtCaret(o),a.isSetup){if(!a.isPending&&a.settings.hideSelected){let y=a.getOption(h),O=a.getAdjacent(y,1);O&&a.setActiveOption(O)}!a.isPending&&!a.settings.closeAfterSelect&&a.refreshOptions(a.isFocused&&u!=="single"),a.settings.closeAfterSelect!=!1&&a.isFull()?a.close():a.isPending||a.positionDropdown(),a.trigger("item_add",h,o),a.isPending||a.updateOriginalInput({silent:t})}(!a.isPending||!r&&a.isFull())&&(a.inputState(),a.refreshState())}})}removeItem(e=null,t){const i=this;if(e=i.getItem(e),!e)return;var o,r;const a=e.dataset.value;o=rn(e),e.remove(),e.classList.contains("active")&&(r=i.activeItems.indexOf(e),i.activeItems.splice(r,1),pt(e,"active")),i.items.splice(o,1),i.lastQuery=null,!i.settings.persist&&i.userOptions.hasOwnProperty(a)&&i.removeOption(a,t),o<i.caretPos&&i.setCaret(i.caretPos-1),i.updateOriginalInput({silent:t}),i.refreshState(),i.positionDropdown(),i.trigger("item_remove",a,e)}createItem(e=null,t=()=>{}){arguments.length===3&&(t=arguments[2]),typeof t!="function"&&(t=()=>{});var i=this,o=i.caretPos,r;if(e=e||i.inputValue(),!i.canCreate(e))return t(),!1;i.lock();var a=!1,u=h=>{if(i.unlock(),!h||typeof h!="object")return t();var y=st(h[i.settings.valueField]);if(typeof y!="string")return t();i.setTextboxValue(),i.addOption(h,!0),i.setCaret(o),i.addItem(y),t(h),a=!0};return typeof i.settings.create=="function"?r=i.settings.create.call(this,e,u):r={[i.settings.labelField]:e,[i.settings.valueField]:e},a||u(r),!0}refreshItems(){var e=this;e.lastQuery=null,e.isSetup&&e.addItems(e.items),e.updateOriginalInput(),e.refreshState()}refreshState(){const e=this;e.refreshValidityState();const t=e.isFull(),i=e.isLocked;e.wrapper.classList.toggle("rtl",e.rtl);const o=e.wrapper.classList;o.toggle("focus",e.isFocused),o.toggle("disabled",e.isDisabled),o.toggle("readonly",e.isReadOnly),o.toggle("required",e.isRequired),o.toggle("invalid",!e.isValid),o.toggle("locked",i),o.toggle("full",t),o.toggle("input-active",e.isFocused&&!e.isInputHidden),o.toggle("dropdown-active",e.isOpen),o.toggle("has-options",Dr(e.options)),o.toggle("has-items",e.items.length>0)}refreshValidityState(){var e=this;e.input.validity&&(e.isValid=e.input.validity.valid,e.isInvalid=!e.isValid)}isFull(){return this.settings.maxItems!==null&&this.items.length>=this.settings.maxItems}updateOriginalInput(e={}){const t=this;var i,o;const r=t.input.querySelector('option[value=""]');if(t.is_select_tag){let h=function(y,O,D){return y||(y=We('<option value="'+Yt(O)+'">'+Yt(D)+"</option>")),y!=r&&t.input.append(y),a.push(y),(y!=r||u>0)&&(y.selected=!0),y};const a=[],u=t.input.querySelectorAll("option:checked").length;t.input.querySelectorAll("option:checked").forEach(y=>{y.selected=!1}),t.items.length==0&&t.settings.mode=="single"?h(r,"",""):t.items.forEach(y=>{if(i=t.options[y],o=i[t.settings.labelField]||"",a.includes(i.$option)){const O=t.input.querySelector(`option[value="${_i(y)}"]:not(:checked)`);h(O,y,o)}else i.$option=h(i.$option,y,o)})}else t.input.value=t.getValue();t.isSetup&&(e.silent||t.trigger("change",t.getValue()))}open(){var e=this;e.isLocked||e.isOpen||e.settings.mode==="multi"&&e.isFull()||(e.isOpen=!0,Ve(e.focus_node,{"aria-expanded":"true"}),e.refreshState(),Ft(e.dropdown,{visibility:"hidden",display:"block"}),e.positionDropdown(),Ft(e.dropdown,{visibility:"visible",display:"block"}),e.focus(),e.trigger("dropdown_open",e.dropdown))}close(e=!0){var t=this,i=t.isOpen;e&&(t.setTextboxValue(),t.settings.mode==="single"&&t.items.length&&t.inputState()),t.isOpen=!1,Ve(t.focus_node,{"aria-expanded":"false"}),Ft(t.dropdown,{display:"none"}),t.settings.hideSelected&&t.clearActiveOption(),t.refreshState(),i&&t.trigger("dropdown_close",t.dropdown)}positionDropdown(){if(this.settings.dropdownParent==="body"){var e=this.control,t=e.getBoundingClientRect(),i=e.offsetHeight+t.top+window.scrollY,o=t.left+window.scrollX;Ft(this.dropdown,{width:t.width+"px",top:i+"px",left:o+"px"})}}clear(e){var t=this;if(t.items.length){var i=t.controlChildren();et(i,o=>{t.removeItem(o,!0)}),t.inputState(),e||t.updateOriginalInput(),t.trigger("clear")}}insertAtCaret(e){const t=this,i=t.caretPos,o=t.control;o.insertBefore(e,o.children[i]||null),t.setCaret(i+1)}deleteSelection(e){var t,i,o,r,a=this;t=e&&e.keyCode===Di?-1:1,i=Fr(a.control_input);const u=[];if(a.activeItems.length)r=ki(a.activeItems,t),o=rn(r),t>0&&o++,et(a.activeItems,h=>u.push(h));else if((a.isFocused||a.settings.mode==="single")&&a.items.length){const h=a.controlChildren();let y;t<0&&i.start===0&&i.length===0?y=h[a.caretPos-1]:t>0&&i.start===a.inputValue().length&&(y=h[a.caretPos]),y!==void 0&&u.push(y)}if(!a.shouldDelete(u,e))return!1;for(Pe(e,!0),typeof o<"u"&&a.setCaret(o);u.length;)a.removeItem(u.pop());return a.inputState(),a.positionDropdown(),a.refreshOptions(!1),!0}shouldDelete(e,t){const i=e.map(o=>o.dataset.value);return!(!i.length||typeof this.settings.onDelete=="function"&&this.settings.onDelete(i,t)===!1)}advanceSelection(e,t){var i,o,r=this;r.rtl&&(e*=-1),!r.inputValue().length&&(It(Bt,t)||It("shiftKey",t)?(i=r.getLastActive(e),i?i.classList.contains("active")?o=r.getAdjacent(i,e,"item"):o=i:e>0?o=r.control_input.nextElementSibling:o=r.control_input.previousElementSibling,o&&(o.classList.contains("active")&&r.removeActiveItem(i),r.setActiveItemClass(o))):r.moveCaret(e))}moveCaret(e){}getLastActive(e){let t=this.control.querySelector(".last-active");if(t)return t;var i=this.control.querySelectorAll(".active");if(i)return ki(i,e)}setCaret(e){this.caretPos=this.items.length}controlChildren(){return Array.from(this.control.querySelectorAll("[data-ts-item]"))}lock(){this.setLocked(!0)}unlock(){this.setLocked(!1)}setLocked(e=this.isReadOnly||this.isDisabled){this.isLocked=e,this.refreshState()}disable(){this.setDisabled(!0),this.close()}enable(){this.setDisabled(!1)}setDisabled(e){this.focus_node.tabIndex=e?-1:this.tabIndex,this.isDisabled=e,this.input.disabled=e,this.control_input.disabled=e,this.setLocked()}setReadOnly(e){this.isReadOnly=e,this.input.readOnly=e,this.control_input.readOnly=e,this.setLocked()}destroy(){var e=this,t=e.revertSettings;e.trigger("destroy"),e.off(),e.wrapper.remove(),e.dropdown.remove(),e.input.innerHTML=t.innerHTML,e.input.tabIndex=t.tabIndex,pt(e.input,"tomselected","ts-hidden-accessible"),e._destroy(),delete e.input.tomselect}render(e,t){var i,o;const r=this;if(typeof this.settings.render[e]!="function"||(o=r.settings.render[e].call(this,t,Yt),!o))return null;if(o=We(o),e==="option"||e==="option_create"?t[r.settings.disabledField]?Ve(o,{"aria-disabled":"true"}):Ve(o,{"data-selectable":""}):e==="optgroup"&&(i=t.group[r.settings.optgroupValueField],Ve(o,{"data-group":i}),t.group[r.settings.disabledField]&&Ve(o,{"data-disabled":""})),e==="option"||e==="item"){const a=zt(t[r.settings.valueField]);Ve(o,{"data-value":a}),e==="item"?(Qe(o,r.settings.itemClass),Ve(o,{"data-ts-item":""})):(Qe(o,r.settings.optionClass),Ve(o,{role:"option",id:t.$id}),t.$div=o,r.options[a]=t)}return o}_render(e,t){const i=this.render(e,t);if(i==null)throw"HTMLElement expected";return i}clearCache(){et(this.options,e=>{e.$div&&(e.$div.remove(),delete e.$div)})}uncacheValue(e){const t=this.getOption(e);t&&t.remove()}canCreate(e){return this.settings.create&&e.length>0&&this.settings.createFilter.call(this,e)}hook(e,t,i){var o=this,r=o[t];o[t]=function(){var a,u;return e==="after"&&(a=r.apply(o,arguments)),u=i.apply(o,arguments),e==="instead"?u:(e==="before"&&(a=r.apply(o,arguments)),a)}}}function Br(){Le(this.input,"change",()=>{this.sync()})}function Vr(n){var e=this,t=e.onOptionSelect;e.settings.hideSelected=!1;const i=Object.assign({className:"tomselect-checkbox",checkedClassNames:void 0,uncheckedClassNames:void 0},n);var o=function(u,h){h?(u.checked=!0,i.uncheckedClassNames&&u.classList.remove(...i.uncheckedClassNames),i.checkedClassNames&&u.classList.add(...i.checkedClassNames)):(u.checked=!1,i.checkedClassNames&&u.classList.remove(...i.checkedClassNames),i.uncheckedClassNames&&u.classList.add(...i.uncheckedClassNames))},r=function(u){setTimeout(()=>{var h=u.querySelector("input."+i.className);h instanceof HTMLInputElement&&o(h,u.classList.contains("selected"))},1)};e.hook("after","setupTemplates",()=>{var a=e.settings.render.option;e.settings.render.option=(u,h)=>{var y=We(a.call(e,u,h)),O=document.createElement("input");i.className&&O.classList.add(i.className),O.addEventListener("click",function(M){Pe(M)}),O.type="checkbox";const D=st(u[e.settings.valueField]);return o(O,!!(D&&e.items.indexOf(D)>-1)),y.prepend(O),y}}),e.on("item_remove",a=>{var u=e.getOption(a);u&&(u.classList.remove("selected"),r(u))}),e.on("item_add",a=>{var u=e.getOption(a);u&&r(u)}),e.hook("instead","onOptionSelect",(a,u)=>{if(u.classList.contains("selected")){u.classList.remove("selected"),e.removeItem(u.dataset.value),e.refreshOptions(),Pe(a,!0);return}t.call(e,a,u),r(u)})}function Hr(n){const e=this,t=Object.assign({className:"clear-button",title:"Clear All",html:i=>`<div class="${i.className}" title="${i.title}">&#10799;</div>`},n);e.on("initialize",()=>{var i=We(t.html(t));i.addEventListener("click",o=>{e.isLocked||(e.clear(),e.settings.mode==="single"&&e.settings.allowEmptyOption&&e.addItem(""),o.preventDefault(),o.stopPropagation())}),e.control.appendChild(i)})}const Ur=(n,e)=>{var t;(t=n.parentNode)==null||t.insertBefore(e,n.nextSibling)},Gr=(n,e)=>{var t;(t=n.parentNode)==null||t.insertBefore(e,n)},Wr=(n,e)=>{do{var t;if(e=(t=e)==null?void 0:t.previousElementSibling,n==e)return!0}while(e&&e.previousElementSibling);return!1};function jr(){var n=this;if(n.settings.mode!=="multi")return;var e=n.lock,t=n.unlock;let i=!0,o;n.hook("after","setupTemplates",()=>{var r=n.settings.render.item;n.settings.render.item=(a,u)=>{const h=We(r.call(n,a,u));Ve(h,{draggable:"true"});const y=$=>{i||Pe($),$.stopPropagation()},O=$=>{o=h,setTimeout(()=>{h.classList.add("ts-dragging")},0)},D=$=>{$.preventDefault(),h.classList.add("ts-drag-over"),A(h,o)},M=()=>{h.classList.remove("ts-drag-over")},A=($,x)=>{x!==void 0&&(Wr(x,h)?Ur($,x):Gr($,x))},T=()=>{var $;document.querySelectorAll(".ts-drag-over").forEach(L=>L.classList.remove("ts-drag-over")),($=o)==null||$.classList.remove("ts-dragging"),o=void 0;var x=[];n.control.querySelectorAll("[data-value]").forEach(L=>{if(L.dataset.value){let P=L.dataset.value;P&&x.push(P)}}),n.setValue(x)};return Le(h,"mousedown",y),Le(h,"dragstart",O),Le(h,"dragenter",D),Le(h,"dragover",D),Le(h,"dragleave",M),Le(h,"dragend",T),h}}),n.hook("instead","lock",()=>(i=!1,e.call(n))),n.hook("instead","unlock",()=>(i=!0,t.call(n)))}function qr(n){const e=this,t=Object.assign({title:"Untitled",headerClass:"dropdown-header",titleRowClass:"dropdown-header-title",labelClass:"dropdown-header-label",closeClass:"dropdown-header-close",html:i=>'<div class="'+i.headerClass+'"><div class="'+i.titleRowClass+'"><span class="'+i.labelClass+'">'+i.title+'</span><a class="'+i.closeClass+'">&times;</a></div></div>'},n);e.on("initialize",()=>{var i=We(t.html(t)),o=i.querySelector("."+t.closeClass);o&&o.addEventListener("click",r=>{Pe(r,!0),e.close()}),e.dropdown.insertBefore(i,e.dropdown.firstChild)})}function Kr(){var n=this;n.hook("instead","setCaret",e=>{n.settings.mode==="single"||!n.control.contains(n.control_input)?e=n.items.length:(e=Math.max(0,Math.min(n.items.length,e)),e!=n.caretPos&&!n.isPending&&n.controlChildren().forEach((t,i)=>{i<e?n.control_input.insertAdjacentElement("beforebegin",t):n.control.appendChild(t)})),n.caretPos=e}),n.hook("instead","moveCaret",e=>{if(!n.isFocused)return;const t=n.getLastActive(e);if(t){const i=rn(t);n.setCaret(e>0?i+1:i),n.setActiveItem(),pt(t,"last-active")}else n.setCaret(n.caretPos+e)})}function zr(){const n=this;n.settings.shouldOpen=!0,n.hook("before","setup",()=>{n.focus_node=n.control,Qe(n.control_input,"dropdown-input");const e=We('<div class="dropdown-input-wrap">');e.append(n.control_input),n.dropdown.insertBefore(e,n.dropdown.firstChild);const t=We('<input class="items-placeholder" tabindex="-1" />');t.placeholder=n.settings.placeholder||"",n.control.append(t)}),n.on("initialize",()=>{n.control_input.addEventListener("keydown",t=>{switch(t.keyCode){case Ji:n.isOpen&&(Pe(t,!0),n.close()),n.clearActiveItems();return;case Xn:n.focus_node.tabIndex=-1;break}return n.onKeyDown.call(n,t)}),n.on("blur",()=>{n.focus_node.tabIndex=n.isDisabled?-1:n.tabIndex}),n.on("dropdown_open",()=>{n.control_input.focus()});const e=n.onBlur;n.hook("instead","onBlur",t=>{if(!(t&&t.relatedTarget==n.control_input))return e.call(n)}),Le(n.control_input,"blur",()=>n.onBlur()),n.hook("before","close",()=>{n.isOpen&&n.focus_node.focus({preventScroll:!0})})})}function Yr(){var n=this;n.on("initialize",()=>{var e=document.createElement("span"),t=n.control_input;e.style.cssText="position:absolute; top:-99999px; left:-99999px; width:auto; padding:0; white-space:pre; ",n.wrapper.appendChild(e);var i=["letterSpacing","fontSize","fontFamily","fontWeight","textTransform"];for(const r of i)e.style[r]=t.style[r];var o=()=>{e.textContent=t.value,t.style.width=e.clientWidth+"px"};o(),n.on("update item_add item_remove",o),Le(t,"input",o),Le(t,"keyup",o),Le(t,"blur",o),Le(t,"update",o)})}function Zr(){var n=this,e=n.deleteSelection;this.hook("instead","deleteSelection",t=>n.activeItems.length?e.call(n,t):!1)}function Jr(){this.hook("instead","setActiveItem",()=>{}),this.hook("instead","selectAll",()=>{})}function Qr(){var n=this,e=n.onKeyDown;n.hook("instead","onKeyDown",t=>{var i,o,r,a;if(!n.isOpen||!(t.keyCode===Rn||t.keyCode===Qi))return e.call(n,t);n.ignoreHover=!0,a=Kt(n.activeOption,"[data-group]"),i=rn(n.activeOption,"[data-selectable]"),a&&(t.keyCode===Rn?a=a.previousSibling:a=a.nextSibling,a&&(r=a.querySelectorAll("[data-selectable]"),o=r[Math.min(r.length-1,i)],o&&n.setActiveOption(o)))})}function ea(n){const e=Object.assign({label:"&times;",title:"Remove",className:"remove",append:!0},n);var t=this;if(e.append){var i='<a href="javascript:void(0)" class="'+e.className+'" tabindex="-1" title="'+Yt(e.title)+'">'+e.label+"</a>";t.hook("after","setupTemplates",()=>{var o=t.settings.render.item;t.settings.render.item=(r,a)=>{var u=We(o.call(t,r,a)),h=We(i);return u.appendChild(h),Le(h,"mousedown",y=>{Pe(y,!0)}),Le(h,"click",y=>{t.isLocked||(Pe(y,!0),!t.isLocked&&t.shouldDelete([u],y)&&(t.removeItem(u),t.refreshOptions(!1),t.inputState()))}),u}})}}function ta(n){const e=this,t=Object.assign({text:i=>i[e.settings.labelField]},n);e.on("item_remove",function(i){if(e.isFocused&&e.control_input.value.trim()===""){var o=e.options[i];o&&e.setTextboxValue(t.text.call(e,o))}})}function na(){const n=this,e=n.canLoad,t=n.clearActiveOption,i=n.loadCallback;var o={},r,a=!1,u,h=[];if(n.settings.shouldLoadMore||(n.settings.shouldLoadMore=()=>{if(r.clientHeight/(r.scrollHeight-r.scrollTop)>.9)return!0;if(n.activeOption){var M=n.selectable(),A=Array.from(M).indexOf(n.activeOption);if(A>=M.length-2)return!0}return!1}),!n.settings.firstUrl)throw"virtual_scroll plugin requires a firstUrl() method";n.settings.sortField=[{field:"$order"},{field:"$score"}];const y=D=>typeof n.settings.maxOptions=="number"&&r.children.length>=n.settings.maxOptions?!1:!!(D in o&&o[D]),O=(D,M)=>n.items.indexOf(M)>=0||h.indexOf(M)>=0;n.setNextUrl=(D,M)=>{o[D]=M},n.getUrl=D=>{if(D in o){const M=o[D];return o[D]=!1,M}return n.clearPagination(),n.settings.firstUrl.call(n,D)},n.clearPagination=()=>{o={}},n.hook("instead","clearActiveOption",()=>{if(!a)return t.call(n)}),n.hook("instead","canLoad",D=>D in o?y(D):e.call(n,D)),n.hook("instead","loadCallback",(D,M)=>{if(!a)n.clearOptions(O);else if(u){const A=D[0];A!==void 0&&(u.dataset.value=A[n.settings.valueField])}i.call(n,D,M),a=!1}),n.hook("after","refreshOptions",()=>{const D=n.lastValue;var M;y(D)?(M=n.render("loading_more",{query:D}),M&&(M.setAttribute("data-selectable",""),u=M)):D in o&&!r.querySelector(".no-results")&&(M=n.render("no_more_results",{query:D})),M&&(Qe(M,n.settings.optionClass),r.append(M))}),n.on("initialize",()=>{h=Object.keys(n.options),r=n.dropdown_content,n.settings.render=Object.assign({},{loading_more:()=>'<div class="loading-more-results">Loading more results ... </div>',no_more_results:()=>'<div class="no-more-results">No more results</div>'},n.settings.render),r.addEventListener("scroll",()=>{n.settings.shouldLoadMore.call(n)&&y(n.lastValue)&&(a||(a=!0,n.load.call(n,n.lastValue)))})})}tt.define("change_listener",Br);tt.define("checkbox_options",Vr);tt.define("clear_button",Hr);tt.define("drag_drop",jr);tt.define("dropdown_header",qr);tt.define("caret_position",Kr);tt.define("dropdown_input",zr);tt.define("input_autogrow",Yr);tt.define("no_backspace_delete",Zr);tt.define("no_active_items",Jr);tt.define("optgroup_columns",Qr);tt.define("remove_button",ea);tt.define("restore_on_backspace",ta);tt.define("virtual_scroll",na);class ia{debouncedLocalChanges;debouncedBroadcastChanges;constructor(){this.debouncedBroadcastChanges=Ei(async e=>{if(!e.data||e.data.length===0)return;const t=e.data,i=p.playerRole==="GM"?t:t.filter(u=>u.metadata[`${c.SPECTREID}/viewers`].includes(p.playerId)),r=p.localGhosts.filter(u=>u.metadata[`${c.SPECTREID}/spectred`]===!0).filter(u=>u.metadata[`${c.SPECTREID}/viewers`].includes(p.playerId));if(!Tn(i,r)){const u=i.map(O=>O.id),h=[],y=p.localGhosts.filter(O=>!u.includes(O.id));for(const O of i){const D=p.localGhosts.find(M=>M.id===O.id);D&&Wo(O,D)||h.push(O)}h.length>0&&await b.scene.local.addItems(h),y.length>0&&await b.scene.local.deleteItems(y.map(O=>O.id)),p.localGhosts=t}},0),this.debouncedLocalChanges=Ei(async e=>{if(p.playerRole==="GM"){const t=e.filter(i=>i.metadata[`${c.SPECTREID}/spectred`]===!0);if(Tn(p.localGhosts,t))return;p.localGhosts=t,Ii(t)?await b.notification.show("You currently have too many Spectres in the scene. Unable to update.","ERROR"):(await b.scene.setMetadata({[`${c.SPECTREID}/current_spectres`]:t}),await b.broadcast.sendMessage(c.SPECTREBROADCASTID,t))}else{const t=e.filter(a=>a.metadata[`${c.SPECTREID}/spectred`]===!0),o=p.localGhosts.filter(a=>a.metadata[`${c.SPECTREID}/spectred`]===!0).filter(a=>a.metadata[`${c.SPECTREID}/viewers`].includes(p.playerId));if(t.length<o.length){const a=[];for(const u of o)t.includes(u)||a.push(u.id);a.length>0&&await b.broadcast.sendMessage("SPECTREDELETED",a)}if(t.length===0&&o.length===0)return;if(t.length<o.length){p.localGhosts=t;return}Tn(t,o)||(jo(p.localGhosts,t),await b.broadcast.sendMessage(c.SPECTREBROADCASTID,p.localGhosts))}},0)}SetupLocalSpecterHandlers(){p.sceneReady&&(b.broadcast.onMessage(c.SPECTREBROADCASTID,e=>{this.debouncedBroadcastChanges(e)}),p.playerRole==="GM"&&b.broadcast.onMessage("SPECTREDELETED",async e=>{const t=e.data;if(t.length>0){for(const i of t)document.getElementById(`tr-${i}`).remove();await b.scene.local.deleteItems(t)}}))}async LoadSpectreSceneMetadata(){p.localGhosts=p.sceneMetadata[`${c.SPECTREID}/current_spectres`],p.localGhosts||(p.localGhosts=[]);const e=[];for(const t of p.localGhosts)t.metadata[`${c.SPECTREID}/viewers`].includes(p.playerId)&&p.playerRole!=="GM"&&e.push(t);e.length>0&&await b.scene.local.addItems(e)}UpdateSpectreTargets(){const e=document.querySelectorAll(".tSelects");for(const t of e)if(t&&t.tomselect){const i=t.tomselect,o=[];for(const r of p.party)o.push({value:r.id,text:r.name});i.clearOptions(),i.addOption(o),o.length===0?(i.settings.placeholder="No Players Present",i.inputState()):(i.settings.placeholder="Choose..",i.inputState())}}async SetupSpectreGM(){await b.contextMenu.create({id:`${c.SPECTREID}/context-menu`,icons:[{icon:"/ghost.svg",label:"Spectre",filter:{every:[{key:"type",value:"IMAGE"},{key:["metadata",`${c.SPECTREID}/spectred`],value:void 0,operator:"==",coordinator:"&&"}]}},{icon:"/ghost.svg",label:"Un-Spectre",filter:{every:[{key:"type",value:"IMAGE"},{key:["metadata",`${c.SPECTREID}/spectred`],value:void 0,operator:"!=",coordinator:"&&"}]}}],async onClick(e){if(e.items.every(i=>i.metadata[`${c.SPECTREID}/spectred`]===void 0))if(Ii(p.localGhosts,e.items))await b.notification.show("This would exceed the maximum Spectres. Please remove some before adding more.","INFO");else for(const i of e.items){const o=i;dt.SetupTomSelect(o)}else for(const i of e.items){const o=i;await dt.RemoveGhost(o),o.metadata[`${c.SPECTREID}/spectred`]=void 0;const r=p.localGhosts.findIndex(u=>u.id===o.id);p.localGhosts.splice(r,1),document.getElementById(`tr-${o.id}`)?.remove(),o.metadata[`${c.SPECTREID}/viewers`]=[],await b.scene.items.addItems([o])}}})}async RestoreGhostsGM(){p.localGhosts=p.sceneMetadata[`${c.SPECTREID}/current_spectres`],p.localGhosts||(p.localGhosts=[]),p.localGhosts.length>0&&(await b.scene.local.addItems(p.localGhosts),p.localGhosts.forEach(e=>{this.SetupTomSelect(e)}))}async StoreGhost(e){let t=p.sceneMetadata[`${c.SPECTREID}/current_spectres`];if(!t)t=[e];else{if(t.find(o=>o.id===e.id))return;t.push(e)}await b.scene.setMetadata({[`${c.SPECTREID}/current_spectres`]:t})}async RemoveGhost(e){let t=p.sceneMetadata[`${c.SPECTREID}/current_spectres`];t||(t=[]);const i=t.filter(o=>o.id!==e.id);await b.scene.local.deleteItems([e.id]),await b.scene.setMetadata({[`${c.SPECTREID}/current_spectres`]:i})}async SetupTomSelect(e){const t=e.text?.plainText||e.name;let i=e.metadata[`${c.SPECTREID}/viewers`];e.metadata[`${c.SPECTREID}/spectred`]=!0,i===void 0&&(i=[],e.metadata[`${c.SPECTREID}/viewers`]=[]),await b.scene.items.deleteItems([e.id]),await b.scene.local.addItems([e]),await this.StoreGhost(e),p.localGhosts.push(e);const o=document.getElementById("ghostList"),r=document.createElement("tr");r.id=`tr-${e.id}`,r.className="ghost-table-entry",r.innerHTML=`<td class="token-name">${t}</td>
            <td><select id="select-${e.id}" class="tSelects" multiple autocomplete="off" /></td>
            <td><input type="button" class="mysteryButton" id="deleteGhost-${e.id}" value="Delete"/></td>`,o.appendChild(r);const a=document.getElementById(`select-${e.id}`);for(const O of p.party){const D=document.createElement("option");D.value=O.id,D.text=O.name,a.appendChild(D)}const u={plugins:{remove_button:{title:"Remove this item"}},allowEmptyOption:!0,placeholder:p.party.length==0?"No Players Present":"Choose..",maxItems:null,create:!1,onDelete:async function(O,D){const M=D.currentTarget.parentElement.parentElement.parentElement.parentElement.parentElement.id.slice(3);await b.scene.local.updateItems([M],A=>{const T=A[0].metadata[`${c.SPECTREID}/viewers`],$=T.findIndex(x=>x==O);T.splice($,1),A[0].metadata[`${c.SPECTREID}/viewers`]=T})},onItemAdd:async function(O,D){const M=D.parentElement.parentElement.parentElement.parentElement.id.slice(3);await b.scene.local.updateItems([M],A=>{const T=A[0].metadata[`${c.SPECTREID}/viewers`];T?(T.push(O),A[0].metadata[`${c.SPECTREID}/viewers`]=T):A[0].metadata[`${c.SPECTREID}/viewers`]=[O]})}},h=new tt(`#select-${e.id}`,u);if(i.length>0)for(const O of i){if(!p.party.find(M=>M.id===O)){const M=p.sceneMetadata[`${c.EXTENSIONID}/USER-${O}`],A=[];A.push({value:O,text:M.name}),h.addOption(A)}h.addItem(O,!0)}const y=document.getElementById(`deleteGhost-${e.id}`);y.onclick=async()=>{const O=p.localGhosts.findIndex(D=>D.id===e.id);p.localGhosts.splice(O,1),r.remove(),await b.scene.local.updateItems([e.id],D=>{D[0]&&(D[0].metadata[`${c.SPECTREID}/viewers`]=[])}),await this.RemoveGhost(e)}}ClearGhostList(){const e=document.getElementById("ghostList");e&&(e.innerHTML="")}}const dt=new ia;async function Fn(){await b.scene.items.deleteItems(p.sceneItems.filter(At).map(e=>e.id)),en(p.sceneMetadata[`${c.EXTENSIONID}/fowEnabled`]==!0);let n;if(p.sceneItems.filter(La).length==0){const e=p.sceneItems.filter(i=>i.layer=="MAP"&&Jt(i)),t=e.map(i=>i.image.width*i.image.height/Math.pow(i.grid.dpi,2));n=e[t.indexOf(Math.max(...t))]}if(p.sceneMetadata[`${c.EXTENSIONID}/autodetectEnabled`]===void 0&&(p.playerRole==="GM"&&(Z.autodetectCheckbox.checked=!0),await b.scene.setMetadata({[`${c.EXTENSIONID}/autodetectEnabled`]:!0})),p.sceneMetadata[`${c.EXTENSIONID}/sceneId`]===void 0)await b.scene.setMetadata({[`${c.EXTENSIONID}/sceneId`]:crypto.randomUUID()});else try{const e=p.sceneMetadata[`${c.EXTENSIONID}/sceneId`],t=localStorage.getItem(`${c.EXTENSIONID}/fogCache/${p.playerId}/${e}`);if(t!==null&&p.sceneMetadata[`${c.EXTENSIONID}/persistenceEnabled`]===!0){const i=JSON.parse(t),o=[];for(let r=0;r<i.length;r++){const a=gt().commands(i[r].commands).fillRule("evenodd").locked(!0).visible(!1).fillColor("#000000").strokeColor("#000000").layer("FOG").name("Fog of War").metadata({[`${c.EXTENSIONID}/isVisionFog`]:!0,[`${c.EXTENSIONID}/digest`]:i[r].digest}).build();a.zIndex=3,o.push(a)}await b.scene.local.addItems(o)}}catch{}p.playerRole==="GM"?(await dt.RestoreGhostsGM(),await Z.UpdateUI(),Z.mapSubmit.onclick=async()=>{await b.scene.items.updateItems([c.GRIDID],e=>{for(const t of e){const i=t;i.width=p.gridDpi*+Z.mapWidth.value,i.height=p.gridDpi*+Z.mapHeight.value,i.scale={x:1,y:1}}})},n!==void 0&&await b.scene.items.updateItems([n],e=>{e[0].metadata[`${c.EXTENSIONID}/isBackgroundImage`]=!0})):await dt.LoadSpectreSceneMetadata(),p.snap=!0,p.sceneInitialized=!0}var eo={exports:{}};const oa={},ra=Object.freeze(Object.defineProperty({__proto__:null,default:oa},Symbol.toStringTag,{value:"Module"})),Dn=Vo(ra);(function(n,e){var t=(()=>{var i=typeof document<"u"&&document.currentScript?document.currentScript.src:void 0;return typeof __filename<"u"&&(i=i||__filename),function(o){o=o||{};var r;r||(r=typeof o<"u"?o:{});var a=Object.assign,u,h;r.ready=new Promise(function(l,s){u=l,h=s}),function(l){var s={};l.loadCmdsTypedArray=function(U){for(var Y=0,ee=0;ee<U.length;ee++)Y+=U[ee].length;if(s[Y])var te=s[Y];else te=new Float32Array(Y),s[Y]=te;var ce=0;for(ee=0;ee<U.length;ee++)for(var _e=0;_e<U[ee].length;_e++){var Re=U[ee][_e];typeof Re=="string"&&(Re=l.SkBits2FloatUnsigned(parseInt(Re))),te[ce]=Re,ce++}return U=l._malloc(te.length*te.BYTES_PER_ELEMENT),l.HEAPF32.set(te,U/te.BYTES_PER_ELEMENT),[U,Y]},l.FromCmds=function(U){U=l.loadCmdsTypedArray(U);var Y=l._FromCmds(U[0],U[1]);return l._free(U[0]),Y};var d,v,_,X,z;l.cubicYFromX=function(U,Y,ee,te,ce){return d&&v===U&&_===Y&&X===ee&&z===te||(d&&d.delete(),d=new l._SkCubicMap([U,Y],[ee,te]),v=U,_=Y,X=ee,z=te),d.computeYFromX(ce)},l.cubicPtFromT=function(U,Y,ee,te,ce){return d&&v===U&&_===Y&&X===ee&&z===te||(d&&d.delete(),d=new l._SkCubicMap([U,Y],[ee,te]),v=U,_=Y,X=ee,z=te),d.computePtFromT(ce)}}(r),function(l){l.onRuntimeInitialized=function(){l.SkPath.prototype.addPath=function(){var s=arguments[0];if(arguments.length===1)this._addPath(s,1,0,0,0,1,0,0,0,1);else if(arguments.length===2){var d=arguments[1];this._addPath(s,d.a,d.c,d.e,d.b,d.d,d.f,0,0,1)}else if(arguments.length===7)d=arguments,this._addPath(s,d[1],d[3],d[5],d[2],d[4],d[6],0,0,1);else if(arguments.length===10)d=arguments,this._addPath(s,d[1],d[2],d[3],d[4],d[5],d[6],d[7],d[8],d[9]);else return console.Ma("addPath expected to take 1, 2, 7, or 10 args. Got "+arguments.length),null;return this},l.SkPath.prototype.arc=function(s,d,v,_,X,z){return this._arc(s,d,v,_,X,!!z),this},l.SkPath.prototype.arcTo=function(s,d,v,_,X){return this._arcTo(s,d,v,_,X),this},l.SkPath.prototype.bezierCurveTo=function(s,d,v,_,X,z){return this._cubicTo(s,d,v,_,X,z),this},l.SkPath.prototype.close=function(){return this._close(),this},l.SkPath.prototype.closePath=function(){return this._close(),this},l.SkPath.prototype.conicTo=function(s,d,v,_,X){return this._conicTo(s,d,v,_,X),this},l.SkPath.prototype.cubicTo=function(s,d,v,_,X,z){return this._cubicTo(s,d,v,_,X,z),this},l.SkPath.prototype.dash=function(s,d,v){return this._dash(s,d,v)?this:null},l.SkPath.prototype.ellipse=function(s,d,v,_,X,z,U,Y){return this._ellipse(s,d,v,_,X,z,U,!!Y),this},l.SkPath.prototype.lineTo=function(s,d){return this._lineTo(s,d),this},l.SkPath.prototype.moveTo=function(s,d){return this._moveTo(s,d),this},l.SkPath.prototype.op=function(s,d){return this._op(s,d)?this:null},l.SkPath.prototype.quadraticCurveTo=function(s,d,v,_){return this._quadTo(s,d,v,_),this},l.SkPath.prototype.quadTo=function(s,d,v,_){return this._quadTo(s,d,v,_),this},l.SkPath.prototype.rect=function(s,d,v,_){return this._rect(s,d,v,_),this},l.SkPath.prototype.simplify=function(){return this._simplify()?this:null},l.SkPath.prototype.stroke=function(s){return s=s||{},s.width=s.width||1,s.miter_limit=s.miter_limit||4,s.cap=s.cap||l.StrokeCap.BUTT,s.join=s.join||l.StrokeJoin.MITER,this._stroke(s)?this:null},l.SkPath.prototype.transform=function(){if(arguments.length===1)this._transform(arguments[0]);else if(arguments.length===9){var s=arguments;this._transform(s[0],s[1],s[2],s[3],s[4],s[5],s[6],s[7],s[8])}else return console.Ma("transform expected to take 1 or 9 arguments. Got "+arguments.length),null;return this},l.SkPath.prototype.trim=function(s,d,v){return this._trim(s,d,!!v)?this:null}}}(r);var y=a({},r),O=typeof window=="object",D=typeof importScripts=="function",M="",A,T,$,x,L,P;typeof process=="object"&&typeof process.versions=="object"&&typeof process.versions.node=="string"?(M=D?Dn.dirname(M)+"/":__dirname+"/",P=()=>{L||(x=Dn,L=Dn)},A=function(l,s){return P(),l=L.normalize(l),x.readFileSync(l,s?null:"utf8")},$=l=>(l=A(l,!0),l.buffer||(l=new Uint8Array(l)),l),T=(l,s,d)=>{P(),l=L.normalize(l),x.readFile(l,function(v,_){v?d(v):s(_.buffer)})},1<process.argv.length&&process.argv[1].replace(/\\/g,"/"),process.argv.slice(2),process.on("uncaughtException",function(l){throw l}),process.on("unhandledRejection",function(l){throw l}),r.inspect=function(){return"[Emscripten Module object]"}):(O||D)&&(D?M=self.location.href:typeof document<"u"&&document.currentScript&&(M=document.currentScript.src),i&&(M=i),M.indexOf("blob:")!==0?M=M.substr(0,M.replace(/[?#].*/,"").lastIndexOf("/")+1):M="",A=l=>{var s=new XMLHttpRequest;return s.open("GET",l,!1),s.send(null),s.responseText},D&&($=l=>{var s=new XMLHttpRequest;return s.open("GET",l,!1),s.responseType="arraybuffer",s.send(null),new Uint8Array(s.response)}),T=(l,s,d)=>{var v=new XMLHttpRequest;v.open("GET",l,!0),v.responseType="arraybuffer",v.onload=()=>{v.status==200||v.status==0&&v.response?s(v.response):d()},v.onerror=d,v.send(null)});var V=r.print||console.log.bind(console),F=r.printErr||console.warn.bind(console);a(r,y),y=null;var oe;r.wasmBinary&&(oe=r.wasmBinary),r.noExitRuntime,typeof WebAssembly!="object"&&ue("no native wasm support detected");var C,w=!1,g=typeof TextDecoder<"u"?new TextDecoder("utf8"):void 0;function E(l,s,d){var v=s+d;for(d=s;l[d]&&!(d>=v);)++d;if(16<d-s&&l.subarray&&g)return g.decode(l.subarray(s,d));for(v="";s<d;){var _=l[s++];if(_&128){var X=l[s++]&63;if((_&224)==192)v+=String.fromCharCode((_&31)<<6|X);else{var z=l[s++]&63;_=(_&240)==224?(_&15)<<12|X<<6|z:(_&7)<<18|X<<12|z<<6|l[s++]&63,65536>_?v+=String.fromCharCode(_):(_-=65536,v+=String.fromCharCode(55296|_>>10,56320|_&1023))}}else v+=String.fromCharCode(_)}return v}function m(l,s,d){var v=J;if(0<d){d=s+d-1;for(var _=0;_<l.length;++_){var X=l.charCodeAt(_);if(55296<=X&&57343>=X){var z=l.charCodeAt(++_);X=65536+((X&1023)<<10)|z&1023}if(127>=X){if(s>=d)break;v[s++]=X}else{if(2047>=X){if(s+1>=d)break;v[s++]=192|X>>6}else{if(65535>=X){if(s+2>=d)break;v[s++]=224|X>>12}else{if(s+3>=d)break;v[s++]=240|X>>18,v[s++]=128|X>>12&63}v[s++]=128|X>>6&63}v[s++]=128|X&63}}v[s]=0}}var k=typeof TextDecoder<"u"?new TextDecoder("utf-16le"):void 0;function R(l,s){for(var d=l>>1,v=d+s/2;!(d>=v)&&Ie[d];)++d;if(d<<=1,32<d-l&&k)return k.decode(J.subarray(l,d));for(d="",v=0;!(v>=s/2);++v){var _=se[l+2*v>>1];if(_==0)break;d+=String.fromCharCode(_)}return d}function j(l,s,d){if(d===void 0&&(d=2147483647),2>d)return 0;d-=2;var v=s;d=d<2*l.length?d/2:l.length;for(var _=0;_<d;++_)se[s>>1]=l.charCodeAt(_),s+=2;return se[s>>1]=0,s-v}function re(l){return 2*l.length}function le(l,s){for(var d=0,v="";!(d>=s/4);){var _=me[l+4*d>>2];if(_==0)break;++d,65536<=_?(_-=65536,v+=String.fromCharCode(55296|_>>10,56320|_&1023)):v+=String.fromCharCode(_)}return v}function Q(l,s,d){if(d===void 0&&(d=2147483647),4>d)return 0;var v=s;d=v+d-4;for(var _=0;_<l.length;++_){var X=l.charCodeAt(_);if(55296<=X&&57343>=X){var z=l.charCodeAt(++_);X=65536+((X&1023)<<10)|z&1023}if(me[s>>2]=X,s+=4,s+4>d)break}return me[s>>2]=0,s-v}function we(l){for(var s=0,d=0;d<l.length;++d){var v=l.charCodeAt(d);55296<=v&&57343>=v&&++d,s+=4}return s}var De,Se,J,se,Ie,me,de,fe,ye;function Te(){var l=C.buffer;De=l,r.HEAP8=Se=new Int8Array(l),r.HEAP16=se=new Int16Array(l),r.HEAP32=me=new Int32Array(l),r.HEAPU8=J=new Uint8Array(l),r.HEAPU16=Ie=new Uint16Array(l),r.HEAPU32=de=new Uint32Array(l),r.HEAPF32=fe=new Float32Array(l),r.HEAPF64=ye=new Float64Array(l)}var K,f=[],I=[],N=[];function W(){var l=r.preRun.shift();f.unshift(l)}var G=0,H=null;r.preloadedImages={},r.preloadedAudios={};function ue(l){throw r.onAbort&&r.onAbort(l),l="Aborted("+l+")",F(l),w=!0,l=new WebAssembly.RuntimeError(l+". Build with -s ASSERTIONS=1 for more info."),h(l),l}function Ce(){return Ee.startsWith("data:application/octet-stream;base64,")}var Ee;if(Ee="pathkit.wasm",!Ce()){var He=Ee;Ee=r.locateFile?r.locateFile(He,M):M+He}function Fe(){var l=Ee;try{if(l==Ee&&oe)return new Uint8Array(oe);if($)return $(l);throw"both async and sync fetching of the wasm failed"}catch(s){ue(s)}}function Be(){if(!oe&&(O||D)){if(typeof fetch=="function"&&!Ee.startsWith("file://"))return fetch(Ee,{credentials:"same-origin"}).then(function(l){if(!l.ok)throw"failed to load wasm binary file at '"+Ee+"'";return l.arrayBuffer()}).catch(function(){return Fe()});if(T)return new Promise(function(l,s){T(Ee,function(d){l(new Uint8Array(d))},s)})}return Promise.resolve().then(function(){return Fe()})}function Me(l){for(;0<l.length;){var s=l.shift();if(typeof s=="function")s(r);else{var d=s.Wa;typeof d=="number"?s.xa===void 0?K.get(d)():K.get(d)(s.xa):d(s.xa===void 0?null:s.xa)}}}var ve={};function Oe(l){for(;l.length;){var s=l.pop();l.pop()(s)}}function qe(l){return this.fromWireType(de[l>>2])}var ne={},ge={},S={};function B(l){if(l===void 0)return"_unknown";l=l.replace(/[^a-zA-Z0-9_]/g,"$");var s=l.charCodeAt(0);return 48<=s&&57>=s?"_"+l:l}function q(l,s){return l=B(l),function(){return s.apply(this,arguments)}}function ie(l){var s=Error,d=q(l,function(v){this.name=l,this.message=v,v=Error(v).stack,v!==void 0&&(this.stack=this.toString()+`
`+v.replace(/^Error(:[^\n]*)?\n/,""))});return d.prototype=Object.create(s.prototype),d.prototype.constructor=d,d.prototype.toString=function(){return this.message===void 0?this.name:this.name+": "+this.message},d}var ae=void 0;function he(l){throw new ae(l)}function pe(l,s,d){function v(U){U=d(U),U.length!==l.length&&he("Mismatched type converter count");for(var Y=0;Y<l.length;++Y)ut(l[Y],U[Y])}l.forEach(function(U){S[U]=s});var _=Array(s.length),X=[],z=0;s.forEach(function(U,Y){ge.hasOwnProperty(U)?_[Y]=ge[U]:(X.push(U),ne.hasOwnProperty(U)||(ne[U]=[]),ne[U].push(function(){_[Y]=ge[U],++z,z===X.length&&v(_)}))}),X.length===0&&v(_)}var $e={};function be(l){switch(l){case 1:return 0;case 2:return 1;case 4:return 2;case 8:return 3;default:throw new TypeError("Unknown type size: "+l)}}var Ue=void 0;function xe(l){for(var s="";J[l];)s+=Ue[J[l++]];return s}var Ge=void 0;function ke(l){throw new Ge(l)}function ut(l,s,d={}){if(!("argPackAdvance"in s))throw new TypeError("registerType registeredInstance requires argPackAdvance");var v=s.name;if(l||ke('type "'+v+'" must have a positive integer typeid pointer'),ge.hasOwnProperty(l)){if(d.Qa)return;ke("Cannot register type '"+v+"' twice")}ge[l]=s,delete S[l],ne.hasOwnProperty(l)&&(s=ne[l],delete ne[l],s.forEach(function(_){_()}))}function sn(l){ke(l.ea.ha.fa.name+" instance already deleted")}var ln=!1;function Qn(){}function ei(l){--l.count.value,l.count.value===0&&(l.ka?l.ma.la(l.ka):l.ha.fa.la(l.ga))}function kt(l){return typeof FinalizationGroup>"u"?(kt=s=>s,l):(ln=new FinalizationGroup(function(s){for(var d=s.next();!d.done;d=s.next())d=d.value,d.ga?ei(d):console.warn("object already deleted: "+d.ga)}),kt=s=>(ln.register(s,s.ea,s.ea),s),Qn=s=>{ln.unregister(s.ea)},kt(l))}var Dt=void 0,Ct=[];function cn(){for(;Ct.length;){var l=Ct.pop();l.ea.pa=!1,l.delete()}}function mt(){}var ti={};function ni(l,s,d){if(l[s].ia===void 0){var v=l[s];l[s]=function(){return l[s].ia.hasOwnProperty(arguments.length)||ke("Function '"+d+"' called with an invalid number of arguments ("+arguments.length+") - expects one of ("+l[s].ia+")!"),l[s].ia[arguments.length].apply(this,arguments)},l[s].ia=[],l[s].ia[v.ua]=v}}function un(l,s,d){r.hasOwnProperty(l)?((d===void 0||r[l].ia!==void 0&&r[l].ia[d]!==void 0)&&ke("Cannot register public name '"+l+"' twice"),ni(r,l,l),r.hasOwnProperty(d)&&ke("Cannot register multiple overloads of a function with the same number of arguments ("+d+")!"),r[l].ia[d]=s):(r[l]=s,d!==void 0&&(r[l].Xa=d))}function To(l,s,d,v,_,X,z,U){this.name=l,this.constructor=s,this.qa=d,this.la=v,this.na=_,this.Oa=X,this.ta=z,this.La=U,this.Ta=[]}function dn(l,s,d){for(;s!==d;)s.ta||ke("Expected null or instance of "+d.name+", got an instance of "+s.name),l=s.ta(l),s=s.na;return l}function So(l,s){return s===null?(this.Ba&&ke("null is not a valid "+this.name),0):(s.ea||ke('Cannot pass "'+mn(s)+'" as a '+this.name),s.ea.ga||ke("Cannot pass deleted object as a pointer of type "+this.name),dn(s.ea.ga,s.ea.ha.fa,this.fa))}function bo(l,s){if(s===null){if(this.Ba&&ke("null is not a valid "+this.name),this.wa){var d=this.sa();return l!==null&&l.push(this.la,d),d}return 0}if(s.ea||ke('Cannot pass "'+mn(s)+'" as a '+this.name),s.ea.ga||ke("Cannot pass deleted object as a pointer of type "+this.name),!this.va&&s.ea.ha.va&&ke("Cannot convert argument of type "+(s.ea.ma?s.ea.ma.name:s.ea.ha.name)+" to parameter type "+this.name),d=dn(s.ea.ga,s.ea.ha.fa,this.fa),this.wa)switch(s.ea.ka===void 0&&ke("Passing raw pointer to smart pointer is illegal"),this.Va){case 0:s.ea.ma===this?d=s.ea.ka:ke("Cannot convert argument of type "+(s.ea.ma?s.ea.ma.name:s.ea.ha.name)+" to parameter type "+this.name);break;case 1:d=s.ea.ka;break;case 2:if(s.ea.ma===this)d=s.ea.ka;else{var v=s.clone();d=this.Ua(d,yt(function(){v.delete()})),l!==null&&l.push(this.la,d)}break;default:ke("Unsupporting sharing policy")}return d}function No(l,s){return s===null?(this.Ba&&ke("null is not a valid "+this.name),0):(s.ea||ke('Cannot pass "'+mn(s)+'" as a '+this.name),s.ea.ga||ke("Cannot pass deleted object as a pointer of type "+this.name),s.ea.ha.va&&ke("Cannot convert argument of type "+s.ea.ha.name+" to parameter type "+this.name),dn(s.ea.ga,s.ea.ha.fa,this.fa))}function ii(l,s,d){return s===d?l:d.na===void 0?null:(l=ii(l,s,d.na),l===null?null:d.La(l))}var xt={};function Oo(l,s){for(s===void 0&&ke("ptr should not be undefined");l.na;)s=l.ta(s),l=l.na;return xt[s]}function $t(l,s){return s.ha&&s.ga||he("makeClassHandle requires ptr and ptrType"),!!s.ma!=!!s.ka&&he("Both smartPtrType and smartPtr must be specified"),s.count={value:1},kt(Object.create(l,{ea:{value:s}}))}function ft(l,s,d,v){this.name=l,this.fa=s,this.Ba=d,this.va=v,this.wa=!1,this.la=this.Ua=this.sa=this.Ia=this.Va=this.Sa=void 0,s.na!==void 0?this.toWireType=bo:(this.toWireType=v?So:No,this.ja=null)}function oi(l,s,d){r.hasOwnProperty(l)||he("Replacing nonexistant public symbol"),r[l].ia!==void 0&&d!==void 0?r[l].ia[d]=s:(r[l]=s,r[l].ua=d)}function ko(l,s){var d=[];return function(){d.length=arguments.length;for(var v=0;v<arguments.length;v++)d[v]=arguments[v];return l.includes("j")?(v=r["dynCall_"+l],v=d&&d.length?v.apply(null,[s].concat(d)):v.call(null,s)):v=K.get(s).apply(null,d),v}}function Ye(l,s){l=xe(l);var d=l.includes("j")?ko(l,s):K.get(s);return typeof d!="function"&&ke("unknown function pointer with signature "+l+": "+s),d}var ri=void 0;function ai(l){l=fi(l);var s=xe(l);return ht(l),s}function Pt(l,s){function d(X){_[X]||ge[X]||(S[X]?S[X].forEach(d):(v.push(X),_[X]=!0))}var v=[],_={};throw s.forEach(d),new ri(l+": "+v.map(ai).join([", "]))}function fn(l,s){for(var d=[],v=0;v<l;v++)d.push(me[(s>>2)+v]);return d}function hn(l,s,d,v,_){var X=s.length;2>X&&ke("argTypes array size mismatch! Must at least get return value and 'this' types!");var z=s[1]!==null&&d!==null,U=!1;for(d=1;d<s.length;++d)if(s[d]!==null&&s[d].ja===void 0){U=!0;break}var Y=s[0].name!=="void",ee=X-2,te=Array(ee),ce=[],_e=[];return function(){if(arguments.length!==ee&&ke("function "+l+" called with "+arguments.length+" arguments, expected "+ee+" args!"),_e.length=0,ce.length=z?2:1,ce[0]=_,z){var Re=s[1].toWireType(_e,this);ce[1]=Re}for(var Ae=0;Ae<ee;++Ae)te[Ae]=s[Ae+2].toWireType(_e,arguments[Ae]),ce.push(te[Ae]);if(Ae=v.apply(null,ce),U)Oe(_e);else for(var Ze=z?1:2;Ze<s.length;Ze++){var Je=Ze===1?Re:te[Ze-2];s[Ze].ja!==null&&s[Ze].ja(Je)}return Re=Y?s[0].fromWireType(Ae):void 0,Re}}var pn=[],lt=[{},{value:void 0},{value:null},{value:!0},{value:!1}];function si(l){4<l&&--lt[l].Ca===0&&(lt[l]=void 0,pn.push(l))}function gn(l){return l||ke("Cannot use deleted val. handle = "+l),lt[l].value}function yt(l){switch(l){case void 0:return 1;case null:return 2;case!0:return 3;case!1:return 4;default:var s=pn.length?pn.pop():lt.length;return lt[s]={Ca:1,value:l},s}}function Do(l,s,d){switch(s){case 0:return function(v){return this.fromWireType((d?Se:J)[v])};case 1:return function(v){return this.fromWireType((d?se:Ie)[v>>1])};case 2:return function(v){return this.fromWireType((d?me:de)[v>>2])};default:throw new TypeError("Unknown integer type: "+l)}}function Lt(l,s){var d=ge[l];return d===void 0&&ke(s+" has unknown type "+ai(l)),d}function mn(l){if(l===null)return"null";var s=typeof l;return s==="object"||s==="array"||s==="function"?l.toString():""+l}function Co(l,s){switch(s){case 2:return function(d){return this.fromWireType(fe[d>>2])};case 3:return function(d){return this.fromWireType(ye[d>>3])};default:throw new TypeError("Unknown float type: "+l)}}function xo(l,s,d){switch(s){case 0:return d?function(v){return Se[v]}:function(v){return J[v]};case 1:return d?function(v){return se[v>>1]}:function(v){return Ie[v>>1]};case 2:return d?function(v){return me[v>>2]}:function(v){return de[v>>2]};default:throw new TypeError("Unknown integer type: "+l)}}var _o={};function yn(l){var s=_o[l];return s===void 0?xe(l):s}var vn=[];function li(){function l(s){s.$$$embind_global$$$=s;var d=typeof $$$embind_global$$$=="object"&&s.$$$embind_global$$$===s;return d||delete s.$$$embind_global$$$,d}if(typeof globalThis=="object")return globalThis;if(typeof $$$embind_global$$$=="object"||(typeof wn=="object"&&l(wn)?$$$embind_global$$$=wn:typeof self=="object"&&l(self)&&($$$embind_global$$$=self),typeof $$$embind_global$$$=="object"))return $$$embind_global$$$;throw Error("unable to get global object.")}function Ao(l){var s=vn.length;return vn.push(l),s}function Mo(l,s){for(var d=Array(l),v=0;v<l;++v)d[v]=Lt(me[(s>>2)+v],"parameter "+v);return d}var ci=[];function $o(l){var s=Array(l+1);return function(d,v,_){s[0]=d;for(var X=0;X<l;++X){var z=Lt(me[(v>>2)+X],"parameter "+X);s[X+1]=z.readValueFromPointer(_),_+=z.argPackAdvance}return d=new(d.bind.apply(d,s)),yt(d)}}var ui={},Po=[null,[],[]];ae=r.InternalError=ie("InternalError");for(var di=Array(256),Rt=0;256>Rt;++Rt)di[Rt]=String.fromCharCode(Rt);Ue=di,Ge=r.BindingError=ie("BindingError"),mt.prototype.isAliasOf=function(l){if(!(this instanceof mt&&l instanceof mt))return!1;var s=this.ea.ha.fa,d=this.ea.ga,v=l.ea.ha.fa;for(l=l.ea.ga;s.na;)d=s.ta(d),s=s.na;for(;v.na;)l=v.ta(l),v=v.na;return s===v&&d===l},mt.prototype.clone=function(){if(this.ea.ga||sn(this),this.ea.ra)return this.ea.count.value+=1,this;var l=kt,s=Object,d=s.create,v=Object.getPrototypeOf(this),_=this.ea;return l=l(d.call(s,v,{ea:{value:{count:_.count,pa:_.pa,ra:_.ra,ga:_.ga,ha:_.ha,ka:_.ka,ma:_.ma}}})),l.ea.count.value+=1,l.ea.pa=!1,l},mt.prototype.delete=function(){this.ea.ga||sn(this),this.ea.pa&&!this.ea.ra&&ke("Object already scheduled for deletion"),Qn(this),ei(this.ea),this.ea.ra||(this.ea.ka=void 0,this.ea.ga=void 0)},mt.prototype.isDeleted=function(){return!this.ea.ga},mt.prototype.deleteLater=function(){return this.ea.ga||sn(this),this.ea.pa&&!this.ea.ra&&ke("Object already scheduled for deletion"),Ct.push(this),Ct.length===1&&Dt&&Dt(cn),this.ea.pa=!0,this},ft.prototype.Pa=function(l){return this.Ia&&(l=this.Ia(l)),l},ft.prototype.Ga=function(l){this.la&&this.la(l)},ft.prototype.argPackAdvance=8,ft.prototype.readValueFromPointer=qe,ft.prototype.deleteObject=function(l){l!==null&&l.delete()},ft.prototype.fromWireType=function(l){function s(){return this.wa?$t(this.fa.qa,{ha:this.Sa,ga:d,ma:this,ka:l}):$t(this.fa.qa,{ha:this,ga:l})}var d=this.Pa(l);if(!d)return this.Ga(l),null;var v=Oo(this.fa,d);if(v!==void 0)return v.ea.count.value===0?(v.ea.ga=d,v.ea.ka=l,v.clone()):(v=v.clone(),this.Ga(l),v);if(v=this.fa.Oa(d),v=ti[v],!v)return s.call(this);v=this.va?v.Ja:v.pointerType;var _=ii(d,this.fa,v.fa);return _===null?s.call(this):this.wa?$t(v.fa.qa,{ha:v,ga:_,ma:this,ka:l}):$t(v.fa.qa,{ha:v,ga:_})},r.getInheritedInstanceCount=function(){return Object.keys(xt).length},r.getLiveInheritedInstances=function(){var l=[],s;for(s in xt)xt.hasOwnProperty(s)&&l.push(xt[s]);return l},r.flushPendingDeletes=cn,r.setDelayFunction=function(l){Dt=l,Ct.length&&Dt&&Dt(cn)},ri=r.UnboundTypeError=ie("UnboundTypeError"),r.count_emval_handles=function(){for(var l=0,s=5;s<lt.length;++s)lt[s]!==void 0&&++l;return l},r.get_first_emval=function(){for(var l=5;l<lt.length;++l)if(lt[l]!==void 0)return lt[l];return null};var Lo={r:function(l){var s=ve[l];delete ve[l];var d=s.elements,v=d.length,_=d.map(function(U){return U.Aa}).concat(d.map(function(U){return U.Ea})),X=s.sa,z=s.la;pe([l],_,function(U){return d.forEach(function(Y,ee){var te=U[ee],ce=Y.ya,_e=Y.za,Re=U[ee+v],Ae=Y.Da,Ze=Y.Fa;Y.read=Je=>te.fromWireType(ce(_e,Je)),Y.write=(Je,Et)=>{var at=[];Ae(Ze,Je,Re.toWireType(at,Et)),Oe(at)}}),[{name:s.name,fromWireType:function(Y){for(var ee=Array(v),te=0;te<v;++te)ee[te]=d[te].read(Y);return z(Y),ee},toWireType:function(Y,ee){if(v!==ee.length)throw new TypeError("Incorrect number of tuple elements for "+s.name+": expected="+v+", actual="+ee.length);for(var te=X(),ce=0;ce<v;++ce)d[ce].write(te,ee[ce]);return Y!==null&&Y.push(z,te),te},argPackAdvance:8,readValueFromPointer:qe,ja:z}]})},u:function(l){var s=$e[l];delete $e[l];var d=s.sa,v=s.la,_=s.Ha,X=_.map(function(z){return z.Aa}).concat(_.map(function(z){return z.Ea}));pe([l],X,function(z){var U={};return _.forEach(function(Y,ee){var te=z[ee],ce=Y.ya,_e=Y.za,Re=z[ee+_.length],Ae=Y.Da,Ze=Y.Fa;U[Y.Na]={read:function(Je){return te.fromWireType(ce(_e,Je))},write:function(Je,Et){var at=[];Ae(Ze,Je,Re.toWireType(at,Et)),Oe(at)}}}),[{name:s.name,fromWireType:function(Y){var ee={},te;for(te in U)ee[te]=U[te].read(Y);return v(Y),ee},toWireType:function(Y,ee){for(var te in U)if(!(te in ee))throw new TypeError('Missing field:  "'+te+'"');var ce=d();for(te in U)U[te].write(ce,ee[te]);return Y!==null&&Y.push(v,ce),ce},argPackAdvance:8,readValueFromPointer:qe,ja:v}]})},z:function(){},F:function(l,s,d,v,_){var X=be(d);s=xe(s),ut(l,{name:s,fromWireType:function(z){return!!z},toWireType:function(z,U){return U?v:_},argPackAdvance:8,readValueFromPointer:function(z){if(d===1)var U=Se;else if(d===2)U=se;else if(d===4)U=me;else throw new TypeError("Unknown boolean type size: "+s);return this.fromWireType(U[z>>X])},ja:null})},l:function(l,s,d,v,_,X,z,U,Y,ee,te,ce,_e){te=xe(te),X=Ye(_,X),U&&(U=Ye(z,U)),ee&&(ee=Ye(Y,ee)),_e=Ye(ce,_e);var Re=B(te);un(Re,function(){Pt("Cannot construct "+te+" due to unbound types",[v])}),pe([l,s,d],v?[v]:[],function(Ae){if(Ae=Ae[0],v)var Ze=Ae.fa,Je=Ze.qa;else Je=mt.prototype;Ae=q(Re,function(){if(Object.getPrototypeOf(this)!==Et)throw new Ge("Use 'new' to construct "+te);if(at.oa===void 0)throw new Ge(te+" has no accessible constructor");var pi=at.oa[arguments.length];if(pi===void 0)throw new Ge("Tried to invoke ctor of "+te+" with invalid number of parameters ("+arguments.length+") - expected ("+Object.keys(at.oa).toString()+") parameters instead!");return pi.apply(this,arguments)});var Et=Object.create(Je,{constructor:{value:Ae}});Ae.prototype=Et;var at=new To(te,Ae,Et,_e,Ze,X,U,ee);Ze=new ft(te,at,!0,!1),Je=new ft(te+"*",at,!1,!1);var hi=new ft(te+" const*",at,!1,!0);return ti[l]={pointerType:Je,Ja:hi},oi(Re,Ae),[Ze,Je,hi]})},i:function(l,s,d,v,_,X){0<s||ue(void 0);var z=fn(s,d);_=Ye(v,_),pe([],[l],function(U){U=U[0];var Y="constructor "+U.name;if(U.fa.oa===void 0&&(U.fa.oa=[]),U.fa.oa[s-1]!==void 0)throw new Ge("Cannot register multiple constructors with identical number of parameters ("+(s-1)+") for class '"+U.name+"'! Overload resolution is currently only performed using the parameter count, not actual type info!");return U.fa.oa[s-1]=()=>{Pt("Cannot construct "+U.name+" due to unbound types",z)},pe([],z,function(ee){return ee.splice(1,0,null),U.fa.oa[s-1]=hn(Y,ee,null,_,X),[]}),[]})},a:function(l,s,d,v,_,X,z,U){var Y=fn(d,v);s=xe(s),X=Ye(_,X),pe([],[l],function(ee){function te(){Pt("Cannot call "+ce+" due to unbound types",Y)}ee=ee[0];var ce=ee.name+"."+s;s.startsWith("@@")&&(s=Symbol[s.substring(2)]),U&&ee.fa.Ta.push(s);var _e=ee.fa.qa,Re=_e[s];return Re===void 0||Re.ia===void 0&&Re.className!==ee.name&&Re.ua===d-2?(te.ua=d-2,te.className=ee.name,_e[s]=te):(ni(_e,s,ce),_e[s].ia[d-2]=te),pe([],Y,function(Ae){return Ae=hn(ce,Ae,ee,X,z),_e[s].ia===void 0?(Ae.ua=d-2,_e[s]=Ae):_e[s].ia[d-2]=Ae,[]}),[]})},I:function(l,s,d){l=xe(l),pe([],[s],function(v){return v=v[0],r[l]=v.fromWireType(d),[]})},E:function(l,s){s=xe(s),ut(l,{name:s,fromWireType:function(d){var v=gn(d);return si(d),v},toWireType:function(d,v){return yt(v)},argPackAdvance:8,readValueFromPointer:qe,ja:null})},h:function(l,s,d,v){function _(){}d=be(d),s=xe(s),_.values={},ut(l,{name:s,constructor:_,fromWireType:function(X){return this.constructor.values[X]},toWireType:function(X,z){return z.value},argPackAdvance:8,readValueFromPointer:Do(s,d,v),ja:null}),un(s,_)},k:function(l,s,d){var v=Lt(l,"enum");s=xe(s),l=v.constructor,v=Object.create(v.constructor.prototype,{value:{value:d},constructor:{value:q(v.name+"_"+s,function(){})}}),l.values[d]=v,l[s]=v},q:function(l,s,d){d=be(d),s=xe(s),ut(l,{name:s,fromWireType:function(v){return v},toWireType:function(v,_){return _},argPackAdvance:8,readValueFromPointer:Co(s,d),ja:null})},f:function(l,s,d,v,_,X){var z=fn(s,d);l=xe(l),_=Ye(v,_),un(l,function(){Pt("Cannot call "+l+" due to unbound types",z)},s-1),pe([],z,function(U){return U=[U[0],null].concat(U.slice(1)),oi(l,hn(l,U,null,_,X),s-1),[]})},e:function(l,s,d,v,_){s=xe(s),_===-1&&(_=4294967295),_=be(d);var X=U=>U;if(v===0){var z=32-8*d;X=U=>U<<z>>>z}d=s.includes("unsigned")?function(U,Y){return Y>>>0}:function(U,Y){return Y},ut(l,{name:s,fromWireType:X,toWireType:d,argPackAdvance:8,readValueFromPointer:xo(s,_,v!==0),ja:null})},b:function(l,s,d){function v(X){X>>=2;var z=de;return new _(De,z[X+1],z[X])}var _=[Int8Array,Uint8Array,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array][s];d=xe(d),ut(l,{name:d,fromWireType:v,argPackAdvance:8,readValueFromPointer:v},{Qa:!0})},p:function(l,s){s=xe(s);var d=s==="std::string";ut(l,{name:s,fromWireType:function(v){var _=de[v>>2];if(d)for(var X=v+4,z=0;z<=_;++z){var U=v+4+z;if(z==_||J[U]==0){if(X=X?E(J,X,U-X):"",Y===void 0)var Y=X;else Y+=String.fromCharCode(0),Y+=X;X=U+1}}else{for(Y=Array(_),z=0;z<_;++z)Y[z]=String.fromCharCode(J[v+4+z]);Y=Y.join("")}return ht(v),Y},toWireType:function(v,_){_ instanceof ArrayBuffer&&(_=new Uint8Array(_));var X=typeof _=="string";X||_ instanceof Uint8Array||_ instanceof Uint8ClampedArray||_ instanceof Int8Array||ke("Cannot pass non-string to std::string");var z=(d&&X?()=>{for(var ee=0,te=0;te<_.length;++te){var ce=_.charCodeAt(te);55296<=ce&&57343>=ce&&(ce=65536+((ce&1023)<<10)|_.charCodeAt(++te)&1023),127>=ce?++ee:ee=2047>=ce?ee+2:65535>=ce?ee+3:ee+4}return ee}:()=>_.length)(),U=En(4+z+1);if(de[U>>2]=z,d&&X)m(_,U+4,z+1);else if(X)for(X=0;X<z;++X){var Y=_.charCodeAt(X);255<Y&&(ht(U),ke("String has UTF-16 code units that do not fit in 8 bits")),J[U+4+X]=Y}else for(X=0;X<z;++X)J[U+4+X]=_[X];return v!==null&&v.push(ht,U),U},argPackAdvance:8,readValueFromPointer:qe,ja:function(v){ht(v)}})},m:function(l,s,d){if(d=xe(d),s===2)var v=R,_=j,X=re,z=()=>Ie,U=1;else s===4&&(v=le,_=Q,X=we,z=()=>de,U=2);ut(l,{name:d,fromWireType:function(Y){for(var ee=de[Y>>2],te=z(),ce,_e=Y+4,Re=0;Re<=ee;++Re){var Ae=Y+4+Re*s;(Re==ee||te[Ae>>U]==0)&&(_e=v(_e,Ae-_e),ce===void 0?ce=_e:(ce+=String.fromCharCode(0),ce+=_e),_e=Ae+s)}return ht(Y),ce},toWireType:function(Y,ee){typeof ee!="string"&&ke("Cannot pass non-string to C++ string type "+d);var te=X(ee),ce=En(4+te+s);return de[ce>>2]=te>>U,_(ee,ce+4,te+s),Y!==null&&Y.push(ht,ce),ce},argPackAdvance:8,readValueFromPointer:qe,ja:function(Y){ht(Y)}})},t:function(l,s,d,v,_,X){ve[l]={name:xe(s),sa:Ye(d,v),la:Ye(_,X),elements:[]}},s:function(l,s,d,v,_,X,z,U,Y){ve[l].elements.push({Aa:s,ya:Ye(d,v),za:_,Ea:X,Da:Ye(z,U),Fa:Y})},v:function(l,s,d,v,_,X){$e[l]={name:xe(s),sa:Ye(d,v),la:Ye(_,X),Ha:[]}},j:function(l,s,d,v,_,X,z,U,Y,ee){$e[l].Ha.push({Na:xe(s),Aa:d,ya:Ye(v,_),za:X,Ea:z,Da:Ye(U,Y),Fa:ee})},G:function(l,s){s=xe(s),ut(l,{Ra:!0,name:s,argPackAdvance:0,fromWireType:function(){},toWireType:function(){}})},d:function(l,s,d,v){l=vn[l],s=gn(s),d=yn(d),l(s,d,null,v)},J:si,x:function(l){return l===0?yt(li()):(l=yn(l),yt(li()[l]))},c:function(l,s){var d=Mo(l,s),v=d[0];s=v.name+"_$"+d.slice(1).map(function(z){return z.name}).join("_")+"$";var _=ci[s];if(_!==void 0)return _;var X=Array(l-1);return _=Ao((z,U,Y,ee)=>{for(var te=0,ce=0;ce<l-1;++ce)X[ce]=d[ce+1].readValueFromPointer(ee+te),te+=d[ce+1].argPackAdvance;for(z=z[U].apply(z,X),ce=0;ce<l-1;++ce)d[ce+1].Ka&&d[ce+1].Ka(X[ce]);if(!v.Ra)return v.toWireType(Y,z)}),ci[s]=_},n:function(l){4<l&&(lt[l].Ca+=1)},w:function(l,s,d,v){l=gn(l);var _=ui[s];return _||(_=$o(s),ui[s]=_),_(l,d,v)},K:function(){return yt([])},D:function(l){return yt(yn(l))},H:function(l,s){return l=Lt(l,"_emval_take_value"),l=l.readValueFromPointer(s),yt(l)},g:function(){ue("")},B:function(l){var s=J.length;if(l>>>=0,2147483648<l)return!1;for(var d=1;4>=d;d*=2){var v=s*(1+.2/d);v=Math.min(v,l+100663296),v=Math.max(l,v),0<v%65536&&(v+=65536-v%65536);e:{try{C.grow(Math.min(2147483648,v)-De.byteLength+65535>>>16),Te();var _=1;break e}catch{}_=void 0}if(_)return!0}return!1},C:function(){return 0},y:function(){},o:function(l,s,d,v){for(var _=0,X=0;X<d;X++){var z=me[s>>2],U=me[s+4>>2];s+=8;for(var Y=0;Y<U;Y++){var ee=J[z+Y],te=Po[l];ee===0||ee===10?((l===1?V:F)(E(te,0)),te.length=0):te.push(ee)}_+=U}return me[v>>2]=_,0},A:function(){}};(function(){function l(_){r.asm=_.exports,C=r.asm.L,Te(),K=r.asm._,I.unshift(r.asm.M),G--,r.monitorRunDependencies&&r.monitorRunDependencies(G),G==0&&H&&(_=H,H=null,_())}function s(_){l(_.instance)}function d(_){return Be().then(function(X){return WebAssembly.instantiate(X,v)}).then(function(X){return X}).then(_,function(X){F("failed to asynchronously prepare wasm: "+X),ue(X)})}var v={a:Lo};if(G++,r.monitorRunDependencies&&r.monitorRunDependencies(G),r.instantiateWasm)try{return r.instantiateWasm(v,l)}catch(_){return F("Module.instantiateWasm callback failed with error: "+_),!1}return function(){return oe||typeof WebAssembly.instantiateStreaming!="function"||Ce()||Ee.startsWith("file://")||typeof fetch!="function"?d(s):fetch(Ee,{credentials:"same-origin"}).then(function(_){return WebAssembly.instantiateStreaming(_,v).then(s,function(X){return F("wasm streaming compile failed: "+X),F("falling back to ArrayBuffer instantiation"),d(s)})})}().catch(h),{}})(),r.___wasm_call_ctors=function(){return(r.___wasm_call_ctors=r.asm.M).apply(null,arguments)},r.__Z6ToCmdsRK6SkPath=function(){return(r.__Z6ToCmdsRK6SkPath=r.asm.N).apply(null,arguments)},r.__Z8FromCmdsmi=function(){return(r.__Z8FromCmdsmi=r.asm.O).apply(null,arguments)},r.__Z7NewPathv=function(){return(r.__Z7NewPathv=r.asm.P).apply(null,arguments)},r.__Z8CopyPathRK6SkPath=function(){return(r.__Z8CopyPathRK6SkPath=r.asm.Q).apply(null,arguments)},r.__Z6EqualsRK6SkPathS1_=function(){return(r.__Z6EqualsRK6SkPathS1_=r.asm.R).apply(null,arguments)},r.__Z11ToSVGStringRK6SkPath=function(){return(r.__Z11ToSVGStringRK6SkPath=r.asm.S).apply(null,arguments)},r.__Z13FromSVGStringNSt3__212basic_stringIcNS_11char_traitsIcEENS_9allocatorIcEEEE=function(){return(r.__Z13FromSVGStringNSt3__212basic_stringIcNS_11char_traitsIcEENS_9allocatorIcEEEE=r.asm.T).apply(null,arguments)},r.__Z13ApplySimplifyR6SkPath=function(){return(r.__Z13ApplySimplifyR6SkPath=r.asm.U).apply(null,arguments)},r.__Z11ApplyPathOpR6SkPathRKS_8SkPathOp=function(){return(r.__Z11ApplyPathOpR6SkPathRKS_8SkPathOp=r.asm.V).apply(null,arguments)},r.__Z10MakeFromOpRK6SkPathS1_8SkPathOp=function(){return(r.__Z10MakeFromOpRK6SkPathS1_8SkPathOp=r.asm.W).apply(null,arguments)},r.__Z14ResolveBuilderR11SkOpBuilder=function(){return(r.__Z14ResolveBuilderR11SkOpBuilder=r.asm.X).apply(null,arguments)},r.__Z8ToCanvasRK6SkPathN10emscripten3valE=function(){return(r.__Z8ToCanvasRK6SkPathN10emscripten3valE=r.asm.Y).apply(null,arguments)},r.__Z8ToPath2DRK6SkPath=function(){return(r.__Z8ToPath2DRK6SkPath=r.asm.Z).apply(null,arguments)};var ht=r._free=function(){return(ht=r._free=r.asm.$).apply(null,arguments)},En=r._malloc=function(){return(En=r._malloc=r.asm.aa).apply(null,arguments)},fi=r.___getTypeName=function(){return(fi=r.___getTypeName=r.asm.ba).apply(null,arguments)};r.___embind_register_native_and_builtin_types=function(){return(r.___embind_register_native_and_builtin_types=r.asm.ca).apply(null,arguments)},r.dynCall_jiji=function(){return(r.dynCall_jiji=r.asm.da).apply(null,arguments)};var Xt;H=function l(){Xt||In(),Xt||(H=l)};function In(){function l(){if(!Xt&&(Xt=!0,r.calledRun=!0,!w)){if(Me(I),u(r),r.onRuntimeInitialized&&r.onRuntimeInitialized(),r.postRun)for(typeof r.postRun=="function"&&(r.postRun=[r.postRun]);r.postRun.length;){var s=r.postRun.shift();N.unshift(s)}Me(N)}}if(!(0<G)){if(r.preRun)for(typeof r.preRun=="function"&&(r.preRun=[r.preRun]);r.preRun.length;)W();Me(f),0<G||(r.setStatus?(r.setStatus("Running..."),setTimeout(function(){setTimeout(function(){r.setStatus("")},1),l()},1)):l())}}if(r.run=In,r.preInit)for(typeof r.preInit=="function"&&(r.preInit=[r.preInit]);0<r.preInit.length;)r.preInit.pop()();return In(),o.ready}})();n.exports=t})(eo);var aa=eo.exports;const sa=Wn(aa),la="/assets/pathkit-1356ccfa.wasm";class Cn{startTime;accumulatedTime;constructor(){this.startTime=-1,this.accumulatedTime=-1}start(){this.startTime=performance.now(),this.accumulatedTime=0}resume(){this.startTime=performance.now()}pause(){return this.accumulatedTime+=performance.now()-this.startTime,this.startTime=-1,this.accumulatedTime}stop(){if(this.startTime!=-1){const e=performance.now()-this.startTime+this.accumulatedTime;return this.accumulatedTime=0,e}else{const e=this.accumulatedTime;return this.accumulatedTime=0,e}}}class ca{activated;constructor(e){this.activated=e}async BlueTokenBoundingPath(e){if(this.activated){const t=gt().strokeColor("#0000ff").locked(!0).fillOpacity(1).commands(e.toCmds()).metadata({[`${c.EXTENSIONID}/debug`]:!0}).build();await b.scene.local.addItems([t])}}async RedIntersectionPath(e){if(this.activated){const t=gt().fillRule("evenodd").locked(!0).strokeColor("#ff0000").fillOpacity(0).commands(e.toCmds()).metadata({[`${c.EXTENSIONID}/debug`]:!0}).build();await b.scene.local.addItems([t])}}async GreenDebugPath(e){if(this.activated){const t=gt().commands(e.toCmds()).locked(!0).visible(e.visible).fillColor("#555500").fillOpacity(.3).strokeColor("#00FF00").layer("DRAWING").metadata({[`${c.EXTENSIONID}/debug`]:!0}).build();await b.scene.local.addItems([t])}}async DebugBlobINeverUse(){this.activated}}const Vt=new ca(!1);function Ht(n,e){return(n.x-e.x)*(n.x-e.x)+(n.y-e.y)*(n.y-e.y)}function to(n,e){return n.x==e.x&&n.y==e.y}function Ut(n,e,t){return t===void 0&&(t=.01),Math.abs(n-e)<=t}function xn(n,e){return(n%e+e)%e}function ua(n,e){return ze.pointInPolygon(n[0],e)||ze.pointInPolygon(n[0],e)?!0:Gt(n,[e[0],e[1]])||Gt(n,[e[1],e[2]])||Gt(n,[e[2],e[3]])||Gt(n,[e[3],e[0]])}function Gt(n,e){const t=(n[1].x-n[0].x)*(e[1].y-e[0].y)-(e[1].x-e[0].x)*(n[1].y-n[0].y),i=((e[1].y-e[0].y)*(e[1].x-n[0].x)+(e[0].x-e[1].x)*(e[1].y-n[0].y))/t,o=((n[0].y-n[1].y)*(e[1].x-n[0].x)+(n[1].x-n[0].x)*(e[1].y-n[0].y))/t;return i>=0&&i<=1&&o>=0&&o<=1}function Wt(n,e,t){return{x:n.x+e*Math.cos(t),y:n.y+e*Math.sin(t)}}function da(n,e,t,i){const o=Math.atan2(n.y-t.y,n.x-t.x);let r=Wt(n,e,o+Math.PI/2),a=Wt(n,e,o-Math.PI/2),u=Wt(t,i,o+Math.PI/2),h=Wt(t,i,o-Math.PI/2);const y=ze.normalize(ze.subtract(n,t));return r=ze.add(r,ze.multiply(y,e)),a=ze.add(a,ze.multiply(y,e)),u=ze.add(u,ze.multiply(y,0-i)),h=ze.add(h,ze.multiply(y,0-i)),[r,a,h,u]}function fa(n){return n.filter(e=>e.points&&e.points.length>1).flatMap(e=>{const t=je.fromItem(e);return e.points.slice(0,-1).map((i,o)=>{const r=je.fromPosition(e.points[o]),a=je.fromPosition(e.points[o+1]),u=je.decompose(je.multiply(t,r)).position,h=je.decompose(je.multiply(t,a)).position;return{startPosition:u,endPosition:h,originalShape:e,oneSided:e.metadata[`${c.EXTENSIONID}/oneSided`]}})})}function ha(n,e,t,i,o,r){const a=parseInt(p.sceneMetadata[`${c.EXTENSIONID}/defaultMELDepth`]??"0");let u=[],h=[t,i];const y=p.sceneMetadata[`${c.EXTENSIONID}/elevationMapping`]??[],O=[{x:(t+o[0])*r[0],y:o[1]*r[1]},{x:(t+o[0])*r[0],y:(i+o[1])*r[1]},{x:o[0]*r[0],y:(i+o[1])*r[1]},{x:o[0]*r[0],y:o[1]*r[1]}],D=p.gridDpi,M=c.EXTENSIONID,A=e.some(St);if(e.length===0)return u;for(const F of e){const oe=p.playerId===F.createdUserId,w=p.sceneMetadata[`${c.EXTENSIONID}/USER-${F.createdUserId}`]?.role==="GM";let g;for(const j of y){const re=vi(F.position,j.Points);re&&re&&(g===void 0||j.Depth>g)&&(g=j.Depth)}if(g===void 0&&(g=a),!oe&&p.playerRole!=="GM"&&!w)continue;const E=F.metadata[`${M}/visionRange`],m=p.playerShadowCache.getValue(F.id);if(u.push([]),m!==void 0&&to(m.player.position,F.position)&&m.player.metadata[`${M}/visionRange`]===E)continue;let k=D*1e3;E&&(k=D*(E/p.gridScale+.5));const R=[];if(A&&!St(F)){for(const j of e)if(St(j)){const re=j.metadata[`${c.EXTENSIONID}/visionRange`];let le=1e3*p.gridDpi;re&&(le=p.gridDpi*(re/p.gridScale+.5));const Q=da(F.position,k,j.position,le);R.push(Q)}}for(const j of n){let re;for(const H of y){const ue=vi(j.startPosition,H.Points);ue&&ue&&(re===void 0||H.Depth>g)&&(re=H.Depth)}if(re===void 0&&(re=a),g>re)continue;const le=(F.position.x-j.startPosition.x)*(j.endPosition.y-j.startPosition.y)-(F.position.y-j.startPosition.y)*(j.endPosition.x-j.startPosition.x);if(j.oneSided!==void 0&&(j.oneSided==="right"&&le>0||j.oneSided==="left"&&le<0))continue;let Q=j.startPosition.x,we=j.startPosition.y,De=j.endPosition.x,Se=j.endPosition.y;(Q<o[0]||we<o[1]||Q>o[0]+h[0]||we>o[1]+h[1]||De<o[0]||Se<o[1]||De>o[0]+h[0]||Se>o[1]+h[1])&&(Q=Math.max(o[0],Math.min(Q,o[0]+h[0])),we=Math.max(o[1],Math.min(we,o[1]+h[1])),j.startPosition=$i(j,o,h).startPosition,j.endPosition=$i(j,o,h).endPosition);const J=[j.startPosition,j.endPosition],se=ze.distance(j.startPosition,j.endPosition),me=Math.floor(se/(k/3));for(let H=1;H<me;H++)J.push(ze.lerp(j.startPosition,j.endPosition,H/me));let de=!0;for(const H of J)if(ze.compare(F.position,H,k*1.05)){de=!1;break}if(de&&A&&!St(F)){for(const H of R)if(ua([j.startPosition,j.endPosition],H)){de=!1;break}}if(de)continue;const fe={x:j.startPosition.x-F.position.x,y:j.startPosition.y-F.position.y},ye={x:j.endPosition.x-F.position.x,y:j.endPosition.y-F.position.y};var T={x:0,y:0},$={x:0,y:0},x=0,L=0,P=0,V=0;fe.x<0?x=o[0]*r[0]:x=(t+o[0])*r[0],fe.y<0?L=o[1]*r[1]:L=(i+o[1])*r[1],ye.x<0?P=o[0]*r[0]:P=(t+o[0])*r[0],ye.y<0?V=o[1]*r[1]:V=(i+o[1])*r[1];const Te=[],K=[];if(fe.x!=0){const H=fe.y/fe.x,ue=j.startPosition.y-H*j.startPosition.x;Te.push({x,y:H*x+ue})}if(fe.y!=0){const H=fe.x/fe.y,ue=H*j.startPosition.y-j.startPosition.x;Te.push({x:H*L-ue,y:L})}if(ye.x!=0){const H=ye.y/ye.x,ue=j.endPosition.y-H*j.endPosition.x;K.push({x:P,y:H*P+ue})}if(ye.y!=0){const H=ye.x/ye.y,ue=H*j.endPosition.y-j.endPosition.x;K.push({x:H*V-ue,y:V})}if(Te.length===0||K.length===0)continue;Te.length==1||Ht(Te[0],j.startPosition)<Ht(Te[1],j.startPosition)?T=Te[0]:T=Te[1],K.length==1||Ht(K[0],j.endPosition)<Ht(K[1],j.endPosition)?$=K[0]:$=K[1];const f=[{x:j.startPosition.x,y:j.startPosition.y},T,$,{x:j.endPosition.x,y:j.endPosition.y}],I=[0,0];let N=0;for(const H of[T,$])Ut(H.y,o[1]*r[1])?I[N]=0:Ut(H.y,(i+o[1])*r[1])?I[N]=2:Ut(H.x,o[0]*r[0])?I[N]=3:Ut(H.x,(t+o[0])*r[0])&&(I[N]=1),N++;let W=Math.sign(le);W=W==0?1:-W;const G=W==1?I[1]:xn(I[1]-1,4);for(let H=I[0]+(W==1?0:-1);xn(H,4)!=G;H+=W)f.splice(f.length-2,0,O[xn(H,4)]);u[u.length-1].push({pointset:f,fromShape:j.originalShape})}}return u}function $i(n,e,t){let{x:i,y:o}=n.startPosition,{x:r,y:a}=n.endPosition,u=(a-o)/(r-i),h=o-u*i,y=[];if(o<e[1]){let A=(e[1]-h)/u;A>=e[0]&&A<=e[0]+t[0]&&y.push({x:A,y:e[1]})}if(o>e[1]+t[1]){let A=(e[1]+t[1]-h)/u;A>=e[0]&&A<=e[0]+t[0]&&y.push({x:A,y:e[1]+t[1]})}if(i<e[0]){let A=u*e[0]+h;A>=e[1]&&A<=e[1]+t[1]&&y.push({x:e[0],y:A})}if(i>e[0]+t[0]){let A=u*(e[0]+t[0])+h;A>=e[1]&&A<=e[1]+t[1]&&y.push({x:e[0]+t[0],y:A})}y.sort((A,T)=>{let $=Math.sqrt((A.x-i)**2+(A.y-o)**2),x=Math.sqrt((T.x-i)**2+(T.y-o)**2);return $-x});let O=y.length>0?y[0]:{x:i,y:o},D=y.length>0?y[y.length-1]:{x:r,y:a};return{startPosition:O,endPosition:D}}let Xe;async function Tt(n){if(await b.action.setBadgeText("⏱️"),await b.player.setMetadata({[`${c.EXTENSIONID}/processed`]:!1}),Xe||(Xe=await sa({locateFile:()=>la})),!p.sceneReady||!p.sceneInitialized){p.playerShadowCache.invalidate(),p.busy=!1,await b.action.setBadgeText(void 0);return}if(p.busy)return;p.busy=!0;const[e,t]=[new Cn,new Cn];e.start(),e.pause(),t.start();const i=p.sceneItems.filter(J=>Li(J)&&(!St(J)||J.visible===!0)),o=p.sceneItems.filter(Xa),r=p.sceneItems.filter(Ri),a=p.sceneItems.filter(mo)?.[0],u=p.sceneMetadata[`${c.EXTENSIONID}/visionEnabled`]===!0,h=p.sceneMetadata[`${c.EXTENSIONID}/persistenceEnabled`]===!0,y=p.sceneMetadata[`${c.EXTENSIONID}/autodetectEnabled`]===!0,O=p.sceneMetadata[`${c.EXTENSIONID}/fowEnabled`]===!0,D=p.sceneMetadata[`${c.EXTENSIONID}/fowColor`],M=p.sceneMetadata[`${c.EXTENSIONID}/playerDoors`]===!0;let A=[],T=[],$=[],x=!1,L=[];if(a===void 0?(A[0]=0,A[1]=0,T[0]=1,T[1]=1,$[0]=0,$[1]=0):(A[0]=a.width*a.scale.x,A[1]=a.height*a.scale.y,T[0]=a.scale.x,T[1]=a.scale.y,$[0]=a.position.x,$[1]=a.position.y),p.playerRole==="GM"){L=i;const J=document.getElementById("mapHeight"),se=document.getElementById("mapWidth");se&&(se.value=(Math.round(A[0])/p.gridDpi).toString()),J&&(J.value=(Math.round(A[1])/p.gridDpi).toString())}else{L=i.filter(Fa);for(const J of i)Li(J)&&p.sceneMetadata[`${c.EXTENSIONID}/USER-${J.createdUserId}`]?.role==="GM"&&L.push(J)}const P=JSON.stringify(o),V=JSON.stringify(r),F=JSON.stringify(L),oe=JSON.stringify(a);if(p.previousMap===oe&&p.previousVisionEnabled===u&&p.previousFowColor===D&&p.previousAutodetectEnabled===y&&p.previousFowEnabled===O&&p.previousPersistenceEnabled===h&&p.previousVisionShapes===P&&p.previousAutohideItems===V&&p.previousPlayersWithVision===F&&p.previousSize[0]===A[0]&&p.previousSize[1]===A[1]&&n!==!0){p.busy=!1,await b.action.setBadgeText(void 0);return}(oe!=p.previousMap||p.previousVisionShapes!=P||A[0]!=p.previousSize[0]||A[1]!=p.previousSize[1])&&(x=!0),p.previousMap=oe,p.previousPlayersWithVision=F,p.previousVisionShapes=P,p.previousSize=A,p.previousVisionEnabled=u,p.previousAutodetectEnabled=y,p.previousFowEnabled=O,p.previousFowColor=D,p.previousPersistenceEnabled=h,t.pause();const C=[];for(let J=0;J<=6;J++)C.push(new Cn);C[1].start();let[w,g]=A;if(y){const J=p.sceneItems.filter(Ie=>Ie.layer==="MAP"&&Jt(Ie));if(J.length===0){p.busy=!1,await b.action.setBadgeText(void 0);return}let se=[];for(let Ie of J){let me=p.gridDpi/Ie.grid.dpi,de=Ie.position.x-me*Ie.grid.offset.x*Ie.scale.x,fe=Ie.position.y-me*Ie.grid.offset.y*Ie.scale.y,ye=de+me*Ie.image.width*Ie.scale.x,Te=fe+me*Ie.image.height*Ie.scale.y;if(Ie.rotation>0){const K=Math.abs(ye-de),f=Math.abs(Te-fe);switch(Ie.rotation){case 270:fe-=f,Te-=f;break;case 180:fe-=f,Te-=f,de-=K,ye-=K;break;case 90:de-=K,ye-=K;break}}se.length?(de<se[0]&&(se[0]=de),fe<se[1]&&(se[1]=fe),ye>se[2]&&(se[2]=ye),Te>se[3]&&(se[3]=Te)):(se[0]=de,se[1]=fe,se[2]=ye,se[3]=Te)}$=[se[0],se[1]],A=[se[2]-se[0],se[3]-se[1]],T=[1,1],[w,g]=A}let E=0,m=0;if(x&&p.playerShadowCache.invalidate(),t.resume(),!(p.sceneMetadata[`${c.EXTENSIONID}/visionEnabled`]===!0)||L.length==0){const J=p.sceneLocal.filter(se=>Gn(se));await b.scene.local.deleteItems(J.map(se=>se.id)),p.busy=!1,await b.action.setBadgeText(void 0);return}const R=fa(o),j=ha(R,L,w,g,$,T);if(j.length==0){p.busy=!1,await b.action.setBadgeText(void 0);return}const re=[];C[1].pause(),C[2].start();const le={};let Q=0;await we();async function we(){const J=L[Q];let se=p.playerShadowCache.getValue(J.id);if(se!==void 0&&to(se.player.position,J.position)&&se.player.metadata[`${c.EXTENSIONID}/visionRange`]===J.metadata[`${c.EXTENSIONID}/visionRange`]){const ye=Xe.FromCmds(se.shadowPath);if(le[Q]=ye,E++,Q===L.length-1){await De(C);return}else{Q++,await we();return}}m++;const Ie=j[Q];let me=new Xe.SkOpBuilder;const de=Xe.NewPath().rect($[0],$[1],A[0],A[1]);me.add(de,Xe.PathOp.UNION),de.delete(),await fe(Ie);function fe(ye){const Te=Math.ceil(ye.length/p.workers.length);let K=0,f=0,I={};for(let N=0;N<p.workers.length;N++){const W=K+Te,G=ye.slice(K,W+10);p.workers[N].onmessage=async function(H){if(H.data){const{numb:ue,messageData:Ce}=H.data;if(f++,I[ue]=Ce,f===p.workers.length){for(let Fe=0;Fe<p.workers.length;Fe++){const Be=I[Fe];if(Be){const Me=Xe.FromCmds(Be);me.add(Me,Xe.PathOp.INTERSECT),Me.delete()}}let Ee=me.resolve();if(Ee.simplify(),!Ee){console.error("Couldn't compute fog"),p.busy=!1,await b.action.setBadgeText(void 0);return}le[Q]=Ee,se!==void 0&&(se.shadowPath="");const He=Ee.toCmds();p.playerShadowCache.cacheValue(J.id,{shadowPath:He,player:J}),me.delete(),Q===L.length-1?await De(C):(Q++,await we())}}},p.workers[N].postMessage({numb:N,polygons:G,mapOffset:$,mapSize:A}),K=W}}}async function De(J){J[2].pause(),J[3].start();const se=[],Ie=Xe.NewPath();for(let ne=0;ne<L.length;ne++){const ge=L[ne],S=ge.metadata[`${c.EXTENSIONID}/visionRange`],B=p.playerId===L[ne].createdUserId,ie=p.sceneMetadata[`${c.EXTENSIONID}/USER-${L[ne].createdUserId}`]?.role==="GM";if(St(ge)?se[ne]=!0:Ie.op(le[ne],Xe.PathOp.UNION),S){if(!B&&p.playerRole!=="GM"&&!ie)continue;const ae=p.gridDpi*(S/p.gridScale+.5),he=Xe.NewPath().ellipse(ge.position.x,ge.position.y,ae,ae,0,0,2*Math.PI);le[ne]?.op(he,Xe.PathOp.INTERSECT),he.delete();const pe=p.sceneMetadata[`${c.EXTENSIONID}/USER-${ge.createdUserId}`];if(pe&&p.playerRole==="GM"&&!St(ge)&&pe.role!=="GM"){const $e=Vi().strokeColor(pe.color).fillOpacity(0).position({x:ge.position.x,y:ge.position.y}).width(ae*2).height(ae*2).shapeType("CIRCLE").metadata({[`${c.EXTENSIONID}/isIndicatorRing`]:!0}).locked(!0).build();re.push($e)}}}Ie.simplify();for(let ne=0;ne<se.length;ne++)se[ne]===!0&&(le[ne].op(Ie,Xe.PathOp.INTERSECT),le[ne].simplify());Ie.delete(),J[3].pause(),J[4].start();const me=[],de=[];let fe=[],ye=[];const Te=Xe.NewPath(),K={},f=p.sceneLocal.filter(ne=>Gn(ne)),I=p.sceneLocal.filter(ne=>Ra(ne));O&&Te.rect($[0],$[1],A[0],A[1]);let N=[],W,G=null;if(h)if(N=f.filter(ne=>At(ne)),W=new Xe.SkOpBuilder,K.reuse=!0,N.length===0){const ne=gt().commands([]).fillRule("evenodd").locked(!0).visible(!1).fillColor("#000000").strokeColor("#000000").layer("FOG").name("Fog of War").metadata({[`${c.EXTENSIONID}/isVisionFog`]:!0,[`${c.EXTENSIONID}/digest`]:"reuse"}).build();ne.zIndex=3,ye.push(ne),N=[ne]}else G=Xe.FromCmds(N[0].commands),G.setFillType(Xe.FillType.EVENODD);const H=new Xe.SkOpBuilder;let ue=!1;for(const ne of Object.keys(le)){const ge=le[ne],B=new TextEncoder().encode(ge.toCmds().toString()),q=await crypto.subtle.digest("SHA-1",B).then(ae=>[...new Uint8Array(ae)].map(he=>he.toString(16).padStart(2,"0")).join(""));if(f.filter(ae=>At(ae)&&ae.metadata[`${c.EXTENSIONID}/digest`]===q).length===0?h?W.add(ge,Xe.PathOp.UNION):me.push({cmds:ge.toCmds(),visible:!1,zIndex:3,playerId:L[ne].id,digest:q}):K[q]=!0,O){const ae=p.sceneLocal.filter(he=>he.metadata[`${c.EXTENSIONID}/debug`]===!0).map(he=>he.id);ae.length>0&&(fe=fe.concat(ae)),await Vt.GreenDebugPath(ge),Te.op(ge,Xe.PathOp.DIFFERENCE),p.playerRole==="GM"&&(ue=!0,H.add(ge,Xe.PathOp.UNION))}ge.delete()}const Ce=p.sceneMetadata[`${c.EXTENSIONID}/sceneId`];if(h){const ne=W.resolve();ne.setFillType(Xe.FillType.EVENODD),G!==null&&ne.op(G,Xe.PathOp.UNION);const ge=ne.toCmds();N.length>0&&(N[0].commands=ge,ye=ye.concat(N));try{localStorage.setItem(`${c.EXTENSIONID}/fogCache/${p.playerId}/${Ce}`,JSON.stringify([{digest:"reuse",commands:ge}]))}catch{console.log("Local storage is disabled")}G!==null&&G.delete(),ne.delete(),W.delete()}else if(h){const ne=f.filter(At);try{localStorage.setItem(`${c.EXTENSIONID}/fogCache/${p.playerId}/${Ce}`,JSON.stringify(ne.map(ge=>({digest:ge.metadata[`${c.EXTENSIONID}/digest`],commands:ge.commands}))))}catch{console.log("Local storage is disabled")}}let Ee;ue&&(Ee=H.resolve()),H.delete();const He=f.filter(Zt),Fe=f.filter(ne=>{const ge=ne.metadata[`${c.EXTENSIONID}/digest`];return At(ne)&&K[ge]===void 0});if(O){let ne=p.sceneMetadata[`${c.EXTENSIONID}/fowColor`]?p.sceneMetadata[`${c.EXTENSIONID}/fowColor`]:"#00000088",ge=.5;ne.length==9&&(ge=Number.parseInt(ne.substring(7),16)/255,ne=ne.substring(0,7));const S=gt().commands(Te.toCmds()).locked(!0).fillRule("evenodd").visible(!0).fillColor(ne).fillOpacity(ge).strokeWidth(0).strokeColor("#000000").layer("DRAWING").metadata({[`${c.EXTENSIONID}/isTrailingFog`]:!0}).name("Trailing Fog").build();S.disableHit=!0,He.length>0?de.push(b.scene.local.updateItems(Zt,B=>{for(const q of B)q.commands=S.commands},!1)):ye.push(S)}else fe=fe.concat(f.filter(Zt).map(ne=>ne.id));Te.delete(),J[4].pause(),J[5].start();const Be=p.sceneLocal.filter(ne=>ne.metadata[`${c.EXTENSIONID}/doorId`]!==void 0);M||p.playerRole=="GM"?await Zo():Be.length>0&&(fe=fe.concat(Be.map(ne=>ne.id)));for(const ne of Be){const ge=ne.metadata[`${c.EXTENSIONID}/doorId`],S=p.sceneItems.find(B=>B.id===ge);if(S){const B=ne.commands.length==c.DOOROPEN.length,q=!!S.metadata[`${c.EXTENSIONID}/doorOpen`];if(B===q)continue;de.push(b.scene.local.updateItems([ne.id],ie=>{const ae=ie[0];Bo(ae)&&(ae.commands=Hi(q))}))}}t.pause(),e.resume(),await Vt.DebugBlobINeverUse(),fe=fe.concat(I.map(ne=>ne.id)),me.map(ne=>{const ge=gt().commands(ne.cmds).fillRule("evenodd").locked(!0).visible(ne.visible).fillColor("#000000").strokeColor("#000000").layer("FOG").name("Fog of War").metadata({[`${c.EXTENSIONID}/isVisionFog`]:!0,[`${c.EXTENSIONID}/digest`]:ne.digest}).build();ge.zIndex=ne.zIndex,ye.push(ge)}),h||(fe=fe.concat(Fe.map(ne=>ne.id))),re.length>0&&(ye=ye.concat(re)),p.fogFilled||await b.scene.fog.setFilled(!0),await Promise.all(de),await b.scene.local.deleteItems(fe),await b.scene.local.addItems(ye);let Me=0;J[5].pause(),J[6].start(),ue&&(await Se(Ee,de),Ee.delete()),J[6].pause();const[ve,Oe]=[e.stop(),t.stop()],qe={compute_time:`${Oe} ms`,communication_time:`${ve} ms`,cache_hits:E.toString(),cache_misses:m.toString(),item_counter:Me.toString()};for(let ne=1;ne<=6;ne++){const ge=J[ne].stop();qe["stage"+ne]=`${ge} ms`}pa(qe),p.busy=!1,await b.player.setMetadata({[`${c.EXTENSIONID}/processed`]:!0}),await b.action.setBadgeText(void 0)}async function Se(J,se){const Ie=[],me=p.sceneItems.filter(de=>Ri(de)&&Jt(de));J.simplify();for(const de of me){const fe=new Xe.SkOpBuilder,ye=Xe.NewPath(),Te=p.gridDpi/de.grid.dpi*(de.image.width/2)*de.scale.x;for(let I=0;I<6;I++){const N=I*60*Math.PI/180,W=de.position.x+Te*Math.cos(N),G=de.position.y+Te*Math.sin(N);I==0?ye.moveTo(W,G):ye.lineTo(W,G)}ye.closePath(),await Vt.BlueTokenBoundingPath(ye),fe.add(ye,Xe.PathOp.UNION),fe.add(J,Xe.PathOp.INTERSECT);const K=fe.resolve(),f=!K.toCmds().length;de.visible==f&&Ie.push(de),await Vt.RedIntersectionPath(K),ye.delete(),fe.delete(),K.delete()}se.push(b.scene.items.updateItems(Ie.map(de=>de.id),de=>{for(let fe=0;fe<de.length;fe++)de[fe].visible=!de[fe].visible}))}}function pa(n){for(const[e,t]of Object.entries(n)){const i=document.getElementById(e);e=="compute_time"||e=="communication_time"||e[0]=="s"?i&&(i.innerText=Number.parseFloat(t).toFixed(1)+"ms"):i&&(i.innerText=t)}}function Ot(n){if(n.ctrlKey)return n.pointerPosition;const e=Math.round(p.gridDpi/p.gridSnap),t=Math.round(n.pointerPosition.x/p.gridDpi)*p.gridDpi,i=Math.round(n.pointerPosition.y/p.gridDpi)*p.gridDpi,o=Math.abs(t-n.pointerPosition.x),r=Math.abs(i-n.pointerPosition.y);let a,u;return o<=e?a=t:a=n.pointerPosition.x,r<=e?u=i:u=n.pointerPosition.y,{x:a,y:u}}let nt=null;const ga="#000000",ma=8,ya=[];async function no(){await b.popover.close(c.LINETOOLID)}async function Bn(){if(!nt)return;const[n,e]=nt;e(),nt=null,await no()}async function Vn(){if(!nt)return;const[n,e]=nt,t=n(i=>{i.visible=!1,i.metadata[`${c.EXTENSIONID}/isVisionLine`]=!0,i.points.pop()});t.points.length>=2&&await b.scene.items.addItems([t]),e(),nt=null,await no()}async function io(){if(!nt)return;const[n]=nt;n(e=>{e.points.length>2&&e.points.pop()})}async function va(n,e){if(!e.transformer)if(nt){const[t]=nt;t(i=>{i.points.push(e.pointerPosition)})}else{const t=Ot(e),i=p.snap?t:e.pointerPosition,o=ct().tension(0).points([i,i]).strokeColor(p.sceneMetadata[`${c.EXTENSIONID}/toolColor`]??ga).strokeDash(p.sceneMetadata[`${c.EXTENSIONID}/toolStyle`]??ya).strokeWidth(p.sceneMetadata[`${c.EXTENSIONID}/toolWidth`]??ma).fillOpacity(0).fillColor("#000000").layer("DRAWING").name("Vision Line (Line)").closed(!1).locked(!0).build();nt=await b.interaction.startItemInteraction(o);const r=await b.viewport.getWidth();await b.popover.open({id:c.LINETOOLID,url:"/pages/line.html",height:75,width:350,disableClickAway:!0,hidePaper:!0,anchorPosition:{top:50,left:r/2},anchorReference:"POSITION",anchorOrigin:{vertical:"CENTER",horizontal:"CENTER"},transformOrigin:{vertical:"TOP",horizontal:"CENTER"}})}}function Ea(n,e){if(!nt||e.transformer)return;const[t]=nt,i=Ot(e);t(o=>{o.points[o.points.length-1]=p.snap?i:e.pointerPosition})}function Ia(n,e){nt&&(e.key=="Escape"?Bn():e.key=="Enter"?Vn():e.key==="z"&&io())}const _n={onToolClick:va,onToolMove:Ea,onKeyDown:Ia};let it=null;const wa="#000000",Ta=8,Sa=[];async function oo(){await b.popover.close(c.POLYTOOLID)}async function Hn(){if(!it)return;const[n,e]=it;e(),it=null,oo(),await b.player.setMetadata({[`${c.EXTENSIONID}/cancelPoly`]:!1})}async function Un(){if(!it)return;const[n,e]=it,t=n(i=>{i.visible=!1,i.metadata[`${c.EXTENSIONID}/isVisionLine`]=!0,i.points.pop(),i.points.push(i.points[0])});t.points.length>=4&&await b.scene.items.addItems([t]),e(),it=null,oo(),await b.player.setMetadata({[`${c.EXTENSIONID}/finishPoly`]:!1})}async function ro(){if(!it)return;const[n]=it;n(e=>{e.points.length>2&&e.points.pop()})}async function ba(n,e){if(!e.transformer)if(it){const[t]=it;t(i=>{i.points.push(e.pointerPosition)})}else{const t=Ot(e),i=p.snap?t:e.pointerPosition,o=ct().tension(0).points([i,i]).strokeColor(p.sceneMetadata[`${c.EXTENSIONID}/toolColor`]??wa).strokeDash(p.sceneMetadata[`${c.EXTENSIONID}/toolStyle`]??Sa).strokeWidth(p.sceneMetadata[`${c.EXTENSIONID}/toolWidth`]??Ta).fillOpacity(.5).fillColor("#000000").layer("DRAWING").name("Vision Line (Polygon)").locked(!0).build();it=await b.interaction.startItemInteraction(o);const r=await b.viewport.getWidth();await b.popover.open({id:c.POLYTOOLID,url:"/pages/polygon.html",height:75,width:400,disableClickAway:!0,hidePaper:!0,anchorPosition:{top:50,left:r/2},anchorReference:"POSITION",anchorOrigin:{vertical:"CENTER",horizontal:"CENTER"},transformOrigin:{vertical:"TOP",horizontal:"CENTER"}})}}function Na(n,e){if(!it||e.transformer)return;const[t]=it,i=Ot(e);t(o=>{o.points[o.points.length-1]=p.snap?i:e.pointerPosition})}function Oa(n,e){it&&(e.key=="Escape"?Hn():e.key=="Enter"?Un():e.key==="z"&&ro())}const An={onToolClick:ba,onToolMove:Na,onKeyDown:Oa};let ot=null;const ao=8,so=[];async function lo(){await b.popover.close(c.ELEVATIONTOOLID)}async function Jn(){if(!ot)return;const[n,e]=ot;e(),ot=null,lo()}async function co(){if(!ot)return;const[n,e]=ot,t=n(i=>{i.visible=!1,i.points.pop(),i.points.push(i.points[0])});if(t.points.length>=4){await b.scene.local.addItems([t]);let i=p.sceneMetadata[`${c.EXTENSIONID}/elevationMapping`];i||(i=[]);const o=t.metadata[`${c.EXTENSIONID}/elevation`]??0,r={Points:t.points,Depth:o};i.push(r),await b.scene.setMetadata({[`${c.EXTENSIONID}/elevationMapping`]:i})}e(),ot=null,lo()}async function uo(){if(!ot)return;const[n]=ot;n(e=>{e.points.length>2&&e.points.pop()})}async function ka(n,e,t){if(!e.transformer)if(ot){const[i]=ot;i(o=>{o.points.push(e.pointerPosition)})}else{const i=Ot(e),o=p.snap?i:e.pointerPosition,r=ct().tension(0).points([o,o]).strokeColor(fo(t)).strokeDash(p.sceneMetadata[`${c.EXTENSIONID}/toolStyle`]??so).strokeWidth(p.sceneMetadata[`${c.EXTENSIONID}/toolWidth`]??ao).fillOpacity(.5).fillColor(ho(t)).layer("DRAWING").metadata({[`${c.EXTENSIONID}/elevation`]:t}).name(`Elevation-${t} Area`).zIndex(t).locked(!0).build();ot=await b.interaction.startItemInteraction(r);const a=await b.viewport.getWidth();await b.popover.open({id:c.ELEVATIONTOOLID,url:"/pages/elevation.html",height:110,width:360,disableClickAway:!0,anchorPosition:{top:60,left:a/2},anchorReference:"POSITION",anchorOrigin:{vertical:"CENTER",horizontal:"CENTER"},transformOrigin:{vertical:"TOP",horizontal:"CENTER"}})}}function Da(n,e){if(!ot||e.transformer)return;const[t]=ot,i=Ot(e);t(o=>{o.points[o.points.length-1]=p.snap?i:e.pointerPosition})}function Ca(n,e,t){ot&&(e.key=="Escape"?Jn():e.key=="Enter"?co():e.key==="z"&&uo())}async function xa(n){const e=n.metadata[`${c.EXTENSIONID}/elevationEditor`]??!1;await b.tool.setMetadata(`${c.EXTENSIONID}/vision-tool`,{[`${c.EXTENSIONID}/elevationEditor`]:!e}),e?await Aa():await _a()}async function _a(n){const t=(await b.scene.getMetadata())[`${c.EXTENSIONID}/elevationMapping`]??[];if(t&&t.length>0){const i=[];for(const o of t){const r=ct().tension(0).points(o.Points).strokeColor(fo(o.Depth)).strokeDash(p.sceneMetadata[`${c.EXTENSIONID}/toolStyle`]??so).strokeWidth(p.sceneMetadata[`${c.EXTENSIONID}/toolWidth`]??ao).fillOpacity(.5).fillColor(ho(o.Depth)).layer("DRAWING").name("Elevation-1 Area").locked(!0).visible(!1).metadata({[`${c.EXTENSIONID}/elevation`]:o.Depth}).zIndex(o.Depth).build();i.push(r)}await b.scene.local.addItems(i)}}async function Aa(n){const e=p.sceneLocal.filter(t=>t.metadata[`${c.EXTENSIONID}/elevation`]!==void 0);if(e.length>0){const t=[];for(const i of e){let o=i.points;(i.position.x!==0||i.position.y!==0)&&(o=i.points.map(a=>{const u=a.x+i.position.x,h=a.y+i.position.y;return{x:u,y:h}}));const r={Points:o,Depth:i.metadata[`${c.EXTENSIONID}/elevation`]??0};t.push(r)}await b.scene.setMetadata({[`${c.EXTENSIONID}/elevationMapping`]:t}),await b.scene.local.deleteItems(e.map(i=>i.id))}else await b.scene.setMetadata({[`${c.EXTENSIONID}/elevationMapping`]:[]})}function fo(n){switch(n){case 1:return"#6454ac";case 2:return"#029658";case 3:return"#fcd444";case 4:return"#fc6404";case 5:return"#ff0000";default:return"#000000"}}function ho(n){switch(n){case 1:return"#6454ac4F";case 2:return"#0296584F";case 3:return"#fcd4444F";case 4:return"#fc64044F";case 5:return"#ff00004F";default:return"#0000004F"}}const Ke={onToolClick:ka,onToolMove:Da,onKeyDown:Ca,enterEditMode:xa,cancelDrawing:Jn};function jt(n){throw new Error('Could not dynamically require "'+n+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var po={exports:{}};(function(n,e){(function(t){n.exports=t()})(function(){return function t(i,o,r){function a(y,O){if(!o[y]){if(!i[y]){var D=typeof jt=="function"&&jt;if(!O&&D)return D(y,!0);if(u)return u(y,!0);throw new Error("Cannot find module '"+y+"'")}O=o[y]={exports:{}},i[y][0].call(O.exports,function(M){var A=i[y][1][M];return a(A||M)},O,O.exports,t,i,o,r)}return o[y].exports}for(var u=typeof jt=="function"&&jt,h=0;h<r.length;h++)a(r[h]);return a}({1:[function(t,i,o){(function(r,a,u,h,y,O,D,M,A){var T=t("crypto");function $(C,w){w=P(C,w);var g;return(g=w.algorithm!=="passthrough"?T.createHash(w.algorithm):new oe).write===void 0&&(g.write=g.update,g.end=g.update),F(w,g).dispatch(C),g.update||g.end(""),g.digest?g.digest(w.encoding==="buffer"?void 0:w.encoding):(C=g.read(),w.encoding!=="buffer"?C.toString(w.encoding):C)}(o=i.exports=$).sha1=function(C){return $(C)},o.keys=function(C){return $(C,{excludeValues:!0,algorithm:"sha1",encoding:"hex"})},o.MD5=function(C){return $(C,{algorithm:"md5",encoding:"hex"})},o.keysMD5=function(C){return $(C,{algorithm:"md5",encoding:"hex",excludeValues:!0})};var x=T.getHashes?T.getHashes().slice():["sha1","md5"],L=(x.push("passthrough"),["buffer","hex","binary","base64"]);function P(C,w){var g={};if(g.algorithm=(w=w||{}).algorithm||"sha1",g.encoding=w.encoding||"hex",g.excludeValues=!!w.excludeValues,g.algorithm=g.algorithm.toLowerCase(),g.encoding=g.encoding.toLowerCase(),g.ignoreUnknown=w.ignoreUnknown===!0,g.respectType=w.respectType!==!1,g.respectFunctionNames=w.respectFunctionNames!==!1,g.respectFunctionProperties=w.respectFunctionProperties!==!1,g.unorderedArrays=w.unorderedArrays===!0,g.unorderedSets=w.unorderedSets!==!1,g.unorderedObjects=w.unorderedObjects!==!1,g.replacer=w.replacer||void 0,g.excludeKeys=w.excludeKeys||void 0,C===void 0)throw new Error("Object argument required.");for(var E=0;E<x.length;++E)x[E].toLowerCase()===g.algorithm.toLowerCase()&&(g.algorithm=x[E]);if(x.indexOf(g.algorithm)===-1)throw new Error('Algorithm "'+g.algorithm+'"  not supported. supported values: '+x.join(", "));if(L.indexOf(g.encoding)===-1&&g.algorithm!=="passthrough")throw new Error('Encoding "'+g.encoding+'"  not supported. supported values: '+L.join(", "));return g}function V(C){if(typeof C=="function")return/^function\s+\w*\s*\(\s*\)\s*{\s+\[native code\]\s+}$/i.exec(Function.prototype.toString.call(C))!=null}function F(C,w,g){g=g||[];function E(m){return w.update?w.update(m,"utf8"):w.write(m,"utf8")}return{dispatch:function(m){return this["_"+((m=C.replacer?C.replacer(m):m)===null?"null":typeof m)](m)},_object:function(m){var k,R=Object.prototype.toString.call(m),j=/\[object (.*)\]/i.exec(R);if(j=(j=j?j[1]:"unknown:["+R+"]").toLowerCase(),0<=(R=g.indexOf(m)))return this.dispatch("[CIRCULAR:"+R+"]");if(g.push(m),u!==void 0&&u.isBuffer&&u.isBuffer(m))return E("buffer:"),E(m);if(j==="object"||j==="function"||j==="asyncfunction")return R=Object.keys(m),C.unorderedObjects&&(R=R.sort()),C.respectType===!1||V(m)||R.splice(0,0,"prototype","__proto__","constructor"),C.excludeKeys&&(R=R.filter(function(re){return!C.excludeKeys(re)})),E("object:"+R.length+":"),k=this,R.forEach(function(re){k.dispatch(re),E(":"),C.excludeValues||k.dispatch(m[re]),E(",")});if(!this["_"+j]){if(C.ignoreUnknown)return E("["+j+"]");throw new Error('Unknown object type "'+j+'"')}this["_"+j](m)},_array:function(m,re){re=re!==void 0?re:C.unorderedArrays!==!1;var R=this;if(E("array:"+m.length+":"),!re||m.length<=1)return m.forEach(function(le){return R.dispatch(le)});var j=[],re=m.map(function(le){var Q=new oe,we=g.slice();return F(C,Q,we).dispatch(le),j=j.concat(we.slice(g.length)),Q.read().toString()});return g=g.concat(j),re.sort(),this._array(re,!1)},_date:function(m){return E("date:"+m.toJSON())},_symbol:function(m){return E("symbol:"+m.toString())},_error:function(m){return E("error:"+m.toString())},_boolean:function(m){return E("bool:"+m.toString())},_string:function(m){E("string:"+m.length+":"),E(m.toString())},_function:function(m){E("fn:"),V(m)?this.dispatch("[native]"):this.dispatch(m.toString()),C.respectFunctionNames!==!1&&this.dispatch("function-name:"+String(m.name)),C.respectFunctionProperties&&this._object(m)},_number:function(m){return E("number:"+m.toString())},_xml:function(m){return E("xml:"+m.toString())},_null:function(){return E("Null")},_undefined:function(){return E("Undefined")},_regexp:function(m){return E("regex:"+m.toString())},_uint8array:function(m){return E("uint8array:"),this.dispatch(Array.prototype.slice.call(m))},_uint8clampedarray:function(m){return E("uint8clampedarray:"),this.dispatch(Array.prototype.slice.call(m))},_int8array:function(m){return E("int8array:"),this.dispatch(Array.prototype.slice.call(m))},_uint16array:function(m){return E("uint16array:"),this.dispatch(Array.prototype.slice.call(m))},_int16array:function(m){return E("int16array:"),this.dispatch(Array.prototype.slice.call(m))},_uint32array:function(m){return E("uint32array:"),this.dispatch(Array.prototype.slice.call(m))},_int32array:function(m){return E("int32array:"),this.dispatch(Array.prototype.slice.call(m))},_float32array:function(m){return E("float32array:"),this.dispatch(Array.prototype.slice.call(m))},_float64array:function(m){return E("float64array:"),this.dispatch(Array.prototype.slice.call(m))},_arraybuffer:function(m){return E("arraybuffer:"),this.dispatch(new Uint8Array(m))},_url:function(m){return E("url:"+m.toString())},_map:function(m){return E("map:"),m=Array.from(m),this._array(m,C.unorderedSets!==!1)},_set:function(m){return E("set:"),m=Array.from(m),this._array(m,C.unorderedSets!==!1)},_file:function(m){return E("file:"),this.dispatch([m.name,m.size,m.type,m.lastModfied])},_blob:function(){if(C.ignoreUnknown)return E("[blob]");throw Error(`Hashing Blob objects is currently not supported
(see https://github.com/puleos/object-hash/issues/26)
Use "options.replacer" or "options.ignoreUnknown"
`)},_domwindow:function(){return E("domwindow")},_bigint:function(m){return E("bigint:"+m.toString())},_process:function(){return E("process")},_timer:function(){return E("timer")},_pipe:function(){return E("pipe")},_tcp:function(){return E("tcp")},_udp:function(){return E("udp")},_tty:function(){return E("tty")},_statwatcher:function(){return E("statwatcher")},_securecontext:function(){return E("securecontext")},_connection:function(){return E("connection")},_zlib:function(){return E("zlib")},_context:function(){return E("context")},_nodescript:function(){return E("nodescript")},_httpparser:function(){return E("httpparser")},_dataview:function(){return E("dataview")},_signal:function(){return E("signal")},_fsevent:function(){return E("fsevent")},_tlswrap:function(){return E("tlswrap")}}}function oe(){return{buf:"",write:function(C){this.buf+=C},end:function(C){this.buf+=C},read:function(){return this.buf}}}o.writeToStream=function(C,w,g){return g===void 0&&(g=w,w={}),F(w=P(C,w),g).dispatch(C)}}).call(this,t("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},t("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/fake_9a5aa49d.js","/")},{buffer:3,crypto:5,lYpoI2:11}],2:[function(t,i,o){(function(r,a,u,h,y,O,D,M,A){(function(T){var $=typeof Uint8Array<"u"?Uint8Array:Array,x="+".charCodeAt(0),L="/".charCodeAt(0),P="0".charCodeAt(0),V="a".charCodeAt(0),F="A".charCodeAt(0),oe="-".charCodeAt(0),C="_".charCodeAt(0);function w(g){return g=g.charCodeAt(0),g===x||g===oe?62:g===L||g===C?63:g<P?-1:g<P+10?g-P+26+26:g<F+26?g-F:g<V+26?g-V+26:void 0}T.toByteArray=function(g){var E,m;if(0<g.length%4)throw new Error("Invalid string. Length must be a multiple of 4");var k=g.length,k=g.charAt(k-2)==="="?2:g.charAt(k-1)==="="?1:0,R=new $(3*g.length/4-k),j=0<k?g.length-4:g.length,re=0;function le(Q){R[re++]=Q}for(E=0;E<j;E+=4,0)le((16711680&(m=w(g.charAt(E))<<18|w(g.charAt(E+1))<<12|w(g.charAt(E+2))<<6|w(g.charAt(E+3))))>>16),le((65280&m)>>8),le(255&m);return k==2?le(255&(m=w(g.charAt(E))<<2|w(g.charAt(E+1))>>4)):k==1&&(le((m=w(g.charAt(E))<<10|w(g.charAt(E+1))<<4|w(g.charAt(E+2))>>2)>>8&255),le(255&m)),R},T.fromByteArray=function(g){var E,m,k,R,j=g.length%3,re="";function le(Q){return"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(Q)}for(E=0,k=g.length-j;E<k;E+=3)m=(g[E]<<16)+(g[E+1]<<8)+g[E+2],re+=le((R=m)>>18&63)+le(R>>12&63)+le(R>>6&63)+le(63&R);switch(j){case 1:re=(re+=le((m=g[g.length-1])>>2))+le(m<<4&63)+"==";break;case 2:re=(re=(re+=le((m=(g[g.length-2]<<8)+g[g.length-1])>>10))+le(m>>4&63))+le(m<<2&63)+"="}return re}})(o===void 0?this.base64js={}:o)}).call(this,t("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},t("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/base64-js/lib/b64.js","/node_modules/gulp-browserify/node_modules/base64-js/lib")},{buffer:3,lYpoI2:11}],3:[function(t,i,o){(function(r,a,x,h,y,O,D,M,A){var T=t("base64-js"),$=t("ieee754");function x(f,I,N){if(!(this instanceof x))return new x(f,I,N);var W,G,H,ue,Ce=typeof f;if(I==="base64"&&Ce=="string")for(f=(ue=f).trim?ue.trim():ue.replace(/^\s+|\s+$/g,"");f.length%4!=0;)f+="=";if(Ce=="number")W=De(f);else if(Ce=="string")W=x.byteLength(f,I);else{if(Ce!="object")throw new Error("First argument needs to be a number, array or string.");W=De(f.length)}if(x._useTypedArrays?G=x._augment(new Uint8Array(W)):((G=this).length=W,G._isBuffer=!0),x._useTypedArrays&&typeof f.byteLength=="number")G._set(f);else if(Se(ue=f)||x.isBuffer(ue)||ue&&typeof ue=="object"&&typeof ue.length=="number")for(H=0;H<W;H++)x.isBuffer(f)?G[H]=f.readUInt8(H):G[H]=f[H];else if(Ce=="string")G.write(f,0,I);else if(Ce=="number"&&!x._useTypedArrays&&!N)for(H=0;H<W;H++)G[H]=0;return G}function L(f,I,N,W){return x._charsWritten=me(function(G){for(var H=[],ue=0;ue<G.length;ue++)H.push(255&G.charCodeAt(ue));return H}(I),f,N,W)}function P(f,I,N,W){return x._charsWritten=me(function(G){for(var H,ue,Ce=[],Ee=0;Ee<G.length;Ee++)ue=G.charCodeAt(Ee),H=ue>>8,ue=ue%256,Ce.push(ue),Ce.push(H);return Ce}(I),f,N,W)}function V(f,I,N){var W="";N=Math.min(f.length,N);for(var G=I;G<N;G++)W+=String.fromCharCode(f[G]);return W}function F(f,I,N,H){H||(K(typeof N=="boolean","missing or invalid endian"),K(I!=null,"missing offset"),K(I+1<f.length,"Trying to read beyond buffer length"));var G,H=f.length;if(!(H<=I))return N?(G=f[I],I+1<H&&(G|=f[I+1]<<8)):(G=f[I]<<8,I+1<H&&(G|=f[I+1])),G}function oe(f,I,N,H){H||(K(typeof N=="boolean","missing or invalid endian"),K(I!=null,"missing offset"),K(I+3<f.length,"Trying to read beyond buffer length"));var G,H=f.length;if(!(H<=I))return N?(I+2<H&&(G=f[I+2]<<16),I+1<H&&(G|=f[I+1]<<8),G|=f[I],I+3<H&&(G+=f[I+3]<<24>>>0)):(I+1<H&&(G=f[I+1]<<16),I+2<H&&(G|=f[I+2]<<8),I+3<H&&(G|=f[I+3]),G+=f[I]<<24>>>0),G}function C(f,I,N,W){if(W||(K(typeof N=="boolean","missing or invalid endian"),K(I!=null,"missing offset"),K(I+1<f.length,"Trying to read beyond buffer length")),!(f.length<=I))return W=F(f,I,N,!0),32768&W?-1*(65535-W+1):W}function w(f,I,N,W){if(W||(K(typeof N=="boolean","missing or invalid endian"),K(I!=null,"missing offset"),K(I+3<f.length,"Trying to read beyond buffer length")),!(f.length<=I))return W=oe(f,I,N,!0),2147483648&W?-1*(4294967295-W+1):W}function g(f,I,N,W){return W||(K(typeof N=="boolean","missing or invalid endian"),K(I+3<f.length,"Trying to read beyond buffer length")),$.read(f,I,N,23,4)}function E(f,I,N,W){return W||(K(typeof N=="boolean","missing or invalid endian"),K(I+7<f.length,"Trying to read beyond buffer length")),$.read(f,I,N,52,8)}function m(f,I,N,W,G){if(G||(K(I!=null,"missing value"),K(typeof W=="boolean","missing or invalid endian"),K(N!=null,"missing offset"),K(N+1<f.length,"trying to write beyond buffer length"),fe(I,65535)),G=f.length,!(G<=N))for(var H=0,ue=Math.min(G-N,2);H<ue;H++)f[N+H]=(I&255<<8*(W?H:1-H))>>>8*(W?H:1-H)}function k(f,I,N,W,G){if(G||(K(I!=null,"missing value"),K(typeof W=="boolean","missing or invalid endian"),K(N!=null,"missing offset"),K(N+3<f.length,"trying to write beyond buffer length"),fe(I,4294967295)),G=f.length,!(G<=N))for(var H=0,ue=Math.min(G-N,4);H<ue;H++)f[N+H]=I>>>8*(W?H:3-H)&255}function R(f,I,N,W,G){G||(K(I!=null,"missing value"),K(typeof W=="boolean","missing or invalid endian"),K(N!=null,"missing offset"),K(N+1<f.length,"Trying to write beyond buffer length"),ye(I,32767,-32768)),f.length<=N||m(f,0<=I?I:65535+I+1,N,W,G)}function j(f,I,N,W,G){G||(K(I!=null,"missing value"),K(typeof W=="boolean","missing or invalid endian"),K(N!=null,"missing offset"),K(N+3<f.length,"Trying to write beyond buffer length"),ye(I,2147483647,-2147483648)),f.length<=N||k(f,0<=I?I:4294967295+I+1,N,W,G)}function re(f,I,N,W,G){G||(K(I!=null,"missing value"),K(typeof W=="boolean","missing or invalid endian"),K(N!=null,"missing offset"),K(N+3<f.length,"Trying to write beyond buffer length"),Te(I,34028234663852886e22,-34028234663852886e22)),f.length<=N||$.write(f,I,N,W,23,4)}function le(f,I,N,W,G){G||(K(I!=null,"missing value"),K(typeof W=="boolean","missing or invalid endian"),K(N!=null,"missing offset"),K(N+7<f.length,"Trying to write beyond buffer length"),Te(I,17976931348623157e292,-17976931348623157e292)),f.length<=N||$.write(f,I,N,W,52,8)}o.Buffer=x,o.SlowBuffer=x,o.INSPECT_MAX_BYTES=50,x.poolSize=8192,x._useTypedArrays=function(){try{var f=new ArrayBuffer(0),I=new Uint8Array(f);return I.foo=function(){return 42},I.foo()===42&&typeof I.subarray=="function"}catch{return!1}}(),x.isEncoding=function(f){switch(String(f).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"binary":case"base64":case"raw":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},x.isBuffer=function(f){return!(f==null||!f._isBuffer)},x.byteLength=function(f,I){var N;switch(f+="",I||"utf8"){case"hex":N=f.length/2;break;case"utf8":case"utf-8":N=se(f).length;break;case"ascii":case"binary":case"raw":N=f.length;break;case"base64":N=Ie(f).length;break;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":N=2*f.length;break;default:throw new Error("Unknown encoding")}return N},x.concat=function(f,I){if(K(Se(f),`Usage: Buffer.concat(list, [totalLength])
list should be an Array.`),f.length===0)return new x(0);if(f.length===1)return f[0];if(typeof I!="number")for(G=I=0;G<f.length;G++)I+=f[G].length;for(var N=new x(I),W=0,G=0;G<f.length;G++){var H=f[G];H.copy(N,W),W+=H.length}return N},x.prototype.write=function(f,I,N,W){isFinite(I)?isFinite(N)||(W=N,N=void 0):(Ee=W,W=I,I=N,N=Ee),I=Number(I)||0;var G,H,ue,Ce,Ee=this.length-I;switch((!N||Ee<(N=Number(N)))&&(N=Ee),W=String(W||"utf8").toLowerCase()){case"hex":G=function(He,Fe,Be,Me){Be=Number(Be)||0;var ve=He.length-Be;(!Me||ve<(Me=Number(Me)))&&(Me=ve),K((ve=Fe.length)%2==0,"Invalid hex string"),ve/2<Me&&(Me=ve/2);for(var Oe=0;Oe<Me;Oe++){var qe=parseInt(Fe.substr(2*Oe,2),16);K(!isNaN(qe),"Invalid hex string"),He[Be+Oe]=qe}return x._charsWritten=2*Oe,Oe}(this,f,I,N);break;case"utf8":case"utf-8":H=this,ue=I,Ce=N,G=x._charsWritten=me(se(f),H,ue,Ce);break;case"ascii":case"binary":G=L(this,f,I,N);break;case"base64":H=this,ue=I,Ce=N,G=x._charsWritten=me(Ie(f),H,ue,Ce);break;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":G=P(this,f,I,N);break;default:throw new Error("Unknown encoding")}return G},x.prototype.toString=function(f,I,N){var W,G,H,ue,Ce=this;if(f=String(f||"utf8").toLowerCase(),I=Number(I)||0,(N=N!==void 0?Number(N):Ce.length)===I)return"";switch(f){case"hex":W=function(Ee,He,Fe){var Be=Ee.length;(!He||He<0)&&(He=0),(!Fe||Fe<0||Be<Fe)&&(Fe=Be);for(var Me="",ve=He;ve<Fe;ve++)Me+=J(Ee[ve]);return Me}(Ce,I,N);break;case"utf8":case"utf-8":W=function(Ee,He,Fe){var Be="",Me="";Fe=Math.min(Ee.length,Fe);for(var ve=He;ve<Fe;ve++)Ee[ve]<=127?(Be+=de(Me)+String.fromCharCode(Ee[ve]),Me=""):Me+="%"+Ee[ve].toString(16);return Be+de(Me)}(Ce,I,N);break;case"ascii":case"binary":W=V(Ce,I,N);break;case"base64":G=Ce,ue=N,W=(H=I)===0&&ue===G.length?T.fromByteArray(G):T.fromByteArray(G.slice(H,ue));break;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":W=function(Ee,He,Fe){for(var Be=Ee.slice(He,Fe),Me="",ve=0;ve<Be.length;ve+=2)Me+=String.fromCharCode(Be[ve]+256*Be[ve+1]);return Me}(Ce,I,N);break;default:throw new Error("Unknown encoding")}return W},x.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}},x.prototype.copy=function(f,I,N,W){if(I=I||0,(W=W||W===0?W:this.length)!==(N=N||0)&&f.length!==0&&this.length!==0){K(N<=W,"sourceEnd < sourceStart"),K(0<=I&&I<f.length,"targetStart out of bounds"),K(0<=N&&N<this.length,"sourceStart out of bounds"),K(0<=W&&W<=this.length,"sourceEnd out of bounds"),W>this.length&&(W=this.length);var G=(W=f.length-I<W-N?f.length-I+N:W)-N;if(G<100||!x._useTypedArrays)for(var H=0;H<G;H++)f[H+I]=this[H+N];else f._set(this.subarray(N,N+G),I)}},x.prototype.slice=function(f,I){var N=this.length;if(f=we(f,N,0),I=we(I,N,N),x._useTypedArrays)return x._augment(this.subarray(f,I));for(var W=I-f,G=new x(W,void 0,!0),H=0;H<W;H++)G[H]=this[H+f];return G},x.prototype.get=function(f){return console.log(".get() is deprecated. Access using array indexes instead."),this.readUInt8(f)},x.prototype.set=function(f,I){return console.log(".set() is deprecated. Access using array indexes instead."),this.writeUInt8(f,I)},x.prototype.readUInt8=function(f,I){if(I||(K(f!=null,"missing offset"),K(f<this.length,"Trying to read beyond buffer length")),!(f>=this.length))return this[f]},x.prototype.readUInt16LE=function(f,I){return F(this,f,!0,I)},x.prototype.readUInt16BE=function(f,I){return F(this,f,!1,I)},x.prototype.readUInt32LE=function(f,I){return oe(this,f,!0,I)},x.prototype.readUInt32BE=function(f,I){return oe(this,f,!1,I)},x.prototype.readInt8=function(f,I){if(I||(K(f!=null,"missing offset"),K(f<this.length,"Trying to read beyond buffer length")),!(f>=this.length))return 128&this[f]?-1*(255-this[f]+1):this[f]},x.prototype.readInt16LE=function(f,I){return C(this,f,!0,I)},x.prototype.readInt16BE=function(f,I){return C(this,f,!1,I)},x.prototype.readInt32LE=function(f,I){return w(this,f,!0,I)},x.prototype.readInt32BE=function(f,I){return w(this,f,!1,I)},x.prototype.readFloatLE=function(f,I){return g(this,f,!0,I)},x.prototype.readFloatBE=function(f,I){return g(this,f,!1,I)},x.prototype.readDoubleLE=function(f,I){return E(this,f,!0,I)},x.prototype.readDoubleBE=function(f,I){return E(this,f,!1,I)},x.prototype.writeUInt8=function(f,I,N){N||(K(f!=null,"missing value"),K(I!=null,"missing offset"),K(I<this.length,"trying to write beyond buffer length"),fe(f,255)),I>=this.length||(this[I]=f)},x.prototype.writeUInt16LE=function(f,I,N){m(this,f,I,!0,N)},x.prototype.writeUInt16BE=function(f,I,N){m(this,f,I,!1,N)},x.prototype.writeUInt32LE=function(f,I,N){k(this,f,I,!0,N)},x.prototype.writeUInt32BE=function(f,I,N){k(this,f,I,!1,N)},x.prototype.writeInt8=function(f,I,N){N||(K(f!=null,"missing value"),K(I!=null,"missing offset"),K(I<this.length,"Trying to write beyond buffer length"),ye(f,127,-128)),I>=this.length||(0<=f?this.writeUInt8(f,I,N):this.writeUInt8(255+f+1,I,N))},x.prototype.writeInt16LE=function(f,I,N){R(this,f,I,!0,N)},x.prototype.writeInt16BE=function(f,I,N){R(this,f,I,!1,N)},x.prototype.writeInt32LE=function(f,I,N){j(this,f,I,!0,N)},x.prototype.writeInt32BE=function(f,I,N){j(this,f,I,!1,N)},x.prototype.writeFloatLE=function(f,I,N){re(this,f,I,!0,N)},x.prototype.writeFloatBE=function(f,I,N){re(this,f,I,!1,N)},x.prototype.writeDoubleLE=function(f,I,N){le(this,f,I,!0,N)},x.prototype.writeDoubleBE=function(f,I,N){le(this,f,I,!1,N)},x.prototype.fill=function(f,I,N){if(I=I||0,N=N||this.length,K(typeof(f=typeof(f=f||0)=="string"?f.charCodeAt(0):f)=="number"&&!isNaN(f),"value is not a number"),K(I<=N,"end < start"),N!==I&&this.length!==0){K(0<=I&&I<this.length,"start out of bounds"),K(0<=N&&N<=this.length,"end out of bounds");for(var W=I;W<N;W++)this[W]=f}},x.prototype.inspect=function(){for(var f=[],I=this.length,N=0;N<I;N++)if(f[N]=J(this[N]),N===o.INSPECT_MAX_BYTES){f[N+1]="...";break}return"<Buffer "+f.join(" ")+">"},x.prototype.toArrayBuffer=function(){if(typeof Uint8Array>"u")throw new Error("Buffer.toArrayBuffer not supported in this browser");if(x._useTypedArrays)return new x(this).buffer;for(var f=new Uint8Array(this.length),I=0,N=f.length;I<N;I+=1)f[I]=this[I];return f.buffer};var Q=x.prototype;function we(f,I,N){return typeof f!="number"?N:I<=(f=~~f)?I:0<=f||0<=(f+=I)?f:0}function De(f){return(f=~~Math.ceil(+f))<0?0:f}function Se(f){return(Array.isArray||function(I){return Object.prototype.toString.call(I)==="[object Array]"})(f)}function J(f){return f<16?"0"+f.toString(16):f.toString(16)}function se(f){for(var I=[],N=0;N<f.length;N++){var W=f.charCodeAt(N);if(W<=127)I.push(f.charCodeAt(N));else for(var G=N,H=(55296<=W&&W<=57343&&N++,encodeURIComponent(f.slice(G,N+1)).substr(1).split("%")),ue=0;ue<H.length;ue++)I.push(parseInt(H[ue],16))}return I}function Ie(f){return T.toByteArray(f)}function me(f,I,N,W){for(var G=0;G<W&&!(G+N>=I.length||G>=f.length);G++)I[G+N]=f[G];return G}function de(f){try{return decodeURIComponent(f)}catch{return String.fromCharCode(65533)}}function fe(f,I){K(typeof f=="number","cannot write a non-number as a number"),K(0<=f,"specified a negative value for writing an unsigned value"),K(f<=I,"value is larger than maximum value for type"),K(Math.floor(f)===f,"value has a fractional component")}function ye(f,I,N){K(typeof f=="number","cannot write a non-number as a number"),K(f<=I,"value larger than maximum allowed value"),K(N<=f,"value smaller than minimum allowed value"),K(Math.floor(f)===f,"value has a fractional component")}function Te(f,I,N){K(typeof f=="number","cannot write a non-number as a number"),K(f<=I,"value larger than maximum allowed value"),K(N<=f,"value smaller than minimum allowed value")}function K(f,I){if(!f)throw new Error(I||"Failed assertion")}x._augment=function(f){return f._isBuffer=!0,f._get=f.get,f._set=f.set,f.get=Q.get,f.set=Q.set,f.write=Q.write,f.toString=Q.toString,f.toLocaleString=Q.toString,f.toJSON=Q.toJSON,f.copy=Q.copy,f.slice=Q.slice,f.readUInt8=Q.readUInt8,f.readUInt16LE=Q.readUInt16LE,f.readUInt16BE=Q.readUInt16BE,f.readUInt32LE=Q.readUInt32LE,f.readUInt32BE=Q.readUInt32BE,f.readInt8=Q.readInt8,f.readInt16LE=Q.readInt16LE,f.readInt16BE=Q.readInt16BE,f.readInt32LE=Q.readInt32LE,f.readInt32BE=Q.readInt32BE,f.readFloatLE=Q.readFloatLE,f.readFloatBE=Q.readFloatBE,f.readDoubleLE=Q.readDoubleLE,f.readDoubleBE=Q.readDoubleBE,f.writeUInt8=Q.writeUInt8,f.writeUInt16LE=Q.writeUInt16LE,f.writeUInt16BE=Q.writeUInt16BE,f.writeUInt32LE=Q.writeUInt32LE,f.writeUInt32BE=Q.writeUInt32BE,f.writeInt8=Q.writeInt8,f.writeInt16LE=Q.writeInt16LE,f.writeInt16BE=Q.writeInt16BE,f.writeInt32LE=Q.writeInt32LE,f.writeInt32BE=Q.writeInt32BE,f.writeFloatLE=Q.writeFloatLE,f.writeFloatBE=Q.writeFloatBE,f.writeDoubleLE=Q.writeDoubleLE,f.writeDoubleBE=Q.writeDoubleBE,f.fill=Q.fill,f.inspect=Q.inspect,f.toArrayBuffer=Q.toArrayBuffer,f}}).call(this,t("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},t("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/buffer/index.js","/node_modules/gulp-browserify/node_modules/buffer")},{"base64-js":2,buffer:3,ieee754:10,lYpoI2:11}],4:[function(t,i,o){(function(r,a,T,h,y,O,D,M,A){var T=t("buffer").Buffer,$=4,x=new T($);x.fill(0),i.exports={hash:function(L,P,V,F){for(var oe=P(function(m,k){m.length%$!=0&&(R=m.length+($-m.length%$),m=T.concat([m,x],R));for(var R,j=[],re=k?m.readInt32BE:m.readInt32LE,le=0;le<m.length;le+=$)j.push(re.call(m,le));return j}(L=T.isBuffer(L)?L:new T(L),F),8*L.length),P=F,C=new T(V),w=P?C.writeInt32BE:C.writeInt32LE,g=0;g<oe.length;g++)w.call(C,oe[g],4*g,!0);return C}}}).call(this,t("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},t("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/crypto-browserify/helpers.js","/node_modules/gulp-browserify/node_modules/crypto-browserify")},{buffer:3,lYpoI2:11}],5:[function(t,i,o){(function(r,a,T,h,y,O,D,M,A){var T=t("buffer").Buffer,$=t("./sha"),x=t("./sha256"),L=t("./rng"),P={sha1:$,sha256:x,md5:t("./md5")},V=64,F=new T(V);function oe(m,k){var R=P[m=m||"sha1"],j=[];return R||C("algorithm:",m,"is not yet supported"),{update:function(re){return T.isBuffer(re)||(re=new T(re)),j.push(re),re.length,this},digest:function(re){var le=T.concat(j),le=k?function(Q,we,De){T.isBuffer(we)||(we=new T(we)),T.isBuffer(De)||(De=new T(De)),we.length>V?we=Q(we):we.length<V&&(we=T.concat([we,F],V));for(var Se=new T(V),J=new T(V),se=0;se<V;se++)Se[se]=54^we[se],J[se]=92^we[se];return De=Q(T.concat([Se,De])),Q(T.concat([J,De]))}(R,k,le):R(le);return j=null,re?le.toString(re):le}}}function C(){var m=[].slice.call(arguments).join(" ");throw new Error([m,"we accept pull requests","http://github.com/dominictarr/crypto-browserify"].join(`
`))}F.fill(0),o.createHash=function(m){return oe(m)},o.createHmac=oe,o.randomBytes=function(m,k){if(!k||!k.call)return new T(L(m));try{k.call(this,void 0,new T(L(m)))}catch(R){k(R)}};var w,g=["createCredentials","createCipher","createCipheriv","createDecipher","createDecipheriv","createSign","createVerify","createDiffieHellman","pbkdf2"],E=function(m){o[m]=function(){C("sorry,",m,"is not implemented yet")}};for(w in g)E(g[w])}).call(this,t("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},t("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/crypto-browserify/index.js","/node_modules/gulp-browserify/node_modules/crypto-browserify")},{"./md5":6,"./rng":7,"./sha":8,"./sha256":9,buffer:3,lYpoI2:11}],6:[function(t,i,o){(function(r,a,u,h,y,O,D,M,A){var T=t("./helpers");function $(C,w){C[w>>5]|=128<<w%32,C[14+(w+64>>>9<<4)]=w;for(var g=1732584193,E=-271733879,m=-1732584194,k=271733878,R=0;R<C.length;R+=16){var j=g,re=E,le=m,Q=k,g=L(g,E,m,k,C[R+0],7,-680876936),k=L(k,g,E,m,C[R+1],12,-389564586),m=L(m,k,g,E,C[R+2],17,606105819),E=L(E,m,k,g,C[R+3],22,-1044525330);g=L(g,E,m,k,C[R+4],7,-176418897),k=L(k,g,E,m,C[R+5],12,1200080426),m=L(m,k,g,E,C[R+6],17,-1473231341),E=L(E,m,k,g,C[R+7],22,-45705983),g=L(g,E,m,k,C[R+8],7,1770035416),k=L(k,g,E,m,C[R+9],12,-1958414417),m=L(m,k,g,E,C[R+10],17,-42063),E=L(E,m,k,g,C[R+11],22,-1990404162),g=L(g,E,m,k,C[R+12],7,1804603682),k=L(k,g,E,m,C[R+13],12,-40341101),m=L(m,k,g,E,C[R+14],17,-1502002290),g=P(g,E=L(E,m,k,g,C[R+15],22,1236535329),m,k,C[R+1],5,-165796510),k=P(k,g,E,m,C[R+6],9,-1069501632),m=P(m,k,g,E,C[R+11],14,643717713),E=P(E,m,k,g,C[R+0],20,-373897302),g=P(g,E,m,k,C[R+5],5,-701558691),k=P(k,g,E,m,C[R+10],9,38016083),m=P(m,k,g,E,C[R+15],14,-660478335),E=P(E,m,k,g,C[R+4],20,-405537848),g=P(g,E,m,k,C[R+9],5,568446438),k=P(k,g,E,m,C[R+14],9,-1019803690),m=P(m,k,g,E,C[R+3],14,-187363961),E=P(E,m,k,g,C[R+8],20,1163531501),g=P(g,E,m,k,C[R+13],5,-1444681467),k=P(k,g,E,m,C[R+2],9,-51403784),m=P(m,k,g,E,C[R+7],14,1735328473),g=V(g,E=P(E,m,k,g,C[R+12],20,-1926607734),m,k,C[R+5],4,-378558),k=V(k,g,E,m,C[R+8],11,-2022574463),m=V(m,k,g,E,C[R+11],16,1839030562),E=V(E,m,k,g,C[R+14],23,-35309556),g=V(g,E,m,k,C[R+1],4,-1530992060),k=V(k,g,E,m,C[R+4],11,1272893353),m=V(m,k,g,E,C[R+7],16,-155497632),E=V(E,m,k,g,C[R+10],23,-1094730640),g=V(g,E,m,k,C[R+13],4,681279174),k=V(k,g,E,m,C[R+0],11,-358537222),m=V(m,k,g,E,C[R+3],16,-722521979),E=V(E,m,k,g,C[R+6],23,76029189),g=V(g,E,m,k,C[R+9],4,-640364487),k=V(k,g,E,m,C[R+12],11,-421815835),m=V(m,k,g,E,C[R+15],16,530742520),g=F(g,E=V(E,m,k,g,C[R+2],23,-995338651),m,k,C[R+0],6,-198630844),k=F(k,g,E,m,C[R+7],10,1126891415),m=F(m,k,g,E,C[R+14],15,-1416354905),E=F(E,m,k,g,C[R+5],21,-57434055),g=F(g,E,m,k,C[R+12],6,1700485571),k=F(k,g,E,m,C[R+3],10,-1894986606),m=F(m,k,g,E,C[R+10],15,-1051523),E=F(E,m,k,g,C[R+1],21,-2054922799),g=F(g,E,m,k,C[R+8],6,1873313359),k=F(k,g,E,m,C[R+15],10,-30611744),m=F(m,k,g,E,C[R+6],15,-1560198380),E=F(E,m,k,g,C[R+13],21,1309151649),g=F(g,E,m,k,C[R+4],6,-145523070),k=F(k,g,E,m,C[R+11],10,-1120210379),m=F(m,k,g,E,C[R+2],15,718787259),E=F(E,m,k,g,C[R+9],21,-343485551),g=oe(g,j),E=oe(E,re),m=oe(m,le),k=oe(k,Q)}return Array(g,E,m,k)}function x(C,w,g,E,m,k){return oe((w=oe(oe(w,C),oe(E,k)))<<m|w>>>32-m,g)}function L(C,w,g,E,m,k,R){return x(w&g|~w&E,C,w,m,k,R)}function P(C,w,g,E,m,k,R){return x(w&E|g&~E,C,w,m,k,R)}function V(C,w,g,E,m,k,R){return x(w^g^E,C,w,m,k,R)}function F(C,w,g,E,m,k,R){return x(g^(w|~E),C,w,m,k,R)}function oe(C,w){var g=(65535&C)+(65535&w);return(C>>16)+(w>>16)+(g>>16)<<16|65535&g}i.exports=function(C){return T.hash(C,$,16)}}).call(this,t("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},t("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/crypto-browserify/md5.js","/node_modules/gulp-browserify/node_modules/crypto-browserify")},{"./helpers":4,buffer:3,lYpoI2:11}],7:[function(t,i,o){(function(r,a,u,h,y,O,D,M,A){i.exports=function(T){for(var $,x=new Array(T),L=0;L<T;L++)!(3&L)&&($=4294967296*Math.random()),x[L]=$>>>((3&L)<<3)&255;return x}}).call(this,t("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},t("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/crypto-browserify/rng.js","/node_modules/gulp-browserify/node_modules/crypto-browserify")},{buffer:3,lYpoI2:11}],8:[function(t,i,o){(function(r,a,u,h,y,O,D,M,A){var T=t("./helpers");function $(P,V){P[V>>5]|=128<<24-V%32,P[15+(V+64>>9<<4)]=V;for(var F,oe,C,w=Array(80),g=1732584193,E=-271733879,m=-1732584194,k=271733878,R=-1009589776,j=0;j<P.length;j+=16){for(var re=g,le=E,Q=m,we=k,De=R,Se=0;Se<80;Se++){w[Se]=Se<16?P[j+Se]:L(w[Se-3]^w[Se-8]^w[Se-14]^w[Se-16],1);var J=x(x(L(g,5),(J=E,oe=m,C=k,(F=Se)<20?J&oe|~J&C:!(F<40)&&F<60?J&oe|J&C|oe&C:J^oe^C)),x(x(R,w[Se]),(F=Se)<20?1518500249:F<40?1859775393:F<60?-1894007588:-899497514)),R=k,k=m,m=L(E,30),E=g,g=J}g=x(g,re),E=x(E,le),m=x(m,Q),k=x(k,we),R=x(R,De)}return Array(g,E,m,k,R)}function x(P,V){var F=(65535&P)+(65535&V);return(P>>16)+(V>>16)+(F>>16)<<16|65535&F}function L(P,V){return P<<V|P>>>32-V}i.exports=function(P){return T.hash(P,$,20,!0)}}).call(this,t("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},t("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/crypto-browserify/sha.js","/node_modules/gulp-browserify/node_modules/crypto-browserify")},{"./helpers":4,buffer:3,lYpoI2:11}],9:[function(t,i,o){(function(r,a,u,h,y,O,D,M,A){function T(V,F){var oe=(65535&V)+(65535&F);return(V>>16)+(F>>16)+(oe>>16)<<16|65535&oe}function $(V,F){var oe,C=new Array(1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298),w=new Array(1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225),g=new Array(64);V[F>>5]|=128<<24-F%32,V[15+(F+64>>9<<4)]=F;for(var E,m,k=0;k<V.length;k+=16){for(var R=w[0],j=w[1],re=w[2],le=w[3],Q=w[4],we=w[5],De=w[6],Se=w[7],J=0;J<64;J++)g[J]=J<16?V[J+k]:T(T(T((m=g[J-2],L(m,17)^L(m,19)^P(m,10)),g[J-7]),(m=g[J-15],L(m,7)^L(m,18)^P(m,3))),g[J-16]),oe=T(T(T(T(Se,L(m=Q,6)^L(m,11)^L(m,25)),Q&we^~Q&De),C[J]),g[J]),E=T(L(E=R,2)^L(E,13)^L(E,22),R&j^R&re^j&re),Se=De,De=we,we=Q,Q=T(le,oe),le=re,re=j,j=R,R=T(oe,E);w[0]=T(R,w[0]),w[1]=T(j,w[1]),w[2]=T(re,w[2]),w[3]=T(le,w[3]),w[4]=T(Q,w[4]),w[5]=T(we,w[5]),w[6]=T(De,w[6]),w[7]=T(Se,w[7])}return w}var x=t("./helpers"),L=function(V,F){return V>>>F|V<<32-F},P=function(V,F){return V>>>F};i.exports=function(V){return x.hash(V,$,32,!0)}}).call(this,t("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},t("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/crypto-browserify/sha256.js","/node_modules/gulp-browserify/node_modules/crypto-browserify")},{"./helpers":4,buffer:3,lYpoI2:11}],10:[function(t,i,o){(function(r,a,u,h,y,O,D,M,A){o.read=function(T,$,x,L,k){var V,F,oe=8*k-L-1,C=(1<<oe)-1,w=C>>1,g=-7,E=x?k-1:0,m=x?-1:1,k=T[$+E];for(E+=m,V=k&(1<<-g)-1,k>>=-g,g+=oe;0<g;V=256*V+T[$+E],E+=m,g-=8);for(F=V&(1<<-g)-1,V>>=-g,g+=L;0<g;F=256*F+T[$+E],E+=m,g-=8);if(V===0)V=1-w;else{if(V===C)return F?NaN:1/0*(k?-1:1);F+=Math.pow(2,L),V-=w}return(k?-1:1)*F*Math.pow(2,V-L)},o.write=function(T,$,x,L,P,R){var F,oe,C=8*R-P-1,w=(1<<C)-1,g=w>>1,E=P===23?Math.pow(2,-24)-Math.pow(2,-77):0,m=L?0:R-1,k=L?1:-1,R=$<0||$===0&&1/$<0?1:0;for($=Math.abs($),isNaN($)||$===1/0?(oe=isNaN($)?1:0,F=w):(F=Math.floor(Math.log($)/Math.LN2),$*(L=Math.pow(2,-F))<1&&(F--,L*=2),2<=($+=1<=F+g?E/L:E*Math.pow(2,1-g))*L&&(F++,L/=2),w<=F+g?(oe=0,F=w):1<=F+g?(oe=($*L-1)*Math.pow(2,P),F+=g):(oe=$*Math.pow(2,g-1)*Math.pow(2,P),F=0));8<=P;T[x+m]=255&oe,m+=k,oe/=256,P-=8);for(F=F<<P|oe,C+=P;0<C;T[x+m]=255&F,m+=k,F/=256,C-=8);T[x+m-k]|=128*R}}).call(this,t("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},t("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/ieee754/index.js","/node_modules/gulp-browserify/node_modules/ieee754")},{buffer:3,lYpoI2:11}],11:[function(t,i,o){(function(r,a,u,h,y,O,D,M,A){var T,$,x;function L(){}(r=i.exports={}).nextTick=($=typeof window<"u"&&window.setImmediate,x=typeof window<"u"&&window.postMessage&&window.addEventListener,$?function(P){return window.setImmediate(P)}:x?(T=[],window.addEventListener("message",function(P){var V=P.source;V!==window&&V!==null||P.data!=="process-tick"||(P.stopPropagation(),0<T.length&&T.shift()())},!0),function(P){T.push(P),window.postMessage("process-tick","*")}):function(P){setTimeout(P,0)}),r.title="browser",r.browser=!0,r.env={},r.argv=[],r.on=L,r.addListener=L,r.once=L,r.off=L,r.removeListener=L,r.removeAllListeners=L,r.emit=L,r.binding=function(P){throw new Error("process.binding is not supported")},r.cwd=function(){return"/"},r.chdir=function(P){throw new Error("process.chdir is not supported")}}).call(this,t("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},t("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/process/browser.js","/node_modules/gulp-browserify/node_modules/process")},{buffer:3,lYpoI2:11}]},{},[1])(1)})})(po);var Ma=po.exports;const qt=Wn(Ma);class $a{cache;useHash;constructor(e){this.cache={},this.useHash=e}cacheValue(e,t){this.cache[this.useHash?qt(e):String(e)]=t}deleteValue(e){delete this.cache[this.useHash?qt(e):String(e)]}getValue(e){return this.cache[this.useHash?qt(e):String(e)]}isCached(e){return(this.useHash?qt(e):String(e))in this.cache}invalidate(e){e&&Object.entries(this.cache).forEach(([t,i])=>e(t,i)),this.cache={}}}function Pa(){return new Worker("/assets/worker-b3cb1e7d.js",{type:"module"})}class Ne{static PLAYER="PLAYER";static PARTY="PARTY";static SCENEITEMS="SCENEITEMS";static SCENELOCAL="SCENELOCAL";static SCENEMETA="SCENEMETADATA";static SCENEGRID="SCENEGRID";static SCENEFOG="SCENEFOG";static ROOMMETA="ROOMMETADATA";playerId;playerColor;playerName;playerMetadata;playerRole;party;lastParty;fogFilled;fogColor;fogStroke;gridDpi;gridScale;gridSnap;gridType;storedMetaItems;baseMELDepth;sceneItems;sceneLocal;sceneSelected;sceneMetadata;sceneReady;sceneInitialized;roomMetadata;theme;caches;playerShadowCache;localGhosts;snap;torchActive;previousVisionShapes;previousAutohideItems;previousPlayersWithVision;previousSize=[];previousVisionEnabled;previousMap;previousAutodetectEnabled;previousFowEnabled;previousPersistenceEnabled;previousFowColor;busy;workers;workersSetup;toolStarted;sceneMetadataHandler;sceneItemsHandler;sceneLocalHandler;sceneGridHandler;sceneReadyHandler;playerHandler;partyHandler;themeHandler;roomHandler;fogHandler;constructor(e){this.playerId="",this.playerName="",this.playerColor="",this.playerMetadata={},this.playerRole="PLAYER",this.party=[],this.lastParty=[],this.fogFilled=!1,this.fogColor="#000",this.fogStroke=5,this.storedMetaItems=[],this.sceneItems=[],this.sceneLocal=[],this.sceneSelected=[],this.sceneMetadata={},this.gridDpi=0,this.gridScale=5,this.gridSnap=10,this.gridType="ft",this.sceneReady=!1,this.sceneInitialized=!1,this.theme="DARK",this.roomMetadata={},this.localGhosts=[],this.snap=!1,this.busy=!1,this.torchActive=!1,this.toolStarted=!1,this.baseMELDepth=0,this.caches=e,this.playerShadowCache=new $a(!1),this.previousVisionShapes="",this.previousAutohideItems="",this.previousPlayersWithVision="",this.previousSize=[],this.previousVisionEnabled=!1,this.previousMap="",this.previousAutodetectEnabled=!1,this.previousFowEnabled=!1,this.previousPersistenceEnabled=!1,this.previousFowColor="",this.workers=[],this.workersSetup=!1}async RefreshCache(){if(this.caches.includes(Ne.PLAYER)&&(this.playerId=await b.player.getId(),this.playerName=await b.player.getName(),this.playerColor=await b.player.getColor(),this.playerMetadata=await b.player.getMetadata(),this.playerRole=await b.player.getRole()),this.caches.includes(Ne.PARTY)&&(this.party=await b.party.getPlayers()),this.caches.includes(Ne.SCENEFOG)&&this.sceneReady&&(this.fogColor=await b.scene.fog.getColor(),this.fogFilled=await b.scene.fog.getFilled()),this.caches.includes(Ne.SCENEITEMS)&&this.sceneReady&&(this.sceneItems=await b.scene.items.getItems(),this.sceneLocal=await b.scene.local.getItems()),this.caches.includes(Ne.SCENEMETA)&&this.sceneReady){this.sceneMetadata=await b.scene.getMetadata();const e=this.sceneMetadata[`${c.EXTENSIONID}/stored`];e&&(this.storedMetaItems=e)}if(this.caches.includes(Ne.SCENEGRID)&&this.sceneReady){this.gridDpi=await b.scene.grid.getDpi();const e=await b.scene.grid.getScale();this.gridScale=e.parsed?.multiplier??5,this.gridType=e.parsed.unit}this.caches.includes(Ne.ROOMMETA)&&this.sceneReady&&(this.roomMetadata=await b.room.getMetadata())}async InitializeCache(){if(this.CreateWorkers(),this.sceneReady=await b.scene.isReady(),this.theme=await b.theme.getTheme(),wi(this.theme,document),this.caches.includes(Ne.PLAYER)&&(this.playerId=await b.player.getId(),this.playerName=await b.player.getName(),this.playerColor=await b.player.getColor(),this.playerMetadata=await b.player.getMetadata(),this.playerRole=await b.player.getRole()),this.caches.includes(Ne.PARTY)&&(this.party=await b.party.getPlayers()),this.caches.includes(Ne.SCENEFOG)&&this.sceneReady&&(this.fogColor=await b.scene.fog.getColor(),this.fogFilled=await b.scene.fog.getFilled()),this.caches.includes(Ne.SCENEITEMS)&&this.sceneReady&&(this.sceneItems=await b.scene.items.getItems(),this.sceneLocal=await b.scene.local.getItems()),this.caches.includes(Ne.SCENEMETA)&&this.sceneReady){this.sceneMetadata=await b.scene.getMetadata();const e=this.sceneMetadata[`${c.EXTENSIONID}/stored`];e&&(this.storedMetaItems=e)}if(this.caches.includes(Ne.SCENEGRID)&&this.sceneReady){this.gridDpi=await b.scene.grid.getDpi();const e=await b.scene.grid.getScale();this.gridScale=e.parsed?.multiplier??5,this.gridType=e.parsed.unit}this.caches.includes(Ne.ROOMMETA)&&this.sceneReady&&(this.roomMetadata=await b.room.getMetadata()),b.broadcast.onMessage(c.RESETID,async e=>{e.data&&await Z.ResetPersistence()}),b.broadcast.onMessage(`${c.EXTENSIONID}/ELEVATIONEVENT`,e=>{switch(e.data){case"CANCEL":Jn();break;case"FINISH":co();break;case"UNDO":uo();break}}),b.broadcast.onMessage(`${c.EXTENSIONID}/LINEEVENT`,e=>{switch(e.data){case"CANCEL":Bn();break;case"FINISH":Vn();break;case"UNDO":io();break}}),b.broadcast.onMessage(`${c.EXTENSIONID}/POLYGONEVENT`,e=>{switch(e.data){case"CANCEL":Hn();break;case"FINISH":Un();break;case"UNDO":ro();break}}),await this.SaveUserToScene()}CreateWorkers(){const t=Math.min(navigator.hardwareConcurrency??1,16);for(let i=0;i<t;i++){const o=new Pa;this.workers.push(o)}}async SaveUserToScene(){await b.scene.setMetadata({[`${c.EXTENSIONID}/USER-${this.playerId}`]:{role:this.playerRole,name:this.playerName,color:this.playerColor}})}KillHandlers(){this.caches.includes(Ne.SCENEMETA)&&this.sceneMetadataHandler!==void 0&&this.sceneMetadataHandler(),this.caches.includes(Ne.SCENEITEMS)&&this.sceneItemsHandler!==void 0&&this.sceneItemsHandler(),this.caches.includes(Ne.SCENEITEMS)&&this.sceneLocalHandler!==void 0&&this.sceneLocalHandler(),this.caches.includes(Ne.SCENEGRID)&&this.sceneGridHandler!==void 0&&this.sceneGridHandler(),this.caches.includes(Ne.PLAYER)&&this.playerHandler!==void 0&&this.playerHandler(),this.caches.includes(Ne.PARTY)&&this.partyHandler!==void 0&&this.partyHandler(),this.caches.includes(Ne.ROOMMETA)&&this.roomHandler!==void 0&&this.roomHandler(),this.caches.includes(Ne.SCENEFOG)&&this.fogHandler!==void 0&&this.fogHandler(),this.themeHandler!==void 0&&this.themeHandler()}SetupHandlers(){(this.sceneMetadataHandler===void 0||this.sceneMetadataHandler.length===0)&&this.caches.includes(Ne.SCENEMETA)&&(this.sceneMetadataHandler=b.scene.onMetadataChange(async e=>{this.sceneMetadata=e,await this.OnSceneMetadataChanges(e)})),(this.sceneItemsHandler===void 0||this.sceneItemsHandler.length===0)&&this.caches.includes(Ne.SCENEITEMS)&&(this.sceneItemsHandler=b.scene.items.onChange(async e=>{this.sceneItems=e,await this.OnSceneItemsChange(e)}),this.sceneLocalHandler=b.scene.local.onChange(async e=>{this.sceneLocal=e,await this.OnSceneLocalChange(e)})),(this.sceneGridHandler===void 0||this.sceneGridHandler.length===0)&&this.caches.includes(Ne.SCENEGRID)&&(this.sceneGridHandler=b.scene.grid.onChange(async e=>{await this.OnSceneGridChange(e),this.gridDpi=e.dpi,this.gridScale=parseInt(e.scale)})),(this.playerHandler===void 0||this.playerHandler.length===0)&&this.caches.includes(Ne.PLAYER)&&(this.playerHandler=b.player.onChange(async e=>{const t=this.playerRole;let i=!1;(this.playerName!==e.name||this.playerColor!==e.color||this.playerRole!==e.role)&&(i=!0),this.playerName=e.name,this.playerColor=e.color,this.playerId=e.id,this.playerRole=e.role,this.playerMetadata=e.metadata,await this.OnPlayerChange(e,t),i&&await this.SaveUserToScene()})),(this.partyHandler===void 0||this.partyHandler.length===0)&&this.caches.includes(Ne.PARTY)&&(this.partyHandler=b.party.onChange(async e=>{this.party=e.filter(t=>t.id!==""),await this.OnPartyChange(e)})),(this.roomHandler===void 0||this.roomHandler.length===0)&&this.caches.includes(Ne.ROOMMETA)&&(this.roomHandler=b.room.onMetadataChange(async e=>{await this.OnRoomMetadataChange(e),this.roomMetadata=e})),(this.fogHandler===void 0||this.fogHandler.length===0)&&this.caches.includes(Ne.ROOMMETA)&&(this.fogHandler=b.scene.fog.onChange(async e=>{await this.OnFogChange(e),this.fogColor=e.style.color,this.fogFilled=e.filled})),this.themeHandler===void 0&&(this.themeHandler=b.theme.onChange(async e=>{this.theme=e.mode,await this.OnThemeChange(e)})),this.sceneReadyHandler===void 0&&(this.sceneReadyHandler=b.scene.onReadyChange(async e=>{this.sceneReady=e,e?(await this.SaveUserToScene(),await this.RefreshCache()):(dt.ClearGhostList(),this.KillHandlers(),this.toolStarted=!1,await b.tool.setMetadata(`${c.EXTENSIONID}/vision-tool`,{[`${c.EXTENSIONID}/elevationEditor`]:!1}),this.sceneItems=[],this.sceneMetadata={}),await this.OnSceneReadyChange(e)}))}async OnSceneMetadataChanges(e){this.baseMELDepth=e[`${c.EXTENSIONID}/defaultMELDepth`]??0,this.playerRole==="GM"&&await $n(),await Tt()}async OnSceneItemsChange(e){this.playerRole==="GM"?(await Z.UpdateUI(),await Pn(Z.mapAlign)):Z.UpdatePlayerVisionList(),await Tt()}async OnSceneLocalChange(e){dt.debouncedLocalChanges(p.sceneLocal)}async OnSceneGridChange(e){await Tt()}async OnSceneReadyChange(e){e?(await Fn(),this.SetupHandlers(),await Tt(),this.playerRole==="GM"&&await $n()):this.playerRole==="GM"&&(this.sceneInitialized=!1,await Z.UpdateUI())}async OnPlayerChange(e,t){this.playerRole!==t&&(await Z.SoftReset(),e.role==="GM"?(await b.action.setHeight(510),await b.action.setWidth(420)):Z.UpdatePlayerVisionList());const i=document.querySelectorAll(".token-table-entry");for(let y of i){let O=y.id.substring(3);e.selection!==void 0&&e.selection.includes(O)?y.classList.add("token-table-selected"):y.classList.remove("token-table-selected")}e.selection!==void 0&&e.selection.length===1&&Yo(e.selection[0]);const o=e.metadata;(o[`${c.EXTENSIONID}/finishLine`]??!1)===!0&&Vn(),(o[`${c.EXTENSIONID}/cancelLine`]??!1)===!0&&Bn(),(o[`${c.EXTENSIONID}/finishPoly`]??!1)===!0&&Un(),(o[`${c.EXTENSIONID}/cancelPoly`]??!1)===!0&&Hn()}async OnPartyChange(e){if(this.playerRole!=="PLAYER"){const t=document.getElementById("playerListing");t.innerHTML="",t.appendChild(Z.GetEmptyContextItem());for(const i of this.party){const o=document.createElement("li");o.id=i.id,o.textContent=i.name,o.style.color=i.color,t.appendChild(o)}dt.UpdateSpectreTargets(),Z.UpdatePlayerProcessUI()}}async OnFogChange(e){}async OnRoomMetadataChange(e){}async OnThemeChange(e){wi(e,document)}async ToggleBusy(e){await b.action.setBadgeText(e?"⏱️":void 0),p.busy=e}}const p=new Ne([Ne.SCENEITEMS,Ne.SCENEMETA,Ne.SCENEFOG,Ne.SCENEGRID,Ne.PLAYER,Ne.PARTY]);function La(n){return n.layer=="MAP"&&(n.metadata[`${c.EXTENSIONID}/isBackgroundImage`]||n.metadata[`${c.ARMINDOID}/isBackgroundImage`])}function At(n){return n.metadata[`${c.EXTENSIONID}/isVisionFog`]||n.metadata[`${c.ARMINDOID}/isVisionFog`]}function Ra(n){return n.metadata[`${c.EXTENSIONID}/isIndicatorRing`]||n.metadata[`${c.ARMINDOID}/isIndicatorRing`]}function Pi(n){return n.metadata[`${c.EXTENSIONID}/isVisionLine`]||n.metadata[`${c.ARMINDOID}/isVisionLine`]}function Xa(n){return n.metadata[`${c.EXTENSIONID}/isVisionLine`]&&!n.metadata[`${c.EXTENSIONID}/disabled`]||n.metadata[`${c.ARMINDOID}/isVisionLine`]&&!n.metadata[`${c.ARMINDOID}/disabled`]}function go(n){return(n.layer==="CHARACTER"||n.layer==="MOUNT"||n.layer==="ATTACHMENT"||n.layer==="PROP")&&(n.metadata[`${c.EXTENSIONID}/hasVision`]||n.metadata[`${c.ARMINDOID}/hasVision`])}function Li(n){return(n.layer==="CHARACTER"||n.layer==="MOUNT"||n.layer==="ATTACHMENT"||n.layer==="PROP")&&(n.metadata[`${c.EXTENSIONID}/hasVision`]||n.metadata[`${c.ARMINDOID}/hasVision`])&&!n.metadata[`${c.EXTENSIONID}/visionBlind`]}function Fa(n){return(n.layer==="CHARACTER"||n.layer==="MOUNT"||n.layer==="ATTACHMENT"||n.layer==="PROP")&&n.createdUserId==p.playerId&&(n.metadata[`${c.EXTENSIONID}/hasVision`]||n.metadata[`${c.ARMINDOID}/hasVision`])&&!n.metadata[`${c.EXTENSIONID}/visionBlind`]}function mo(n){return(n.layer==="DRAWING"||n.layer==="MAP")&&(n.metadata[`${c.EXTENSIONID}/isBackgroundImage`]||n.metadata[`${c.ARMINDOID}/isBackgroundImage`])}function Zt(n){return n.metadata[`${c.EXTENSIONID}/isTrailingFog`]}function Gn(n){return n.metadata[`${c.EXTENSIONID}/isTrailingFog`]||n.metadata[`${c.EXTENSIONID}/isVisionFog`]||n.metadata[`${c.ARMINDOID}/isVisionFog`]||n.metadata[`${c.EXTENSIONID}/isIndicatorRing`]}function Ba(n){return n.metadata[`${c.EXTENSIONID}/isBrushSquare`]}function St(n){return n.metadata[`${c.EXTENSIONID}/visionTorch`]}function Ri(n){return(n.layer==="CHARACTER"||n.layer==="MOUNT"||n.layer==="ATTACHMENT"||n.layer==="PROP")&&!go(n)&&n.metadata[`${c.EXTENSIONID}/hasAutohide`]===!0}var rt=function(){/*!
* Copyright (c) 2021-2023 Momo Bassit.
* Licensed under the MIT License (MIT)
* https://github.com/mdbassit/Coloris
* Version: 0.21.1
* NPM: https://github.com/melloware/coloris-npm
*/return function(n,e,t,i){var o=e.createElement("canvas").getContext("2d"),r={r:0,g:0,b:0,h:0,s:0,v:0,a:1},a,u,h,y,O,D,M,A,T,$,x,L,P,V,F,oe,C={},w={el:"[data-coloris]",parent:"body",theme:"default",themeMode:"light",rtl:!1,wrap:!0,margin:2,format:"hex",formatToggle:!1,swatches:[],swatchesOnly:!1,alpha:!0,forceAlpha:!1,focusInput:!0,selectInput:!1,inline:!1,defaultColor:"#000000",clearButton:!1,clearLabel:"Clear",closeButton:!1,closeLabel:"Close",onChange:function(){return i},a11y:{open:"Open color picker",close:"Close color picker",clear:"Clear the selected color",marker:"Saturation: {s}. Brightness: {v}.",hueSlider:"Hue slider",alphaSlider:"Opacity slider",input:"Color value field",format:"Color format",swatch:"Color swatch",instruction:"Saturation and brightness selector. Use up, down, left and right arrow keys to select."}},g={},E="",m={},k=!1;function R(S){if(typeof S=="object"){var B=function(){switch(q){case"el":we(S.el),S.wrap!==!1&&Se(S.el);break;case"parent":a=e.querySelector(S.parent),a&&(a.appendChild(u),w.parent=S.parent,a===e.body&&(a=i));break;case"themeMode":w.themeMode=S.themeMode,S.themeMode==="auto"&&n.matchMedia&&n.matchMedia("(prefers-color-scheme: dark)").matches&&(w.themeMode="dark");case"theme":S.theme&&(w.theme=S.theme),u.className="clr-picker clr-"+w.theme+" clr-"+w.themeMode,w.inline&&De();break;case"rtl":w.rtl=!!S.rtl,e.querySelectorAll(".clr-field").forEach(function(Ge){return Ge.classList.toggle("clr-rtl",w.rtl)});break;case"margin":S.margin*=1,w.margin=isNaN(S.margin)?w.margin:S.margin;break;case"wrap":S.el&&S.wrap&&Se(S.el);break;case"formatToggle":w.formatToggle=!!S.formatToggle,ve("clr-format").style.display=w.formatToggle?"block":"none",w.formatToggle&&(w.format="auto");break;case"swatches":if(Array.isArray(S.swatches)){var ae=[];S.swatches.forEach(function(Ge,ke){ae.push('<button type="button" id="clr-swatch-'+ke+'" aria-labelledby="clr-swatch-label clr-swatch-'+ke+'" style="color: '+Ge+';">'+Ge+"</button>")}),ve("clr-swatches").innerHTML=ae.length?"<div>"+ae.join("")+"</div>":"",w.swatches=S.swatches.slice()}break;case"swatchesOnly":w.swatchesOnly=!!S.swatchesOnly,u.setAttribute("data-minimal",w.swatchesOnly);break;case"alpha":w.alpha=!!S.alpha,u.setAttribute("data-alpha",w.alpha);break;case"inline":if(w.inline=!!S.inline,u.setAttribute("data-inline",w.inline),w.inline){var he=S.defaultColor||w.defaultColor;V=Ie(he),De(),se(he)}break;case"clearButton":typeof S.clearButton=="object"&&(S.clearButton.label&&(w.clearLabel=S.clearButton.label,M.innerHTML=w.clearLabel),S.clearButton=S.clearButton.show),w.clearButton=!!S.clearButton,M.style.display=w.clearButton?"block":"none";break;case"clearLabel":w.clearLabel=S.clearLabel,M.innerHTML=w.clearLabel;break;case"closeButton":w.closeButton=!!S.closeButton,w.closeButton?u.insertBefore(A,O):O.appendChild(A);break;case"closeLabel":w.closeLabel=S.closeLabel,A.innerHTML=w.closeLabel;break;case"a11y":var pe=S.a11y,$e=!1;if(typeof pe=="object")for(var be in pe)pe[be]&&w.a11y[be]&&(w.a11y[be]=pe[be],$e=!0);if($e){var Ue=ve("clr-open-label"),xe=ve("clr-swatch-label");Ue.innerHTML=w.a11y.open,xe.innerHTML=w.a11y.swatch,A.setAttribute("aria-label",w.a11y.close),M.setAttribute("aria-label",w.a11y.clear),T.setAttribute("aria-label",w.a11y.hueSlider),x.setAttribute("aria-label",w.a11y.alphaSlider),D.setAttribute("aria-label",w.a11y.input),h.setAttribute("aria-label",w.a11y.instruction)}break;default:w[q]=S[q]}};for(var q in S)B()}}function j(S,B){typeof S=="string"&&typeof B=="object"&&(g[S]=B,k=!0)}function re(S){delete g[S],Object.keys(g).length===0&&(k=!1,S===E&&Q())}function le(S){if(k){var B=["el","wrap","rtl","inline","defaultColor","a11y"],q=function(){var pe=g[ie];if(S.matches(ie)){E=ie,m={},B.forEach(function(be){return delete pe[be]});for(var $e in pe)m[$e]=Array.isArray(w[$e])?w[$e].slice():w[$e];return R(pe),"break"}};for(var ie in g){var ae=q();if(ae==="break")break}}}function Q(){Object.keys(m).length>0&&(R(m),E="",m={})}function we(S){Oe(e,"click",S,function(B){w.inline||(le(B.target),P=B.target,F=P.value,V=Ie(F),u.classList.add("clr-open"),De(),se(F),(w.focusInput||w.selectInput)&&(D.focus({preventScroll:!0}),D.setSelectionRange(P.selectionStart,P.selectionEnd)),w.selectInput&&D.select(),(oe||w.swatchesOnly)&&Me().shift().focus(),P.dispatchEvent(new Event("open",{bubbles:!0})))}),Oe(e,"input",S,function(B){var q=B.target.parentNode;q.classList.contains("clr-field")&&(q.style.color=B.target.value)})}function De(){if(!(!u||!P&&!w.inline)){var S=a,B=n.scrollY,q=u.offsetWidth,ie=u.offsetHeight,ae={left:!1,top:!1},he,pe,$e,be={x:0,y:0};if(S&&(he=n.getComputedStyle(S),pe=parseFloat(he.marginTop),$e=parseFloat(he.borderTopWidth),be=S.getBoundingClientRect(),be.y+=$e+B),!w.inline){var Ue=P.getBoundingClientRect(),xe=Ue.x,Ge=B+Ue.y+Ue.height+w.margin;S?(xe-=be.x,Ge-=be.y,xe+q>S.clientWidth&&(xe+=Ue.width-q,ae.left=!0),Ge+ie>S.clientHeight-pe&&ie+w.margin<=Ue.top-(be.y-B)&&(Ge-=Ue.height+ie+w.margin*2,ae.top=!0),Ge+=S.scrollTop):(xe+q>e.documentElement.clientWidth&&(xe+=Ue.width-q,ae.left=!0),Ge+ie-B>e.documentElement.clientHeight&&ie+w.margin<=Ue.top&&(Ge=B+Ue.y-ie-w.margin,ae.top=!0)),u.classList.toggle("clr-left",ae.left),u.classList.toggle("clr-top",ae.top),u.style.left=xe+"px",u.style.top=Ge+"px",be.x+=u.offsetLeft,be.y+=u.offsetTop}C={width:h.offsetWidth,height:h.offsetHeight,x:h.offsetLeft+be.x,y:h.offsetTop+be.y}}}function Se(S){e.querySelectorAll(S).forEach(function(B){var q=B.parentNode;if(!q.classList.contains("clr-field")){var ie=e.createElement("div"),ae="clr-field";(w.rtl||B.classList.contains("clr-rtl"))&&(ae+=" clr-rtl"),ie.innerHTML='<button type="button" aria-labelledby="clr-open-label"></button>',q.insertBefore(ie,B),ie.setAttribute("class",ae),ie.style.color=B.value,ie.appendChild(B)}})}function J(S){if(P&&!w.inline){var B=P;S&&(P=i,F!==B.value&&(B.value=F,B.dispatchEvent(new Event("input",{bubbles:!0})))),setTimeout(function(){F!==B.value&&B.dispatchEvent(new Event("change",{bubbles:!0}))}),u.classList.remove("clr-open"),k&&Q(),B.dispatchEvent(new Event("close",{bubbles:!0})),w.focusInput&&B.focus({preventScroll:!0}),P=i}}function se(S){var B=Ce(S),q=ue(B);fe(q.s,q.v),I(B,q),T.value=q.h,u.style.color="hsl("+q.h+", 100%, 50%)",$.style.left=q.h/360*100+"%",y.style.left=C.width*q.s/100+"px",y.style.top=C.height-C.height*q.v/100+"px",x.value=q.a*100,L.style.left=q.a*100+"%"}function Ie(S){var B=S.substring(0,3).toLowerCase();return B==="rgb"||B==="hsl"?B:"hex"}function me(S){S=S!==i?S:D.value,P&&(P.value=S,P.dispatchEvent(new Event("input",{bubbles:!0}))),w.onChange&&w.onChange.call(n,S,P),e.dispatchEvent(new CustomEvent("coloris:pick",{detail:{color:S,currentEl:P}}))}function de(S,B){var q={h:T.value*1,s:S/C.width*100,v:100-B/C.height*100,a:x.value/100},ie=G(q);fe(q.s,q.v),I(ie,q),me()}function fe(S,B){var q=w.a11y.marker;S=S.toFixed(1)*1,B=B.toFixed(1)*1,q=q.replace("{s}",S),q=q.replace("{v}",B),y.setAttribute("aria-label",q)}function ye(S){return{pageX:S.changedTouches?S.changedTouches[0].pageX:S.pageX,pageY:S.changedTouches?S.changedTouches[0].pageY:S.pageY}}function Te(S){var B=ye(S),q=B.pageX-C.x,ie=B.pageY-C.y;a&&(ie+=a.scrollTop),f(q,ie),S.preventDefault(),S.stopPropagation()}function K(S,B){var q=y.style.left.replace("px","")*1+S,ie=y.style.top.replace("px","")*1+B;f(q,ie)}function f(S,B){S=S<0?0:S>C.width?C.width:S,B=B<0?0:B>C.height?C.height:B,y.style.left=S+"px",y.style.top=B+"px",de(S,B),y.focus()}function I(S,B){S===void 0&&(S={}),B===void 0&&(B={});var q=w.format;for(var ie in S)r[ie]=S[ie];for(var ae in B)r[ae]=B[ae];var he=Ee(r),pe=he.substring(0,7);switch(y.style.color=pe,L.parentNode.style.color=pe,L.style.color=he,O.style.color=he,h.style.display="none",h.offsetHeight,h.style.display="",L.nextElementSibling.style.display="none",L.nextElementSibling.offsetHeight,L.nextElementSibling.style.display="",q==="mixed"?q=r.a===1?"hex":"rgb":q==="auto"&&(q=V),q){case"hex":D.value=he;break;case"rgb":D.value=He(r);break;case"hsl":D.value=Fe(H(r));break}e.querySelector('.clr-format [value="'+q+'"]').checked=!0}function N(){var S=T.value*1,B=y.style.left.replace("px","")*1,q=y.style.top.replace("px","")*1;u.style.color="hsl("+S+", 100%, 50%)",$.style.left=S/360*100+"%",de(B,q)}function W(){var S=x.value/100;L.style.left=S*100+"%",I({a:S}),me()}function G(S){var B=S.s/100,q=S.v/100,ie=B*q,ae=S.h/60,he=ie*(1-t.abs(ae%2-1)),pe=q-ie;ie=ie+pe,he=he+pe;var $e=t.floor(ae)%6,be=[ie,he,pe,pe,he,ie][$e],Ue=[he,ie,ie,he,pe,pe][$e],xe=[pe,pe,he,ie,ie,he][$e];return{r:t.round(be*255),g:t.round(Ue*255),b:t.round(xe*255),a:S.a}}function H(S){var B=S.v/100,q=B*(1-S.s/100/2),ie;return q>0&&q<1&&(ie=t.round((B-q)/t.min(q,1-q)*100)),{h:S.h,s:ie||0,l:t.round(q*100),a:S.a}}function ue(S){var B=S.r/255,q=S.g/255,ie=S.b/255,ae=t.max(B,q,ie),he=t.min(B,q,ie),pe=ae-he,$e=ae,be=0,Ue=0;return pe&&(ae===B&&(be=(q-ie)/pe),ae===q&&(be=2+(ie-B)/pe),ae===ie&&(be=4+(B-q)/pe),ae&&(Ue=pe/ae)),be=t.floor(be*60),{h:be<0?be+360:be,s:t.round(Ue*100),v:t.round($e*100),a:S.a}}function Ce(S){var B=/^((rgba)|rgb)[\D]+([\d.]+)[\D]+([\d.]+)[\D]+([\d.]+)[\D]*?([\d.]+|$)/i,q,ie;return o.fillStyle="#000",o.fillStyle=S,q=B.exec(o.fillStyle),q?(ie={r:q[3]*1,g:q[4]*1,b:q[5]*1,a:q[6]*1},ie.a=+ie.a.toFixed(2)):(q=o.fillStyle.replace("#","").match(/.{2}/g).map(function(ae){return parseInt(ae,16)}),ie={r:q[0],g:q[1],b:q[2],a:1}),ie}function Ee(S){var B=S.r.toString(16),q=S.g.toString(16),ie=S.b.toString(16),ae="";if(S.r<16&&(B="0"+B),S.g<16&&(q="0"+q),S.b<16&&(ie="0"+ie),w.alpha&&(S.a<1||w.forceAlpha)){var he=S.a*255|0;ae=he.toString(16),he<16&&(ae="0"+ae)}return"#"+B+q+ie+ae}function He(S){return!w.alpha||S.a===1&&!w.forceAlpha?"rgb("+S.r+", "+S.g+", "+S.b+")":"rgba("+S.r+", "+S.g+", "+S.b+", "+S.a+")"}function Fe(S){return!w.alpha||S.a===1&&!w.forceAlpha?"hsl("+S.h+", "+S.s+"%, "+S.l+"%)":"hsla("+S.h+", "+S.s+"%, "+S.l+"%, "+S.a+")"}function Be(){e.getElementById("clr-picker")||(a=i,u=e.createElement("div"),u.setAttribute("id","clr-picker"),u.className="clr-picker",u.innerHTML='<input id="clr-color-value" name="clr-color-value" class="clr-color" type="text" value="" spellcheck="false" aria-label="'+w.a11y.input+'">'+('<div id="clr-color-area" class="clr-gradient" role="application" aria-label="'+w.a11y.instruction+'">')+'<div id="clr-color-marker" class="clr-marker" tabindex="0"></div></div><div class="clr-hue">'+('<input id="clr-hue-slider" name="clr-hue-slider" type="range" min="0" max="360" step="1" aria-label="'+w.a11y.hueSlider+'">')+'<div id="clr-hue-marker"></div></div><div class="clr-alpha">'+('<input id="clr-alpha-slider" name="clr-alpha-slider" type="range" min="0" max="100" step="1" aria-label="'+w.a11y.alphaSlider+'">')+'<div id="clr-alpha-marker"></div><span></span></div><div id="clr-format" class="clr-format"><fieldset class="clr-segmented">'+("<legend>"+w.a11y.format+"</legend>")+'<input id="clr-f1" type="radio" name="clr-format" value="hex"><label for="clr-f1">Hex</label><input id="clr-f2" type="radio" name="clr-format" value="rgb"><label for="clr-f2">RGB</label><input id="clr-f3" type="radio" name="clr-format" value="hsl"><label for="clr-f3">HSL</label><span></span></fieldset></div><div id="clr-swatches" class="clr-swatches"></div>'+('<button type="button" id="clr-clear" class="clr-clear" aria-label="'+w.a11y.clear+'">'+w.clearLabel+"</button>")+'<div id="clr-color-preview" class="clr-preview">'+('<button type="button" id="clr-close" class="clr-close" aria-label="'+w.a11y.close+'">'+w.closeLabel+"</button>")+"</div>"+('<span id="clr-open-label" hidden>'+w.a11y.open+"</span>")+('<span id="clr-swatch-label" hidden>'+w.a11y.swatch+"</span>"),e.body.appendChild(u),h=ve("clr-color-area"),y=ve("clr-color-marker"),M=ve("clr-clear"),A=ve("clr-close"),O=ve("clr-color-preview"),D=ve("clr-color-value"),T=ve("clr-hue-slider"),$=ve("clr-hue-marker"),x=ve("clr-alpha-slider"),L=ve("clr-alpha-marker"),we(w.el),Se(w.el),Oe(u,"mousedown",function(S){u.classList.remove("clr-keyboard-nav"),S.stopPropagation()}),Oe(h,"mousedown",function(S){Oe(e,"mousemove",Te)}),Oe(h,"touchstart",function(S){e.addEventListener("touchmove",Te,{passive:!1})}),Oe(y,"mousedown",function(S){Oe(e,"mousemove",Te)}),Oe(y,"touchstart",function(S){e.addEventListener("touchmove",Te,{passive:!1})}),Oe(D,"change",function(S){var B=D.value;if(P||w.inline){var q=B===""?B:se(B);me(q)}}),Oe(M,"click",function(S){me(""),J()}),Oe(A,"click",function(S){me(),J()}),Oe(ve("clr-format"),"click",".clr-format input",function(S){V=S.target.value,I(),me()}),Oe(u,"click",".clr-swatches button",function(S){se(S.target.textContent),me(),w.swatchesOnly&&J()}),Oe(e,"mouseup",function(S){e.removeEventListener("mousemove",Te)}),Oe(e,"touchend",function(S){e.removeEventListener("touchmove",Te)}),Oe(e,"mousedown",function(S){oe=!1,u.classList.remove("clr-keyboard-nav"),J()}),Oe(e,"keydown",function(S){var B=S.key,q=S.target,ie=S.shiftKey,ae=["Tab","ArrowUp","ArrowDown","ArrowLeft","ArrowRight"];if(B==="Escape"?J(!0):ae.includes(B)&&(oe=!0,u.classList.add("clr-keyboard-nav")),B==="Tab"&&q.matches(".clr-picker *")){var he=Me(),pe=he.shift(),$e=he.pop();ie&&q===pe?($e.focus(),S.preventDefault()):!ie&&q===$e&&(pe.focus(),S.preventDefault())}}),Oe(e,"click",".clr-field button",function(S){k&&Q(),S.target.nextElementSibling.dispatchEvent(new Event("click",{bubbles:!0}))}),Oe(y,"keydown",function(S){var B={ArrowUp:[0,-1],ArrowDown:[0,1],ArrowLeft:[-1,0],ArrowRight:[1,0]};Object.keys(B).includes(S.key)&&(K.apply(void 0,B[S.key]),S.preventDefault())}),Oe(h,"click",Te),Oe(T,"input",N),Oe(x,"input",W))}function Me(){var S=Array.from(u.querySelectorAll("input, button")),B=S.filter(function(q){return!!q.offsetWidth});return B}function ve(S){return e.getElementById(S)}function Oe(S,B,q,ie){var ae=Element.prototype.matches||Element.prototype.msMatchesSelector;typeof q=="string"?S.addEventListener(B,function(he){ae.call(he.target,q)&&ie.call(he.target,he)}):(ie=q,S.addEventListener(B,ie))}function qe(S,B){B=B!==i?B:[],e.readyState!=="loading"?S.apply(void 0,B):e.addEventListener("DOMContentLoaded",function(){S.apply(void 0,B)})}NodeList!==i&&NodeList.prototype&&!NodeList.prototype.forEach&&(NodeList.prototype.forEach=Array.prototype.forEach);function ne(S,B){P=B,F=P.value,le(B),V=Ie(S),De(),se(S),me(),F!==S&&P.dispatchEvent(new Event("change",{bubbles:!0}))}var ge=function(){var S={init:Be,set:R,wrap:Se,close:J,setInstance:j,setColor:ne,removeInstance:re,updatePosition:De};function B(ae){qe(function(){ae&&(typeof ae=="string"?we(ae):R(ae))})}var q=function(he){B[he]=function(){for(var pe=arguments.length,$e=new Array(pe),be=0;be<pe;be++)$e[be]=arguments[be];qe(S[he],$e)}};for(var ie in S)q(ie);return qe(function(){n.addEventListener("resize",function(ae){B.updatePosition()}),n.addEventListener("scroll",function(ae){B.updatePosition()})}),B}();return ge.coloris=ge,ge}(window,document,Math)}();rt.coloris;rt.init;rt.set;rt.wrap;rt.close;rt.setInstance;rt.removeInstance;rt.updatePosition;function Va(){Z.smokeViewToggle.onclick=e=>{e.preventDefault(),n(Z.smokeViewToggle,Z.smokeViewPanel)},Z.spectreViewToggle.onclick=e=>{e.preventDefault(),n(Z.spectreViewToggle,Z.spectreViewPanel)},Z.settingsViewToggle.onclick=e=>{e.preventDefault(),n(Z.settingsViewToggle,Z.settingsViewPanel)},Z.debugViewToggle.onclick=e=>{e.preventDefault(),n(Z.debugViewToggle,Z.debugViewPanel)};function n(e,t){Z.smokeViewToggle?.classList.remove("selected"),Z.spectreViewToggle?.classList.remove("selected"),Z.settingsViewToggle?.classList.remove("selected"),Z.debugViewToggle?.classList.remove("selected"),Z.smokeViewPanel.style.display="none",Z.spectreViewPanel.style.display="none",Z.settingsViewPanel.style.display="none",Z.debugViewPanel.style.display="none",e.classList.add("selected"),t.style.display="block"}}function Xi(){Z.processedIndicator.onclick=async()=>{await b.popover.open({id:c.PROCESSEDID,url:"/pages/processed.html",height:300,width:320,disableClickAway:!1})},Z.hiddenListToggle.onclick=async o=>{Z.hiddenTable.style.display==="none"?(Z.hiddenTable.style.display="table-row-group",Z.hiddenListToggle.value="Out-of-Sight List: Click to Hide"):(Z.hiddenTable.style.display="none",Z.hiddenListToggle.value="Out-of-Sight List: Click to Show")},Z.visionCheckbox.onclick=async o=>{if(!p.sceneReady){o.preventDefault();return}const r=o.target;await b.scene.setMetadata({[`${c.EXTENSIONID}/visionEnabled`]:r.checked}),await b.scene.fog.setFilled(r.checked)},Z.snapCheckbox.checked=!0,Z.snapCheckbox.onclick=async o=>{if(!p.sceneReady){o.preventDefault();return}const r=o.target;p.snap=r.checked},Z.persistenceCheckbox.onclick=async o=>{if(!o||!o.target)return;const r=o.target;await b.scene.setMetadata({[`${c.EXTENSIONID}/persistenceEnabled`]:r.checked})},Z.autodetectCheckbox.onclick=async o=>{if(!o||!o.target)return;const r=o.target;await b.scene.setMetadata({[`${c.EXTENSIONID}/autodetectEnabled`]:r.checked}),Z.boundryOptions.style.display=r.checked?"none":"",await $n()},Z.fowCheckbox.onclick=async o=>{if(!o||!o.target)return;const r=o.target;await en(r.checked),await b.scene.setMetadata({[`${c.EXTENSIONID}/fowEnabled`]:r.checked})},Z.doorCheckbox.onclick=async o=>{if(!o||!o.target)return;const r=o.target;await b.scene.setMetadata({[`${c.EXTENSIONID}/playerDoors`]:r.checked})},Z.resetButton.onclick=async o=>{!o||!o.target||b.broadcast.sendMessage(c.RESETID,!0,{destination:"ALL"})},Z.unlockFogButton.onclick=async o=>{if(!o||!o.target)return;const r=p.sceneItems.filter(a=>Pi(a));await p.ToggleBusy(!0);for(let a=0;a<r.length;a+=64){const u=r.slice(a,a+64);await b.scene.items.updateItems(u,h=>{for(let y of h)y.locked=!1})}await p.ToggleBusy(!1)},Z.lockFogButton.onclick=async o=>{if(!o||!o.target)return;const r=p.sceneItems.filter(a=>Pi(a));await p.ToggleBusy(!0);for(let a=0;a<r.length;a+=64){const u=r.slice(a,a+64);await b.scene.items.updateItems(u,h=>{for(let y of h)y.locked=!0})}await p.ToggleBusy(!1)},Z.backgroundButton.onclick=async o=>{!o||!o.target||(o.target,await b.scene.items.updateItems(r=>r.layer=="FOG"&&r.metadata[`${c.EXTENSIONID}/isBackgroundMap`]===!0,r=>{for(let a=0;a<r.length;a++)r[a].layer="MAP",r[a].disableHit=!1,r[a].locked=!1,r[a].visible=!0,delete r[a].metadata[`${c.EXTENSIONID}/isBackgroundMap`]}))};let n;Z.fowColor.onclick=()=>{rt({el:`#${Z.fowColor.id}`,alpha:!0,forceAlpha:!0})},Z.fowColor.oninput=async o=>{if(!o||!o.target)return;const r=o.target;clearTimeout(n),n=setTimeout(async()=>{if(/#[a-f0-9]{8}/.test(r.value)){await b.scene.setMetadata({[`${c.EXTENSIONID}/fowColor`]:r.value});const u=await b.scene.local.getItems(Zt);await b.scene.local.deleteItems(u.map(h=>h.id))}},500)},Z.convertButton.onclick=async o=>{if(!(!o||!o.target)&&window.confirm(`WARNING: THIS CANNOT BE UNDONE.

This operation will remove all metadata from the original dynamic fog extension, and will break fog lines and other things if you do not continue using Smoke!.

WARNING: THIS CANNOT BE UNDONE.

Are you REALLY sure?`)){for(const r in p.sceneMetadata)r.substring(0,r.indexOf("/"))==c.ARMINDOID&&await b.scene.setMetadata({[`${r}`]:void 0});await b.scene.items.updateItems(p.sceneItems,r=>{for(const a of r)a.metadata[`${c.ARMINDOID}/isVisionLine`]!==void 0&&(a.metadata[`${c.EXTENSIONID}/isVisionLine`]=a.metadata[`${c.ARMINDOID}/isVisionLine`],delete a.metadata[`${c.ARMINDOID}/isVisionLine`]),a.metadata[`${c.ARMINDOID}/disabled`]!==void 0&&(a.metadata[`${c.EXTENSIONID}/disabled`]=a.metadata[`${c.ARMINDOID}/disabled`],delete a.metadata[`${c.ARMINDOID}/disabled`])})}};var e;Z.importFile.onchange=o=>{if(Z.importButton.disabled=!0,!o||!o.target)return;const r=o.target;if(!r.files)return;const a=r.files[0];if(a.type!=="text/javascript"&&a.type,a){var u=new FileReader;u.onload=function(h){if(!h||!h.target){Z.importErrors.innerText="Invalid import event";return}const y=h.target;if(!y.result){Z.importErrors.innerText="Unable to read imported file";return}const O=y.result;e=JSON.parse(O),e&&(e.walls&&e.walls.length||e.line_of_sight&&e.line_of_sight.length||e.objects_line_of_sight&&e.objects_line_of_sight.length)?Z.importButton.disabled=!1:Z.importErrors.innerText="Imported file has no walls"},u.readAsText(a)}else Z.importErrors.innerText="Failed to load file"},Z.dpiAutodetect.onclick=async o=>{!o||!o.target||(Z.importDpi.disabled=Z.dpiAutodetect.checked)},Z.importButton.onclick=async o=>{!o||!o.target||(await p.ToggleBusy(!0),Z.importFormat.value==="scene"?await nr(e,Z.importErrors):await er(Z.importFormat.value,e,Z.dpiAutodetect.checked?0:Number.parseInt(Z.importDpi.value),Z.mapAlign.value,Z.importErrors),await p.ToggleBusy(!1))},Z.toolColor.onclick=async o=>{rt({el:`#${Z.toolColor.id}`,alpha:!1,forceAlpha:!1})},Z.toolColor.oninput=async o=>{if(!o||!o.target)return;const r=o.target;clearTimeout(n),n=setTimeout(async()=>{/#[a-f0-9]{6}/.test(r.value)&&await b.scene.setMetadata({[`${c.EXTENSIONID}/toolColor`]:r.value})},400)},Z.toolStyle.onchange=async o=>{const r=o.currentTarget;await b.scene.setMetadata({[`${c.EXTENSIONID}/toolStyle`]:r.value=="solid"?[]:[25,25]})},Z.toolWidth.onchange=o=>{const r=o.currentTarget;clearTimeout(n),n=setTimeout(async()=>{await b.scene.setMetadata({[`${c.EXTENSIONID}/toolWidth`]:r.value})},400)},Z.defaultMELDepth.onchange=o=>{const r=o.currentTarget;clearTimeout(n),n=setTimeout(async()=>{await b.scene.setMetadata({[`${c.EXTENSIONID}/defaultMELDepth`]:r.value})},400)},Z.whatsNewButton.onclick=async function(){Z.whatsNewIcon?.classList.remove("new-shine"),await b.modal.open({id:c.EXTENSIONWHATSNEW,url:"/pages/whatsnew.html",height:500,width:400})};const t=p.sceneMetadata[`${c.EXTENSIONID}/fowColor`]??"#00000088",i=p.sceneMetadata[`${c.EXTENSIONID}/toolColor`]??"#000000";Z.toolColor.value=i,Z.fowColor.value=t,rt({themeMode:"dark",alpha:!0,forceAlpha:!0,el:"#fow_color",defaultColor:t}),rt({themeMode:"dark",alpha:!1,forceAlpha:!1,el:"#tool_color",defaultColor:i})}const yo="#000000",Ha=8,Ua=[];let vt=[];async function vo(){vt=[];const n=await b.scene.local.getItems(Ba);await b.scene.local.deleteItems(n.map(e=>e.id)),await b.popover.close(c.BRUSHTOOLID)}async function Ga(n,e){await Eo(e.pointerPosition)}async function Wa(){const n=await b.viewport.getWidth();await b.popover.open({id:c.BRUSHTOOLID,url:"/pages/brush.html",height:80,width:350,disableClickAway:!0,anchorPosition:{top:60,left:n/2},anchorReference:"POSITION",anchorOrigin:{vertical:"CENTER",horizontal:"CENTER"},transformOrigin:{vertical:"TOP",horizontal:"CENTER"}})}async function ja(){await b.popover.close(c.BRUSHTOOLID)}async function qa(n,e){await Eo(e.pointerPosition)}async function Ka(n,e){await Ya(),await vo()}async function za(n,e){await vo()}async function Eo(n){const e={x:Math.floor(n.x/p.gridDpi),y:Math.floor(n.y/p.gridDpi)};if(!vt.some(i=>i.x===e.x&&i.y===e.y)){const i={x:e.x*p.gridDpi,y:e.y*p.gridDpi},o={x:(e.x+1)*p.gridDpi,y:e.y*p.gridDpi},r={x:e.x*p.gridDpi,y:(e.y+1)*p.gridDpi},a={x:(e.x+1)*p.gridDpi,y:(e.y+1)*p.gridDpi},u=[[_t.MOVE,i.x,i.y],[_t.LINE,o.x,o.y],[_t.LINE,a.x,a.y],[_t.LINE,r.x,r.y],[_t.CLOSE]],h=gt().commands(u).strokeOpacity(0).fillOpacity(.5).fillColor(p.sceneMetadata[`${c.EXTENSIONID}/toolColor`]??yo).build();h.metadata[`${c.EXTENSIONID}/isBrushSquare`]=!0,vt.push(e),await b.scene.local.addItems([h])}}async function Ya(){const n=[];for(const a of vt){const{x:u,y:h}=a,y={x:u*p.gridDpi,y:h*p.gridDpi},O={x:(u+1)*p.gridDpi,y:h*p.gridDpi},D={x:u*p.gridDpi,y:(h+1)*p.gridDpi},M={x:(u+1)*p.gridDpi,y:(h+1)*p.gridDpi};if(!vt.some(A=>A.x===u&&A.y===h-1)){const A=y,T=O;n.push({Start:A,End:T})}if(!vt.some(A=>A.x===u&&A.y===h+1)){const A=D,T=M;n.push({Start:A,End:T})}if(!vt.some(A=>A.x===u-1&&A.y===h)){const A=y,T=D;n.push({Start:A,End:T})}if(!vt.some(A=>A.x===u+1&&A.y===h)){const A=O,T=M;n.push({Start:A,End:T})}}const e=wo(n),t=Io(e),i=Qa(t),o=25,r=i.length;for(let a=0;a<r;a+=o){const u=i.slice(a,a+o);await b.scene.items.addItems(u)}}function Io(n){let e=[],t=[],i=!1;for(const o of n){const r=o.Start.x===o.End.x?n.filter(h=>h.Start.x===h.End.x):n.filter(h=>h.Start.y===h.End.y),a=o.Start.x===o.End.x?r.filter(h=>h.Start.x===o.Start.x&&h.End.x===o.End.x):r.filter(h=>h.Start.y===o.Start.y&&h.End.y===o.End.y),u=o.Start.x!==o.End.x?a.find(h=>h.Start.x>o.Start.x&&h.Start.x<o.End.x):a.find(h=>h.Start.y>o.Start.y&&h.Start.y<o.End.y);if(u){const h=Ja(o,u);t.push(h),e.push(o),e.push(u),t=t.filter(y=>y!==o&&y!==u),i=!0}else e.includes(o)||t.push(o)}return i?Io(t):t}function wo(n){let e=[],t=[],i=!1;for(const o of n){const a=(o.Start.x===o.End.x?n.filter(u=>u.Start.x===u.End.x):n.filter(u=>u.Start.y===u.End.y)).find(u=>u.Start.x===o.End.x&&u.Start.y===o.End.y);if(a){const u=Za(o,a);t.push(u),e.push(o),e.push(a),t=t.filter(h=>h!==o&&h!==a),i=!0}else e.includes(o)||t.push(o)}return i?wo(t):t}function Za(n,e){return{Start:n.Start,End:e.End}}function Ja(n,e){const t=Math.min(n.Start.x,e.Start.x),i=Math.min(n.Start.y,e.Start.y),o=Math.max(n.End.x,e.End.x),r=Math.max(n.End.y,e.End.y);return{Start:{x:t,y:i},End:{x:o,y:r}}}function Qa(n){const e=[];for(const t of n){const i=ct().tension(0).points([t.Start,t.End]).strokeColor(p.sceneMetadata[`${c.EXTENSIONID}/toolColor`]??yo).strokeDash(p.sceneMetadata[`${c.EXTENSIONID}/toolStyle`]??Ua).strokeWidth(p.sceneMetadata[`${c.EXTENSIONID}/toolWidth`]??Ha).fillOpacity(0).fillColor("#000000").layer("DRAWING").name("Vision Line (Brushed)").closed(!1).locked(!0).build();i.visible=!1,i.metadata[`${c.EXTENSIONID}/isVisionLine`]=!0,e.push(i)}return e}const bt={onActivate:Wa,onDeactivate:ja,onDragStart:Ga,onDragMove:qa,onDragEnd:Ka,onDragCancel:za};async function Fi(){await b.tool.create({id:`${c.EXTENSIONID}/vision-tool`,icons:[{icon:"/icon.svg",label:"Setup Vision"}],defaultMetadata:{[`${c.EXTENSIONID}/elevationEditor`]:!1},async onClick(){await b.tool.activateTool(`${c.EXTENSIONID}/vision-tool`),p.toolStarted||(p.toolStarted=!0,await b.tool.setMetadata(`${c.EXTENSIONID}/vision-tool`,{[`${c.EXTENSIONID}/elevationEditor`]:!1}))}}),await b.tool.createMode({id:`${c.EXTENSIONID}/add-vision-polygon-mode`,icons:[{icon:"/object.svg",label:"Add Obstruction Object",filter:{activeTools:[`${c.EXTENSIONID}/vision-tool`]}}],onToolDown:An.onToolClick,onToolMove:An.onToolMove,onKeyDown:An.onKeyDown,preventDrag:{dragging:!1}}),await b.tool.createMode({id:`${c.EXTENSIONID}/add-vision-line-mode`,icons:[{icon:"/line.svg",label:"Add Obstruction Line",filter:{activeTools:[`${c.EXTENSIONID}/vision-tool`]}}],onToolDown:_n.onToolClick,onToolMove:_n.onToolMove,onKeyDown:_n.onKeyDown,preventDrag:{dragging:!1}}),await b.tool.createMode({id:`${c.EXTENSIONID}/add-vision-brush-mode`,icons:[{icon:"/brush.svg",label:"Paint Obstructions by Grid",filter:{activeTools:[`${c.EXTENSIONID}/vision-tool`]}}],onToolDown:bt.onActivate,onToolUp:bt.onDeactivate,onToolDragStart:bt.onDragStart,onToolDragMove:bt.onDragMove,onToolDragEnd:bt.onDragEnd,onToolDragCancel:bt.onDragCancel}),await b.tool.createMode({id:`${c.EXTENSIONID}/enter-elevation-mode-1`,icons:[{icon:"/mountain1.svg",label:"Create Map Elevation Layer-1",filter:{activeTools:[`${c.EXTENSIONID}/vision-tool`]}}],disabled:{metadata:[{key:[`${c.EXTENSIONID}/elevationEditor`],value:!1}]},onToolDown:(n,e)=>{Ke.onToolClick(n,e,1)},onToolMove:Ke.onToolMove,onKeyDown:(n,e)=>{Ke.onKeyDown(n,e,1)},preventDrag:{dragging:!0}}),await b.tool.createMode({id:`${c.EXTENSIONID}/enter-elevation-mode-2`,icons:[{icon:"/mountain2.svg",label:"Create Map Elevation Layer-2",filter:{activeTools:[`${c.EXTENSIONID}/vision-tool`]}}],disabled:{metadata:[{key:[`${c.EXTENSIONID}/elevationEditor`],value:!1}]},onToolDown:(n,e)=>{Ke.onToolClick(n,e,2)},onToolMove:Ke.onToolMove,onKeyDown:(n,e)=>{Ke.onKeyDown(n,e,2)},preventDrag:{dragging:!0}}),await b.tool.createMode({id:`${c.EXTENSIONID}/enter-elevation-mode-3`,icons:[{icon:"/mountain3.svg",label:"Create Map Elevation Layer-3",filter:{activeTools:[`${c.EXTENSIONID}/vision-tool`]}}],disabled:{metadata:[{key:[`${c.EXTENSIONID}/elevationEditor`],value:!1}]},onToolDown:(n,e)=>{Ke.onToolClick(n,e,3)},onToolMove:Ke.onToolMove,onKeyDown:(n,e)=>{Ke.onKeyDown(n,e,3)},preventDrag:{dragging:!0}}),await b.tool.createMode({id:`${c.EXTENSIONID}/enter-elevation-mode-4`,icons:[{icon:"/mountain4.svg",label:"Create Map Elevation Layer-4",filter:{activeTools:[`${c.EXTENSIONID}/vision-tool`]}}],disabled:{metadata:[{key:[`${c.EXTENSIONID}/elevationEditor`],value:!1}]},onToolDown:(n,e)=>{Ke.onToolClick(n,e,4)},onToolMove:Ke.onToolMove,onKeyDown:(n,e)=>{Ke.onKeyDown(n,e,4)},preventDrag:{dragging:!0}}),await b.tool.createMode({id:`${c.EXTENSIONID}/enter-elevation-mode-5`,icons:[{icon:"/mountain5.svg",label:"Create Map Elevation Layer-5",filter:{activeTools:[`${c.EXTENSIONID}/vision-tool`]}}],disabled:{metadata:[{key:[`${c.EXTENSIONID}/elevationEditor`],value:!1}]},onToolDown:(n,e)=>{Ke.onToolClick(n,e,5)},onToolMove:Ke.onToolMove,onKeyDown:(n,e)=>{Ke.onKeyDown(n,e,5)},preventDrag:{dragging:!0}}),await b.tool.createMode({id:`${c.EXTENSIONID}/enter-elevation-mode-select`,icons:[{icon:"/mountain-select.svg",label:"Selector",filter:{activeTools:[`${c.EXTENSIONID}/vision-tool`]}}],disabled:{metadata:[{key:[`${c.EXTENSIONID}/elevationEditor`],value:!1}]},onToolDown:(n,e)=>!0,preventDrag:{dragging:!0}}),await b.tool.createAction({id:`${c.EXTENSIONID}/enter-elevation-mode`,icons:[{icon:"/eyeclosed.svg",label:"Activate Elevation Editor",filter:{activeTools:[`${c.EXTENSIONID}/vision-tool`],metadata:[{key:[`${c.EXTENSIONID}/elevationEditor`],value:!0,operator:"!="}]}},{icon:"/eyeopen.svg",label:"De-Activate Elevation Editor",filter:{activeTools:[`${c.EXTENSIONID}/vision-tool`],metadata:[{key:[`${c.EXTENSIONID}/elevationEditor`],value:!0,operator:"=="}]}}],onClick:Ke.enterEditMode})}class es{mainWindow=document.getElementById("app");mainUIDiv;playerListContainer;settingsUIDiv;visionCheckbox;hiddenListToggle;snapCheckbox;table;hiddenTable;message;mapHeight;mapWidth;mapSubmit;whatsNewButton;whatsNewIcon;processedIndicator;smokeViewToggle;spectreViewToggle;settingsViewToggle;debugViewToggle;smokeViewPanel;spectreViewPanel;settingsViewPanel;debugViewPanel;persistenceCheckbox;autodetectCheckbox;fowCheckbox;doorCheckbox;fowColor;resetButton;convertButton;boundryOptions;backgroundButton;lockFogButton;unlockFogButton;defaultMELDepth;toolWidth;toolColor;toolStyle;importButton;importFile;mapAlign;importErrors;dpiAutodetect;importDpi;importFormat;version;constructor(e){this.version=`SMOKEANDSPECTRE-${e}`}SetupGMElements(){this.mainWindow.innerHTML=`
            <div id="localStorageWarning"></div>
            <div id="tabControls">
                <div class="controlContainer">
                    <button class="view-button selected" id="smokeViewToggle">SMOKE</button>
                    <button class="view-button" id="spectreViewToggle">SPECTRE</button>
                    <button class="view-button" id="settingsViewToggle">SETTINGS</button>
                    <button class="view-button" id="debugViewToggle">INFO</button>
                    <div id="miniButtons">
                        <button class="circle-button" id="processedIndicator"></button>
                        <input type="checkbox" id="vision_checkbox" class="large" title="Enable Dynamic Fog">    
                        <div class="tooltip" id="whatsnewbutton" title="Whats New"><svg id="whatsNewIcon" class="svgclickable" fill="#fff" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 3a7 7 0 100 14 7 7 0 000-14zm-9 7a9 9 0 1118 0 9 9 0 01-18 0zm8-4a1 1 0 011-1h.01a1 1 0 110 2H10a1 1 0 01-1-1zm.01 8a1 1 0 102 0V9a1 1 0 10-2 0v5z"/></svg></div>
                    </div>
                </div>
            </div>
            <div id="smokeViewPanel" class="panel"></div>
            <div id="spectreViewPanel" class="panel" style="display: none;"></div>
            <div id="settingsViewPanel" class="panel" style="display: none;"></div>
            <div id="debugViewPanel" class="panel" style="display: none;"></div>
        `,this.mainWindow.parentElement.style.placeItems="start",this.smokeViewToggle=document.getElementById("smokeViewToggle"),this.spectreViewToggle=document.getElementById("spectreViewToggle"),this.settingsViewToggle=document.getElementById("settingsViewToggle"),this.debugViewToggle=document.getElementById("debugViewToggle"),this.smokeViewPanel=document.getElementById("smokeViewPanel"),this.spectreViewPanel=document.getElementById("spectreViewPanel"),this.settingsViewPanel=document.getElementById("settingsViewPanel"),this.debugViewPanel=document.getElementById("debugViewPanel"),this.smokeViewPanel.innerHTML=c.SMOKEHTML,this.spectreViewPanel.innerHTML=c.SPECTREHTML,this.settingsViewPanel.innerHTML=c.SETTINGSHTML,this.debugViewPanel.innerHTML=c.DEBUGHTML,this.mainUIDiv=document.getElementById("main-ui"),this.settingsUIDiv=document.getElementById("settings-ui"),this.visionCheckbox=document.getElementById("vision_checkbox"),this.hiddenListToggle=document.getElementById("hideListToggle"),this.snapCheckbox=document.getElementById("snap_checkbox"),this.table=document.getElementById("token_list"),this.hiddenTable=document.getElementById("hidden_list"),this.message=document.getElementById("no_tokens_message"),this.mapHeight=document.getElementById("mapHeight"),this.mapWidth=document.getElementById("mapWidth"),this.mapSubmit=document.getElementById("mapSubmit"),this.whatsNewButton=document.getElementById("whatsnewbutton"),this.whatsNewIcon=document.getElementById("whatsNewIcon"),this.processedIndicator=document.getElementById("processedIndicator"),this.persistenceCheckbox=document.getElementById("persistence_checkbox"),this.autodetectCheckbox=document.getElementById("autodetect_checkbox"),this.fowCheckbox=document.getElementById("fow_checkbox"),this.doorCheckbox=document.getElementById("door_checkbox"),this.fowColor=document.getElementById("fow_color"),this.resetButton=document.getElementById("persistence_reset"),this.convertButton=document.getElementById("convert_button"),this.boundryOptions=document.getElementById("boundry_options"),this.backgroundButton=document.getElementById("background_button"),this.lockFogButton=document.getElementById("lock_button"),this.unlockFogButton=document.getElementById("unlock_button"),this.toolWidth=document.getElementById("tool_width"),this.toolColor=document.getElementById("tool_color"),this.toolStyle=document.getElementById("tool_style"),this.defaultMELDepth=document.getElementById("default_mel_depth"),this.importButton=document.getElementById("import_button"),this.importFile=document.getElementById("import_file"),this.mapAlign=document.getElementById("map_align"),this.importErrors=document.getElementById("import_errors"),this.dpiAutodetect=document.getElementById("dpi_autodetect"),this.importDpi=document.getElementById("import_dpi"),this.importFormat=document.getElementById("import_format");const e=document.getElementById("playerListing");e.appendChild(this.GetEmptyContextItem());for(const t of p.party){const i=document.createElement("li");i.id=t.id,i.textContent=t.name,i.style.color=t.color,e.appendChild(i)}rt.init(),Va()}async SetupPlayerElements(){this.mainWindow.innerHTML=`<div class="title">Configuration via GM.
            <div class="tooltip" id="helpButton" title="Need Help?"></div>
            </div>
            <hr><sub>You must have ownership of a token to see it.</sub></br></br>Tokens Owned By You:<div id="playerOwnedTokens"></div><div id="localStorageWarning"></div>`,await b.action.setHeight(300),await b.action.setWidth(350),this.playerListContainer=document.getElementById("playerOwnedTokens");const e=document.getElementById("helpButton"),t=document.createElement("input");t.classList.add("clickable"),t.src="/help.svg",t.height=15,t.width=15,t.type="image",t.title="Need Help?",t.onclick=async function(){await b.modal.open({id:c.EXTENSIONWHATSNEW,url:"/pages/whatsnew.html?gethelp=true",height:500,width:350})},e.appendChild(t)}GetEmptyContextItem(){const e=document.createElement("li");return e.id=p.playerId,e.textContent="Self",e}async ResetPersistence(){const e=await b.scene.local.getItems(Gn);await b.scene.local.deleteItems(e.map(i=>i.id));const t=p.sceneMetadata[`${c.EXTENSIONID}/sceneId`];localStorage.removeItem(`${c.EXTENSIONID}/fogCache/${p.playerId}/${t}`),await Tt()}async UpdateUI(){const e=p.sceneItems.filter(u=>go(u));Go(p.sceneMetadata)||(this.defaultMELDepth.value=p.sceneMetadata[`${c.EXTENSIONID}/defaultMELDepth`]??"0",this.toolWidth.value=p.sceneMetadata[`${c.EXTENSIONID}/toolWidth`]??"8",this.toolColor.value=p.sceneMetadata[`${c.EXTENSIONID}/toolColor`]??"#000000",this.toolStyle.value=p.sceneMetadata[`${c.EXTENSIONID}/toolStyle`]==="solid"?"solid":"dotted",this.visionCheckbox.checked=p.sceneMetadata[`${c.EXTENSIONID}/visionEnabled`]==!0,this.autodetectCheckbox.checked=p.sceneMetadata[`${c.EXTENSIONID}/autodetectEnabled`]==!0,this.persistenceCheckbox.checked=p.sceneMetadata[`${c.EXTENSIONID}/persistenceEnabled`]==!0,this.autodetectCheckbox.checked=p.sceneMetadata[`${c.EXTENSIONID}/autodetectEnabled`]==!0,this.fowCheckbox.checked=p.sceneMetadata[`${c.EXTENSIONID}/fowEnabled`]==!0,this.doorCheckbox.checked=p.sceneMetadata[`${c.EXTENSIONID}/playerDoors`]==!0,this.fowColor.value=p.sceneMetadata[`${c.EXTENSIONID}/fowColor`]??"#00000088",p.sceneMetadata[`${c.EXTENSIONID}/debug`]==!0),this.boundryOptions.style.display=this.autodetectCheckbox.checked?"none":"";const t=p.sceneItems.filter(u=>u.layer==="FOG"&&u.metadata[`${c.EXTENSIONID}/isBackgroundMap`]===!0),i=document.querySelectorAll(".fog-background-entry");for(const u of i){const h=u.id.slice(3);t.find(y=>y.id===h)===void 0&&u.remove()}for(const u of t)if(!document.querySelector(`#bg-${u.id}`)){const y=document.createElement("div");y.id=`bg-${u.id}`,y.className="fog-background-entry grid-3 grid-main",y.style.width="300",y.innerHTML=`<div class="token-name grid-2">${u.name}</div>
                    <div><label title="Unlock this fog background and turn it back into a map"><input type="button" value="Unlock"></label></div>`,document.querySelector("#fog_background_list").appendChild(y),y.querySelector("input").addEventListener("click",async D=>{if(!D||!D.target)return;const A=D.target.parentElement.parentElement.parentElement.id.slice(3);await b.scene.items.updateItems(T=>T.id===A&&T.layer=="FOG"&&T.metadata[`${c.EXTENSIONID}/isBackgroundMap`]===!0,T=>{for(let $=0;$<T.length;$++)T[$].layer="MAP",T[$].disableHit=!1,T[$].locked=!1,T[$].visible=!0,delete T[$].metadata[`${c.EXTENSIONID}/isBackgroundMap`]})})}const o=document.querySelector("#fog_backgrounds");t.length==0?o.style.display="none":o.style.display="block";const r=document.getElementsByClassName("token-table-entry"),a=[];for(const u of r){const h=u.id.slice(3);e.find(y=>y.id===h)===void 0&&a.push(u)}for(const u of a)u.remove();for(const u of e)Ko(u)}UpdatePlayerProcessUI(){p.party.every(t=>t.metadata[`${c.EXTENSIONID}/processed`]===!0)?(this.processedIndicator.style.backgroundColor="green",this.processedIndicator.title="Everything looks good."):(this.processedIndicator.style.backgroundColor="red",this.processedIndicator.title="A player is having trouble processing/seeing.")}UpdatePlayerVisionList(){const e=[];for(const t of p.sceneItems)if(Jt(t)&&t.createdUserId===p.playerId){const i=t.metadata[`${c.EXTENSIONID}/hasVision`]!==void 0;e.push(`<li>${t.name}${i?"":": <b>Vision Disabled</b>"}</li>`)}e.length===0&&e.push("<li>None found.</li>"),this.playerListContainer.innerHTML=`<ul>${e.join("")}</ul>`}HighlightWhatsNew(){let e=localStorage.getItem(this.version);(e==="false"||!e)&&(this.whatsNewIcon?.classList.add("new-shine"),localStorage.setItem(this.version,"true"))}async SoftReset(){p.playerRole==="GM"?(this.SetupGMElements(),Xi(),this.UpdatePlayerProcessUI(),Pn(this.mapAlign),await Promise.all([Si(),Fi(),dt.SetupSpectreGM(),en(!1),this.UpdateUI()])):this.SetupPlayerElements(),p.sceneReady&&(await Fn(),await Tt())}async Start(){qo(),p.playerRole==="GM"?(this.SetupGMElements(),Xi(),this.UpdatePlayerProcessUI(),Pn(this.mapAlign),await Promise.all([Si(),Fi(),dt.SetupSpectreGM(),en(!1),this.UpdateUI()])):(await this.SetupPlayerElements(),this.UpdatePlayerVisionList()),await Fn(),await Tt(),dt.SetupLocalSpecterHandlers(),p.SetupHandlers(),this.HighlightWhatsNew()}}const Z=new es("2.62");b.onReady(async()=>{const n=await b.scene.isReady();if(!document.getElementById("papp"))if(n===!1){const t=b.scene.onReadyChange(async i=>{i&&(t(),await Bi())})}else await Bi()});async function Bi(){await p.InitializeCache(),await Z.Start()}export{Li as i};
