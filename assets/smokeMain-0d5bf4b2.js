import{C as s,b as Hi,O as b,a as gt,c as Xo,d as Fo,e as Bo,f as ct,i as Vo,g as _t}from"./bsConstants-1ab61c84.js";/* empty css              */var wn=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function Wn(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}function Ho(n){if(n.__esModule)return n;var e=n.default;if(typeof e=="function"){var t=function i(){return this instanceof i?Reflect.construct(e,arguments,this.constructor):e.apply(this,arguments)};t.prototype=e.prototype}else t={};return Object.defineProperty(t,"__esModule",{value:!0}),Object.keys(n).forEach(function(i){var o=Object.getOwnPropertyDescriptor(n,i);Object.defineProperty(t,i,o.get?o:{enumerable:!0,get:function(){return n[i]}})}),t}function Uo(n){return n.type==="CURVE"}function Jt(n){return n.type==="IMAGE"}function mi(n,e){return Math.round(n/e)*e}function yi(n,e){return Math.floor(n/e)*e}function Mn(n){return n*(Math.PI/180)}function Go(n){return n*(180/Math.PI)}function vi(n,e,t){return n*(1-t)+e*t}class qe{static magnitudeSquared(e){return e.x*e.x+e.y*e.y}static magnitude(e){const t=Math.sqrt(this.magnitudeSquared(e));return isNaN(t)?0:t}static normalize(e){const t=this.magnitude(e);return t===0?{x:0,y:0}:this.divide(e,t)}static dot(e,t){return e.x*t.x+e.y*t.y}static subtract(e,t){return typeof t=="number"?{x:e.x-t,y:e.y-t}:{x:e.x-t.x,y:e.y-t.y}}static add(e,t){return typeof t=="number"?{x:e.x+t,y:e.y+t}:{x:e.x+t.x,y:e.y+t.y}}static multiply(e,t){return typeof t=="number"?{x:e.x*t,y:e.y*t}:{x:e.x*t.x,y:e.y*t.y}}static divide(e,t){return typeof t=="number"?{x:e.x/t,y:e.y/t}:{x:e.x/t.x,y:e.y/t.y}}static rotate(e,t,i){const o=Math.cos(Mn(i)),a=Math.sin(Mn(i)),r=this.subtract(e,t);return{x:t.x+o*r.x-a*r.y,y:t.y+a*r.x+o*r.y}}static min(e,t){return typeof t=="number"?{x:Math.min(e.x,t),y:Math.min(e.y,t)}:{x:Math.min(e.x,t.x),y:Math.min(e.y,t.y)}}static componentMin(e){return e.x<e.y?e.x:e.y}static max(e,t){return typeof t=="number"?{x:Math.max(e.x,t),y:Math.max(e.y,t)}:{x:Math.max(e.x,t.x),y:Math.max(e.y,t.y)}}static componentMax(e){return e.x>e.y?e.x:e.y}static roundTo(e,t){return{x:mi(e.x,t.x),y:mi(e.y,t.y)}}static floorTo(e,t){return{x:yi(e.x,t.x),y:yi(e.y,t.y)}}static sign(e){return{x:Math.sign(e.x),y:Math.sign(e.y)}}static abs(e){return{x:Math.abs(e.x),y:Math.abs(e.y)}}static pow(e,t){return typeof t=="number"?{x:Math.pow(e.x,t),y:Math.pow(e.y,t)}:{x:Math.pow(e.x,t.x),y:Math.pow(e.y,t.y)}}static clamp(e,t,i){return{x:Math.min(Math.max(e.x,t),i),y:Math.min(Math.max(e.y,t),i)}}static boundingBox(e){let t=Number.MAX_SAFE_INTEGER,i=Number.MIN_SAFE_INTEGER,o=Number.MAX_SAFE_INTEGER,a=Number.MIN_SAFE_INTEGER;for(let m of e)t=m.x<t?m.x:t,i=m.x>i?m.x:i,o=m.y<o?m.y:o,a=m.y>a?m.y:a;let r=i-t,d=a-o,h={x:(t+i)/2,y:(o+a)/2};return{min:{x:t,y:o},max:{x:i,y:a},width:r,height:d,center:h}}static pointInPolygon(e,t){const i=this.boundingBox(t);if(e.x<i.min.x||e.x>i.max.x||e.y<i.min.y||e.y>i.max.y)return!1;let o=!1;for(let a=0,r=t.length-1;a<t.length;r=a++){const d=t[a].y>e.y,h=t[r].y>e.y;d!==h&&e.x<(t[r].x-t[a].x)*(e.y-t[a].y)/(t[r].y-t[a].y)+t[a].x&&(o=!o)}return o}static compare(e,t,i){return this.magnitudeSquared(this.subtract(e,t))<i*i}static distance(e,t){return this.magnitude(this.subtract(e,t))}static lerp(e,t,i){return{x:vi(e.x,t.x,i),y:vi(e.y,t.y,i)}}static centroid(e){let t={x:0,y:0};for(let i of e)t.x+=i.x,t.y+=i.y;return e.length>0&&(t={x:t.x/e.length,y:t.y/e.length}),t}}class We{static inverse(e){const[t,i,o,a,r,d,h,m,N]=e,D=t*(r*N-m*d)-i*(a*N-d*h)+o*(a*m-r*h);if(Math.abs(D)<1e-14)return e;const A=1/D,M=(r*N-m*d)*A,T=(o*m-i*N)*A,P=(i*d-o*r)*A,O=(d*h-a*N)*A,L=(t*N-o*h)*A,$=(a*o-t*d)*A,H=(a*m-h*r)*A,R=(h*i-t*m)*A,ie=(t*r-a*i)*A;return[M,T,P,O,L,$,H,R,ie]}static multiply(e,t){return[e[0]*t[0]+e[1]*t[3]+e[2]*t[6],e[0]*t[1]+e[1]*t[4]+e[2]*t[7],e[0]*t[2]+e[1]*t[5]+e[2]*t[8],e[3]*t[0]+e[4]*t[3]+e[5]*t[6],e[3]*t[1]+e[4]*t[4]+e[5]*t[7],e[3]*t[2]+e[4]*t[5]+e[5]*t[8],e[6]*t[0]+e[7]*t[3]+e[8]*t[6],e[6]*t[1]+e[7]*t[4]+e[8]*t[7],e[6]*t[2]+e[7]*t[5]+e[8]*t[8]]}static fromPosition(e){return[1,0,e.x,0,1,e.y,0,0,1]}static fromRotation(e){const t=Mn(e);return[Math.cos(t),-Math.sin(t),0,Math.sin(t),Math.cos(t),0,0,0,1]}static fromScale(e){return[e.x,0,0,0,e.y,0,0,0,1]}static fromItem(e){const t=We.fromPosition(e.position),i=We.fromScale(e.scale),o=We.fromRotation(e.rotation);return We.multiply(We.multiply(t,o),i)}static decompose(e){const[t,i,o,a,r,d]=e,h=t*r-a*i,m={position:{x:o,y:d},rotation:0,scale:{x:1,y:1}};if(t!=0||a!=0){var N=Math.sqrt(t*t+a*a);m.rotation=a>0?Math.acos(t/N):-Math.acos(t/N),m.scale={x:N,y:h/N}}else if(i!=0||r!=0){var D=Math.sqrt(i*i+r*r);m.rotation=Math.PI/2-(r>0?Math.acos(-i/D):-Math.acos(i/D)),m.scale={x:h/D,y:D}}return m.rotation=Go(m.rotation),m}}function Ei(n,e){let t=!1;const i=e.length;let o=e[0];for(let a=1;a<=i;a++){const r=e[a%i];if(n.y>Math.min(o.y,r.y)&&n.y<=Math.max(o.y,r.y)&&n.x<=Math.max(o.x,r.x)&&o.y!=r.y){const d=(n.y-o.y)*(r.x-o.x)/(r.y-o.y)+o.x;(o.x==r.x||n.x<=d)&&(t=!t)}o=r}return t}function Ii(n,e){let t;return function(...o){t&&clearTimeout(t),t=setTimeout(()=>{n(...o),t=void 0},e)}}function Wo(n){for(const e in n)if(n.hasOwnProperty(e))return!1;return!0}function jn(n,e,t=[]){if(n===e)return!0;if(typeof n!="object"||typeof e!="object"||n===null||e===null)return!1;const i=Object.keys(n).filter(a=>!t.includes(a)),o=Object.keys(e).filter(a=>!t.includes(a));if(i.length!==o.length)return!1;for(const a of i)if(!o.includes(a)||!jn(n[a],e[a],t))return!1;return!0}function jo(n,e){return jn(n,e,["lastModified","lastModifiedUserId"])}function wi(n,e){let t=JSON.stringify(n);if(e){const o=JSON.stringify(e);t=t+o}return new TextEncoder().encode(t).length>14384}function Sn(n,e){const t=["lastModified","lastModifiedUserId"];if(n.length!==e.length)return!1;for(let i=0;i<n.length;i++)if(!jn(n[i],e[i],t))return!1;return!0}function qo(n,e){e.forEach(t=>{const i=n.findIndex(o=>o.id===t.id);i!==-1?n[i]=t:n.push(t)})}function Ko(){try{localStorage.setItem("STORAGECHECK","test")}catch{const e=document.getElementById("localStorageWarning");e.innerText="Local Storage disabled. Some features will not function."}}function Si(n,e){const t=window.matchMedia("(prefers-color-scheme: dark)"),i=t.matches?"dark":"light",o=t.matches?"light":"dark";for(var a=0;a<e.styleSheets.length;a++)for(var r=0;r<e.styleSheets[a].cssRules.length;r++){let d=e.styleSheets[a].cssRules[r];d&&d.media&&d.media.mediaText.includes("prefers-color-scheme")&&(n.mode=="LIGHT"?(d.media.appendMedium(`(prefers-color-scheme: ${i})`),d.media.mediaText.includes(o)&&d.media.deleteMedium(`(prefers-color-scheme: ${o})`)):n.mode=="DARK"&&(d.media.appendMedium(`(prefers-color-scheme: ${o})`),d.media.mediaText.includes(i)&&d.media.deleteMedium(`(prefers-color-scheme: ${i})`)))}}async function $n(){const n=p.sceneItems.filter(Qn);if(!p.sceneMetadata[`${s.EXTENSIONID}/autodetectEnabled`]&&n.length==0){const e=[],t=Hi().width(p.gridDpi*30).height(p.gridDpi*30).visible(!1).shapeType("RECTANGLE").name("Smoke! Boundary Box").visible(!0).locked(!1).strokeColor("pink").strokeOpacity(.5).fillColor(p.fogColor).fillOpacity(p.sceneMetadata[`${s.EXTENSIONID}/visionEnabled`]===!0?1:0).strokeDash([200,500]).strokeWidth(50).layer("FOG").visible(!0).zIndex(0).build();t.metadata[`${s.EXTENSIONID}/isBackgroundImage`]=!0,t.metadata[`${s.EXTENSIONID}/grid`]=!0,t.id=s.GRIDID,e.push(t),await b.scene.items.addItems(e),await b.scene.fog.setFilled(!1)}p.sceneMetadata[`${s.EXTENSIONID}/autodetectEnabled`]===!0&&n.length>0&&(p.sceneMetadata[`${s.EXTENSIONID}/visionEnabled`]===!0&&await b.scene.fog.setFilled(!0),await b.scene.items.deleteItems([s.GRIDID]))}function zo(n){function e(){document.getElementById("contextMenu").style.display="none"}const t=document.getElementById(`tr-${n.id}`);if(t){const i=t.getElementsByClassName("token-name")[0],o=t.getElementsByClassName("token-vision-range")[0],a=t.getElementsByClassName("unlimited-vision")[0],r=t.getElementsByClassName("no-vision")[0],d=t.getElementsByClassName("hidden-token")[0];i&&(i.innerText=n.name),o&&!a.checked&&!r.checked&&(o.value=n.metadata[`${s.EXTENSIONID}/visionRange`]!==void 0?n.metadata[`${s.EXTENSIONID}/visionRange`]:s.VISIONDEFAULT),a&&(a.checked=n.metadata[`${s.EXTENSIONID}/visionRange`]===0),r&&(r.checked=n.metadata[`${s.EXTENSIONID}/visionBlind`]),d&&(d.checked=n.metadata[`${s.EXTENSIONID}/hiddenToken`]),a.checked||r.checked?o.setAttribute("disabled","disabled"):o.removeAttribute("disabled")}else{const i=p.sceneMetadata[`${s.EXTENSIONID}/USER-${n.createdUserId}`];let o=i?.color,a=i?.name?`This token is owned by ${i.name}.`:"This token is owned by you.";!o&&n.createdUserId!==p.playerId&&(o="#aeb0af",a="This tokens owner is not in the room currently.");const r=p.sceneItems.find(M=>M.id===n.id),d=document.createElement("tr");d.id=`tr-${r.id}`,d.className="token-table-entry",d.innerHTML=`<td id="contextLocator" title="${a}" ${o==="#aeb0af"?'style="color:black !important; font-style: italic;" ':""}data-color="${o}" class="token-name">${r.name}</td>
                           <td class="token-vision-container" title="The unit of measurement for your grid"><input class="token-vision-range" type="number" value=${s.VISIONDEFAULT}><span class="unit">${p.gridType}</span></td>
                           <td class="token-vision-container-grid">
                            <div class="vision-container-div">
                                <label class="cbutton" title="Unlimited vision range"><input type="checkbox" class="unlimited-vision"><span class="emoji">&infin;</span></label>
                                <label class="cbutton" title="Turn token into a light source"><input type="checkbox" class="torch-vision"><span class="emoji">&#128294;</span></label>
                                <label class="cbutton" title="Disable vision on this token"><input type="checkbox" class="no-vision"><span class="emoji">&#8856;</span></label>
                                <label class="cbutton" title="Move to Out-of-Sight List"><input type="checkbox" class="hidden-token"><span class="emoji">&#128065;</span></label>
                            </div>
                           </td>`,n.metadata[`${s.EXTENSIONID}/hiddenToken`]===!0?Z.hiddenTable.prepend(d):Z.table.appendChild(d),d.getElementsByClassName("token-name")[0].style.textShadow=`
        -2px -2px 2px ${o},
        2px -2px 2px ${o},
        -2px 2px 2px ${o},
        2px 2px 2px ${o}`;const h=d.getElementsByClassName("token-vision-range")[0],m=d.getElementsByClassName("unlimited-vision")[0],N=d.getElementsByClassName("torch-vision")[0],D=d.getElementsByClassName("no-vision")[0],A=d.getElementsByClassName("hidden-token")[0];h&&!m.checked&&!D.checked&&(h.value=n.metadata[`${s.EXTENSIONID}/visionRange`]?n.metadata[`${s.EXTENSIONID}/visionRange`]:s.VISIONDEFAULT),m&&(m.checked=n.metadata[`${s.EXTENSIONID}/visionRange`]===0),N&&(N.checked=n.metadata[`${s.EXTENSIONID}/visionTorch`]),D&&(D.checked=n.metadata[`${s.EXTENSIONID}/visionBlind`]),A&&(A.checked=n.metadata[`${s.EXTENSIONID}/hiddenToken`]),m.checked||D.checked?h.setAttribute("disabled","disabled"):h.removeAttribute("disabled"),h.onchange=async M=>{if(!M||!M.target)return;const T=p.sceneItems.find(L=>L.id===n.id),P=M.target,O=parseInt(P.value);O<0&&(P.value="0"),O>999&&(P.value="999"),await b.scene.items.updateItems([T],L=>{L[0].metadata[`${s.EXTENSIONID}/visionRange`]=O})},A.onclick=async M=>{if(!M||!M.target)return;const T=p.sceneItems.find(L=>L.id===n.id),P=M.target,O=document.getElementById(`tr-${n.id}`);P.checked?Z.hiddenTable.prepend(O):Z.table.appendChild(O),await b.scene.items.updateItems([T],L=>{L[0].metadata[`${s.EXTENSIONID}/hiddenToken`]=P.checked})},m.onclick=async M=>{if(!M||!M.target)return;const T=p.sceneItems.find(L=>L.id===n.id);let P=0;M.target.checked?(h.setAttribute("disabled","disabled"),D.checked=!1):(P=parseInt(h.value),h.removeAttribute("disabled")),await b.scene.items.updateItems([T],L=>{L[0].metadata[`${s.EXTENSIONID}/visionRange`]=P})},D.onclick=async M=>{if(!M||!M.target)return;const T=p.sceneItems.find(O=>O.id===n.id),P=M.target;P.checked?h.setAttribute("disabled","disabled"):h.removeAttribute("disabled"),await b.scene.items.updateItems([T],O=>{O[0].metadata[`${s.EXTENSIONID}/visionBlind`]=P.checked})},N.onclick=async M=>{if(!M||!M.target)return;const T=p.sceneItems.find(O=>O.id===n.id),P=M.target;await b.scene.items.updateItems([T],O=>{O[0].metadata[`${s.EXTENSIONID}/visionTorch`]=P.checked})},h.addEventListener("mousewheel",async()=>{}),d.oncontextmenu=async function(M){M.preventDefault();const T=M.currentTarget,P=document.getElementById("contextMenu"),O=H=>{H.preventDefault()},L=async H=>{const R=H.target,ie=P.getAttribute("currentUnit"),x=p.party.find(I=>R.id===I.id)?.color,g=document.getElementById(`tr-${ie}`).getElementsByClassName("token-name")[0];x?g.style.textShadow=`
                    -2px -2px 2px ${x},
                    2px -2px 2px ${x},
                    -2px 2px 2px ${x},
                    2px 2px 2px ${x}`:g.style.textShadow="",await b.scene.items.updateItems([ie],I=>{for(const y of I)y.createdUserId=R.id}),P.style.display="none",H.stopPropagation(),window.removeEventListener("click",$),P.removeEventListener("click",L),P.removeEventListener("contextmenu",O)};P.setAttribute("currentUnit",T.id.substring(3));const $=()=>{P.style.display="none",window.removeEventListener("click",$),P.removeEventListener("click",L),P.removeEventListener("contextmenu",O)};if(P.addEventListener("click",L),P.addEventListener("contextmenu",O),window.addEventListener("click",$),P.style.display=="block")e();else{const R=(document.getElementById("playerListing").children.length+1)*34,ie=Math.min(M.pageX,window.innerWidth-150);let x=Math.min(M.pageY,(window.innerHeight>300?window.innerHeight-50:window.innerHeight)-120);window.innerHeight<R+x&&(x=window.innerHeight-R),P.style.display="block",P.style.left=ie+"px",P.style.top=x+"px"}}}}async function Yo(n){const e=await b.scene.local.getItems(i=>i.metadata[`${s.EXTENSIONID}/doorId`]!==void 0),t=[];for(let i of e){let o=!1;for(const a of n)i.metadata[`${s.EXTENSIONID}/doorId`]==a.id&&(o=!0);o&&t.push(i.id)}await b.scene.local.deleteItems(t)}async function Qt(n){const e=[],t=await b.scene.local.getItems(i=>i.metadata[`${s.EXTENSIONID}/doorId`]!==void 0);for(const i of n){if(!Uo(i)||t.some(r=>r.metadata[`${s.EXTENSIONID}/doorId`]===i.id))continue;const o=We.fromItem(i),a=[];for(let r=0;r<i.points.length;r++){const d=We.fromPosition(i.points[r]);a.push(We.decompose(We.multiply(o,d)).position)}e.push(gt().locked(!0).commands(Ui(i.metadata[`${s.EXTENSIONID}/disabled`]===!0)).scale({x:.2,y:.2}).name("Door").position(qe.centroid(a)).metadata({[`${s.EXTENSIONID}/doorId`]:i.id}).build())}e.length>0&&await b.scene.local.addItems(e)}async function Zo(n){const e=await b.scene.local.getItems(t=>t.id===n&&t.metadata[`${s.EXTENSIONID}/doorId`]!==void 0);if(e.length===1){const t=e[0].metadata[`${s.EXTENSIONID}/doorId`],i=p.sceneItems.filter(o=>o.id===t);await b.scene.items.updateItems(i,o=>{const a=o[0];p.playerRole!=="GM"&&a.metadata[`${s.EXTENSIONID}/isDoorLocked`]||(a.metadata[`${s.EXTENSIONID}/isVisionLine`]&&a.metadata[`${s.EXTENSIONID}/disabled`]?(delete a.metadata[`${s.EXTENSIONID}/disabled`],delete a.metadata[`${s.EXTENSIONID}/doorOpen`]):a.metadata[`${s.EXTENSIONID}/isVisionLine`]&&(a.metadata[`${s.EXTENSIONID}/disabled`]=!0,a.metadata[`${s.EXTENSIONID}/doorOpen`]=!0,delete a.metadata[`${s.EXTENSIONID}/isDoorLocked`]))}),await b.player.deselect([n])}}async function Jo(){const n=p.sceneItems.filter(e=>e.metadata[`${s.EXTENSIONID}/isDoor`]===!0);await Qt(n)}function Ui(n){return n?s.DOOROPEN:s.DOORCLOSED}var Gi={exports:{}};(function(n){(function(){function e(d,h){var m=d.x-h.x,N=d.y-h.y;return m*m+N*N}function t(d,h,m){var N=h.x,D=h.y,A=m.x-N,M=m.y-D;if(A!==0||M!==0){var T=((d.x-N)*A+(d.y-D)*M)/(A*A+M*M);T>1?(N=m.x,D=m.y):T>0&&(N+=A*T,D+=M*T)}return A=d.x-N,M=d.y-D,A*A+M*M}function i(d,h){for(var m=d[0],N=[m],D,A=1,M=d.length;A<M;A++)D=d[A],e(D,m)>h&&(N.push(D),m=D);return m!==D&&N.push(D),N}function o(d,h,m,N,D){for(var A=N,M,T=h+1;T<m;T++){var P=t(d[T],d[h],d[m]);P>A&&(M=T,A=P)}A>N&&(M-h>1&&o(d,h,M,N,D),D.push(d[M]),m-M>1&&o(d,M,m,N,D))}function a(d,h){var m=d.length-1,N=[d[0]];return o(d,0,m,h,N),N.push(d[m]),N}function r(d,h,m){if(d.length<=2)return d;var N=h!==void 0?h*h:1;return d=m?d:i(d,N),d=a(d,N),d}n.exports=r,n.exports.default=r})()})(Gi);var Qo=Gi.exports;const ea=Wn(Qo),qn="#000000",Kn=8,zn=[];function Pn(n){const e=p.sceneItems.filter(o=>o.layer==="MAP"),t={};for(let o=0;o<e.length;o++){let a=n.querySelector("#map-"+e[o].id);a===null&&(a=document.createElement("option"),a.id="map-"+e[o].id,a.value=e[o].id,a.innerText=e[o].name,n.appendChild(a)),t[e[o].id]=e[o].name}let i=n.querySelectorAll("option");for(let o=0;o<i.length;o++)t[i[o].value]===void 0&&n.removeChild(i[o])}async function ta(n,e,t,i,o){if(o.innerText="",Number.isNaN(t)||t<0){o.innerText="Invalid DPI";return}let a=p.gridDpi/t,r,d=[];if(d[0]=0,d[1]=0,i!==""){let h=await b.scene.items.getItems([i]);if(h.length>0)r=h[0],t===0&&(t=r.grid.dpi),a=p.gridDpi/t,d[0]=r.position.x-r.grid.offset.x*a,d[1]=r.position.y-r.grid.offset.y*a;else{o.innerText="Unable to find map";return}}else{o.innerText="No map selected";return}n==="foundry"?aa(e,a,d,o):n==="uvtt"&&oa(e,a,d,o)}function Ti(n){const e=[];for(const t of n){const i=[];for(const a of t)i.push({x:a.x*p.gridDpi,y:a.y*p.gridDpi});const o=ct().tension(0).points(i).strokeColor(p.sceneMetadata[`${s.EXTENSIONID}/toolColor`]??qn).strokeDash(p.sceneMetadata[`${s.EXTENSIONID}/toolStyle`]??zn).strokeWidth(p.sceneMetadata[`${s.EXTENSIONID}/toolWidth`]??Kn).fillOpacity(0).fillColor("#000000").layer("DRAWING").name("Vision Line (Line)").closed(!1).locked(!0).visible(!1).metadata({[`${s.EXTENSIONID}/isVisionLine`]:!0}).build();e.push(o)}return e}function na(n){const e=[];for(const t of n){const i=[];for(const a of t.bounds)i.push({x:a.x*p.gridDpi,y:a.y*p.gridDpi});const o=ct().tension(0).points(i).strokeColor(p.sceneMetadata[`${s.EXTENSIONID}/toolColor`]??qn).strokeDash(p.sceneMetadata[`${s.EXTENSIONID}/toolStyle`]??zn).strokeWidth(p.sceneMetadata[`${s.EXTENSIONID}/toolWidth`]??Kn).fillOpacity(0).fillColor("#000000").layer("DRAWING").name("Vision Line (Door)").closed(!1).locked(!0).visible(!1).metadata({[`${s.EXTENSIONID}/isVisionLine`]:!0,[`${s.EXTENSIONID}/isDoor`]:!0}).build();e.push(o)}return e}async function ia(n,e){let t=[];n.objects_line_of_sight?.length>0&&(t=t.concat(Ti(n.objects_line_of_sight))),n.line_of_sight?.length>0&&(t=t.concat(Ti(n.line_of_sight))),n.portals?.length>0&&(t=t.concat(na(n.portals)));try{if(n.lights?.length>0){const h=[];for(const m of n.lights){const N=Xo({height:150,width:150,url:"https://battle-system.com/blank.png",mime:"image/png"},{dpi:300,offset:{x:150,y:150}}).position({x:m.position.x*p.gridDpi,y:m.position.y*p.gridDpi}).layer("CHARACTER").metadata({[`${s.EXTENSIONID}/hasVision`]:!0,[`${s.EXTENSIONID}/visionRange`]:m.range.toString(),[`${s.EXTENSIONID}/visionTorch`]:!0,[`${s.EXTENSIONID}/hiddenToken`]:!0}).name("Imported Light Source").build();h.push(N)}t=t.concat(h)}const i=atob(n.image),o=new Uint8Array(i.length);for(let h=0;h<i.length;h++)o[h]=i.charCodeAt(h);const a=new Blob([o],{type:"image/png"}),r=Fo(a).grid({dpi:n.resolution.pixels_per_grid,offset:{x:0,y:0}}).build(),d=Bo().baseMap(r).name("New UVTT Scene").items(t).build();await b.assets.uploadScenes([d],!0),await b.notification.show("Toggle Smoke Off then On when opening the new Scene","DEFAULT")}catch(i){await b.notification.show("There was an error: "+i,"ERROR")}}async function Wi(n,e,t,i,o){let a=0,r=0,d=0;const h=[];for(let m=0;m<n.length;m++){let N=[],D=!1;for(let A=0;A<n[m].length-1;A++){let M=n[m][A].x*e,T=n[m][A].y*e,P=n[m][A+1].x*e,O=n[m][A+1].y*e;N.push({x:M*t+i[0],y:T*t+i[1]}),N.push({x:P*t+i[0],y:O*t+i[1]}),r++,!D&&n[m][A].door&&(D=!0)}N.length>128&&(N.length,N=ea(N,8,!1));for(let A=0;A<N.length;A+=256){const M=N.slice(A>0?A-1:0,A+256),T=ct().tension(0).points(M).strokeColor(p.sceneMetadata[`${s.EXTENSIONID}/toolColor`]??qn).strokeDash(p.sceneMetadata[`${s.EXTENSIONID}/toolStyle`]??zn).strokeWidth(p.sceneMetadata[`${s.EXTENSIONID}/toolWidth`]??Kn).fillOpacity(0).fillColor("#000000").layer("DRAWING").name("Vision Line (Import)").closed(!1).locked(!0).build();if(T.visible=!1,T.metadata[`${s.EXTENSIONID}/isVisionLine`]=!0,D&&(T.metadata[`${s.EXTENSIONID}/isDoor`]=!0),h.push(T),d+=M.length,d>512||h.length>64){a+=h.length,await b.scene.items.addItems(h);const P=h.filter(O=>O.metadata[`${s.EXTENSIONID}/isDoor`]===!0);await Qt(P),h.length=0,d=0}}}if(h.length>0){a+=h.length,await b.scene.items.addItems(h);const m=h.filter(N=>N.metadata[`${s.EXTENSIONID}/isDoor`]===!0);await Qt(m)}o.innerText="Finished importing "+a+" walls, "+r+" points."}function oa(n,e,t,i){if(n.resolution.map_origin!==void 0&&(t[0]-=n.resolution.map_origin.x*n.resolution.pixels_per_grid,t[1]-=n.resolution.map_origin.y*n.resolution.pixels_per_grid),n.portals&&n.portals.length)for(let a=0;a<n.portals.length;a++){let r=n.portals[a].bounds;r[0].door=!0,r[1].door=!0,n.line_of_sight.push(r)}const o=n.line_of_sight.concat(n.objects_line_of_sight);Wi(o,n.resolution.pixels_per_grid,e,t,i)}function aa(n,e,t,i){if(!n.walls||n.walls.length===0){i.innerText="No walls found";return}const o=[];for(var a=0;a<n.walls.length;a++)o.push([{x:n.walls[a].c[0],y:n.walls[a].c[1],door:!!n.walls[a].door},{x:n.walls[a].c[2],y:n.walls[a].c[3],door:!!n.walls[a].door}]);Wi(o,1,e,t,i)}async function bi(){await b.contextMenu.create({id:`${s.EXTENSIONID}/convert-curve`,icons:[{icon:"/opendoor.svg",label:"Convert to Obstruction",filter:{every:[{key:"layer",value:"DRAWING"},{key:["metadata",`${s.EXTENSIONID}/elevation`],value:void 0},{key:["metadata",`${s.EXTENSIONID}/isVisionLine`],value:void 0}],roles:["GM"]}}],async onClick(n){const e="#000000",i=[],o=[],a=[];for(const r of n.items){if(r.type==="CURVE"){const d=r;if(d.points.length>2){const h=ct().tension(0).points(d.points).strokeColor(p.sceneMetadata[`${s.EXTENSIONID}/toolColor`]??e).strokeDash(p.sceneMetadata[`${s.EXTENSIONID}/toolStyle`]??i).strokeWidth(p.sceneMetadata[`${s.EXTENSIONID}/toolWidth`]??8).fillOpacity(0).fillColor("#000000").layer("DRAWING").name("Vision Line (Line)").closed(!1).locked(!0).visible(!1).position(d.position).metadata({[`${s.EXTENSIONID}/isVisionLine`]:!0}).build();d.style.closed&&h.points.push(d.points[0]),o.push(h),a.push(d.id)}}else if(r.type==="LINE"){const d=r,h=ct().tension(0).points([d.startPosition,d.endPosition]).strokeColor(p.sceneMetadata[`${s.EXTENSIONID}/toolColor`]??e).strokeDash(p.sceneMetadata[`${s.EXTENSIONID}/toolStyle`]??i).strokeWidth(p.sceneMetadata[`${s.EXTENSIONID}/toolWidth`]??8).fillOpacity(0).fillColor("#000000").layer("DRAWING").name("Vision Line (Line)").closed(!1).locked(!0).visible(!1).position(d.position).metadata({[`${s.EXTENSIONID}/isVisionLine`]:!0}).build();o.push(h),a.push(d.id)}else if(r.type==="SHAPE"){const d=r,h=[];if(d.shapeType==="CIRCLE"){const m=Math.min(d.width,d.height)/2,N=2*Math.PI/20;for(let D=0;D<20;D++){const A=D*N,M=m*Math.cos(A),T=m*Math.sin(A);h.push({x:M,y:T})}}else if(d.shapeType==="RECTANGLE"){const D=0+d.width,A=0+d.height;h.push({x:0,y:0}),h.push({x:D,y:0}),h.push({x:D,y:A}),h.push({x:0,y:A})}else if(d.shapeType==="HEXAGON"){const m=d.width/2,N=[Math.PI/2,Math.PI/6,11*Math.PI/6,3*Math.PI/2,7*Math.PI/6,5*Math.PI/6];for(let D=0;D<6;D++){const A=N[D],M=m*Math.cos(A),T=m*Math.sin(A);h.push({x:M,y:T})}}else d.shapeType==="TRIANGLE"&&(h.push({x:0,y:0}),h.push({x:0-d.width/2,y:0+d.height}),h.push({x:0+d.width/2,y:0+d.height}));if(h.length>0){const m=ct().tension(0).points(h).position(d.position).rotation(d.rotation).strokeColor(p.sceneMetadata[`${s.EXTENSIONID}/toolColor`]??e).strokeDash(p.sceneMetadata[`${s.EXTENSIONID}/toolStyle`]??i).strokeWidth(p.sceneMetadata[`${s.EXTENSIONID}/toolWidth`]??8).fillOpacity(0).fillColor("#000000").layer("DRAWING").name("Vision Line (Line)").closed(!1).locked(!0).visible(!1).metadata({[`${s.EXTENSIONID}/isVisionLine`]:!0}).build();m.points.push(h[0]),o.push(m),a.push(d.id)}}o.length>0&&(await b.scene.items.addItems(o),await b.scene.items.deleteItems(a))}}}),await b.contextMenu.create({id:`${s.EXTENSIONID}/toggle-vision-menu`,icons:[{icon:"/no-vision.svg",label:"Enable Vision",filter:{every:[{key:["metadata",`${s.EXTENSIONID}/hasVision`],operator:"==",value:void 0,coordinator:"&&"},{key:["metadata",`${s.SPECTREID}/spectred`],operator:"==",value:void 0}],some:[{key:"layer",value:"CHARACTER",coordinator:"||"},{key:"layer",value:"ATTACHMENT"}]}},{icon:"/icon.svg",label:"Disable Vision",filter:{every:[{key:["metadata",`${s.SPECTREID}/spectred`],operator:"==",value:void 0}],some:[{key:"layer",value:"CHARACTER",coordinator:"||"},{key:"layer",value:"ATTACHMENT"}]}}],async onClick(n){const e=n.items.every(t=>t.metadata[`${s.EXTENSIONID}/hasVision`]===void 0);await b.scene.items.updateItems(n.items,t=>{for(const i of t)e?(i.metadata[`${s.EXTENSIONID}/hasVision`]=!0,i.metadata[`${s.EXTENSIONID}/visionRange`]===void 0&&(i.metadata[`${s.EXTENSIONID}/visionRange`]=s.VISIONDEFAULT)):delete i.metadata[`${s.EXTENSIONID}/hasVision`]})}}),await b.contextMenu.create({id:`${s.EXTENSIONID}/toggle-groupvision-menu`,icons:[{icon:"/no-vision.svg",label:"Toggle Attachments Vision",filter:{every:[{key:"layer",value:"NOTE"},{key:["metadata",`${s.EXTENSIONID}/hasVision`],value:void 0}]}}],async onClick(n){if(n.items.length>0){const e=n.items.map(i=>i.id),t=await b.scene.items.getItemAttachments(e);await b.scene.items.updateItems(t,i=>{for(const o of i)e.includes(o.attachedTo)&&(o.metadata[`${s.EXTENSIONID}/hasVision`]&&(o.layer=="CHARACTER"||o.layer=="ATTACHMENT")?delete o.metadata[`${s.EXTENSIONID}/hasVision`]:(o.layer=="CHARACTER"||o.layer=="ATTACHMENT")&&(o.metadata[`${s.EXTENSIONID}/hasVision`]=!0,o.metadata[`${s.EXTENSIONID}/visionRange`]===void 0&&(o.metadata[`${s.EXTENSIONID}/visionRange`]=s.VISIONDEFAULT)))})}}}),await b.contextMenu.create({id:`${s.EXTENSIONID}/toggle-vision-line`,icons:[{icon:"/icon.svg",label:"Disable Vision Line",filter:{some:[{key:["metadata",`${s.EXTENSIONID}/isVisionLine`],value:!0,coordinator:"&&"},{key:["metadata",`${s.EXTENSIONID}/disabled`],value:void 0,coordinator:"||"},{key:["metadata",`${s.ARMINDOID}/isVisionLine`],value:!0,coordinator:"&&"},{key:["metadata",`${s.ARMINDOID}/disabled`],value:void 0}]}},{icon:"/no-vision.svg",label:"Enable Vision Line",filter:{some:[{key:["metadata",`${s.EXTENSIONID}/isVisionLine`],value:!0,coordinator:"||"},{key:["metadata",`${s.ARMINDOID}/isVisionLine`],value:!0}]}}],async onClick(n){await b.scene.items.updateItems(n.items,e=>{for(const t of e)t.metadata[`${s.EXTENSIONID}/isVisionLine`]&&t.metadata[`${s.EXTENSIONID}/disabled`]?delete t.metadata[`${s.EXTENSIONID}/disabled`]:t.metadata[`${s.EXTENSIONID}/isVisionLine`]&&(t.metadata[`${s.EXTENSIONID}/disabled`]=!0)})}}),await b.contextMenu.create({id:`${s.EXTENSIONID}/switch-one-sided-type`,icons:[{icon:"/two-sided.svg",label:"Two-sided",filter:{some:[{key:["metadata",`${s.EXTENSIONID}/isVisionLine`],value:!0,coordinator:"&&"},{key:["metadata",`${s.EXTENSIONID}/oneSided`],value:void 0,coordinator:"||"},{key:["metadata",`${s.ARMINDOID}/isVisionLine`],value:!0,coordinator:"&&"},{key:["metadata",`${s.ARMINDOID}/oneSided`],value:void 0}]}},{icon:"/left-sided.svg",label:"One-sided left",filter:{some:[{key:["metadata",`${s.EXTENSIONID}/isVisionLine`],value:!0,coordinator:"&&"},{key:["metadata",`${s.EXTENSIONID}/oneSided`],value:"left",coordinator:"||"},{key:["metadata",`${s.ARMINDOID}/isVisionLine`],value:!0,coordinator:"&&"},{key:["metadata",`${s.ARMINDOID}/oneSided`],value:"left"}]}},{icon:"/right-sided.svg",label:"One-sided right",filter:{some:[{key:["metadata",`${s.EXTENSIONID}/isVisionLine`],value:!0,coordinator:"||"},{key:["metadata",`${s.ARMINDOID}/isVisionLine`],value:!0}]}}],async onClick(n){await b.scene.items.updateItems(n.items,e=>{for(const t of e)(t.metadata[`${s.EXTENSIONID}/isVisionLine`]||t.metadata[`${s.ARMINDOID}/isVisionLine`])&&(t.metadata[`${s.EXTENSIONID}/oneSided`]=="right"||t.metadata[`${s.ARMINDOID}/oneSided`]=="right")?(delete t.metadata[`${s.EXTENSIONID}/oneSided`],delete t.metadata[`${s.ARMINDOID}/oneSided`]):(t.metadata[`${s.EXTENSIONID}/isVisionLine`]||t.metadata[`${s.ARMINDOID}/isVisionLine`])&&(t.metadata[`${s.EXTENSIONID}/oneSided`]=="left"||t.metadata[`${s.ARMINDOID}/oneSided`]=="left")?(t.metadata[`${s.EXTENSIONID}/oneSided`]="right",t.metadata[`${s.ARMINDOID}/oneSided`]="right"):(t.metadata[`${s.EXTENSIONID}/isVisionLine`]||t.metadata[`${s.ARMINDOID}/isVisionLine`])&&(t.metadata[`${s.EXTENSIONID}/oneSided`]="left",t.metadata[`${s.ARMINDOID}/oneSided`]="left")})}}),await b.contextMenu.create({id:`${s.EXTENSIONID}/toggle-fog-background`,icons:[{icon:"/fog-background.svg",label:"Convert To Fog Background",filter:{every:[{key:"layer",value:"MAP"}]}}],async onClick(n){n.items.length>0&&await b.scene.items.updateItems(n.items,e=>{for(let t=0;t<e.length;t++)e[t].zIndex=1,e[t].layer="FOG",e[t].disableHit=!0,e[t].locked=!1,e[t].visible=!1,e[t].metadata[`${s.EXTENSIONID}/isBackgroundMap`]=!0})}}),await b.contextMenu.create({id:`${s.EXTENSIONID}/bounding-grid`,icons:[{icon:"/icon.svg",label:"Smoke Bounding Grid",filter:{every:[{key:["metadata",`${s.EXTENSIONID}/grid`],value:!0}]}}],async onClick(n){await b.notification.show("This is the Smoke&Spectre Bounding Grid. It contains the area your fog can be drawn in. To remove this and have fog contained dynamically by the size of your map(s), turn on AutoDetect Maps in Settings.","INFO")}}),await b.contextMenu.create({id:`${s.EXTENSIONID}/create-door`,icons:[{icon:"/opendoor.svg",label:"Enable Door",filter:{every:[{key:"layer",value:"DRAWING"},{key:["metadata",`${s.EXTENSIONID}/isVisionLine`],value:!0},{key:["metadata",`${s.EXTENSIONID}/isDoor`],value:void 0},{key:["metadata",`${s.EXTENSIONID}/doorId`],value:void 0},{key:["metadata",`${s.EXTENSIONID}/grid`],value:void 0}],roles:["GM"]}},{icon:"/closedoor.svg",label:"Disable Door",filter:{every:[{key:"layer",value:"DRAWING"},{key:["metadata",`${s.EXTENSIONID}/isVisionLine`],value:!0},{key:["metadata",`${s.EXTENSIONID}/doorId`],value:void 0},{key:["metadata",`${s.EXTENSIONID}/grid`],value:void 0}],roles:["GM"]}}],async onClick(n){const e=n.items.every(t=>t.metadata[`${s.EXTENSIONID}/isDoor`]===void 0);await b.scene.items.updateItems(n.items,t=>{for(const i of t)e?i.metadata[`${s.EXTENSIONID}/isDoor`]=!0:delete i.metadata[`${s.EXTENSIONID}/isDoor`]}),e?await Qt(n.items):await Yo(n.items)}}),await b.contextMenu.create({id:`${s.EXTENSIONID}/open-door`,icons:[{icon:"/opendoor.svg",label:"Open Door",filter:{every:[{key:"layer",value:"DRAWING"},{key:["metadata",`${s.EXTENSIONID}/isVisionLine`],value:!0},{key:["metadata",`${s.EXTENSIONID}/isDoor`],value:!0},{key:["metadata",`${s.EXTENSIONID}/doorOpen`],value:void 0},{key:["metadata",`${s.EXTENSIONID}/isDoorLocked`],value:void 0}]}},{icon:"/closedoor.svg",label:"Close Door",filter:{every:[{key:"layer",value:"DRAWING"},{key:["metadata",`${s.EXTENSIONID}/isVisionLine`],value:!0},{key:["metadata",`${s.EXTENSIONID}/isDoor`],value:!0},{key:["metadata",`${s.EXTENSIONID}/doorOpen`],value:!0},{key:["metadata",`${s.EXTENSIONID}/isDoorLocked`],value:void 0}]}}],async onClick(n){await b.scene.items.updateItems(n.items,e=>{for(let t of e)t.metadata[`${s.EXTENSIONID}/isVisionLine`]&&t.metadata[`${s.EXTENSIONID}/disabled`]?(delete t.metadata[`${s.EXTENSIONID}/disabled`],delete t.metadata[`${s.EXTENSIONID}/doorOpen`]):t.metadata[`${s.EXTENSIONID}/isVisionLine`]&&(t.metadata[`${s.EXTENSIONID}/disabled`]=!0,t.metadata[`${s.EXTENSIONID}/doorOpen`]=!0)})}}),await b.contextMenu.create({id:`${s.EXTENSIONID}/toggle-door-lock`,icons:[{icon:"/locked-door.svg",label:"Lock Door",filter:{every:[{key:"layer",value:"DRAWING"},{key:["metadata",`${s.EXTENSIONID}/isDoorLocked`],value:void 0},{key:["metadata",`${s.EXTENSIONID}/isDoor`],value:!0},{key:["metadata",`${s.EXTENSIONID}/doorOpen`],value:void 0}],roles:["GM"]}},{icon:"/unlocked-door.svg",label:"Unlock Door",filter:{every:[{key:"layer",value:"DRAWING"},{key:["metadata",`${s.EXTENSIONID}/isVisionLine`],value:!0},{key:["metadata",`${s.EXTENSIONID}/isDoor`],value:!0},{key:["metadata",`${s.EXTENSIONID}/doorOpen`],value:void 0}],roles:["GM"]}}],async onClick(n){const e=n.items.every(t=>t.metadata[`${s.EXTENSIONID}/isDoorLocked`]===void 0);await b.scene.items.updateItems(n.items,t=>{for(const i of t)e?i.metadata[`${s.EXTENSIONID}/isDoorLocked`]=!0:delete i.metadata[`${s.EXTENSIONID}/isDoorLocked`]})}})}async function en(n){n?await b.contextMenu.create({id:`${s.EXTENSIONID}/toggle-autohide-menu`,icons:[{icon:"/autohide-off.svg",label:"Enable Autohide",filter:{every:[{key:"layer",value:"CHARACTER"},{key:["metadata",`${s.EXTENSIONID}/hasAutohide`],value:void 0,coordinator:"&&"},{key:["metadata",`${s.SPECTREID}/spectred`],value:void 0,operator:"=="}],roles:["GM"]}},{icon:"/autohide-on.svg",label:"Disable Autohide",filter:{every:[{key:"layer",value:"CHARACTER",coordinator:"&&"},{key:["metadata",`${s.SPECTREID}/spectred`],value:void 0,operator:"=="}],roles:["GM"]}}],async onClick(e){const t=e.items.every(i=>i.metadata[`${s.EXTENSIONID}/hasAutohide`]===void 0);await b.scene.items.updateItems(e.items,i=>{for(const o of i)t?o.metadata[`${s.EXTENSIONID}/hasAutohide`]=!0:delete o.metadata[`${s.EXTENSIONID}/hasAutohide`]})}}):await b.contextMenu.remove(`${s.EXTENSIONID}/toggle-autohide-menu`)}function Tn(n,e){n.split(/\s+/).forEach(t=>{e(t)})}class ra{constructor(){this._events=void 0,this._events={}}on(e,t){Tn(e,i=>{const o=this._events[i]||[];o.push(t),this._events[i]=o})}off(e,t){var i=arguments.length;if(i===0){this._events={};return}Tn(e,o=>{if(i===1){delete this._events[o];return}const a=this._events[o];a!==void 0&&(a.splice(a.indexOf(t),1),this._events[o]=a)})}trigger(e,...t){var i=this;Tn(e,o=>{const a=i._events[o];a!==void 0&&a.forEach(r=>{r.apply(i,t)})})}}function sa(n){return n.plugins={},class extends n{constructor(...e){super(...e),this.plugins={names:[],settings:{},requested:{},loaded:{}}}static define(e,t){n.plugins[e]={name:e,fn:t}}initializePlugins(e){var t,i;const o=this,a=[];if(Array.isArray(e))e.forEach(r=>{typeof r=="string"?a.push(r):(o.plugins.settings[r.name]=r.options,a.push(r.name))});else if(e)for(t in e)e.hasOwnProperty(t)&&(o.plugins.settings[t]=e[t],a.push(t));for(;i=a.shift();)o.require(i)}loadPlugin(e){var t=this,i=t.plugins,o=n.plugins[e];if(!n.plugins.hasOwnProperty(e))throw new Error('Unable to find "'+e+'" plugin');i.requested[e]=!0,i.loaded[e]=o.fn.apply(t,[t.plugins.settings[e]||{}]),i.names.push(e)}require(e){var t=this,i=t.plugins;if(!t.plugins.loaded.hasOwnProperty(e)){if(i.requested[e])throw new Error('Plugin has circular dependency ("'+e+'")');t.loadPlugin(e)}return i.loaded[e]}}}/*! @orchidjs/unicode-variants | https://github.com/orchidjs/unicode-variants | Apache License (v2) */const rn=n=>(n=n.filter(Boolean),n.length<2?n[0]||"":ca(n)==1?"["+n.join("")+"]":"(?:"+n.join("|")+")"),ji=n=>{if(!la(n))return n.join("");let e="",t=0;const i=()=>{t>1&&(e+="{"+t+"}")};return n.forEach((o,a)=>{if(o===n[a-1]){t++;return}i(),e+=o,t=1}),i(),e},qi=n=>{let e=Yn(n);return rn(e)},la=n=>new Set(n).size!==n.length,Mt=n=>(n+"").replace(/([\$\(\)\*\+\.\?\[\]\^\{\|\}\\])/gu,"\\$1"),ca=n=>n.reduce((e,t)=>Math.max(e,da(t)),0),da=n=>Yn(n).length,Yn=n=>Array.from(n);/*! @orchidjs/unicode-variants | https://github.com/orchidjs/unicode-variants | Apache License (v2) */const Ki=n=>{if(n.length===1)return[[n]];let e=[];const t=n.substring(1);return Ki(t).forEach(function(o){let a=o.slice(0);a[0]=n.charAt(0)+a[0],e.push(a),a=o.slice(0),a.unshift(n.charAt(0)),e.push(a)}),e};/*! @orchidjs/unicode-variants | https://github.com/orchidjs/unicode-variants | Apache License (v2) */const ua=[[0,65535]],fa="[̀-ͯ·ʾʼ]";let tn,zi;const ha=3,Zn={},Ni={"/":"⁄∕",0:"߀",a:"ⱥɐɑ",aa:"ꜳ",ae:"æǽǣ",ao:"ꜵ",au:"ꜷ",av:"ꜹꜻ",ay:"ꜽ",b:"ƀɓƃ",c:"ꜿƈȼↄ",d:"đɗɖᴅƌꮷԁɦ",e:"ɛǝᴇɇ",f:"ꝼƒ",g:"ǥɠꞡᵹꝿɢ",h:"ħⱨⱶɥ",i:"ɨı",j:"ɉȷ",k:"ƙⱪꝁꝃꝅꞣ",l:"łƚɫⱡꝉꝇꞁɭ",m:"ɱɯϻ",n:"ꞥƞɲꞑᴎлԉ",o:"øǿɔɵꝋꝍᴑ",oe:"œ",oi:"ƣ",oo:"ꝏ",ou:"ȣ",p:"ƥᵽꝑꝓꝕρ",q:"ꝗꝙɋ",r:"ɍɽꝛꞧꞃ",s:"ßȿꞩꞅʂ",t:"ŧƭʈⱦꞇ",th:"þ",tz:"ꜩ",u:"ʉ",v:"ʋꝟʌ",vy:"ꝡ",w:"ⱳ",y:"ƴɏỿ",z:"ƶȥɀⱬꝣ",hv:"ƕ"};for(let n in Ni){let e=Ni[n]||"";for(let t=0;t<e.length;t++){let i=e.substring(t,t+1);Zn[i]=n}}const pa=new RegExp(Object.keys(Zn).join("|")+"|"+fa,"gu"),ga=n=>{tn===void 0&&(tn=Ea(n||ua))},Oi=(n,e="NFKD")=>n.normalize(e),nn=n=>Yn(n).reduce((e,t)=>e+ma(t),""),ma=n=>(n=Oi(n).toLowerCase().replace(pa,e=>Zn[e]||""),Oi(n,"NFC"));function*ya(n){for(const[e,t]of n)for(let i=e;i<=t;i++){let o=String.fromCharCode(i),a=nn(o);a!=o.toLowerCase()&&(a.length>ha||a.length!=0&&(yield{folded:a,composed:o,code_point:i}))}}const va=n=>{const e={},t=(i,o)=>{const a=e[i]||new Set,r=new RegExp("^"+qi(a)+"$","iu");o.match(r)||(a.add(Mt(o)),e[i]=a)};for(let i of ya(n))t(i.folded,i.folded),t(i.folded,i.composed);return e},Ea=n=>{const e=va(n),t={};let i=[];for(let a in e){let r=e[a];r&&(t[a]=qi(r)),a.length>1&&i.push(Mt(a))}i.sort((a,r)=>r.length-a.length);const o=rn(i);return zi=new RegExp("^"+o,"u"),t},Ia=(n,e=1)=>{let t=0;return n=n.map(i=>(tn[i]&&(t+=i.length),tn[i]||i)),t>=e?ji(n):""},wa=(n,e=1)=>(e=Math.max(e,n.length-1),rn(Ki(n).map(t=>Ia(t,e)))),ki=(n,e=!0)=>{let t=n.length>1?1:0;return rn(n.map(i=>{let o=[];const a=e?i.length():i.length()-1;for(let r=0;r<a;r++)o.push(wa(i.substrs[r]||"",t));return ji(o)}))},Sa=(n,e)=>{for(const t of e){if(t.start!=n.start||t.end!=n.end||t.substrs.join("")!==n.substrs.join(""))continue;let i=n.parts;const o=r=>{for(const d of i){if(d.start===r.start&&d.substr===r.substr)return!1;if(!(r.length==1||d.length==1)&&(r.start<d.start&&r.end>d.start||d.start<r.start&&d.end>r.start))return!0}return!1};if(!(t.parts.filter(o).length>0))return!0}return!1};class on{constructor(){this.parts=[],this.substrs=[],this.start=0,this.end=0}add(e){e&&(this.parts.push(e),this.substrs.push(e.substr),this.start=Math.min(e.start,this.start),this.end=Math.max(e.end,this.end))}last(){return this.parts[this.parts.length-1]}length(){return this.parts.length}clone(e,t){let i=new on,o=JSON.parse(JSON.stringify(this.parts)),a=o.pop();for(const h of o)i.add(h);let r=t.substr.substring(0,e-a.start),d=r.length;return i.add({start:a.start,end:a.start+d,length:d,substr:r}),i}}const Ta=n=>{ga(),n=nn(n);let e="",t=[new on];for(let i=0;i<n.length;i++){let a=n.substring(i).match(zi);const r=n.substring(i,i+1),d=a?a[0]:null;let h=[],m=new Set;for(const N of t){const D=N.last();if(!D||D.length==1||D.end<=i)if(d){const A=d.length;N.add({start:i,end:i+A,length:A,substr:d}),m.add("1")}else N.add({start:i,end:i+1,length:1,substr:r}),m.add("2");else if(d){let A=N.clone(i,D);const M=d.length;A.add({start:i,end:i+M,length:M,substr:d}),h.push(A)}else m.add("3")}if(h.length>0){h=h.sort((N,D)=>N.length()-D.length());for(let N of h)Sa(N,t)||t.push(N);continue}if(i>0&&m.size==1&&!m.has("3")){e+=ki(t,!1);let N=new on;const D=t[0];D&&N.add(D.last()),t=[N]}}return e+=ki(t,!0),e};/*! sifter.js | https://github.com/orchidjs/sifter.js | Apache License (v2) */const ba=(n,e)=>{if(n)return n[e]},Na=(n,e)=>{if(n){for(var t,i=e.split(".");(t=i.shift())&&(n=n[t]););return n}},bn=(n,e,t)=>{var i,o;return!n||(n=n+"",e.regex==null)||(o=n.search(e.regex),o===-1)?0:(i=e.string.length/n.length,o===0&&(i+=.5),i*t)},Nn=(n,e)=>{var t=n[e];if(typeof t=="function")return t;t&&!Array.isArray(t)&&(n[e]=[t])},Qe=(n,e)=>{if(Array.isArray(n))n.forEach(e);else for(var t in n)n.hasOwnProperty(t)&&e(n[t],t)},Oa=(n,e)=>typeof n=="number"&&typeof e=="number"?n>e?1:n<e?-1:0:(n=nn(n+"").toLowerCase(),e=nn(e+"").toLowerCase(),n>e?1:e>n?-1:0);/*! sifter.js | https://github.com/orchidjs/sifter.js | Apache License (v2) */class ka{constructor(e,t){this.items=void 0,this.settings=void 0,this.items=e,this.settings=t||{diacritics:!0}}tokenize(e,t,i){if(!e||!e.length)return[];const o=[],a=e.split(/\s+/);var r;return i&&(r=new RegExp("^("+Object.keys(i).map(Mt).join("|")+"):(.*)$")),a.forEach(d=>{let h,m=null,N=null;r&&(h=d.match(r))&&(m=h[1],d=h[2]),d.length>0&&(this.settings.diacritics?N=Ta(d)||null:N=Mt(d),N&&t&&(N="\\b"+N)),o.push({string:d,regex:N?new RegExp(N,"iu"):null,field:m})}),o}getScoreFunction(e,t){var i=this.prepareSearch(e,t);return this._getScoreFunction(i)}_getScoreFunction(e){const t=e.tokens,i=t.length;if(!i)return function(){return 0};const o=e.options.fields,a=e.weights,r=o.length,d=e.getAttrFn;if(!r)return function(){return 1};const h=function(){return r===1?function(m,N){const D=o[0].field;return bn(d(N,D),m,a[D]||1)}:function(m,N){var D=0;if(m.field){const A=d(N,m.field);!m.regex&&A?D+=1/r:D+=bn(A,m,1)}else Qe(a,(A,M)=>{D+=bn(d(N,M),m,A)});return D/r}}();return i===1?function(m){return h(t[0],m)}:e.options.conjunction==="and"?function(m){var N,D=0;for(let A of t){if(N=h(A,m),N<=0)return 0;D+=N}return D/i}:function(m){var N=0;return Qe(t,D=>{N+=h(D,m)}),N/i}}getSortFunction(e,t){var i=this.prepareSearch(e,t);return this._getSortFunction(i)}_getSortFunction(e){var t,i=[];const o=this,a=e.options,r=!e.query&&a.sort_empty?a.sort_empty:a.sort;if(typeof r=="function")return r.bind(this);const d=function(N,D){return N==="$score"?D.score:e.getAttrFn(o.items[D.id],N)};if(r)for(let m of r)(e.query||m.field!=="$score")&&i.push(m);if(e.query){t=!0;for(let m of i)if(m.field==="$score"){t=!1;break}t&&i.unshift({field:"$score",direction:"desc"})}else i=i.filter(m=>m.field!=="$score");return i.length?function(m,N){var D,A;for(let M of i)if(A=M.field,D=(M.direction==="desc"?-1:1)*Oa(d(A,m),d(A,N)),D)return D;return 0}:null}prepareSearch(e,t){const i={};var o=Object.assign({},t);if(Nn(o,"sort"),Nn(o,"sort_empty"),o.fields){Nn(o,"fields");const a=[];o.fields.forEach(r=>{typeof r=="string"&&(r={field:r,weight:1}),a.push(r),i[r.field]="weight"in r?r.weight:1}),o.fields=a}return{options:o,query:e.toLowerCase().trim(),tokens:this.tokenize(e,o.respect_word_boundaries,i),total:0,items:[],weights:i,getAttrFn:o.nesting?Na:ba}}search(e,t){var i=this,o,a;a=this.prepareSearch(e,t),t=a.options,e=a.query;const r=t.score||i._getScoreFunction(a);e.length?Qe(i.items,(h,m)=>{o=r(h),(t.filter===!1||o>0)&&a.items.push({score:o,id:m})}):Qe(i.items,(h,m)=>{a.items.push({score:1,id:m})});const d=i._getSortFunction(a);return d&&a.items.sort(d),a.total=a.items.length,typeof t.limit=="number"&&(a.items=a.items.slice(0,t.limit)),a}}const Nt=(n,e)=>{if(Array.isArray(n))n.forEach(e);else for(var t in n)n.hasOwnProperty(t)&&e(n[t],t)},Ge=n=>{if(n.jquery)return n[0];if(n instanceof HTMLElement)return n;if(Yi(n)){var e=document.createElement("template");return e.innerHTML=n.trim(),e.content.firstChild}return document.querySelector(n)},Yi=n=>typeof n=="string"&&n.indexOf("<")>-1,Da=n=>n.replace(/['"\\]/g,"\\$&"),On=(n,e)=>{var t=document.createEvent("HTMLEvents");t.initEvent(e,!0,!1),n.dispatchEvent(t)},Ft=(n,e)=>{Object.assign(n.style,e)},Je=(n,...e)=>{var t=Zi(e);n=Ji(n),n.map(i=>{t.map(o=>{i.classList.add(o)})})},pt=(n,...e)=>{var t=Zi(e);n=Ji(n),n.map(i=>{t.map(o=>{i.classList.remove(o)})})},Zi=n=>{var e=[];return Nt(n,t=>{typeof t=="string"&&(t=t.trim().split(/[\11\12\14\15\40]/)),Array.isArray(t)&&(e=e.concat(t))}),e.filter(Boolean)},Ji=n=>(Array.isArray(n)||(n=[n]),n),Kt=(n,e,t)=>{if(!(t&&!t.contains(n)))for(;n&&n.matches;){if(n.matches(e))return n;n=n.parentNode}},Di=(n,e=0)=>e>0?n[n.length-1]:n[0],Ca=n=>Object.keys(n).length===0,an=(n,e)=>{if(!n)return-1;e=e||n.nodeName;for(var t=0;n=n.previousElementSibling;)n.matches(e)&&t++;return t},Fe=(n,e)=>{Nt(e,(t,i)=>{t==null?n.removeAttribute(i):n.setAttribute(i,""+t)})},Ln=(n,e)=>{n.parentNode&&n.parentNode.replaceChild(e,n)},xa=(n,e)=>{if(e===null)return;if(typeof e=="string"){if(!e.length)return;e=new RegExp(e,"i")}const t=a=>{var r=a.data.match(e);if(r&&a.data.length>0){var d=document.createElement("span");d.className="highlight";var h=a.splitText(r.index);h.splitText(r[0].length);var m=h.cloneNode(!0);return d.appendChild(m),Ln(h,d),1}return 0},i=a=>{a.nodeType===1&&a.childNodes&&!/(script|style)/i.test(a.tagName)&&(a.className!=="highlight"||a.tagName!=="SPAN")&&Array.from(a.childNodes).forEach(r=>{o(r)})},o=a=>a.nodeType===3?t(a):(i(a),0);o(n)},_a=n=>{var e=n.querySelectorAll("span.highlight");Array.prototype.forEach.call(e,function(t){var i=t.parentNode;i.replaceChild(t.firstChild,t),i.normalize()})},Aa=65,Ma=13,Qi=27,Rn=37,$a=38,eo=39,Pa=40,Ci=8,La=46,Xn=9,Ra=typeof navigator>"u"?!1:/Mac/.test(navigator.userAgent),Bt=Ra?"metaKey":"ctrlKey";var xi={options:[],optgroups:[],plugins:[],delimiter:",",splitOn:null,persist:!0,diacritics:!0,create:null,createOnBlur:!1,createFilter:null,highlight:!0,openOnFocus:!0,shouldOpen:null,maxOptions:50,maxItems:null,hideSelected:null,duplicates:!1,addPrecedence:!1,selectOnTab:!1,preload:null,allowEmptyOption:!1,refreshThrottle:300,loadThrottle:300,loadingClass:"loading",dataAttr:null,optgroupField:"optgroup",valueField:"value",labelField:"text",disabledField:"disabled",optgroupLabelField:"label",optgroupValueField:"value",lockOptgroupOrder:!1,sortField:"$order",searchField:["text"],searchConjunction:"and",mode:null,wrapperClass:"ts-wrapper",controlClass:"ts-control",dropdownClass:"ts-dropdown",dropdownContentClass:"ts-dropdown-content",itemClass:"item",optionClass:"option",dropdownParent:null,controlInput:'<input type="text" autocomplete="off" size="1" />',copyClassesToDropdown:!1,placeholder:null,hidePlaceholder:null,shouldLoad:function(n){return n.length>0},render:{}};const rt=n=>typeof n>"u"||n===null?null:zt(n),zt=n=>typeof n=="boolean"?n?"1":"0":n+"",Yt=n=>(n+"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;"),Xa=(n,e)=>e>0?setTimeout(n,e):(n.call(null),null),Fa=(n,e)=>{var t;return function(i,o){var a=this;t&&(a.loading=Math.max(a.loading-1,0),clearTimeout(t)),t=setTimeout(function(){t=null,a.loadedSearches[i]=!0,n.call(a,i,o)},e)}},_i=(n,e,t)=>{var i,o=n.trigger,a={};n.trigger=function(){var r=arguments[0];if(e.indexOf(r)!==-1)a[r]=arguments;else return o.apply(n,arguments)},t.apply(n,[]),n.trigger=o;for(i of e)i in a&&o.apply(n,a[i])},Ba=n=>({start:n.selectionStart||0,length:(n.selectionEnd||0)-(n.selectionStart||0)}),$e=(n,e=!1)=>{n&&(n.preventDefault(),e&&n.stopPropagation())},Pe=(n,e,t,i)=>{n.addEventListener(e,t,i)},It=(n,e)=>{if(!e||!e[n])return!1;var t=(e.altKey?1:0)+(e.ctrlKey?1:0)+(e.shiftKey?1:0)+(e.metaKey?1:0);return t===1},kn=(n,e)=>{const t=n.getAttribute("id");return t||(n.setAttribute("id",e),e)},Ai=n=>n.replace(/[\\"']/g,"\\$&"),wt=(n,e)=>{e&&n.append(e)};function Mi(n,e){var t=Object.assign({},xi,e),i=t.dataAttr,o=t.labelField,a=t.valueField,r=t.disabledField,d=t.optgroupField,h=t.optgroupLabelField,m=t.optgroupValueField,N=n.tagName.toLowerCase(),D=n.getAttribute("placeholder")||n.getAttribute("data-placeholder");if(!D&&!t.allowEmptyOption){let P=n.querySelector('option[value=""]');P&&(D=P.textContent)}var A={placeholder:D,options:[],optgroups:[],items:[],maxItems:null},M=()=>{var P,O=A.options,L={},$=1;let H=0;var R=w=>{var g=Object.assign({},w.dataset),I=i&&g[i];return typeof I=="string"&&I.length&&(g=Object.assign(g,JSON.parse(I))),g},ie=(w,g)=>{var I=rt(w.value);if(I!=null&&!(!I&&!t.allowEmptyOption)){if(L.hasOwnProperty(I)){if(g){var y=L[I][d];y?Array.isArray(y)?y.push(g):L[I][d]=[y,g]:L[I][d]=g}}else{var C=R(w);C[o]=C[o]||w.textContent,C[a]=C[a]||I,C[r]=C[r]||w.disabled,C[d]=C[d]||g,C.$option=w,C.$order=C.$order||++H,L[I]=C,O.push(C)}w.selected&&A.items.push(I)}},x=w=>{var g,I;I=R(w),I[h]=I[h]||w.getAttribute("label")||"",I[m]=I[m]||$++,I[r]=I[r]||w.disabled,I.$order=I.$order||++H,A.optgroups.push(I),g=I[m],Nt(w.children,y=>{ie(y,g)})};A.maxItems=n.hasAttribute("multiple")?null:1,Nt(n.children,w=>{P=w.tagName.toLowerCase(),P==="optgroup"?x(w):P==="option"&&ie(w)})},T=()=>{const P=n.getAttribute(i);if(P)A.options=JSON.parse(P),Nt(A.options,L=>{A.items.push(L[a])});else{var O=n.value.trim()||"";if(!t.allowEmptyOption&&!O.length)return;const L=O.split(t.delimiter);Nt(L,$=>{const H={};H[o]=$,H[a]=$,A.options.push(H)}),A.items=L}};return N==="select"?M():T(),Object.assign({},xi,A,e)}var $i=0;class et extends sa(ra){constructor(e,t){super(),this.control_input=void 0,this.wrapper=void 0,this.dropdown=void 0,this.control=void 0,this.dropdown_content=void 0,this.focus_node=void 0,this.order=0,this.settings=void 0,this.input=void 0,this.tabIndex=void 0,this.is_select_tag=void 0,this.rtl=void 0,this.inputId=void 0,this._destroy=void 0,this.sifter=void 0,this.isOpen=!1,this.isDisabled=!1,this.isReadOnly=!1,this.isRequired=void 0,this.isInvalid=!1,this.isValid=!0,this.isLocked=!1,this.isFocused=!1,this.isInputHidden=!1,this.isSetup=!1,this.ignoreFocus=!1,this.ignoreHover=!1,this.hasOptions=!1,this.currentResults=void 0,this.lastValue="",this.caretPos=0,this.loading=0,this.loadedSearches={},this.activeOption=null,this.activeItems=[],this.optgroups={},this.options={},this.userOptions={},this.items=[],this.refreshTimeout=null,$i++;var i,o=Ge(e);if(o.tomselect)throw new Error("Tom Select already initialized on this element");o.tomselect=this;var a=window.getComputedStyle&&window.getComputedStyle(o,null);i=a.getPropertyValue("direction");const r=Mi(o,t);this.settings=r,this.input=o,this.tabIndex=o.tabIndex||0,this.is_select_tag=o.tagName.toLowerCase()==="select",this.rtl=/rtl/i.test(i),this.inputId=kn(o,"tomselect-"+$i),this.isRequired=o.required,this.sifter=new ka(this.options,{diacritics:r.diacritics}),r.mode=r.mode||(r.maxItems===1?"single":"multi"),typeof r.hideSelected!="boolean"&&(r.hideSelected=r.mode==="multi"),typeof r.hidePlaceholder!="boolean"&&(r.hidePlaceholder=r.mode!=="multi");var d=r.createFilter;typeof d!="function"&&(typeof d=="string"&&(d=new RegExp(d)),d instanceof RegExp?r.createFilter=O=>d.test(O):r.createFilter=O=>this.settings.duplicates||!this.options[O]),this.initializePlugins(r.plugins),this.setupCallbacks(),this.setupTemplates();const h=Ge("<div>"),m=Ge("<div>"),N=this._render("dropdown"),D=Ge('<div role="listbox" tabindex="-1">'),A=this.input.getAttribute("class")||"",M=r.mode;var T;if(Je(h,r.wrapperClass,A,M),Je(m,r.controlClass),wt(h,m),Je(N,r.dropdownClass,M),r.copyClassesToDropdown&&Je(N,A),Je(D,r.dropdownContentClass),wt(N,D),Ge(r.dropdownParent||h).appendChild(N),Yi(r.controlInput)){T=Ge(r.controlInput);var P=["autocorrect","autocapitalize","autocomplete","spellcheck"];Qe(P,O=>{o.getAttribute(O)&&Fe(T,{[O]:o.getAttribute(O)})}),T.tabIndex=-1,m.appendChild(T),this.focus_node=T}else r.controlInput?(T=Ge(r.controlInput),this.focus_node=T):(T=Ge("<input/>"),this.focus_node=m);this.wrapper=h,this.dropdown=N,this.dropdown_content=D,this.control=m,this.control_input=T,this.setup()}setup(){const e=this,t=e.settings,i=e.control_input,o=e.dropdown,a=e.dropdown_content,r=e.wrapper,d=e.control,h=e.input,m=e.focus_node,N={passive:!0},D=e.inputId+"-ts-dropdown";Fe(a,{id:D}),Fe(m,{role:"combobox","aria-haspopup":"listbox","aria-expanded":"false","aria-controls":D});const A=kn(m,e.inputId+"-ts-control"),M="label[for='"+Da(e.inputId)+"']",T=document.querySelector(M),P=e.focus.bind(e);if(T){Pe(T,"click",P),Fe(T,{for:A});const $=kn(T,e.inputId+"-ts-label");Fe(m,{"aria-labelledby":$}),Fe(a,{"aria-labelledby":$})}if(r.style.width=h.style.width,e.plugins.names.length){const $="plugin-"+e.plugins.names.join(" plugin-");Je([r,o],$)}(t.maxItems===null||t.maxItems>1)&&e.is_select_tag&&Fe(h,{multiple:"multiple"}),t.placeholder&&Fe(i,{placeholder:t.placeholder}),!t.splitOn&&t.delimiter&&(t.splitOn=new RegExp("\\s*"+Mt(t.delimiter)+"+\\s*")),t.load&&t.loadThrottle&&(t.load=Fa(t.load,t.loadThrottle)),Pe(o,"mousemove",()=>{e.ignoreHover=!1}),Pe(o,"mouseenter",$=>{var H=Kt($.target,"[data-selectable]",o);H&&e.onOptionHover($,H)},{capture:!0}),Pe(o,"click",$=>{const H=Kt($.target,"[data-selectable]");H&&(e.onOptionSelect($,H),$e($,!0))}),Pe(d,"click",$=>{var H=Kt($.target,"[data-ts-item]",d);if(H&&e.onItemSelect($,H)){$e($,!0);return}i.value==""&&(e.onClick(),$e($,!0))}),Pe(m,"keydown",$=>e.onKeyDown($)),Pe(i,"keypress",$=>e.onKeyPress($)),Pe(i,"input",$=>e.onInput($)),Pe(m,"blur",$=>e.onBlur($)),Pe(m,"focus",$=>e.onFocus($)),Pe(i,"paste",$=>e.onPaste($));const O=$=>{const H=$.composedPath()[0];if(!r.contains(H)&&!o.contains(H)){e.isFocused&&e.blur(),e.inputState();return}H==i&&e.isOpen?$.stopPropagation():$e($,!0)},L=()=>{e.isOpen&&e.positionDropdown()};Pe(document,"mousedown",O),Pe(window,"scroll",L,N),Pe(window,"resize",L,N),this._destroy=()=>{document.removeEventListener("mousedown",O),window.removeEventListener("scroll",L),window.removeEventListener("resize",L),T&&T.removeEventListener("click",P)},this.revertSettings={innerHTML:h.innerHTML,tabIndex:h.tabIndex},h.tabIndex=-1,h.insertAdjacentElement("afterend",e.wrapper),e.sync(!1),t.items=[],delete t.optgroups,delete t.options,Pe(h,"invalid",()=>{e.isValid&&(e.isValid=!1,e.isInvalid=!0,e.refreshState())}),e.updateOriginalInput(),e.refreshItems(),e.close(!1),e.inputState(),e.isSetup=!0,h.disabled?e.disable():h.readOnly?e.setReadOnly(!0):e.enable(),e.on("change",this.onChange),Je(h,"tomselected","ts-hidden-accessible"),e.trigger("initialize"),t.preload===!0&&e.preload()}setupOptions(e=[],t=[]){this.addOptions(e),Qe(t,i=>{this.registerOptionGroup(i)})}setupTemplates(){var e=this,t=e.settings.labelField,i=e.settings.optgroupLabelField,o={optgroup:a=>{let r=document.createElement("div");return r.className="optgroup",r.appendChild(a.options),r},optgroup_header:(a,r)=>'<div class="optgroup-header">'+r(a[i])+"</div>",option:(a,r)=>"<div>"+r(a[t])+"</div>",item:(a,r)=>"<div>"+r(a[t])+"</div>",option_create:(a,r)=>'<div class="create">Add <strong>'+r(a.input)+"</strong>&hellip;</div>",no_results:()=>'<div class="no-results">No results found</div>',loading:()=>'<div class="spinner"></div>',not_loading:()=>{},dropdown:()=>"<div></div>"};e.settings.render=Object.assign({},o,e.settings.render)}setupCallbacks(){var e,t,i={initialize:"onInitialize",change:"onChange",item_add:"onItemAdd",item_remove:"onItemRemove",item_select:"onItemSelect",clear:"onClear",option_add:"onOptionAdd",option_remove:"onOptionRemove",option_clear:"onOptionClear",optgroup_add:"onOptionGroupAdd",optgroup_remove:"onOptionGroupRemove",optgroup_clear:"onOptionGroupClear",dropdown_open:"onDropdownOpen",dropdown_close:"onDropdownClose",type:"onType",load:"onLoad",focus:"onFocus",blur:"onBlur"};for(e in i)t=this.settings[i[e]],t&&this.on(e,t)}sync(e=!0){const t=this,i=e?Mi(t.input,{delimiter:t.settings.delimiter}):t.settings;t.setupOptions(i.options,i.optgroups),t.setValue(i.items||[],!0),t.lastQuery=null}onClick(){var e=this;if(e.activeItems.length>0){e.clearActiveItems(),e.focus();return}e.isFocused&&e.isOpen?e.blur():e.focus()}onMouseDown(){}onChange(){On(this.input,"input"),On(this.input,"change")}onPaste(e){var t=this;if(t.isInputHidden||t.isLocked){$e(e);return}t.settings.splitOn&&setTimeout(()=>{var i=t.inputValue();if(i.match(t.settings.splitOn)){var o=i.trim().split(t.settings.splitOn);Qe(o,a=>{rt(a)&&(this.options[a]?t.addItem(a):t.createItem(a))})}},0)}onKeyPress(e){var t=this;if(t.isLocked){$e(e);return}var i=String.fromCharCode(e.keyCode||e.which);if(t.settings.create&&t.settings.mode==="multi"&&i===t.settings.delimiter){t.createItem(),$e(e);return}}onKeyDown(e){var t=this;if(t.ignoreHover=!0,t.isLocked){e.keyCode!==Xn&&$e(e);return}switch(e.keyCode){case Aa:if(It(Bt,e)&&t.control_input.value==""){$e(e),t.selectAll();return}break;case Qi:t.isOpen&&($e(e,!0),t.close()),t.clearActiveItems();return;case Pa:if(!t.isOpen&&t.hasOptions)t.open();else if(t.activeOption){let i=t.getAdjacent(t.activeOption,1);i&&t.setActiveOption(i)}$e(e);return;case $a:if(t.activeOption){let i=t.getAdjacent(t.activeOption,-1);i&&t.setActiveOption(i)}$e(e);return;case Ma:t.canSelect(t.activeOption)?(t.onOptionSelect(e,t.activeOption),$e(e)):(t.settings.create&&t.createItem()||document.activeElement==t.control_input&&t.isOpen)&&$e(e);return;case Rn:t.advanceSelection(-1,e);return;case eo:t.advanceSelection(1,e);return;case Xn:t.settings.selectOnTab&&(t.canSelect(t.activeOption)&&(t.onOptionSelect(e,t.activeOption),$e(e)),t.settings.create&&t.createItem()&&$e(e));return;case Ci:case La:t.deleteSelection(e);return}t.isInputHidden&&!It(Bt,e)&&$e(e)}onInput(e){if(this.isLocked)return;const t=this.inputValue();if(this.lastValue!==t){if(this.lastValue=t,t==""){this._onInput();return}this.refreshTimeout&&clearTimeout(this.refreshTimeout),this.refreshTimeout=Xa(()=>{this.refreshTimeout=null,this._onInput()},this.settings.refreshThrottle)}}_onInput(){const e=this.lastValue;this.settings.shouldLoad.call(this,e)&&this.load(e),this.refreshOptions(),this.trigger("type",e)}onOptionHover(e,t){this.ignoreHover||this.setActiveOption(t,!1)}onFocus(e){var t=this,i=t.isFocused;if(t.isDisabled||t.isReadOnly){t.blur(),$e(e);return}t.ignoreFocus||(t.isFocused=!0,t.settings.preload==="focus"&&t.preload(),i||t.trigger("focus"),t.activeItems.length||(t.inputState(),t.refreshOptions(!!t.settings.openOnFocus)),t.refreshState())}onBlur(e){if(document.hasFocus()!==!1){var t=this;if(t.isFocused){t.isFocused=!1,t.ignoreFocus=!1;var i=()=>{t.close(),t.setActiveItem(),t.setCaret(t.items.length),t.trigger("blur")};t.settings.create&&t.settings.createOnBlur?t.createItem(null,i):i()}}}onOptionSelect(e,t){var i,o=this;t.parentElement&&t.parentElement.matches("[data-disabled]")||(t.classList.contains("create")?o.createItem(null,()=>{o.settings.closeAfterSelect&&o.close()}):(i=t.dataset.value,typeof i<"u"&&(o.lastQuery=null,o.addItem(i),o.settings.closeAfterSelect&&o.close(),!o.settings.hideSelected&&e.type&&/click/.test(e.type)&&o.setActiveOption(t))))}canSelect(e){return!!(this.isOpen&&e&&this.dropdown_content.contains(e))}onItemSelect(e,t){var i=this;return!i.isLocked&&i.settings.mode==="multi"?($e(e),i.setActiveItem(t,e),!0):!1}canLoad(e){return!(!this.settings.load||this.loadedSearches.hasOwnProperty(e))}load(e){const t=this;if(!t.canLoad(e))return;Je(t.wrapper,t.settings.loadingClass),t.loading++;const i=t.loadCallback.bind(t);t.settings.load.call(t,e,i)}loadCallback(e,t){const i=this;i.loading=Math.max(i.loading-1,0),i.lastQuery=null,i.clearActiveOption(),i.setupOptions(e,t),i.refreshOptions(i.isFocused&&!i.isInputHidden),i.loading||pt(i.wrapper,i.settings.loadingClass),i.trigger("load",e,t)}preload(){var e=this.wrapper.classList;e.contains("preloaded")||(e.add("preloaded"),this.load(""))}setTextboxValue(e=""){var t=this.control_input,i=t.value!==e;i&&(t.value=e,On(t,"update"),this.lastValue=e)}getValue(){return this.is_select_tag&&this.input.hasAttribute("multiple")?this.items:this.items.join(this.settings.delimiter)}setValue(e,t){var i=t?[]:["change"];_i(this,i,()=>{this.clear(t),this.addItems(e,t)})}setMaxItems(e){e===0&&(e=null),this.settings.maxItems=e,this.refreshState()}setActiveItem(e,t){var i=this,o,a,r,d,h,m;if(i.settings.mode!=="single"){if(!e){i.clearActiveItems(),i.isFocused&&i.inputState();return}if(o=t&&t.type.toLowerCase(),o==="click"&&It("shiftKey",t)&&i.activeItems.length){for(m=i.getLastActive(),r=Array.prototype.indexOf.call(i.control.children,m),d=Array.prototype.indexOf.call(i.control.children,e),r>d&&(h=r,r=d,d=h),a=r;a<=d;a++)e=i.control.children[a],i.activeItems.indexOf(e)===-1&&i.setActiveItemClass(e);$e(t)}else o==="click"&&It(Bt,t)||o==="keydown"&&It("shiftKey",t)?e.classList.contains("active")?i.removeActiveItem(e):i.setActiveItemClass(e):(i.clearActiveItems(),i.setActiveItemClass(e));i.inputState(),i.isFocused||i.focus()}}setActiveItemClass(e){const t=this,i=t.control.querySelector(".last-active");i&&pt(i,"last-active"),Je(e,"active last-active"),t.trigger("item_select",e),t.activeItems.indexOf(e)==-1&&t.activeItems.push(e)}removeActiveItem(e){var t=this.activeItems.indexOf(e);this.activeItems.splice(t,1),pt(e,"active")}clearActiveItems(){pt(this.activeItems,"active"),this.activeItems=[]}setActiveOption(e,t=!0){e!==this.activeOption&&(this.clearActiveOption(),e&&(this.activeOption=e,Fe(this.focus_node,{"aria-activedescendant":e.getAttribute("id")}),Fe(e,{"aria-selected":"true"}),Je(e,"active"),t&&this.scrollToOption(e)))}scrollToOption(e,t){if(!e)return;const i=this.dropdown_content,o=i.clientHeight,a=i.scrollTop||0,r=e.offsetHeight,d=e.getBoundingClientRect().top-i.getBoundingClientRect().top+a;d+r>o+a?this.scroll(d-o+r,t):d<a&&this.scroll(d,t)}scroll(e,t){const i=this.dropdown_content;t&&(i.style.scrollBehavior=t),i.scrollTop=e,i.style.scrollBehavior=""}clearActiveOption(){this.activeOption&&(pt(this.activeOption,"active"),Fe(this.activeOption,{"aria-selected":null})),this.activeOption=null,Fe(this.focus_node,{"aria-activedescendant":null})}selectAll(){const e=this;if(e.settings.mode==="single")return;const t=e.controlChildren();t.length&&(e.inputState(),e.close(),e.activeItems=t,Qe(t,i=>{e.setActiveItemClass(i)}))}inputState(){var e=this;e.control.contains(e.control_input)&&(Fe(e.control_input,{placeholder:e.settings.placeholder}),e.activeItems.length>0||!e.isFocused&&e.settings.hidePlaceholder&&e.items.length>0?(e.setTextboxValue(),e.isInputHidden=!0):(e.settings.hidePlaceholder&&e.items.length>0&&Fe(e.control_input,{placeholder:""}),e.isInputHidden=!1),e.wrapper.classList.toggle("input-hidden",e.isInputHidden))}inputValue(){return this.control_input.value.trim()}focus(){var e=this;e.isDisabled||e.isReadOnly||(e.ignoreFocus=!0,e.control_input.offsetWidth?e.control_input.focus():e.focus_node.focus(),setTimeout(()=>{e.ignoreFocus=!1,e.onFocus()},0))}blur(){this.focus_node.blur(),this.onBlur()}getScoreFunction(e){return this.sifter.getScoreFunction(e,this.getSearchOptions())}getSearchOptions(){var e=this.settings,t=e.sortField;return typeof e.sortField=="string"&&(t=[{field:e.sortField}]),{fields:e.searchField,conjunction:e.searchConjunction,sort:t,nesting:e.nesting}}search(e){var t,i,o=this,a=this.getSearchOptions();if(o.settings.score&&(i=o.settings.score.call(o,e),typeof i!="function"))throw new Error('Tom Select "score" setting must be a function that returns a function');return e!==o.lastQuery?(o.lastQuery=e,t=o.sifter.search(e,Object.assign(a,{score:i})),o.currentResults=t):t=Object.assign({},o.currentResults),o.settings.hideSelected&&(t.items=t.items.filter(r=>{let d=rt(r.id);return!(d&&o.items.indexOf(d)!==-1)})),t}refreshOptions(e=!0){var t,i,o,a,r,d,h,m,N,D;const A={},M=[];var T=this,P=T.inputValue();const O=P===T.lastQuery||P==""&&T.lastQuery==null;var L=T.search(P),$=null,H=T.settings.shouldOpen||!1,R=T.dropdown_content;O&&($=T.activeOption,$&&(N=$.closest("[data-group]"))),a=L.items.length,typeof T.settings.maxOptions=="number"&&(a=Math.min(a,T.settings.maxOptions)),a>0&&(H=!0);const ie=(w,g)=>{let I=A[w];if(I!==void 0){let C=M[I];if(C!==void 0)return[I,C.fragment]}let y=document.createDocumentFragment();return I=M.length,M.push({fragment:y,order:g,optgroup:w}),[I,y]};for(t=0;t<a;t++){let w=L.items[t];if(!w)continue;let g=w.id,I=T.options[g];if(I===void 0)continue;let y=zt(g),C=T.getOption(y,!0);for(T.settings.hideSelected||C.classList.toggle("selected",T.items.includes(y)),r=I[T.settings.optgroupField]||"",d=Array.isArray(r)?r:[r],i=0,o=d&&d.length;i<o;i++){r=d[i];let X=I.$order,q=T.optgroups[r];q===void 0?r="":X=q.$order;const[oe,se]=ie(r,X);i>0&&(C=C.cloneNode(!0),Fe(C,{id:I.$id+"-clone-"+i,"aria-selected":null}),C.classList.add("ts-cloned"),pt(C,"active"),T.activeOption&&T.activeOption.dataset.value==g&&N&&N.dataset.group===r.toString()&&($=C)),se.appendChild(C),r!=""&&(A[r]=oe)}}T.settings.lockOptgroupOrder&&M.sort((w,g)=>w.order-g.order),h=document.createDocumentFragment(),Qe(M,w=>{let g=w.fragment,I=w.optgroup;if(!g||!g.children.length)return;let y=T.optgroups[I];if(y!==void 0){let C=document.createDocumentFragment(),X=T.render("optgroup_header",y);wt(C,X),wt(C,g);let q=T.render("optgroup",{group:y,options:C});wt(h,q)}else wt(h,g)}),R.innerHTML="",wt(R,h),T.settings.highlight&&(_a(R),L.query.length&&L.tokens.length&&Qe(L.tokens,w=>{xa(R,w.regex)}));var x=w=>{let g=T.render(w,{input:P});return g&&(H=!0,R.insertBefore(g,R.firstChild)),g};if(T.loading?x("loading"):T.settings.shouldLoad.call(T,P)?L.items.length===0&&x("no_results"):x("not_loading"),m=T.canCreate(P),m&&(D=x("option_create")),T.hasOptions=L.items.length>0||m,H){if(L.items.length>0){if(!$&&T.settings.mode==="single"&&T.items[0]!=null&&($=T.getOption(T.items[0])),!R.contains($)){let w=0;D&&!T.settings.addPrecedence&&(w=1),$=T.selectable()[w]}}else D&&($=D);e&&!T.isOpen&&(T.open(),T.scrollToOption($,"auto")),T.setActiveOption($)}else T.clearActiveOption(),e&&T.isOpen&&T.close(!1)}selectable(){return this.dropdown_content.querySelectorAll("[data-selectable]")}addOption(e,t=!1){const i=this;if(Array.isArray(e))return i.addOptions(e,t),!1;const o=rt(e[i.settings.valueField]);return o===null||i.options.hasOwnProperty(o)?!1:(e.$order=e.$order||++i.order,e.$id=i.inputId+"-opt-"+e.$order,i.options[o]=e,i.lastQuery=null,t&&(i.userOptions[o]=t,i.trigger("option_add",o,e)),o)}addOptions(e,t=!1){Qe(e,i=>{this.addOption(i,t)})}registerOption(e){return this.addOption(e)}registerOptionGroup(e){var t=rt(e[this.settings.optgroupValueField]);return t===null?!1:(e.$order=e.$order||++this.order,this.optgroups[t]=e,t)}addOptionGroup(e,t){var i;t[this.settings.optgroupValueField]=e,(i=this.registerOptionGroup(t))&&this.trigger("optgroup_add",i,t)}removeOptionGroup(e){this.optgroups.hasOwnProperty(e)&&(delete this.optgroups[e],this.clearCache(),this.trigger("optgroup_remove",e))}clearOptionGroups(){this.optgroups={},this.clearCache(),this.trigger("optgroup_clear")}updateOption(e,t){const i=this;var o,a;const r=rt(e),d=rt(t[i.settings.valueField]);if(r===null)return;const h=i.options[r];if(h==null)return;if(typeof d!="string")throw new Error("Value must be set in option data");const m=i.getOption(r),N=i.getItem(r);if(t.$order=t.$order||h.$order,delete i.options[r],i.uncacheValue(d),i.options[d]=t,m){if(i.dropdown_content.contains(m)){const D=i._render("option",t);Ln(m,D),i.activeOption===m&&i.setActiveOption(D)}m.remove()}N&&(a=i.items.indexOf(r),a!==-1&&i.items.splice(a,1,d),o=i._render("item",t),N.classList.contains("active")&&Je(o,"active"),Ln(N,o)),i.lastQuery=null}removeOption(e,t){const i=this;e=zt(e),i.uncacheValue(e),delete i.userOptions[e],delete i.options[e],i.lastQuery=null,i.trigger("option_remove",e),i.removeItem(e,t)}clearOptions(e){const t=(e||this.clearFilter).bind(this);this.loadedSearches={},this.userOptions={},this.clearCache();const i={};Qe(this.options,(o,a)=>{t(o,a)&&(i[a]=o)}),this.options=this.sifter.items=i,this.lastQuery=null,this.trigger("option_clear")}clearFilter(e,t){return this.items.indexOf(t)>=0}getOption(e,t=!1){const i=rt(e);if(i===null)return null;const o=this.options[i];if(o!=null){if(o.$div)return o.$div;if(t)return this._render("option",o)}return null}getAdjacent(e,t,i="option"){var o=this,a;if(!e)return null;i=="item"?a=o.controlChildren():a=o.dropdown_content.querySelectorAll("[data-selectable]");for(let r=0;r<a.length;r++)if(a[r]==e)return t>0?a[r+1]:a[r-1];return null}getItem(e){if(typeof e=="object")return e;var t=rt(e);return t!==null?this.control.querySelector(`[data-value="${Ai(t)}"]`):null}addItems(e,t){var i=this,o=Array.isArray(e)?e:[e];o=o.filter(r=>i.items.indexOf(r)===-1);const a=o[o.length-1];o.forEach(r=>{i.isPending=r!==a,i.addItem(r,t)})}addItem(e,t){var i=t?[]:["change","dropdown_close"];_i(this,i,()=>{var o,a;const r=this,d=r.settings.mode,h=rt(e);if(!(h&&r.items.indexOf(h)!==-1&&(d==="single"&&r.close(),d==="single"||!r.settings.duplicates))&&!(h===null||!r.options.hasOwnProperty(h))&&(d==="single"&&r.clear(t),!(d==="multi"&&r.isFull()))){if(o=r._render("item",r.options[h]),r.control.contains(o)&&(o=o.cloneNode(!0)),a=r.isFull(),r.items.splice(r.caretPos,0,h),r.insertAtCaret(o),r.isSetup){if(!r.isPending&&r.settings.hideSelected){let m=r.getOption(h),N=r.getAdjacent(m,1);N&&r.setActiveOption(N)}!r.isPending&&!r.settings.closeAfterSelect&&r.refreshOptions(r.isFocused&&d!=="single"),r.settings.closeAfterSelect!=!1&&r.isFull()?r.close():r.isPending||r.positionDropdown(),r.trigger("item_add",h,o),r.isPending||r.updateOriginalInput({silent:t})}(!r.isPending||!a&&r.isFull())&&(r.inputState(),r.refreshState())}})}removeItem(e=null,t){const i=this;if(e=i.getItem(e),!e)return;var o,a;const r=e.dataset.value;o=an(e),e.remove(),e.classList.contains("active")&&(a=i.activeItems.indexOf(e),i.activeItems.splice(a,1),pt(e,"active")),i.items.splice(o,1),i.lastQuery=null,!i.settings.persist&&i.userOptions.hasOwnProperty(r)&&i.removeOption(r,t),o<i.caretPos&&i.setCaret(i.caretPos-1),i.updateOriginalInput({silent:t}),i.refreshState(),i.positionDropdown(),i.trigger("item_remove",r,e)}createItem(e=null,t=()=>{}){arguments.length===3&&(t=arguments[2]),typeof t!="function"&&(t=()=>{});var i=this,o=i.caretPos,a;if(e=e||i.inputValue(),!i.canCreate(e))return t(),!1;i.lock();var r=!1,d=h=>{if(i.unlock(),!h||typeof h!="object")return t();var m=rt(h[i.settings.valueField]);if(typeof m!="string")return t();i.setTextboxValue(),i.addOption(h,!0),i.setCaret(o),i.addItem(m),t(h),r=!0};return typeof i.settings.create=="function"?a=i.settings.create.call(this,e,d):a={[i.settings.labelField]:e,[i.settings.valueField]:e},r||d(a),!0}refreshItems(){var e=this;e.lastQuery=null,e.isSetup&&e.addItems(e.items),e.updateOriginalInput(),e.refreshState()}refreshState(){const e=this;e.refreshValidityState();const t=e.isFull(),i=e.isLocked;e.wrapper.classList.toggle("rtl",e.rtl);const o=e.wrapper.classList;o.toggle("focus",e.isFocused),o.toggle("disabled",e.isDisabled),o.toggle("readonly",e.isReadOnly),o.toggle("required",e.isRequired),o.toggle("invalid",!e.isValid),o.toggle("locked",i),o.toggle("full",t),o.toggle("input-active",e.isFocused&&!e.isInputHidden),o.toggle("dropdown-active",e.isOpen),o.toggle("has-options",Ca(e.options)),o.toggle("has-items",e.items.length>0)}refreshValidityState(){var e=this;e.input.validity&&(e.isValid=e.input.validity.valid,e.isInvalid=!e.isValid)}isFull(){return this.settings.maxItems!==null&&this.items.length>=this.settings.maxItems}updateOriginalInput(e={}){const t=this;var i,o;const a=t.input.querySelector('option[value=""]');if(t.is_select_tag){let h=function(m,N,D){return m||(m=Ge('<option value="'+Yt(N)+'">'+Yt(D)+"</option>")),m!=a&&t.input.append(m),r.push(m),(m!=a||d>0)&&(m.selected=!0),m};const r=[],d=t.input.querySelectorAll("option:checked").length;t.input.querySelectorAll("option:checked").forEach(m=>{m.selected=!1}),t.items.length==0&&t.settings.mode=="single"?h(a,"",""):t.items.forEach(m=>{if(i=t.options[m],o=i[t.settings.labelField]||"",r.includes(i.$option)){const N=t.input.querySelector(`option[value="${Ai(m)}"]:not(:checked)`);h(N,m,o)}else i.$option=h(i.$option,m,o)})}else t.input.value=t.getValue();t.isSetup&&(e.silent||t.trigger("change",t.getValue()))}open(){var e=this;e.isLocked||e.isOpen||e.settings.mode==="multi"&&e.isFull()||(e.isOpen=!0,Fe(e.focus_node,{"aria-expanded":"true"}),e.refreshState(),Ft(e.dropdown,{visibility:"hidden",display:"block"}),e.positionDropdown(),Ft(e.dropdown,{visibility:"visible",display:"block"}),e.focus(),e.trigger("dropdown_open",e.dropdown))}close(e=!0){var t=this,i=t.isOpen;e&&(t.setTextboxValue(),t.settings.mode==="single"&&t.items.length&&t.inputState()),t.isOpen=!1,Fe(t.focus_node,{"aria-expanded":"false"}),Ft(t.dropdown,{display:"none"}),t.settings.hideSelected&&t.clearActiveOption(),t.refreshState(),i&&t.trigger("dropdown_close",t.dropdown)}positionDropdown(){if(this.settings.dropdownParent==="body"){var e=this.control,t=e.getBoundingClientRect(),i=e.offsetHeight+t.top+window.scrollY,o=t.left+window.scrollX;Ft(this.dropdown,{width:t.width+"px",top:i+"px",left:o+"px"})}}clear(e){var t=this;if(t.items.length){var i=t.controlChildren();Qe(i,o=>{t.removeItem(o,!0)}),t.inputState(),e||t.updateOriginalInput(),t.trigger("clear")}}insertAtCaret(e){const t=this,i=t.caretPos,o=t.control;o.insertBefore(e,o.children[i]||null),t.setCaret(i+1)}deleteSelection(e){var t,i,o,a,r=this;t=e&&e.keyCode===Ci?-1:1,i=Ba(r.control_input);const d=[];if(r.activeItems.length)a=Di(r.activeItems,t),o=an(a),t>0&&o++,Qe(r.activeItems,h=>d.push(h));else if((r.isFocused||r.settings.mode==="single")&&r.items.length){const h=r.controlChildren();let m;t<0&&i.start===0&&i.length===0?m=h[r.caretPos-1]:t>0&&i.start===r.inputValue().length&&(m=h[r.caretPos]),m!==void 0&&d.push(m)}if(!r.shouldDelete(d,e))return!1;for($e(e,!0),typeof o<"u"&&r.setCaret(o);d.length;)r.removeItem(d.pop());return r.inputState(),r.positionDropdown(),r.refreshOptions(!1),!0}shouldDelete(e,t){const i=e.map(o=>o.dataset.value);return!(!i.length||typeof this.settings.onDelete=="function"&&this.settings.onDelete(i,t)===!1)}advanceSelection(e,t){var i,o,a=this;a.rtl&&(e*=-1),!a.inputValue().length&&(It(Bt,t)||It("shiftKey",t)?(i=a.getLastActive(e),i?i.classList.contains("active")?o=a.getAdjacent(i,e,"item"):o=i:e>0?o=a.control_input.nextElementSibling:o=a.control_input.previousElementSibling,o&&(o.classList.contains("active")&&a.removeActiveItem(i),a.setActiveItemClass(o))):a.moveCaret(e))}moveCaret(e){}getLastActive(e){let t=this.control.querySelector(".last-active");if(t)return t;var i=this.control.querySelectorAll(".active");if(i)return Di(i,e)}setCaret(e){this.caretPos=this.items.length}controlChildren(){return Array.from(this.control.querySelectorAll("[data-ts-item]"))}lock(){this.setLocked(!0)}unlock(){this.setLocked(!1)}setLocked(e=this.isReadOnly||this.isDisabled){this.isLocked=e,this.refreshState()}disable(){this.setDisabled(!0),this.close()}enable(){this.setDisabled(!1)}setDisabled(e){this.focus_node.tabIndex=e?-1:this.tabIndex,this.isDisabled=e,this.input.disabled=e,this.control_input.disabled=e,this.setLocked()}setReadOnly(e){this.isReadOnly=e,this.input.readOnly=e,this.control_input.readOnly=e,this.setLocked()}destroy(){var e=this,t=e.revertSettings;e.trigger("destroy"),e.off(),e.wrapper.remove(),e.dropdown.remove(),e.input.innerHTML=t.innerHTML,e.input.tabIndex=t.tabIndex,pt(e.input,"tomselected","ts-hidden-accessible"),e._destroy(),delete e.input.tomselect}render(e,t){var i,o;const a=this;if(typeof this.settings.render[e]!="function"||(o=a.settings.render[e].call(this,t,Yt),!o))return null;if(o=Ge(o),e==="option"||e==="option_create"?t[a.settings.disabledField]?Fe(o,{"aria-disabled":"true"}):Fe(o,{"data-selectable":""}):e==="optgroup"&&(i=t.group[a.settings.optgroupValueField],Fe(o,{"data-group":i}),t.group[a.settings.disabledField]&&Fe(o,{"data-disabled":""})),e==="option"||e==="item"){const r=zt(t[a.settings.valueField]);Fe(o,{"data-value":r}),e==="item"?(Je(o,a.settings.itemClass),Fe(o,{"data-ts-item":""})):(Je(o,a.settings.optionClass),Fe(o,{role:"option",id:t.$id}),t.$div=o,a.options[r]=t)}return o}_render(e,t){const i=this.render(e,t);if(i==null)throw"HTMLElement expected";return i}clearCache(){Qe(this.options,e=>{e.$div&&(e.$div.remove(),delete e.$div)})}uncacheValue(e){const t=this.getOption(e);t&&t.remove()}canCreate(e){return this.settings.create&&e.length>0&&this.settings.createFilter.call(this,e)}hook(e,t,i){var o=this,a=o[t];o[t]=function(){var r,d;return e==="after"&&(r=a.apply(o,arguments)),d=i.apply(o,arguments),e==="instead"?d:(e==="before"&&(r=a.apply(o,arguments)),r)}}}function Va(){Pe(this.input,"change",()=>{this.sync()})}function Ha(n){var e=this,t=e.onOptionSelect;e.settings.hideSelected=!1;const i=Object.assign({className:"tomselect-checkbox",checkedClassNames:void 0,uncheckedClassNames:void 0},n);var o=function(d,h){h?(d.checked=!0,i.uncheckedClassNames&&d.classList.remove(...i.uncheckedClassNames),i.checkedClassNames&&d.classList.add(...i.checkedClassNames)):(d.checked=!1,i.checkedClassNames&&d.classList.remove(...i.checkedClassNames),i.uncheckedClassNames&&d.classList.add(...i.uncheckedClassNames))},a=function(d){setTimeout(()=>{var h=d.querySelector("input."+i.className);h instanceof HTMLInputElement&&o(h,d.classList.contains("selected"))},1)};e.hook("after","setupTemplates",()=>{var r=e.settings.render.option;e.settings.render.option=(d,h)=>{var m=Ge(r.call(e,d,h)),N=document.createElement("input");i.className&&N.classList.add(i.className),N.addEventListener("click",function(A){$e(A)}),N.type="checkbox";const D=rt(d[e.settings.valueField]);return o(N,!!(D&&e.items.indexOf(D)>-1)),m.prepend(N),m}}),e.on("item_remove",r=>{var d=e.getOption(r);d&&(d.classList.remove("selected"),a(d))}),e.on("item_add",r=>{var d=e.getOption(r);d&&a(d)}),e.hook("instead","onOptionSelect",(r,d)=>{if(d.classList.contains("selected")){d.classList.remove("selected"),e.removeItem(d.dataset.value),e.refreshOptions(),$e(r,!0);return}t.call(e,r,d),a(d)})}function Ua(n){const e=this,t=Object.assign({className:"clear-button",title:"Clear All",html:i=>`<div class="${i.className}" title="${i.title}">&#10799;</div>`},n);e.on("initialize",()=>{var i=Ge(t.html(t));i.addEventListener("click",o=>{e.isLocked||(e.clear(),e.settings.mode==="single"&&e.settings.allowEmptyOption&&e.addItem(""),o.preventDefault(),o.stopPropagation())}),e.control.appendChild(i)})}const Ga=(n,e)=>{var t;(t=n.parentNode)==null||t.insertBefore(e,n.nextSibling)},Wa=(n,e)=>{var t;(t=n.parentNode)==null||t.insertBefore(e,n)},ja=(n,e)=>{do{var t;if(e=(t=e)==null?void 0:t.previousElementSibling,n==e)return!0}while(e&&e.previousElementSibling);return!1};function qa(){var n=this;if(n.settings.mode!=="multi")return;var e=n.lock,t=n.unlock;let i=!0,o;n.hook("after","setupTemplates",()=>{var a=n.settings.render.item;n.settings.render.item=(r,d)=>{const h=Ge(a.call(n,r,d));Fe(h,{draggable:"true"});const m=P=>{i||$e(P),P.stopPropagation()},N=P=>{o=h,setTimeout(()=>{h.classList.add("ts-dragging")},0)},D=P=>{P.preventDefault(),h.classList.add("ts-drag-over"),M(h,o)},A=()=>{h.classList.remove("ts-drag-over")},M=(P,O)=>{O!==void 0&&(ja(O,h)?Ga(P,O):Wa(P,O))},T=()=>{var P;document.querySelectorAll(".ts-drag-over").forEach(L=>L.classList.remove("ts-drag-over")),(P=o)==null||P.classList.remove("ts-dragging"),o=void 0;var O=[];n.control.querySelectorAll("[data-value]").forEach(L=>{if(L.dataset.value){let $=L.dataset.value;$&&O.push($)}}),n.setValue(O)};return Pe(h,"mousedown",m),Pe(h,"dragstart",N),Pe(h,"dragenter",D),Pe(h,"dragover",D),Pe(h,"dragleave",A),Pe(h,"dragend",T),h}}),n.hook("instead","lock",()=>(i=!1,e.call(n))),n.hook("instead","unlock",()=>(i=!0,t.call(n)))}function Ka(n){const e=this,t=Object.assign({title:"Untitled",headerClass:"dropdown-header",titleRowClass:"dropdown-header-title",labelClass:"dropdown-header-label",closeClass:"dropdown-header-close",html:i=>'<div class="'+i.headerClass+'"><div class="'+i.titleRowClass+'"><span class="'+i.labelClass+'">'+i.title+'</span><a class="'+i.closeClass+'">&times;</a></div></div>'},n);e.on("initialize",()=>{var i=Ge(t.html(t)),o=i.querySelector("."+t.closeClass);o&&o.addEventListener("click",a=>{$e(a,!0),e.close()}),e.dropdown.insertBefore(i,e.dropdown.firstChild)})}function za(){var n=this;n.hook("instead","setCaret",e=>{n.settings.mode==="single"||!n.control.contains(n.control_input)?e=n.items.length:(e=Math.max(0,Math.min(n.items.length,e)),e!=n.caretPos&&!n.isPending&&n.controlChildren().forEach((t,i)=>{i<e?n.control_input.insertAdjacentElement("beforebegin",t):n.control.appendChild(t)})),n.caretPos=e}),n.hook("instead","moveCaret",e=>{if(!n.isFocused)return;const t=n.getLastActive(e);if(t){const i=an(t);n.setCaret(e>0?i+1:i),n.setActiveItem(),pt(t,"last-active")}else n.setCaret(n.caretPos+e)})}function Ya(){const n=this;n.settings.shouldOpen=!0,n.hook("before","setup",()=>{n.focus_node=n.control,Je(n.control_input,"dropdown-input");const e=Ge('<div class="dropdown-input-wrap">');e.append(n.control_input),n.dropdown.insertBefore(e,n.dropdown.firstChild);const t=Ge('<input class="items-placeholder" tabindex="-1" />');t.placeholder=n.settings.placeholder||"",n.control.append(t)}),n.on("initialize",()=>{n.control_input.addEventListener("keydown",t=>{switch(t.keyCode){case Qi:n.isOpen&&($e(t,!0),n.close()),n.clearActiveItems();return;case Xn:n.focus_node.tabIndex=-1;break}return n.onKeyDown.call(n,t)}),n.on("blur",()=>{n.focus_node.tabIndex=n.isDisabled?-1:n.tabIndex}),n.on("dropdown_open",()=>{n.control_input.focus()});const e=n.onBlur;n.hook("instead","onBlur",t=>{if(!(t&&t.relatedTarget==n.control_input))return e.call(n)}),Pe(n.control_input,"blur",()=>n.onBlur()),n.hook("before","close",()=>{n.isOpen&&n.focus_node.focus({preventScroll:!0})})})}function Za(){var n=this;n.on("initialize",()=>{var e=document.createElement("span"),t=n.control_input;e.style.cssText="position:absolute; top:-99999px; left:-99999px; width:auto; padding:0; white-space:pre; ",n.wrapper.appendChild(e);var i=["letterSpacing","fontSize","fontFamily","fontWeight","textTransform"];for(const a of i)e.style[a]=t.style[a];var o=()=>{e.textContent=t.value,t.style.width=e.clientWidth+"px"};o(),n.on("update item_add item_remove",o),Pe(t,"input",o),Pe(t,"keyup",o),Pe(t,"blur",o),Pe(t,"update",o)})}function Ja(){var n=this,e=n.deleteSelection;this.hook("instead","deleteSelection",t=>n.activeItems.length?e.call(n,t):!1)}function Qa(){this.hook("instead","setActiveItem",()=>{}),this.hook("instead","selectAll",()=>{})}function er(){var n=this,e=n.onKeyDown;n.hook("instead","onKeyDown",t=>{var i,o,a,r;if(!n.isOpen||!(t.keyCode===Rn||t.keyCode===eo))return e.call(n,t);n.ignoreHover=!0,r=Kt(n.activeOption,"[data-group]"),i=an(n.activeOption,"[data-selectable]"),r&&(t.keyCode===Rn?r=r.previousSibling:r=r.nextSibling,r&&(a=r.querySelectorAll("[data-selectable]"),o=a[Math.min(a.length-1,i)],o&&n.setActiveOption(o)))})}function tr(n){const e=Object.assign({label:"&times;",title:"Remove",className:"remove",append:!0},n);var t=this;if(e.append){var i='<a href="javascript:void(0)" class="'+e.className+'" tabindex="-1" title="'+Yt(e.title)+'">'+e.label+"</a>";t.hook("after","setupTemplates",()=>{var o=t.settings.render.item;t.settings.render.item=(a,r)=>{var d=Ge(o.call(t,a,r)),h=Ge(i);return d.appendChild(h),Pe(h,"mousedown",m=>{$e(m,!0)}),Pe(h,"click",m=>{t.isLocked||($e(m,!0),!t.isLocked&&t.shouldDelete([d],m)&&(t.removeItem(d),t.refreshOptions(!1),t.inputState()))}),d}})}}function nr(n){const e=this,t=Object.assign({text:i=>i[e.settings.labelField]},n);e.on("item_remove",function(i){if(e.isFocused&&e.control_input.value.trim()===""){var o=e.options[i];o&&e.setTextboxValue(t.text.call(e,o))}})}function ir(){const n=this,e=n.canLoad,t=n.clearActiveOption,i=n.loadCallback;var o={},a,r=!1,d,h=[];if(n.settings.shouldLoadMore||(n.settings.shouldLoadMore=()=>{if(a.clientHeight/(a.scrollHeight-a.scrollTop)>.9)return!0;if(n.activeOption){var A=n.selectable(),M=Array.from(A).indexOf(n.activeOption);if(M>=A.length-2)return!0}return!1}),!n.settings.firstUrl)throw"virtual_scroll plugin requires a firstUrl() method";n.settings.sortField=[{field:"$order"},{field:"$score"}];const m=D=>typeof n.settings.maxOptions=="number"&&a.children.length>=n.settings.maxOptions?!1:!!(D in o&&o[D]),N=(D,A)=>n.items.indexOf(A)>=0||h.indexOf(A)>=0;n.setNextUrl=(D,A)=>{o[D]=A},n.getUrl=D=>{if(D in o){const A=o[D];return o[D]=!1,A}return n.clearPagination(),n.settings.firstUrl.call(n,D)},n.clearPagination=()=>{o={}},n.hook("instead","clearActiveOption",()=>{if(!r)return t.call(n)}),n.hook("instead","canLoad",D=>D in o?m(D):e.call(n,D)),n.hook("instead","loadCallback",(D,A)=>{if(!r)n.clearOptions(N);else if(d){const M=D[0];M!==void 0&&(d.dataset.value=M[n.settings.valueField])}i.call(n,D,A),r=!1}),n.hook("after","refreshOptions",()=>{const D=n.lastValue;var A;m(D)?(A=n.render("loading_more",{query:D}),A&&(A.setAttribute("data-selectable",""),d=A)):D in o&&!a.querySelector(".no-results")&&(A=n.render("no_more_results",{query:D})),A&&(Je(A,n.settings.optionClass),a.append(A))}),n.on("initialize",()=>{h=Object.keys(n.options),a=n.dropdown_content,n.settings.render=Object.assign({},{loading_more:()=>'<div class="loading-more-results">Loading more results ... </div>',no_more_results:()=>'<div class="no-more-results">No more results</div>'},n.settings.render),a.addEventListener("scroll",()=>{n.settings.shouldLoadMore.call(n)&&m(n.lastValue)&&(r||(r=!0,n.load.call(n,n.lastValue)))})})}et.define("change_listener",Va);et.define("checkbox_options",Ha);et.define("clear_button",Ua);et.define("drag_drop",qa);et.define("dropdown_header",Ka);et.define("caret_position",za);et.define("dropdown_input",Ya);et.define("input_autogrow",Za);et.define("no_backspace_delete",Ja);et.define("no_active_items",Qa);et.define("optgroup_columns",er);et.define("remove_button",tr);et.define("restore_on_backspace",nr);et.define("virtual_scroll",ir);class or{debouncedLocalChanges;debouncedBroadcastChanges;constructor(){this.debouncedBroadcastChanges=Ii(async e=>{if(!e.data||e.data.length===0)return;const t=e.data,i=p.playerRole==="GM"?t:t.filter(d=>d.metadata[`${s.SPECTREID}/viewers`].includes(p.playerId)),a=p.localGhosts.filter(d=>d.metadata[`${s.SPECTREID}/spectred`]===!0).filter(d=>d.metadata[`${s.SPECTREID}/viewers`].includes(p.playerId));if(!Sn(i,a)){const d=i.map(N=>N.id),h=[],m=p.localGhosts.filter(N=>!d.includes(N.id));for(const N of i){const D=p.localGhosts.find(A=>A.id===N.id);D&&jo(N,D)||h.push(N)}h.length>0&&await b.scene.local.addItems(h),m.length>0&&await b.scene.local.deleteItems(m.map(N=>N.id)),p.localGhosts=t}},0),this.debouncedLocalChanges=Ii(async e=>{if(p.playerRole==="GM"){const t=e.filter(o=>o.metadata[`${s.SPECTREID}/spectred`]===!0);if(Sn(p.localGhosts,t))return;p.localGhosts=t,wi(t)?await b.notification.show("You currently have too many Spectres in the scene. Unable to update.","ERROR"):(await b.scene.setMetadata({[`${s.SPECTREID}/current_spectres`]:t}),await b.broadcast.sendMessage(s.SPECTREBROADCASTID,t));const i=document.querySelectorAll(".tSelects");for(const o of i){const a=o.id.replace("select-","");t.find(d=>d.id===a)||document.getElementById(`tr-${a}`)?.remove()}}else{const t=e.filter(r=>r.metadata[`${s.SPECTREID}/spectred`]===!0),o=p.localGhosts.filter(r=>r.metadata[`${s.SPECTREID}/spectred`]===!0).filter(r=>r.metadata[`${s.SPECTREID}/viewers`].includes(p.playerId));if(t.length<o.length){const r=[];for(const d of o)t.includes(d)||r.push(d.id);r.length>0&&await b.broadcast.sendMessage("SPECTREDELETED",r)}if(t.length===0&&o.length===0)return;if(t.length<o.length){p.localGhosts=t;return}Sn(t,o)||(qo(p.localGhosts,t),await b.broadcast.sendMessage(s.SPECTREBROADCASTID,p.localGhosts))}},0)}SetupLocalSpecterHandlers(){p.sceneReady&&(b.broadcast.onMessage(s.SPECTREBROADCASTID,e=>{this.debouncedBroadcastChanges(e)}),p.playerRole==="GM"&&b.broadcast.onMessage("SPECTREDELETED",async e=>{const t=e.data;if(t.length>0){for(const i of t)document.getElementById(`tr-${i}`).remove();await b.scene.local.deleteItems(t)}}))}async LoadSpectreSceneMetadata(){p.localGhosts=p.sceneMetadata[`${s.SPECTREID}/current_spectres`],p.localGhosts||(p.localGhosts=[]);const e=[];for(const t of p.localGhosts)t.metadata[`${s.SPECTREID}/viewers`].includes(p.playerId)&&p.playerRole!=="GM"&&e.push(t);e.length>0&&await b.scene.local.addItems(e)}UpdateSpectreTargets(){const e=document.querySelectorAll(".tSelects");for(const t of e)if(t&&t.tomselect){const i=t.tomselect,o=[];for(const a of p.party)o.push({value:a.id,text:a.name});i.clearOptions(),i.addOption(o),o.length===0?(i.settings.placeholder="No Players Present",i.inputState()):(i.settings.placeholder="Choose..",i.inputState())}}async SetupSpectreGM(){await b.contextMenu.create({id:`${s.SPECTREID}/context-menu`,icons:[{icon:"/ghost.svg",label:"Spectre",filter:{every:[{key:"type",value:"IMAGE"},{key:["metadata",`${s.SPECTREID}/spectred`],value:void 0,operator:"==",coordinator:"&&"},{key:["metadata",`${s.EXTENSIONID}/hasVision`],operator:"==",value:void 0}]}},{icon:"/ghost.svg",label:"Un-Spectre",filter:{every:[{key:"type",value:"IMAGE"},{key:["metadata",`${s.SPECTREID}/spectred`],value:void 0,operator:"!=",coordinator:"&&"}]}}],async onClick(e){if(e.items.every(i=>i.metadata[`${s.SPECTREID}/spectred`]===void 0))if(wi(p.localGhosts,e.items))await b.notification.show("This would exceed the maximum Spectres. Please remove some before adding more.","INFO");else for(const i of e.items){const o=i;ut.SetupTomSelect(o)}else for(const i of e.items){const o=i;await ut.RemoveGhost(o),o.metadata[`${s.SPECTREID}/spectred`]=void 0;const a=p.localGhosts.findIndex(r=>r.id===o.id);a!==-1&&(p.localGhosts.splice(a,1),document.getElementById(`tr-${o.id}`)?.remove(),o.metadata[`${s.SPECTREID}/viewers`]=[],await b.scene.items.addItems([o]))}}})}async RestoreGhostsGM(){p.localGhosts=p.sceneMetadata[`${s.SPECTREID}/current_spectres`],p.localGhosts||(p.localGhosts=[]),p.localGhosts.length>0&&(await b.scene.local.addItems(p.localGhosts),p.localGhosts.forEach(t=>{this.SetupTomSelect(t)})),p.sceneMetadata[`${s.SPECTREID}/stored`]?.length>0&&(await b.scene.local.addItems(p.localGhosts),p.localGhosts.forEach(t=>{this.SetupTomSelect(t)}))}async StoreGhost(e){let t=p.sceneMetadata[`${s.SPECTREID}/current_spectres`];if(!t)t=[e];else{if(t.find(o=>o.id===e.id))return;t.push(e)}await b.scene.setMetadata({[`${s.SPECTREID}/current_spectres`]:t})}async RemoveGhost(e){let t=p.sceneMetadata[`${s.SPECTREID}/current_spectres`];t||(t=[]);const i=t.filter(o=>o.id!==e.id);await b.scene.local.deleteItems([e.id]),await b.scene.setMetadata({[`${s.SPECTREID}/current_spectres`]:i})}async SetupTomSelect(e){const t=e.text?.plainText||e.name;let i=e.metadata[`${s.SPECTREID}/viewers`];e.metadata[`${s.SPECTREID}/spectred`]=!0,i===void 0&&(i=[],e.metadata[`${s.SPECTREID}/viewers`]=[]),await b.scene.items.deleteItems([e.id]),await b.scene.local.addItems([e]),await this.StoreGhost(e),p.localGhosts.push(e);const o=document.getElementById("ghostList"),a=document.createElement("tr");a.id=`tr-${e.id}`,a.className="ghost-table-entry",a.innerHTML=`<td class="token-name">${t}</td>
            <td><select id="select-${e.id}" class="tSelects" multiple autocomplete="off" /></td>
            <td><input type="button" class="mysteryButton" id="deleteGhost-${e.id}" value="Delete"/></td>`,o.appendChild(a);const r=document.getElementById(`select-${e.id}`);for(const N of p.party){const D=document.createElement("option");D.value=N.id,D.text=N.name,r.appendChild(D)}const d={plugins:{remove_button:{title:"Remove this item"}},allowEmptyOption:!0,placeholder:p.party.length==0?"No Players Present":"Choose..",maxItems:null,create:!1,onDelete:async function(N,D){const A=D.currentTarget.parentElement.parentElement.parentElement.parentElement.parentElement.id.slice(3);await b.scene.local.updateItems([A],M=>{const T=M[0].metadata[`${s.SPECTREID}/viewers`],P=T.findIndex(O=>O==N);T.splice(P,1),M[0].metadata[`${s.SPECTREID}/viewers`]=T})},onItemAdd:async function(N,D){const A=D.parentElement.parentElement.parentElement.parentElement.id.slice(3);await b.scene.local.updateItems([A],M=>{const T=M[0].metadata[`${s.SPECTREID}/viewers`];T?(T.push(N),M[0].metadata[`${s.SPECTREID}/viewers`]=T):M[0].metadata[`${s.SPECTREID}/viewers`]=[N]})}},h=new et(`#select-${e.id}`,d);if(i.length>0)for(const N of i){if(!p.party.find(A=>A.id===N)){const A=p.sceneMetadata[`${s.EXTENSIONID}/USER-${N}`],M=[];M.push({value:N,text:A.name}),h.addOption(M)}h.addItem(N,!0)}const m=document.getElementById(`deleteGhost-${e.id}`);m.onclick=async()=>{const N=p.localGhosts.findIndex(D=>D.id===e.id);p.localGhosts.splice(N,1),a.remove(),await b.scene.local.updateItems([e.id],D=>{D[0]&&(D[0].metadata[`${s.SPECTREID}/viewers`]=[])}),await this.RemoveGhost(e)}}ClearGhostList(){const e=document.getElementById("ghostList");e&&(e.innerHTML="")}}const ut=new or;async function Fn(){await b.scene.items.deleteItems(p.sceneItems.filter(At).map(e=>e.id)),en(p.sceneMetadata[`${s.EXTENSIONID}/fowEnabled`]==!0);let n;if(p.sceneItems.filter(mo).length==0){const e=p.sceneItems.filter(i=>i.layer=="MAP"&&Jt(i)),t=e.map(i=>i.image.width*i.image.height/Math.pow(i.grid.dpi,2));n=e[t.indexOf(Math.max(...t))]}if(p.sceneMetadata[`${s.EXTENSIONID}/autodetectEnabled`]===void 0&&(p.playerRole==="GM"&&(Z.autodetectCheckbox.checked=!0),await b.scene.setMetadata({[`${s.EXTENSIONID}/autodetectEnabled`]:!0})),p.sceneMetadata[`${s.EXTENSIONID}/sceneId`]===void 0)await b.scene.setMetadata({[`${s.EXTENSIONID}/sceneId`]:crypto.randomUUID()});else try{const e=p.sceneMetadata[`${s.EXTENSIONID}/sceneId`],t=localStorage.getItem(`${s.EXTENSIONID}/fogCache/${p.playerId}/${e}`);if(t!==null&&p.sceneMetadata[`${s.EXTENSIONID}/persistenceEnabled`]===!0){const i=JSON.parse(t),o=[];for(let a=0;a<i.length;a++){const r=gt().commands(i[a].commands).fillRule("evenodd").locked(!0).visible(!1).fillColor("#000000").strokeColor("#000000").layer("FOG").name("Fog of War").metadata({[`${s.EXTENSIONID}/isVisionFog`]:!0,[`${s.EXTENSIONID}/digest`]:i[a].digest}).build();r.zIndex=3,o.push(r)}await b.scene.local.addItems(o)}}catch{}p.playerRole==="GM"?(await ut.RestoreGhostsGM(),await Z.UpdateUI(),Z.mapSubmit.onclick=async()=>{await b.scene.items.updateItems([s.GRIDID],e=>{for(const t of e){const i=t;i.width=p.gridDpi*+Z.mapWidth.value,i.height=p.gridDpi*+Z.mapHeight.value,i.scale={x:1,y:1}}})},n!==void 0&&await b.scene.items.updateItems([n],e=>{e[0].metadata[`${s.EXTENSIONID}/isBackgroundImage`]=!0})):await ut.LoadSpectreSceneMetadata(),p.snap=!0,p.sceneInitialized=!0}var to={exports:{}};const ar={},rr=Object.freeze(Object.defineProperty({__proto__:null,default:ar},Symbol.toStringTag,{value:"Module"})),Dn=Ho(rr);(function(n,e){var t=(()=>{var i=typeof document<"u"&&document.currentScript?document.currentScript.src:void 0;return typeof __filename<"u"&&(i=i||__filename),function(o){o=o||{};var a;a||(a=typeof o<"u"?o:{});var r=Object.assign,d,h;a.ready=new Promise(function(c,l){d=c,h=l}),function(c){var l={};c.loadCmdsTypedArray=function(G){for(var Y=0,te=0;te<G.length;te++)Y+=G[te].length;if(l[Y])var ne=l[Y];else ne=new Float32Array(Y),l[Y]=ne;var re=0;for(te=0;te<G.length;te++)for(var Ae=0;Ae<G[te].length;Ae++){var Le=G[te][Ae];typeof Le=="string"&&(Le=c.SkBits2FloatUnsigned(parseInt(Le))),ne[re]=Le,re++}return G=c._malloc(ne.length*ne.BYTES_PER_ELEMENT),c.HEAPF32.set(ne,G/ne.BYTES_PER_ELEMENT),[G,Y]},c.FromCmds=function(G){G=c.loadCmdsTypedArray(G);var Y=c._FromCmds(G[0],G[1]);return c._free(G[0]),Y};var u,v,_,F,z;c.cubicYFromX=function(G,Y,te,ne,re){return u&&v===G&&_===Y&&F===te&&z===ne||(u&&u.delete(),u=new c._SkCubicMap([G,Y],[te,ne]),v=G,_=Y,F=te,z=ne),u.computeYFromX(re)},c.cubicPtFromT=function(G,Y,te,ne,re){return u&&v===G&&_===Y&&F===te&&z===ne||(u&&u.delete(),u=new c._SkCubicMap([G,Y],[te,ne]),v=G,_=Y,F=te,z=ne),u.computePtFromT(re)}}(a),function(c){c.onRuntimeInitialized=function(){c.SkPath.prototype.addPath=function(){var l=arguments[0];if(arguments.length===1)this._addPath(l,1,0,0,0,1,0,0,0,1);else if(arguments.length===2){var u=arguments[1];this._addPath(l,u.a,u.c,u.e,u.b,u.d,u.f,0,0,1)}else if(arguments.length===7)u=arguments,this._addPath(l,u[1],u[3],u[5],u[2],u[4],u[6],0,0,1);else if(arguments.length===10)u=arguments,this._addPath(l,u[1],u[2],u[3],u[4],u[5],u[6],u[7],u[8],u[9]);else return console.Ma("addPath expected to take 1, 2, 7, or 10 args. Got "+arguments.length),null;return this},c.SkPath.prototype.arc=function(l,u,v,_,F,z){return this._arc(l,u,v,_,F,!!z),this},c.SkPath.prototype.arcTo=function(l,u,v,_,F){return this._arcTo(l,u,v,_,F),this},c.SkPath.prototype.bezierCurveTo=function(l,u,v,_,F,z){return this._cubicTo(l,u,v,_,F,z),this},c.SkPath.prototype.close=function(){return this._close(),this},c.SkPath.prototype.closePath=function(){return this._close(),this},c.SkPath.prototype.conicTo=function(l,u,v,_,F){return this._conicTo(l,u,v,_,F),this},c.SkPath.prototype.cubicTo=function(l,u,v,_,F,z){return this._cubicTo(l,u,v,_,F,z),this},c.SkPath.prototype.dash=function(l,u,v){return this._dash(l,u,v)?this:null},c.SkPath.prototype.ellipse=function(l,u,v,_,F,z,G,Y){return this._ellipse(l,u,v,_,F,z,G,!!Y),this},c.SkPath.prototype.lineTo=function(l,u){return this._lineTo(l,u),this},c.SkPath.prototype.moveTo=function(l,u){return this._moveTo(l,u),this},c.SkPath.prototype.op=function(l,u){return this._op(l,u)?this:null},c.SkPath.prototype.quadraticCurveTo=function(l,u,v,_){return this._quadTo(l,u,v,_),this},c.SkPath.prototype.quadTo=function(l,u,v,_){return this._quadTo(l,u,v,_),this},c.SkPath.prototype.rect=function(l,u,v,_){return this._rect(l,u,v,_),this},c.SkPath.prototype.simplify=function(){return this._simplify()?this:null},c.SkPath.prototype.stroke=function(l){return l=l||{},l.width=l.width||1,l.miter_limit=l.miter_limit||4,l.cap=l.cap||c.StrokeCap.BUTT,l.join=l.join||c.StrokeJoin.MITER,this._stroke(l)?this:null},c.SkPath.prototype.transform=function(){if(arguments.length===1)this._transform(arguments[0]);else if(arguments.length===9){var l=arguments;this._transform(l[0],l[1],l[2],l[3],l[4],l[5],l[6],l[7],l[8])}else return console.Ma("transform expected to take 1 or 9 arguments. Got "+arguments.length),null;return this},c.SkPath.prototype.trim=function(l,u,v){return this._trim(l,u,!!v)?this:null}}}(a);var m=r({},a),N=typeof window=="object",D=typeof importScripts=="function",A="",M,T,P,O,L,$;typeof process=="object"&&typeof process.versions=="object"&&typeof process.versions.node=="string"?(A=D?Dn.dirname(A)+"/":__dirname+"/",$=()=>{L||(O=Dn,L=Dn)},M=function(c,l){return $(),c=L.normalize(c),O.readFileSync(c,l?null:"utf8")},P=c=>(c=M(c,!0),c.buffer||(c=new Uint8Array(c)),c),T=(c,l,u)=>{$(),c=L.normalize(c),O.readFile(c,function(v,_){v?u(v):l(_.buffer)})},1<process.argv.length&&process.argv[1].replace(/\\/g,"/"),process.argv.slice(2),process.on("uncaughtException",function(c){throw c}),process.on("unhandledRejection",function(c){throw c}),a.inspect=function(){return"[Emscripten Module object]"}):(N||D)&&(D?A=self.location.href:typeof document<"u"&&document.currentScript&&(A=document.currentScript.src),i&&(A=i),A.indexOf("blob:")!==0?A=A.substr(0,A.replace(/[?#].*/,"").lastIndexOf("/")+1):A="",M=c=>{var l=new XMLHttpRequest;return l.open("GET",c,!1),l.send(null),l.responseText},D&&(P=c=>{var l=new XMLHttpRequest;return l.open("GET",c,!1),l.responseType="arraybuffer",l.send(null),new Uint8Array(l.response)}),T=(c,l,u)=>{var v=new XMLHttpRequest;v.open("GET",c,!0),v.responseType="arraybuffer",v.onload=()=>{v.status==200||v.status==0&&v.response?l(v.response):u()},v.onerror=u,v.send(null)});var H=a.print||console.log.bind(console),R=a.printErr||console.warn.bind(console);r(a,m),m=null;var ie;a.wasmBinary&&(ie=a.wasmBinary),a.noExitRuntime,typeof WebAssembly!="object"&&le("no native wasm support detected");var x,w=!1,g=typeof TextDecoder<"u"?new TextDecoder("utf8"):void 0;function I(c,l,u){var v=l+u;for(u=l;c[u]&&!(u>=v);)++u;if(16<u-l&&c.subarray&&g)return g.decode(c.subarray(l,u));for(v="";l<u;){var _=c[l++];if(_&128){var F=c[l++]&63;if((_&224)==192)v+=String.fromCharCode((_&31)<<6|F);else{var z=c[l++]&63;_=(_&240)==224?(_&15)<<12|F<<6|z:(_&7)<<18|F<<12|z<<6|c[l++]&63,65536>_?v+=String.fromCharCode(_):(_-=65536,v+=String.fromCharCode(55296|_>>10,56320|_&1023))}}else v+=String.fromCharCode(_)}return v}function y(c,l,u){var v=pe;if(0<u){u=l+u-1;for(var _=0;_<c.length;++_){var F=c.charCodeAt(_);if(55296<=F&&57343>=F){var z=c.charCodeAt(++_);F=65536+((F&1023)<<10)|z&1023}if(127>=F){if(l>=u)break;v[l++]=F}else{if(2047>=F){if(l+1>=u)break;v[l++]=192|F>>6}else{if(65535>=F){if(l+2>=u)break;v[l++]=224|F>>12}else{if(l+3>=u)break;v[l++]=240|F>>18,v[l++]=128|F>>12&63}v[l++]=128|F>>6&63}v[l++]=128|F&63}}v[l]=0}}var C=typeof TextDecoder<"u"?new TextDecoder("utf-16le"):void 0;function X(c,l){for(var u=c>>1,v=u+l/2;!(u>=v)&&fe[u];)++u;if(u<<=1,32<u-c&&C)return C.decode(pe.subarray(c,u));for(u="",v=0;!(v>=l/2);++v){var _=ae[c+2*v>>1];if(_==0)break;u+=String.fromCharCode(_)}return u}function q(c,l,u){if(u===void 0&&(u=2147483647),2>u)return 0;u-=2;var v=l;u=u<2*c.length?u/2:c.length;for(var _=0;_<u;++_)ae[l>>1]=c.charCodeAt(_),l+=2;return ae[l>>1]=0,l-v}function oe(c){return 2*c.length}function se(c,l){for(var u=0,v="";!(u>=l/4);){var _=ce[c+4*u>>2];if(_==0)break;++u,65536<=_?(_-=65536,v+=String.fromCharCode(55296|_>>10,56320|_&1023)):v+=String.fromCharCode(_)}return v}function J(c,l,u){if(u===void 0&&(u=2147483647),4>u)return 0;var v=l;u=v+u-4;for(var _=0;_<c.length;++_){var F=c.charCodeAt(_);if(55296<=F&&57343>=F){var z=c.charCodeAt(++_);F=65536+((F&1023)<<10)|z&1023}if(ce[l>>2]=F,l+=4,l+4>u)break}return ce[l>>2]=0,l-v}function Ee(c){for(var l=0,u=0;u<c.length;++u){var v=c.charCodeAt(u);55296<=v&&57343>=v&&++u,l+=4}return l}var ke,we,pe,ae,fe,ce,be,ge,ye;function me(){var c=x.buffer;ke=c,a.HEAP8=we=new Int8Array(c),a.HEAP16=ae=new Int16Array(c),a.HEAP32=ce=new Int32Array(c),a.HEAPU8=pe=new Uint8Array(c),a.HEAPU16=fe=new Uint16Array(c),a.HEAPU32=be=new Uint32Array(c),a.HEAPF32=ge=new Float32Array(c),a.HEAPF64=ye=new Float64Array(c)}var K,f=[],E=[],k=[];function U(){var c=a.preRun.shift();f.unshift(c)}var W=0,V=null;a.preloadedImages={},a.preloadedAudios={};function le(c){throw a.onAbort&&a.onAbort(c),c="Aborted("+c+")",R(c),w=!0,c=new WebAssembly.RuntimeError(c+". Build with -s ASSERTIONS=1 for more info."),h(c),c}function De(){return Se.startsWith("data:application/octet-stream;base64,")}var Se;if(Se="pathkit.wasm",!De()){var Xe=Se;Se=a.locateFile?a.locateFile(Xe,A):A+Xe}function Ve(){var c=Se;try{if(c==Se&&ie)return new Uint8Array(ie);if(P)return P(c);throw"both async and sync fetching of the wasm failed"}catch(l){le(l)}}function Be(){if(!ie&&(N||D)){if(typeof fetch=="function"&&!Se.startsWith("file://"))return fetch(Se,{credentials:"same-origin"}).then(function(c){if(!c.ok)throw"failed to load wasm binary file at '"+Se+"'";return c.arrayBuffer()}).catch(function(){return Ve()});if(T)return new Promise(function(c,l){T(Se,function(u){c(new Uint8Array(u))},l)})}return Promise.resolve().then(function(){return Ve()})}function Ce(c){for(;0<c.length;){var l=c.shift();if(typeof l=="function")l(a);else{var u=l.Wa;typeof u=="number"?l.xa===void 0?K.get(u)():K.get(u)(l.xa):u(l.xa===void 0?null:l.xa)}}}var ve={};function Ne(c){for(;c.length;){var l=c.pop();c.pop()(l)}}function Ke(c){return this.fromWireType(be[c>>2])}var st={},Q={},S={};function B(c){if(c===void 0)return"_unknown";c=c.replace(/[^a-zA-Z0-9_]/g,"$");var l=c.charCodeAt(0);return 48<=l&&57>=l?"_"+c:c}function j(c,l){return c=B(c),function(){return l.apply(this,arguments)}}function ee(c){var l=Error,u=j(c,function(v){this.name=c,this.message=v,v=Error(v).stack,v!==void 0&&(this.stack=this.toString()+`
`+v.replace(/^Error(:[^\n]*)?\n/,""))});return u.prototype=Object.create(l.prototype),u.prototype.constructor=u,u.prototype.toString=function(){return this.message===void 0?this.name:this.name+": "+this.message},u}var ue=void 0;function de(c){throw new ue(c)}function he(c,l,u){function v(G){G=u(G),G.length!==c.length&&de("Mismatched type converter count");for(var Y=0;Y<c.length;++Y)dt(c[Y],G[Y])}c.forEach(function(G){S[G]=l});var _=Array(l.length),F=[],z=0;l.forEach(function(G,Y){Q.hasOwnProperty(G)?_[Y]=Q[G]:(F.push(G),st.hasOwnProperty(G)||(st[G]=[]),st[G].push(function(){_[Y]=Q[G],++z,z===F.length&&v(_)}))}),F.length===0&&v(_)}var xe={};function Ie(c){switch(c){case 1:return 0;case 2:return 1;case 4:return 2;case 8:return 3;default:throw new TypeError("Unknown type size: "+c)}}var He=void 0;function _e(c){for(var l="";pe[c];)l+=He[pe[c++]];return l}var Ue=void 0;function Oe(c){throw new Ue(c)}function dt(c,l,u={}){if(!("argPackAdvance"in l))throw new TypeError("registerType registeredInstance requires argPackAdvance");var v=l.name;if(c||Oe('type "'+v+'" must have a positive integer typeid pointer'),Q.hasOwnProperty(c)){if(u.Qa)return;Oe("Cannot register type '"+v+"' twice")}Q[c]=l,delete S[c],st.hasOwnProperty(c)&&(l=st[c],delete st[c],l.forEach(function(_){_()}))}function sn(c){Oe(c.ea.ha.fa.name+" instance already deleted")}var ln=!1;function ei(){}function ti(c){--c.count.value,c.count.value===0&&(c.ka?c.ma.la(c.ka):c.ha.fa.la(c.ga))}function kt(c){return typeof FinalizationGroup>"u"?(kt=l=>l,c):(ln=new FinalizationGroup(function(l){for(var u=l.next();!u.done;u=l.next())u=u.value,u.ga?ti(u):console.warn("object already deleted: "+u.ga)}),kt=l=>(ln.register(l,l.ea,l.ea),l),ei=l=>{ln.unregister(l.ea)},kt(c))}var Dt=void 0,Ct=[];function cn(){for(;Ct.length;){var c=Ct.pop();c.ea.pa=!1,c.delete()}}function mt(){}var ni={};function ii(c,l,u){if(c[l].ia===void 0){var v=c[l];c[l]=function(){return c[l].ia.hasOwnProperty(arguments.length)||Oe("Function '"+u+"' called with an invalid number of arguments ("+arguments.length+") - expects one of ("+c[l].ia+")!"),c[l].ia[arguments.length].apply(this,arguments)},c[l].ia=[],c[l].ia[v.ua]=v}}function dn(c,l,u){a.hasOwnProperty(c)?((u===void 0||a[c].ia!==void 0&&a[c].ia[u]!==void 0)&&Oe("Cannot register public name '"+c+"' twice"),ii(a,c,c),a.hasOwnProperty(u)&&Oe("Cannot register multiple overloads of a function with the same number of arguments ("+u+")!"),a[c].ia[u]=l):(a[c]=l,u!==void 0&&(a[c].Xa=u))}function To(c,l,u,v,_,F,z,G){this.name=c,this.constructor=l,this.qa=u,this.la=v,this.na=_,this.Oa=F,this.ta=z,this.La=G,this.Ta=[]}function un(c,l,u){for(;l!==u;)l.ta||Oe("Expected null or instance of "+u.name+", got an instance of "+l.name),c=l.ta(c),l=l.na;return c}function bo(c,l){return l===null?(this.Ba&&Oe("null is not a valid "+this.name),0):(l.ea||Oe('Cannot pass "'+mn(l)+'" as a '+this.name),l.ea.ga||Oe("Cannot pass deleted object as a pointer of type "+this.name),un(l.ea.ga,l.ea.ha.fa,this.fa))}function No(c,l){if(l===null){if(this.Ba&&Oe("null is not a valid "+this.name),this.wa){var u=this.sa();return c!==null&&c.push(this.la,u),u}return 0}if(l.ea||Oe('Cannot pass "'+mn(l)+'" as a '+this.name),l.ea.ga||Oe("Cannot pass deleted object as a pointer of type "+this.name),!this.va&&l.ea.ha.va&&Oe("Cannot convert argument of type "+(l.ea.ma?l.ea.ma.name:l.ea.ha.name)+" to parameter type "+this.name),u=un(l.ea.ga,l.ea.ha.fa,this.fa),this.wa)switch(l.ea.ka===void 0&&Oe("Passing raw pointer to smart pointer is illegal"),this.Va){case 0:l.ea.ma===this?u=l.ea.ka:Oe("Cannot convert argument of type "+(l.ea.ma?l.ea.ma.name:l.ea.ha.name)+" to parameter type "+this.name);break;case 1:u=l.ea.ka;break;case 2:if(l.ea.ma===this)u=l.ea.ka;else{var v=l.clone();u=this.Ua(u,yt(function(){v.delete()})),c!==null&&c.push(this.la,u)}break;default:Oe("Unsupporting sharing policy")}return u}function Oo(c,l){return l===null?(this.Ba&&Oe("null is not a valid "+this.name),0):(l.ea||Oe('Cannot pass "'+mn(l)+'" as a '+this.name),l.ea.ga||Oe("Cannot pass deleted object as a pointer of type "+this.name),l.ea.ha.va&&Oe("Cannot convert argument of type "+l.ea.ha.name+" to parameter type "+this.name),un(l.ea.ga,l.ea.ha.fa,this.fa))}function oi(c,l,u){return l===u?c:u.na===void 0?null:(c=oi(c,l,u.na),c===null?null:u.La(c))}var xt={};function ko(c,l){for(l===void 0&&Oe("ptr should not be undefined");c.na;)l=c.ta(l),c=c.na;return xt[l]}function $t(c,l){return l.ha&&l.ga||de("makeClassHandle requires ptr and ptrType"),!!l.ma!=!!l.ka&&de("Both smartPtrType and smartPtr must be specified"),l.count={value:1},kt(Object.create(c,{ea:{value:l}}))}function ft(c,l,u,v){this.name=c,this.fa=l,this.Ba=u,this.va=v,this.wa=!1,this.la=this.Ua=this.sa=this.Ia=this.Va=this.Sa=void 0,l.na!==void 0?this.toWireType=No:(this.toWireType=v?bo:Oo,this.ja=null)}function ai(c,l,u){a.hasOwnProperty(c)||de("Replacing nonexistant public symbol"),a[c].ia!==void 0&&u!==void 0?a[c].ia[u]=l:(a[c]=l,a[c].ua=u)}function Do(c,l){var u=[];return function(){u.length=arguments.length;for(var v=0;v<arguments.length;v++)u[v]=arguments[v];return c.includes("j")?(v=a["dynCall_"+c],v=u&&u.length?v.apply(null,[l].concat(u)):v.call(null,l)):v=K.get(l).apply(null,u),v}}function ze(c,l){c=_e(c);var u=c.includes("j")?Do(c,l):K.get(l);return typeof u!="function"&&Oe("unknown function pointer with signature "+c+": "+l),u}var ri=void 0;function si(c){c=hi(c);var l=_e(c);return ht(c),l}function Pt(c,l){function u(F){_[F]||Q[F]||(S[F]?S[F].forEach(u):(v.push(F),_[F]=!0))}var v=[],_={};throw l.forEach(u),new ri(c+": "+v.map(si).join([", "]))}function fn(c,l){for(var u=[],v=0;v<c;v++)u.push(ce[(l>>2)+v]);return u}function hn(c,l,u,v,_){var F=l.length;2>F&&Oe("argTypes array size mismatch! Must at least get return value and 'this' types!");var z=l[1]!==null&&u!==null,G=!1;for(u=1;u<l.length;++u)if(l[u]!==null&&l[u].ja===void 0){G=!0;break}var Y=l[0].name!=="void",te=F-2,ne=Array(te),re=[],Ae=[];return function(){if(arguments.length!==te&&Oe("function "+c+" called with "+arguments.length+" arguments, expected "+te+" args!"),Ae.length=0,re.length=z?2:1,re[0]=_,z){var Le=l[1].toWireType(Ae,this);re[1]=Le}for(var Me=0;Me<te;++Me)ne[Me]=l[Me+2].toWireType(Ae,arguments[Me]),re.push(ne[Me]);if(Me=v.apply(null,re),G)Ne(Ae);else for(var Ye=z?1:2;Ye<l.length;Ye++){var Ze=Ye===1?Le:ne[Ye-2];l[Ye].ja!==null&&l[Ye].ja(Ze)}return Le=Y?l[0].fromWireType(Me):void 0,Le}}var pn=[],lt=[{},{value:void 0},{value:null},{value:!0},{value:!1}];function li(c){4<c&&--lt[c].Ca===0&&(lt[c]=void 0,pn.push(c))}function gn(c){return c||Oe("Cannot use deleted val. handle = "+c),lt[c].value}function yt(c){switch(c){case void 0:return 1;case null:return 2;case!0:return 3;case!1:return 4;default:var l=pn.length?pn.pop():lt.length;return lt[l]={Ca:1,value:c},l}}function Co(c,l,u){switch(l){case 0:return function(v){return this.fromWireType((u?we:pe)[v])};case 1:return function(v){return this.fromWireType((u?ae:fe)[v>>1])};case 2:return function(v){return this.fromWireType((u?ce:be)[v>>2])};default:throw new TypeError("Unknown integer type: "+c)}}function Lt(c,l){var u=Q[c];return u===void 0&&Oe(l+" has unknown type "+si(c)),u}function mn(c){if(c===null)return"null";var l=typeof c;return l==="object"||l==="array"||l==="function"?c.toString():""+c}function xo(c,l){switch(l){case 2:return function(u){return this.fromWireType(ge[u>>2])};case 3:return function(u){return this.fromWireType(ye[u>>3])};default:throw new TypeError("Unknown float type: "+c)}}function _o(c,l,u){switch(l){case 0:return u?function(v){return we[v]}:function(v){return pe[v]};case 1:return u?function(v){return ae[v>>1]}:function(v){return fe[v>>1]};case 2:return u?function(v){return ce[v>>2]}:function(v){return be[v>>2]};default:throw new TypeError("Unknown integer type: "+c)}}var Ao={};function yn(c){var l=Ao[c];return l===void 0?_e(c):l}var vn=[];function ci(){function c(l){l.$$$embind_global$$$=l;var u=typeof $$$embind_global$$$=="object"&&l.$$$embind_global$$$===l;return u||delete l.$$$embind_global$$$,u}if(typeof globalThis=="object")return globalThis;if(typeof $$$embind_global$$$=="object"||(typeof wn=="object"&&c(wn)?$$$embind_global$$$=wn:typeof self=="object"&&c(self)&&($$$embind_global$$$=self),typeof $$$embind_global$$$=="object"))return $$$embind_global$$$;throw Error("unable to get global object.")}function Mo(c){var l=vn.length;return vn.push(c),l}function $o(c,l){for(var u=Array(c),v=0;v<c;++v)u[v]=Lt(ce[(l>>2)+v],"parameter "+v);return u}var di=[];function Po(c){var l=Array(c+1);return function(u,v,_){l[0]=u;for(var F=0;F<c;++F){var z=Lt(ce[(v>>2)+F],"parameter "+F);l[F+1]=z.readValueFromPointer(_),_+=z.argPackAdvance}return u=new(u.bind.apply(u,l)),yt(u)}}var ui={},Lo=[null,[],[]];ue=a.InternalError=ee("InternalError");for(var fi=Array(256),Rt=0;256>Rt;++Rt)fi[Rt]=String.fromCharCode(Rt);He=fi,Ue=a.BindingError=ee("BindingError"),mt.prototype.isAliasOf=function(c){if(!(this instanceof mt&&c instanceof mt))return!1;var l=this.ea.ha.fa,u=this.ea.ga,v=c.ea.ha.fa;for(c=c.ea.ga;l.na;)u=l.ta(u),l=l.na;for(;v.na;)c=v.ta(c),v=v.na;return l===v&&u===c},mt.prototype.clone=function(){if(this.ea.ga||sn(this),this.ea.ra)return this.ea.count.value+=1,this;var c=kt,l=Object,u=l.create,v=Object.getPrototypeOf(this),_=this.ea;return c=c(u.call(l,v,{ea:{value:{count:_.count,pa:_.pa,ra:_.ra,ga:_.ga,ha:_.ha,ka:_.ka,ma:_.ma}}})),c.ea.count.value+=1,c.ea.pa=!1,c},mt.prototype.delete=function(){this.ea.ga||sn(this),this.ea.pa&&!this.ea.ra&&Oe("Object already scheduled for deletion"),ei(this),ti(this.ea),this.ea.ra||(this.ea.ka=void 0,this.ea.ga=void 0)},mt.prototype.isDeleted=function(){return!this.ea.ga},mt.prototype.deleteLater=function(){return this.ea.ga||sn(this),this.ea.pa&&!this.ea.ra&&Oe("Object already scheduled for deletion"),Ct.push(this),Ct.length===1&&Dt&&Dt(cn),this.ea.pa=!0,this},ft.prototype.Pa=function(c){return this.Ia&&(c=this.Ia(c)),c},ft.prototype.Ga=function(c){this.la&&this.la(c)},ft.prototype.argPackAdvance=8,ft.prototype.readValueFromPointer=Ke,ft.prototype.deleteObject=function(c){c!==null&&c.delete()},ft.prototype.fromWireType=function(c){function l(){return this.wa?$t(this.fa.qa,{ha:this.Sa,ga:u,ma:this,ka:c}):$t(this.fa.qa,{ha:this,ga:c})}var u=this.Pa(c);if(!u)return this.Ga(c),null;var v=ko(this.fa,u);if(v!==void 0)return v.ea.count.value===0?(v.ea.ga=u,v.ea.ka=c,v.clone()):(v=v.clone(),this.Ga(c),v);if(v=this.fa.Oa(u),v=ni[v],!v)return l.call(this);v=this.va?v.Ja:v.pointerType;var _=oi(u,this.fa,v.fa);return _===null?l.call(this):this.wa?$t(v.fa.qa,{ha:v,ga:_,ma:this,ka:c}):$t(v.fa.qa,{ha:v,ga:_})},a.getInheritedInstanceCount=function(){return Object.keys(xt).length},a.getLiveInheritedInstances=function(){var c=[],l;for(l in xt)xt.hasOwnProperty(l)&&c.push(xt[l]);return c},a.flushPendingDeletes=cn,a.setDelayFunction=function(c){Dt=c,Ct.length&&Dt&&Dt(cn)},ri=a.UnboundTypeError=ee("UnboundTypeError"),a.count_emval_handles=function(){for(var c=0,l=5;l<lt.length;++l)lt[l]!==void 0&&++c;return c},a.get_first_emval=function(){for(var c=5;c<lt.length;++c)if(lt[c]!==void 0)return lt[c];return null};var Ro={r:function(c){var l=ve[c];delete ve[c];var u=l.elements,v=u.length,_=u.map(function(G){return G.Aa}).concat(u.map(function(G){return G.Ea})),F=l.sa,z=l.la;he([c],_,function(G){return u.forEach(function(Y,te){var ne=G[te],re=Y.ya,Ae=Y.za,Le=G[te+v],Me=Y.Da,Ye=Y.Fa;Y.read=Ze=>ne.fromWireType(re(Ae,Ze)),Y.write=(Ze,Et)=>{var at=[];Me(Ye,Ze,Le.toWireType(at,Et)),Ne(at)}}),[{name:l.name,fromWireType:function(Y){for(var te=Array(v),ne=0;ne<v;++ne)te[ne]=u[ne].read(Y);return z(Y),te},toWireType:function(Y,te){if(v!==te.length)throw new TypeError("Incorrect number of tuple elements for "+l.name+": expected="+v+", actual="+te.length);for(var ne=F(),re=0;re<v;++re)u[re].write(ne,te[re]);return Y!==null&&Y.push(z,ne),ne},argPackAdvance:8,readValueFromPointer:Ke,ja:z}]})},u:function(c){var l=xe[c];delete xe[c];var u=l.sa,v=l.la,_=l.Ha,F=_.map(function(z){return z.Aa}).concat(_.map(function(z){return z.Ea}));he([c],F,function(z){var G={};return _.forEach(function(Y,te){var ne=z[te],re=Y.ya,Ae=Y.za,Le=z[te+_.length],Me=Y.Da,Ye=Y.Fa;G[Y.Na]={read:function(Ze){return ne.fromWireType(re(Ae,Ze))},write:function(Ze,Et){var at=[];Me(Ye,Ze,Le.toWireType(at,Et)),Ne(at)}}}),[{name:l.name,fromWireType:function(Y){var te={},ne;for(ne in G)te[ne]=G[ne].read(Y);return v(Y),te},toWireType:function(Y,te){for(var ne in G)if(!(ne in te))throw new TypeError('Missing field:  "'+ne+'"');var re=u();for(ne in G)G[ne].write(re,te[ne]);return Y!==null&&Y.push(v,re),re},argPackAdvance:8,readValueFromPointer:Ke,ja:v}]})},z:function(){},F:function(c,l,u,v,_){var F=Ie(u);l=_e(l),dt(c,{name:l,fromWireType:function(z){return!!z},toWireType:function(z,G){return G?v:_},argPackAdvance:8,readValueFromPointer:function(z){if(u===1)var G=we;else if(u===2)G=ae;else if(u===4)G=ce;else throw new TypeError("Unknown boolean type size: "+l);return this.fromWireType(G[z>>F])},ja:null})},l:function(c,l,u,v,_,F,z,G,Y,te,ne,re,Ae){ne=_e(ne),F=ze(_,F),G&&(G=ze(z,G)),te&&(te=ze(Y,te)),Ae=ze(re,Ae);var Le=B(ne);dn(Le,function(){Pt("Cannot construct "+ne+" due to unbound types",[v])}),he([c,l,u],v?[v]:[],function(Me){if(Me=Me[0],v)var Ye=Me.fa,Ze=Ye.qa;else Ze=mt.prototype;Me=j(Le,function(){if(Object.getPrototypeOf(this)!==Et)throw new Ue("Use 'new' to construct "+ne);if(at.oa===void 0)throw new Ue(ne+" has no accessible constructor");var gi=at.oa[arguments.length];if(gi===void 0)throw new Ue("Tried to invoke ctor of "+ne+" with invalid number of parameters ("+arguments.length+") - expected ("+Object.keys(at.oa).toString()+") parameters instead!");return gi.apply(this,arguments)});var Et=Object.create(Ze,{constructor:{value:Me}});Me.prototype=Et;var at=new To(ne,Me,Et,Ae,Ye,F,G,te);Ye=new ft(ne,at,!0,!1),Ze=new ft(ne+"*",at,!1,!1);var pi=new ft(ne+" const*",at,!1,!0);return ni[c]={pointerType:Ze,Ja:pi},ai(Le,Me),[Ye,Ze,pi]})},i:function(c,l,u,v,_,F){0<l||le(void 0);var z=fn(l,u);_=ze(v,_),he([],[c],function(G){G=G[0];var Y="constructor "+G.name;if(G.fa.oa===void 0&&(G.fa.oa=[]),G.fa.oa[l-1]!==void 0)throw new Ue("Cannot register multiple constructors with identical number of parameters ("+(l-1)+") for class '"+G.name+"'! Overload resolution is currently only performed using the parameter count, not actual type info!");return G.fa.oa[l-1]=()=>{Pt("Cannot construct "+G.name+" due to unbound types",z)},he([],z,function(te){return te.splice(1,0,null),G.fa.oa[l-1]=hn(Y,te,null,_,F),[]}),[]})},a:function(c,l,u,v,_,F,z,G){var Y=fn(u,v);l=_e(l),F=ze(_,F),he([],[c],function(te){function ne(){Pt("Cannot call "+re+" due to unbound types",Y)}te=te[0];var re=te.name+"."+l;l.startsWith("@@")&&(l=Symbol[l.substring(2)]),G&&te.fa.Ta.push(l);var Ae=te.fa.qa,Le=Ae[l];return Le===void 0||Le.ia===void 0&&Le.className!==te.name&&Le.ua===u-2?(ne.ua=u-2,ne.className=te.name,Ae[l]=ne):(ii(Ae,l,re),Ae[l].ia[u-2]=ne),he([],Y,function(Me){return Me=hn(re,Me,te,F,z),Ae[l].ia===void 0?(Me.ua=u-2,Ae[l]=Me):Ae[l].ia[u-2]=Me,[]}),[]})},I:function(c,l,u){c=_e(c),he([],[l],function(v){return v=v[0],a[c]=v.fromWireType(u),[]})},E:function(c,l){l=_e(l),dt(c,{name:l,fromWireType:function(u){var v=gn(u);return li(u),v},toWireType:function(u,v){return yt(v)},argPackAdvance:8,readValueFromPointer:Ke,ja:null})},h:function(c,l,u,v){function _(){}u=Ie(u),l=_e(l),_.values={},dt(c,{name:l,constructor:_,fromWireType:function(F){return this.constructor.values[F]},toWireType:function(F,z){return z.value},argPackAdvance:8,readValueFromPointer:Co(l,u,v),ja:null}),dn(l,_)},k:function(c,l,u){var v=Lt(c,"enum");l=_e(l),c=v.constructor,v=Object.create(v.constructor.prototype,{value:{value:u},constructor:{value:j(v.name+"_"+l,function(){})}}),c.values[u]=v,c[l]=v},q:function(c,l,u){u=Ie(u),l=_e(l),dt(c,{name:l,fromWireType:function(v){return v},toWireType:function(v,_){return _},argPackAdvance:8,readValueFromPointer:xo(l,u),ja:null})},f:function(c,l,u,v,_,F){var z=fn(l,u);c=_e(c),_=ze(v,_),dn(c,function(){Pt("Cannot call "+c+" due to unbound types",z)},l-1),he([],z,function(G){return G=[G[0],null].concat(G.slice(1)),ai(c,hn(c,G,null,_,F),l-1),[]})},e:function(c,l,u,v,_){l=_e(l),_===-1&&(_=4294967295),_=Ie(u);var F=G=>G;if(v===0){var z=32-8*u;F=G=>G<<z>>>z}u=l.includes("unsigned")?function(G,Y){return Y>>>0}:function(G,Y){return Y},dt(c,{name:l,fromWireType:F,toWireType:u,argPackAdvance:8,readValueFromPointer:_o(l,_,v!==0),ja:null})},b:function(c,l,u){function v(F){F>>=2;var z=be;return new _(ke,z[F+1],z[F])}var _=[Int8Array,Uint8Array,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array][l];u=_e(u),dt(c,{name:u,fromWireType:v,argPackAdvance:8,readValueFromPointer:v},{Qa:!0})},p:function(c,l){l=_e(l);var u=l==="std::string";dt(c,{name:l,fromWireType:function(v){var _=be[v>>2];if(u)for(var F=v+4,z=0;z<=_;++z){var G=v+4+z;if(z==_||pe[G]==0){if(F=F?I(pe,F,G-F):"",Y===void 0)var Y=F;else Y+=String.fromCharCode(0),Y+=F;F=G+1}}else{for(Y=Array(_),z=0;z<_;++z)Y[z]=String.fromCharCode(pe[v+4+z]);Y=Y.join("")}return ht(v),Y},toWireType:function(v,_){_ instanceof ArrayBuffer&&(_=new Uint8Array(_));var F=typeof _=="string";F||_ instanceof Uint8Array||_ instanceof Uint8ClampedArray||_ instanceof Int8Array||Oe("Cannot pass non-string to std::string");var z=(u&&F?()=>{for(var te=0,ne=0;ne<_.length;++ne){var re=_.charCodeAt(ne);55296<=re&&57343>=re&&(re=65536+((re&1023)<<10)|_.charCodeAt(++ne)&1023),127>=re?++te:te=2047>=re?te+2:65535>=re?te+3:te+4}return te}:()=>_.length)(),G=En(4+z+1);if(be[G>>2]=z,u&&F)y(_,G+4,z+1);else if(F)for(F=0;F<z;++F){var Y=_.charCodeAt(F);255<Y&&(ht(G),Oe("String has UTF-16 code units that do not fit in 8 bits")),pe[G+4+F]=Y}else for(F=0;F<z;++F)pe[G+4+F]=_[F];return v!==null&&v.push(ht,G),G},argPackAdvance:8,readValueFromPointer:Ke,ja:function(v){ht(v)}})},m:function(c,l,u){if(u=_e(u),l===2)var v=X,_=q,F=oe,z=()=>fe,G=1;else l===4&&(v=se,_=J,F=Ee,z=()=>be,G=2);dt(c,{name:u,fromWireType:function(Y){for(var te=be[Y>>2],ne=z(),re,Ae=Y+4,Le=0;Le<=te;++Le){var Me=Y+4+Le*l;(Le==te||ne[Me>>G]==0)&&(Ae=v(Ae,Me-Ae),re===void 0?re=Ae:(re+=String.fromCharCode(0),re+=Ae),Ae=Me+l)}return ht(Y),re},toWireType:function(Y,te){typeof te!="string"&&Oe("Cannot pass non-string to C++ string type "+u);var ne=F(te),re=En(4+ne+l);return be[re>>2]=ne>>G,_(te,re+4,ne+l),Y!==null&&Y.push(ht,re),re},argPackAdvance:8,readValueFromPointer:Ke,ja:function(Y){ht(Y)}})},t:function(c,l,u,v,_,F){ve[c]={name:_e(l),sa:ze(u,v),la:ze(_,F),elements:[]}},s:function(c,l,u,v,_,F,z,G,Y){ve[c].elements.push({Aa:l,ya:ze(u,v),za:_,Ea:F,Da:ze(z,G),Fa:Y})},v:function(c,l,u,v,_,F){xe[c]={name:_e(l),sa:ze(u,v),la:ze(_,F),Ha:[]}},j:function(c,l,u,v,_,F,z,G,Y,te){xe[c].Ha.push({Na:_e(l),Aa:u,ya:ze(v,_),za:F,Ea:z,Da:ze(G,Y),Fa:te})},G:function(c,l){l=_e(l),dt(c,{Ra:!0,name:l,argPackAdvance:0,fromWireType:function(){},toWireType:function(){}})},d:function(c,l,u,v){c=vn[c],l=gn(l),u=yn(u),c(l,u,null,v)},J:li,x:function(c){return c===0?yt(ci()):(c=yn(c),yt(ci()[c]))},c:function(c,l){var u=$o(c,l),v=u[0];l=v.name+"_$"+u.slice(1).map(function(z){return z.name}).join("_")+"$";var _=di[l];if(_!==void 0)return _;var F=Array(c-1);return _=Mo((z,G,Y,te)=>{for(var ne=0,re=0;re<c-1;++re)F[re]=u[re+1].readValueFromPointer(te+ne),ne+=u[re+1].argPackAdvance;for(z=z[G].apply(z,F),re=0;re<c-1;++re)u[re+1].Ka&&u[re+1].Ka(F[re]);if(!v.Ra)return v.toWireType(Y,z)}),di[l]=_},n:function(c){4<c&&(lt[c].Ca+=1)},w:function(c,l,u,v){c=gn(c);var _=ui[l];return _||(_=Po(l),ui[l]=_),_(c,u,v)},K:function(){return yt([])},D:function(c){return yt(yn(c))},H:function(c,l){return c=Lt(c,"_emval_take_value"),c=c.readValueFromPointer(l),yt(c)},g:function(){le("")},B:function(c){var l=pe.length;if(c>>>=0,2147483648<c)return!1;for(var u=1;4>=u;u*=2){var v=l*(1+.2/u);v=Math.min(v,c+100663296),v=Math.max(c,v),0<v%65536&&(v+=65536-v%65536);e:{try{x.grow(Math.min(2147483648,v)-ke.byteLength+65535>>>16),me();var _=1;break e}catch{}_=void 0}if(_)return!0}return!1},C:function(){return 0},y:function(){},o:function(c,l,u,v){for(var _=0,F=0;F<u;F++){var z=ce[l>>2],G=ce[l+4>>2];l+=8;for(var Y=0;Y<G;Y++){var te=pe[z+Y],ne=Lo[c];te===0||te===10?((c===1?H:R)(I(ne,0)),ne.length=0):ne.push(te)}_+=G}return ce[v>>2]=_,0},A:function(){}};(function(){function c(_){a.asm=_.exports,x=a.asm.L,me(),K=a.asm._,E.unshift(a.asm.M),W--,a.monitorRunDependencies&&a.monitorRunDependencies(W),W==0&&V&&(_=V,V=null,_())}function l(_){c(_.instance)}function u(_){return Be().then(function(F){return WebAssembly.instantiate(F,v)}).then(function(F){return F}).then(_,function(F){R("failed to asynchronously prepare wasm: "+F),le(F)})}var v={a:Ro};if(W++,a.monitorRunDependencies&&a.monitorRunDependencies(W),a.instantiateWasm)try{return a.instantiateWasm(v,c)}catch(_){return R("Module.instantiateWasm callback failed with error: "+_),!1}return function(){return ie||typeof WebAssembly.instantiateStreaming!="function"||De()||Se.startsWith("file://")||typeof fetch!="function"?u(l):fetch(Se,{credentials:"same-origin"}).then(function(_){return WebAssembly.instantiateStreaming(_,v).then(l,function(F){return R("wasm streaming compile failed: "+F),R("falling back to ArrayBuffer instantiation"),u(l)})})}().catch(h),{}})(),a.___wasm_call_ctors=function(){return(a.___wasm_call_ctors=a.asm.M).apply(null,arguments)},a.__Z6ToCmdsRK6SkPath=function(){return(a.__Z6ToCmdsRK6SkPath=a.asm.N).apply(null,arguments)},a.__Z8FromCmdsmi=function(){return(a.__Z8FromCmdsmi=a.asm.O).apply(null,arguments)},a.__Z7NewPathv=function(){return(a.__Z7NewPathv=a.asm.P).apply(null,arguments)},a.__Z8CopyPathRK6SkPath=function(){return(a.__Z8CopyPathRK6SkPath=a.asm.Q).apply(null,arguments)},a.__Z6EqualsRK6SkPathS1_=function(){return(a.__Z6EqualsRK6SkPathS1_=a.asm.R).apply(null,arguments)},a.__Z11ToSVGStringRK6SkPath=function(){return(a.__Z11ToSVGStringRK6SkPath=a.asm.S).apply(null,arguments)},a.__Z13FromSVGStringNSt3__212basic_stringIcNS_11char_traitsIcEENS_9allocatorIcEEEE=function(){return(a.__Z13FromSVGStringNSt3__212basic_stringIcNS_11char_traitsIcEENS_9allocatorIcEEEE=a.asm.T).apply(null,arguments)},a.__Z13ApplySimplifyR6SkPath=function(){return(a.__Z13ApplySimplifyR6SkPath=a.asm.U).apply(null,arguments)},a.__Z11ApplyPathOpR6SkPathRKS_8SkPathOp=function(){return(a.__Z11ApplyPathOpR6SkPathRKS_8SkPathOp=a.asm.V).apply(null,arguments)},a.__Z10MakeFromOpRK6SkPathS1_8SkPathOp=function(){return(a.__Z10MakeFromOpRK6SkPathS1_8SkPathOp=a.asm.W).apply(null,arguments)},a.__Z14ResolveBuilderR11SkOpBuilder=function(){return(a.__Z14ResolveBuilderR11SkOpBuilder=a.asm.X).apply(null,arguments)},a.__Z8ToCanvasRK6SkPathN10emscripten3valE=function(){return(a.__Z8ToCanvasRK6SkPathN10emscripten3valE=a.asm.Y).apply(null,arguments)},a.__Z8ToPath2DRK6SkPath=function(){return(a.__Z8ToPath2DRK6SkPath=a.asm.Z).apply(null,arguments)};var ht=a._free=function(){return(ht=a._free=a.asm.$).apply(null,arguments)},En=a._malloc=function(){return(En=a._malloc=a.asm.aa).apply(null,arguments)},hi=a.___getTypeName=function(){return(hi=a.___getTypeName=a.asm.ba).apply(null,arguments)};a.___embind_register_native_and_builtin_types=function(){return(a.___embind_register_native_and_builtin_types=a.asm.ca).apply(null,arguments)},a.dynCall_jiji=function(){return(a.dynCall_jiji=a.asm.da).apply(null,arguments)};var Xt;V=function c(){Xt||In(),Xt||(V=c)};function In(){function c(){if(!Xt&&(Xt=!0,a.calledRun=!0,!w)){if(Ce(E),d(a),a.onRuntimeInitialized&&a.onRuntimeInitialized(),a.postRun)for(typeof a.postRun=="function"&&(a.postRun=[a.postRun]);a.postRun.length;){var l=a.postRun.shift();k.unshift(l)}Ce(k)}}if(!(0<W)){if(a.preRun)for(typeof a.preRun=="function"&&(a.preRun=[a.preRun]);a.preRun.length;)U();Ce(f),0<W||(a.setStatus?(a.setStatus("Running..."),setTimeout(function(){setTimeout(function(){a.setStatus("")},1),c()},1)):c())}}if(a.run=In,a.preInit)for(typeof a.preInit=="function"&&(a.preInit=[a.preInit]);0<a.preInit.length;)a.preInit.pop()();return In(),o.ready}})();n.exports=t})(to);var sr=to.exports;const lr=Wn(sr),cr="/assets/pathkit-1356ccfa.wasm";class Cn{startTime;accumulatedTime;constructor(){this.startTime=-1,this.accumulatedTime=-1}start(){this.startTime=performance.now(),this.accumulatedTime=0}resume(){this.startTime=performance.now()}pause(){return this.accumulatedTime+=performance.now()-this.startTime,this.startTime=-1,this.accumulatedTime}stop(){if(this.startTime!=-1){const e=performance.now()-this.startTime+this.accumulatedTime;return this.accumulatedTime=0,e}else{const e=this.accumulatedTime;return this.accumulatedTime=0,e}}}class dr{activated;constructor(e){this.activated=e}async BlueTokenBoundingPath(e){if(this.activated){const t=gt().strokeColor("#0000ff").locked(!0).fillOpacity(1).commands(e.toCmds()).metadata({[`${s.EXTENSIONID}/debug`]:!0}).build();await b.scene.local.addItems([t])}}async RedIntersectionPath(e){if(this.activated){const t=gt().fillRule("evenodd").locked(!0).strokeColor("#ff0000").fillOpacity(0).commands(e.toCmds()).metadata({[`${s.EXTENSIONID}/debug`]:!0}).build();await b.scene.local.addItems([t])}}async GreenDebugPath(e){if(this.activated){const t=gt().commands(e.toCmds()).locked(!0).visible(e.visible).fillColor("#555500").fillOpacity(.3).strokeColor("#00FF00").layer("DRAWING").metadata({[`${s.EXTENSIONID}/debug`]:!0}).build();await b.scene.local.addItems([t])}}async DebugBlobINeverUse(){this.activated}}const Vt=new dr(!1);function Ht(n,e){return(n.x-e.x)*(n.x-e.x)+(n.y-e.y)*(n.y-e.y)}function no(n,e){return n.x==e.x&&n.y==e.y}function Ut(n,e,t){return t===void 0&&(t=.01),Math.abs(n-e)<=t}function xn(n,e){return(n%e+e)%e}function ur(n,e){return qe.pointInPolygon(n[0],e)||qe.pointInPolygon(n[0],e)?!0:Gt(n,[e[0],e[1]])||Gt(n,[e[1],e[2]])||Gt(n,[e[2],e[3]])||Gt(n,[e[3],e[0]])}function Gt(n,e){const t=(n[1].x-n[0].x)*(e[1].y-e[0].y)-(e[1].x-e[0].x)*(n[1].y-n[0].y),i=((e[1].y-e[0].y)*(e[1].x-n[0].x)+(e[0].x-e[1].x)*(e[1].y-n[0].y))/t,o=((n[0].y-n[1].y)*(e[1].x-n[0].x)+(n[1].x-n[0].x)*(e[1].y-n[0].y))/t;return i>=0&&i<=1&&o>=0&&o<=1}function Wt(n,e,t){return{x:n.x+e*Math.cos(t),y:n.y+e*Math.sin(t)}}function fr(n,e,t,i){const o=Math.atan2(n.y-t.y,n.x-t.x);let a=Wt(n,e,o+Math.PI/2),r=Wt(n,e,o-Math.PI/2),d=Wt(t,i,o+Math.PI/2),h=Wt(t,i,o-Math.PI/2);const m=qe.normalize(qe.subtract(n,t));return a=qe.add(a,qe.multiply(m,e)),r=qe.add(r,qe.multiply(m,e)),d=qe.add(d,qe.multiply(m,0-i)),h=qe.add(h,qe.multiply(m,0-i)),[a,r,h,d]}function hr(n){return n.filter(e=>e.points&&e.points.length>1).flatMap(e=>{const t=We.fromItem(e);return e.points.slice(0,-1).map((i,o)=>{const a=We.fromPosition(e.points[o]),r=We.fromPosition(e.points[o+1]),d=We.decompose(We.multiply(t,a)).position,h=We.decompose(We.multiply(t,r)).position;return{startPosition:d,endPosition:h,originalShape:e,oneSided:e.metadata[`${s.EXTENSIONID}/oneSided`]}})})}function pr(n,e,t,i,o,a){const r=parseInt(p.sceneMetadata[`${s.EXTENSIONID}/defaultMELDepth`]??"0");let d=[],h=[t,i];const m=p.sceneMetadata[`${s.EXTENSIONID}/elevationMapping`]??[],N=[{x:(t+o[0])*a[0],y:o[1]*a[1]},{x:(t+o[0])*a[0],y:(i+o[1])*a[1]},{x:o[0]*a[0],y:(i+o[1])*a[1]},{x:o[0]*a[0],y:o[1]*a[1]}],D=p.gridDpi,A=s.EXTENSIONID,M=e.some(Tt);if(e.length===0)return d;for(const R of e){const ie=p.playerId===R.createdUserId,w=p.sceneMetadata[`${s.EXTENSIONID}/USER-${R.createdUserId}`]?.role==="GM";let g;for(const q of m)Ei(R.position,q.Points)&&(g===void 0||q.Depth>g)&&(g=q.Depth);if(g===void 0&&(g=r),!ie&&p.playerRole!=="GM"&&!w)continue;const I=R.metadata[`${A}/visionRange`],y=p.playerShadowCache.getValue(R.id);if(d.push([]),y!==void 0&&no(y.player.position,R.position)&&y.player.metadata[`${A}/visionRange`]===I)continue;let C=D*1e3;I&&(C=D*(I/p.gridScale+.5));const X=[];if(M&&!Tt(R)){for(const q of e)if(Tt(q)){const oe=q.metadata[`${s.EXTENSIONID}/visionRange`];let se=1e3*p.gridDpi;oe&&(se=p.gridDpi*(oe/p.gridScale+.5));const J=fr(R.position,C,q.position,se);X.push(J)}}for(const q of n){let oe;for(const V of m)Ei(q.startPosition,V.Points)&&(oe===void 0||V.Depth>oe)&&(oe=V.Depth);if(oe===void 0&&(oe=r),g>=oe&&oe!==0&&g!==0)continue;const se=(R.position.x-q.startPosition.x)*(q.endPosition.y-q.startPosition.y)-(R.position.y-q.startPosition.y)*(q.endPosition.x-q.startPosition.x);if(q.oneSided!==void 0&&(q.oneSided==="right"&&se>0||q.oneSided==="left"&&se<0))continue;let J=q.startPosition.x,Ee=q.startPosition.y,ke=q.endPosition.x,we=q.endPosition.y;(J<o[0]||Ee<o[1]||J>o[0]+h[0]||Ee>o[1]+h[1]||ke<o[0]||we<o[1]||ke>o[0]+h[0]||we>o[1]+h[1])&&(J=Math.max(o[0],Math.min(J,o[0]+h[0])),Ee=Math.max(o[1],Math.min(Ee,o[1]+h[1])),q.startPosition=Pi(q,o,h).startPosition,q.endPosition=Pi(q,o,h).endPosition);const pe=[q.startPosition,q.endPosition],ae=qe.distance(q.startPosition,q.endPosition),ce=Math.floor(ae/(C/3));for(let V=1;V<ce;V++)pe.push(qe.lerp(q.startPosition,q.endPosition,V/ce));let be=!0;for(const V of pe)if(qe.compare(R.position,V,C*1.05)){be=!1;break}if(be&&M&&!Tt(R)){for(const V of X)if(ur([q.startPosition,q.endPosition],V)){be=!1;break}}if(be)continue;const ge={x:q.startPosition.x-R.position.x,y:q.startPosition.y-R.position.y},ye={x:q.endPosition.x-R.position.x,y:q.endPosition.y-R.position.y};var T={x:0,y:0},P={x:0,y:0},O=0,L=0,$=0,H=0;ge.x<0?O=o[0]*a[0]:O=(t+o[0])*a[0],ge.y<0?L=o[1]*a[1]:L=(i+o[1])*a[1],ye.x<0?$=o[0]*a[0]:$=(t+o[0])*a[0],ye.y<0?H=o[1]*a[1]:H=(i+o[1])*a[1];const me=[],K=[];if(ge.x!=0){const V=ge.y/ge.x,le=q.startPosition.y-V*q.startPosition.x;me.push({x:O,y:V*O+le})}if(ge.y!=0){const V=ge.x/ge.y,le=V*q.startPosition.y-q.startPosition.x;me.push({x:V*L-le,y:L})}if(ye.x!=0){const V=ye.y/ye.x,le=q.endPosition.y-V*q.endPosition.x;K.push({x:$,y:V*$+le})}if(ye.y!=0){const V=ye.x/ye.y,le=V*q.endPosition.y-q.endPosition.x;K.push({x:V*H-le,y:H})}if(me.length===0||K.length===0)continue;me.length==1||Ht(me[0],q.startPosition)<Ht(me[1],q.startPosition)?T=me[0]:T=me[1],K.length==1||Ht(K[0],q.endPosition)<Ht(K[1],q.endPosition)?P=K[0]:P=K[1];const f=[{x:q.startPosition.x,y:q.startPosition.y},T,P,{x:q.endPosition.x,y:q.endPosition.y}],E=[0,0];let k=0;for(const V of[T,P])Ut(V.y,o[1]*a[1])?E[k]=0:Ut(V.y,(i+o[1])*a[1])?E[k]=2:Ut(V.x,o[0]*a[0])?E[k]=3:Ut(V.x,(t+o[0])*a[0])&&(E[k]=1),k++;let U=Math.sign(se);U=U==0?1:-U;const W=U==1?E[1]:xn(E[1]-1,4);for(let V=E[0]+(U==1?0:-1);xn(V,4)!=W;V+=U)f.splice(f.length-2,0,N[xn(V,4)]);d[d.length-1].push({pointset:f,fromShape:q.originalShape})}}return d}function Pi(n,e,t){let{x:i,y:o}=n.startPosition,{x:a,y:r}=n.endPosition,d=(r-o)/(a-i),h=o-d*i,m=[];if(o<e[1]){let M=(e[1]-h)/d;M>=e[0]&&M<=e[0]+t[0]&&m.push({x:M,y:e[1]})}if(o>e[1]+t[1]){let M=(e[1]+t[1]-h)/d;M>=e[0]&&M<=e[0]+t[0]&&m.push({x:M,y:e[1]+t[1]})}if(i<e[0]){let M=d*e[0]+h;M>=e[1]&&M<=e[1]+t[1]&&m.push({x:e[0],y:M})}if(i>e[0]+t[0]){let M=d*(e[0]+t[0])+h;M>=e[1]&&M<=e[1]+t[1]&&m.push({x:e[0]+t[0],y:M})}m.sort((M,T)=>{let P=Math.sqrt((M.x-i)**2+(M.y-o)**2),O=Math.sqrt((T.x-i)**2+(T.y-o)**2);return P-O});let N=m.length>0?m[0]:{x:i,y:o},D=m.length>0?m[m.length-1]:{x:a,y:r};return{startPosition:N,endPosition:D}}let Re;async function St(n){if(await b.action.setBadgeText("⏱️"),await b.player.setMetadata({[`${s.EXTENSIONID}/processed`]:!1}),Re||(Re=await lr({locateFile:()=>cr})),!p.sceneReady||!p.sceneInitialized){p.playerShadowCache.invalidate(),p.busy=!1,await b.action.setBadgeText(void 0);return}if(p.busy)return;p.busy=!0;const[e,t]=[new Cn,new Cn];e.start(),e.pause(),t.start();const i=p.sceneItems.filter(ae=>Ri(ae)&&(!Tt(ae)||ae.visible===!0)),o=p.sceneItems.filter(Xr),a=p.sceneItems.filter(Xi),r=p.sceneItems.filter(mo)?.[0],d=p.sceneItems.filter(Qn)?.[0],h=p.sceneMetadata[`${s.EXTENSIONID}/visionEnabled`]===!0,m=p.sceneMetadata[`${s.EXTENSIONID}/persistenceEnabled`]===!0,N=p.sceneMetadata[`${s.EXTENSIONID}/autodetectEnabled`]===!0,D=p.sceneMetadata[`${s.EXTENSIONID}/fowEnabled`]===!0,A=p.sceneMetadata[`${s.EXTENSIONID}/fowColor`],M=p.sceneMetadata[`${s.EXTENSIONID}/playerDoors`]===!0;let T=[0,0],P=[1,1],O=[0,0],[L,$]=T,H=!1,R=[];if(r===void 0&&d===void 0){p.playerShadowCache.invalidate(),p.busy=!1,await b.action.setBadgeText(void 0);return}else if(N){const ae=p.sceneItems.filter(ce=>ce.layer==="MAP"&&Jt(ce));if(ae.length===0){p.busy=!1,await b.action.setBadgeText(void 0);return}let fe=[];for(let ce of ae){let be=p.gridDpi/ce.grid.dpi,ge=ce.position.x-be*ce.grid.offset.x*ce.scale.x,ye=ce.position.y-be*ce.grid.offset.y*ce.scale.y,me=ge+be*ce.image.width*ce.scale.x,K=ye+be*ce.image.height*ce.scale.y;if(ce.rotation>0){const f=Math.abs(me-ge),E=Math.abs(K-ye);switch(ce.rotation){case 270:ye-=E,K-=E;break;case 180:ye-=E,K-=E,ge-=f,me-=f;break;case 90:ge-=f,me-=f;break}}fe.length?(ge<fe[0]&&(fe[0]=ge),ye<fe[1]&&(fe[1]=ye),me>fe[2]&&(fe[2]=me),K>fe[3]&&(fe[3]=K)):(fe[0]=ge,fe[1]=ye,fe[2]=me,fe[3]=K)}O=[fe[0],fe[1]],T=[fe[2]-fe[0],fe[3]-fe[1]],P=[1,1],[L,$]=T}else T[0]=d.width*d.scale.x,T[1]=d.height*d.scale.y,P[0]=d.scale.x,P[1]=d.scale.y,O[0]=d.position.x,O[1]=d.position.y,[L,$]=T;if(p.playerRole==="GM"){R=i;const ae=document.getElementById("mapHeight"),fe=document.getElementById("mapWidth");fe&&(fe.value=(Math.round(T[0])/p.gridDpi).toString()),ae&&(ae.value=(Math.round(T[1])/p.gridDpi).toString())}else{R=i.filter(Fr);for(const ae of i)Ri(ae)&&p.sceneMetadata[`${s.EXTENSIONID}/USER-${ae.createdUserId}`]?.role==="GM"&&R.push(ae)}const ie=JSON.stringify(o),x=JSON.stringify(a),w=JSON.stringify(R),g=JSON.stringify(r);if(p.previousMap===g&&p.previousVisionEnabled===h&&p.previousFowColor===A&&p.previousAutodetectEnabled===N&&p.previousFowEnabled===D&&p.previousPersistenceEnabled===m&&p.previousVisionShapes===ie&&p.previousAutohideItems===x&&p.previousPlayersWithVision===w&&p.previousSize[0]===T[0]&&p.previousSize[1]===T[1]&&n!==!0){p.busy=!1,await b.action.setBadgeText(void 0);return}(g!=p.previousMap||p.previousVisionShapes!=ie||T[0]!=p.previousSize[0]||T[1]!=p.previousSize[1])&&(H=!0),p.previousMap=g,p.previousPlayersWithVision=w,p.previousVisionShapes=ie,p.previousSize=T,p.previousVisionEnabled=h,p.previousAutodetectEnabled=N,p.previousFowEnabled=D,p.previousFowColor=A,p.previousPersistenceEnabled=m,t.pause();const I=[];for(let ae=0;ae<=6;ae++)I.push(new Cn);I[1].start();let y=0,C=0;if(H&&p.playerShadowCache.invalidate(),t.resume(),!(p.sceneMetadata[`${s.EXTENSIONID}/visionEnabled`]===!0)||R.length==0){const ae=p.sceneLocal.filter(fe=>Gn(fe));await b.scene.local.deleteItems(ae.map(fe=>fe.id)),p.busy=!1,await b.action.setBadgeText(void 0);return}const q=hr(o),oe=pr(q,R,L,$,O,P);if(oe.length==0){p.busy=!1,await b.action.setBadgeText(void 0);return}const se=[];I[1].pause(),I[2].start();const J={};let Ee=0;await ke();async function ke(){const ae=R[Ee];let fe=p.playerShadowCache.getValue(ae.id);if(fe!==void 0&&no(fe.player.position,ae.position)&&fe.player.metadata[`${s.EXTENSIONID}/visionRange`]===ae.metadata[`${s.EXTENSIONID}/visionRange`]){const me=Re.FromCmds(fe.shadowPath);if(J[Ee]=me,y++,Ee===R.length-1){await we(I);return}else{Ee++,await ke();return}}C++;const ce=oe[Ee];let be=new Re.SkOpBuilder;const ge=Re.NewPath().rect(O[0],O[1],T[0],T[1]);be.add(ge,Re.PathOp.UNION),ge.delete(),await ye(ce);function ye(me){const K=Math.ceil(me.length/p.workers.length);let f=0,E=0,k={};for(let U=0;U<p.workers.length;U++){const W=f+K,V=me.slice(f,W+10);p.workers[U].onmessage=async function(le){if(le.data){const{numb:De,messageData:Se}=le.data;if(E++,k[De]=Se,E===p.workers.length){for(let Be=0;Be<p.workers.length;Be++){const Ce=k[Be];if(Ce){const ve=Re.FromCmds(Ce);be.add(ve,Re.PathOp.INTERSECT),ve.delete()}}let Xe=be.resolve();if(Xe.simplify(),!Xe){console.error("Couldn't compute fog"),p.busy=!1,await b.action.setBadgeText(void 0);return}J[Ee]=Xe,fe!==void 0&&(fe.shadowPath="");const Ve=Xe.toCmds();p.playerShadowCache.cacheValue(ae.id,{shadowPath:Ve,player:ae}),be.delete(),Ee===R.length-1?await we(I):(Ee++,await ke())}}},p.workers[U].postMessage({numb:U,polygons:V,mapOffset:O,mapSize:T}),f=W}}}async function we(ae){ae[2].pause(),ae[3].start();const fe=[],ce=Re.NewPath();for(let Q=0;Q<R.length;Q++){const S=R[Q],B=S.metadata[`${s.EXTENSIONID}/visionRange`],j=p.playerId===R[Q].createdUserId,ue=p.sceneMetadata[`${s.EXTENSIONID}/USER-${R[Q].createdUserId}`]?.role==="GM";if(Tt(S)?fe[Q]=!0:ce.op(J[Q],Re.PathOp.UNION),B){if(!j&&p.playerRole!=="GM"&&!ue)continue;const de=p.gridDpi*(B/p.gridScale+.5),he=Re.NewPath().ellipse(S.position.x,S.position.y,de,de,0,0,2*Math.PI);J[Q]?.op(he,Re.PathOp.INTERSECT),he.delete();const xe=p.sceneMetadata[`${s.EXTENSIONID}/USER-${S.createdUserId}`];if(xe&&p.playerRole==="GM"&&!Tt(S)&&xe.role!=="GM"){const Ie=Hi().strokeColor(xe.color).fillOpacity(0).position({x:S.position.x,y:S.position.y}).width(de*2).height(de*2).shapeType("CIRCLE").metadata({[`${s.EXTENSIONID}/isIndicatorRing`]:!0}).locked(!0).build();se.push(Ie)}}}ce.simplify();for(let Q=0;Q<fe.length;Q++)fe[Q]===!0&&(J[Q].op(ce,Re.PathOp.INTERSECT),J[Q].simplify());ce.delete(),ae[3].pause(),ae[4].start();const be=[],ge=[];let ye=[],me=[];const K=Re.NewPath(),f={},E=p.sceneLocal.filter(Q=>Gn(Q)),k=p.sceneLocal.filter(Q=>Rr(Q));D&&K.rect(O[0],O[1],T[0],T[1]);let U=[],W,V=null;if(m)if(U=E.filter(Q=>At(Q)),W=new Re.SkOpBuilder,f.reuse=!0,U.length===0){const Q=gt().commands([]).fillRule("evenodd").locked(!0).visible(!1).fillColor("#000000").strokeColor("#000000").layer("FOG").name("Smoke!").metadata({[`${s.EXTENSIONID}/isVisionFog`]:!0,[`${s.EXTENSIONID}/digest`]:"reuse"}).build();Q.zIndex=3,me.push(Q),U=[Q]}else V=Re.FromCmds(U[0].commands),V.setFillType(Re.FillType.EVENODD);const le=new Re.SkOpBuilder;let De=!1;for(const Q of Object.keys(J)){const S=J[Q],j=new TextEncoder().encode(S.toCmds().toString()),ee=await crypto.subtle.digest("SHA-1",j).then(de=>[...new Uint8Array(de)].map(he=>he.toString(16).padStart(2,"0")).join(""));if(E.filter(de=>At(de)&&de.metadata[`${s.EXTENSIONID}/digest`]===ee).length===0?m?W.add(S,Re.PathOp.UNION):be.push({cmds:S.toCmds(),visible:!1,zIndex:3,playerId:R[Q].id,digest:ee}):f[ee]=!0,D){const de=p.sceneLocal.filter(he=>he.metadata[`${s.EXTENSIONID}/debug`]===!0).map(he=>he.id);de.length>0&&(ye=ye.concat(de)),await Vt.GreenDebugPath(S),K.op(S,Re.PathOp.DIFFERENCE),p.playerRole==="GM"&&(De=!0,le.add(S,Re.PathOp.UNION))}S.delete()}const Se=p.sceneMetadata[`${s.EXTENSIONID}/sceneId`];if(m){const Q=W.resolve();Q.setFillType(Re.FillType.EVENODD),V!==null&&Q.op(V,Re.PathOp.UNION);const S=Q.toCmds();U.length>0&&(U[0].commands=S,me=me.concat(U));try{localStorage.setItem(`${s.EXTENSIONID}/fogCache/${p.playerId}/${Se}`,JSON.stringify([{digest:"reuse",commands:S}]))}catch{console.log("Local storage is disabled")}V!==null&&V.delete(),Q.delete(),W.delete()}else if(m){const Q=E.filter(At);try{localStorage.setItem(`${s.EXTENSIONID}/fogCache/${p.playerId}/${Se}`,JSON.stringify(Q.map(S=>({digest:S.metadata[`${s.EXTENSIONID}/digest`],commands:S.commands}))))}catch{console.log("Local storage is disabled")}}let Xe;De&&(Xe=le.resolve()),le.delete();const Ve=E.filter(Zt),Be=E.filter(Q=>{const S=Q.metadata[`${s.EXTENSIONID}/digest`];return At(Q)&&f[S]===void 0});if(D){let Q=p.sceneMetadata[`${s.EXTENSIONID}/fowColor`]?p.sceneMetadata[`${s.EXTENSIONID}/fowColor`]:"#00000088",S=.5;Q.length==9&&(S=Number.parseInt(Q.substring(7),16)/255,Q=Q.substring(0,7));const B=gt().commands(K.toCmds()).locked(!0).fillRule("evenodd").visible(!0).fillColor(Q).fillOpacity(S).strokeWidth(0).strokeColor("#000000").layer("DRAWING").metadata({[`${s.EXTENSIONID}/isTrailingFog`]:!0}).name("Trailing Fog").build();B.disableHit=!0,Ve.length>0?ge.push(b.scene.local.updateItems(Zt,j=>{for(const ee of j)ee.commands=B.commands},!1)):me.push(B)}else ye=ye.concat(E.filter(Zt).map(Q=>Q.id));K.delete(),ae[4].pause(),ae[5].start();const Ce=p.sceneLocal.filter(Q=>Q.metadata[`${s.EXTENSIONID}/doorId`]!==void 0);M||p.playerRole=="GM"?await Jo():Ce.length>0&&(ye=ye.concat(Ce.map(Q=>Q.id)));for(const Q of Ce){const S=Q.metadata[`${s.EXTENSIONID}/doorId`],B=p.sceneItems.find(j=>j.id===S);if(B){const j=Q.commands.length==s.DOOROPEN.length,ee=!!B.metadata[`${s.EXTENSIONID}/doorOpen`];if(j===ee)continue;ge.push(b.scene.local.updateItems([Q.id],ue=>{const de=ue[0];Vo(de)&&(de.commands=Ui(ee))}))}}t.pause(),e.resume(),await Vt.DebugBlobINeverUse(),ye=ye.concat(k.map(Q=>Q.id)),be.map(Q=>{const S=gt().commands(Q.cmds).fillRule("evenodd").locked(!0).visible(Q.visible).fillColor("#000000").strokeColor("#000000").layer("FOG").name("Smoke!").metadata({[`${s.EXTENSIONID}/isVisionFog`]:!0,[`${s.EXTENSIONID}/digest`]:Q.digest}).build();S.zIndex=Q.zIndex,me.push(S)}),m||(ye=ye.concat(Be.map(Q=>Q.id))),se.length>0&&(me=me.concat(se)),!p.fogFilled&&p.sceneMetadata[`${s.EXTENSIONID}/autodetectEnabled`]===!0?await b.scene.fog.setFilled(!0):p.fogFilled&&p.sceneMetadata[`${s.EXTENSIONID}/autodetectEnabled`]!==!0&&await b.scene.fog.setFilled(!1),d&&d.zIndex!==0&&ge.push(b.scene.items.updateItems([d.id],Q=>{for(let S of Q)S.zIndex=0})),await Promise.all(ge),await b.scene.local.deleteItems(ye),await b.scene.local.addItems(me);let ve=0;ae[5].pause(),ae[6].start(),De&&(await pe(Xe,ge),Xe.delete()),ae[6].pause();const[Ne,Ke]=[e.stop(),t.stop()],st={compute_time:`${Ke} ms`,communication_time:`${Ne} ms`,cache_hits:y.toString(),cache_misses:C.toString(),item_counter:ve.toString()};for(let Q=1;Q<=6;Q++){const S=ae[Q].stop();st["stage"+Q]=`${S} ms`}gr(st),p.busy=!1,await b.player.setMetadata({[`${s.EXTENSIONID}/processed`]:!0}),await b.action.setBadgeText(void 0)}async function pe(ae,fe){const ce=[],be=p.sceneItems.filter(ge=>Xi(ge)&&Jt(ge));ae.simplify();for(const ge of be){const ye=new Re.SkOpBuilder,me=Re.NewPath(),K=p.gridDpi/ge.grid.dpi*(ge.image.width/2)*ge.scale.x;for(let k=0;k<6;k++){const U=k*60*Math.PI/180,W=ge.position.x+K*Math.cos(U),V=ge.position.y+K*Math.sin(U);k==0?me.moveTo(W,V):me.lineTo(W,V)}me.closePath(),await Vt.BlueTokenBoundingPath(me),ye.add(me,Re.PathOp.UNION),ye.add(ae,Re.PathOp.INTERSECT);const f=ye.resolve(),E=!f.toCmds().length;ge.visible==E&&ce.push(ge),await Vt.RedIntersectionPath(f),me.delete(),ye.delete(),f.delete()}fe.push(b.scene.items.updateItems(ce.map(ge=>ge.id),ge=>{for(let ye=0;ye<ge.length;ye++)ge[ye].visible=!ge[ye].visible}))}}function gr(n){for(const[e,t]of Object.entries(n)){const i=document.getElementById(e);e=="compute_time"||e=="communication_time"||e[0]=="s"?i&&(i.innerText=Number.parseFloat(t).toFixed(1)+"ms"):i&&(i.innerText=t)}}function Ot(n){if(n.ctrlKey)return n.pointerPosition;const e=Math.round(p.gridDpi/p.gridSnap),t=Math.round(n.pointerPosition.x/p.gridDpi)*p.gridDpi,i=Math.round(n.pointerPosition.y/p.gridDpi)*p.gridDpi,o=Math.abs(t-n.pointerPosition.x),a=Math.abs(i-n.pointerPosition.y);let r,d;return o<=e?r=t:r=n.pointerPosition.x,a<=e?d=i:d=n.pointerPosition.y,{x:r,y:d}}let tt=null;const mr="#000000",yr=8,vr=[];async function io(){await b.popover.close(s.LINETOOLID)}async function Bn(){if(!tt)return;const[n,e]=tt;e(),tt=null,await io()}async function Vn(){if(!tt)return;const[n,e]=tt,t=n(i=>{i.visible=!1,i.metadata[`${s.EXTENSIONID}/isVisionLine`]=!0,i.points.pop()});t.points.length>=2&&await b.scene.items.addItems([t]),e(),tt=null,await io()}async function oo(){if(!tt)return;const[n]=tt;n(e=>{e.points.length>2&&e.points.pop()})}async function Er(n,e){if(!e.transformer)if(tt){const[t]=tt;t(i=>{i.points.push(e.pointerPosition)})}else{const t=Ot(e),i=p.snap?t:e.pointerPosition,o=ct().tension(0).points([i,i]).strokeColor(p.sceneMetadata[`${s.EXTENSIONID}/toolColor`]??mr).strokeDash(p.sceneMetadata[`${s.EXTENSIONID}/toolStyle`]??vr).strokeWidth(p.sceneMetadata[`${s.EXTENSIONID}/toolWidth`]??yr).fillOpacity(0).fillColor("#000000").layer("DRAWING").name("Vision Line (Line)").closed(!1).locked(!0).build();tt=await b.interaction.startItemInteraction(o);const a=await b.viewport.getWidth();await b.popover.open({id:s.LINETOOLID,url:"/pages/line.html",height:75,width:350,disableClickAway:!0,hidePaper:!0,anchorPosition:{top:50,left:a/2},anchorReference:"POSITION",anchorOrigin:{vertical:"CENTER",horizontal:"CENTER"},transformOrigin:{vertical:"TOP",horizontal:"CENTER"}})}}function Ir(n,e){if(!tt||e.transformer)return;const[t]=tt,i=Ot(e);t(o=>{o.points[o.points.length-1]=p.snap?i:e.pointerPosition})}function wr(n,e){tt&&(e.key=="Escape"?Bn():e.key=="Enter"?Vn():e.key==="z"&&oo())}const _n={onToolClick:Er,onToolMove:Ir,onKeyDown:wr};let nt=null;const Sr="#000000",Tr=8,br=[];async function ao(){await b.popover.close(s.POLYTOOLID)}async function Hn(){if(!nt)return;const[n,e]=nt;e(),nt=null,ao(),await b.player.setMetadata({[`${s.EXTENSIONID}/cancelPoly`]:!1})}async function Un(){if(!nt)return;const[n,e]=nt,t=n(i=>{i.visible=!1,i.metadata[`${s.EXTENSIONID}/isVisionLine`]=!0,i.points.pop(),i.points.push(i.points[0])});t.points.length>=4&&await b.scene.items.addItems([t]),e(),nt=null,ao(),await b.player.setMetadata({[`${s.EXTENSIONID}/finishPoly`]:!1})}async function ro(){if(!nt)return;const[n]=nt;n(e=>{e.points.length>2&&e.points.pop()})}async function Nr(n,e){if(!e.transformer)if(nt){const[t]=nt;t(i=>{i.points.push(e.pointerPosition)})}else{const t=Ot(e),i=p.snap?t:e.pointerPosition,o=ct().tension(0).points([i,i]).strokeColor(p.sceneMetadata[`${s.EXTENSIONID}/toolColor`]??Sr).strokeDash(p.sceneMetadata[`${s.EXTENSIONID}/toolStyle`]??br).strokeWidth(p.sceneMetadata[`${s.EXTENSIONID}/toolWidth`]??Tr).fillOpacity(.5).fillColor("#000000").layer("DRAWING").name("Vision Line (Polygon)").locked(!0).build();nt=await b.interaction.startItemInteraction(o);const a=await b.viewport.getWidth();await b.popover.open({id:s.POLYTOOLID,url:"/pages/polygon.html",height:75,width:400,disableClickAway:!0,hidePaper:!0,anchorPosition:{top:50,left:a/2},anchorReference:"POSITION",anchorOrigin:{vertical:"CENTER",horizontal:"CENTER"},transformOrigin:{vertical:"TOP",horizontal:"CENTER"}})}}function Or(n,e){if(!nt||e.transformer)return;const[t]=nt,i=Ot(e);t(o=>{o.points[o.points.length-1]=p.snap?i:e.pointerPosition})}function kr(n,e){nt&&(e.key=="Escape"?Hn():e.key=="Enter"?Un():e.key==="z"&&ro())}const An={onToolClick:Nr,onToolMove:Or,onKeyDown:kr};let it=null;const so=8,lo=[];async function co(){await b.popover.close(s.ELEVATIONTOOLID)}async function Jn(){if(!it)return;const[n,e]=it;e(),it=null,co()}async function uo(){if(!it)return;const[n,e]=it,t=n(i=>{i.visible=!1,i.points.pop(),i.points.push(i.points[0])});if(t.points.length>=4){await b.scene.local.addItems([t]);let i=p.sceneMetadata[`${s.EXTENSIONID}/elevationMapping`];i||(i=[]);const o=t.metadata[`${s.EXTENSIONID}/elevation`]??0,a={Points:t.points,Depth:o};i.push(a),await b.scene.setMetadata({[`${s.EXTENSIONID}/elevationMapping`]:i})}e(),it=null,co()}async function fo(){if(!it)return;const[n]=it;n(e=>{e.points.length>2&&e.points.pop()})}async function Dr(n,e,t){if(!e.transformer)if(it){const[i]=it;i(o=>{o.points.push(e.pointerPosition)})}else{const i=Ot(e),o=p.snap?i:e.pointerPosition,a=ct().tension(0).points([o,o]).strokeColor(ho(t)).strokeDash(p.sceneMetadata[`${s.EXTENSIONID}/toolStyle`]??lo).strokeWidth(p.sceneMetadata[`${s.EXTENSIONID}/toolWidth`]??so).fillOpacity(.5).fillColor(po(t)).layer("DRAWING").metadata({[`${s.EXTENSIONID}/elevation`]:t}).name(`Elevation-${t} Area`).zIndex(t).locked(!0).build();it=await b.interaction.startItemInteraction(a);const r=await b.viewport.getWidth();await b.popover.open({id:s.ELEVATIONTOOLID,url:"/pages/elevation.html",height:110,width:360,disableClickAway:!0,anchorPosition:{top:60,left:r/2},anchorReference:"POSITION",anchorOrigin:{vertical:"CENTER",horizontal:"CENTER"},transformOrigin:{vertical:"TOP",horizontal:"CENTER"}})}}function Cr(n,e){if(!it||e.transformer)return;const[t]=it,i=Ot(e);t(o=>{o.points[o.points.length-1]=p.snap?i:e.pointerPosition})}function xr(n,e,t){it&&(e.key=="Escape"?Jn():e.key=="Enter"?uo():e.key==="z"&&fo())}async function _r(n){const e=n.metadata[`${s.EXTENSIONID}/elevationEditor`]??!1;await b.tool.setMetadata(`${s.EXTENSIONID}/vision-tool`,{[`${s.EXTENSIONID}/elevationEditor`]:!e}),e?await Mr():await Ar()}async function Ar(n){const t=(await b.scene.getMetadata())[`${s.EXTENSIONID}/elevationMapping`]??[];if(t&&t.length>0){const i=[];for(const o of t){const a=ct().tension(0).points(o.Points).strokeColor(ho(o.Depth)).strokeDash(p.sceneMetadata[`${s.EXTENSIONID}/toolStyle`]??lo).strokeWidth(p.sceneMetadata[`${s.EXTENSIONID}/toolWidth`]??so).fillOpacity(.5).fillColor(po(o.Depth)).layer("DRAWING").name("Elevation-1 Area").locked(!0).visible(!1).metadata({[`${s.EXTENSIONID}/elevation`]:o.Depth}).zIndex(o.Depth).build();i.push(a)}await b.scene.local.addItems(i)}}async function Mr(n){const e=p.sceneLocal.filter(t=>t.metadata[`${s.EXTENSIONID}/elevation`]!==void 0);if(e.length>0){const t=[];for(const i of e){let o=i.points;(i.position.x!==0||i.position.y!==0)&&(o=i.points.map(r=>{const d=r.x+i.position.x,h=r.y+i.position.y;return{x:d,y:h}}));const a={Points:o,Depth:i.metadata[`${s.EXTENSIONID}/elevation`]??0};t.push(a)}await b.scene.setMetadata({[`${s.EXTENSIONID}/elevationMapping`]:t}),await b.scene.local.deleteItems(e.map(i=>i.id))}else await b.scene.setMetadata({[`${s.EXTENSIONID}/elevationMapping`]:[]})}function ho(n){switch(n){case 1:return"#6454ac";case 2:return"#029658";case 3:return"#fcd444";case 4:return"#fc6404";case 5:return"#ff0000";default:return"#000000"}}function po(n){switch(n){case 1:return"#6454ac4F";case 2:return"#0296584F";case 3:return"#fcd4444F";case 4:return"#fc64044F";case 5:return"#ff00004F";default:return"#0000004F"}}const je={onToolClick:Dr,onToolMove:Cr,onKeyDown:xr,enterEditMode:_r,cancelDrawing:Jn};function jt(n){throw new Error('Could not dynamically require "'+n+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var go={exports:{}};(function(n,e){(function(t){n.exports=t()})(function(){return function t(i,o,a){function r(m,N){if(!o[m]){if(!i[m]){var D=typeof jt=="function"&&jt;if(!N&&D)return D(m,!0);if(d)return d(m,!0);throw new Error("Cannot find module '"+m+"'")}N=o[m]={exports:{}},i[m][0].call(N.exports,function(A){var M=i[m][1][A];return r(M||A)},N,N.exports,t,i,o,a)}return o[m].exports}for(var d=typeof jt=="function"&&jt,h=0;h<a.length;h++)r(a[h]);return r}({1:[function(t,i,o){(function(a,r,d,h,m,N,D,A,M){var T=t("crypto");function P(x,w){w=$(x,w);var g;return(g=w.algorithm!=="passthrough"?T.createHash(w.algorithm):new ie).write===void 0&&(g.write=g.update,g.end=g.update),R(w,g).dispatch(x),g.update||g.end(""),g.digest?g.digest(w.encoding==="buffer"?void 0:w.encoding):(x=g.read(),w.encoding!=="buffer"?x.toString(w.encoding):x)}(o=i.exports=P).sha1=function(x){return P(x)},o.keys=function(x){return P(x,{excludeValues:!0,algorithm:"sha1",encoding:"hex"})},o.MD5=function(x){return P(x,{algorithm:"md5",encoding:"hex"})},o.keysMD5=function(x){return P(x,{algorithm:"md5",encoding:"hex",excludeValues:!0})};var O=T.getHashes?T.getHashes().slice():["sha1","md5"],L=(O.push("passthrough"),["buffer","hex","binary","base64"]);function $(x,w){var g={};if(g.algorithm=(w=w||{}).algorithm||"sha1",g.encoding=w.encoding||"hex",g.excludeValues=!!w.excludeValues,g.algorithm=g.algorithm.toLowerCase(),g.encoding=g.encoding.toLowerCase(),g.ignoreUnknown=w.ignoreUnknown===!0,g.respectType=w.respectType!==!1,g.respectFunctionNames=w.respectFunctionNames!==!1,g.respectFunctionProperties=w.respectFunctionProperties!==!1,g.unorderedArrays=w.unorderedArrays===!0,g.unorderedSets=w.unorderedSets!==!1,g.unorderedObjects=w.unorderedObjects!==!1,g.replacer=w.replacer||void 0,g.excludeKeys=w.excludeKeys||void 0,x===void 0)throw new Error("Object argument required.");for(var I=0;I<O.length;++I)O[I].toLowerCase()===g.algorithm.toLowerCase()&&(g.algorithm=O[I]);if(O.indexOf(g.algorithm)===-1)throw new Error('Algorithm "'+g.algorithm+'"  not supported. supported values: '+O.join(", "));if(L.indexOf(g.encoding)===-1&&g.algorithm!=="passthrough")throw new Error('Encoding "'+g.encoding+'"  not supported. supported values: '+L.join(", "));return g}function H(x){if(typeof x=="function")return/^function\s+\w*\s*\(\s*\)\s*{\s+\[native code\]\s+}$/i.exec(Function.prototype.toString.call(x))!=null}function R(x,w,g){g=g||[];function I(y){return w.update?w.update(y,"utf8"):w.write(y,"utf8")}return{dispatch:function(y){return this["_"+((y=x.replacer?x.replacer(y):y)===null?"null":typeof y)](y)},_object:function(y){var C,X=Object.prototype.toString.call(y),q=/\[object (.*)\]/i.exec(X);if(q=(q=q?q[1]:"unknown:["+X+"]").toLowerCase(),0<=(X=g.indexOf(y)))return this.dispatch("[CIRCULAR:"+X+"]");if(g.push(y),d!==void 0&&d.isBuffer&&d.isBuffer(y))return I("buffer:"),I(y);if(q==="object"||q==="function"||q==="asyncfunction")return X=Object.keys(y),x.unorderedObjects&&(X=X.sort()),x.respectType===!1||H(y)||X.splice(0,0,"prototype","__proto__","constructor"),x.excludeKeys&&(X=X.filter(function(oe){return!x.excludeKeys(oe)})),I("object:"+X.length+":"),C=this,X.forEach(function(oe){C.dispatch(oe),I(":"),x.excludeValues||C.dispatch(y[oe]),I(",")});if(!this["_"+q]){if(x.ignoreUnknown)return I("["+q+"]");throw new Error('Unknown object type "'+q+'"')}this["_"+q](y)},_array:function(y,oe){oe=oe!==void 0?oe:x.unorderedArrays!==!1;var X=this;if(I("array:"+y.length+":"),!oe||y.length<=1)return y.forEach(function(se){return X.dispatch(se)});var q=[],oe=y.map(function(se){var J=new ie,Ee=g.slice();return R(x,J,Ee).dispatch(se),q=q.concat(Ee.slice(g.length)),J.read().toString()});return g=g.concat(q),oe.sort(),this._array(oe,!1)},_date:function(y){return I("date:"+y.toJSON())},_symbol:function(y){return I("symbol:"+y.toString())},_error:function(y){return I("error:"+y.toString())},_boolean:function(y){return I("bool:"+y.toString())},_string:function(y){I("string:"+y.length+":"),I(y.toString())},_function:function(y){I("fn:"),H(y)?this.dispatch("[native]"):this.dispatch(y.toString()),x.respectFunctionNames!==!1&&this.dispatch("function-name:"+String(y.name)),x.respectFunctionProperties&&this._object(y)},_number:function(y){return I("number:"+y.toString())},_xml:function(y){return I("xml:"+y.toString())},_null:function(){return I("Null")},_undefined:function(){return I("Undefined")},_regexp:function(y){return I("regex:"+y.toString())},_uint8array:function(y){return I("uint8array:"),this.dispatch(Array.prototype.slice.call(y))},_uint8clampedarray:function(y){return I("uint8clampedarray:"),this.dispatch(Array.prototype.slice.call(y))},_int8array:function(y){return I("int8array:"),this.dispatch(Array.prototype.slice.call(y))},_uint16array:function(y){return I("uint16array:"),this.dispatch(Array.prototype.slice.call(y))},_int16array:function(y){return I("int16array:"),this.dispatch(Array.prototype.slice.call(y))},_uint32array:function(y){return I("uint32array:"),this.dispatch(Array.prototype.slice.call(y))},_int32array:function(y){return I("int32array:"),this.dispatch(Array.prototype.slice.call(y))},_float32array:function(y){return I("float32array:"),this.dispatch(Array.prototype.slice.call(y))},_float64array:function(y){return I("float64array:"),this.dispatch(Array.prototype.slice.call(y))},_arraybuffer:function(y){return I("arraybuffer:"),this.dispatch(new Uint8Array(y))},_url:function(y){return I("url:"+y.toString())},_map:function(y){return I("map:"),y=Array.from(y),this._array(y,x.unorderedSets!==!1)},_set:function(y){return I("set:"),y=Array.from(y),this._array(y,x.unorderedSets!==!1)},_file:function(y){return I("file:"),this.dispatch([y.name,y.size,y.type,y.lastModfied])},_blob:function(){if(x.ignoreUnknown)return I("[blob]");throw Error(`Hashing Blob objects is currently not supported
(see https://github.com/puleos/object-hash/issues/26)
Use "options.replacer" or "options.ignoreUnknown"
`)},_domwindow:function(){return I("domwindow")},_bigint:function(y){return I("bigint:"+y.toString())},_process:function(){return I("process")},_timer:function(){return I("timer")},_pipe:function(){return I("pipe")},_tcp:function(){return I("tcp")},_udp:function(){return I("udp")},_tty:function(){return I("tty")},_statwatcher:function(){return I("statwatcher")},_securecontext:function(){return I("securecontext")},_connection:function(){return I("connection")},_zlib:function(){return I("zlib")},_context:function(){return I("context")},_nodescript:function(){return I("nodescript")},_httpparser:function(){return I("httpparser")},_dataview:function(){return I("dataview")},_signal:function(){return I("signal")},_fsevent:function(){return I("fsevent")},_tlswrap:function(){return I("tlswrap")}}}function ie(){return{buf:"",write:function(x){this.buf+=x},end:function(x){this.buf+=x},read:function(){return this.buf}}}o.writeToStream=function(x,w,g){return g===void 0&&(g=w,w={}),R(w=$(x,w),g).dispatch(x)}}).call(this,t("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},t("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/fake_9a5aa49d.js","/")},{buffer:3,crypto:5,lYpoI2:11}],2:[function(t,i,o){(function(a,r,d,h,m,N,D,A,M){(function(T){var P=typeof Uint8Array<"u"?Uint8Array:Array,O="+".charCodeAt(0),L="/".charCodeAt(0),$="0".charCodeAt(0),H="a".charCodeAt(0),R="A".charCodeAt(0),ie="-".charCodeAt(0),x="_".charCodeAt(0);function w(g){return g=g.charCodeAt(0),g===O||g===ie?62:g===L||g===x?63:g<$?-1:g<$+10?g-$+26+26:g<R+26?g-R:g<H+26?g-H+26:void 0}T.toByteArray=function(g){var I,y;if(0<g.length%4)throw new Error("Invalid string. Length must be a multiple of 4");var C=g.length,C=g.charAt(C-2)==="="?2:g.charAt(C-1)==="="?1:0,X=new P(3*g.length/4-C),q=0<C?g.length-4:g.length,oe=0;function se(J){X[oe++]=J}for(I=0;I<q;I+=4,0)se((16711680&(y=w(g.charAt(I))<<18|w(g.charAt(I+1))<<12|w(g.charAt(I+2))<<6|w(g.charAt(I+3))))>>16),se((65280&y)>>8),se(255&y);return C==2?se(255&(y=w(g.charAt(I))<<2|w(g.charAt(I+1))>>4)):C==1&&(se((y=w(g.charAt(I))<<10|w(g.charAt(I+1))<<4|w(g.charAt(I+2))>>2)>>8&255),se(255&y)),X},T.fromByteArray=function(g){var I,y,C,X,q=g.length%3,oe="";function se(J){return"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(J)}for(I=0,C=g.length-q;I<C;I+=3)y=(g[I]<<16)+(g[I+1]<<8)+g[I+2],oe+=se((X=y)>>18&63)+se(X>>12&63)+se(X>>6&63)+se(63&X);switch(q){case 1:oe=(oe+=se((y=g[g.length-1])>>2))+se(y<<4&63)+"==";break;case 2:oe=(oe=(oe+=se((y=(g[g.length-2]<<8)+g[g.length-1])>>10))+se(y>>4&63))+se(y<<2&63)+"="}return oe}})(o===void 0?this.base64js={}:o)}).call(this,t("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},t("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/base64-js/lib/b64.js","/node_modules/gulp-browserify/node_modules/base64-js/lib")},{buffer:3,lYpoI2:11}],3:[function(t,i,o){(function(a,r,O,h,m,N,D,A,M){var T=t("base64-js"),P=t("ieee754");function O(f,E,k){if(!(this instanceof O))return new O(f,E,k);var U,W,V,le,De=typeof f;if(E==="base64"&&De=="string")for(f=(le=f).trim?le.trim():le.replace(/^\s+|\s+$/g,"");f.length%4!=0;)f+="=";if(De=="number")U=ke(f);else if(De=="string")U=O.byteLength(f,E);else{if(De!="object")throw new Error("First argument needs to be a number, array or string.");U=ke(f.length)}if(O._useTypedArrays?W=O._augment(new Uint8Array(U)):((W=this).length=U,W._isBuffer=!0),O._useTypedArrays&&typeof f.byteLength=="number")W._set(f);else if(we(le=f)||O.isBuffer(le)||le&&typeof le=="object"&&typeof le.length=="number")for(V=0;V<U;V++)O.isBuffer(f)?W[V]=f.readUInt8(V):W[V]=f[V];else if(De=="string")W.write(f,0,E);else if(De=="number"&&!O._useTypedArrays&&!k)for(V=0;V<U;V++)W[V]=0;return W}function L(f,E,k,U){return O._charsWritten=ce(function(W){for(var V=[],le=0;le<W.length;le++)V.push(255&W.charCodeAt(le));return V}(E),f,k,U)}function $(f,E,k,U){return O._charsWritten=ce(function(W){for(var V,le,De=[],Se=0;Se<W.length;Se++)le=W.charCodeAt(Se),V=le>>8,le=le%256,De.push(le),De.push(V);return De}(E),f,k,U)}function H(f,E,k){var U="";k=Math.min(f.length,k);for(var W=E;W<k;W++)U+=String.fromCharCode(f[W]);return U}function R(f,E,k,V){V||(K(typeof k=="boolean","missing or invalid endian"),K(E!=null,"missing offset"),K(E+1<f.length,"Trying to read beyond buffer length"));var W,V=f.length;if(!(V<=E))return k?(W=f[E],E+1<V&&(W|=f[E+1]<<8)):(W=f[E]<<8,E+1<V&&(W|=f[E+1])),W}function ie(f,E,k,V){V||(K(typeof k=="boolean","missing or invalid endian"),K(E!=null,"missing offset"),K(E+3<f.length,"Trying to read beyond buffer length"));var W,V=f.length;if(!(V<=E))return k?(E+2<V&&(W=f[E+2]<<16),E+1<V&&(W|=f[E+1]<<8),W|=f[E],E+3<V&&(W+=f[E+3]<<24>>>0)):(E+1<V&&(W=f[E+1]<<16),E+2<V&&(W|=f[E+2]<<8),E+3<V&&(W|=f[E+3]),W+=f[E]<<24>>>0),W}function x(f,E,k,U){if(U||(K(typeof k=="boolean","missing or invalid endian"),K(E!=null,"missing offset"),K(E+1<f.length,"Trying to read beyond buffer length")),!(f.length<=E))return U=R(f,E,k,!0),32768&U?-1*(65535-U+1):U}function w(f,E,k,U){if(U||(K(typeof k=="boolean","missing or invalid endian"),K(E!=null,"missing offset"),K(E+3<f.length,"Trying to read beyond buffer length")),!(f.length<=E))return U=ie(f,E,k,!0),2147483648&U?-1*(4294967295-U+1):U}function g(f,E,k,U){return U||(K(typeof k=="boolean","missing or invalid endian"),K(E+3<f.length,"Trying to read beyond buffer length")),P.read(f,E,k,23,4)}function I(f,E,k,U){return U||(K(typeof k=="boolean","missing or invalid endian"),K(E+7<f.length,"Trying to read beyond buffer length")),P.read(f,E,k,52,8)}function y(f,E,k,U,W){if(W||(K(E!=null,"missing value"),K(typeof U=="boolean","missing or invalid endian"),K(k!=null,"missing offset"),K(k+1<f.length,"trying to write beyond buffer length"),ge(E,65535)),W=f.length,!(W<=k))for(var V=0,le=Math.min(W-k,2);V<le;V++)f[k+V]=(E&255<<8*(U?V:1-V))>>>8*(U?V:1-V)}function C(f,E,k,U,W){if(W||(K(E!=null,"missing value"),K(typeof U=="boolean","missing or invalid endian"),K(k!=null,"missing offset"),K(k+3<f.length,"trying to write beyond buffer length"),ge(E,4294967295)),W=f.length,!(W<=k))for(var V=0,le=Math.min(W-k,4);V<le;V++)f[k+V]=E>>>8*(U?V:3-V)&255}function X(f,E,k,U,W){W||(K(E!=null,"missing value"),K(typeof U=="boolean","missing or invalid endian"),K(k!=null,"missing offset"),K(k+1<f.length,"Trying to write beyond buffer length"),ye(E,32767,-32768)),f.length<=k||y(f,0<=E?E:65535+E+1,k,U,W)}function q(f,E,k,U,W){W||(K(E!=null,"missing value"),K(typeof U=="boolean","missing or invalid endian"),K(k!=null,"missing offset"),K(k+3<f.length,"Trying to write beyond buffer length"),ye(E,2147483647,-2147483648)),f.length<=k||C(f,0<=E?E:4294967295+E+1,k,U,W)}function oe(f,E,k,U,W){W||(K(E!=null,"missing value"),K(typeof U=="boolean","missing or invalid endian"),K(k!=null,"missing offset"),K(k+3<f.length,"Trying to write beyond buffer length"),me(E,34028234663852886e22,-34028234663852886e22)),f.length<=k||P.write(f,E,k,U,23,4)}function se(f,E,k,U,W){W||(K(E!=null,"missing value"),K(typeof U=="boolean","missing or invalid endian"),K(k!=null,"missing offset"),K(k+7<f.length,"Trying to write beyond buffer length"),me(E,17976931348623157e292,-17976931348623157e292)),f.length<=k||P.write(f,E,k,U,52,8)}o.Buffer=O,o.SlowBuffer=O,o.INSPECT_MAX_BYTES=50,O.poolSize=8192,O._useTypedArrays=function(){try{var f=new ArrayBuffer(0),E=new Uint8Array(f);return E.foo=function(){return 42},E.foo()===42&&typeof E.subarray=="function"}catch{return!1}}(),O.isEncoding=function(f){switch(String(f).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"binary":case"base64":case"raw":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},O.isBuffer=function(f){return!(f==null||!f._isBuffer)},O.byteLength=function(f,E){var k;switch(f+="",E||"utf8"){case"hex":k=f.length/2;break;case"utf8":case"utf-8":k=ae(f).length;break;case"ascii":case"binary":case"raw":k=f.length;break;case"base64":k=fe(f).length;break;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":k=2*f.length;break;default:throw new Error("Unknown encoding")}return k},O.concat=function(f,E){if(K(we(f),`Usage: Buffer.concat(list, [totalLength])
list should be an Array.`),f.length===0)return new O(0);if(f.length===1)return f[0];if(typeof E!="number")for(W=E=0;W<f.length;W++)E+=f[W].length;for(var k=new O(E),U=0,W=0;W<f.length;W++){var V=f[W];V.copy(k,U),U+=V.length}return k},O.prototype.write=function(f,E,k,U){isFinite(E)?isFinite(k)||(U=k,k=void 0):(Se=U,U=E,E=k,k=Se),E=Number(E)||0;var W,V,le,De,Se=this.length-E;switch((!k||Se<(k=Number(k)))&&(k=Se),U=String(U||"utf8").toLowerCase()){case"hex":W=function(Xe,Ve,Be,Ce){Be=Number(Be)||0;var ve=Xe.length-Be;(!Ce||ve<(Ce=Number(Ce)))&&(Ce=ve),K((ve=Ve.length)%2==0,"Invalid hex string"),ve/2<Ce&&(Ce=ve/2);for(var Ne=0;Ne<Ce;Ne++){var Ke=parseInt(Ve.substr(2*Ne,2),16);K(!isNaN(Ke),"Invalid hex string"),Xe[Be+Ne]=Ke}return O._charsWritten=2*Ne,Ne}(this,f,E,k);break;case"utf8":case"utf-8":V=this,le=E,De=k,W=O._charsWritten=ce(ae(f),V,le,De);break;case"ascii":case"binary":W=L(this,f,E,k);break;case"base64":V=this,le=E,De=k,W=O._charsWritten=ce(fe(f),V,le,De);break;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":W=$(this,f,E,k);break;default:throw new Error("Unknown encoding")}return W},O.prototype.toString=function(f,E,k){var U,W,V,le,De=this;if(f=String(f||"utf8").toLowerCase(),E=Number(E)||0,(k=k!==void 0?Number(k):De.length)===E)return"";switch(f){case"hex":U=function(Se,Xe,Ve){var Be=Se.length;(!Xe||Xe<0)&&(Xe=0),(!Ve||Ve<0||Be<Ve)&&(Ve=Be);for(var Ce="",ve=Xe;ve<Ve;ve++)Ce+=pe(Se[ve]);return Ce}(De,E,k);break;case"utf8":case"utf-8":U=function(Se,Xe,Ve){var Be="",Ce="";Ve=Math.min(Se.length,Ve);for(var ve=Xe;ve<Ve;ve++)Se[ve]<=127?(Be+=be(Ce)+String.fromCharCode(Se[ve]),Ce=""):Ce+="%"+Se[ve].toString(16);return Be+be(Ce)}(De,E,k);break;case"ascii":case"binary":U=H(De,E,k);break;case"base64":W=De,le=k,U=(V=E)===0&&le===W.length?T.fromByteArray(W):T.fromByteArray(W.slice(V,le));break;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":U=function(Se,Xe,Ve){for(var Be=Se.slice(Xe,Ve),Ce="",ve=0;ve<Be.length;ve+=2)Ce+=String.fromCharCode(Be[ve]+256*Be[ve+1]);return Ce}(De,E,k);break;default:throw new Error("Unknown encoding")}return U},O.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}},O.prototype.copy=function(f,E,k,U){if(E=E||0,(U=U||U===0?U:this.length)!==(k=k||0)&&f.length!==0&&this.length!==0){K(k<=U,"sourceEnd < sourceStart"),K(0<=E&&E<f.length,"targetStart out of bounds"),K(0<=k&&k<this.length,"sourceStart out of bounds"),K(0<=U&&U<=this.length,"sourceEnd out of bounds"),U>this.length&&(U=this.length);var W=(U=f.length-E<U-k?f.length-E+k:U)-k;if(W<100||!O._useTypedArrays)for(var V=0;V<W;V++)f[V+E]=this[V+k];else f._set(this.subarray(k,k+W),E)}},O.prototype.slice=function(f,E){var k=this.length;if(f=Ee(f,k,0),E=Ee(E,k,k),O._useTypedArrays)return O._augment(this.subarray(f,E));for(var U=E-f,W=new O(U,void 0,!0),V=0;V<U;V++)W[V]=this[V+f];return W},O.prototype.get=function(f){return console.log(".get() is deprecated. Access using array indexes instead."),this.readUInt8(f)},O.prototype.set=function(f,E){return console.log(".set() is deprecated. Access using array indexes instead."),this.writeUInt8(f,E)},O.prototype.readUInt8=function(f,E){if(E||(K(f!=null,"missing offset"),K(f<this.length,"Trying to read beyond buffer length")),!(f>=this.length))return this[f]},O.prototype.readUInt16LE=function(f,E){return R(this,f,!0,E)},O.prototype.readUInt16BE=function(f,E){return R(this,f,!1,E)},O.prototype.readUInt32LE=function(f,E){return ie(this,f,!0,E)},O.prototype.readUInt32BE=function(f,E){return ie(this,f,!1,E)},O.prototype.readInt8=function(f,E){if(E||(K(f!=null,"missing offset"),K(f<this.length,"Trying to read beyond buffer length")),!(f>=this.length))return 128&this[f]?-1*(255-this[f]+1):this[f]},O.prototype.readInt16LE=function(f,E){return x(this,f,!0,E)},O.prototype.readInt16BE=function(f,E){return x(this,f,!1,E)},O.prototype.readInt32LE=function(f,E){return w(this,f,!0,E)},O.prototype.readInt32BE=function(f,E){return w(this,f,!1,E)},O.prototype.readFloatLE=function(f,E){return g(this,f,!0,E)},O.prototype.readFloatBE=function(f,E){return g(this,f,!1,E)},O.prototype.readDoubleLE=function(f,E){return I(this,f,!0,E)},O.prototype.readDoubleBE=function(f,E){return I(this,f,!1,E)},O.prototype.writeUInt8=function(f,E,k){k||(K(f!=null,"missing value"),K(E!=null,"missing offset"),K(E<this.length,"trying to write beyond buffer length"),ge(f,255)),E>=this.length||(this[E]=f)},O.prototype.writeUInt16LE=function(f,E,k){y(this,f,E,!0,k)},O.prototype.writeUInt16BE=function(f,E,k){y(this,f,E,!1,k)},O.prototype.writeUInt32LE=function(f,E,k){C(this,f,E,!0,k)},O.prototype.writeUInt32BE=function(f,E,k){C(this,f,E,!1,k)},O.prototype.writeInt8=function(f,E,k){k||(K(f!=null,"missing value"),K(E!=null,"missing offset"),K(E<this.length,"Trying to write beyond buffer length"),ye(f,127,-128)),E>=this.length||(0<=f?this.writeUInt8(f,E,k):this.writeUInt8(255+f+1,E,k))},O.prototype.writeInt16LE=function(f,E,k){X(this,f,E,!0,k)},O.prototype.writeInt16BE=function(f,E,k){X(this,f,E,!1,k)},O.prototype.writeInt32LE=function(f,E,k){q(this,f,E,!0,k)},O.prototype.writeInt32BE=function(f,E,k){q(this,f,E,!1,k)},O.prototype.writeFloatLE=function(f,E,k){oe(this,f,E,!0,k)},O.prototype.writeFloatBE=function(f,E,k){oe(this,f,E,!1,k)},O.prototype.writeDoubleLE=function(f,E,k){se(this,f,E,!0,k)},O.prototype.writeDoubleBE=function(f,E,k){se(this,f,E,!1,k)},O.prototype.fill=function(f,E,k){if(E=E||0,k=k||this.length,K(typeof(f=typeof(f=f||0)=="string"?f.charCodeAt(0):f)=="number"&&!isNaN(f),"value is not a number"),K(E<=k,"end < start"),k!==E&&this.length!==0){K(0<=E&&E<this.length,"start out of bounds"),K(0<=k&&k<=this.length,"end out of bounds");for(var U=E;U<k;U++)this[U]=f}},O.prototype.inspect=function(){for(var f=[],E=this.length,k=0;k<E;k++)if(f[k]=pe(this[k]),k===o.INSPECT_MAX_BYTES){f[k+1]="...";break}return"<Buffer "+f.join(" ")+">"},O.prototype.toArrayBuffer=function(){if(typeof Uint8Array>"u")throw new Error("Buffer.toArrayBuffer not supported in this browser");if(O._useTypedArrays)return new O(this).buffer;for(var f=new Uint8Array(this.length),E=0,k=f.length;E<k;E+=1)f[E]=this[E];return f.buffer};var J=O.prototype;function Ee(f,E,k){return typeof f!="number"?k:E<=(f=~~f)?E:0<=f||0<=(f+=E)?f:0}function ke(f){return(f=~~Math.ceil(+f))<0?0:f}function we(f){return(Array.isArray||function(E){return Object.prototype.toString.call(E)==="[object Array]"})(f)}function pe(f){return f<16?"0"+f.toString(16):f.toString(16)}function ae(f){for(var E=[],k=0;k<f.length;k++){var U=f.charCodeAt(k);if(U<=127)E.push(f.charCodeAt(k));else for(var W=k,V=(55296<=U&&U<=57343&&k++,encodeURIComponent(f.slice(W,k+1)).substr(1).split("%")),le=0;le<V.length;le++)E.push(parseInt(V[le],16))}return E}function fe(f){return T.toByteArray(f)}function ce(f,E,k,U){for(var W=0;W<U&&!(W+k>=E.length||W>=f.length);W++)E[W+k]=f[W];return W}function be(f){try{return decodeURIComponent(f)}catch{return String.fromCharCode(65533)}}function ge(f,E){K(typeof f=="number","cannot write a non-number as a number"),K(0<=f,"specified a negative value for writing an unsigned value"),K(f<=E,"value is larger than maximum value for type"),K(Math.floor(f)===f,"value has a fractional component")}function ye(f,E,k){K(typeof f=="number","cannot write a non-number as a number"),K(f<=E,"value larger than maximum allowed value"),K(k<=f,"value smaller than minimum allowed value"),K(Math.floor(f)===f,"value has a fractional component")}function me(f,E,k){K(typeof f=="number","cannot write a non-number as a number"),K(f<=E,"value larger than maximum allowed value"),K(k<=f,"value smaller than minimum allowed value")}function K(f,E){if(!f)throw new Error(E||"Failed assertion")}O._augment=function(f){return f._isBuffer=!0,f._get=f.get,f._set=f.set,f.get=J.get,f.set=J.set,f.write=J.write,f.toString=J.toString,f.toLocaleString=J.toString,f.toJSON=J.toJSON,f.copy=J.copy,f.slice=J.slice,f.readUInt8=J.readUInt8,f.readUInt16LE=J.readUInt16LE,f.readUInt16BE=J.readUInt16BE,f.readUInt32LE=J.readUInt32LE,f.readUInt32BE=J.readUInt32BE,f.readInt8=J.readInt8,f.readInt16LE=J.readInt16LE,f.readInt16BE=J.readInt16BE,f.readInt32LE=J.readInt32LE,f.readInt32BE=J.readInt32BE,f.readFloatLE=J.readFloatLE,f.readFloatBE=J.readFloatBE,f.readDoubleLE=J.readDoubleLE,f.readDoubleBE=J.readDoubleBE,f.writeUInt8=J.writeUInt8,f.writeUInt16LE=J.writeUInt16LE,f.writeUInt16BE=J.writeUInt16BE,f.writeUInt32LE=J.writeUInt32LE,f.writeUInt32BE=J.writeUInt32BE,f.writeInt8=J.writeInt8,f.writeInt16LE=J.writeInt16LE,f.writeInt16BE=J.writeInt16BE,f.writeInt32LE=J.writeInt32LE,f.writeInt32BE=J.writeInt32BE,f.writeFloatLE=J.writeFloatLE,f.writeFloatBE=J.writeFloatBE,f.writeDoubleLE=J.writeDoubleLE,f.writeDoubleBE=J.writeDoubleBE,f.fill=J.fill,f.inspect=J.inspect,f.toArrayBuffer=J.toArrayBuffer,f}}).call(this,t("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},t("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/buffer/index.js","/node_modules/gulp-browserify/node_modules/buffer")},{"base64-js":2,buffer:3,ieee754:10,lYpoI2:11}],4:[function(t,i,o){(function(a,r,T,h,m,N,D,A,M){var T=t("buffer").Buffer,P=4,O=new T(P);O.fill(0),i.exports={hash:function(L,$,H,R){for(var ie=$(function(y,C){y.length%P!=0&&(X=y.length+(P-y.length%P),y=T.concat([y,O],X));for(var X,q=[],oe=C?y.readInt32BE:y.readInt32LE,se=0;se<y.length;se+=P)q.push(oe.call(y,se));return q}(L=T.isBuffer(L)?L:new T(L),R),8*L.length),$=R,x=new T(H),w=$?x.writeInt32BE:x.writeInt32LE,g=0;g<ie.length;g++)w.call(x,ie[g],4*g,!0);return x}}}).call(this,t("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},t("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/crypto-browserify/helpers.js","/node_modules/gulp-browserify/node_modules/crypto-browserify")},{buffer:3,lYpoI2:11}],5:[function(t,i,o){(function(a,r,T,h,m,N,D,A,M){var T=t("buffer").Buffer,P=t("./sha"),O=t("./sha256"),L=t("./rng"),$={sha1:P,sha256:O,md5:t("./md5")},H=64,R=new T(H);function ie(y,C){var X=$[y=y||"sha1"],q=[];return X||x("algorithm:",y,"is not yet supported"),{update:function(oe){return T.isBuffer(oe)||(oe=new T(oe)),q.push(oe),oe.length,this},digest:function(oe){var se=T.concat(q),se=C?function(J,Ee,ke){T.isBuffer(Ee)||(Ee=new T(Ee)),T.isBuffer(ke)||(ke=new T(ke)),Ee.length>H?Ee=J(Ee):Ee.length<H&&(Ee=T.concat([Ee,R],H));for(var we=new T(H),pe=new T(H),ae=0;ae<H;ae++)we[ae]=54^Ee[ae],pe[ae]=92^Ee[ae];return ke=J(T.concat([we,ke])),J(T.concat([pe,ke]))}(X,C,se):X(se);return q=null,oe?se.toString(oe):se}}}function x(){var y=[].slice.call(arguments).join(" ");throw new Error([y,"we accept pull requests","http://github.com/dominictarr/crypto-browserify"].join(`
`))}R.fill(0),o.createHash=function(y){return ie(y)},o.createHmac=ie,o.randomBytes=function(y,C){if(!C||!C.call)return new T(L(y));try{C.call(this,void 0,new T(L(y)))}catch(X){C(X)}};var w,g=["createCredentials","createCipher","createCipheriv","createDecipher","createDecipheriv","createSign","createVerify","createDiffieHellman","pbkdf2"],I=function(y){o[y]=function(){x("sorry,",y,"is not implemented yet")}};for(w in g)I(g[w])}).call(this,t("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},t("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/crypto-browserify/index.js","/node_modules/gulp-browserify/node_modules/crypto-browserify")},{"./md5":6,"./rng":7,"./sha":8,"./sha256":9,buffer:3,lYpoI2:11}],6:[function(t,i,o){(function(a,r,d,h,m,N,D,A,M){var T=t("./helpers");function P(x,w){x[w>>5]|=128<<w%32,x[14+(w+64>>>9<<4)]=w;for(var g=1732584193,I=-271733879,y=-1732584194,C=271733878,X=0;X<x.length;X+=16){var q=g,oe=I,se=y,J=C,g=L(g,I,y,C,x[X+0],7,-680876936),C=L(C,g,I,y,x[X+1],12,-389564586),y=L(y,C,g,I,x[X+2],17,606105819),I=L(I,y,C,g,x[X+3],22,-1044525330);g=L(g,I,y,C,x[X+4],7,-176418897),C=L(C,g,I,y,x[X+5],12,1200080426),y=L(y,C,g,I,x[X+6],17,-1473231341),I=L(I,y,C,g,x[X+7],22,-45705983),g=L(g,I,y,C,x[X+8],7,1770035416),C=L(C,g,I,y,x[X+9],12,-1958414417),y=L(y,C,g,I,x[X+10],17,-42063),I=L(I,y,C,g,x[X+11],22,-1990404162),g=L(g,I,y,C,x[X+12],7,1804603682),C=L(C,g,I,y,x[X+13],12,-40341101),y=L(y,C,g,I,x[X+14],17,-1502002290),g=$(g,I=L(I,y,C,g,x[X+15],22,1236535329),y,C,x[X+1],5,-165796510),C=$(C,g,I,y,x[X+6],9,-1069501632),y=$(y,C,g,I,x[X+11],14,643717713),I=$(I,y,C,g,x[X+0],20,-373897302),g=$(g,I,y,C,x[X+5],5,-701558691),C=$(C,g,I,y,x[X+10],9,38016083),y=$(y,C,g,I,x[X+15],14,-660478335),I=$(I,y,C,g,x[X+4],20,-405537848),g=$(g,I,y,C,x[X+9],5,568446438),C=$(C,g,I,y,x[X+14],9,-1019803690),y=$(y,C,g,I,x[X+3],14,-187363961),I=$(I,y,C,g,x[X+8],20,1163531501),g=$(g,I,y,C,x[X+13],5,-1444681467),C=$(C,g,I,y,x[X+2],9,-51403784),y=$(y,C,g,I,x[X+7],14,1735328473),g=H(g,I=$(I,y,C,g,x[X+12],20,-1926607734),y,C,x[X+5],4,-378558),C=H(C,g,I,y,x[X+8],11,-2022574463),y=H(y,C,g,I,x[X+11],16,1839030562),I=H(I,y,C,g,x[X+14],23,-35309556),g=H(g,I,y,C,x[X+1],4,-1530992060),C=H(C,g,I,y,x[X+4],11,1272893353),y=H(y,C,g,I,x[X+7],16,-155497632),I=H(I,y,C,g,x[X+10],23,-1094730640),g=H(g,I,y,C,x[X+13],4,681279174),C=H(C,g,I,y,x[X+0],11,-358537222),y=H(y,C,g,I,x[X+3],16,-722521979),I=H(I,y,C,g,x[X+6],23,76029189),g=H(g,I,y,C,x[X+9],4,-640364487),C=H(C,g,I,y,x[X+12],11,-421815835),y=H(y,C,g,I,x[X+15],16,530742520),g=R(g,I=H(I,y,C,g,x[X+2],23,-995338651),y,C,x[X+0],6,-198630844),C=R(C,g,I,y,x[X+7],10,1126891415),y=R(y,C,g,I,x[X+14],15,-1416354905),I=R(I,y,C,g,x[X+5],21,-57434055),g=R(g,I,y,C,x[X+12],6,1700485571),C=R(C,g,I,y,x[X+3],10,-1894986606),y=R(y,C,g,I,x[X+10],15,-1051523),I=R(I,y,C,g,x[X+1],21,-2054922799),g=R(g,I,y,C,x[X+8],6,1873313359),C=R(C,g,I,y,x[X+15],10,-30611744),y=R(y,C,g,I,x[X+6],15,-1560198380),I=R(I,y,C,g,x[X+13],21,1309151649),g=R(g,I,y,C,x[X+4],6,-145523070),C=R(C,g,I,y,x[X+11],10,-1120210379),y=R(y,C,g,I,x[X+2],15,718787259),I=R(I,y,C,g,x[X+9],21,-343485551),g=ie(g,q),I=ie(I,oe),y=ie(y,se),C=ie(C,J)}return Array(g,I,y,C)}function O(x,w,g,I,y,C){return ie((w=ie(ie(w,x),ie(I,C)))<<y|w>>>32-y,g)}function L(x,w,g,I,y,C,X){return O(w&g|~w&I,x,w,y,C,X)}function $(x,w,g,I,y,C,X){return O(w&I|g&~I,x,w,y,C,X)}function H(x,w,g,I,y,C,X){return O(w^g^I,x,w,y,C,X)}function R(x,w,g,I,y,C,X){return O(g^(w|~I),x,w,y,C,X)}function ie(x,w){var g=(65535&x)+(65535&w);return(x>>16)+(w>>16)+(g>>16)<<16|65535&g}i.exports=function(x){return T.hash(x,P,16)}}).call(this,t("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},t("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/crypto-browserify/md5.js","/node_modules/gulp-browserify/node_modules/crypto-browserify")},{"./helpers":4,buffer:3,lYpoI2:11}],7:[function(t,i,o){(function(a,r,d,h,m,N,D,A,M){i.exports=function(T){for(var P,O=new Array(T),L=0;L<T;L++)!(3&L)&&(P=4294967296*Math.random()),O[L]=P>>>((3&L)<<3)&255;return O}}).call(this,t("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},t("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/crypto-browserify/rng.js","/node_modules/gulp-browserify/node_modules/crypto-browserify")},{buffer:3,lYpoI2:11}],8:[function(t,i,o){(function(a,r,d,h,m,N,D,A,M){var T=t("./helpers");function P($,H){$[H>>5]|=128<<24-H%32,$[15+(H+64>>9<<4)]=H;for(var R,ie,x,w=Array(80),g=1732584193,I=-271733879,y=-1732584194,C=271733878,X=-1009589776,q=0;q<$.length;q+=16){for(var oe=g,se=I,J=y,Ee=C,ke=X,we=0;we<80;we++){w[we]=we<16?$[q+we]:L(w[we-3]^w[we-8]^w[we-14]^w[we-16],1);var pe=O(O(L(g,5),(pe=I,ie=y,x=C,(R=we)<20?pe&ie|~pe&x:!(R<40)&&R<60?pe&ie|pe&x|ie&x:pe^ie^x)),O(O(X,w[we]),(R=we)<20?1518500249:R<40?1859775393:R<60?-1894007588:-899497514)),X=C,C=y,y=L(I,30),I=g,g=pe}g=O(g,oe),I=O(I,se),y=O(y,J),C=O(C,Ee),X=O(X,ke)}return Array(g,I,y,C,X)}function O($,H){var R=(65535&$)+(65535&H);return($>>16)+(H>>16)+(R>>16)<<16|65535&R}function L($,H){return $<<H|$>>>32-H}i.exports=function($){return T.hash($,P,20,!0)}}).call(this,t("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},t("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/crypto-browserify/sha.js","/node_modules/gulp-browserify/node_modules/crypto-browserify")},{"./helpers":4,buffer:3,lYpoI2:11}],9:[function(t,i,o){(function(a,r,d,h,m,N,D,A,M){function T(H,R){var ie=(65535&H)+(65535&R);return(H>>16)+(R>>16)+(ie>>16)<<16|65535&ie}function P(H,R){var ie,x=new Array(1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298),w=new Array(1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225),g=new Array(64);H[R>>5]|=128<<24-R%32,H[15+(R+64>>9<<4)]=R;for(var I,y,C=0;C<H.length;C+=16){for(var X=w[0],q=w[1],oe=w[2],se=w[3],J=w[4],Ee=w[5],ke=w[6],we=w[7],pe=0;pe<64;pe++)g[pe]=pe<16?H[pe+C]:T(T(T((y=g[pe-2],L(y,17)^L(y,19)^$(y,10)),g[pe-7]),(y=g[pe-15],L(y,7)^L(y,18)^$(y,3))),g[pe-16]),ie=T(T(T(T(we,L(y=J,6)^L(y,11)^L(y,25)),J&Ee^~J&ke),x[pe]),g[pe]),I=T(L(I=X,2)^L(I,13)^L(I,22),X&q^X&oe^q&oe),we=ke,ke=Ee,Ee=J,J=T(se,ie),se=oe,oe=q,q=X,X=T(ie,I);w[0]=T(X,w[0]),w[1]=T(q,w[1]),w[2]=T(oe,w[2]),w[3]=T(se,w[3]),w[4]=T(J,w[4]),w[5]=T(Ee,w[5]),w[6]=T(ke,w[6]),w[7]=T(we,w[7])}return w}var O=t("./helpers"),L=function(H,R){return H>>>R|H<<32-R},$=function(H,R){return H>>>R};i.exports=function(H){return O.hash(H,P,32,!0)}}).call(this,t("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},t("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/crypto-browserify/sha256.js","/node_modules/gulp-browserify/node_modules/crypto-browserify")},{"./helpers":4,buffer:3,lYpoI2:11}],10:[function(t,i,o){(function(a,r,d,h,m,N,D,A,M){o.read=function(T,P,O,L,C){var H,R,ie=8*C-L-1,x=(1<<ie)-1,w=x>>1,g=-7,I=O?C-1:0,y=O?-1:1,C=T[P+I];for(I+=y,H=C&(1<<-g)-1,C>>=-g,g+=ie;0<g;H=256*H+T[P+I],I+=y,g-=8);for(R=H&(1<<-g)-1,H>>=-g,g+=L;0<g;R=256*R+T[P+I],I+=y,g-=8);if(H===0)H=1-w;else{if(H===x)return R?NaN:1/0*(C?-1:1);R+=Math.pow(2,L),H-=w}return(C?-1:1)*R*Math.pow(2,H-L)},o.write=function(T,P,O,L,$,X){var R,ie,x=8*X-$-1,w=(1<<x)-1,g=w>>1,I=$===23?Math.pow(2,-24)-Math.pow(2,-77):0,y=L?0:X-1,C=L?1:-1,X=P<0||P===0&&1/P<0?1:0;for(P=Math.abs(P),isNaN(P)||P===1/0?(ie=isNaN(P)?1:0,R=w):(R=Math.floor(Math.log(P)/Math.LN2),P*(L=Math.pow(2,-R))<1&&(R--,L*=2),2<=(P+=1<=R+g?I/L:I*Math.pow(2,1-g))*L&&(R++,L/=2),w<=R+g?(ie=0,R=w):1<=R+g?(ie=(P*L-1)*Math.pow(2,$),R+=g):(ie=P*Math.pow(2,g-1)*Math.pow(2,$),R=0));8<=$;T[O+y]=255&ie,y+=C,ie/=256,$-=8);for(R=R<<$|ie,x+=$;0<x;T[O+y]=255&R,y+=C,R/=256,x-=8);T[O+y-C]|=128*X}}).call(this,t("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},t("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/ieee754/index.js","/node_modules/gulp-browserify/node_modules/ieee754")},{buffer:3,lYpoI2:11}],11:[function(t,i,o){(function(a,r,d,h,m,N,D,A,M){var T,P,O;function L(){}(a=i.exports={}).nextTick=(P=typeof window<"u"&&window.setImmediate,O=typeof window<"u"&&window.postMessage&&window.addEventListener,P?function($){return window.setImmediate($)}:O?(T=[],window.addEventListener("message",function($){var H=$.source;H!==window&&H!==null||$.data!=="process-tick"||($.stopPropagation(),0<T.length&&T.shift()())},!0),function($){T.push($),window.postMessage("process-tick","*")}):function($){setTimeout($,0)}),a.title="browser",a.browser=!0,a.env={},a.argv=[],a.on=L,a.addListener=L,a.once=L,a.off=L,a.removeListener=L,a.removeAllListeners=L,a.emit=L,a.binding=function($){throw new Error("process.binding is not supported")},a.cwd=function(){return"/"},a.chdir=function($){throw new Error("process.chdir is not supported")}}).call(this,t("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},t("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/process/browser.js","/node_modules/gulp-browserify/node_modules/process")},{buffer:3,lYpoI2:11}]},{},[1])(1)})})(go);var $r=go.exports;const qt=Wn($r);class Pr{cache;useHash;constructor(e){this.cache={},this.useHash=e}cacheValue(e,t){this.cache[this.useHash?qt(e):String(e)]=t}deleteValue(e){delete this.cache[this.useHash?qt(e):String(e)]}getValue(e){return this.cache[this.useHash?qt(e):String(e)]}isCached(e){return(this.useHash?qt(e):String(e))in this.cache}invalidate(e){e&&Object.entries(this.cache).forEach(([t,i])=>e(t,i)),this.cache={}}}function Lr(){return new Worker("/assets/worker-b3cb1e7d.js",{type:"module"})}class Te{static PLAYER="PLAYER";static PARTY="PARTY";static SCENEITEMS="SCENEITEMS";static SCENELOCAL="SCENELOCAL";static SCENEMETA="SCENEMETADATA";static SCENEGRID="SCENEGRID";static SCENEFOG="SCENEFOG";static ROOMMETA="ROOMMETADATA";playerId;playerColor;playerName;playerMetadata;playerRole;party;lastParty;fogFilled;fogColor;fogStroke;gridDpi;gridScale;gridSnap;gridType;storedMetaItems;baseMELDepth;sceneItems;sceneLocal;sceneSelected;sceneMetadata;sceneReady;sceneInitialized;roomMetadata;theme;caches;playerShadowCache;localGhosts;snap;torchActive;previousVisionShapes;previousAutohideItems;previousPlayersWithVision;previousSize=[];previousVisionEnabled;previousMap;previousAutodetectEnabled;previousFowEnabled;previousPersistenceEnabled;previousFowColor;busy;workers;workersSetup;toolStarted;sceneMetadataHandler;sceneItemsHandler;sceneLocalHandler;sceneGridHandler;sceneReadyHandler;playerHandler;partyHandler;themeHandler;roomHandler;fogHandler;constructor(e){this.playerId="",this.playerName="",this.playerColor="",this.playerMetadata={},this.playerRole="PLAYER",this.party=[],this.lastParty=[],this.fogFilled=!1,this.fogColor="#000",this.fogStroke=5,this.storedMetaItems=[],this.sceneItems=[],this.sceneLocal=[],this.sceneSelected=[],this.sceneMetadata={},this.gridDpi=0,this.gridScale=5,this.gridSnap=10,this.gridType="ft",this.sceneReady=!1,this.sceneInitialized=!1,this.theme="DARK",this.roomMetadata={},this.localGhosts=[],this.snap=!1,this.busy=!1,this.torchActive=!1,this.toolStarted=!1,this.baseMELDepth=0,this.caches=e,this.playerShadowCache=new Pr(!1),this.previousVisionShapes="",this.previousAutohideItems="",this.previousPlayersWithVision="",this.previousSize=[],this.previousVisionEnabled=!1,this.previousMap="",this.previousAutodetectEnabled=!1,this.previousFowEnabled=!1,this.previousPersistenceEnabled=!1,this.previousFowColor="",this.workers=[],this.workersSetup=!1}async RefreshCache(){if(this.caches.includes(Te.PLAYER)&&(this.playerId=await b.player.getId(),this.playerName=await b.player.getName(),this.playerColor=await b.player.getColor(),this.playerMetadata=await b.player.getMetadata(),this.playerRole=await b.player.getRole()),this.caches.includes(Te.PARTY)&&(this.party=await b.party.getPlayers()),this.caches.includes(Te.SCENEFOG)&&this.sceneReady&&(this.fogColor=await b.scene.fog.getColor(),this.fogFilled=await b.scene.fog.getFilled()),this.caches.includes(Te.SCENEITEMS)&&this.sceneReady&&(this.sceneItems=await b.scene.items.getItems(),this.sceneLocal=await b.scene.local.getItems()),this.caches.includes(Te.SCENEMETA)&&this.sceneReady){this.sceneMetadata=await b.scene.getMetadata();const e=this.sceneMetadata[`${s.EXTENSIONID}/stored`];e&&(this.storedMetaItems=e)}if(this.caches.includes(Te.SCENEGRID)&&this.sceneReady){this.gridDpi=await b.scene.grid.getDpi();const e=await b.scene.grid.getScale();this.gridScale=e.parsed?.multiplier??5,this.gridType=e.parsed.unit}this.caches.includes(Te.ROOMMETA)&&this.sceneReady&&(this.roomMetadata=await b.room.getMetadata())}async InitializeCache(){if(this.CreateWorkers(),this.sceneReady=await b.scene.isReady(),this.theme=await b.theme.getTheme(),Si(this.theme,document),this.caches.includes(Te.PLAYER)&&(this.playerId=await b.player.getId(),this.playerName=await b.player.getName(),this.playerColor=await b.player.getColor(),this.playerMetadata=await b.player.getMetadata(),this.playerRole=await b.player.getRole()),this.caches.includes(Te.PARTY)&&(this.party=await b.party.getPlayers()),this.caches.includes(Te.SCENEFOG)&&this.sceneReady&&(this.fogColor=await b.scene.fog.getColor(),this.fogFilled=await b.scene.fog.getFilled()),this.caches.includes(Te.SCENEITEMS)&&this.sceneReady&&(this.sceneItems=await b.scene.items.getItems(),this.sceneLocal=await b.scene.local.getItems()),this.caches.includes(Te.SCENEMETA)&&this.sceneReady){this.sceneMetadata=await b.scene.getMetadata();const e=this.sceneMetadata[`${s.EXTENSIONID}/stored`];e&&(this.storedMetaItems=e)}if(this.caches.includes(Te.SCENEGRID)&&this.sceneReady){this.gridDpi=await b.scene.grid.getDpi();const e=await b.scene.grid.getScale();this.gridScale=e.parsed?.multiplier??5,this.gridType=e.parsed.unit}this.caches.includes(Te.ROOMMETA)&&this.sceneReady&&(this.roomMetadata=await b.room.getMetadata()),b.broadcast.onMessage(s.RESETID,async e=>{e.data&&await Z.ResetPersistence()}),b.broadcast.onMessage(`${s.EXTENSIONID}/ELEVATIONEVENT`,e=>{switch(e.data){case"CANCEL":Jn();break;case"FINISH":uo();break;case"UNDO":fo();break}}),b.broadcast.onMessage(`${s.EXTENSIONID}/LINEEVENT`,e=>{switch(e.data){case"CANCEL":Bn();break;case"FINISH":Vn();break;case"UNDO":oo();break}}),b.broadcast.onMessage(`${s.EXTENSIONID}/POLYGONEVENT`,e=>{switch(e.data){case"CANCEL":Hn();break;case"FINISH":Un();break;case"UNDO":ro();break}}),await this.SaveUserToScene()}CreateWorkers(){const t=Math.min(navigator.hardwareConcurrency??1,16);for(let i=0;i<t;i++){const o=new Lr;this.workers.push(o)}}async SaveUserToScene(){await b.scene.setMetadata({[`${s.EXTENSIONID}/USER-${this.playerId}`]:{role:this.playerRole,name:this.playerName,color:this.playerColor}})}KillHandlers(){this.caches.includes(Te.SCENEMETA)&&this.sceneMetadataHandler!==void 0&&this.sceneMetadataHandler(),this.caches.includes(Te.SCENEITEMS)&&this.sceneItemsHandler!==void 0&&this.sceneItemsHandler(),this.caches.includes(Te.SCENEITEMS)&&this.sceneLocalHandler!==void 0&&this.sceneLocalHandler(),this.caches.includes(Te.SCENEGRID)&&this.sceneGridHandler!==void 0&&this.sceneGridHandler(),this.caches.includes(Te.PLAYER)&&this.playerHandler!==void 0&&this.playerHandler(),this.caches.includes(Te.PARTY)&&this.partyHandler!==void 0&&this.partyHandler(),this.caches.includes(Te.ROOMMETA)&&this.roomHandler!==void 0&&this.roomHandler(),this.caches.includes(Te.SCENEFOG)&&this.fogHandler!==void 0&&this.fogHandler(),this.themeHandler!==void 0&&this.themeHandler()}SetupHandlers(){(this.sceneMetadataHandler===void 0||this.sceneMetadataHandler.length===0)&&this.caches.includes(Te.SCENEMETA)&&(this.sceneMetadataHandler=b.scene.onMetadataChange(async e=>{this.sceneMetadata=e,await this.OnSceneMetadataChanges(e)})),(this.sceneItemsHandler===void 0||this.sceneItemsHandler.length===0)&&this.caches.includes(Te.SCENEITEMS)&&(this.sceneItemsHandler=b.scene.items.onChange(async e=>{this.sceneItems=e,await this.OnSceneItemsChange(e)}),this.sceneLocalHandler=b.scene.local.onChange(async e=>{this.sceneLocal=e,await this.OnSceneLocalChange(e)})),(this.sceneGridHandler===void 0||this.sceneGridHandler.length===0)&&this.caches.includes(Te.SCENEGRID)&&(this.sceneGridHandler=b.scene.grid.onChange(async e=>{await this.OnSceneGridChange(e),this.gridDpi=e.dpi,this.gridScale=parseInt(e.scale)})),(this.playerHandler===void 0||this.playerHandler.length===0)&&this.caches.includes(Te.PLAYER)&&(this.playerHandler=b.player.onChange(async e=>{const t=this.playerRole;let i=!1;(this.playerName!==e.name||this.playerColor!==e.color||this.playerRole!==e.role)&&(i=!0),this.playerName=e.name,this.playerColor=e.color,this.playerId=e.id,this.playerRole=e.role,this.playerMetadata=e.metadata,await this.OnPlayerChange(e,t),i&&await this.SaveUserToScene()})),(this.partyHandler===void 0||this.partyHandler.length===0)&&this.caches.includes(Te.PARTY)&&(this.partyHandler=b.party.onChange(async e=>{this.party=e.filter(t=>t.id!==""),await this.OnPartyChange(e)})),(this.roomHandler===void 0||this.roomHandler.length===0)&&this.caches.includes(Te.ROOMMETA)&&(this.roomHandler=b.room.onMetadataChange(async e=>{await this.OnRoomMetadataChange(e),this.roomMetadata=e})),(this.fogHandler===void 0||this.fogHandler.length===0)&&this.caches.includes(Te.ROOMMETA)&&(this.fogHandler=b.scene.fog.onChange(async e=>{await this.OnFogChange(e),this.fogColor=e.style.color,this.fogFilled=e.filled})),this.themeHandler===void 0&&(this.themeHandler=b.theme.onChange(async e=>{this.theme=e.mode,await this.OnThemeChange(e)})),this.sceneReadyHandler===void 0&&(this.sceneReadyHandler=b.scene.onReadyChange(async e=>{this.sceneReady=e,e?(await this.SaveUserToScene(),await this.RefreshCache()):(ut.ClearGhostList(),this.KillHandlers(),this.toolStarted=!1,await b.tool.setMetadata(`${s.EXTENSIONID}/vision-tool`,{[`${s.EXTENSIONID}/elevationEditor`]:!1}),this.sceneItems=[],this.sceneMetadata={}),await this.OnSceneReadyChange(e)}))}async OnSceneMetadataChanges(e){this.baseMELDepth=e[`${s.EXTENSIONID}/defaultMELDepth`]??0,this.playerRole==="GM"&&await $n(),await St()}async OnSceneItemsChange(e){this.playerRole==="GM"?(await Z.UpdateUI(),await Pn(Z.mapAlign)):Z.UpdatePlayerVisionList(),await St()}async OnSceneLocalChange(e){ut.debouncedLocalChanges(p.sceneLocal)}async OnSceneGridChange(e){await St()}async OnSceneReadyChange(e){e?(await Fn(),this.SetupHandlers(),await St(),this.playerRole==="GM"&&await $n()):this.playerRole==="GM"&&(this.sceneInitialized=!1,await Z.UpdateUI())}async OnPlayerChange(e,t){this.playerRole!==t&&(await Z.SoftReset(),e.role==="GM"?(await b.action.setHeight(510),await b.action.setWidth(420)):Z.UpdatePlayerVisionList());const i=document.querySelectorAll(".token-table-entry");for(let m of i){let N=m.id.substring(3);e.selection!==void 0&&e.selection.includes(N)?m.classList.add("token-table-selected"):m.classList.remove("token-table-selected")}e.selection!==void 0&&e.selection.length===1&&Zo(e.selection[0]);const o=e.metadata;(o[`${s.EXTENSIONID}/finishLine`]??!1)===!0&&Vn(),(o[`${s.EXTENSIONID}/cancelLine`]??!1)===!0&&Bn(),(o[`${s.EXTENSIONID}/finishPoly`]??!1)===!0&&Un(),(o[`${s.EXTENSIONID}/cancelPoly`]??!1)===!0&&Hn()}async OnPartyChange(e){if(this.playerRole!=="PLAYER"){const t=document.getElementById("playerListing");t.innerHTML="",t.appendChild(Z.GetEmptyContextItem());for(const i of this.party){const o=document.createElement("li");o.id=i.id,o.textContent=i.name,o.style.color=i.color,t.appendChild(o)}ut.UpdateSpectreTargets(),Z.UpdatePlayerProcessUI()}}async OnFogChange(e){}async OnRoomMetadataChange(e){}async OnThemeChange(e){Si(e,document)}async ToggleBusy(e){await b.action.setBadgeText(e?"⏱️":void 0),p.busy=e}}const p=new Te([Te.SCENEITEMS,Te.SCENEMETA,Te.SCENEFOG,Te.SCENEGRID,Te.PLAYER,Te.PARTY]);function mo(n){return n.layer=="MAP"&&(n.metadata[`${s.EXTENSIONID}/isBackgroundImage`]||n.metadata[`${s.ARMINDOID}/isBackgroundImage`])}function At(n){return n.metadata[`${s.EXTENSIONID}/isVisionFog`]||n.metadata[`${s.ARMINDOID}/isVisionFog`]}function Rr(n){return n.metadata[`${s.EXTENSIONID}/isIndicatorRing`]||n.metadata[`${s.ARMINDOID}/isIndicatorRing`]}function Li(n){return n.metadata[`${s.EXTENSIONID}/isVisionLine`]||n.metadata[`${s.ARMINDOID}/isVisionLine`]}function Xr(n){return n.metadata[`${s.EXTENSIONID}/isVisionLine`]&&!n.metadata[`${s.EXTENSIONID}/disabled`]||n.metadata[`${s.ARMINDOID}/isVisionLine`]&&!n.metadata[`${s.ARMINDOID}/disabled`]}function yo(n){return(n.layer==="CHARACTER"||n.layer==="MOUNT"||n.layer==="ATTACHMENT"||n.layer==="PROP")&&(n.metadata[`${s.EXTENSIONID}/hasVision`]||n.metadata[`${s.ARMINDOID}/hasVision`])}function Ri(n){return(n.layer==="CHARACTER"||n.layer==="MOUNT"||n.layer==="ATTACHMENT"||n.layer==="PROP")&&(n.metadata[`${s.EXTENSIONID}/hasVision`]||n.metadata[`${s.ARMINDOID}/hasVision`])&&!n.metadata[`${s.EXTENSIONID}/visionBlind`]}function Fr(n){return(n.layer==="CHARACTER"||n.layer==="MOUNT"||n.layer==="ATTACHMENT"||n.layer==="PROP")&&n.createdUserId==p.playerId&&(n.metadata[`${s.EXTENSIONID}/hasVision`]||n.metadata[`${s.ARMINDOID}/hasVision`])&&!n.metadata[`${s.EXTENSIONID}/visionBlind`]}function Qn(n){return n.layer==="FOG"&&(n.metadata[`${s.EXTENSIONID}/isBackgroundImage`]||n.metadata[`${s.ARMINDOID}/isBackgroundImage`])}function Zt(n){return n.metadata[`${s.EXTENSIONID}/isTrailingFog`]}function Gn(n){return n.metadata[`${s.EXTENSIONID}/isTrailingFog`]||n.metadata[`${s.EXTENSIONID}/isVisionFog`]||n.metadata[`${s.ARMINDOID}/isVisionFog`]||n.metadata[`${s.EXTENSIONID}/isIndicatorRing`]}function Br(n){return n.metadata[`${s.EXTENSIONID}/isBrushSquare`]}function Tt(n){return n.metadata[`${s.EXTENSIONID}/visionTorch`]}function Xi(n){return(n.layer==="CHARACTER"||n.layer==="MOUNT"||n.layer==="ATTACHMENT"||n.layer==="PROP")&&!yo(n)&&n.metadata[`${s.EXTENSIONID}/hasAutohide`]===!0}var ot=function(){/*!
* Copyright (c) 2021-2023 Momo Bassit.
* Licensed under the MIT License (MIT)
* https://github.com/mdbassit/Coloris
* Version: 0.21.1
* NPM: https://github.com/melloware/coloris-npm
*/return function(n,e,t,i){var o=e.createElement("canvas").getContext("2d"),a={r:0,g:0,b:0,h:0,s:0,v:0,a:1},r,d,h,m,N,D,A,M,T,P,O,L,$,H,R,ie,x={},w={el:"[data-coloris]",parent:"body",theme:"default",themeMode:"light",rtl:!1,wrap:!0,margin:2,format:"hex",formatToggle:!1,swatches:[],swatchesOnly:!1,alpha:!0,forceAlpha:!1,focusInput:!0,selectInput:!1,inline:!1,defaultColor:"#000000",clearButton:!1,clearLabel:"Clear",closeButton:!1,closeLabel:"Close",onChange:function(){return i},a11y:{open:"Open color picker",close:"Close color picker",clear:"Clear the selected color",marker:"Saturation: {s}. Brightness: {v}.",hueSlider:"Hue slider",alphaSlider:"Opacity slider",input:"Color value field",format:"Color format",swatch:"Color swatch",instruction:"Saturation and brightness selector. Use up, down, left and right arrow keys to select."}},g={},I="",y={},C=!1;function X(S){if(typeof S=="object"){var B=function(){switch(j){case"el":Ee(S.el),S.wrap!==!1&&we(S.el);break;case"parent":r=e.querySelector(S.parent),r&&(r.appendChild(d),w.parent=S.parent,r===e.body&&(r=i));break;case"themeMode":w.themeMode=S.themeMode,S.themeMode==="auto"&&n.matchMedia&&n.matchMedia("(prefers-color-scheme: dark)").matches&&(w.themeMode="dark");case"theme":S.theme&&(w.theme=S.theme),d.className="clr-picker clr-"+w.theme+" clr-"+w.themeMode,w.inline&&ke();break;case"rtl":w.rtl=!!S.rtl,e.querySelectorAll(".clr-field").forEach(function(Ue){return Ue.classList.toggle("clr-rtl",w.rtl)});break;case"margin":S.margin*=1,w.margin=isNaN(S.margin)?w.margin:S.margin;break;case"wrap":S.el&&S.wrap&&we(S.el);break;case"formatToggle":w.formatToggle=!!S.formatToggle,ve("clr-format").style.display=w.formatToggle?"block":"none",w.formatToggle&&(w.format="auto");break;case"swatches":if(Array.isArray(S.swatches)){var ue=[];S.swatches.forEach(function(Ue,Oe){ue.push('<button type="button" id="clr-swatch-'+Oe+'" aria-labelledby="clr-swatch-label clr-swatch-'+Oe+'" style="color: '+Ue+';">'+Ue+"</button>")}),ve("clr-swatches").innerHTML=ue.length?"<div>"+ue.join("")+"</div>":"",w.swatches=S.swatches.slice()}break;case"swatchesOnly":w.swatchesOnly=!!S.swatchesOnly,d.setAttribute("data-minimal",w.swatchesOnly);break;case"alpha":w.alpha=!!S.alpha,d.setAttribute("data-alpha",w.alpha);break;case"inline":if(w.inline=!!S.inline,d.setAttribute("data-inline",w.inline),w.inline){var de=S.defaultColor||w.defaultColor;H=fe(de),ke(),ae(de)}break;case"clearButton":typeof S.clearButton=="object"&&(S.clearButton.label&&(w.clearLabel=S.clearButton.label,A.innerHTML=w.clearLabel),S.clearButton=S.clearButton.show),w.clearButton=!!S.clearButton,A.style.display=w.clearButton?"block":"none";break;case"clearLabel":w.clearLabel=S.clearLabel,A.innerHTML=w.clearLabel;break;case"closeButton":w.closeButton=!!S.closeButton,w.closeButton?d.insertBefore(M,N):N.appendChild(M);break;case"closeLabel":w.closeLabel=S.closeLabel,M.innerHTML=w.closeLabel;break;case"a11y":var he=S.a11y,xe=!1;if(typeof he=="object")for(var Ie in he)he[Ie]&&w.a11y[Ie]&&(w.a11y[Ie]=he[Ie],xe=!0);if(xe){var He=ve("clr-open-label"),_e=ve("clr-swatch-label");He.innerHTML=w.a11y.open,_e.innerHTML=w.a11y.swatch,M.setAttribute("aria-label",w.a11y.close),A.setAttribute("aria-label",w.a11y.clear),T.setAttribute("aria-label",w.a11y.hueSlider),O.setAttribute("aria-label",w.a11y.alphaSlider),D.setAttribute("aria-label",w.a11y.input),h.setAttribute("aria-label",w.a11y.instruction)}break;default:w[j]=S[j]}};for(var j in S)B()}}function q(S,B){typeof S=="string"&&typeof B=="object"&&(g[S]=B,C=!0)}function oe(S){delete g[S],Object.keys(g).length===0&&(C=!1,S===I&&J())}function se(S){if(C){var B=["el","wrap","rtl","inline","defaultColor","a11y"],j=function(){var he=g[ee];if(S.matches(ee)){I=ee,y={},B.forEach(function(Ie){return delete he[Ie]});for(var xe in he)y[xe]=Array.isArray(w[xe])?w[xe].slice():w[xe];return X(he),"break"}};for(var ee in g){var ue=j();if(ue==="break")break}}}function J(){Object.keys(y).length>0&&(X(y),I="",y={})}function Ee(S){Ne(e,"click",S,function(B){w.inline||(se(B.target),$=B.target,R=$.value,H=fe(R),d.classList.add("clr-open"),ke(),ae(R),(w.focusInput||w.selectInput)&&(D.focus({preventScroll:!0}),D.setSelectionRange($.selectionStart,$.selectionEnd)),w.selectInput&&D.select(),(ie||w.swatchesOnly)&&Ce().shift().focus(),$.dispatchEvent(new Event("open",{bubbles:!0})))}),Ne(e,"input",S,function(B){var j=B.target.parentNode;j.classList.contains("clr-field")&&(j.style.color=B.target.value)})}function ke(){if(!(!d||!$&&!w.inline)){var S=r,B=n.scrollY,j=d.offsetWidth,ee=d.offsetHeight,ue={left:!1,top:!1},de,he,xe,Ie={x:0,y:0};if(S&&(de=n.getComputedStyle(S),he=parseFloat(de.marginTop),xe=parseFloat(de.borderTopWidth),Ie=S.getBoundingClientRect(),Ie.y+=xe+B),!w.inline){var He=$.getBoundingClientRect(),_e=He.x,Ue=B+He.y+He.height+w.margin;S?(_e-=Ie.x,Ue-=Ie.y,_e+j>S.clientWidth&&(_e+=He.width-j,ue.left=!0),Ue+ee>S.clientHeight-he&&ee+w.margin<=He.top-(Ie.y-B)&&(Ue-=He.height+ee+w.margin*2,ue.top=!0),Ue+=S.scrollTop):(_e+j>e.documentElement.clientWidth&&(_e+=He.width-j,ue.left=!0),Ue+ee-B>e.documentElement.clientHeight&&ee+w.margin<=He.top&&(Ue=B+He.y-ee-w.margin,ue.top=!0)),d.classList.toggle("clr-left",ue.left),d.classList.toggle("clr-top",ue.top),d.style.left=_e+"px",d.style.top=Ue+"px",Ie.x+=d.offsetLeft,Ie.y+=d.offsetTop}x={width:h.offsetWidth,height:h.offsetHeight,x:h.offsetLeft+Ie.x,y:h.offsetTop+Ie.y}}}function we(S){e.querySelectorAll(S).forEach(function(B){var j=B.parentNode;if(!j.classList.contains("clr-field")){var ee=e.createElement("div"),ue="clr-field";(w.rtl||B.classList.contains("clr-rtl"))&&(ue+=" clr-rtl"),ee.innerHTML='<button type="button" aria-labelledby="clr-open-label"></button>',j.insertBefore(ee,B),ee.setAttribute("class",ue),ee.style.color=B.value,ee.appendChild(B)}})}function pe(S){if($&&!w.inline){var B=$;S&&($=i,R!==B.value&&(B.value=R,B.dispatchEvent(new Event("input",{bubbles:!0})))),setTimeout(function(){R!==B.value&&B.dispatchEvent(new Event("change",{bubbles:!0}))}),d.classList.remove("clr-open"),C&&J(),B.dispatchEvent(new Event("close",{bubbles:!0})),w.focusInput&&B.focus({preventScroll:!0}),$=i}}function ae(S){var B=De(S),j=le(B);ge(j.s,j.v),E(B,j),T.value=j.h,d.style.color="hsl("+j.h+", 100%, 50%)",P.style.left=j.h/360*100+"%",m.style.left=x.width*j.s/100+"px",m.style.top=x.height-x.height*j.v/100+"px",O.value=j.a*100,L.style.left=j.a*100+"%"}function fe(S){var B=S.substring(0,3).toLowerCase();return B==="rgb"||B==="hsl"?B:"hex"}function ce(S){S=S!==i?S:D.value,$&&($.value=S,$.dispatchEvent(new Event("input",{bubbles:!0}))),w.onChange&&w.onChange.call(n,S,$),e.dispatchEvent(new CustomEvent("coloris:pick",{detail:{color:S,currentEl:$}}))}function be(S,B){var j={h:T.value*1,s:S/x.width*100,v:100-B/x.height*100,a:O.value/100},ee=W(j);ge(j.s,j.v),E(ee,j),ce()}function ge(S,B){var j=w.a11y.marker;S=S.toFixed(1)*1,B=B.toFixed(1)*1,j=j.replace("{s}",S),j=j.replace("{v}",B),m.setAttribute("aria-label",j)}function ye(S){return{pageX:S.changedTouches?S.changedTouches[0].pageX:S.pageX,pageY:S.changedTouches?S.changedTouches[0].pageY:S.pageY}}function me(S){var B=ye(S),j=B.pageX-x.x,ee=B.pageY-x.y;r&&(ee+=r.scrollTop),f(j,ee),S.preventDefault(),S.stopPropagation()}function K(S,B){var j=m.style.left.replace("px","")*1+S,ee=m.style.top.replace("px","")*1+B;f(j,ee)}function f(S,B){S=S<0?0:S>x.width?x.width:S,B=B<0?0:B>x.height?x.height:B,m.style.left=S+"px",m.style.top=B+"px",be(S,B),m.focus()}function E(S,B){S===void 0&&(S={}),B===void 0&&(B={});var j=w.format;for(var ee in S)a[ee]=S[ee];for(var ue in B)a[ue]=B[ue];var de=Se(a),he=de.substring(0,7);switch(m.style.color=he,L.parentNode.style.color=he,L.style.color=de,N.style.color=de,h.style.display="none",h.offsetHeight,h.style.display="",L.nextElementSibling.style.display="none",L.nextElementSibling.offsetHeight,L.nextElementSibling.style.display="",j==="mixed"?j=a.a===1?"hex":"rgb":j==="auto"&&(j=H),j){case"hex":D.value=de;break;case"rgb":D.value=Xe(a);break;case"hsl":D.value=Ve(V(a));break}e.querySelector('.clr-format [value="'+j+'"]').checked=!0}function k(){var S=T.value*1,B=m.style.left.replace("px","")*1,j=m.style.top.replace("px","")*1;d.style.color="hsl("+S+", 100%, 50%)",P.style.left=S/360*100+"%",be(B,j)}function U(){var S=O.value/100;L.style.left=S*100+"%",E({a:S}),ce()}function W(S){var B=S.s/100,j=S.v/100,ee=B*j,ue=S.h/60,de=ee*(1-t.abs(ue%2-1)),he=j-ee;ee=ee+he,de=de+he;var xe=t.floor(ue)%6,Ie=[ee,de,he,he,de,ee][xe],He=[de,ee,ee,de,he,he][xe],_e=[he,he,de,ee,ee,de][xe];return{r:t.round(Ie*255),g:t.round(He*255),b:t.round(_e*255),a:S.a}}function V(S){var B=S.v/100,j=B*(1-S.s/100/2),ee;return j>0&&j<1&&(ee=t.round((B-j)/t.min(j,1-j)*100)),{h:S.h,s:ee||0,l:t.round(j*100),a:S.a}}function le(S){var B=S.r/255,j=S.g/255,ee=S.b/255,ue=t.max(B,j,ee),de=t.min(B,j,ee),he=ue-de,xe=ue,Ie=0,He=0;return he&&(ue===B&&(Ie=(j-ee)/he),ue===j&&(Ie=2+(ee-B)/he),ue===ee&&(Ie=4+(B-j)/he),ue&&(He=he/ue)),Ie=t.floor(Ie*60),{h:Ie<0?Ie+360:Ie,s:t.round(He*100),v:t.round(xe*100),a:S.a}}function De(S){var B=/^((rgba)|rgb)[\D]+([\d.]+)[\D]+([\d.]+)[\D]+([\d.]+)[\D]*?([\d.]+|$)/i,j,ee;return o.fillStyle="#000",o.fillStyle=S,j=B.exec(o.fillStyle),j?(ee={r:j[3]*1,g:j[4]*1,b:j[5]*1,a:j[6]*1},ee.a=+ee.a.toFixed(2)):(j=o.fillStyle.replace("#","").match(/.{2}/g).map(function(ue){return parseInt(ue,16)}),ee={r:j[0],g:j[1],b:j[2],a:1}),ee}function Se(S){var B=S.r.toString(16),j=S.g.toString(16),ee=S.b.toString(16),ue="";if(S.r<16&&(B="0"+B),S.g<16&&(j="0"+j),S.b<16&&(ee="0"+ee),w.alpha&&(S.a<1||w.forceAlpha)){var de=S.a*255|0;ue=de.toString(16),de<16&&(ue="0"+ue)}return"#"+B+j+ee+ue}function Xe(S){return!w.alpha||S.a===1&&!w.forceAlpha?"rgb("+S.r+", "+S.g+", "+S.b+")":"rgba("+S.r+", "+S.g+", "+S.b+", "+S.a+")"}function Ve(S){return!w.alpha||S.a===1&&!w.forceAlpha?"hsl("+S.h+", "+S.s+"%, "+S.l+"%)":"hsla("+S.h+", "+S.s+"%, "+S.l+"%, "+S.a+")"}function Be(){e.getElementById("clr-picker")||(r=i,d=e.createElement("div"),d.setAttribute("id","clr-picker"),d.className="clr-picker",d.innerHTML='<input id="clr-color-value" name="clr-color-value" class="clr-color" type="text" value="" spellcheck="false" aria-label="'+w.a11y.input+'">'+('<div id="clr-color-area" class="clr-gradient" role="application" aria-label="'+w.a11y.instruction+'">')+'<div id="clr-color-marker" class="clr-marker" tabindex="0"></div></div><div class="clr-hue">'+('<input id="clr-hue-slider" name="clr-hue-slider" type="range" min="0" max="360" step="1" aria-label="'+w.a11y.hueSlider+'">')+'<div id="clr-hue-marker"></div></div><div class="clr-alpha">'+('<input id="clr-alpha-slider" name="clr-alpha-slider" type="range" min="0" max="100" step="1" aria-label="'+w.a11y.alphaSlider+'">')+'<div id="clr-alpha-marker"></div><span></span></div><div id="clr-format" class="clr-format"><fieldset class="clr-segmented">'+("<legend>"+w.a11y.format+"</legend>")+'<input id="clr-f1" type="radio" name="clr-format" value="hex"><label for="clr-f1">Hex</label><input id="clr-f2" type="radio" name="clr-format" value="rgb"><label for="clr-f2">RGB</label><input id="clr-f3" type="radio" name="clr-format" value="hsl"><label for="clr-f3">HSL</label><span></span></fieldset></div><div id="clr-swatches" class="clr-swatches"></div>'+('<button type="button" id="clr-clear" class="clr-clear" aria-label="'+w.a11y.clear+'">'+w.clearLabel+"</button>")+'<div id="clr-color-preview" class="clr-preview">'+('<button type="button" id="clr-close" class="clr-close" aria-label="'+w.a11y.close+'">'+w.closeLabel+"</button>")+"</div>"+('<span id="clr-open-label" hidden>'+w.a11y.open+"</span>")+('<span id="clr-swatch-label" hidden>'+w.a11y.swatch+"</span>"),e.body.appendChild(d),h=ve("clr-color-area"),m=ve("clr-color-marker"),A=ve("clr-clear"),M=ve("clr-close"),N=ve("clr-color-preview"),D=ve("clr-color-value"),T=ve("clr-hue-slider"),P=ve("clr-hue-marker"),O=ve("clr-alpha-slider"),L=ve("clr-alpha-marker"),Ee(w.el),we(w.el),Ne(d,"mousedown",function(S){d.classList.remove("clr-keyboard-nav"),S.stopPropagation()}),Ne(h,"mousedown",function(S){Ne(e,"mousemove",me)}),Ne(h,"touchstart",function(S){e.addEventListener("touchmove",me,{passive:!1})}),Ne(m,"mousedown",function(S){Ne(e,"mousemove",me)}),Ne(m,"touchstart",function(S){e.addEventListener("touchmove",me,{passive:!1})}),Ne(D,"change",function(S){var B=D.value;if($||w.inline){var j=B===""?B:ae(B);ce(j)}}),Ne(A,"click",function(S){ce(""),pe()}),Ne(M,"click",function(S){ce(),pe()}),Ne(ve("clr-format"),"click",".clr-format input",function(S){H=S.target.value,E(),ce()}),Ne(d,"click",".clr-swatches button",function(S){ae(S.target.textContent),ce(),w.swatchesOnly&&pe()}),Ne(e,"mouseup",function(S){e.removeEventListener("mousemove",me)}),Ne(e,"touchend",function(S){e.removeEventListener("touchmove",me)}),Ne(e,"mousedown",function(S){ie=!1,d.classList.remove("clr-keyboard-nav"),pe()}),Ne(e,"keydown",function(S){var B=S.key,j=S.target,ee=S.shiftKey,ue=["Tab","ArrowUp","ArrowDown","ArrowLeft","ArrowRight"];if(B==="Escape"?pe(!0):ue.includes(B)&&(ie=!0,d.classList.add("clr-keyboard-nav")),B==="Tab"&&j.matches(".clr-picker *")){var de=Ce(),he=de.shift(),xe=de.pop();ee&&j===he?(xe.focus(),S.preventDefault()):!ee&&j===xe&&(he.focus(),S.preventDefault())}}),Ne(e,"click",".clr-field button",function(S){C&&J(),S.target.nextElementSibling.dispatchEvent(new Event("click",{bubbles:!0}))}),Ne(m,"keydown",function(S){var B={ArrowUp:[0,-1],ArrowDown:[0,1],ArrowLeft:[-1,0],ArrowRight:[1,0]};Object.keys(B).includes(S.key)&&(K.apply(void 0,B[S.key]),S.preventDefault())}),Ne(h,"click",me),Ne(T,"input",k),Ne(O,"input",U))}function Ce(){var S=Array.from(d.querySelectorAll("input, button")),B=S.filter(function(j){return!!j.offsetWidth});return B}function ve(S){return e.getElementById(S)}function Ne(S,B,j,ee){var ue=Element.prototype.matches||Element.prototype.msMatchesSelector;typeof j=="string"?S.addEventListener(B,function(de){ue.call(de.target,j)&&ee.call(de.target,de)}):(ee=j,S.addEventListener(B,ee))}function Ke(S,B){B=B!==i?B:[],e.readyState!=="loading"?S.apply(void 0,B):e.addEventListener("DOMContentLoaded",function(){S.apply(void 0,B)})}NodeList!==i&&NodeList.prototype&&!NodeList.prototype.forEach&&(NodeList.prototype.forEach=Array.prototype.forEach);function st(S,B){$=B,R=$.value,se(B),H=fe(S),ke(),ae(S),ce(),R!==S&&$.dispatchEvent(new Event("change",{bubbles:!0}))}var Q=function(){var S={init:Be,set:X,wrap:we,close:pe,setInstance:q,setColor:st,removeInstance:oe,updatePosition:ke};function B(ue){Ke(function(){ue&&(typeof ue=="string"?Ee(ue):X(ue))})}var j=function(de){B[de]=function(){for(var he=arguments.length,xe=new Array(he),Ie=0;Ie<he;Ie++)xe[Ie]=arguments[Ie];Ke(S[de],xe)}};for(var ee in S)j(ee);return Ke(function(){n.addEventListener("resize",function(ue){B.updatePosition()}),n.addEventListener("scroll",function(ue){B.updatePosition()})}),B}();return Q.coloris=Q,Q}(window,document,Math)}();ot.coloris;ot.init;ot.set;ot.wrap;ot.close;ot.setInstance;ot.removeInstance;ot.updatePosition;function Vr(){Z.smokeViewToggle.onclick=e=>{e.preventDefault(),n(Z.smokeViewToggle,Z.smokeViewPanel)},Z.spectreViewToggle.onclick=e=>{e.preventDefault(),n(Z.spectreViewToggle,Z.spectreViewPanel)},Z.settingsViewToggle.onclick=e=>{e.preventDefault(),n(Z.settingsViewToggle,Z.settingsViewPanel)},Z.debugViewToggle.onclick=e=>{e.preventDefault(),n(Z.debugViewToggle,Z.debugViewPanel)};function n(e,t){Z.smokeViewToggle?.classList.remove("selected"),Z.spectreViewToggle?.classList.remove("selected"),Z.settingsViewToggle?.classList.remove("selected"),Z.debugViewToggle?.classList.remove("selected"),Z.smokeViewPanel.style.display="none",Z.spectreViewPanel.style.display="none",Z.settingsViewPanel.style.display="none",Z.debugViewPanel.style.display="none",e.classList.add("selected"),t.style.display="block"}}function Fi(){Z.processedIndicator.onclick=async()=>{await b.popover.open({id:s.PROCESSEDID,url:"/pages/processed.html",height:300,width:320,disableClickAway:!1})},Z.hiddenListToggle.onclick=async o=>{Z.hiddenTable.style.display==="none"?(Z.hiddenTable&&(Z.hiddenTable.style.display="table-row-group"),Z.hiddenListToggle&&(Z.hiddenListToggle.value="Out-of-Sight List: Click to Hide")):(Z.hiddenTable&&(Z.hiddenTable.style.display="none"),Z.hiddenListToggle&&(Z.hiddenListToggle.value="Out-of-Sight List: Click to Show"))},Z.visionCheckbox.onclick=async o=>{if(!p.sceneReady){o.preventDefault();return}const a=o.target;if(await b.scene.setMetadata({[`${s.EXTENSIONID}/visionEnabled`]:a.checked}),p.sceneMetadata[`${s.EXTENSIONID}/autodetectEnabled`]===!0)await b.scene.fog.setFilled(a.checked);else{await b.scene.fog.setFilled(!1);const r=p.sceneItems.filter(Qn);await b.scene.items.updateItems(r,d=>{for(let h of d)a.checked?h.style.fillOpacity=1:h.style.fillOpacity=0})}},Z.snapCheckbox.checked=!0,Z.snapCheckbox.onclick=async o=>{if(!p.sceneReady){o.preventDefault();return}const a=o.target;p.snap=a.checked},Z.persistenceCheckbox.onclick=async o=>{if(!o||!o.target)return;const a=o.target;await b.scene.setMetadata({[`${s.EXTENSIONID}/persistenceEnabled`]:a.checked})},Z.autodetectCheckbox.onclick=async o=>{if(!o||!o.target)return;const a=o.target;Z.boundryOptions.style.display=a.checked?"none":"",await b.scene.setMetadata({[`${s.EXTENSIONID}/autodetectEnabled`]:a.checked})},Z.fowCheckbox.onclick=async o=>{if(!o||!o.target)return;const a=o.target;await en(a.checked),await b.scene.setMetadata({[`${s.EXTENSIONID}/fowEnabled`]:a.checked})},Z.doorCheckbox.onclick=async o=>{if(!o||!o.target)return;const a=o.target;await b.scene.setMetadata({[`${s.EXTENSIONID}/playerDoors`]:a.checked})},Z.resetButton.onclick=async o=>{!o||!o.target||b.broadcast.sendMessage(s.RESETID,!0,{destination:"ALL"})},Z.unlockFogButton.onclick=async o=>{if(!o||!o.target)return;const a=p.sceneItems.filter(r=>Li(r));await p.ToggleBusy(!0);for(let r=0;r<a.length;r+=64){const d=a.slice(r,r+64);await b.scene.items.updateItems(d,h=>{for(let m of h)m.locked=!1})}await p.ToggleBusy(!1)},Z.lockFogButton.onclick=async o=>{if(!o||!o.target)return;const a=p.sceneItems.filter(r=>Li(r));await p.ToggleBusy(!0);for(let r=0;r<a.length;r+=64){const d=a.slice(r,r+64);await b.scene.items.updateItems(d,h=>{for(let m of h)m.locked=!0})}await p.ToggleBusy(!1)},Z.backgroundButton.onclick=async o=>{!o||!o.target||(o.target,await b.scene.items.updateItems(a=>a.layer=="FOG"&&a.metadata[`${s.EXTENSIONID}/isBackgroundMap`]===!0,a=>{for(let r=0;r<a.length;r++)a[r].layer="MAP",a[r].disableHit=!1,a[r].locked=!1,a[r].visible=!0,delete a[r].metadata[`${s.EXTENSIONID}/isBackgroundMap`]}))};let n;Z.fowColor.onclick=()=>{ot({el:`#${Z.fowColor.id}`,alpha:!0,forceAlpha:!0})},Z.fowColor.oninput=async o=>{if(!o||!o.target)return;const a=o.target;clearTimeout(n),n=setTimeout(async()=>{if(/#[a-f0-9]{8}/.test(a.value)){await b.scene.setMetadata({[`${s.EXTENSIONID}/fowColor`]:a.value});const d=await b.scene.local.getItems(Zt);await b.scene.local.deleteItems(d.map(h=>h.id))}},500)},Z.convertButton.onclick=async o=>{if(!(!o||!o.target)&&window.confirm(`WARNING: THIS CANNOT BE UNDONE.

This operation will remove all metadata from the original dynamic fog extension, and will break fog lines and other things if you do not continue using Smoke!.

WARNING: THIS CANNOT BE UNDONE.

Are you REALLY sure?`)){for(const a in p.sceneMetadata)a.substring(0,a.indexOf("/"))==s.ARMINDOID&&await b.scene.setMetadata({[`${a}`]:void 0});await b.scene.items.updateItems(p.sceneItems,a=>{for(const r of a)r.metadata[`${s.ARMINDOID}/isVisionLine`]!==void 0&&(r.metadata[`${s.EXTENSIONID}/isVisionLine`]=r.metadata[`${s.ARMINDOID}/isVisionLine`],delete r.metadata[`${s.ARMINDOID}/isVisionLine`]),r.metadata[`${s.ARMINDOID}/disabled`]!==void 0&&(r.metadata[`${s.EXTENSIONID}/disabled`]=r.metadata[`${s.ARMINDOID}/disabled`],delete r.metadata[`${s.ARMINDOID}/disabled`])})}};var e;Z.importFile.onchange=o=>{if(Z.importButton.disabled=!0,!o||!o.target)return;const a=o.target;if(!a.files)return;const r=a.files[0];if(r.type!=="text/javascript"&&r.type,r){var d=new FileReader;d.onload=function(h){if(!h||!h.target){Z.importErrors.innerText="Invalid import event";return}const m=h.target;if(!m.result){Z.importErrors.innerText="Unable to read imported file";return}const N=m.result;e=JSON.parse(N),e&&(e.walls&&e.walls.length||e.line_of_sight&&e.line_of_sight.length||e.objects_line_of_sight&&e.objects_line_of_sight.length)?Z.importButton.disabled=!1:Z.importErrors.innerText="Imported file has no walls"},d.readAsText(r)}else Z.importErrors.innerText="Failed to load file"},Z.dpiAutodetect.onclick=async o=>{!o||!o.target||(Z.importDpi.disabled=Z.dpiAutodetect.checked)},Z.importButton.onclick=async o=>{!o||!o.target||(await p.ToggleBusy(!0),Z.importFormat.value==="scene"?await ia(e,Z.importErrors):await ta(Z.importFormat.value,e,Z.dpiAutodetect.checked?0:Number.parseInt(Z.importDpi.value),Z.mapAlign.value,Z.importErrors),await p.ToggleBusy(!1))},Z.toolColor.onclick=async o=>{ot({el:`#${Z.toolColor.id}`,alpha:!1,forceAlpha:!1})},Z.toolColor.oninput=async o=>{if(!o||!o.target)return;const a=o.target;clearTimeout(n),n=setTimeout(async()=>{/#[a-f0-9]{6}/.test(a.value)&&await b.scene.setMetadata({[`${s.EXTENSIONID}/toolColor`]:a.value})},400)},Z.toolStyle.onchange=async o=>{const a=o.currentTarget;await b.scene.setMetadata({[`${s.EXTENSIONID}/toolStyle`]:a.value=="solid"?[]:[25,25]})},Z.toolWidth.onchange=o=>{const a=o.currentTarget;clearTimeout(n),n=setTimeout(async()=>{await b.scene.setMetadata({[`${s.EXTENSIONID}/toolWidth`]:a.value})},400)},Z.defaultMELDepth.onchange=o=>{const a=o.currentTarget;clearTimeout(n),n=setTimeout(async()=>{await b.scene.setMetadata({[`${s.EXTENSIONID}/defaultMELDepth`]:a.value})},400)},Z.whatsNewButton.onclick=async function(){Z.whatsNewIcon?.classList.remove("new-shine"),await b.modal.open({id:s.EXTENSIONWHATSNEW,url:"/pages/whatsnew.html",height:500,width:400})};const t=p.sceneMetadata[`${s.EXTENSIONID}/fowColor`]??"#00000088",i=p.sceneMetadata[`${s.EXTENSIONID}/toolColor`]??"#000000";Z.toolColor&&(Z.toolColor.value=i),Z.fowColor&&(Z.fowColor.value=t),ot({themeMode:"dark",alpha:!0,forceAlpha:!0,el:"#fow_color",defaultColor:t}),ot({themeMode:"dark",alpha:!1,forceAlpha:!1,el:"#tool_color",defaultColor:i})}const vo="#000000",Hr=8,Ur=[];let vt=[];async function Eo(){vt=[];const n=await b.scene.local.getItems(Br);await b.scene.local.deleteItems(n.map(e=>e.id)),await b.popover.close(s.BRUSHTOOLID)}async function Gr(n,e){await Io(e.pointerPosition)}async function Wr(){const n=await b.viewport.getWidth();await b.popover.open({id:s.BRUSHTOOLID,url:"/pages/brush.html",height:80,width:350,disableClickAway:!0,anchorPosition:{top:60,left:n/2},anchorReference:"POSITION",anchorOrigin:{vertical:"CENTER",horizontal:"CENTER"},transformOrigin:{vertical:"TOP",horizontal:"CENTER"}})}async function jr(){await b.popover.close(s.BRUSHTOOLID)}async function qr(n,e){await Io(e.pointerPosition)}async function Kr(n,e){await Yr(),await Eo()}async function zr(n,e){await Eo()}async function Io(n){const e={x:Math.floor(n.x/p.gridDpi),y:Math.floor(n.y/p.gridDpi)};if(!vt.some(i=>i.x===e.x&&i.y===e.y)){const i={x:e.x*p.gridDpi,y:e.y*p.gridDpi},o={x:(e.x+1)*p.gridDpi,y:e.y*p.gridDpi},a={x:e.x*p.gridDpi,y:(e.y+1)*p.gridDpi},r={x:(e.x+1)*p.gridDpi,y:(e.y+1)*p.gridDpi},d=[[_t.MOVE,i.x,i.y],[_t.LINE,o.x,o.y],[_t.LINE,r.x,r.y],[_t.LINE,a.x,a.y],[_t.CLOSE]],h=gt().commands(d).strokeOpacity(0).fillOpacity(.5).fillColor(p.sceneMetadata[`${s.EXTENSIONID}/toolColor`]??vo).build();h.metadata[`${s.EXTENSIONID}/isBrushSquare`]=!0,vt.push(e),await b.scene.local.addItems([h])}}async function Yr(){const n=[];for(const r of vt){const{x:d,y:h}=r,m={x:d*p.gridDpi,y:h*p.gridDpi},N={x:(d+1)*p.gridDpi,y:h*p.gridDpi},D={x:d*p.gridDpi,y:(h+1)*p.gridDpi},A={x:(d+1)*p.gridDpi,y:(h+1)*p.gridDpi};if(!vt.some(M=>M.x===d&&M.y===h-1)){const M=m,T=N;n.push({Start:M,End:T})}if(!vt.some(M=>M.x===d&&M.y===h+1)){const M=D,T=A;n.push({Start:M,End:T})}if(!vt.some(M=>M.x===d-1&&M.y===h)){const M=m,T=D;n.push({Start:M,End:T})}if(!vt.some(M=>M.x===d+1&&M.y===h)){const M=N,T=A;n.push({Start:M,End:T})}}const e=So(n),t=wo(e),i=Qr(t),o=25,a=i.length;for(let r=0;r<a;r+=o){const d=i.slice(r,r+o);await b.scene.items.addItems(d)}}function wo(n){let e=[],t=[],i=!1;for(const o of n){const a=o.Start.x===o.End.x?n.filter(h=>h.Start.x===h.End.x):n.filter(h=>h.Start.y===h.End.y),r=o.Start.x===o.End.x?a.filter(h=>h.Start.x===o.Start.x&&h.End.x===o.End.x):a.filter(h=>h.Start.y===o.Start.y&&h.End.y===o.End.y),d=o.Start.x!==o.End.x?r.find(h=>h.Start.x>o.Start.x&&h.Start.x<o.End.x):r.find(h=>h.Start.y>o.Start.y&&h.Start.y<o.End.y);if(d){const h=Jr(o,d);t.push(h),e.push(o),e.push(d),t=t.filter(m=>m!==o&&m!==d),i=!0}else e.includes(o)||t.push(o)}return i?wo(t):t}function So(n){let e=[],t=[],i=!1;for(const o of n){const r=(o.Start.x===o.End.x?n.filter(d=>d.Start.x===d.End.x):n.filter(d=>d.Start.y===d.End.y)).find(d=>d.Start.x===o.End.x&&d.Start.y===o.End.y);if(r){const d=Zr(o,r);t.push(d),e.push(o),e.push(r),t=t.filter(h=>h!==o&&h!==r),i=!0}else e.includes(o)||t.push(o)}return i?So(t):t}function Zr(n,e){return{Start:n.Start,End:e.End}}function Jr(n,e){const t=Math.min(n.Start.x,e.Start.x),i=Math.min(n.Start.y,e.Start.y),o=Math.max(n.End.x,e.End.x),a=Math.max(n.End.y,e.End.y);return{Start:{x:t,y:i},End:{x:o,y:a}}}function Qr(n){const e=[];for(const t of n){const i=ct().tension(0).points([t.Start,t.End]).strokeColor(p.sceneMetadata[`${s.EXTENSIONID}/toolColor`]??vo).strokeDash(p.sceneMetadata[`${s.EXTENSIONID}/toolStyle`]??Ur).strokeWidth(p.sceneMetadata[`${s.EXTENSIONID}/toolWidth`]??Hr).fillOpacity(0).fillColor("#000000").layer("DRAWING").name("Vision Line (Brushed)").closed(!1).locked(!0).build();i.visible=!1,i.metadata[`${s.EXTENSIONID}/isVisionLine`]=!0,e.push(i)}return e}const bt={onActivate:Wr,onDeactivate:jr,onDragStart:Gr,onDragMove:qr,onDragEnd:Kr,onDragCancel:zr};async function Bi(){await b.tool.create({id:`${s.EXTENSIONID}/vision-tool`,icons:[{icon:"/icon.svg",label:"Setup Vision"}],defaultMetadata:{[`${s.EXTENSIONID}/elevationEditor`]:!1},async onClick(){await b.tool.activateTool(`${s.EXTENSIONID}/vision-tool`),p.toolStarted||(p.toolStarted=!0,await b.tool.setMetadata(`${s.EXTENSIONID}/vision-tool`,{[`${s.EXTENSIONID}/elevationEditor`]:!1}))}}),await b.tool.createMode({id:`${s.EXTENSIONID}/add-vision-polygon-mode`,icons:[{icon:"/object.svg",label:"Add Obstruction Object",filter:{activeTools:[`${s.EXTENSIONID}/vision-tool`]}}],onToolDown:An.onToolClick,onToolMove:An.onToolMove,onKeyDown:An.onKeyDown,preventDrag:{dragging:!1}}),await b.tool.createMode({id:`${s.EXTENSIONID}/add-vision-line-mode`,icons:[{icon:"/line.svg",label:"Add Obstruction Line",filter:{activeTools:[`${s.EXTENSIONID}/vision-tool`]}}],onToolDown:_n.onToolClick,onToolMove:_n.onToolMove,onKeyDown:_n.onKeyDown,preventDrag:{dragging:!1}}),await b.tool.createMode({id:`${s.EXTENSIONID}/add-vision-brush-mode`,icons:[{icon:"/brush.svg",label:"Paint Obstructions by Grid",filter:{activeTools:[`${s.EXTENSIONID}/vision-tool`]}}],onToolDown:bt.onActivate,onToolUp:bt.onDeactivate,onToolDragStart:bt.onDragStart,onToolDragMove:bt.onDragMove,onToolDragEnd:bt.onDragEnd,onToolDragCancel:bt.onDragCancel}),await b.tool.createMode({id:`${s.EXTENSIONID}/enter-elevation-mode-1`,icons:[{icon:"/mountain1.svg",label:"Create Map Elevation Layer-1",filter:{activeTools:[`${s.EXTENSIONID}/vision-tool`]}}],disabled:{metadata:[{key:[`${s.EXTENSIONID}/elevationEditor`],value:!1}]},onToolDown:(n,e)=>{je.onToolClick(n,e,1)},onToolMove:je.onToolMove,onKeyDown:(n,e)=>{je.onKeyDown(n,e,1)},preventDrag:{dragging:!0}}),await b.tool.createMode({id:`${s.EXTENSIONID}/enter-elevation-mode-2`,icons:[{icon:"/mountain2.svg",label:"Create Map Elevation Layer-2",filter:{activeTools:[`${s.EXTENSIONID}/vision-tool`]}}],disabled:{metadata:[{key:[`${s.EXTENSIONID}/elevationEditor`],value:!1}]},onToolDown:(n,e)=>{je.onToolClick(n,e,2)},onToolMove:je.onToolMove,onKeyDown:(n,e)=>{je.onKeyDown(n,e,2)},preventDrag:{dragging:!0}}),await b.tool.createMode({id:`${s.EXTENSIONID}/enter-elevation-mode-3`,icons:[{icon:"/mountain3.svg",label:"Create Map Elevation Layer-3",filter:{activeTools:[`${s.EXTENSIONID}/vision-tool`]}}],disabled:{metadata:[{key:[`${s.EXTENSIONID}/elevationEditor`],value:!1}]},onToolDown:(n,e)=>{je.onToolClick(n,e,3)},onToolMove:je.onToolMove,onKeyDown:(n,e)=>{je.onKeyDown(n,e,3)},preventDrag:{dragging:!0}}),await b.tool.createMode({id:`${s.EXTENSIONID}/enter-elevation-mode-4`,icons:[{icon:"/mountain4.svg",label:"Create Map Elevation Layer-4",filter:{activeTools:[`${s.EXTENSIONID}/vision-tool`]}}],disabled:{metadata:[{key:[`${s.EXTENSIONID}/elevationEditor`],value:!1}]},onToolDown:(n,e)=>{je.onToolClick(n,e,4)},onToolMove:je.onToolMove,onKeyDown:(n,e)=>{je.onKeyDown(n,e,4)},preventDrag:{dragging:!0}}),await b.tool.createMode({id:`${s.EXTENSIONID}/enter-elevation-mode-5`,icons:[{icon:"/mountain5.svg",label:"Create Map Elevation Layer-5",filter:{activeTools:[`${s.EXTENSIONID}/vision-tool`]}}],disabled:{metadata:[{key:[`${s.EXTENSIONID}/elevationEditor`],value:!1}]},onToolDown:(n,e)=>{je.onToolClick(n,e,5)},onToolMove:je.onToolMove,onKeyDown:(n,e)=>{je.onKeyDown(n,e,5)},preventDrag:{dragging:!0}}),await b.tool.createMode({id:`${s.EXTENSIONID}/enter-elevation-mode-select`,icons:[{icon:"/mountain-select.svg",label:"Selector",filter:{activeTools:[`${s.EXTENSIONID}/vision-tool`]}}],disabled:{metadata:[{key:[`${s.EXTENSIONID}/elevationEditor`],value:!1}]},onToolDown:(n,e)=>!0,preventDrag:{dragging:!0}}),await b.tool.createAction({id:`${s.EXTENSIONID}/enter-elevation-mode`,icons:[{icon:"/eyeclosed.svg",label:"Activate Elevation Editor",filter:{activeTools:[`${s.EXTENSIONID}/vision-tool`],metadata:[{key:[`${s.EXTENSIONID}/elevationEditor`],value:!0,operator:"!="}]}},{icon:"/eyeopen.svg",label:"De-Activate Elevation Editor",filter:{activeTools:[`${s.EXTENSIONID}/vision-tool`],metadata:[{key:[`${s.EXTENSIONID}/elevationEditor`],value:!0,operator:"=="}]}}],onClick:je.enterEditMode})}class es{mainWindow=document.getElementById("app");mainUIDiv;playerListContainer;settingsUIDiv;visionCheckbox;hiddenListToggle;snapCheckbox;table;hiddenTable;message;mapHeight;mapWidth;mapSubmit;whatsNewButton;whatsNewIcon;processedIndicator;smokeViewToggle;spectreViewToggle;settingsViewToggle;debugViewToggle;smokeViewPanel;spectreViewPanel;settingsViewPanel;debugViewPanel;persistenceCheckbox;autodetectCheckbox;fowCheckbox;doorCheckbox;fowColor;resetButton;convertButton;boundryOptions;backgroundButton;lockFogButton;unlockFogButton;defaultMELDepth;toolWidth;toolColor;toolStyle;importButton;importFile;mapAlign;importErrors;dpiAutodetect;importDpi;importFormat;version;constructor(e){this.version=`SMOKEANDSPECTRE-${e}`}SetupGMElements(){this.mainWindow.innerHTML=`
            <div id="localStorageWarning"></div>
            <div id="tabControls">
                <div class="controlContainer">
                    <button class="view-button selected" id="smokeViewToggle">SMOKE</button>
                    <button class="view-button" id="spectreViewToggle">SPECTRE</button>
                    <button class="view-button" id="settingsViewToggle">SETTINGS</button>
                    <button class="view-button" id="debugViewToggle">INFO</button>
                    <div id="miniButtons">
                        <button class="circle-button" id="processedIndicator"></button>
                        <input type="checkbox" id="vision_checkbox" class="large" title="Enable Dynamic Fog">    
                        <div class="tooltip" id="whatsnewbutton" title="Whats New"><svg id="whatsNewIcon" class="svgclickable" fill="#fff" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 3a7 7 0 100 14 7 7 0 000-14zm-9 7a9 9 0 1118 0 9 9 0 01-18 0zm8-4a1 1 0 011-1h.01a1 1 0 110 2H10a1 1 0 01-1-1zm.01 8a1 1 0 102 0V9a1 1 0 10-2 0v5z"/></svg></div>
                    </div>
                </div>
            </div>
            <div id="smokeViewPanel" class="panel"></div>
            <div id="spectreViewPanel" class="panel" style="display: none;"></div>
            <div id="settingsViewPanel" class="panel" style="display: none;"></div>
            <div id="debugViewPanel" class="panel" style="display: none;"></div>
        `,this.mainWindow.parentElement.style.placeItems="start",this.smokeViewToggle=document.getElementById("smokeViewToggle"),this.spectreViewToggle=document.getElementById("spectreViewToggle"),this.settingsViewToggle=document.getElementById("settingsViewToggle"),this.debugViewToggle=document.getElementById("debugViewToggle"),this.smokeViewPanel=document.getElementById("smokeViewPanel"),this.spectreViewPanel=document.getElementById("spectreViewPanel"),this.settingsViewPanel=document.getElementById("settingsViewPanel"),this.debugViewPanel=document.getElementById("debugViewPanel"),this.smokeViewPanel.innerHTML=s.SMOKEHTML,this.spectreViewPanel.innerHTML=s.SPECTREHTML,this.settingsViewPanel.innerHTML=s.SETTINGSHTML,this.debugViewPanel.innerHTML=s.DEBUGHTML,this.mainUIDiv=document.getElementById("main-ui"),this.settingsUIDiv=document.getElementById("settings-ui"),this.visionCheckbox=document.getElementById("vision_checkbox"),this.hiddenListToggle=document.getElementById("hideListToggle"),this.snapCheckbox=document.getElementById("snap_checkbox"),this.table=document.getElementById("token_list"),this.hiddenTable=document.getElementById("hidden_list"),this.message=document.getElementById("no_tokens_message"),this.mapHeight=document.getElementById("mapHeight"),this.mapWidth=document.getElementById("mapWidth"),this.mapSubmit=document.getElementById("mapSubmit"),this.whatsNewButton=document.getElementById("whatsnewbutton"),this.whatsNewIcon=document.getElementById("whatsNewIcon"),this.processedIndicator=document.getElementById("processedIndicator"),this.persistenceCheckbox=document.getElementById("persistence_checkbox"),this.autodetectCheckbox=document.getElementById("autodetect_checkbox"),this.fowCheckbox=document.getElementById("fow_checkbox"),this.doorCheckbox=document.getElementById("door_checkbox"),this.fowColor=document.getElementById("fow_color"),this.resetButton=document.getElementById("persistence_reset"),this.convertButton=document.getElementById("convert_button"),this.boundryOptions=document.getElementById("boundry_options"),this.backgroundButton=document.getElementById("background_button"),this.lockFogButton=document.getElementById("lock_button"),this.unlockFogButton=document.getElementById("unlock_button"),this.toolWidth=document.getElementById("tool_width"),this.toolColor=document.getElementById("tool_color"),this.toolStyle=document.getElementById("tool_style"),this.defaultMELDepth=document.getElementById("default_mel_depth"),this.importButton=document.getElementById("import_button"),this.importFile=document.getElementById("import_file"),this.mapAlign=document.getElementById("map_align"),this.importErrors=document.getElementById("import_errors"),this.dpiAutodetect=document.getElementById("dpi_autodetect"),this.importDpi=document.getElementById("import_dpi"),this.importFormat=document.getElementById("import_format");const e=document.getElementById("playerListing");e.appendChild(this.GetEmptyContextItem());for(const t of p.party){const i=document.createElement("li");i.id=t.id,i.textContent=t.name,i.style.color=t.color,e.appendChild(i)}ot.init(),Vr()}async SetupPlayerElements(){this.mainWindow.innerHTML=`<div class="title">Configuration via GM.
            <div class="tooltip" id="helpButton" title="Need Help?"></div>
            </div>
            <hr><sub>You must have ownership of a token to see it.</sub></br></br>Tokens Owned By You:<div id="playerOwnedTokens"></div><div id="localStorageWarning"></div>`,await b.action.setHeight(300),await b.action.setWidth(350),this.playerListContainer=document.getElementById("playerOwnedTokens");const e=document.getElementById("helpButton"),t=document.createElement("input");t.classList.add("clickable"),t.src="/help.svg",t.height=15,t.width=15,t.type="image",t.title="Need Help?",t.onclick=async function(){await b.modal.open({id:s.EXTENSIONWHATSNEW,url:"/pages/whatsnew.html?gethelp=true",height:500,width:350})},e.appendChild(t)}GetEmptyContextItem(){const e=document.createElement("li");return e.id=p.playerId,e.textContent="Self",e}async ResetPersistence(){const e=await b.scene.local.getItems(Gn);await b.scene.local.deleteItems(e.map(i=>i.id));const t=p.sceneMetadata[`${s.EXTENSIONID}/sceneId`];localStorage.removeItem(`${s.EXTENSIONID}/fogCache/${p.playerId}/${t}`),await St()}async UpdateUI(){const e=p.sceneItems.filter(d=>yo(d));Wo(p.sceneMetadata)||(this.defaultMELDepth&&(this.defaultMELDepth.value=p.sceneMetadata[`${s.EXTENSIONID}/defaultMELDepth`]??"0"),this.toolWidth&&(this.toolWidth.value=p.sceneMetadata[`${s.EXTENSIONID}/toolWidth`]??"8"),this.toolColor&&(this.toolColor.value=p.sceneMetadata[`${s.EXTENSIONID}/toolColor`]??"#000000"),this.toolStyle&&(this.toolStyle.value=p.sceneMetadata[`${s.EXTENSIONID}/toolStyle`]==="solid"?"solid":"dotted"),this.visionCheckbox&&(this.visionCheckbox.checked=p.sceneMetadata[`${s.EXTENSIONID}/visionEnabled`]==!0),this.autodetectCheckbox&&(this.autodetectCheckbox.checked=p.sceneMetadata[`${s.EXTENSIONID}/autodetectEnabled`]==!0),this.persistenceCheckbox&&(this.persistenceCheckbox.checked=p.sceneMetadata[`${s.EXTENSIONID}/persistenceEnabled`]==!0),this.fowCheckbox&&(this.fowCheckbox.checked=p.sceneMetadata[`${s.EXTENSIONID}/fowEnabled`]==!0),this.doorCheckbox&&(this.doorCheckbox.checked=p.sceneMetadata[`${s.EXTENSIONID}/playerDoors`]==!0),this.fowColor&&(this.fowColor.value=p.sceneMetadata[`${s.EXTENSIONID}/fowColor`]??"#00000088"),p.sceneMetadata[`${s.EXTENSIONID}/debug`]==!0),this.boundryOptions.style.display=this.autodetectCheckbox.checked?"none":"";const t=p.sceneItems.filter(d=>d.layer==="FOG"&&d.metadata[`${s.EXTENSIONID}/isBackgroundMap`]===!0),i=document.querySelectorAll(".fog-background-entry");for(const d of i){const h=d.id.slice(3);t.find(m=>m.id===h)===void 0&&d.remove()}for(const d of t)if(!document.querySelector(`#bg-${d.id}`)){const m=document.createElement("div");m.id=`bg-${d.id}`,m.className="fog-background-entry grid-3 grid-main",m.style.width="300",m.innerHTML=`<div class="token-name grid-2">${d.name}</div>
                    <div><label title="Unlock this fog background and turn it back into a map"><input type="button" value="Unlock"></label></div>`,document.querySelector("#fog_background_list").appendChild(m),m.querySelector("input").addEventListener("click",async D=>{if(!D||!D.target)return;const M=D.target.parentElement.parentElement.parentElement.id.slice(3);await b.scene.items.updateItems(T=>T.id===M&&T.layer=="FOG"&&T.metadata[`${s.EXTENSIONID}/isBackgroundMap`]===!0,T=>{for(let P=0;P<T.length;P++)T[P].layer="MAP",T[P].disableHit=!1,T[P].locked=!1,T[P].visible=!0,delete T[P].metadata[`${s.EXTENSIONID}/isBackgroundMap`]})})}const o=document.querySelector("#fog_backgrounds");t.length==0?o.style.display="none":o.style.display="block";const a=document.getElementsByClassName("token-table-entry"),r=[];for(const d of a){const h=d.id.slice(3);e.find(m=>m.id===h)===void 0&&r.push(d)}for(const d of r)d.remove();for(const d of e)zo(d)}UpdatePlayerProcessUI(){p.party.every(t=>t.metadata[`${s.EXTENSIONID}/processed`]===!0)?(this.processedIndicator.style.backgroundColor="green",this.processedIndicator.title="Everything looks good."):(this.processedIndicator.style.backgroundColor="red",this.processedIndicator.title="A player is having trouble processing/seeing.")}UpdatePlayerVisionList(){const e=[];for(const t of p.sceneItems)if(Jt(t)&&t.createdUserId===p.playerId){const i=t.metadata[`${s.EXTENSIONID}/hasVision`]!==void 0;e.push(`<li>${t.name}${i?"":": <b>Vision Disabled</b>"}</li>`)}e.length===0&&e.push("<li>None found.</li>"),this.playerListContainer.innerHTML=`<ul>${e.join("")}</ul>`}HighlightWhatsNew(){let e=localStorage.getItem(this.version);(e==="false"||!e)&&(this.whatsNewIcon?.classList.add("new-shine"),localStorage.setItem(this.version,"true"))}async SoftReset(){p.playerRole==="GM"?(this.SetupGMElements(),Fi(),this.UpdatePlayerProcessUI(),Pn(this.mapAlign),await Promise.all([bi(),Bi(),ut.SetupSpectreGM(),en(!1),this.UpdateUI()])):this.SetupPlayerElements(),p.sceneReady&&(await Fn(),await St())}async Start(){Ko(),p.playerRole==="GM"?(this.SetupGMElements(),Fi(),this.UpdatePlayerProcessUI(),Pn(this.mapAlign),await Promise.all([bi(),Bi(),ut.SetupSpectreGM(),en(!1),this.UpdateUI()])):(await this.SetupPlayerElements(),this.UpdatePlayerVisionList()),await Fn(),await $n(),await St(),ut.SetupLocalSpecterHandlers(),p.SetupHandlers(),this.HighlightWhatsNew()}}const Z=new es("2.70");b.onReady(async()=>{const n=await b.scene.isReady();if(!document.getElementById("papp"))if(n===!1){const t=b.scene.onReadyChange(async i=>{i&&(t(),await Vi())})}else await Vi()});async function Vi(){await p.InitializeCache(),await Z.Start()}export{Ri as i};
