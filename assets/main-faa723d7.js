import{C as m,O as P,b as kt,a as wt,i as Er,c as Vn,d as zt}from"./constants-60dbadaa.js";var Sn=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function Un(i){return i&&i.__esModule&&Object.prototype.hasOwnProperty.call(i,"default")?i.default:i}function wr(i){if(i.__esModule)return i;var e=i.default;if(typeof e=="function"){var t=function n(){return this instanceof n?Reflect.construct(e,arguments,this.constructor):e.apply(this,arguments)};t.prototype=e.prototype}else t={};return Object.defineProperty(t,"__esModule",{value:!0}),Object.keys(i).forEach(function(n){var o=Object.getOwnPropertyDescriptor(i,n);Object.defineProperty(t,n,o.get?o:{enumerable:!0,get:function(){return i[n]}})}),t}function br(i){return i.type==="CURVE"}function sn(i){return i.type==="IMAGE"}function ci(i,e){return Math.round(i/e)*e}function ui(i,e){return Math.floor(i/e)*e}function Ln(i){return i*(Math.PI/180)}function Sr(i){return i*(180/Math.PI)}function di(i,e,t){return i*(1-t)+e*t}class He{static magnitudeSquared(e){return e.x*e.x+e.y*e.y}static magnitude(e){const t=Math.sqrt(this.magnitudeSquared(e));return isNaN(t)?0:t}static normalize(e){const t=this.magnitude(e);return t===0?{x:0,y:0}:this.divide(e,t)}static dot(e,t){return e.x*t.x+e.y*t.y}static subtract(e,t){return typeof t=="number"?{x:e.x-t,y:e.y-t}:{x:e.x-t.x,y:e.y-t.y}}static add(e,t){return typeof t=="number"?{x:e.x+t,y:e.y+t}:{x:e.x+t.x,y:e.y+t.y}}static multiply(e,t){return typeof t=="number"?{x:e.x*t,y:e.y*t}:{x:e.x*t.x,y:e.y*t.y}}static divide(e,t){return typeof t=="number"?{x:e.x/t,y:e.y/t}:{x:e.x/t.x,y:e.y/t.y}}static rotate(e,t,n){const o=Math.cos(Ln(n)),r=Math.sin(Ln(n)),l=this.subtract(e,t);return{x:t.x+o*l.x-r*l.y,y:t.y+r*l.x+o*l.y}}static min(e,t){return typeof t=="number"?{x:Math.min(e.x,t),y:Math.min(e.y,t)}:{x:Math.min(e.x,t.x),y:Math.min(e.y,t.y)}}static componentMin(e){return e.x<e.y?e.x:e.y}static max(e,t){return typeof t=="number"?{x:Math.max(e.x,t),y:Math.max(e.y,t)}:{x:Math.max(e.x,t.x),y:Math.max(e.y,t.y)}}static componentMax(e){return e.x>e.y?e.x:e.y}static roundTo(e,t){return{x:ci(e.x,t.x),y:ci(e.y,t.y)}}static floorTo(e,t){return{x:ui(e.x,t.x),y:ui(e.y,t.y)}}static sign(e){return{x:Math.sign(e.x),y:Math.sign(e.y)}}static abs(e){return{x:Math.abs(e.x),y:Math.abs(e.y)}}static pow(e,t){return typeof t=="number"?{x:Math.pow(e.x,t),y:Math.pow(e.y,t)}:{x:Math.pow(e.x,t.x),y:Math.pow(e.y,t.y)}}static clamp(e,t,n){return{x:Math.min(Math.max(e.x,t),n),y:Math.min(Math.max(e.y,t),n)}}static boundingBox(e){let t=Number.MAX_SAFE_INTEGER,n=Number.MIN_SAFE_INTEGER,o=Number.MAX_SAFE_INTEGER,r=Number.MIN_SAFE_INTEGER;for(let I of e)t=I.x<t?I.x:t,n=I.x>n?I.x:n,o=I.y<o?I.y:o,r=I.y>r?I.y:r;let l=n-t,p=r-o,y={x:(t+n)/2,y:(o+r)/2};return{min:{x:t,y:o},max:{x:n,y:r},width:l,height:p,center:y}}static pointInPolygon(e,t){const n=this.boundingBox(t);if(e.x<n.min.x||e.x>n.max.x||e.y<n.min.y||e.y>n.max.y)return!1;let o=!1;for(let r=0,l=t.length-1;r<t.length;l=r++){const p=t[r].y>e.y,y=t[l].y>e.y;p!==y&&e.x<(t[l].x-t[r].x)*(e.y-t[r].y)/(t[l].y-t[r].y)+t[r].x&&(o=!o)}return o}static compare(e,t,n){return this.magnitudeSquared(this.subtract(e,t))<n*n}static distance(e,t){return this.magnitude(this.subtract(e,t))}static lerp(e,t,n){return{x:di(e.x,t.x,n),y:di(e.y,t.y,n)}}static centroid(e){let t={x:0,y:0};for(let n of e)t.x+=n.x,t.y+=n.y;return e.length>0&&(t={x:t.x/e.length,y:t.y/e.length}),t}}class je{static inverse(e){const[t,n,o,r,l,p,y,I,b]=e,C=t*(l*b-I*p)-n*(r*b-p*y)+o*(r*I-l*y);if(Math.abs(C)<1e-14)return e;const k=1/C,j=(l*b-I*p)*k,T=(o*I-n*b)*k,B=(n*p-o*l)*k,N=(p*y-r*b)*k,R=(t*b-o*y)*k,D=(r*o-t*p)*k,L=(r*I-y*l)*k,X=(y*n-t*I)*k,Z=(t*l-r*n)*k;return[j,T,B,N,R,D,L,X,Z]}static multiply(e,t){return[e[0]*t[0]+e[1]*t[3]+e[2]*t[6],e[0]*t[1]+e[1]*t[4]+e[2]*t[7],e[0]*t[2]+e[1]*t[5]+e[2]*t[8],e[3]*t[0]+e[4]*t[3]+e[5]*t[6],e[3]*t[1]+e[4]*t[4]+e[5]*t[7],e[3]*t[2]+e[4]*t[5]+e[5]*t[8],e[6]*t[0]+e[7]*t[3]+e[8]*t[6],e[6]*t[1]+e[7]*t[4]+e[8]*t[7],e[6]*t[2]+e[7]*t[5]+e[8]*t[8]]}static fromPosition(e){return[1,0,e.x,0,1,e.y,0,0,1]}static fromRotation(e){const t=Ln(e);return[Math.cos(t),-Math.sin(t),0,Math.sin(t),Math.cos(t),0,0,0,1]}static fromScale(e){return[e.x,0,0,0,e.y,0,0,0,1]}static fromItem(e){const t=je.fromPosition(e.position),n=je.fromScale(e.scale),o=je.fromRotation(e.rotation);return je.multiply(je.multiply(t,o),n)}static decompose(e){const[t,n,o,r,l,p]=e,y=t*l-r*n,I={position:{x:o,y:p},rotation:0,scale:{x:1,y:1}};if(t!=0||r!=0){var b=Math.sqrt(t*t+r*r);I.rotation=r>0?Math.acos(t/b):-Math.acos(t/b),I.scale={x:b,y:y/b}}else if(n!=0||l!=0){var C=Math.sqrt(n*n+l*l);I.rotation=Math.PI/2-(l>0?Math.acos(-n/C):-Math.acos(n/C)),I.scale={x:y/C,y:C}}return I.rotation=Sr(I.rotation),I}}class _r{userId;role;items;ghosts;players;metadata;gridDpi;gridScale;gridSnap;fog;ready;snap;initialized;torchActive;lastReset;constructor(){this.userId="",this.role="PLAYER",this.items=[],this.players=[],this.ghosts=[],this.metadata={},this.gridDpi=0,this.gridScale=0,this.gridSnap=10,this.fog={filled:!1,style:{color:"white",strokeWidth:0}},this.ready=!1,this.snap=!0,this.initialized=!1,this.torchActive=!1,this.lastReset=""}}const A=new _r;function Tr(i){return i.layer=="MAP"&&(i.metadata[`${m.EXTENSIONID}/isBackgroundImage`]||i.metadata[`${m.ARMINDOID}/isBackgroundImage`])}function yt(i){return i.metadata[`${m.EXTENSIONID}/isVisionFog`]||i.metadata[`${m.ARMINDOID}/isVisionFog`]}function Or(i){return i.metadata[`${m.EXTENSIONID}/isIndicatorRing`]||i.metadata[`${m.ARMINDOID}/isIndicatorRing`]}function kr(i){return i.metadata[`${m.EXTENSIONID}/isVisionLine`]&&!i.metadata[`${m.EXTENSIONID}/disabled`]||i.metadata[`${m.ARMINDOID}/isVisionLine`]&&!i.metadata[`${m.ARMINDOID}/disabled`]}function xi(i){return(i.layer=="CHARACTER"||i.layer=="ATTACHMENT")&&(i.metadata[`${m.EXTENSIONID}/hasVision`]||i.metadata[`${m.ARMINDOID}/hasVision`])}function Nr(i){return(i.layer=="CHARACTER"||i.layer=="ATTACHMENT")&&(i.metadata[`${m.EXTENSIONID}/hasVision`]||i.metadata[`${m.ARMINDOID}/hasVision`])&&!i.metadata[`${m.EXTENSIONID}/visionBlind`]}function xr(i){return(i.layer=="CHARACTER"||i.layer=="ATTACHMENT")&&i.createdUserId==A.userId&&(i.metadata[`${m.EXTENSIONID}/hasVision`]||i.metadata[`${m.ARMINDOID}/hasVision`])&&!i.metadata[`${m.EXTENSIONID}/visionBlind`]}function Ci(i){return i.layer=="DRAWING"&&(i.metadata[`${m.EXTENSIONID}/isBackgroundImage`]||i.metadata[`${m.ARMINDOID}/isBackgroundImage`])}function Ht(i){return i.metadata[`${m.EXTENSIONID}/isTrailingFog`]}function Mn(i){return i.metadata[`${m.EXTENSIONID}/isTrailingFog`]||i.metadata[`${m.EXTENSIONID}/isVisionFog`]||i.metadata[`${m.ARMINDOID}/isVisionFog`]||i.metadata[`${m.EXTENSIONID}/isIndicatorRing`]}function gt(i){return i.metadata[`${m.EXTENSIONID}/visionTorch`]}function Ai(i){return i.layer=="CHARACTER"&&!xi(i)&&i.metadata[`${m.EXTENSIONID}/hasAutohide`]===!0}var Di={exports:{}};const Cr={},Ar=Object.freeze(Object.defineProperty({__proto__:null,default:Cr},Symbol.toStringTag,{value:"Module"})),_n=wr(Ar);(function(i,e){var t=(()=>{var n=typeof document<"u"&&document.currentScript?document.currentScript.src:void 0;return typeof __filename<"u"&&(n=n||__filename),function(o){o=o||{};var r;r||(r=typeof o<"u"?o:{});var l=Object.assign,p,y;r.ready=new Promise(function(s,a){p=s,y=a}),function(s){var a={};s.loadCmdsTypedArray=function(U){for(var z=0,Y=0;Y<U.length;Y++)z+=U[Y].length;if(a[z])var Q=a[z];else Q=new Float32Array(z),a[z]=Q;var ne=0;for(Y=0;Y<U.length;Y++)for(var Oe=0;Oe<U[Y].length;Oe++){var De=U[Y][Oe];typeof De=="string"&&(De=s.SkBits2FloatUnsigned(parseInt(De))),Q[ne]=De,ne++}return U=s._malloc(Q.length*Q.BYTES_PER_ELEMENT),s.HEAPF32.set(Q,U/Q.BYTES_PER_ELEMENT),[U,z]},s.FromCmds=function(U){U=s.loadCmdsTypedArray(U);var z=s._FromCmds(U[0],U[1]);return s._free(U[0]),z};var u,g,x,M,q;s.cubicYFromX=function(U,z,Y,Q,ne){return u&&g===U&&x===z&&M===Y&&q===Q||(u&&u.delete(),u=new s._SkCubicMap([U,z],[Y,Q]),g=U,x=z,M=Y,q=Q),u.computeYFromX(ne)},s.cubicPtFromT=function(U,z,Y,Q,ne){return u&&g===U&&x===z&&M===Y&&q===Q||(u&&u.delete(),u=new s._SkCubicMap([U,z],[Y,Q]),g=U,x=z,M=Y,q=Q),u.computePtFromT(ne)}}(r),function(s){s.onRuntimeInitialized=function(){s.SkPath.prototype.addPath=function(){var a=arguments[0];if(arguments.length===1)this._addPath(a,1,0,0,0,1,0,0,0,1);else if(arguments.length===2){var u=arguments[1];this._addPath(a,u.a,u.c,u.e,u.b,u.d,u.f,0,0,1)}else if(arguments.length===7)u=arguments,this._addPath(a,u[1],u[3],u[5],u[2],u[4],u[6],0,0,1);else if(arguments.length===10)u=arguments,this._addPath(a,u[1],u[2],u[3],u[4],u[5],u[6],u[7],u[8],u[9]);else return console.Ma("addPath expected to take 1, 2, 7, or 10 args. Got "+arguments.length),null;return this},s.SkPath.prototype.arc=function(a,u,g,x,M,q){return this._arc(a,u,g,x,M,!!q),this},s.SkPath.prototype.arcTo=function(a,u,g,x,M){return this._arcTo(a,u,g,x,M),this},s.SkPath.prototype.bezierCurveTo=function(a,u,g,x,M,q){return this._cubicTo(a,u,g,x,M,q),this},s.SkPath.prototype.close=function(){return this._close(),this},s.SkPath.prototype.closePath=function(){return this._close(),this},s.SkPath.prototype.conicTo=function(a,u,g,x,M){return this._conicTo(a,u,g,x,M),this},s.SkPath.prototype.cubicTo=function(a,u,g,x,M,q){return this._cubicTo(a,u,g,x,M,q),this},s.SkPath.prototype.dash=function(a,u,g){return this._dash(a,u,g)?this:null},s.SkPath.prototype.ellipse=function(a,u,g,x,M,q,U,z){return this._ellipse(a,u,g,x,M,q,U,!!z),this},s.SkPath.prototype.lineTo=function(a,u){return this._lineTo(a,u),this},s.SkPath.prototype.moveTo=function(a,u){return this._moveTo(a,u),this},s.SkPath.prototype.op=function(a,u){return this._op(a,u)?this:null},s.SkPath.prototype.quadraticCurveTo=function(a,u,g,x){return this._quadTo(a,u,g,x),this},s.SkPath.prototype.quadTo=function(a,u,g,x){return this._quadTo(a,u,g,x),this},s.SkPath.prototype.rect=function(a,u,g,x){return this._rect(a,u,g,x),this},s.SkPath.prototype.simplify=function(){return this._simplify()?this:null},s.SkPath.prototype.stroke=function(a){return a=a||{},a.width=a.width||1,a.miter_limit=a.miter_limit||4,a.cap=a.cap||s.StrokeCap.BUTT,a.join=a.join||s.StrokeJoin.MITER,this._stroke(a)?this:null},s.SkPath.prototype.transform=function(){if(arguments.length===1)this._transform(arguments[0]);else if(arguments.length===9){var a=arguments;this._transform(a[0],a[1],a[2],a[3],a[4],a[5],a[6],a[7],a[8])}else return console.Ma("transform expected to take 1 or 9 arguments. Got "+arguments.length),null;return this},s.SkPath.prototype.trim=function(a,u,g){return this._trim(a,u,!!g)?this:null}}}(r);var I=l({},r),b=typeof window=="object",C=typeof importScripts=="function",k="",j,T,B,N,R,D;typeof process=="object"&&typeof process.versions=="object"&&typeof process.versions.node=="string"?(k=C?_n.dirname(k)+"/":__dirname+"/",D=()=>{R||(N=_n,R=_n)},j=function(s,a){return D(),s=R.normalize(s),N.readFileSync(s,a?null:"utf8")},B=s=>(s=j(s,!0),s.buffer||(s=new Uint8Array(s)),s),T=(s,a,u)=>{D(),s=R.normalize(s),N.readFile(s,function(g,x){g?u(g):a(x.buffer)})},1<process.argv.length&&process.argv[1].replace(/\\/g,"/"),process.argv.slice(2),process.on("uncaughtException",function(s){throw s}),process.on("unhandledRejection",function(s){throw s}),r.inspect=function(){return"[Emscripten Module object]"}):(b||C)&&(C?k=self.location.href:typeof document<"u"&&document.currentScript&&(k=document.currentScript.src),n&&(k=n),k.indexOf("blob:")!==0?k=k.substr(0,k.replace(/[?#].*/,"").lastIndexOf("/")+1):k="",j=s=>{var a=new XMLHttpRequest;return a.open("GET",s,!1),a.send(null),a.responseText},C&&(B=s=>{var a=new XMLHttpRequest;return a.open("GET",s,!1),a.responseType="arraybuffer",a.send(null),new Uint8Array(a.response)}),T=(s,a,u)=>{var g=new XMLHttpRequest;g.open("GET",s,!0),g.responseType="arraybuffer",g.onload=()=>{g.status==200||g.status==0&&g.response?a(g.response):u()},g.onerror=u,g.send(null)});var L=r.print||console.log.bind(console),X=r.printErr||console.warn.bind(console);l(r,I),I=null;var Z;r.wasmBinary&&(Z=r.wasmBinary),r.noExitRuntime,typeof WebAssembly!="object"&&oe("no native wasm support detected");var O,v=!1,h=typeof TextDecoder<"u"?new TextDecoder("utf8"):void 0;function E(s,a,u){var g=a+u;for(u=a;s[u]&&!(u>=g);)++u;if(16<u-a&&s.subarray&&h)return h.decode(s.subarray(a,u));for(g="";a<u;){var x=s[a++];if(x&128){var M=s[a++]&63;if((x&224)==192)g+=String.fromCharCode((x&31)<<6|M);else{var q=s[a++]&63;x=(x&240)==224?(x&15)<<12|M<<6|q:(x&7)<<18|M<<12|q<<6|s[a++]&63,65536>x?g+=String.fromCharCode(x):(x-=65536,g+=String.fromCharCode(55296|x>>10,56320|x&1023))}}else g+=String.fromCharCode(x)}return g}function d(s,a,u){var g=ae;if(0<u){u=a+u-1;for(var x=0;x<s.length;++x){var M=s.charCodeAt(x);if(55296<=M&&57343>=M){var q=s.charCodeAt(++x);M=65536+((M&1023)<<10)|q&1023}if(127>=M){if(a>=u)break;g[a++]=M}else{if(2047>=M){if(a+1>=u)break;g[a++]=192|M>>6}else{if(65535>=M){if(a+2>=u)break;g[a++]=224|M>>12}else{if(a+3>=u)break;g[a++]=240|M>>18,g[a++]=128|M>>12&63}g[a++]=128|M>>6&63}g[a++]=128|M&63}}g[a]=0}}var _=typeof TextDecoder<"u"?new TextDecoder("utf-16le"):void 0;function $(s,a){for(var u=s>>1,g=u+a/2;!(u>=g)&&$e[u];)++u;if(u<<=1,32<u-s&&_)return _.decode(ae.subarray(s,u));for(u="",g=0;!(g>=a/2);++g){var x=Ie[s+2*g>>1];if(x==0)break;u+=String.fromCharCode(x)}return u}function te(s,a,u){if(u===void 0&&(u=2147483647),2>u)return 0;u-=2;var g=a;u=u<2*s.length?u/2:s.length;for(var x=0;x<u;++x)Ie[a>>1]=s.charCodeAt(x),a+=2;return Ie[a>>1]=0,a-g}function re(s){return 2*s.length}function se(s,a){for(var u=0,g="";!(u>=a/4);){var x=ye[s+4*u>>2];if(x==0)break;++u,65536<=x?(x-=65536,g+=String.fromCharCode(55296|x>>10,56320|x&1023)):g+=String.fromCharCode(x)}return g}function J(s,a,u){if(u===void 0&&(u=2147483647),4>u)return 0;var g=a;u=g+u-4;for(var x=0;x<s.length;++x){var M=s.charCodeAt(x);if(55296<=M&&57343>=M){var q=s.charCodeAt(++x);M=65536+((M&1023)<<10)|q&1023}if(ye[a>>2]=M,a+=4,a+4>u)break}return ye[a>>2]=0,a-g}function ge(s){for(var a=0,u=0;u<s.length;++u){var g=s.charCodeAt(u);55296<=g&&57343>=g&&++u,a+=4}return a}var we,he,ae,Ie,$e,ye,Pe,Ue,Xe;function Re(){var s=O.buffer;we=s,r.HEAP8=he=new Int8Array(s),r.HEAP16=Ie=new Int16Array(s),r.HEAP32=ye=new Int32Array(s),r.HEAPU8=ae=new Uint8Array(s),r.HEAPU16=$e=new Uint16Array(s),r.HEAPU32=Pe=new Uint32Array(s),r.HEAPF32=Ue=new Float32Array(s),r.HEAPF64=Xe=new Float64Array(s)}var K,f=[],c=[],w=[];function F(){var s=r.preRun.shift();f.unshift(s)}var V=0,G=null;r.preloadedImages={},r.preloadedAudios={};function oe(s){throw r.onAbort&&r.onAbort(s),s="Aborted("+s+")",X(s),v=!0,s=new WebAssembly.RuntimeError(s+". Build with -s ASSERTIONS=1 for more info."),y(s),s}function ce(){return le.startsWith("data:application/octet-stream;base64,")}var le;if(le="pathkit.wasm",!ce()){var be=le;le=r.locateFile?r.locateFile(be,k):k+be}function Ce(){var s=le;try{if(s==le&&Z)return new Uint8Array(Z);if(B)return B(s);throw"both async and sync fetching of the wasm failed"}catch(a){oe(a)}}function Me(){if(!Z&&(b||C)){if(typeof fetch=="function"&&!le.startsWith("file://"))return fetch(le,{credentials:"same-origin"}).then(function(s){if(!s.ok)throw"failed to load wasm binary file at '"+le+"'";return s.arrayBuffer()}).catch(function(){return Ce()});if(T)return new Promise(function(s,a){T(le,function(u){s(new Uint8Array(u))},a)})}return Promise.resolve().then(function(){return Ce()})}function Se(s){for(;0<s.length;){var a=s.shift();if(typeof a=="function")a(r);else{var u=a.Wa;typeof u=="number"?a.xa===void 0?K.get(u)():K.get(u)(a.xa):u(a.xa===void 0?null:a.xa)}}}var fe={};function me(s){for(;s.length;){var a=s.pop();s.pop()(a)}}function Ze(s){return this.fromWireType(Pe[s>>2])}var ct={},it={},S={};function H(s){if(s===void 0)return"_unknown";s=s.replace(/[^a-zA-Z0-9_]/g,"$");var a=s.charCodeAt(0);return 48<=a&&57>=a?"_"+s:s}function W(s,a){return s=H(s),function(){return a.apply(this,arguments)}}function ee(s){var a=Error,u=W(s,function(g){this.name=s,this.message=g,g=Error(g).stack,g!==void 0&&(this.stack=this.toString()+`
`+g.replace(/^Error(:[^\n]*)?\n/,""))});return u.prototype=Object.create(a.prototype),u.prototype.constructor=u,u.prototype.toString=function(){return this.message===void 0?this.name:this.name+": "+this.message},u}var ue=void 0;function pe(s){throw new ue(s)}function de(s,a,u){function g(U){U=u(U),U.length!==s.length&&pe("Mismatched type converter count");for(var z=0;z<s.length;++z)ot(s[z],U[z])}s.forEach(function(U){S[U]=a});var x=Array(a.length),M=[],q=0;a.forEach(function(U,z){it.hasOwnProperty(U)?x[z]=it[U]:(M.push(U),ct.hasOwnProperty(U)||(ct[U]=[]),ct[U].push(function(){x[z]=it[U],++q,q===M.length&&g(x)}))}),M.length===0&&g(x)}var Ae={};function ve(s){switch(s){case 1:return 0;case 2:return 1;case 4:return 2;case 8:return 3;default:throw new TypeError("Unknown type size: "+s)}}var Be=void 0;function Te(s){for(var a="";ae[s];)a+=Be[ae[s++]];return a}var Fe=void 0;function Ee(s){throw new Fe(s)}function ot(s,a,u={}){if(!("argPackAdvance"in a))throw new TypeError("registerType registeredInstance requires argPackAdvance");var g=a.name;if(s||Ee('type "'+g+'" must have a positive integer typeid pointer'),it.hasOwnProperty(s)){if(u.Qa)return;Ee("Cannot register type '"+g+"' twice")}it[s]=a,delete S[s],ct.hasOwnProperty(s)&&(a=ct[s],delete ct[s],a.forEach(function(x){x()}))}function cn(s){Ee(s.ea.ha.fa.name+" instance already deleted")}var un=!1;function qn(){}function zn(s){--s.count.value,s.count.value===0&&(s.ka?s.ma.la(s.ka):s.ha.fa.la(s.ga))}function bt(s){return typeof FinalizationGroup>"u"?(bt=a=>a,s):(un=new FinalizationGroup(function(a){for(var u=a.next();!u.done;u=a.next())u=u.value,u.ga?zn(u):console.warn("object already deleted: "+u.ga)}),bt=a=>(un.register(a,a.ea,a.ea),a),qn=a=>{un.unregister(a.ea)},bt(s))}var St=void 0,_t=[];function dn(){for(;_t.length;){var s=_t.pop();s.ea.pa=!1,s.delete()}}function ut(){}var Kn={};function Yn(s,a,u){if(s[a].ia===void 0){var g=s[a];s[a]=function(){return s[a].ia.hasOwnProperty(arguments.length)||Ee("Function '"+u+"' called with an invalid number of arguments ("+arguments.length+") - expects one of ("+s[a].ia+")!"),s[a].ia[arguments.length].apply(this,arguments)},s[a].ia=[],s[a].ia[g.ua]=g}}function fn(s,a,u){r.hasOwnProperty(s)?((u===void 0||r[s].ia!==void 0&&r[s].ia[u]!==void 0)&&Ee("Cannot register public name '"+s+"' twice"),Yn(r,s,s),r.hasOwnProperty(u)&&Ee("Cannot register multiple overloads of a function with the same number of arguments ("+u+")!"),r[s].ia[u]=a):(r[s]=a,u!==void 0&&(r[s].Xa=u))}function or(s,a,u,g,x,M,q,U){this.name=s,this.constructor=a,this.qa=u,this.la=g,this.na=x,this.Oa=M,this.ta=q,this.La=U,this.Ta=[]}function pn(s,a,u){for(;a!==u;)a.ta||Ee("Expected null or instance of "+u.name+", got an instance of "+a.name),s=a.ta(s),a=a.na;return s}function ar(s,a){return a===null?(this.Ba&&Ee("null is not a valid "+this.name),0):(a.ea||Ee('Cannot pass "'+vn(a)+'" as a '+this.name),a.ea.ga||Ee("Cannot pass deleted object as a pointer of type "+this.name),pn(a.ea.ga,a.ea.ha.fa,this.fa))}function sr(s,a){if(a===null){if(this.Ba&&Ee("null is not a valid "+this.name),this.wa){var u=this.sa();return s!==null&&s.push(this.la,u),u}return 0}if(a.ea||Ee('Cannot pass "'+vn(a)+'" as a '+this.name),a.ea.ga||Ee("Cannot pass deleted object as a pointer of type "+this.name),!this.va&&a.ea.ha.va&&Ee("Cannot convert argument of type "+(a.ea.ma?a.ea.ma.name:a.ea.ha.name)+" to parameter type "+this.name),u=pn(a.ea.ga,a.ea.ha.fa,this.fa),this.wa)switch(a.ea.ka===void 0&&Ee("Passing raw pointer to smart pointer is illegal"),this.Va){case 0:a.ea.ma===this?u=a.ea.ka:Ee("Cannot convert argument of type "+(a.ea.ma?a.ea.ma.name:a.ea.ha.name)+" to parameter type "+this.name);break;case 1:u=a.ea.ka;break;case 2:if(a.ea.ma===this)u=a.ea.ka;else{var g=a.clone();u=this.Ua(u,dt(function(){g.delete()})),s!==null&&s.push(this.la,u)}break;default:Ee("Unsupporting sharing policy")}return u}function lr(s,a){return a===null?(this.Ba&&Ee("null is not a valid "+this.name),0):(a.ea||Ee('Cannot pass "'+vn(a)+'" as a '+this.name),a.ea.ga||Ee("Cannot pass deleted object as a pointer of type "+this.name),a.ea.ha.va&&Ee("Cannot convert argument of type "+a.ea.ha.name+" to parameter type "+this.name),pn(a.ea.ga,a.ea.ha.fa,this.fa))}function Zn(s,a,u){return a===u?s:u.na===void 0?null:(s=Zn(s,a,u.na),s===null?null:u.La(s))}var Tt={};function cr(s,a){for(a===void 0&&Ee("ptr should not be undefined");s.na;)a=s.ta(a),s=s.na;return Tt[a]}function At(s,a){return a.ha&&a.ga||pe("makeClassHandle requires ptr and ptrType"),!!a.ma!=!!a.ka&&pe("Both smartPtrType and smartPtr must be specified"),a.count={value:1},bt(Object.create(s,{ea:{value:a}}))}function at(s,a,u,g){this.name=s,this.fa=a,this.Ba=u,this.va=g,this.wa=!1,this.la=this.Ua=this.sa=this.Ia=this.Va=this.Sa=void 0,a.na!==void 0?this.toWireType=sr:(this.toWireType=g?ar:lr,this.ja=null)}function Jn(s,a,u){r.hasOwnProperty(s)||pe("Replacing nonexistant public symbol"),r[s].ia!==void 0&&u!==void 0?r[s].ia[u]=a:(r[s]=a,r[s].ua=u)}function ur(s,a){var u=[];return function(){u.length=arguments.length;for(var g=0;g<arguments.length;g++)u[g]=arguments[g];return s.includes("j")?(g=r["dynCall_"+s],g=u&&u.length?g.apply(null,[a].concat(u)):g.call(null,a)):g=K.get(a).apply(null,u),g}}function We(s,a){s=Te(s);var u=s.includes("j")?ur(s,a):K.get(a);return typeof u!="function"&&Ee("unknown function pointer with signature "+s+": "+a),u}var Qn=void 0;function ei(s){s=ai(s);var a=Te(s);return st(s),a}function Dt(s,a){function u(M){x[M]||it[M]||(S[M]?S[M].forEach(u):(g.push(M),x[M]=!0))}var g=[],x={};throw a.forEach(u),new Qn(s+": "+g.map(ei).join([", "]))}function hn(s,a){for(var u=[],g=0;g<s;g++)u.push(ye[(a>>2)+g]);return u}function mn(s,a,u,g,x){var M=a.length;2>M&&Ee("argTypes array size mismatch! Must at least get return value and 'this' types!");var q=a[1]!==null&&u!==null,U=!1;for(u=1;u<a.length;++u)if(a[u]!==null&&a[u].ja===void 0){U=!0;break}var z=a[0].name!=="void",Y=M-2,Q=Array(Y),ne=[],Oe=[];return function(){if(arguments.length!==Y&&Ee("function "+s+" called with "+arguments.length+" arguments, expected "+Y+" args!"),Oe.length=0,ne.length=q?2:1,ne[0]=x,q){var De=a[1].toWireType(Oe,this);ne[1]=De}for(var ke=0;ke<Y;++ke)Q[ke]=a[ke+2].toWireType(Oe,arguments[ke]),ne.push(Q[ke]);if(ke=g.apply(null,ne),U)me(Oe);else for(var Ge=q?1:2;Ge<a.length;Ge++){var qe=Ge===1?De:Q[Ge-2];a[Ge].ja!==null&&a[Ge].ja(qe)}return De=z?a[0].fromWireType(ke):void 0,De}}var gn=[],rt=[{},{value:void 0},{value:null},{value:!0},{value:!1}];function ti(s){4<s&&--rt[s].Ca===0&&(rt[s]=void 0,gn.push(s))}function yn(s){return s||Ee("Cannot use deleted val. handle = "+s),rt[s].value}function dt(s){switch(s){case void 0:return 1;case null:return 2;case!0:return 3;case!1:return 4;default:var a=gn.length?gn.pop():rt.length;return rt[a]={Ca:1,value:s},a}}function dr(s,a,u){switch(a){case 0:return function(g){return this.fromWireType((u?he:ae)[g])};case 1:return function(g){return this.fromWireType((u?Ie:$e)[g>>1])};case 2:return function(g){return this.fromWireType((u?ye:Pe)[g>>2])};default:throw new TypeError("Unknown integer type: "+s)}}function Pt(s,a){var u=it[s];return u===void 0&&Ee(a+" has unknown type "+ei(s)),u}function vn(s){if(s===null)return"null";var a=typeof s;return a==="object"||a==="array"||a==="function"?s.toString():""+s}function fr(s,a){switch(a){case 2:return function(u){return this.fromWireType(Ue[u>>2])};case 3:return function(u){return this.fromWireType(Xe[u>>3])};default:throw new TypeError("Unknown float type: "+s)}}function pr(s,a,u){switch(a){case 0:return u?function(g){return he[g]}:function(g){return ae[g]};case 1:return u?function(g){return Ie[g>>1]}:function(g){return $e[g>>1]};case 2:return u?function(g){return ye[g>>2]}:function(g){return Pe[g>>2]};default:throw new TypeError("Unknown integer type: "+s)}}var hr={};function In(s){var a=hr[s];return a===void 0?Te(s):a}var En=[];function ni(){function s(a){a.$$$embind_global$$$=a;var u=typeof $$$embind_global$$$=="object"&&a.$$$embind_global$$$===a;return u||delete a.$$$embind_global$$$,u}if(typeof globalThis=="object")return globalThis;if(typeof $$$embind_global$$$=="object"||(typeof Sn=="object"&&s(Sn)?$$$embind_global$$$=Sn:typeof self=="object"&&s(self)&&($$$embind_global$$$=self),typeof $$$embind_global$$$=="object"))return $$$embind_global$$$;throw Error("unable to get global object.")}function mr(s){var a=En.length;return En.push(s),a}function gr(s,a){for(var u=Array(s),g=0;g<s;++g)u[g]=Pt(ye[(a>>2)+g],"parameter "+g);return u}var ii=[];function yr(s){var a=Array(s+1);return function(u,g,x){a[0]=u;for(var M=0;M<s;++M){var q=Pt(ye[(g>>2)+M],"parameter "+M);a[M+1]=q.readValueFromPointer(x),x+=q.argPackAdvance}return u=new(u.bind.apply(u,a)),dt(u)}}var ri={},vr=[null,[],[]];ue=r.InternalError=ee("InternalError");for(var oi=Array(256),$t=0;256>$t;++$t)oi[$t]=String.fromCharCode($t);Be=oi,Fe=r.BindingError=ee("BindingError"),ut.prototype.isAliasOf=function(s){if(!(this instanceof ut&&s instanceof ut))return!1;var a=this.ea.ha.fa,u=this.ea.ga,g=s.ea.ha.fa;for(s=s.ea.ga;a.na;)u=a.ta(u),a=a.na;for(;g.na;)s=g.ta(s),g=g.na;return a===g&&u===s},ut.prototype.clone=function(){if(this.ea.ga||cn(this),this.ea.ra)return this.ea.count.value+=1,this;var s=bt,a=Object,u=a.create,g=Object.getPrototypeOf(this),x=this.ea;return s=s(u.call(a,g,{ea:{value:{count:x.count,pa:x.pa,ra:x.ra,ga:x.ga,ha:x.ha,ka:x.ka,ma:x.ma}}})),s.ea.count.value+=1,s.ea.pa=!1,s},ut.prototype.delete=function(){this.ea.ga||cn(this),this.ea.pa&&!this.ea.ra&&Ee("Object already scheduled for deletion"),qn(this),zn(this.ea),this.ea.ra||(this.ea.ka=void 0,this.ea.ga=void 0)},ut.prototype.isDeleted=function(){return!this.ea.ga},ut.prototype.deleteLater=function(){return this.ea.ga||cn(this),this.ea.pa&&!this.ea.ra&&Ee("Object already scheduled for deletion"),_t.push(this),_t.length===1&&St&&St(dn),this.ea.pa=!0,this},at.prototype.Pa=function(s){return this.Ia&&(s=this.Ia(s)),s},at.prototype.Ga=function(s){this.la&&this.la(s)},at.prototype.argPackAdvance=8,at.prototype.readValueFromPointer=Ze,at.prototype.deleteObject=function(s){s!==null&&s.delete()},at.prototype.fromWireType=function(s){function a(){return this.wa?At(this.fa.qa,{ha:this.Sa,ga:u,ma:this,ka:s}):At(this.fa.qa,{ha:this,ga:s})}var u=this.Pa(s);if(!u)return this.Ga(s),null;var g=cr(this.fa,u);if(g!==void 0)return g.ea.count.value===0?(g.ea.ga=u,g.ea.ka=s,g.clone()):(g=g.clone(),this.Ga(s),g);if(g=this.fa.Oa(u),g=Kn[g],!g)return a.call(this);g=this.va?g.Ja:g.pointerType;var x=Zn(u,this.fa,g.fa);return x===null?a.call(this):this.wa?At(g.fa.qa,{ha:g,ga:x,ma:this,ka:s}):At(g.fa.qa,{ha:g,ga:x})},r.getInheritedInstanceCount=function(){return Object.keys(Tt).length},r.getLiveInheritedInstances=function(){var s=[],a;for(a in Tt)Tt.hasOwnProperty(a)&&s.push(Tt[a]);return s},r.flushPendingDeletes=dn,r.setDelayFunction=function(s){St=s,_t.length&&St&&St(dn)},Qn=r.UnboundTypeError=ee("UnboundTypeError"),r.count_emval_handles=function(){for(var s=0,a=5;a<rt.length;++a)rt[a]!==void 0&&++s;return s},r.get_first_emval=function(){for(var s=5;s<rt.length;++s)if(rt[s]!==void 0)return rt[s];return null};var Ir={r:function(s){var a=fe[s];delete fe[s];var u=a.elements,g=u.length,x=u.map(function(U){return U.Aa}).concat(u.map(function(U){return U.Ea})),M=a.sa,q=a.la;de([s],x,function(U){return u.forEach(function(z,Y){var Q=U[Y],ne=z.ya,Oe=z.za,De=U[Y+g],ke=z.Da,Ge=z.Fa;z.read=qe=>Q.fromWireType(ne(Oe,qe)),z.write=(qe,pt)=>{var Qe=[];ke(Ge,qe,De.toWireType(Qe,pt)),me(Qe)}}),[{name:a.name,fromWireType:function(z){for(var Y=Array(g),Q=0;Q<g;++Q)Y[Q]=u[Q].read(z);return q(z),Y},toWireType:function(z,Y){if(g!==Y.length)throw new TypeError("Incorrect number of tuple elements for "+a.name+": expected="+g+", actual="+Y.length);for(var Q=M(),ne=0;ne<g;++ne)u[ne].write(Q,Y[ne]);return z!==null&&z.push(q,Q),Q},argPackAdvance:8,readValueFromPointer:Ze,ja:q}]})},u:function(s){var a=Ae[s];delete Ae[s];var u=a.sa,g=a.la,x=a.Ha,M=x.map(function(q){return q.Aa}).concat(x.map(function(q){return q.Ea}));de([s],M,function(q){var U={};return x.forEach(function(z,Y){var Q=q[Y],ne=z.ya,Oe=z.za,De=q[Y+x.length],ke=z.Da,Ge=z.Fa;U[z.Na]={read:function(qe){return Q.fromWireType(ne(Oe,qe))},write:function(qe,pt){var Qe=[];ke(Ge,qe,De.toWireType(Qe,pt)),me(Qe)}}}),[{name:a.name,fromWireType:function(z){var Y={},Q;for(Q in U)Y[Q]=U[Q].read(z);return g(z),Y},toWireType:function(z,Y){for(var Q in U)if(!(Q in Y))throw new TypeError('Missing field:  "'+Q+'"');var ne=u();for(Q in U)U[Q].write(ne,Y[Q]);return z!==null&&z.push(g,ne),ne},argPackAdvance:8,readValueFromPointer:Ze,ja:g}]})},z:function(){},F:function(s,a,u,g,x){var M=ve(u);a=Te(a),ot(s,{name:a,fromWireType:function(q){return!!q},toWireType:function(q,U){return U?g:x},argPackAdvance:8,readValueFromPointer:function(q){if(u===1)var U=he;else if(u===2)U=Ie;else if(u===4)U=ye;else throw new TypeError("Unknown boolean type size: "+a);return this.fromWireType(U[q>>M])},ja:null})},l:function(s,a,u,g,x,M,q,U,z,Y,Q,ne,Oe){Q=Te(Q),M=We(x,M),U&&(U=We(q,U)),Y&&(Y=We(z,Y)),Oe=We(ne,Oe);var De=H(Q);fn(De,function(){Dt("Cannot construct "+Q+" due to unbound types",[g])}),de([s,a,u],g?[g]:[],function(ke){if(ke=ke[0],g)var Ge=ke.fa,qe=Ge.qa;else qe=ut.prototype;ke=W(De,function(){if(Object.getPrototypeOf(this)!==pt)throw new Fe("Use 'new' to construct "+Q);if(Qe.oa===void 0)throw new Fe(Q+" has no accessible constructor");var li=Qe.oa[arguments.length];if(li===void 0)throw new Fe("Tried to invoke ctor of "+Q+" with invalid number of parameters ("+arguments.length+") - expected ("+Object.keys(Qe.oa).toString()+") parameters instead!");return li.apply(this,arguments)});var pt=Object.create(qe,{constructor:{value:ke}});ke.prototype=pt;var Qe=new or(Q,ke,pt,Oe,Ge,M,U,Y);Ge=new at(Q,Qe,!0,!1),qe=new at(Q+"*",Qe,!1,!1);var si=new at(Q+" const*",Qe,!1,!0);return Kn[s]={pointerType:qe,Ja:si},Jn(De,ke),[Ge,qe,si]})},i:function(s,a,u,g,x,M){0<a||oe(void 0);var q=hn(a,u);x=We(g,x),de([],[s],function(U){U=U[0];var z="constructor "+U.name;if(U.fa.oa===void 0&&(U.fa.oa=[]),U.fa.oa[a-1]!==void 0)throw new Fe("Cannot register multiple constructors with identical number of parameters ("+(a-1)+") for class '"+U.name+"'! Overload resolution is currently only performed using the parameter count, not actual type info!");return U.fa.oa[a-1]=()=>{Dt("Cannot construct "+U.name+" due to unbound types",q)},de([],q,function(Y){return Y.splice(1,0,null),U.fa.oa[a-1]=mn(z,Y,null,x,M),[]}),[]})},a:function(s,a,u,g,x,M,q,U){var z=hn(u,g);a=Te(a),M=We(x,M),de([],[s],function(Y){function Q(){Dt("Cannot call "+ne+" due to unbound types",z)}Y=Y[0];var ne=Y.name+"."+a;a.startsWith("@@")&&(a=Symbol[a.substring(2)]),U&&Y.fa.Ta.push(a);var Oe=Y.fa.qa,De=Oe[a];return De===void 0||De.ia===void 0&&De.className!==Y.name&&De.ua===u-2?(Q.ua=u-2,Q.className=Y.name,Oe[a]=Q):(Yn(Oe,a,ne),Oe[a].ia[u-2]=Q),de([],z,function(ke){return ke=mn(ne,ke,Y,M,q),Oe[a].ia===void 0?(ke.ua=u-2,Oe[a]=ke):Oe[a].ia[u-2]=ke,[]}),[]})},I:function(s,a,u){s=Te(s),de([],[a],function(g){return g=g[0],r[s]=g.fromWireType(u),[]})},E:function(s,a){a=Te(a),ot(s,{name:a,fromWireType:function(u){var g=yn(u);return ti(u),g},toWireType:function(u,g){return dt(g)},argPackAdvance:8,readValueFromPointer:Ze,ja:null})},h:function(s,a,u,g){function x(){}u=ve(u),a=Te(a),x.values={},ot(s,{name:a,constructor:x,fromWireType:function(M){return this.constructor.values[M]},toWireType:function(M,q){return q.value},argPackAdvance:8,readValueFromPointer:dr(a,u,g),ja:null}),fn(a,x)},k:function(s,a,u){var g=Pt(s,"enum");a=Te(a),s=g.constructor,g=Object.create(g.constructor.prototype,{value:{value:u},constructor:{value:W(g.name+"_"+a,function(){})}}),s.values[u]=g,s[a]=g},q:function(s,a,u){u=ve(u),a=Te(a),ot(s,{name:a,fromWireType:function(g){return g},toWireType:function(g,x){return x},argPackAdvance:8,readValueFromPointer:fr(a,u),ja:null})},f:function(s,a,u,g,x,M){var q=hn(a,u);s=Te(s),x=We(g,x),fn(s,function(){Dt("Cannot call "+s+" due to unbound types",q)},a-1),de([],q,function(U){return U=[U[0],null].concat(U.slice(1)),Jn(s,mn(s,U,null,x,M),a-1),[]})},e:function(s,a,u,g,x){a=Te(a),x===-1&&(x=4294967295),x=ve(u);var M=U=>U;if(g===0){var q=32-8*u;M=U=>U<<q>>>q}u=a.includes("unsigned")?function(U,z){return z>>>0}:function(U,z){return z},ot(s,{name:a,fromWireType:M,toWireType:u,argPackAdvance:8,readValueFromPointer:pr(a,x,g!==0),ja:null})},b:function(s,a,u){function g(M){M>>=2;var q=Pe;return new x(we,q[M+1],q[M])}var x=[Int8Array,Uint8Array,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array][a];u=Te(u),ot(s,{name:u,fromWireType:g,argPackAdvance:8,readValueFromPointer:g},{Qa:!0})},p:function(s,a){a=Te(a);var u=a==="std::string";ot(s,{name:a,fromWireType:function(g){var x=Pe[g>>2];if(u)for(var M=g+4,q=0;q<=x;++q){var U=g+4+q;if(q==x||ae[U]==0){if(M=M?E(ae,M,U-M):"",z===void 0)var z=M;else z+=String.fromCharCode(0),z+=M;M=U+1}}else{for(z=Array(x),q=0;q<x;++q)z[q]=String.fromCharCode(ae[g+4+q]);z=z.join("")}return st(g),z},toWireType:function(g,x){x instanceof ArrayBuffer&&(x=new Uint8Array(x));var M=typeof x=="string";M||x instanceof Uint8Array||x instanceof Uint8ClampedArray||x instanceof Int8Array||Ee("Cannot pass non-string to std::string");var q=(u&&M?()=>{for(var Y=0,Q=0;Q<x.length;++Q){var ne=x.charCodeAt(Q);55296<=ne&&57343>=ne&&(ne=65536+((ne&1023)<<10)|x.charCodeAt(++Q)&1023),127>=ne?++Y:Y=2047>=ne?Y+2:65535>=ne?Y+3:Y+4}return Y}:()=>x.length)(),U=wn(4+q+1);if(Pe[U>>2]=q,u&&M)d(x,U+4,q+1);else if(M)for(M=0;M<q;++M){var z=x.charCodeAt(M);255<z&&(st(U),Ee("String has UTF-16 code units that do not fit in 8 bits")),ae[U+4+M]=z}else for(M=0;M<q;++M)ae[U+4+M]=x[M];return g!==null&&g.push(st,U),U},argPackAdvance:8,readValueFromPointer:Ze,ja:function(g){st(g)}})},m:function(s,a,u){if(u=Te(u),a===2)var g=$,x=te,M=re,q=()=>$e,U=1;else a===4&&(g=se,x=J,M=ge,q=()=>Pe,U=2);ot(s,{name:u,fromWireType:function(z){for(var Y=Pe[z>>2],Q=q(),ne,Oe=z+4,De=0;De<=Y;++De){var ke=z+4+De*a;(De==Y||Q[ke>>U]==0)&&(Oe=g(Oe,ke-Oe),ne===void 0?ne=Oe:(ne+=String.fromCharCode(0),ne+=Oe),Oe=ke+a)}return st(z),ne},toWireType:function(z,Y){typeof Y!="string"&&Ee("Cannot pass non-string to C++ string type "+u);var Q=M(Y),ne=wn(4+Q+a);return Pe[ne>>2]=Q>>U,x(Y,ne+4,Q+a),z!==null&&z.push(st,ne),ne},argPackAdvance:8,readValueFromPointer:Ze,ja:function(z){st(z)}})},t:function(s,a,u,g,x,M){fe[s]={name:Te(a),sa:We(u,g),la:We(x,M),elements:[]}},s:function(s,a,u,g,x,M,q,U,z){fe[s].elements.push({Aa:a,ya:We(u,g),za:x,Ea:M,Da:We(q,U),Fa:z})},v:function(s,a,u,g,x,M){Ae[s]={name:Te(a),sa:We(u,g),la:We(x,M),Ha:[]}},j:function(s,a,u,g,x,M,q,U,z,Y){Ae[s].Ha.push({Na:Te(a),Aa:u,ya:We(g,x),za:M,Ea:q,Da:We(U,z),Fa:Y})},G:function(s,a){a=Te(a),ot(s,{Ra:!0,name:a,argPackAdvance:0,fromWireType:function(){},toWireType:function(){}})},d:function(s,a,u,g){s=En[s],a=yn(a),u=In(u),s(a,u,null,g)},J:ti,x:function(s){return s===0?dt(ni()):(s=In(s),dt(ni()[s]))},c:function(s,a){var u=gr(s,a),g=u[0];a=g.name+"_$"+u.slice(1).map(function(q){return q.name}).join("_")+"$";var x=ii[a];if(x!==void 0)return x;var M=Array(s-1);return x=mr((q,U,z,Y)=>{for(var Q=0,ne=0;ne<s-1;++ne)M[ne]=u[ne+1].readValueFromPointer(Y+Q),Q+=u[ne+1].argPackAdvance;for(q=q[U].apply(q,M),ne=0;ne<s-1;++ne)u[ne+1].Ka&&u[ne+1].Ka(M[ne]);if(!g.Ra)return g.toWireType(z,q)}),ii[a]=x},n:function(s){4<s&&(rt[s].Ca+=1)},w:function(s,a,u,g){s=yn(s);var x=ri[a];return x||(x=yr(a),ri[a]=x),x(s,u,g)},K:function(){return dt([])},D:function(s){return dt(In(s))},H:function(s,a){return s=Pt(s,"_emval_take_value"),s=s.readValueFromPointer(a),dt(s)},g:function(){oe("")},B:function(s){var a=ae.length;if(s>>>=0,2147483648<s)return!1;for(var u=1;4>=u;u*=2){var g=a*(1+.2/u);g=Math.min(g,s+100663296),g=Math.max(s,g),0<g%65536&&(g+=65536-g%65536);e:{try{O.grow(Math.min(2147483648,g)-we.byteLength+65535>>>16),Re();var x=1;break e}catch{}x=void 0}if(x)return!0}return!1},C:function(){return 0},y:function(){},o:function(s,a,u,g){for(var x=0,M=0;M<u;M++){var q=ye[a>>2],U=ye[a+4>>2];a+=8;for(var z=0;z<U;z++){var Y=ae[q+z],Q=vr[s];Y===0||Y===10?((s===1?L:X)(E(Q,0)),Q.length=0):Q.push(Y)}x+=U}return ye[g>>2]=x,0},A:function(){}};(function(){function s(x){r.asm=x.exports,O=r.asm.L,Re(),K=r.asm._,c.unshift(r.asm.M),V--,r.monitorRunDependencies&&r.monitorRunDependencies(V),V==0&&G&&(x=G,G=null,x())}function a(x){s(x.instance)}function u(x){return Me().then(function(M){return WebAssembly.instantiate(M,g)}).then(function(M){return M}).then(x,function(M){X("failed to asynchronously prepare wasm: "+M),oe(M)})}var g={a:Ir};if(V++,r.monitorRunDependencies&&r.monitorRunDependencies(V),r.instantiateWasm)try{return r.instantiateWasm(g,s)}catch(x){return X("Module.instantiateWasm callback failed with error: "+x),!1}return function(){return Z||typeof WebAssembly.instantiateStreaming!="function"||ce()||le.startsWith("file://")||typeof fetch!="function"?u(a):fetch(le,{credentials:"same-origin"}).then(function(x){return WebAssembly.instantiateStreaming(x,g).then(a,function(M){return X("wasm streaming compile failed: "+M),X("falling back to ArrayBuffer instantiation"),u(a)})})}().catch(y),{}})(),r.___wasm_call_ctors=function(){return(r.___wasm_call_ctors=r.asm.M).apply(null,arguments)},r.__Z6ToCmdsRK6SkPath=function(){return(r.__Z6ToCmdsRK6SkPath=r.asm.N).apply(null,arguments)},r.__Z8FromCmdsmi=function(){return(r.__Z8FromCmdsmi=r.asm.O).apply(null,arguments)},r.__Z7NewPathv=function(){return(r.__Z7NewPathv=r.asm.P).apply(null,arguments)},r.__Z8CopyPathRK6SkPath=function(){return(r.__Z8CopyPathRK6SkPath=r.asm.Q).apply(null,arguments)},r.__Z6EqualsRK6SkPathS1_=function(){return(r.__Z6EqualsRK6SkPathS1_=r.asm.R).apply(null,arguments)},r.__Z11ToSVGStringRK6SkPath=function(){return(r.__Z11ToSVGStringRK6SkPath=r.asm.S).apply(null,arguments)},r.__Z13FromSVGStringNSt3__212basic_stringIcNS_11char_traitsIcEENS_9allocatorIcEEEE=function(){return(r.__Z13FromSVGStringNSt3__212basic_stringIcNS_11char_traitsIcEENS_9allocatorIcEEEE=r.asm.T).apply(null,arguments)},r.__Z13ApplySimplifyR6SkPath=function(){return(r.__Z13ApplySimplifyR6SkPath=r.asm.U).apply(null,arguments)},r.__Z11ApplyPathOpR6SkPathRKS_8SkPathOp=function(){return(r.__Z11ApplyPathOpR6SkPathRKS_8SkPathOp=r.asm.V).apply(null,arguments)},r.__Z10MakeFromOpRK6SkPathS1_8SkPathOp=function(){return(r.__Z10MakeFromOpRK6SkPathS1_8SkPathOp=r.asm.W).apply(null,arguments)},r.__Z14ResolveBuilderR11SkOpBuilder=function(){return(r.__Z14ResolveBuilderR11SkOpBuilder=r.asm.X).apply(null,arguments)},r.__Z8ToCanvasRK6SkPathN10emscripten3valE=function(){return(r.__Z8ToCanvasRK6SkPathN10emscripten3valE=r.asm.Y).apply(null,arguments)},r.__Z8ToPath2DRK6SkPath=function(){return(r.__Z8ToPath2DRK6SkPath=r.asm.Z).apply(null,arguments)};var st=r._free=function(){return(st=r._free=r.asm.$).apply(null,arguments)},wn=r._malloc=function(){return(wn=r._malloc=r.asm.aa).apply(null,arguments)},ai=r.___getTypeName=function(){return(ai=r.___getTypeName=r.asm.ba).apply(null,arguments)};r.___embind_register_native_and_builtin_types=function(){return(r.___embind_register_native_and_builtin_types=r.asm.ca).apply(null,arguments)},r.dynCall_jiji=function(){return(r.dynCall_jiji=r.asm.da).apply(null,arguments)};var Lt;G=function s(){Lt||bn(),Lt||(G=s)};function bn(){function s(){if(!Lt&&(Lt=!0,r.calledRun=!0,!v)){if(Se(c),p(r),r.onRuntimeInitialized&&r.onRuntimeInitialized(),r.postRun)for(typeof r.postRun=="function"&&(r.postRun=[r.postRun]);r.postRun.length;){var a=r.postRun.shift();w.unshift(a)}Se(w)}}if(!(0<V)){if(r.preRun)for(typeof r.preRun=="function"&&(r.preRun=[r.preRun]);r.preRun.length;)F();Se(f),0<V||(r.setStatus?(r.setStatus("Running..."),setTimeout(function(){setTimeout(function(){r.setStatus("")},1),s()},1)):s())}}if(r.run=bn,r.preInit)for(typeof r.preInit=="function"&&(r.preInit=[r.preInit]);0<r.preInit.length;)r.preInit.pop()();return bn(),o.ready}})();i.exports=t})(Di);var Dr=Di.exports;const Pr=Un(Dr),$r="/assets/pathkit-1356ccfa.wasm";class Rn{startTime;accumulatedTime;constructor(){this.startTime=-1,this.accumulatedTime=-1}start(){this.startTime=performance.now(),this.accumulatedTime=0}resume(){this.startTime=performance.now()}pause(){return this.accumulatedTime+=performance.now()-this.startTime,this.startTime=-1,this.accumulatedTime}stop(){if(this.startTime!=-1){const e=performance.now()-this.startTime+this.accumulatedTime;return this.accumulatedTime=0,e}else{const e=this.accumulatedTime;return this.accumulatedTime=0,e}}}function Mt(i){throw new Error('Could not dynamically require "'+i+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var Pi={exports:{}};(function(i,e){(function(t){i.exports=t()})(function(){return function t(n,o,r){function l(I,b){if(!o[I]){if(!n[I]){var C=typeof Mt=="function"&&Mt;if(!b&&C)return C(I,!0);if(p)return p(I,!0);throw new Error("Cannot find module '"+I+"'")}b=o[I]={exports:{}},n[I][0].call(b.exports,function(k){var j=n[I][1][k];return l(j||k)},b,b.exports,t,n,o,r)}return o[I].exports}for(var p=typeof Mt=="function"&&Mt,y=0;y<r.length;y++)l(r[y]);return l}({1:[function(t,n,o){(function(r,l,p,y,I,b,C,k,j){var T=t("crypto");function B(O,v){v=D(O,v);var h;return(h=v.algorithm!=="passthrough"?T.createHash(v.algorithm):new Z).write===void 0&&(h.write=h.update,h.end=h.update),X(v,h).dispatch(O),h.update||h.end(""),h.digest?h.digest(v.encoding==="buffer"?void 0:v.encoding):(O=h.read(),v.encoding!=="buffer"?O.toString(v.encoding):O)}(o=n.exports=B).sha1=function(O){return B(O)},o.keys=function(O){return B(O,{excludeValues:!0,algorithm:"sha1",encoding:"hex"})},o.MD5=function(O){return B(O,{algorithm:"md5",encoding:"hex"})},o.keysMD5=function(O){return B(O,{algorithm:"md5",encoding:"hex",excludeValues:!0})};var N=T.getHashes?T.getHashes().slice():["sha1","md5"],R=(N.push("passthrough"),["buffer","hex","binary","base64"]);function D(O,v){var h={};if(h.algorithm=(v=v||{}).algorithm||"sha1",h.encoding=v.encoding||"hex",h.excludeValues=!!v.excludeValues,h.algorithm=h.algorithm.toLowerCase(),h.encoding=h.encoding.toLowerCase(),h.ignoreUnknown=v.ignoreUnknown===!0,h.respectType=v.respectType!==!1,h.respectFunctionNames=v.respectFunctionNames!==!1,h.respectFunctionProperties=v.respectFunctionProperties!==!1,h.unorderedArrays=v.unorderedArrays===!0,h.unorderedSets=v.unorderedSets!==!1,h.unorderedObjects=v.unorderedObjects!==!1,h.replacer=v.replacer||void 0,h.excludeKeys=v.excludeKeys||void 0,O===void 0)throw new Error("Object argument required.");for(var E=0;E<N.length;++E)N[E].toLowerCase()===h.algorithm.toLowerCase()&&(h.algorithm=N[E]);if(N.indexOf(h.algorithm)===-1)throw new Error('Algorithm "'+h.algorithm+'"  not supported. supported values: '+N.join(", "));if(R.indexOf(h.encoding)===-1&&h.algorithm!=="passthrough")throw new Error('Encoding "'+h.encoding+'"  not supported. supported values: '+R.join(", "));return h}function L(O){if(typeof O=="function")return/^function\s+\w*\s*\(\s*\)\s*{\s+\[native code\]\s+}$/i.exec(Function.prototype.toString.call(O))!=null}function X(O,v,h){h=h||[];function E(d){return v.update?v.update(d,"utf8"):v.write(d,"utf8")}return{dispatch:function(d){return this["_"+((d=O.replacer?O.replacer(d):d)===null?"null":typeof d)](d)},_object:function(d){var _,$=Object.prototype.toString.call(d),te=/\[object (.*)\]/i.exec($);if(te=(te=te?te[1]:"unknown:["+$+"]").toLowerCase(),0<=($=h.indexOf(d)))return this.dispatch("[CIRCULAR:"+$+"]");if(h.push(d),p!==void 0&&p.isBuffer&&p.isBuffer(d))return E("buffer:"),E(d);if(te==="object"||te==="function"||te==="asyncfunction")return $=Object.keys(d),O.unorderedObjects&&($=$.sort()),O.respectType===!1||L(d)||$.splice(0,0,"prototype","__proto__","constructor"),O.excludeKeys&&($=$.filter(function(re){return!O.excludeKeys(re)})),E("object:"+$.length+":"),_=this,$.forEach(function(re){_.dispatch(re),E(":"),O.excludeValues||_.dispatch(d[re]),E(",")});if(!this["_"+te]){if(O.ignoreUnknown)return E("["+te+"]");throw new Error('Unknown object type "'+te+'"')}this["_"+te](d)},_array:function(d,re){re=re!==void 0?re:O.unorderedArrays!==!1;var $=this;if(E("array:"+d.length+":"),!re||d.length<=1)return d.forEach(function(se){return $.dispatch(se)});var te=[],re=d.map(function(se){var J=new Z,ge=h.slice();return X(O,J,ge).dispatch(se),te=te.concat(ge.slice(h.length)),J.read().toString()});return h=h.concat(te),re.sort(),this._array(re,!1)},_date:function(d){return E("date:"+d.toJSON())},_symbol:function(d){return E("symbol:"+d.toString())},_error:function(d){return E("error:"+d.toString())},_boolean:function(d){return E("bool:"+d.toString())},_string:function(d){E("string:"+d.length+":"),E(d.toString())},_function:function(d){E("fn:"),L(d)?this.dispatch("[native]"):this.dispatch(d.toString()),O.respectFunctionNames!==!1&&this.dispatch("function-name:"+String(d.name)),O.respectFunctionProperties&&this._object(d)},_number:function(d){return E("number:"+d.toString())},_xml:function(d){return E("xml:"+d.toString())},_null:function(){return E("Null")},_undefined:function(){return E("Undefined")},_regexp:function(d){return E("regex:"+d.toString())},_uint8array:function(d){return E("uint8array:"),this.dispatch(Array.prototype.slice.call(d))},_uint8clampedarray:function(d){return E("uint8clampedarray:"),this.dispatch(Array.prototype.slice.call(d))},_int8array:function(d){return E("int8array:"),this.dispatch(Array.prototype.slice.call(d))},_uint16array:function(d){return E("uint16array:"),this.dispatch(Array.prototype.slice.call(d))},_int16array:function(d){return E("int16array:"),this.dispatch(Array.prototype.slice.call(d))},_uint32array:function(d){return E("uint32array:"),this.dispatch(Array.prototype.slice.call(d))},_int32array:function(d){return E("int32array:"),this.dispatch(Array.prototype.slice.call(d))},_float32array:function(d){return E("float32array:"),this.dispatch(Array.prototype.slice.call(d))},_float64array:function(d){return E("float64array:"),this.dispatch(Array.prototype.slice.call(d))},_arraybuffer:function(d){return E("arraybuffer:"),this.dispatch(new Uint8Array(d))},_url:function(d){return E("url:"+d.toString())},_map:function(d){return E("map:"),d=Array.from(d),this._array(d,O.unorderedSets!==!1)},_set:function(d){return E("set:"),d=Array.from(d),this._array(d,O.unorderedSets!==!1)},_file:function(d){return E("file:"),this.dispatch([d.name,d.size,d.type,d.lastModfied])},_blob:function(){if(O.ignoreUnknown)return E("[blob]");throw Error(`Hashing Blob objects is currently not supported
(see https://github.com/puleos/object-hash/issues/26)
Use "options.replacer" or "options.ignoreUnknown"
`)},_domwindow:function(){return E("domwindow")},_bigint:function(d){return E("bigint:"+d.toString())},_process:function(){return E("process")},_timer:function(){return E("timer")},_pipe:function(){return E("pipe")},_tcp:function(){return E("tcp")},_udp:function(){return E("udp")},_tty:function(){return E("tty")},_statwatcher:function(){return E("statwatcher")},_securecontext:function(){return E("securecontext")},_connection:function(){return E("connection")},_zlib:function(){return E("zlib")},_context:function(){return E("context")},_nodescript:function(){return E("nodescript")},_httpparser:function(){return E("httpparser")},_dataview:function(){return E("dataview")},_signal:function(){return E("signal")},_fsevent:function(){return E("fsevent")},_tlswrap:function(){return E("tlswrap")}}}function Z(){return{buf:"",write:function(O){this.buf+=O},end:function(O){this.buf+=O},read:function(){return this.buf}}}o.writeToStream=function(O,v,h){return h===void 0&&(h=v,v={}),X(v=D(O,v),h).dispatch(O)}}).call(this,t("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},t("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/fake_9a5aa49d.js","/")},{buffer:3,crypto:5,lYpoI2:11}],2:[function(t,n,o){(function(r,l,p,y,I,b,C,k,j){(function(T){var B=typeof Uint8Array<"u"?Uint8Array:Array,N="+".charCodeAt(0),R="/".charCodeAt(0),D="0".charCodeAt(0),L="a".charCodeAt(0),X="A".charCodeAt(0),Z="-".charCodeAt(0),O="_".charCodeAt(0);function v(h){return h=h.charCodeAt(0),h===N||h===Z?62:h===R||h===O?63:h<D?-1:h<D+10?h-D+26+26:h<X+26?h-X:h<L+26?h-L+26:void 0}T.toByteArray=function(h){var E,d;if(0<h.length%4)throw new Error("Invalid string. Length must be a multiple of 4");var _=h.length,_=h.charAt(_-2)==="="?2:h.charAt(_-1)==="="?1:0,$=new B(3*h.length/4-_),te=0<_?h.length-4:h.length,re=0;function se(J){$[re++]=J}for(E=0;E<te;E+=4,0)se((16711680&(d=v(h.charAt(E))<<18|v(h.charAt(E+1))<<12|v(h.charAt(E+2))<<6|v(h.charAt(E+3))))>>16),se((65280&d)>>8),se(255&d);return _==2?se(255&(d=v(h.charAt(E))<<2|v(h.charAt(E+1))>>4)):_==1&&(se((d=v(h.charAt(E))<<10|v(h.charAt(E+1))<<4|v(h.charAt(E+2))>>2)>>8&255),se(255&d)),$},T.fromByteArray=function(h){var E,d,_,$,te=h.length%3,re="";function se(J){return"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(J)}for(E=0,_=h.length-te;E<_;E+=3)d=(h[E]<<16)+(h[E+1]<<8)+h[E+2],re+=se(($=d)>>18&63)+se($>>12&63)+se($>>6&63)+se(63&$);switch(te){case 1:re=(re+=se((d=h[h.length-1])>>2))+se(d<<4&63)+"==";break;case 2:re=(re=(re+=se((d=(h[h.length-2]<<8)+h[h.length-1])>>10))+se(d>>4&63))+se(d<<2&63)+"="}return re}})(o===void 0?this.base64js={}:o)}).call(this,t("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},t("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/base64-js/lib/b64.js","/node_modules/gulp-browserify/node_modules/base64-js/lib")},{buffer:3,lYpoI2:11}],3:[function(t,n,o){(function(r,l,N,y,I,b,C,k,j){var T=t("base64-js"),B=t("ieee754");function N(f,c,w){if(!(this instanceof N))return new N(f,c,w);var F,V,G,oe,ce=typeof f;if(c==="base64"&&ce=="string")for(f=(oe=f).trim?oe.trim():oe.replace(/^\s+|\s+$/g,"");f.length%4!=0;)f+="=";if(ce=="number")F=we(f);else if(ce=="string")F=N.byteLength(f,c);else{if(ce!="object")throw new Error("First argument needs to be a number, array or string.");F=we(f.length)}if(N._useTypedArrays?V=N._augment(new Uint8Array(F)):((V=this).length=F,V._isBuffer=!0),N._useTypedArrays&&typeof f.byteLength=="number")V._set(f);else if(he(oe=f)||N.isBuffer(oe)||oe&&typeof oe=="object"&&typeof oe.length=="number")for(G=0;G<F;G++)N.isBuffer(f)?V[G]=f.readUInt8(G):V[G]=f[G];else if(ce=="string")V.write(f,0,c);else if(ce=="number"&&!N._useTypedArrays&&!w)for(G=0;G<F;G++)V[G]=0;return V}function R(f,c,w,F){return N._charsWritten=ye(function(V){for(var G=[],oe=0;oe<V.length;oe++)G.push(255&V.charCodeAt(oe));return G}(c),f,w,F)}function D(f,c,w,F){return N._charsWritten=ye(function(V){for(var G,oe,ce=[],le=0;le<V.length;le++)oe=V.charCodeAt(le),G=oe>>8,oe=oe%256,ce.push(oe),ce.push(G);return ce}(c),f,w,F)}function L(f,c,w){var F="";w=Math.min(f.length,w);for(var V=c;V<w;V++)F+=String.fromCharCode(f[V]);return F}function X(f,c,w,G){G||(K(typeof w=="boolean","missing or invalid endian"),K(c!=null,"missing offset"),K(c+1<f.length,"Trying to read beyond buffer length"));var V,G=f.length;if(!(G<=c))return w?(V=f[c],c+1<G&&(V|=f[c+1]<<8)):(V=f[c]<<8,c+1<G&&(V|=f[c+1])),V}function Z(f,c,w,G){G||(K(typeof w=="boolean","missing or invalid endian"),K(c!=null,"missing offset"),K(c+3<f.length,"Trying to read beyond buffer length"));var V,G=f.length;if(!(G<=c))return w?(c+2<G&&(V=f[c+2]<<16),c+1<G&&(V|=f[c+1]<<8),V|=f[c],c+3<G&&(V+=f[c+3]<<24>>>0)):(c+1<G&&(V=f[c+1]<<16),c+2<G&&(V|=f[c+2]<<8),c+3<G&&(V|=f[c+3]),V+=f[c]<<24>>>0),V}function O(f,c,w,F){if(F||(K(typeof w=="boolean","missing or invalid endian"),K(c!=null,"missing offset"),K(c+1<f.length,"Trying to read beyond buffer length")),!(f.length<=c))return F=X(f,c,w,!0),32768&F?-1*(65535-F+1):F}function v(f,c,w,F){if(F||(K(typeof w=="boolean","missing or invalid endian"),K(c!=null,"missing offset"),K(c+3<f.length,"Trying to read beyond buffer length")),!(f.length<=c))return F=Z(f,c,w,!0),2147483648&F?-1*(4294967295-F+1):F}function h(f,c,w,F){return F||(K(typeof w=="boolean","missing or invalid endian"),K(c+3<f.length,"Trying to read beyond buffer length")),B.read(f,c,w,23,4)}function E(f,c,w,F){return F||(K(typeof w=="boolean","missing or invalid endian"),K(c+7<f.length,"Trying to read beyond buffer length")),B.read(f,c,w,52,8)}function d(f,c,w,F,V){if(V||(K(c!=null,"missing value"),K(typeof F=="boolean","missing or invalid endian"),K(w!=null,"missing offset"),K(w+1<f.length,"trying to write beyond buffer length"),Ue(c,65535)),V=f.length,!(V<=w))for(var G=0,oe=Math.min(V-w,2);G<oe;G++)f[w+G]=(c&255<<8*(F?G:1-G))>>>8*(F?G:1-G)}function _(f,c,w,F,V){if(V||(K(c!=null,"missing value"),K(typeof F=="boolean","missing or invalid endian"),K(w!=null,"missing offset"),K(w+3<f.length,"trying to write beyond buffer length"),Ue(c,4294967295)),V=f.length,!(V<=w))for(var G=0,oe=Math.min(V-w,4);G<oe;G++)f[w+G]=c>>>8*(F?G:3-G)&255}function $(f,c,w,F,V){V||(K(c!=null,"missing value"),K(typeof F=="boolean","missing or invalid endian"),K(w!=null,"missing offset"),K(w+1<f.length,"Trying to write beyond buffer length"),Xe(c,32767,-32768)),f.length<=w||d(f,0<=c?c:65535+c+1,w,F,V)}function te(f,c,w,F,V){V||(K(c!=null,"missing value"),K(typeof F=="boolean","missing or invalid endian"),K(w!=null,"missing offset"),K(w+3<f.length,"Trying to write beyond buffer length"),Xe(c,2147483647,-2147483648)),f.length<=w||_(f,0<=c?c:4294967295+c+1,w,F,V)}function re(f,c,w,F,V){V||(K(c!=null,"missing value"),K(typeof F=="boolean","missing or invalid endian"),K(w!=null,"missing offset"),K(w+3<f.length,"Trying to write beyond buffer length"),Re(c,34028234663852886e22,-34028234663852886e22)),f.length<=w||B.write(f,c,w,F,23,4)}function se(f,c,w,F,V){V||(K(c!=null,"missing value"),K(typeof F=="boolean","missing or invalid endian"),K(w!=null,"missing offset"),K(w+7<f.length,"Trying to write beyond buffer length"),Re(c,17976931348623157e292,-17976931348623157e292)),f.length<=w||B.write(f,c,w,F,52,8)}o.Buffer=N,o.SlowBuffer=N,o.INSPECT_MAX_BYTES=50,N.poolSize=8192,N._useTypedArrays=function(){try{var f=new ArrayBuffer(0),c=new Uint8Array(f);return c.foo=function(){return 42},c.foo()===42&&typeof c.subarray=="function"}catch{return!1}}(),N.isEncoding=function(f){switch(String(f).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"binary":case"base64":case"raw":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},N.isBuffer=function(f){return!(f==null||!f._isBuffer)},N.byteLength=function(f,c){var w;switch(f+="",c||"utf8"){case"hex":w=f.length/2;break;case"utf8":case"utf-8":w=Ie(f).length;break;case"ascii":case"binary":case"raw":w=f.length;break;case"base64":w=$e(f).length;break;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":w=2*f.length;break;default:throw new Error("Unknown encoding")}return w},N.concat=function(f,c){if(K(he(f),`Usage: Buffer.concat(list, [totalLength])
list should be an Array.`),f.length===0)return new N(0);if(f.length===1)return f[0];if(typeof c!="number")for(V=c=0;V<f.length;V++)c+=f[V].length;for(var w=new N(c),F=0,V=0;V<f.length;V++){var G=f[V];G.copy(w,F),F+=G.length}return w},N.prototype.write=function(f,c,w,F){isFinite(c)?isFinite(w)||(F=w,w=void 0):(le=F,F=c,c=w,w=le),c=Number(c)||0;var V,G,oe,ce,le=this.length-c;switch((!w||le<(w=Number(w)))&&(w=le),F=String(F||"utf8").toLowerCase()){case"hex":V=function(be,Ce,Me,Se){Me=Number(Me)||0;var fe=be.length-Me;(!Se||fe<(Se=Number(Se)))&&(Se=fe),K((fe=Ce.length)%2==0,"Invalid hex string"),fe/2<Se&&(Se=fe/2);for(var me=0;me<Se;me++){var Ze=parseInt(Ce.substr(2*me,2),16);K(!isNaN(Ze),"Invalid hex string"),be[Me+me]=Ze}return N._charsWritten=2*me,me}(this,f,c,w);break;case"utf8":case"utf-8":G=this,oe=c,ce=w,V=N._charsWritten=ye(Ie(f),G,oe,ce);break;case"ascii":case"binary":V=R(this,f,c,w);break;case"base64":G=this,oe=c,ce=w,V=N._charsWritten=ye($e(f),G,oe,ce);break;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":V=D(this,f,c,w);break;default:throw new Error("Unknown encoding")}return V},N.prototype.toString=function(f,c,w){var F,V,G,oe,ce=this;if(f=String(f||"utf8").toLowerCase(),c=Number(c)||0,(w=w!==void 0?Number(w):ce.length)===c)return"";switch(f){case"hex":F=function(le,be,Ce){var Me=le.length;(!be||be<0)&&(be=0),(!Ce||Ce<0||Me<Ce)&&(Ce=Me);for(var Se="",fe=be;fe<Ce;fe++)Se+=ae(le[fe]);return Se}(ce,c,w);break;case"utf8":case"utf-8":F=function(le,be,Ce){var Me="",Se="";Ce=Math.min(le.length,Ce);for(var fe=be;fe<Ce;fe++)le[fe]<=127?(Me+=Pe(Se)+String.fromCharCode(le[fe]),Se=""):Se+="%"+le[fe].toString(16);return Me+Pe(Se)}(ce,c,w);break;case"ascii":case"binary":F=L(ce,c,w);break;case"base64":V=ce,oe=w,F=(G=c)===0&&oe===V.length?T.fromByteArray(V):T.fromByteArray(V.slice(G,oe));break;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":F=function(le,be,Ce){for(var Me=le.slice(be,Ce),Se="",fe=0;fe<Me.length;fe+=2)Se+=String.fromCharCode(Me[fe]+256*Me[fe+1]);return Se}(ce,c,w);break;default:throw new Error("Unknown encoding")}return F},N.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}},N.prototype.copy=function(f,c,w,F){if(c=c||0,(F=F||F===0?F:this.length)!==(w=w||0)&&f.length!==0&&this.length!==0){K(w<=F,"sourceEnd < sourceStart"),K(0<=c&&c<f.length,"targetStart out of bounds"),K(0<=w&&w<this.length,"sourceStart out of bounds"),K(0<=F&&F<=this.length,"sourceEnd out of bounds"),F>this.length&&(F=this.length);var V=(F=f.length-c<F-w?f.length-c+w:F)-w;if(V<100||!N._useTypedArrays)for(var G=0;G<V;G++)f[G+c]=this[G+w];else f._set(this.subarray(w,w+V),c)}},N.prototype.slice=function(f,c){var w=this.length;if(f=ge(f,w,0),c=ge(c,w,w),N._useTypedArrays)return N._augment(this.subarray(f,c));for(var F=c-f,V=new N(F,void 0,!0),G=0;G<F;G++)V[G]=this[G+f];return V},N.prototype.get=function(f){return console.log(".get() is deprecated. Access using array indexes instead."),this.readUInt8(f)},N.prototype.set=function(f,c){return console.log(".set() is deprecated. Access using array indexes instead."),this.writeUInt8(f,c)},N.prototype.readUInt8=function(f,c){if(c||(K(f!=null,"missing offset"),K(f<this.length,"Trying to read beyond buffer length")),!(f>=this.length))return this[f]},N.prototype.readUInt16LE=function(f,c){return X(this,f,!0,c)},N.prototype.readUInt16BE=function(f,c){return X(this,f,!1,c)},N.prototype.readUInt32LE=function(f,c){return Z(this,f,!0,c)},N.prototype.readUInt32BE=function(f,c){return Z(this,f,!1,c)},N.prototype.readInt8=function(f,c){if(c||(K(f!=null,"missing offset"),K(f<this.length,"Trying to read beyond buffer length")),!(f>=this.length))return 128&this[f]?-1*(255-this[f]+1):this[f]},N.prototype.readInt16LE=function(f,c){return O(this,f,!0,c)},N.prototype.readInt16BE=function(f,c){return O(this,f,!1,c)},N.prototype.readInt32LE=function(f,c){return v(this,f,!0,c)},N.prototype.readInt32BE=function(f,c){return v(this,f,!1,c)},N.prototype.readFloatLE=function(f,c){return h(this,f,!0,c)},N.prototype.readFloatBE=function(f,c){return h(this,f,!1,c)},N.prototype.readDoubleLE=function(f,c){return E(this,f,!0,c)},N.prototype.readDoubleBE=function(f,c){return E(this,f,!1,c)},N.prototype.writeUInt8=function(f,c,w){w||(K(f!=null,"missing value"),K(c!=null,"missing offset"),K(c<this.length,"trying to write beyond buffer length"),Ue(f,255)),c>=this.length||(this[c]=f)},N.prototype.writeUInt16LE=function(f,c,w){d(this,f,c,!0,w)},N.prototype.writeUInt16BE=function(f,c,w){d(this,f,c,!1,w)},N.prototype.writeUInt32LE=function(f,c,w){_(this,f,c,!0,w)},N.prototype.writeUInt32BE=function(f,c,w){_(this,f,c,!1,w)},N.prototype.writeInt8=function(f,c,w){w||(K(f!=null,"missing value"),K(c!=null,"missing offset"),K(c<this.length,"Trying to write beyond buffer length"),Xe(f,127,-128)),c>=this.length||(0<=f?this.writeUInt8(f,c,w):this.writeUInt8(255+f+1,c,w))},N.prototype.writeInt16LE=function(f,c,w){$(this,f,c,!0,w)},N.prototype.writeInt16BE=function(f,c,w){$(this,f,c,!1,w)},N.prototype.writeInt32LE=function(f,c,w){te(this,f,c,!0,w)},N.prototype.writeInt32BE=function(f,c,w){te(this,f,c,!1,w)},N.prototype.writeFloatLE=function(f,c,w){re(this,f,c,!0,w)},N.prototype.writeFloatBE=function(f,c,w){re(this,f,c,!1,w)},N.prototype.writeDoubleLE=function(f,c,w){se(this,f,c,!0,w)},N.prototype.writeDoubleBE=function(f,c,w){se(this,f,c,!1,w)},N.prototype.fill=function(f,c,w){if(c=c||0,w=w||this.length,K(typeof(f=typeof(f=f||0)=="string"?f.charCodeAt(0):f)=="number"&&!isNaN(f),"value is not a number"),K(c<=w,"end < start"),w!==c&&this.length!==0){K(0<=c&&c<this.length,"start out of bounds"),K(0<=w&&w<=this.length,"end out of bounds");for(var F=c;F<w;F++)this[F]=f}},N.prototype.inspect=function(){for(var f=[],c=this.length,w=0;w<c;w++)if(f[w]=ae(this[w]),w===o.INSPECT_MAX_BYTES){f[w+1]="...";break}return"<Buffer "+f.join(" ")+">"},N.prototype.toArrayBuffer=function(){if(typeof Uint8Array>"u")throw new Error("Buffer.toArrayBuffer not supported in this browser");if(N._useTypedArrays)return new N(this).buffer;for(var f=new Uint8Array(this.length),c=0,w=f.length;c<w;c+=1)f[c]=this[c];return f.buffer};var J=N.prototype;function ge(f,c,w){return typeof f!="number"?w:c<=(f=~~f)?c:0<=f||0<=(f+=c)?f:0}function we(f){return(f=~~Math.ceil(+f))<0?0:f}function he(f){return(Array.isArray||function(c){return Object.prototype.toString.call(c)==="[object Array]"})(f)}function ae(f){return f<16?"0"+f.toString(16):f.toString(16)}function Ie(f){for(var c=[],w=0;w<f.length;w++){var F=f.charCodeAt(w);if(F<=127)c.push(f.charCodeAt(w));else for(var V=w,G=(55296<=F&&F<=57343&&w++,encodeURIComponent(f.slice(V,w+1)).substr(1).split("%")),oe=0;oe<G.length;oe++)c.push(parseInt(G[oe],16))}return c}function $e(f){return T.toByteArray(f)}function ye(f,c,w,F){for(var V=0;V<F&&!(V+w>=c.length||V>=f.length);V++)c[V+w]=f[V];return V}function Pe(f){try{return decodeURIComponent(f)}catch{return String.fromCharCode(65533)}}function Ue(f,c){K(typeof f=="number","cannot write a non-number as a number"),K(0<=f,"specified a negative value for writing an unsigned value"),K(f<=c,"value is larger than maximum value for type"),K(Math.floor(f)===f,"value has a fractional component")}function Xe(f,c,w){K(typeof f=="number","cannot write a non-number as a number"),K(f<=c,"value larger than maximum allowed value"),K(w<=f,"value smaller than minimum allowed value"),K(Math.floor(f)===f,"value has a fractional component")}function Re(f,c,w){K(typeof f=="number","cannot write a non-number as a number"),K(f<=c,"value larger than maximum allowed value"),K(w<=f,"value smaller than minimum allowed value")}function K(f,c){if(!f)throw new Error(c||"Failed assertion")}N._augment=function(f){return f._isBuffer=!0,f._get=f.get,f._set=f.set,f.get=J.get,f.set=J.set,f.write=J.write,f.toString=J.toString,f.toLocaleString=J.toString,f.toJSON=J.toJSON,f.copy=J.copy,f.slice=J.slice,f.readUInt8=J.readUInt8,f.readUInt16LE=J.readUInt16LE,f.readUInt16BE=J.readUInt16BE,f.readUInt32LE=J.readUInt32LE,f.readUInt32BE=J.readUInt32BE,f.readInt8=J.readInt8,f.readInt16LE=J.readInt16LE,f.readInt16BE=J.readInt16BE,f.readInt32LE=J.readInt32LE,f.readInt32BE=J.readInt32BE,f.readFloatLE=J.readFloatLE,f.readFloatBE=J.readFloatBE,f.readDoubleLE=J.readDoubleLE,f.readDoubleBE=J.readDoubleBE,f.writeUInt8=J.writeUInt8,f.writeUInt16LE=J.writeUInt16LE,f.writeUInt16BE=J.writeUInt16BE,f.writeUInt32LE=J.writeUInt32LE,f.writeUInt32BE=J.writeUInt32BE,f.writeInt8=J.writeInt8,f.writeInt16LE=J.writeInt16LE,f.writeInt16BE=J.writeInt16BE,f.writeInt32LE=J.writeInt32LE,f.writeInt32BE=J.writeInt32BE,f.writeFloatLE=J.writeFloatLE,f.writeFloatBE=J.writeFloatBE,f.writeDoubleLE=J.writeDoubleLE,f.writeDoubleBE=J.writeDoubleBE,f.fill=J.fill,f.inspect=J.inspect,f.toArrayBuffer=J.toArrayBuffer,f}}).call(this,t("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},t("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/buffer/index.js","/node_modules/gulp-browserify/node_modules/buffer")},{"base64-js":2,buffer:3,ieee754:10,lYpoI2:11}],4:[function(t,n,o){(function(r,l,T,y,I,b,C,k,j){var T=t("buffer").Buffer,B=4,N=new T(B);N.fill(0),n.exports={hash:function(R,D,L,X){for(var Z=D(function(d,_){d.length%B!=0&&($=d.length+(B-d.length%B),d=T.concat([d,N],$));for(var $,te=[],re=_?d.readInt32BE:d.readInt32LE,se=0;se<d.length;se+=B)te.push(re.call(d,se));return te}(R=T.isBuffer(R)?R:new T(R),X),8*R.length),D=X,O=new T(L),v=D?O.writeInt32BE:O.writeInt32LE,h=0;h<Z.length;h++)v.call(O,Z[h],4*h,!0);return O}}}).call(this,t("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},t("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/crypto-browserify/helpers.js","/node_modules/gulp-browserify/node_modules/crypto-browserify")},{buffer:3,lYpoI2:11}],5:[function(t,n,o){(function(r,l,T,y,I,b,C,k,j){var T=t("buffer").Buffer,B=t("./sha"),N=t("./sha256"),R=t("./rng"),D={sha1:B,sha256:N,md5:t("./md5")},L=64,X=new T(L);function Z(d,_){var $=D[d=d||"sha1"],te=[];return $||O("algorithm:",d,"is not yet supported"),{update:function(re){return T.isBuffer(re)||(re=new T(re)),te.push(re),re.length,this},digest:function(re){var se=T.concat(te),se=_?function(J,ge,we){T.isBuffer(ge)||(ge=new T(ge)),T.isBuffer(we)||(we=new T(we)),ge.length>L?ge=J(ge):ge.length<L&&(ge=T.concat([ge,X],L));for(var he=new T(L),ae=new T(L),Ie=0;Ie<L;Ie++)he[Ie]=54^ge[Ie],ae[Ie]=92^ge[Ie];return we=J(T.concat([he,we])),J(T.concat([ae,we]))}($,_,se):$(se);return te=null,re?se.toString(re):se}}}function O(){var d=[].slice.call(arguments).join(" ");throw new Error([d,"we accept pull requests","http://github.com/dominictarr/crypto-browserify"].join(`
`))}X.fill(0),o.createHash=function(d){return Z(d)},o.createHmac=Z,o.randomBytes=function(d,_){if(!_||!_.call)return new T(R(d));try{_.call(this,void 0,new T(R(d)))}catch($){_($)}};var v,h=["createCredentials","createCipher","createCipheriv","createDecipher","createDecipheriv","createSign","createVerify","createDiffieHellman","pbkdf2"],E=function(d){o[d]=function(){O("sorry,",d,"is not implemented yet")}};for(v in h)E(h[v])}).call(this,t("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},t("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/crypto-browserify/index.js","/node_modules/gulp-browserify/node_modules/crypto-browserify")},{"./md5":6,"./rng":7,"./sha":8,"./sha256":9,buffer:3,lYpoI2:11}],6:[function(t,n,o){(function(r,l,p,y,I,b,C,k,j){var T=t("./helpers");function B(O,v){O[v>>5]|=128<<v%32,O[14+(v+64>>>9<<4)]=v;for(var h=1732584193,E=-271733879,d=-1732584194,_=271733878,$=0;$<O.length;$+=16){var te=h,re=E,se=d,J=_,h=R(h,E,d,_,O[$+0],7,-680876936),_=R(_,h,E,d,O[$+1],12,-389564586),d=R(d,_,h,E,O[$+2],17,606105819),E=R(E,d,_,h,O[$+3],22,-1044525330);h=R(h,E,d,_,O[$+4],7,-176418897),_=R(_,h,E,d,O[$+5],12,1200080426),d=R(d,_,h,E,O[$+6],17,-1473231341),E=R(E,d,_,h,O[$+7],22,-45705983),h=R(h,E,d,_,O[$+8],7,1770035416),_=R(_,h,E,d,O[$+9],12,-1958414417),d=R(d,_,h,E,O[$+10],17,-42063),E=R(E,d,_,h,O[$+11],22,-1990404162),h=R(h,E,d,_,O[$+12],7,1804603682),_=R(_,h,E,d,O[$+13],12,-40341101),d=R(d,_,h,E,O[$+14],17,-1502002290),h=D(h,E=R(E,d,_,h,O[$+15],22,1236535329),d,_,O[$+1],5,-165796510),_=D(_,h,E,d,O[$+6],9,-1069501632),d=D(d,_,h,E,O[$+11],14,643717713),E=D(E,d,_,h,O[$+0],20,-373897302),h=D(h,E,d,_,O[$+5],5,-701558691),_=D(_,h,E,d,O[$+10],9,38016083),d=D(d,_,h,E,O[$+15],14,-660478335),E=D(E,d,_,h,O[$+4],20,-405537848),h=D(h,E,d,_,O[$+9],5,568446438),_=D(_,h,E,d,O[$+14],9,-1019803690),d=D(d,_,h,E,O[$+3],14,-187363961),E=D(E,d,_,h,O[$+8],20,1163531501),h=D(h,E,d,_,O[$+13],5,-1444681467),_=D(_,h,E,d,O[$+2],9,-51403784),d=D(d,_,h,E,O[$+7],14,1735328473),h=L(h,E=D(E,d,_,h,O[$+12],20,-1926607734),d,_,O[$+5],4,-378558),_=L(_,h,E,d,O[$+8],11,-2022574463),d=L(d,_,h,E,O[$+11],16,1839030562),E=L(E,d,_,h,O[$+14],23,-35309556),h=L(h,E,d,_,O[$+1],4,-1530992060),_=L(_,h,E,d,O[$+4],11,1272893353),d=L(d,_,h,E,O[$+7],16,-155497632),E=L(E,d,_,h,O[$+10],23,-1094730640),h=L(h,E,d,_,O[$+13],4,681279174),_=L(_,h,E,d,O[$+0],11,-358537222),d=L(d,_,h,E,O[$+3],16,-722521979),E=L(E,d,_,h,O[$+6],23,76029189),h=L(h,E,d,_,O[$+9],4,-640364487),_=L(_,h,E,d,O[$+12],11,-421815835),d=L(d,_,h,E,O[$+15],16,530742520),h=X(h,E=L(E,d,_,h,O[$+2],23,-995338651),d,_,O[$+0],6,-198630844),_=X(_,h,E,d,O[$+7],10,1126891415),d=X(d,_,h,E,O[$+14],15,-1416354905),E=X(E,d,_,h,O[$+5],21,-57434055),h=X(h,E,d,_,O[$+12],6,1700485571),_=X(_,h,E,d,O[$+3],10,-1894986606),d=X(d,_,h,E,O[$+10],15,-1051523),E=X(E,d,_,h,O[$+1],21,-2054922799),h=X(h,E,d,_,O[$+8],6,1873313359),_=X(_,h,E,d,O[$+15],10,-30611744),d=X(d,_,h,E,O[$+6],15,-1560198380),E=X(E,d,_,h,O[$+13],21,1309151649),h=X(h,E,d,_,O[$+4],6,-145523070),_=X(_,h,E,d,O[$+11],10,-1120210379),d=X(d,_,h,E,O[$+2],15,718787259),E=X(E,d,_,h,O[$+9],21,-343485551),h=Z(h,te),E=Z(E,re),d=Z(d,se),_=Z(_,J)}return Array(h,E,d,_)}function N(O,v,h,E,d,_){return Z((v=Z(Z(v,O),Z(E,_)))<<d|v>>>32-d,h)}function R(O,v,h,E,d,_,$){return N(v&h|~v&E,O,v,d,_,$)}function D(O,v,h,E,d,_,$){return N(v&E|h&~E,O,v,d,_,$)}function L(O,v,h,E,d,_,$){return N(v^h^E,O,v,d,_,$)}function X(O,v,h,E,d,_,$){return N(h^(v|~E),O,v,d,_,$)}function Z(O,v){var h=(65535&O)+(65535&v);return(O>>16)+(v>>16)+(h>>16)<<16|65535&h}n.exports=function(O){return T.hash(O,B,16)}}).call(this,t("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},t("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/crypto-browserify/md5.js","/node_modules/gulp-browserify/node_modules/crypto-browserify")},{"./helpers":4,buffer:3,lYpoI2:11}],7:[function(t,n,o){(function(r,l,p,y,I,b,C,k,j){n.exports=function(T){for(var B,N=new Array(T),R=0;R<T;R++)!(3&R)&&(B=4294967296*Math.random()),N[R]=B>>>((3&R)<<3)&255;return N}}).call(this,t("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},t("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/crypto-browserify/rng.js","/node_modules/gulp-browserify/node_modules/crypto-browserify")},{buffer:3,lYpoI2:11}],8:[function(t,n,o){(function(r,l,p,y,I,b,C,k,j){var T=t("./helpers");function B(D,L){D[L>>5]|=128<<24-L%32,D[15+(L+64>>9<<4)]=L;for(var X,Z,O,v=Array(80),h=1732584193,E=-271733879,d=-1732584194,_=271733878,$=-1009589776,te=0;te<D.length;te+=16){for(var re=h,se=E,J=d,ge=_,we=$,he=0;he<80;he++){v[he]=he<16?D[te+he]:R(v[he-3]^v[he-8]^v[he-14]^v[he-16],1);var ae=N(N(R(h,5),(ae=E,Z=d,O=_,(X=he)<20?ae&Z|~ae&O:!(X<40)&&X<60?ae&Z|ae&O|Z&O:ae^Z^O)),N(N($,v[he]),(X=he)<20?1518500249:X<40?1859775393:X<60?-1894007588:-899497514)),$=_,_=d,d=R(E,30),E=h,h=ae}h=N(h,re),E=N(E,se),d=N(d,J),_=N(_,ge),$=N($,we)}return Array(h,E,d,_,$)}function N(D,L){var X=(65535&D)+(65535&L);return(D>>16)+(L>>16)+(X>>16)<<16|65535&X}function R(D,L){return D<<L|D>>>32-L}n.exports=function(D){return T.hash(D,B,20,!0)}}).call(this,t("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},t("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/crypto-browserify/sha.js","/node_modules/gulp-browserify/node_modules/crypto-browserify")},{"./helpers":4,buffer:3,lYpoI2:11}],9:[function(t,n,o){(function(r,l,p,y,I,b,C,k,j){function T(L,X){var Z=(65535&L)+(65535&X);return(L>>16)+(X>>16)+(Z>>16)<<16|65535&Z}function B(L,X){var Z,O=new Array(1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298),v=new Array(1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225),h=new Array(64);L[X>>5]|=128<<24-X%32,L[15+(X+64>>9<<4)]=X;for(var E,d,_=0;_<L.length;_+=16){for(var $=v[0],te=v[1],re=v[2],se=v[3],J=v[4],ge=v[5],we=v[6],he=v[7],ae=0;ae<64;ae++)h[ae]=ae<16?L[ae+_]:T(T(T((d=h[ae-2],R(d,17)^R(d,19)^D(d,10)),h[ae-7]),(d=h[ae-15],R(d,7)^R(d,18)^D(d,3))),h[ae-16]),Z=T(T(T(T(he,R(d=J,6)^R(d,11)^R(d,25)),J&ge^~J&we),O[ae]),h[ae]),E=T(R(E=$,2)^R(E,13)^R(E,22),$&te^$&re^te&re),he=we,we=ge,ge=J,J=T(se,Z),se=re,re=te,te=$,$=T(Z,E);v[0]=T($,v[0]),v[1]=T(te,v[1]),v[2]=T(re,v[2]),v[3]=T(se,v[3]),v[4]=T(J,v[4]),v[5]=T(ge,v[5]),v[6]=T(we,v[6]),v[7]=T(he,v[7])}return v}var N=t("./helpers"),R=function(L,X){return L>>>X|L<<32-X},D=function(L,X){return L>>>X};n.exports=function(L){return N.hash(L,B,32,!0)}}).call(this,t("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},t("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/crypto-browserify/sha256.js","/node_modules/gulp-browserify/node_modules/crypto-browserify")},{"./helpers":4,buffer:3,lYpoI2:11}],10:[function(t,n,o){(function(r,l,p,y,I,b,C,k,j){o.read=function(T,B,N,R,_){var L,X,Z=8*_-R-1,O=(1<<Z)-1,v=O>>1,h=-7,E=N?_-1:0,d=N?-1:1,_=T[B+E];for(E+=d,L=_&(1<<-h)-1,_>>=-h,h+=Z;0<h;L=256*L+T[B+E],E+=d,h-=8);for(X=L&(1<<-h)-1,L>>=-h,h+=R;0<h;X=256*X+T[B+E],E+=d,h-=8);if(L===0)L=1-v;else{if(L===O)return X?NaN:1/0*(_?-1:1);X+=Math.pow(2,R),L-=v}return(_?-1:1)*X*Math.pow(2,L-R)},o.write=function(T,B,N,R,D,$){var X,Z,O=8*$-D-1,v=(1<<O)-1,h=v>>1,E=D===23?Math.pow(2,-24)-Math.pow(2,-77):0,d=R?0:$-1,_=R?1:-1,$=B<0||B===0&&1/B<0?1:0;for(B=Math.abs(B),isNaN(B)||B===1/0?(Z=isNaN(B)?1:0,X=v):(X=Math.floor(Math.log(B)/Math.LN2),B*(R=Math.pow(2,-X))<1&&(X--,R*=2),2<=(B+=1<=X+h?E/R:E*Math.pow(2,1-h))*R&&(X++,R/=2),v<=X+h?(Z=0,X=v):1<=X+h?(Z=(B*R-1)*Math.pow(2,D),X+=h):(Z=B*Math.pow(2,h-1)*Math.pow(2,D),X=0));8<=D;T[N+d]=255&Z,d+=_,Z/=256,D-=8);for(X=X<<D|Z,O+=D;0<O;T[N+d]=255&X,d+=_,X/=256,O-=8);T[N+d-_]|=128*$}}).call(this,t("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},t("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/ieee754/index.js","/node_modules/gulp-browserify/node_modules/ieee754")},{buffer:3,lYpoI2:11}],11:[function(t,n,o){(function(r,l,p,y,I,b,C,k,j){var T,B,N;function R(){}(r=n.exports={}).nextTick=(B=typeof window<"u"&&window.setImmediate,N=typeof window<"u"&&window.postMessage&&window.addEventListener,B?function(D){return window.setImmediate(D)}:N?(T=[],window.addEventListener("message",function(D){var L=D.source;L!==window&&L!==null||D.data!=="process-tick"||(D.stopPropagation(),0<T.length&&T.shift()())},!0),function(D){T.push(D),window.postMessage("process-tick","*")}):function(D){setTimeout(D,0)}),r.title="browser",r.browser=!0,r.env={},r.argv=[],r.on=R,r.addListener=R,r.once=R,r.off=R,r.removeListener=R,r.removeAllListeners=R,r.emit=R,r.binding=function(D){throw new Error("process.binding is not supported")},r.cwd=function(){return"/"},r.chdir=function(D){throw new Error("process.chdir is not supported")}}).call(this,t("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},t("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/process/browser.js","/node_modules/gulp-browserify/node_modules/process")},{buffer:3,lYpoI2:11}]},{},[1])(1)})})(Pi);var Lr=Pi.exports;const Rt=Un(Lr);class Mr{cache;useHash;constructor(e){this.cache={},this.useHash=e}cacheValue(e,t){this.cache[this.useHash?Rt(e):String(e)]=t}deleteValue(e){delete this.cache[this.useHash?Rt(e):String(e)]}getValue(e){return this.cache[this.useHash?Rt(e):String(e)]}isCached(e){return(this.useHash?Rt(e):String(e))in this.cache}invalidate(e){e&&Object.entries(this.cache).forEach(([t,n])=>e(t,n)),this.cache={}}}function Bt(i,e){return(i.x-e.x)*(i.x-e.x)+(i.y-e.y)*(i.y-e.y)}function $i(i,e){return i.x==e.x&&i.y==e.y}function Ft(i,e,t){return t===void 0&&(t=.01),Math.abs(i-e)<=t}function Tn(i,e){return(i%e+e)%e}async function Rr(i){const e=await P.scene.local.getItems(n=>n.metadata[`${m.EXTENSIONID}/doorId`]!==void 0),t=[];for(let n of e){let o=!1;for(const r of i)n.metadata[`${m.EXTENSIONID}/doorId`]==r.id&&(o=!0);o&&t.push(n.id)}await P.scene.local.deleteItems(t)}async function Kt(i){const e=[],t=await P.scene.local.getItems(n=>n.metadata[`${m.EXTENSIONID}/doorId`]!==void 0);for(const n of i){if(!br(n)||t.some(l=>l.metadata[`${m.EXTENSIONID}/doorId`]===n.id))continue;const o=je.fromItem(n),r=[];for(let l=0;l<n.points.length;l++){const p=je.fromPosition(n.points[l]);r.push(je.decompose(je.multiply(o,p)).position)}e.push(kt().locked(!0).commands(Li(n.metadata[`${m.EXTENSIONID}/disabled`]===!0)).scale({x:.2,y:.2}).name("Door").position(He.centroid(r)).metadata({[`${m.EXTENSIONID}/doorId`]:n.id}).build())}e.length>0&&await P.scene.local.addItems(e)}async function Br(i){const e=await P.scene.local.getItems(t=>t.id===i&&t.metadata[`${m.EXTENSIONID}/doorId`]!==void 0);if(e.length===1){const t=e[0].metadata[`${m.EXTENSIONID}/doorId`],n=A.items.filter(o=>o.id===t);await P.scene.items.updateItems(n,o=>{const r=o[0];r.metadata[`${m.EXTENSIONID}/isVisionLine`]&&r.metadata[`${m.EXTENSIONID}/disabled`]?(delete r.metadata[`${m.EXTENSIONID}/disabled`],delete r.metadata[`${m.EXTENSIONID}/doorOpen`]):r.metadata[`${m.EXTENSIONID}/isVisionLine`]&&(r.metadata[`${m.EXTENSIONID}/disabled`]=!0,r.metadata[`${m.EXTENSIONID}/doorOpen`]=!0)}),await P.player.deselect([i])}}async function Fr(){const i=await P.scene.items.getItems(e=>e.metadata[`${m.EXTENSIONID}/isDoor`]===!0);await Kt(i)}function Li(i){return i?m.DOOROPEN:m.DOORCLOSED}function Xr(i,e){return He.pointInPolygon(i[0],e)||He.pointInPolygon(i[0],e)?!0:Xt(i,[e[0],e[1]])||Xt(i,[e[1],e[2]])||Xt(i,[e[2],e[3]])||Xt(i,[e[3],e[0]])}function Xt(i,e){const t=(i[1].x-i[0].x)*(e[1].y-e[0].y)-(e[1].x-e[0].x)*(i[1].y-i[0].y),n=((e[1].y-e[0].y)*(e[1].x-i[0].x)+(e[0].x-e[1].x)*(e[1].y-i[0].y))/t,o=((i[0].y-i[1].y)*(e[1].x-i[0].x)+(i[1].x-i[0].x)*(e[1].y-i[0].y))/t;return n>=0&&n<=1&&o>=0&&o<=1}function Vt(i,e,t){return{x:i.x+e*Math.cos(t),y:i.y+e*Math.sin(t)}}function Vr(i,e,t,n){const o=Math.atan2(i.y-t.y,i.x-t.x);let r=Vt(i,e,o+Math.PI/2),l=Vt(i,e,o-Math.PI/2),p=Vt(t,n,o+Math.PI/2),y=Vt(t,n,o-Math.PI/2);const I=He.normalize(He.subtract(i,t));return r=He.add(r,He.multiply(I,e)),l=He.add(l,He.multiply(I,e)),p=He.add(p,He.multiply(I,0-n)),y=He.add(y,He.multiply(I,0-n)),[r,l,y,p]}function Ur(i){return i.filter(e=>e.points&&e.points.length>1).flatMap(e=>{const t=je.fromItem(e);return e.points.slice(0,-1).map((n,o)=>{const r=je.fromPosition(e.points[o]),l=je.fromPosition(e.points[o+1]),p=je.decompose(je.multiply(t,r)).position,y=je.decompose(je.multiply(t,l)).position;return{startPosition:p,endPosition:y,originalShape:e,oneSided:e.metadata[`${m.EXTENSIONID}/oneSided`]}})})}function jr(i,e,t,n,o,r){let l=[],p=[t,n];const y=A.players.filter(L=>L.role==="GM"),I=[{x:(t+o[0])*r[0],y:o[1]*r[1]},{x:(t+o[0])*r[0],y:(n+o[1])*r[1]},{x:o[0]*r[0],y:(n+o[1])*r[1]},{x:o[0]*r[0],y:o[1]*r[1]}],b=A.gridDpi,C=m.EXTENSIONID,k=e.some(gt);if(e.length===0)return l;for(const L of e){const X=A.userId===L.createdUserId,Z=y.some(d=>d.id===L.createdUserId);if(!X&&A.role!=="GM"&&!Z)continue;const O=L.metadata[`${C}/visionRange`],v=vt.getValue(L.id);if(l.push([]),v!==void 0&&$i(v.player.position,L.position)&&v.player.metadata[`${C}/visionRange`]===O)continue;let h=b*1e3;O&&(h=b*(O/A.gridScale+.5));const E=[];if(k&&!gt(L)){for(const d of e)if(gt(d)){const _=d.metadata[`${m.EXTENSIONID}/visionRange`];let $=1e3*A.gridDpi;_&&($=A.gridDpi*(_/A.gridScale+.5));const te=Vr(L.position,h,d.position,$);E.push(te)}}for(const d of i){const _=(L.position.x-d.startPosition.x)*(d.endPosition.y-d.startPosition.y)-(L.position.y-d.startPosition.y)*(d.endPosition.x-d.startPosition.x);if(d.oneSided!==void 0&&(d.oneSided==="right"&&_>0||d.oneSided==="left"&&_<0))continue;let $=d.startPosition.x,te=d.startPosition.y,re=d.endPosition.x,se=d.endPosition.y;if($<o[0]||te<o[1]||$>o[0]+p[0]||te>o[1]+p[1]||re<o[0]||se<o[1]||re>o[0]+p[0]||se>o[1]+p[1])continue;const J=[d.startPosition,d.endPosition],ge=He.distance(d.startPosition,d.endPosition),he=Math.floor(ge/(h/3));for(let c=1;c<he;c++)J.push(He.lerp(d.startPosition,d.endPosition,c/he));let ae=!0;for(const c of J)if(He.compare(L.position,c,h*1.05)){ae=!1;break}if(ae&&k&&!gt(L)){for(const c of E)if(Xr([d.startPosition,d.endPosition],c)){ae=!1;break}}if(ae)continue;const Ie={x:d.startPosition.x-L.position.x,y:d.startPosition.y-L.position.y},$e={x:d.endPosition.x-L.position.x,y:d.endPosition.y-L.position.y};var j={x:0,y:0},T={x:0,y:0},B=0,N=0,R=0,D=0;//! This is probably not required if we later compute the intersection
//! (using PathKit) of these polygons with a base rectangle the size of
//! our background image
Ie.x<0?B=o[0]*r[0]:B=(t+o[0])*r[0],Ie.y<0?N=o[1]*r[1]:N=(n+o[1])*r[1],$e.x<0?R=o[0]*r[0]:R=(t+o[0])*r[0],$e.y<0?D=o[1]*r[1]:D=(n+o[1])*r[1];const ye=[],Pe=[];if(Ie.x!=0){const c=Ie.y/Ie.x,w=d.startPosition.y-c*d.startPosition.x;ye.push({x:B,y:c*B+w})}if(Ie.y!=0){const c=Ie.x/Ie.y,w=c*d.startPosition.y-d.startPosition.x;ye.push({x:c*N-w,y:N})}if($e.x!=0){const c=$e.y/$e.x,w=d.endPosition.y-c*d.endPosition.x;Pe.push({x:R,y:c*R+w})}if($e.y!=0){const c=$e.x/$e.y,w=c*d.endPosition.y-d.endPosition.x;Pe.push({x:c*D-w,y:D})}ye.length==1||Bt(ye[0],d.startPosition)<Bt(ye[1],d.startPosition)?j=ye[0]:j=ye[1],Pe.length==1||Bt(Pe[0],d.endPosition)<Bt(Pe[1],d.endPosition)?T=Pe[0]:T=Pe[1];const Ue=[{x:d.startPosition.x,y:d.startPosition.y},j,T,{x:d.endPosition.x,y:d.endPosition.y}],Xe=[0,0];let Re=0;for(const c of[j,T])Ft(c.y,o[1]*r[1])?Xe[Re]=0:Ft(c.y,(n+o[1])*r[1])?Xe[Re]=2:Ft(c.x,o[0]*r[0])?Xe[Re]=3:Ft(c.x,(t+o[0])*r[0])&&(Xe[Re]=1),Re++;let K=Math.sign(_);K=K==0?1:-K;const f=K==1?Xe[1]:Tn(Xe[1]-1,4);for(let c=Xe[0]+(K==1?0:-1);Tn(c,4)!=f;c+=K)Ue.splice(Ue.length-2,0,I[Tn(c,4)]);l[l.length-1].push({pointset:Ue,fromShape:d.originalShape})}}return l}const vt=new Mr(!1);var _e,ft=!1;async function Hr(i){if(await P.action.setBadgeText("Working.."),await P.player.setMetadata({[`${m.EXTENSIONID}/processed`]:!1}),ft=!0,_e||(_e=await Pr({locateFile:()=>$r})),!await P.scene.isReady()){vt.invalidate((c,w)=>w.shadowPath.delete()),ft=!1,await P.action.setBadgeText(void 0);return}const e=[];for(let c=0;c<=6;c++)e.push(new Rn);e[1].start();const{awaitTimer:t,computeTimer:n,visionShapes:o,tokensWithVision:r,invalidateCache:l}=i;let p=i.size,y=i.offset,I=i.scale,[b,C]=p;if(A.metadata[`${m.EXTENSIONID}/autodetectEnabled`]===!0){const c=await P.scene.items.getItems(F=>F.layer==="MAP"&&sn(F));let w=[];for(let F of c){let V=A.gridDpi/F.grid.dpi,G=F.position.x-V*F.grid.offset.x*F.scale.x,oe=F.position.y-V*F.grid.offset.y*F.scale.y,ce=G+V*F.image.width*F.scale.x,le=oe+V*F.image.height*F.scale.y;w.length?(G<w[0]&&(w[0]=G),oe<w[1]&&(w[1]=oe),ce>w[2]&&(w[2]=ce),le>w[3]&&(w[3]=le)):(w[0]=G,w[1]=oe,w[2]=ce,w[3]=le)}y=[w[0],w[1]],p=[w[2]-w[0],w[3]-w[1]],I=[1,1],[b,C]=p}let j=0,T=0;if(l&&vt.invalidate((c,w)=>w.shadowPath.delete()),n.resume(),!(A.metadata[`${m.EXTENSIONID}/visionEnabled`]===!0)||r.length==0){const c=await P.scene.local.getItems(Mn);await P.scene.local.deleteItems(c.map(w=>w.id)),ft=!1,await P.action.setBadgeText(void 0);return}const N=Ur(o),R=jr(N,r,b,C,y,I);if(R.length==0){ft=!1,await P.action.setBadgeText(void 0);return}const D=[];e[1].pause(),e[2].start();const L={};for(let c=0;c<R.length;c++){const w=r[c];let F=vt.getValue(w.id);if(F!==void 0&&$i(F.player.position,w.position)&&F.player.metadata[`${m.EXTENSIONID}/visionRange`]===w.metadata[`${m.EXTENSIONID}/visionRange`]){L[c]=F.shadowPath.copy(),j++;continue}T++;const V=R[c],G=new _e.SkOpBuilder,oe=_e.NewPath().rect(y[0],y[1],p[0],p[1]);G.add(oe,_e.PathOp.UNION),oe.delete();for(const le of V){const be=le.fromShape,Ce=[];Ce.push([_e.MOVE_VERB,le.pointset[0].x,le.pointset[0].y]);for(let Se=1;Se<le.pointset.length;Se++)Ce.push([_e.LINE_VERB,le.pointset[Se].x,le.pointset[Se].y]);const Me=_e.FromCmds(Ce);if(be.style.closed!=!1){const Se=[];Se.push([_e.MOVE_VERB,be.points[0].x*be.scale.x+be.position.x,be.points[0].y*be.scale.y+be.position.y]);for(let me=1;me<be.points.length-1;me++)Se.push([_e.LINE_VERB,be.points[me].x*be.scale.x+be.position.x,be.points[me].y*be.scale.y+be.position.y]);const fe=_e.FromCmds(Se);Me.op(fe,_e.PathOp.DIFFERENCE),fe.delete()}G.add(Me,_e.PathOp.DIFFERENCE),Me.delete()}const ce=G.resolve();if(!ce){console.error("Couldn't compute fog"),ft=!1,await P.action.setBadgeText(void 0);return}if(G.delete(),ce!==void 0){ce.simplify(),L[c]=ce;let le=vt.getValue(w.id);le!==void 0&&le.shadowPath.delete(),vt.cacheValue(w.id,{shadowPath:ce.copy(),player:w})}}e[2].pause(),e[3].start();const X=[],Z=_e.NewPath();for(let c=0;c<r.length;c++){const w=r[c],F=w.metadata[`${m.EXTENSIONID}/visionRange`],V=A.players.filter(ce=>ce.role=="GM"),G=A.userId===r[c].createdUserId,oe=V.some(ce=>ce.id==r[c].createdUserId);if(gt(w)?X[c]=!0:Z.op(L[c],_e.PathOp.UNION),F){if(!G&&A.role!=="GM"&&!oe)continue;const ce=A.gridDpi*(F/A.gridScale+.5),le=_e.NewPath().ellipse(w.position.x,w.position.y,ce,ce,0,0,2*Math.PI);L[c]?.op(le,_e.PathOp.INTERSECT),le.delete();const be=A.players.find(Ce=>Ce.id===w.createdUserId);if(be&&A.role==="GM"&&!gt(w)){const Ce=wt().strokeColor(be.color).fillOpacity(0).position({x:w.position.x,y:w.position.y}).width(ce*2).height(ce*2).shapeType("CIRCLE").metadata({[`${m.EXTENSIONID}/isIndicatorRing`]:!0}).build();D.push(Ce)}}}Z.simplify();for(let c=0;c<X.length;c++)X[c]===!0&&(L[c].op(Z,_e.PathOp.INTERSECT),L[c].simplify());Z.delete(),e[3].pause(),e[4].start();const O=[],v=[],h=A.metadata[`${m.EXTENSIONID}/persistenceEnabled`]===!0,E=A.metadata[`${m.EXTENSIONID}/fowEnabled`]===!0,d=A.metadata[`${m.EXTENSIONID}/playerDoors`]===!0,_=_e.NewPath(),$={},te=await P.scene.local.getItems(Mn),re=await P.scene.local.getItems(Or);E&&_.rect(y[0],y[1],p[0],p[1]);let se=h&&A.metadata[`${m.EXTENSIONID}/quality`]=="fast",J=[],ge,we=null;if(se)if(J=te.filter(c=>yt(c)),ge=new _e.SkOpBuilder,$.reuse=!0,J.length===0){const c=kt().commands([]).fillRule("evenodd").locked(!0).visible(!1).fillColor("#000000").strokeColor("#000000").layer("FOG").name("Fog of War").metadata({[`${m.EXTENSIONID}/isVisionFog`]:!0,[`${m.EXTENSIONID}/digest`]:"reuse"}).build();c.zIndex=3,await P.scene.local.addItems([c]),J=await P.scene.local.getItems(yt)}else we=_e.FromCmds(J[0].commands),we.setFillType(_e.FillType.EVENODD);const he=new _e.SkOpBuilder;let ae=!1;for(const c of Object.keys(L)){const w=L[c],V=new TextEncoder().encode(w.toCmds().toString()),G=await crypto.subtle.digest("SHA-1",V).then(ce=>[...new Uint8Array(ce)].map(le=>le.toString(16).padStart(2,"0")).join(""));te.filter(ce=>yt(ce)&&ce.metadata[`${m.EXTENSIONID}/digest`]===G).length===0?se?ge.add(w,_e.PathOp.UNION):O.push({cmds:w.toCmds(),visible:!1,zIndex:3,playerId:r[c].id,digest:G}):$[G]=!0,E&&(_.op(w,_e.PathOp.DIFFERENCE),A.role==="GM"&&(ae=!0,he.add(w,_e.PathOp.UNION))),w.delete()}const Ie=A.metadata[`${m.EXTENSIONID}/sceneId`];if(se){const c=ge.resolve();c.setFillType(_e.FillType.EVENODD),we!==null&&c.op(we,_e.PathOp.UNION);const w=c.toCmds();J.length>0&&await P.scene.local.updateItems([J[0].id],F=>{F.length>0&&(F[0].commands=w)});try{localStorage.setItem(`${m.EXTENSIONID}/fogCache/${A.userId}/${Ie}`,JSON.stringify([{digest:"reuse",commands:w}]))}catch{}we!==null&&we.delete(),c.delete(),ge.delete()}else if(h){const c=te.filter(yt);try{localStorage.setItem(`${m.EXTENSIONID}/fogCache/${A.userId}/${Ie}`,JSON.stringify(c.map(w=>({digest:w.metadata[`${m.EXTENSIONID}/digest`],commands:w.commands}))))}catch{}}let $e;ae&&($e=he.resolve()),he.delete();const ye=te.filter(Ht),Pe=te.filter(c=>{const w=c.metadata[`${m.EXTENSIONID}/digest`];return yt(c)&&$[w]===void 0});if(E){let c=A.metadata[`${m.EXTENSIONID}/fowColor`]?A.metadata[`${m.EXTENSIONID}/fowColor`]:"#00000088",w=.5;c.length==9&&(w=Number.parseInt(c.substring(7),16)/255,c=c.substring(0,7));const F=kt().commands(_.toCmds()).locked(!0).fillRule("evenodd").visible(!0).fillColor(c).fillOpacity(w).strokeWidth(0).strokeColor("#000000").layer("DRAWING").metadata({[`${m.EXTENSIONID}/isTrailingFog`]:!0}).name("Trailing Fog").build();F.disableHit=!0,ye.length>0?await P.scene.local.updateItems(Ht,V=>{for(const G of V)G.commands=F.commands},!1):v.push(P.scene.local.addItems([F]))}else v.push(P.scene.local.deleteItems(te.filter(Ht).map(c=>c.id)));_.delete(),e[4].pause(),e[5].start();const Ue=await P.scene.local.getItems(c=>c.metadata[`${m.EXTENSIONID}/doorId`]!==void 0);d||A.role=="GM"?await Fr():Ue.length>0&&await P.scene.local.deleteItems(Ue.map(c=>c.id));for(const c of Ue){const w=c.metadata[`${m.EXTENSIONID}/doorId`],F=A.items.find(V=>V.id===w);if(F){const G=c.commands.length==m.DOOROPEN.length,oe=!!F.metadata[`${m.EXTENSIONID}/doorOpen`];if(G===oe)continue;v.push(P.scene.local.updateItems([c.id],ce=>{const le=ce[0];Er(le)&&(le.commands=Li(oe))}))}}n.pause(),t.resume(),v.push(P.scene.local.deleteItems(re.map(c=>c.id))),v.push(P.scene.local.addItems(O.map(c=>{const w=kt().commands(c.cmds).fillRule("evenodd").locked(!0).visible(c.visible).fillColor("#000000").strokeColor("#000000").layer("FOG").name("Fog of War").metadata({[`${m.EXTENSIONID}/isVisionFog`]:!0,[`${m.EXTENSIONID}/digest`]:c.digest}).build();return w.zIndex=c.zIndex,w}))),h||v.push(P.scene.local.deleteItems(Pe.map(c=>c.id))),D.length>0&&v.push(P.scene.local.addItems(D)),A.fog.filled||v.push(P.scene.fog.setFilled(!0)),await Promise.all(v);let Xe=0;e[5].pause(),e[6].start(),ae&&(await Wr($e),$e.delete()),e[6].pause();const[Re,K]=[t.stop(),n.stop()],f={compute_time:`${K} ms`,communication_time:`${Re} ms`,cache_hits:j.toString(),cache_misses:T.toString(),item_counter:Xe.toString()};for(let c=1;c<=6;c++){const w=e[c].stop();f["stage"+c]=`${w} ms`}qr(f),ft=!1,await P.player.setMetadata({[`${m.EXTENSIONID}/processed`]:!0}),await P.action.setBadgeText(void 0)}async function Wr(i){const e=[],t=A.items.filter(n=>Ai(n)&&sn(n));i.simplify();for(const n of t){const o=new _e.SkOpBuilder,r=_e.NewPath(),l=A.gridDpi/n.grid.dpi*(n.image.width/2)*n.scale.x;for(let I=0;I<6;I++){const b=I*60*Math.PI/180,C=n.position.x+l*Math.cos(b),k=n.position.y+l*Math.sin(b);I==0?r.moveTo(C,k):r.lineTo(C,k)}r.closePath(),o.add(r,_e.PathOp.UNION),o.add(i,_e.PathOp.INTERSECT);const p=o.resolve(),y=!p.toCmds().length;n.visible==y&&e.push(n),r.delete(),o.delete(),p.delete()}await P.scene.items.updateItems(e.map(n=>n.id),n=>{for(let o=0;o<n.length;o++)n[o].visible=!n[o].visible})}let On,Gr,fi,Ot=[],pi,kn,hi,mi,gi,yi;async function It(i){if(ft||!A.ready||!A.initialized)return;const[e,t]=[new Rn,new Rn];e.start(),e.pause(),t.start();const n=A.players.filter(h=>h.role=="GM"),o=A.items.filter(h=>(h.layer=="CHARACTER"||h.layer=="ATTACHMENT")&&n.some(E=>h.createdUserId===E.id)&&(h.metadata[`${m.EXTENSIONID}/hasVision`]||h.metadata[`${m.ARMINDOID}/hasVision`])&&!h.metadata[`${m.EXTENSIONID}/visionBlind`]),l=(A.role=="GM"?A.items.filter(Nr):A.items.filter(xr).concat(o)).filter(h=>!gt(h)||h.visible===!0),p=A.items.filter(kr),y=A.items.filter(Ai),I=A.items.filter(Ci)?.[0],b=A.metadata[`${m.EXTENSIONID}/visionEnabled`]===!0,C=A.metadata[`${m.EXTENSIONID}/persistenceEnabled`]===!0,k=A.metadata[`${m.EXTENSIONID}/autodetectEnabled`]===!0,j=A.metadata[`${m.EXTENSIONID}/fowEnabled`]===!0,T=A.metadata[`${m.EXTENSIONID}/fowColor`],B=[],N=[],R=[];if(I===void 0?(B[0]=0,B[1]=0,N[0]=1,N[1]=1,R[0]=0,R[1]=0):(B[0]=I.width*I.scale.x,B[1]=I.height*I.scale.y,N[0]=I.scale.x,N[1]=I.scale.y,R[0]=I.position.x,R[1]=I.position.y),A.role=="GM"){const h=document.getElementById("mapHeight"),E=document.getElementById("mapWidth");E.value=(Math.round(B[0])/A.gridDpi).toString(),h.value=(Math.round(B[1])/A.gridDpi).toString()}const D=JSON.stringify(p),L=JSON.stringify(y),X=JSON.stringify(l),Z=JSON.stringify(I);if(Z==kn&&b==pi&&yi==T&&hi==k&&mi==j&&gi==C&&On==D&&Gr==L&&fi==X&&B[0]==Ot[0]&&B[1]==Ot[1]&&i!==!0)return;let O=!1;(Z!=kn||On!=D||B[0]!=Ot[0]||B[1]!=Ot[1])&&(O=!0),kn=Z,fi=X,On=D,Ot=B,pi=b,hi=k,mi=j,yi=T,gi=C,t.pause();const v={awaitTimer:e,computeTimer:t,allItems:A.items,size:B,offset:R,scale:N,tokensWithVision:l,visionShapes:p,invalidateCache:O};ft||await Hr(v)}function qr(i){for(const[e,t]of Object.entries(i)){const n=document.getElementById(e);e=="compute_time"||e=="communication_time"||e[0]=="s"?n&&(n.innerText=Number.parseFloat(t).toFixed(1)+"ms"):n&&(n.innerText=t)}}function Nn(i,e){i.split(/\s+/).forEach(t=>{e(t)})}class zr{constructor(){this._events=void 0,this._events={}}on(e,t){Nn(e,n=>{const o=this._events[n]||[];o.push(t),this._events[n]=o})}off(e,t){var n=arguments.length;if(n===0){this._events={};return}Nn(e,o=>{if(n===1){delete this._events[o];return}const r=this._events[o];r!==void 0&&(r.splice(r.indexOf(t),1),this._events[o]=r)})}trigger(e,...t){var n=this;Nn(e,o=>{const r=n._events[o];r!==void 0&&r.forEach(l=>{l.apply(n,t)})})}}function Kr(i){return i.plugins={},class extends i{constructor(...e){super(...e),this.plugins={names:[],settings:{},requested:{},loaded:{}}}static define(e,t){i.plugins[e]={name:e,fn:t}}initializePlugins(e){var t,n;const o=this,r=[];if(Array.isArray(e))e.forEach(l=>{typeof l=="string"?r.push(l):(o.plugins.settings[l.name]=l.options,r.push(l.name))});else if(e)for(t in e)e.hasOwnProperty(t)&&(o.plugins.settings[t]=e[t],r.push(t));for(;n=r.shift();)o.require(n)}loadPlugin(e){var t=this,n=t.plugins,o=i.plugins[e];if(!i.plugins.hasOwnProperty(e))throw new Error('Unable to find "'+e+'" plugin');n.requested[e]=!0,n.loaded[e]=o.fn.apply(t,[t.plugins.settings[e]||{}]),n.names.push(e)}require(e){var t=this,n=t.plugins;if(!t.plugins.loaded.hasOwnProperty(e)){if(n.requested[e])throw new Error('Plugin has circular dependency ("'+e+'")');t.loadPlugin(e)}return n.loaded[e]}}}/*! @orchidjs/unicode-variants | https://github.com/orchidjs/unicode-variants | Apache License (v2) */const ln=i=>(i=i.filter(Boolean),i.length<2?i[0]||"":Zr(i)==1?"["+i.join("")+"]":"(?:"+i.join("|")+")"),Mi=i=>{if(!Yr(i))return i.join("");let e="",t=0;const n=()=>{t>1&&(e+="{"+t+"}")};return i.forEach((o,r)=>{if(o===i[r-1]){t++;return}n(),e+=o,t=1}),n(),e},Ri=i=>{let e=jn(i);return ln(e)},Yr=i=>new Set(i).size!==i.length,Ct=i=>(i+"").replace(/([\$\(\)\*\+\.\?\[\]\^\{\|\}\\])/gu,"\\$1"),Zr=i=>i.reduce((e,t)=>Math.max(e,Jr(t)),0),Jr=i=>jn(i).length,jn=i=>Array.from(i);/*! @orchidjs/unicode-variants | https://github.com/orchidjs/unicode-variants | Apache License (v2) */const Bi=i=>{if(i.length===1)return[[i]];let e=[];const t=i.substring(1);return Bi(t).forEach(function(o){let r=o.slice(0);r[0]=i.charAt(0)+r[0],e.push(r),r=o.slice(0),r.unshift(i.charAt(0)),e.push(r)}),e};/*! @orchidjs/unicode-variants | https://github.com/orchidjs/unicode-variants | Apache License (v2) */const Qr=[[0,65535]],eo="[-]";let Yt,Fi;const to=3,Hn={},vi={"/":"",0:"",a:"",aa:"",ae:"",ao:"",au:"",av:"",ay:"",b:"",c:"",d:"",e:"",f:"",g:"",h:"",i:"",j:"",k:"",l:"",m:"",n:"",o:"",oe:"",oi:"",oo:"",ou:"",p:"",q:"",r:"",s:"",t:"",th:"",tz:"",u:"",v:"",vy:"",w:"",y:"",z:"",hv:""};for(let i in vi){let e=vi[i]||"";for(let t=0;t<e.length;t++){let n=e.substring(t,t+1);Hn[n]=i}}const no=new RegExp(Object.keys(Hn).join("|")+"|"+eo,"gu"),io=i=>{Yt===void 0&&(Yt=so(i||Qr))},Ii=(i,e="NFKD")=>i.normalize(e),Zt=i=>jn(i).reduce((e,t)=>e+ro(t),""),ro=i=>(i=Ii(i).toLowerCase().replace(no,e=>Hn[e]||""),Ii(i,"NFC"));function*oo(i){for(const[e,t]of i)for(let n=e;n<=t;n++){let o=String.fromCharCode(n),r=Zt(o);r!=o.toLowerCase()&&(r.length>to||r.length!=0&&(yield{folded:r,composed:o,code_point:n}))}}const ao=i=>{const e={},t=(n,o)=>{const r=e[n]||new Set,l=new RegExp("^"+Ri(r)+"$","iu");o.match(l)||(r.add(Ct(o)),e[n]=r)};for(let n of oo(i))t(n.folded,n.folded),t(n.folded,n.composed);return e},so=i=>{const e=ao(i),t={};let n=[];for(let r in e){let l=e[r];l&&(t[r]=Ri(l)),r.length>1&&n.push(Ct(r))}n.sort((r,l)=>l.length-r.length);const o=ln(n);return Fi=new RegExp("^"+o,"u"),t},lo=(i,e=1)=>{let t=0;return i=i.map(n=>(Yt[n]&&(t+=n.length),Yt[n]||n)),t>=e?Mi(i):""},co=(i,e=1)=>(e=Math.max(e,i.length-1),ln(Bi(i).map(t=>lo(t,e)))),Ei=(i,e=!0)=>{let t=i.length>1?1:0;return ln(i.map(n=>{let o=[];const r=e?n.length():n.length()-1;for(let l=0;l<r;l++)o.push(co(n.substrs[l]||"",t));return Mi(o)}))},uo=(i,e)=>{for(const t of e){if(t.start!=i.start||t.end!=i.end||t.substrs.join("")!==i.substrs.join(""))continue;let n=i.parts;const o=l=>{for(const p of n){if(p.start===l.start&&p.substr===l.substr)return!1;if(!(l.length==1||p.length==1)&&(l.start<p.start&&l.end>p.start||p.start<l.start&&p.end>l.start))return!0}return!1};if(!(t.parts.filter(o).length>0))return!0}return!1};class Jt{constructor(){this.parts=[],this.substrs=[],this.start=0,this.end=0}add(e){e&&(this.parts.push(e),this.substrs.push(e.substr),this.start=Math.min(e.start,this.start),this.end=Math.max(e.end,this.end))}last(){return this.parts[this.parts.length-1]}length(){return this.parts.length}clone(e,t){let n=new Jt,o=JSON.parse(JSON.stringify(this.parts)),r=o.pop();for(const y of o)n.add(y);let l=t.substr.substring(0,e-r.start),p=l.length;return n.add({start:r.start,end:r.start+p,length:p,substr:l}),n}}const fo=i=>{io(),i=Zt(i);let e="",t=[new Jt];for(let n=0;n<i.length;n++){let r=i.substring(n).match(Fi);const l=i.substring(n,n+1),p=r?r[0]:null;let y=[],I=new Set;for(const b of t){const C=b.last();if(!C||C.length==1||C.end<=n)if(p){const k=p.length;b.add({start:n,end:n+k,length:k,substr:p}),I.add("1")}else b.add({start:n,end:n+1,length:1,substr:l}),I.add("2");else if(p){let k=b.clone(n,C);const j=p.length;k.add({start:n,end:n+j,length:j,substr:p}),y.push(k)}else I.add("3")}if(y.length>0){y=y.sort((b,C)=>b.length()-C.length());for(let b of y)uo(b,t)||t.push(b);continue}if(n>0&&I.size==1&&!I.has("3")){e+=Ei(t,!1);let b=new Jt;const C=t[0];C&&b.add(C.last()),t=[b]}}return e+=Ei(t,!0),e};/*! sifter.js | https://github.com/orchidjs/sifter.js | Apache License (v2) */const po=(i,e)=>{if(i)return i[e]},ho=(i,e)=>{if(i){for(var t,n=e.split(".");(t=n.shift())&&(i=i[t]););return i}},xn=(i,e,t)=>{var n,o;return!i||(i=i+"",e.regex==null)||(o=i.search(e.regex),o===-1)?0:(n=e.string.length/i.length,o===0&&(n+=.5),n*t)},Cn=(i,e)=>{var t=i[e];if(typeof t=="function")return t;t&&!Array.isArray(t)&&(i[e]=[t])},Ke=(i,e)=>{if(Array.isArray(i))i.forEach(e);else for(var t in i)i.hasOwnProperty(t)&&e(i[t],t)},mo=(i,e)=>typeof i=="number"&&typeof e=="number"?i>e?1:i<e?-1:0:(i=Zt(i+"").toLowerCase(),e=Zt(e+"").toLowerCase(),i>e?1:e>i?-1:0);/*! sifter.js | https://github.com/orchidjs/sifter.js | Apache License (v2) */class go{constructor(e,t){this.items=void 0,this.settings=void 0,this.items=e,this.settings=t||{diacritics:!0}}tokenize(e,t,n){if(!e||!e.length)return[];const o=[],r=e.split(/\s+/);var l;return n&&(l=new RegExp("^("+Object.keys(n).map(Ct).join("|")+"):(.*)$")),r.forEach(p=>{let y,I=null,b=null;l&&(y=p.match(l))&&(I=y[1],p=y[2]),p.length>0&&(this.settings.diacritics?b=fo(p)||null:b=Ct(p),b&&t&&(b="\\b"+b)),o.push({string:p,regex:b?new RegExp(b,"iu"):null,field:I})}),o}getScoreFunction(e,t){var n=this.prepareSearch(e,t);return this._getScoreFunction(n)}_getScoreFunction(e){const t=e.tokens,n=t.length;if(!n)return function(){return 0};const o=e.options.fields,r=e.weights,l=o.length,p=e.getAttrFn;if(!l)return function(){return 1};const y=function(){return l===1?function(I,b){const C=o[0].field;return xn(p(b,C),I,r[C]||1)}:function(I,b){var C=0;if(I.field){const k=p(b,I.field);!I.regex&&k?C+=1/l:C+=xn(k,I,1)}else Ke(r,(k,j)=>{C+=xn(p(b,j),I,k)});return C/l}}();return n===1?function(I){return y(t[0],I)}:e.options.conjunction==="and"?function(I){var b,C=0;for(let k of t){if(b=y(k,I),b<=0)return 0;C+=b}return C/n}:function(I){var b=0;return Ke(t,C=>{b+=y(C,I)}),b/n}}getSortFunction(e,t){var n=this.prepareSearch(e,t);return this._getSortFunction(n)}_getSortFunction(e){var t,n=[];const o=this,r=e.options,l=!e.query&&r.sort_empty?r.sort_empty:r.sort;if(typeof l=="function")return l.bind(this);const p=function(b,C){return b==="$score"?C.score:e.getAttrFn(o.items[C.id],b)};if(l)for(let I of l)(e.query||I.field!=="$score")&&n.push(I);if(e.query){t=!0;for(let I of n)if(I.field==="$score"){t=!1;break}t&&n.unshift({field:"$score",direction:"desc"})}else n=n.filter(I=>I.field!=="$score");return n.length?function(I,b){var C,k;for(let j of n)if(k=j.field,C=(j.direction==="desc"?-1:1)*mo(p(k,I),p(k,b)),C)return C;return 0}:null}prepareSearch(e,t){const n={};var o=Object.assign({},t);if(Cn(o,"sort"),Cn(o,"sort_empty"),o.fields){Cn(o,"fields");const r=[];o.fields.forEach(l=>{typeof l=="string"&&(l={field:l,weight:1}),r.push(l),n[l.field]="weight"in l?l.weight:1}),o.fields=r}return{options:o,query:e.toLowerCase().trim(),tokens:this.tokenize(e,o.respect_word_boundaries,n),total:0,items:[],weights:n,getAttrFn:o.nesting?ho:po}}search(e,t){var n=this,o,r;r=this.prepareSearch(e,t),t=r.options,e=r.query;const l=t.score||n._getScoreFunction(r);e.length?Ke(n.items,(y,I)=>{o=l(y),(t.filter===!1||o>0)&&r.items.push({score:o,id:I})}):Ke(n.items,(y,I)=>{r.items.push({score:1,id:I})});const p=n._getSortFunction(r);return p&&r.items.sort(p),r.total=r.items.length,typeof t.limit=="number"&&(r.items=r.items.slice(0,t.limit)),r}}const Et=(i,e)=>{if(Array.isArray(i))i.forEach(e);else for(var t in i)i.hasOwnProperty(t)&&e(i[t],t)},Ve=i=>{if(i.jquery)return i[0];if(i instanceof HTMLElement)return i;if(Xi(i)){var e=document.createElement("template");return e.innerHTML=i.trim(),e.content.firstChild}return document.querySelector(i)},Xi=i=>typeof i=="string"&&i.indexOf("<")>-1,yo=i=>i.replace(/['"\\]/g,"\\$&"),An=(i,e)=>{var t=document.createEvent("HTMLEvents");t.initEvent(e,!0,!1),i.dispatchEvent(t)},Ut=(i,e)=>{Object.assign(i.style,e)},ze=(i,...e)=>{var t=Vi(e);i=Ui(i),i.map(n=>{t.map(o=>{n.classList.add(o)})})},lt=(i,...e)=>{var t=Vi(e);i=Ui(i),i.map(n=>{t.map(o=>{n.classList.remove(o)})})},Vi=i=>{var e=[];return Et(i,t=>{typeof t=="string"&&(t=t.trim().split(/[\11\12\14\15\40]/)),Array.isArray(t)&&(e=e.concat(t))}),e.filter(Boolean)},Ui=i=>(Array.isArray(i)||(i=[i]),i),Wt=(i,e,t)=>{if(!(t&&!t.contains(i)))for(;i&&i.matches;){if(i.matches(e))return i;i=i.parentNode}},wi=(i,e=0)=>e>0?i[i.length-1]:i[0],vo=i=>Object.keys(i).length===0,Qt=(i,e)=>{if(!i)return-1;e=e||i.nodeName;for(var t=0;i=i.previousElementSibling;)i.matches(e)&&t++;return t},Le=(i,e)=>{Et(e,(t,n)=>{t==null?i.removeAttribute(n):i.setAttribute(n,""+t)})},Bn=(i,e)=>{i.parentNode&&i.parentNode.replaceChild(e,i)},Io=(i,e)=>{if(e===null)return;if(typeof e=="string"){if(!e.length)return;e=new RegExp(e,"i")}const t=r=>{var l=r.data.match(e);if(l&&r.data.length>0){var p=document.createElement("span");p.className="highlight";var y=r.splitText(l.index);y.splitText(l[0].length);var I=y.cloneNode(!0);return p.appendChild(I),Bn(y,p),1}return 0},n=r=>{r.nodeType===1&&r.childNodes&&!/(script|style)/i.test(r.tagName)&&(r.className!=="highlight"||r.tagName!=="SPAN")&&Array.from(r.childNodes).forEach(l=>{o(l)})},o=r=>r.nodeType===3?t(r):(n(r),0);o(i)},Eo=i=>{var e=i.querySelectorAll("span.highlight");Array.prototype.forEach.call(e,function(t){var n=t.parentNode;n.replaceChild(t.firstChild,t),n.normalize()})},wo=65,bo=13,ji=27,Fn=37,So=38,Hi=39,_o=40,bi=8,To=46,Xn=9,Oo=typeof navigator>"u"?!1:/Mac/.test(navigator.userAgent),jt=Oo?"metaKey":"ctrlKey";var Si={options:[],optgroups:[],plugins:[],delimiter:",",splitOn:null,persist:!0,diacritics:!0,create:null,createOnBlur:!1,createFilter:null,highlight:!0,openOnFocus:!0,shouldOpen:null,maxOptions:50,maxItems:null,hideSelected:null,duplicates:!1,addPrecedence:!1,selectOnTab:!1,preload:null,allowEmptyOption:!1,refreshThrottle:300,loadThrottle:300,loadingClass:"loading",dataAttr:null,optgroupField:"optgroup",valueField:"value",labelField:"text",disabledField:"disabled",optgroupLabelField:"label",optgroupValueField:"value",lockOptgroupOrder:!1,sortField:"$order",searchField:["text"],searchConjunction:"and",mode:null,wrapperClass:"ts-wrapper",controlClass:"ts-control",dropdownClass:"ts-dropdown",dropdownContentClass:"ts-dropdown-content",itemClass:"item",optionClass:"option",dropdownParent:null,controlInput:'<input type="text" autocomplete="off" size="1" />',copyClassesToDropdown:!1,placeholder:null,hidePlaceholder:null,shouldLoad:function(i){return i.length>0},render:{}};const et=i=>typeof i>"u"||i===null?null:Gt(i),Gt=i=>typeof i=="boolean"?i?"1":"0":i+"",qt=i=>(i+"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;"),ko=(i,e)=>e>0?setTimeout(i,e):(i.call(null),null),No=(i,e)=>{var t;return function(n,o){var r=this;t&&(r.loading=Math.max(r.loading-1,0),clearTimeout(t)),t=setTimeout(function(){t=null,r.loadedSearches[n]=!0,i.call(r,n,o)},e)}},_i=(i,e,t)=>{var n,o=i.trigger,r={};i.trigger=function(){var l=arguments[0];if(e.indexOf(l)!==-1)r[l]=arguments;else return o.apply(i,arguments)},t.apply(i,[]),i.trigger=o;for(n of e)n in r&&o.apply(i,r[n])},xo=i=>({start:i.selectionStart||0,length:(i.selectionEnd||0)-(i.selectionStart||0)}),Ne=(i,e=!1)=>{i&&(i.preventDefault(),e&&i.stopPropagation())},xe=(i,e,t,n)=>{i.addEventListener(e,t,n)},ht=(i,e)=>{if(!e||!e[i])return!1;var t=(e.altKey?1:0)+(e.ctrlKey?1:0)+(e.shiftKey?1:0)+(e.metaKey?1:0);return t===1},Dn=(i,e)=>{const t=i.getAttribute("id");return t||(i.setAttribute("id",e),e)},Ti=i=>i.replace(/[\\"']/g,"\\$&"),mt=(i,e)=>{e&&i.append(e)};function Oi(i,e){var t=Object.assign({},Si,e),n=t.dataAttr,o=t.labelField,r=t.valueField,l=t.disabledField,p=t.optgroupField,y=t.optgroupLabelField,I=t.optgroupValueField,b=i.tagName.toLowerCase(),C=i.getAttribute("placeholder")||i.getAttribute("data-placeholder");if(!C&&!t.allowEmptyOption){let B=i.querySelector('option[value=""]');B&&(C=B.textContent)}var k={placeholder:C,options:[],optgroups:[],items:[],maxItems:null},j=()=>{var B,N=k.options,R={},D=1;let L=0;var X=v=>{var h=Object.assign({},v.dataset),E=n&&h[n];return typeof E=="string"&&E.length&&(h=Object.assign(h,JSON.parse(E))),h},Z=(v,h)=>{var E=et(v.value);if(E!=null&&!(!E&&!t.allowEmptyOption)){if(R.hasOwnProperty(E)){if(h){var d=R[E][p];d?Array.isArray(d)?d.push(h):R[E][p]=[d,h]:R[E][p]=h}}else{var _=X(v);_[o]=_[o]||v.textContent,_[r]=_[r]||E,_[l]=_[l]||v.disabled,_[p]=_[p]||h,_.$option=v,_.$order=_.$order||++L,R[E]=_,N.push(_)}v.selected&&k.items.push(E)}},O=v=>{var h,E;E=X(v),E[y]=E[y]||v.getAttribute("label")||"",E[I]=E[I]||D++,E[l]=E[l]||v.disabled,E.$order=E.$order||++L,k.optgroups.push(E),h=E[I],Et(v.children,d=>{Z(d,h)})};k.maxItems=i.hasAttribute("multiple")?null:1,Et(i.children,v=>{B=v.tagName.toLowerCase(),B==="optgroup"?O(v):B==="option"&&Z(v)})},T=()=>{const B=i.getAttribute(n);if(B)k.options=JSON.parse(B),Et(k.options,R=>{k.items.push(R[r])});else{var N=i.value.trim()||"";if(!t.allowEmptyOption&&!N.length)return;const R=N.split(t.delimiter);Et(R,D=>{const L={};L[o]=D,L[r]=D,k.options.push(L)}),k.items=R}};return b==="select"?j():T(),Object.assign({},Si,k,e)}var ki=0;class Ye extends Kr(zr){constructor(e,t){super(),this.control_input=void 0,this.wrapper=void 0,this.dropdown=void 0,this.control=void 0,this.dropdown_content=void 0,this.focus_node=void 0,this.order=0,this.settings=void 0,this.input=void 0,this.tabIndex=void 0,this.is_select_tag=void 0,this.rtl=void 0,this.inputId=void 0,this._destroy=void 0,this.sifter=void 0,this.isOpen=!1,this.isDisabled=!1,this.isReadOnly=!1,this.isRequired=void 0,this.isInvalid=!1,this.isValid=!0,this.isLocked=!1,this.isFocused=!1,this.isInputHidden=!1,this.isSetup=!1,this.ignoreFocus=!1,this.ignoreHover=!1,this.hasOptions=!1,this.currentResults=void 0,this.lastValue="",this.caretPos=0,this.loading=0,this.loadedSearches={},this.activeOption=null,this.activeItems=[],this.optgroups={},this.options={},this.userOptions={},this.items=[],this.refreshTimeout=null,ki++;var n,o=Ve(e);if(o.tomselect)throw new Error("Tom Select already initialized on this element");o.tomselect=this;var r=window.getComputedStyle&&window.getComputedStyle(o,null);n=r.getPropertyValue("direction");const l=Oi(o,t);this.settings=l,this.input=o,this.tabIndex=o.tabIndex||0,this.is_select_tag=o.tagName.toLowerCase()==="select",this.rtl=/rtl/i.test(n),this.inputId=Dn(o,"tomselect-"+ki),this.isRequired=o.required,this.sifter=new go(this.options,{diacritics:l.diacritics}),l.mode=l.mode||(l.maxItems===1?"single":"multi"),typeof l.hideSelected!="boolean"&&(l.hideSelected=l.mode==="multi"),typeof l.hidePlaceholder!="boolean"&&(l.hidePlaceholder=l.mode!=="multi");var p=l.createFilter;typeof p!="function"&&(typeof p=="string"&&(p=new RegExp(p)),p instanceof RegExp?l.createFilter=N=>p.test(N):l.createFilter=N=>this.settings.duplicates||!this.options[N]),this.initializePlugins(l.plugins),this.setupCallbacks(),this.setupTemplates();const y=Ve("<div>"),I=Ve("<div>"),b=this._render("dropdown"),C=Ve('<div role="listbox" tabindex="-1">'),k=this.input.getAttribute("class")||"",j=l.mode;var T;if(ze(y,l.wrapperClass,k,j),ze(I,l.controlClass),mt(y,I),ze(b,l.dropdownClass,j),l.copyClassesToDropdown&&ze(b,k),ze(C,l.dropdownContentClass),mt(b,C),Ve(l.dropdownParent||y).appendChild(b),Xi(l.controlInput)){T=Ve(l.controlInput);var B=["autocorrect","autocapitalize","autocomplete","spellcheck"];Ke(B,N=>{o.getAttribute(N)&&Le(T,{[N]:o.getAttribute(N)})}),T.tabIndex=-1,I.appendChild(T),this.focus_node=T}else l.controlInput?(T=Ve(l.controlInput),this.focus_node=T):(T=Ve("<input/>"),this.focus_node=I);this.wrapper=y,this.dropdown=b,this.dropdown_content=C,this.control=I,this.control_input=T,this.setup()}setup(){const e=this,t=e.settings,n=e.control_input,o=e.dropdown,r=e.dropdown_content,l=e.wrapper,p=e.control,y=e.input,I=e.focus_node,b={passive:!0},C=e.inputId+"-ts-dropdown";Le(r,{id:C}),Le(I,{role:"combobox","aria-haspopup":"listbox","aria-expanded":"false","aria-controls":C});const k=Dn(I,e.inputId+"-ts-control"),j="label[for='"+yo(e.inputId)+"']",T=document.querySelector(j),B=e.focus.bind(e);if(T){xe(T,"click",B),Le(T,{for:k});const D=Dn(T,e.inputId+"-ts-label");Le(I,{"aria-labelledby":D}),Le(r,{"aria-labelledby":D})}if(l.style.width=y.style.width,e.plugins.names.length){const D="plugin-"+e.plugins.names.join(" plugin-");ze([l,o],D)}(t.maxItems===null||t.maxItems>1)&&e.is_select_tag&&Le(y,{multiple:"multiple"}),t.placeholder&&Le(n,{placeholder:t.placeholder}),!t.splitOn&&t.delimiter&&(t.splitOn=new RegExp("\\s*"+Ct(t.delimiter)+"+\\s*")),t.load&&t.loadThrottle&&(t.load=No(t.load,t.loadThrottle)),xe(o,"mousemove",()=>{e.ignoreHover=!1}),xe(o,"mouseenter",D=>{var L=Wt(D.target,"[data-selectable]",o);L&&e.onOptionHover(D,L)},{capture:!0}),xe(o,"click",D=>{const L=Wt(D.target,"[data-selectable]");L&&(e.onOptionSelect(D,L),Ne(D,!0))}),xe(p,"click",D=>{var L=Wt(D.target,"[data-ts-item]",p);if(L&&e.onItemSelect(D,L)){Ne(D,!0);return}n.value==""&&(e.onClick(),Ne(D,!0))}),xe(I,"keydown",D=>e.onKeyDown(D)),xe(n,"keypress",D=>e.onKeyPress(D)),xe(n,"input",D=>e.onInput(D)),xe(I,"blur",D=>e.onBlur(D)),xe(I,"focus",D=>e.onFocus(D)),xe(n,"paste",D=>e.onPaste(D));const N=D=>{const L=D.composedPath()[0];if(!l.contains(L)&&!o.contains(L)){e.isFocused&&e.blur(),e.inputState();return}L==n&&e.isOpen?D.stopPropagation():Ne(D,!0)},R=()=>{e.isOpen&&e.positionDropdown()};xe(document,"mousedown",N),xe(window,"scroll",R,b),xe(window,"resize",R,b),this._destroy=()=>{document.removeEventListener("mousedown",N),window.removeEventListener("scroll",R),window.removeEventListener("resize",R),T&&T.removeEventListener("click",B)},this.revertSettings={innerHTML:y.innerHTML,tabIndex:y.tabIndex},y.tabIndex=-1,y.insertAdjacentElement("afterend",e.wrapper),e.sync(!1),t.items=[],delete t.optgroups,delete t.options,xe(y,"invalid",()=>{e.isValid&&(e.isValid=!1,e.isInvalid=!0,e.refreshState())}),e.updateOriginalInput(),e.refreshItems(),e.close(!1),e.inputState(),e.isSetup=!0,y.disabled?e.disable():y.readOnly?e.setReadOnly(!0):e.enable(),e.on("change",this.onChange),ze(y,"tomselected","ts-hidden-accessible"),e.trigger("initialize"),t.preload===!0&&e.preload()}setupOptions(e=[],t=[]){this.addOptions(e),Ke(t,n=>{this.registerOptionGroup(n)})}setupTemplates(){var e=this,t=e.settings.labelField,n=e.settings.optgroupLabelField,o={optgroup:r=>{let l=document.createElement("div");return l.className="optgroup",l.appendChild(r.options),l},optgroup_header:(r,l)=>'<div class="optgroup-header">'+l(r[n])+"</div>",option:(r,l)=>"<div>"+l(r[t])+"</div>",item:(r,l)=>"<div>"+l(r[t])+"</div>",option_create:(r,l)=>'<div class="create">Add <strong>'+l(r.input)+"</strong>&hellip;</div>",no_results:()=>'<div class="no-results">No results found</div>',loading:()=>'<div class="spinner"></div>',not_loading:()=>{},dropdown:()=>"<div></div>"};e.settings.render=Object.assign({},o,e.settings.render)}setupCallbacks(){var e,t,n={initialize:"onInitialize",change:"onChange",item_add:"onItemAdd",item_remove:"onItemRemove",item_select:"onItemSelect",clear:"onClear",option_add:"onOptionAdd",option_remove:"onOptionRemove",option_clear:"onOptionClear",optgroup_add:"onOptionGroupAdd",optgroup_remove:"onOptionGroupRemove",optgroup_clear:"onOptionGroupClear",dropdown_open:"onDropdownOpen",dropdown_close:"onDropdownClose",type:"onType",load:"onLoad",focus:"onFocus",blur:"onBlur"};for(e in n)t=this.settings[n[e]],t&&this.on(e,t)}sync(e=!0){const t=this,n=e?Oi(t.input,{delimiter:t.settings.delimiter}):t.settings;t.setupOptions(n.options,n.optgroups),t.setValue(n.items||[],!0),t.lastQuery=null}onClick(){var e=this;if(e.activeItems.length>0){e.clearActiveItems(),e.focus();return}e.isFocused&&e.isOpen?e.blur():e.focus()}onMouseDown(){}onChange(){An(this.input,"input"),An(this.input,"change")}onPaste(e){var t=this;if(t.isInputHidden||t.isLocked){Ne(e);return}t.settings.splitOn&&setTimeout(()=>{var n=t.inputValue();if(n.match(t.settings.splitOn)){var o=n.trim().split(t.settings.splitOn);Ke(o,r=>{et(r)&&(this.options[r]?t.addItem(r):t.createItem(r))})}},0)}onKeyPress(e){var t=this;if(t.isLocked){Ne(e);return}var n=String.fromCharCode(e.keyCode||e.which);if(t.settings.create&&t.settings.mode==="multi"&&n===t.settings.delimiter){t.createItem(),Ne(e);return}}onKeyDown(e){var t=this;if(t.ignoreHover=!0,t.isLocked){e.keyCode!==Xn&&Ne(e);return}switch(e.keyCode){case wo:if(ht(jt,e)&&t.control_input.value==""){Ne(e),t.selectAll();return}break;case ji:t.isOpen&&(Ne(e,!0),t.close()),t.clearActiveItems();return;case _o:if(!t.isOpen&&t.hasOptions)t.open();else if(t.activeOption){let n=t.getAdjacent(t.activeOption,1);n&&t.setActiveOption(n)}Ne(e);return;case So:if(t.activeOption){let n=t.getAdjacent(t.activeOption,-1);n&&t.setActiveOption(n)}Ne(e);return;case bo:t.canSelect(t.activeOption)?(t.onOptionSelect(e,t.activeOption),Ne(e)):(t.settings.create&&t.createItem()||document.activeElement==t.control_input&&t.isOpen)&&Ne(e);return;case Fn:t.advanceSelection(-1,e);return;case Hi:t.advanceSelection(1,e);return;case Xn:t.settings.selectOnTab&&(t.canSelect(t.activeOption)&&(t.onOptionSelect(e,t.activeOption),Ne(e)),t.settings.create&&t.createItem()&&Ne(e));return;case bi:case To:t.deleteSelection(e);return}t.isInputHidden&&!ht(jt,e)&&Ne(e)}onInput(e){if(this.isLocked)return;const t=this.inputValue();if(this.lastValue!==t){if(this.lastValue=t,t==""){this._onInput();return}this.refreshTimeout&&clearTimeout(this.refreshTimeout),this.refreshTimeout=ko(()=>{this.refreshTimeout=null,this._onInput()},this.settings.refreshThrottle)}}_onInput(){const e=this.lastValue;this.settings.shouldLoad.call(this,e)&&this.load(e),this.refreshOptions(),this.trigger("type",e)}onOptionHover(e,t){this.ignoreHover||this.setActiveOption(t,!1)}onFocus(e){var t=this,n=t.isFocused;if(t.isDisabled||t.isReadOnly){t.blur(),Ne(e);return}t.ignoreFocus||(t.isFocused=!0,t.settings.preload==="focus"&&t.preload(),n||t.trigger("focus"),t.activeItems.length||(t.inputState(),t.refreshOptions(!!t.settings.openOnFocus)),t.refreshState())}onBlur(e){if(document.hasFocus()!==!1){var t=this;if(t.isFocused){t.isFocused=!1,t.ignoreFocus=!1;var n=()=>{t.close(),t.setActiveItem(),t.setCaret(t.items.length),t.trigger("blur")};t.settings.create&&t.settings.createOnBlur?t.createItem(null,n):n()}}}onOptionSelect(e,t){var n,o=this;t.parentElement&&t.parentElement.matches("[data-disabled]")||(t.classList.contains("create")?o.createItem(null,()=>{o.settings.closeAfterSelect&&o.close()}):(n=t.dataset.value,typeof n<"u"&&(o.lastQuery=null,o.addItem(n),o.settings.closeAfterSelect&&o.close(),!o.settings.hideSelected&&e.type&&/click/.test(e.type)&&o.setActiveOption(t))))}canSelect(e){return!!(this.isOpen&&e&&this.dropdown_content.contains(e))}onItemSelect(e,t){var n=this;return!n.isLocked&&n.settings.mode==="multi"?(Ne(e),n.setActiveItem(t,e),!0):!1}canLoad(e){return!(!this.settings.load||this.loadedSearches.hasOwnProperty(e))}load(e){const t=this;if(!t.canLoad(e))return;ze(t.wrapper,t.settings.loadingClass),t.loading++;const n=t.loadCallback.bind(t);t.settings.load.call(t,e,n)}loadCallback(e,t){const n=this;n.loading=Math.max(n.loading-1,0),n.lastQuery=null,n.clearActiveOption(),n.setupOptions(e,t),n.refreshOptions(n.isFocused&&!n.isInputHidden),n.loading||lt(n.wrapper,n.settings.loadingClass),n.trigger("load",e,t)}preload(){var e=this.wrapper.classList;e.contains("preloaded")||(e.add("preloaded"),this.load(""))}setTextboxValue(e=""){var t=this.control_input,n=t.value!==e;n&&(t.value=e,An(t,"update"),this.lastValue=e)}getValue(){return this.is_select_tag&&this.input.hasAttribute("multiple")?this.items:this.items.join(this.settings.delimiter)}setValue(e,t){var n=t?[]:["change"];_i(this,n,()=>{this.clear(t),this.addItems(e,t)})}setMaxItems(e){e===0&&(e=null),this.settings.maxItems=e,this.refreshState()}setActiveItem(e,t){var n=this,o,r,l,p,y,I;if(n.settings.mode!=="single"){if(!e){n.clearActiveItems(),n.isFocused&&n.inputState();return}if(o=t&&t.type.toLowerCase(),o==="click"&&ht("shiftKey",t)&&n.activeItems.length){for(I=n.getLastActive(),l=Array.prototype.indexOf.call(n.control.children,I),p=Array.prototype.indexOf.call(n.control.children,e),l>p&&(y=l,l=p,p=y),r=l;r<=p;r++)e=n.control.children[r],n.activeItems.indexOf(e)===-1&&n.setActiveItemClass(e);Ne(t)}else o==="click"&&ht(jt,t)||o==="keydown"&&ht("shiftKey",t)?e.classList.contains("active")?n.removeActiveItem(e):n.setActiveItemClass(e):(n.clearActiveItems(),n.setActiveItemClass(e));n.inputState(),n.isFocused||n.focus()}}setActiveItemClass(e){const t=this,n=t.control.querySelector(".last-active");n&&lt(n,"last-active"),ze(e,"active last-active"),t.trigger("item_select",e),t.activeItems.indexOf(e)==-1&&t.activeItems.push(e)}removeActiveItem(e){var t=this.activeItems.indexOf(e);this.activeItems.splice(t,1),lt(e,"active")}clearActiveItems(){lt(this.activeItems,"active"),this.activeItems=[]}setActiveOption(e,t=!0){e!==this.activeOption&&(this.clearActiveOption(),e&&(this.activeOption=e,Le(this.focus_node,{"aria-activedescendant":e.getAttribute("id")}),Le(e,{"aria-selected":"true"}),ze(e,"active"),t&&this.scrollToOption(e)))}scrollToOption(e,t){if(!e)return;const n=this.dropdown_content,o=n.clientHeight,r=n.scrollTop||0,l=e.offsetHeight,p=e.getBoundingClientRect().top-n.getBoundingClientRect().top+r;p+l>o+r?this.scroll(p-o+l,t):p<r&&this.scroll(p,t)}scroll(e,t){const n=this.dropdown_content;t&&(n.style.scrollBehavior=t),n.scrollTop=e,n.style.scrollBehavior=""}clearActiveOption(){this.activeOption&&(lt(this.activeOption,"active"),Le(this.activeOption,{"aria-selected":null})),this.activeOption=null,Le(this.focus_node,{"aria-activedescendant":null})}selectAll(){const e=this;if(e.settings.mode==="single")return;const t=e.controlChildren();t.length&&(e.inputState(),e.close(),e.activeItems=t,Ke(t,n=>{e.setActiveItemClass(n)}))}inputState(){var e=this;e.control.contains(e.control_input)&&(Le(e.control_input,{placeholder:e.settings.placeholder}),e.activeItems.length>0||!e.isFocused&&e.settings.hidePlaceholder&&e.items.length>0?(e.setTextboxValue(),e.isInputHidden=!0):(e.settings.hidePlaceholder&&e.items.length>0&&Le(e.control_input,{placeholder:""}),e.isInputHidden=!1),e.wrapper.classList.toggle("input-hidden",e.isInputHidden))}inputValue(){return this.control_input.value.trim()}focus(){var e=this;e.isDisabled||e.isReadOnly||(e.ignoreFocus=!0,e.control_input.offsetWidth?e.control_input.focus():e.focus_node.focus(),setTimeout(()=>{e.ignoreFocus=!1,e.onFocus()},0))}blur(){this.focus_node.blur(),this.onBlur()}getScoreFunction(e){return this.sifter.getScoreFunction(e,this.getSearchOptions())}getSearchOptions(){var e=this.settings,t=e.sortField;return typeof e.sortField=="string"&&(t=[{field:e.sortField}]),{fields:e.searchField,conjunction:e.searchConjunction,sort:t,nesting:e.nesting}}search(e){var t,n,o=this,r=this.getSearchOptions();if(o.settings.score&&(n=o.settings.score.call(o,e),typeof n!="function"))throw new Error('Tom Select "score" setting must be a function that returns a function');return e!==o.lastQuery?(o.lastQuery=e,t=o.sifter.search(e,Object.assign(r,{score:n})),o.currentResults=t):t=Object.assign({},o.currentResults),o.settings.hideSelected&&(t.items=t.items.filter(l=>{let p=et(l.id);return!(p&&o.items.indexOf(p)!==-1)})),t}refreshOptions(e=!0){var t,n,o,r,l,p,y,I,b,C;const k={},j=[];var T=this,B=T.inputValue();const N=B===T.lastQuery||B==""&&T.lastQuery==null;var R=T.search(B),D=null,L=T.settings.shouldOpen||!1,X=T.dropdown_content;N&&(D=T.activeOption,D&&(b=D.closest("[data-group]"))),r=R.items.length,typeof T.settings.maxOptions=="number"&&(r=Math.min(r,T.settings.maxOptions)),r>0&&(L=!0);const Z=(v,h)=>{let E=k[v];if(E!==void 0){let _=j[E];if(_!==void 0)return[E,_.fragment]}let d=document.createDocumentFragment();return E=j.length,j.push({fragment:d,order:h,optgroup:v}),[E,d]};for(t=0;t<r;t++){let v=R.items[t];if(!v)continue;let h=v.id,E=T.options[h];if(E===void 0)continue;let d=Gt(h),_=T.getOption(d,!0);for(T.settings.hideSelected||_.classList.toggle("selected",T.items.includes(d)),l=E[T.settings.optgroupField]||"",p=Array.isArray(l)?l:[l],n=0,o=p&&p.length;n<o;n++){l=p[n];let $=E.$order,te=T.optgroups[l];te===void 0?l="":$=te.$order;const[re,se]=Z(l,$);n>0&&(_=_.cloneNode(!0),Le(_,{id:E.$id+"-clone-"+n,"aria-selected":null}),_.classList.add("ts-cloned"),lt(_,"active"),T.activeOption&&T.activeOption.dataset.value==h&&b&&b.dataset.group===l.toString()&&(D=_)),se.appendChild(_),l!=""&&(k[l]=re)}}T.settings.lockOptgroupOrder&&j.sort((v,h)=>v.order-h.order),y=document.createDocumentFragment(),Ke(j,v=>{let h=v.fragment,E=v.optgroup;if(!h||!h.children.length)return;let d=T.optgroups[E];if(d!==void 0){let _=document.createDocumentFragment(),$=T.render("optgroup_header",d);mt(_,$),mt(_,h);let te=T.render("optgroup",{group:d,options:_});mt(y,te)}else mt(y,h)}),X.innerHTML="",mt(X,y),T.settings.highlight&&(Eo(X),R.query.length&&R.tokens.length&&Ke(R.tokens,v=>{Io(X,v.regex)}));var O=v=>{let h=T.render(v,{input:B});return h&&(L=!0,X.insertBefore(h,X.firstChild)),h};if(T.loading?O("loading"):T.settings.shouldLoad.call(T,B)?R.items.length===0&&O("no_results"):O("not_loading"),I=T.canCreate(B),I&&(C=O("option_create")),T.hasOptions=R.items.length>0||I,L){if(R.items.length>0){if(!D&&T.settings.mode==="single"&&T.items[0]!=null&&(D=T.getOption(T.items[0])),!X.contains(D)){let v=0;C&&!T.settings.addPrecedence&&(v=1),D=T.selectable()[v]}}else C&&(D=C);e&&!T.isOpen&&(T.open(),T.scrollToOption(D,"auto")),T.setActiveOption(D)}else T.clearActiveOption(),e&&T.isOpen&&T.close(!1)}selectable(){return this.dropdown_content.querySelectorAll("[data-selectable]")}addOption(e,t=!1){const n=this;if(Array.isArray(e))return n.addOptions(e,t),!1;const o=et(e[n.settings.valueField]);return o===null||n.options.hasOwnProperty(o)?!1:(e.$order=e.$order||++n.order,e.$id=n.inputId+"-opt-"+e.$order,n.options[o]=e,n.lastQuery=null,t&&(n.userOptions[o]=t,n.trigger("option_add",o,e)),o)}addOptions(e,t=!1){Ke(e,n=>{this.addOption(n,t)})}registerOption(e){return this.addOption(e)}registerOptionGroup(e){var t=et(e[this.settings.optgroupValueField]);return t===null?!1:(e.$order=e.$order||++this.order,this.optgroups[t]=e,t)}addOptionGroup(e,t){var n;t[this.settings.optgroupValueField]=e,(n=this.registerOptionGroup(t))&&this.trigger("optgroup_add",n,t)}removeOptionGroup(e){this.optgroups.hasOwnProperty(e)&&(delete this.optgroups[e],this.clearCache(),this.trigger("optgroup_remove",e))}clearOptionGroups(){this.optgroups={},this.clearCache(),this.trigger("optgroup_clear")}updateOption(e,t){const n=this;var o,r;const l=et(e),p=et(t[n.settings.valueField]);if(l===null)return;const y=n.options[l];if(y==null)return;if(typeof p!="string")throw new Error("Value must be set in option data");const I=n.getOption(l),b=n.getItem(l);if(t.$order=t.$order||y.$order,delete n.options[l],n.uncacheValue(p),n.options[p]=t,I){if(n.dropdown_content.contains(I)){const C=n._render("option",t);Bn(I,C),n.activeOption===I&&n.setActiveOption(C)}I.remove()}b&&(r=n.items.indexOf(l),r!==-1&&n.items.splice(r,1,p),o=n._render("item",t),b.classList.contains("active")&&ze(o,"active"),Bn(b,o)),n.lastQuery=null}removeOption(e,t){const n=this;e=Gt(e),n.uncacheValue(e),delete n.userOptions[e],delete n.options[e],n.lastQuery=null,n.trigger("option_remove",e),n.removeItem(e,t)}clearOptions(e){const t=(e||this.clearFilter).bind(this);this.loadedSearches={},this.userOptions={},this.clearCache();const n={};Ke(this.options,(o,r)=>{t(o,r)&&(n[r]=o)}),this.options=this.sifter.items=n,this.lastQuery=null,this.trigger("option_clear")}clearFilter(e,t){return this.items.indexOf(t)>=0}getOption(e,t=!1){const n=et(e);if(n===null)return null;const o=this.options[n];if(o!=null){if(o.$div)return o.$div;if(t)return this._render("option",o)}return null}getAdjacent(e,t,n="option"){var o=this,r;if(!e)return null;n=="item"?r=o.controlChildren():r=o.dropdown_content.querySelectorAll("[data-selectable]");for(let l=0;l<r.length;l++)if(r[l]==e)return t>0?r[l+1]:r[l-1];return null}getItem(e){if(typeof e=="object")return e;var t=et(e);return t!==null?this.control.querySelector(`[data-value="${Ti(t)}"]`):null}addItems(e,t){var n=this,o=Array.isArray(e)?e:[e];o=o.filter(l=>n.items.indexOf(l)===-1);const r=o[o.length-1];o.forEach(l=>{n.isPending=l!==r,n.addItem(l,t)})}addItem(e,t){var n=t?[]:["change","dropdown_close"];_i(this,n,()=>{var o,r;const l=this,p=l.settings.mode,y=et(e);if(!(y&&l.items.indexOf(y)!==-1&&(p==="single"&&l.close(),p==="single"||!l.settings.duplicates))&&!(y===null||!l.options.hasOwnProperty(y))&&(p==="single"&&l.clear(t),!(p==="multi"&&l.isFull()))){if(o=l._render("item",l.options[y]),l.control.contains(o)&&(o=o.cloneNode(!0)),r=l.isFull(),l.items.splice(l.caretPos,0,y),l.insertAtCaret(o),l.isSetup){if(!l.isPending&&l.settings.hideSelected){let I=l.getOption(y),b=l.getAdjacent(I,1);b&&l.setActiveOption(b)}!l.isPending&&!l.settings.closeAfterSelect&&l.refreshOptions(l.isFocused&&p!=="single"),l.settings.closeAfterSelect!=!1&&l.isFull()?l.close():l.isPending||l.positionDropdown(),l.trigger("item_add",y,o),l.isPending||l.updateOriginalInput({silent:t})}(!l.isPending||!r&&l.isFull())&&(l.inputState(),l.refreshState())}})}removeItem(e=null,t){const n=this;if(e=n.getItem(e),!e)return;var o,r;const l=e.dataset.value;o=Qt(e),e.remove(),e.classList.contains("active")&&(r=n.activeItems.indexOf(e),n.activeItems.splice(r,1),lt(e,"active")),n.items.splice(o,1),n.lastQuery=null,!n.settings.persist&&n.userOptions.hasOwnProperty(l)&&n.removeOption(l,t),o<n.caretPos&&n.setCaret(n.caretPos-1),n.updateOriginalInput({silent:t}),n.refreshState(),n.positionDropdown(),n.trigger("item_remove",l,e)}createItem(e=null,t=()=>{}){arguments.length===3&&(t=arguments[2]),typeof t!="function"&&(t=()=>{});var n=this,o=n.caretPos,r;if(e=e||n.inputValue(),!n.canCreate(e))return t(),!1;n.lock();var l=!1,p=y=>{if(n.unlock(),!y||typeof y!="object")return t();var I=et(y[n.settings.valueField]);if(typeof I!="string")return t();n.setTextboxValue(),n.addOption(y,!0),n.setCaret(o),n.addItem(I),t(y),l=!0};return typeof n.settings.create=="function"?r=n.settings.create.call(this,e,p):r={[n.settings.labelField]:e,[n.settings.valueField]:e},l||p(r),!0}refreshItems(){var e=this;e.lastQuery=null,e.isSetup&&e.addItems(e.items),e.updateOriginalInput(),e.refreshState()}refreshState(){const e=this;e.refreshValidityState();const t=e.isFull(),n=e.isLocked;e.wrapper.classList.toggle("rtl",e.rtl);const o=e.wrapper.classList;o.toggle("focus",e.isFocused),o.toggle("disabled",e.isDisabled),o.toggle("readonly",e.isReadOnly),o.toggle("required",e.isRequired),o.toggle("invalid",!e.isValid),o.toggle("locked",n),o.toggle("full",t),o.toggle("input-active",e.isFocused&&!e.isInputHidden),o.toggle("dropdown-active",e.isOpen),o.toggle("has-options",vo(e.options)),o.toggle("has-items",e.items.length>0)}refreshValidityState(){var e=this;e.input.validity&&(e.isValid=e.input.validity.valid,e.isInvalid=!e.isValid)}isFull(){return this.settings.maxItems!==null&&this.items.length>=this.settings.maxItems}updateOriginalInput(e={}){const t=this;var n,o;const r=t.input.querySelector('option[value=""]');if(t.is_select_tag){let y=function(I,b,C){return I||(I=Ve('<option value="'+qt(b)+'">'+qt(C)+"</option>")),I!=r&&t.input.append(I),l.push(I),(I!=r||p>0)&&(I.selected=!0),I};const l=[],p=t.input.querySelectorAll("option:checked").length;t.input.querySelectorAll("option:checked").forEach(I=>{I.selected=!1}),t.items.length==0&&t.settings.mode=="single"?y(r,"",""):t.items.forEach(I=>{if(n=t.options[I],o=n[t.settings.labelField]||"",l.includes(n.$option)){const b=t.input.querySelector(`option[value="${Ti(I)}"]:not(:checked)`);y(b,I,o)}else n.$option=y(n.$option,I,o)})}else t.input.value=t.getValue();t.isSetup&&(e.silent||t.trigger("change",t.getValue()))}open(){var e=this;e.isLocked||e.isOpen||e.settings.mode==="multi"&&e.isFull()||(e.isOpen=!0,Le(e.focus_node,{"aria-expanded":"true"}),e.refreshState(),Ut(e.dropdown,{visibility:"hidden",display:"block"}),e.positionDropdown(),Ut(e.dropdown,{visibility:"visible",display:"block"}),e.focus(),e.trigger("dropdown_open",e.dropdown))}close(e=!0){var t=this,n=t.isOpen;e&&(t.setTextboxValue(),t.settings.mode==="single"&&t.items.length&&t.inputState()),t.isOpen=!1,Le(t.focus_node,{"aria-expanded":"false"}),Ut(t.dropdown,{display:"none"}),t.settings.hideSelected&&t.clearActiveOption(),t.refreshState(),n&&t.trigger("dropdown_close",t.dropdown)}positionDropdown(){if(this.settings.dropdownParent==="body"){var e=this.control,t=e.getBoundingClientRect(),n=e.offsetHeight+t.top+window.scrollY,o=t.left+window.scrollX;Ut(this.dropdown,{width:t.width+"px",top:n+"px",left:o+"px"})}}clear(e){var t=this;if(t.items.length){var n=t.controlChildren();Ke(n,o=>{t.removeItem(o,!0)}),t.inputState(),e||t.updateOriginalInput(),t.trigger("clear")}}insertAtCaret(e){const t=this,n=t.caretPos,o=t.control;o.insertBefore(e,o.children[n]||null),t.setCaret(n+1)}deleteSelection(e){var t,n,o,r,l=this;t=e&&e.keyCode===bi?-1:1,n=xo(l.control_input);const p=[];if(l.activeItems.length)r=wi(l.activeItems,t),o=Qt(r),t>0&&o++,Ke(l.activeItems,y=>p.push(y));else if((l.isFocused||l.settings.mode==="single")&&l.items.length){const y=l.controlChildren();let I;t<0&&n.start===0&&n.length===0?I=y[l.caretPos-1]:t>0&&n.start===l.inputValue().length&&(I=y[l.caretPos]),I!==void 0&&p.push(I)}if(!l.shouldDelete(p,e))return!1;for(Ne(e,!0),typeof o<"u"&&l.setCaret(o);p.length;)l.removeItem(p.pop());return l.inputState(),l.positionDropdown(),l.refreshOptions(!1),!0}shouldDelete(e,t){const n=e.map(o=>o.dataset.value);return!(!n.length||typeof this.settings.onDelete=="function"&&this.settings.onDelete(n,t)===!1)}advanceSelection(e,t){var n,o,r=this;r.rtl&&(e*=-1),!r.inputValue().length&&(ht(jt,t)||ht("shiftKey",t)?(n=r.getLastActive(e),n?n.classList.contains("active")?o=r.getAdjacent(n,e,"item"):o=n:e>0?o=r.control_input.nextElementSibling:o=r.control_input.previousElementSibling,o&&(o.classList.contains("active")&&r.removeActiveItem(n),r.setActiveItemClass(o))):r.moveCaret(e))}moveCaret(e){}getLastActive(e){let t=this.control.querySelector(".last-active");if(t)return t;var n=this.control.querySelectorAll(".active");if(n)return wi(n,e)}setCaret(e){this.caretPos=this.items.length}controlChildren(){return Array.from(this.control.querySelectorAll("[data-ts-item]"))}lock(){this.setLocked(!0)}unlock(){this.setLocked(!1)}setLocked(e=this.isReadOnly||this.isDisabled){this.isLocked=e,this.refreshState()}disable(){this.setDisabled(!0),this.close()}enable(){this.setDisabled(!1)}setDisabled(e){this.focus_node.tabIndex=e?-1:this.tabIndex,this.isDisabled=e,this.input.disabled=e,this.control_input.disabled=e,this.setLocked()}setReadOnly(e){this.isReadOnly=e,this.input.readOnly=e,this.control_input.readOnly=e,this.setLocked()}destroy(){var e=this,t=e.revertSettings;e.trigger("destroy"),e.off(),e.wrapper.remove(),e.dropdown.remove(),e.input.innerHTML=t.innerHTML,e.input.tabIndex=t.tabIndex,lt(e.input,"tomselected","ts-hidden-accessible"),e._destroy(),delete e.input.tomselect}render(e,t){var n,o;const r=this;if(typeof this.settings.render[e]!="function"||(o=r.settings.render[e].call(this,t,qt),!o))return null;if(o=Ve(o),e==="option"||e==="option_create"?t[r.settings.disabledField]?Le(o,{"aria-disabled":"true"}):Le(o,{"data-selectable":""}):e==="optgroup"&&(n=t.group[r.settings.optgroupValueField],Le(o,{"data-group":n}),t.group[r.settings.disabledField]&&Le(o,{"data-disabled":""})),e==="option"||e==="item"){const l=Gt(t[r.settings.valueField]);Le(o,{"data-value":l}),e==="item"?(ze(o,r.settings.itemClass),Le(o,{"data-ts-item":""})):(ze(o,r.settings.optionClass),Le(o,{role:"option",id:t.$id}),t.$div=o,r.options[l]=t)}return o}_render(e,t){const n=this.render(e,t);if(n==null)throw"HTMLElement expected";return n}clearCache(){Ke(this.options,e=>{e.$div&&(e.$div.remove(),delete e.$div)})}uncacheValue(e){const t=this.getOption(e);t&&t.remove()}canCreate(e){return this.settings.create&&e.length>0&&this.settings.createFilter.call(this,e)}hook(e,t,n){var o=this,r=o[t];o[t]=function(){var l,p;return e==="after"&&(l=r.apply(o,arguments)),p=n.apply(o,arguments),e==="instead"?p:(e==="before"&&(l=r.apply(o,arguments)),l)}}}function Co(){xe(this.input,"change",()=>{this.sync()})}function Ao(i){var e=this,t=e.onOptionSelect;e.settings.hideSelected=!1;const n=Object.assign({className:"tomselect-checkbox",checkedClassNames:void 0,uncheckedClassNames:void 0},i);var o=function(p,y){y?(p.checked=!0,n.uncheckedClassNames&&p.classList.remove(...n.uncheckedClassNames),n.checkedClassNames&&p.classList.add(...n.checkedClassNames)):(p.checked=!1,n.checkedClassNames&&p.classList.remove(...n.checkedClassNames),n.uncheckedClassNames&&p.classList.add(...n.uncheckedClassNames))},r=function(p){setTimeout(()=>{var y=p.querySelector("input."+n.className);y instanceof HTMLInputElement&&o(y,p.classList.contains("selected"))},1)};e.hook("after","setupTemplates",()=>{var l=e.settings.render.option;e.settings.render.option=(p,y)=>{var I=Ve(l.call(e,p,y)),b=document.createElement("input");n.className&&b.classList.add(n.className),b.addEventListener("click",function(k){Ne(k)}),b.type="checkbox";const C=et(p[e.settings.valueField]);return o(b,!!(C&&e.items.indexOf(C)>-1)),I.prepend(b),I}}),e.on("item_remove",l=>{var p=e.getOption(l);p&&(p.classList.remove("selected"),r(p))}),e.on("item_add",l=>{var p=e.getOption(l);p&&r(p)}),e.hook("instead","onOptionSelect",(l,p)=>{if(p.classList.contains("selected")){p.classList.remove("selected"),e.removeItem(p.dataset.value),e.refreshOptions(),Ne(l,!0);return}t.call(e,l,p),r(p)})}function Do(i){const e=this,t=Object.assign({className:"clear-button",title:"Clear All",html:n=>`<div class="${n.className}" title="${n.title}">&#10799;</div>`},i);e.on("initialize",()=>{var n=Ve(t.html(t));n.addEventListener("click",o=>{e.isLocked||(e.clear(),e.settings.mode==="single"&&e.settings.allowEmptyOption&&e.addItem(""),o.preventDefault(),o.stopPropagation())}),e.control.appendChild(n)})}const Po=(i,e)=>{var t;(t=i.parentNode)==null||t.insertBefore(e,i.nextSibling)},$o=(i,e)=>{var t;(t=i.parentNode)==null||t.insertBefore(e,i)},Lo=(i,e)=>{do{var t;if(e=(t=e)==null?void 0:t.previousElementSibling,i==e)return!0}while(e&&e.previousElementSibling);return!1};function Mo(){var i=this;if(i.settings.mode!=="multi")return;var e=i.lock,t=i.unlock;let n=!0,o;i.hook("after","setupTemplates",()=>{var r=i.settings.render.item;i.settings.render.item=(l,p)=>{const y=Ve(r.call(i,l,p));Le(y,{draggable:"true"});const I=B=>{n||Ne(B),B.stopPropagation()},b=B=>{o=y,setTimeout(()=>{y.classList.add("ts-dragging")},0)},C=B=>{B.preventDefault(),y.classList.add("ts-drag-over"),j(y,o)},k=()=>{y.classList.remove("ts-drag-over")},j=(B,N)=>{N!==void 0&&(Lo(N,y)?Po(B,N):$o(B,N))},T=()=>{var B;document.querySelectorAll(".ts-drag-over").forEach(R=>R.classList.remove("ts-drag-over")),(B=o)==null||B.classList.remove("ts-dragging"),o=void 0;var N=[];i.control.querySelectorAll("[data-value]").forEach(R=>{if(R.dataset.value){let D=R.dataset.value;D&&N.push(D)}}),i.setValue(N)};return xe(y,"mousedown",I),xe(y,"dragstart",b),xe(y,"dragenter",C),xe(y,"dragover",C),xe(y,"dragleave",k),xe(y,"dragend",T),y}}),i.hook("instead","lock",()=>(n=!1,e.call(i))),i.hook("instead","unlock",()=>(n=!0,t.call(i)))}function Ro(i){const e=this,t=Object.assign({title:"Untitled",headerClass:"dropdown-header",titleRowClass:"dropdown-header-title",labelClass:"dropdown-header-label",closeClass:"dropdown-header-close",html:n=>'<div class="'+n.headerClass+'"><div class="'+n.titleRowClass+'"><span class="'+n.labelClass+'">'+n.title+'</span><a class="'+n.closeClass+'">&times;</a></div></div>'},i);e.on("initialize",()=>{var n=Ve(t.html(t)),o=n.querySelector("."+t.closeClass);o&&o.addEventListener("click",r=>{Ne(r,!0),e.close()}),e.dropdown.insertBefore(n,e.dropdown.firstChild)})}function Bo(){var i=this;i.hook("instead","setCaret",e=>{i.settings.mode==="single"||!i.control.contains(i.control_input)?e=i.items.length:(e=Math.max(0,Math.min(i.items.length,e)),e!=i.caretPos&&!i.isPending&&i.controlChildren().forEach((t,n)=>{n<e?i.control_input.insertAdjacentElement("beforebegin",t):i.control.appendChild(t)})),i.caretPos=e}),i.hook("instead","moveCaret",e=>{if(!i.isFocused)return;const t=i.getLastActive(e);if(t){const n=Qt(t);i.setCaret(e>0?n+1:n),i.setActiveItem(),lt(t,"last-active")}else i.setCaret(i.caretPos+e)})}function Fo(){const i=this;i.settings.shouldOpen=!0,i.hook("before","setup",()=>{i.focus_node=i.control,ze(i.control_input,"dropdown-input");const e=Ve('<div class="dropdown-input-wrap">');e.append(i.control_input),i.dropdown.insertBefore(e,i.dropdown.firstChild);const t=Ve('<input class="items-placeholder" tabindex="-1" />');t.placeholder=i.settings.placeholder||"",i.control.append(t)}),i.on("initialize",()=>{i.control_input.addEventListener("keydown",t=>{switch(t.keyCode){case ji:i.isOpen&&(Ne(t,!0),i.close()),i.clearActiveItems();return;case Xn:i.focus_node.tabIndex=-1;break}return i.onKeyDown.call(i,t)}),i.on("blur",()=>{i.focus_node.tabIndex=i.isDisabled?-1:i.tabIndex}),i.on("dropdown_open",()=>{i.control_input.focus()});const e=i.onBlur;i.hook("instead","onBlur",t=>{if(!(t&&t.relatedTarget==i.control_input))return e.call(i)}),xe(i.control_input,"blur",()=>i.onBlur()),i.hook("before","close",()=>{i.isOpen&&i.focus_node.focus({preventScroll:!0})})})}function Xo(){var i=this;i.on("initialize",()=>{var e=document.createElement("span"),t=i.control_input;e.style.cssText="position:absolute; top:-99999px; left:-99999px; width:auto; padding:0; white-space:pre; ",i.wrapper.appendChild(e);var n=["letterSpacing","fontSize","fontFamily","fontWeight","textTransform"];for(const r of n)e.style[r]=t.style[r];var o=()=>{e.textContent=t.value,t.style.width=e.clientWidth+"px"};o(),i.on("update item_add item_remove",o),xe(t,"input",o),xe(t,"keyup",o),xe(t,"blur",o),xe(t,"update",o)})}function Vo(){var i=this,e=i.deleteSelection;this.hook("instead","deleteSelection",t=>i.activeItems.length?e.call(i,t):!1)}function Uo(){this.hook("instead","setActiveItem",()=>{}),this.hook("instead","selectAll",()=>{})}function jo(){var i=this,e=i.onKeyDown;i.hook("instead","onKeyDown",t=>{var n,o,r,l;if(!i.isOpen||!(t.keyCode===Fn||t.keyCode===Hi))return e.call(i,t);i.ignoreHover=!0,l=Wt(i.activeOption,"[data-group]"),n=Qt(i.activeOption,"[data-selectable]"),l&&(t.keyCode===Fn?l=l.previousSibling:l=l.nextSibling,l&&(r=l.querySelectorAll("[data-selectable]"),o=r[Math.min(r.length-1,n)],o&&i.setActiveOption(o)))})}function Ho(i){const e=Object.assign({label:"&times;",title:"Remove",className:"remove",append:!0},i);var t=this;if(e.append){var n='<a href="javascript:void(0)" class="'+e.className+'" tabindex="-1" title="'+qt(e.title)+'">'+e.label+"</a>";t.hook("after","setupTemplates",()=>{var o=t.settings.render.item;t.settings.render.item=(r,l)=>{var p=Ve(o.call(t,r,l)),y=Ve(n);return p.appendChild(y),xe(y,"mousedown",I=>{Ne(I,!0)}),xe(y,"click",I=>{t.isLocked||(Ne(I,!0),!t.isLocked&&t.shouldDelete([p],I)&&(t.removeItem(p),t.refreshOptions(!1),t.inputState()))}),p}})}}function Wo(i){const e=this,t=Object.assign({text:n=>n[e.settings.labelField]},i);e.on("item_remove",function(n){if(e.isFocused&&e.control_input.value.trim()===""){var o=e.options[n];o&&e.setTextboxValue(t.text.call(e,o))}})}function Go(){const i=this,e=i.canLoad,t=i.clearActiveOption,n=i.loadCallback;var o={},r,l=!1,p,y=[];if(i.settings.shouldLoadMore||(i.settings.shouldLoadMore=()=>{if(r.clientHeight/(r.scrollHeight-r.scrollTop)>.9)return!0;if(i.activeOption){var k=i.selectable(),j=Array.from(k).indexOf(i.activeOption);if(j>=k.length-2)return!0}return!1}),!i.settings.firstUrl)throw"virtual_scroll plugin requires a firstUrl() method";i.settings.sortField=[{field:"$order"},{field:"$score"}];const I=C=>typeof i.settings.maxOptions=="number"&&r.children.length>=i.settings.maxOptions?!1:!!(C in o&&o[C]),b=(C,k)=>i.items.indexOf(k)>=0||y.indexOf(k)>=0;i.setNextUrl=(C,k)=>{o[C]=k},i.getUrl=C=>{if(C in o){const k=o[C];return o[C]=!1,k}return i.clearPagination(),i.settings.firstUrl.call(i,C)},i.clearPagination=()=>{o={}},i.hook("instead","clearActiveOption",()=>{if(!l)return t.call(i)}),i.hook("instead","canLoad",C=>C in o?I(C):e.call(i,C)),i.hook("instead","loadCallback",(C,k)=>{if(!l)i.clearOptions(b);else if(p){const j=C[0];j!==void 0&&(p.dataset.value=j[i.settings.valueField])}n.call(i,C,k),l=!1}),i.hook("after","refreshOptions",()=>{const C=i.lastValue;var k;I(C)?(k=i.render("loading_more",{query:C}),k&&(k.setAttribute("data-selectable",""),p=k)):C in o&&!r.querySelector(".no-results")&&(k=i.render("no_more_results",{query:C})),k&&(ze(k,i.settings.optionClass),r.append(k))}),i.on("initialize",()=>{y=Object.keys(i.options),r=i.dropdown_content,i.settings.render=Object.assign({},{loading_more:()=>'<div class="loading-more-results">Loading more results ... </div>',no_more_results:()=>'<div class="no-more-results">No more results</div>'},i.settings.render),r.addEventListener("scroll",()=>{i.settings.shouldLoadMore.call(i)&&I(i.lastValue)&&(l||(l=!0,i.load.call(i,i.lastValue)))})})}Ye.define("change_listener",Co);Ye.define("checkbox_options",Ao);Ye.define("clear_button",Do);Ye.define("drag_drop",Mo);Ye.define("dropdown_header",Ro);Ye.define("caret_position",Bo);Ye.define("dropdown_input",Fo);Ye.define("input_autogrow",Xo);Ye.define("no_backspace_delete",Vo);Ye.define("no_active_items",Uo);Ye.define("optgroup_columns",jo);Ye.define("remove_button",Ho);Ye.define("restore_on_backspace",Wo);Ye.define("virtual_scroll",Go);async function qo(i){if(!A.ready)return;const t=(await P.scene.local.getItems(o=>o.layer==="CHARACTER"))?.map(o=>o.id);let n=!1;for(const o of i){const r=o.metadata[`${m.SPECTREID}/metadata_ghosts`];if(r?.length>0){n=!0;const l=r.map(y=>y.id);for(const y of r){const I=y.metadata[`${m.SPECTREID}/viewers`];I&&(I.includes(A.userId)?await P.scene.local.addItems([y]):t.includes(y.id)&&await P.scene.local.deleteItems([y.id]))}const p=t.filter(y=>!l.includes(y));p?.length>0&&await P.scene.local.deleteItems(p)}}n||await P.scene.local.deleteItems(t)}function zo(){const i=document.querySelectorAll(".tSelects");for(const e of i)if(e&&e.tomselect){const t=e.tomselect,n=[];for(const o of A.players)n.push({value:o.id,text:o.name});t.clearOptions(),t.addOption(n),n.length===0?(t.settings.placeholder="No Players",t.inputState()):(t.settings.placeholder="Choose..",t.inputState())}}async function Ko(){let i=A.metadata[`${m.SPECTREID}/stored`];i&&(await P.scene.local.addItems(i),i.forEach(e=>{Gi(e)}))}async function Yo(){P.scene.local.onChange(async i=>{const e=i.filter(n=>n.layer=="CHARACTER");if(e.length===0)return;const t={};t[`${m.SPECTREID}/metadata_ghosts`]=e,await P.player.setMetadata(t)}),await P.contextMenu.create({id:`${m.SPECTREID}/context-menu`,icons:[{icon:"/ghost.svg",label:"Spectre",filter:{every:[{key:"layer",value:"CHARACTER"},{key:["metadata",`${m.SPECTREID}/spectred`],value:void 0,operator:"==",coordinator:"&&"}]}},{icon:"/ghost.svg",label:"Un-Spectre",filter:{every:[{key:"layer",value:"CHARACTER"},{key:["metadata",`${m.SPECTREID}/spectred`],value:void 0,operator:"!=",coordinator:"&&"}]}}],async onClick(i){if(i.items.every(t=>t.metadata[`${m.SPECTREID}/spectred`]===void 0)){document.getElementById("spectreWarning").style.display="none";for(const t of i.items)Gi(t)}else for(const t of i.items){const n=t;n.metadata[`${m.SPECTREID}/spectred`]=void 0;const o=A.ghosts.findIndex(l=>l.id===n.id);A.ghosts.splice(o,1),document.getElementById(`tr-${n.id}`)?.remove(),await Wi(n),n.metadata[`${m.SPECTREID}/viewers`]=[],await P.scene.items.addItems([n])}}})}async function Wi(i){const t=A.metadata[`${m.SPECTREID}/stored`].filter(n=>n.id!==i.id);await P.scene.setMetadata({[`${m.SPECTREID}/stored`]:t}),await P.scene.local.deleteItems([i.id])}async function Zo(i){let e=A.metadata[`${m.SPECTREID}/stored`];if(!e)e=[i];else{if(e.find(n=>n.id===i.id))return;e.push(i)}await P.scene.setMetadata({[`${m.SPECTREID}/stored`]:e})}async function Gi(i){const e=i.text?.plainText||i.name;i.metadata[`${m.SPECTREID}/spectred`]=!0,await P.scene.items.deleteItems([i.id]),await P.scene.local.addItems([i]),await Zo(i),A.ghosts.push(i);const t=document.getElementById("ghostList"),n=document.createElement("tr");n.id=`tr-${i.id}`,n.className="ghost-table-entry",n.innerHTML=`<td class="token-name">${e}</td>
        <td><select id="select-${i.id}" class="tSelects" multiple autocomplete="off" /></td>
        <td><input type="button" class="mysteryButton" id="deleteGhost-${i.id}" value="Delete"/></td>`,t.appendChild(n);const o=document.getElementById(`select-${i.id}`);for(const p of A.players){const y=document.createElement("option");y.value=p.id,y.text=p.name,o.appendChild(y)}const r={plugins:{remove_button:{title:"Remove this item"}},allowEmptyOption:!0,placeholder:A.players.length==0?"No Players":"Choose..",maxItems:null,create:!1,onDelete:async function(p,y){const I=y.currentTarget.parentElement.parentElement.parentElement.parentElement.parentElement.id.slice(3);await P.scene.local.updateItems([I],b=>{const C=b[0].metadata[`${m.SPECTREID}/viewers`],k=C.findIndex(j=>j==p);C.splice(k,1),b[0].metadata[`${m.SPECTREID}/viewers`]=C})},onItemAdd:async function(p,y){const I=y.parentElement.parentElement.parentElement.parentElement.id.slice(3);await P.scene.local.updateItems([I],b=>{const C=b[0].metadata[`${m.SPECTREID}/viewers`];C?(C.push(p),b[0].metadata[`${m.SPECTREID}/viewers`]=C):b[0].metadata[`${m.SPECTREID}/viewers`]=[p]})}};new Ye(`#select-${i.id}`,r);const l=document.getElementById(`deleteGhost-${i.id}`);l.onclick=async()=>{const p=A.ghosts.findIndex(y=>y.id===i.id);A.ghosts.splice(p,1),n.remove(),await P.scene.local.updateItems([i.id],y=>{y[0].metadata[`${m.SPECTREID}/viewers`]=[]}),await Wi(i)}}var qi={exports:{}};(function(i){(function(){function e(p,y){var I=p.x-y.x,b=p.y-y.y;return I*I+b*b}function t(p,y,I){var b=y.x,C=y.y,k=I.x-b,j=I.y-C;if(k!==0||j!==0){var T=((p.x-b)*k+(p.y-C)*j)/(k*k+j*j);T>1?(b=I.x,C=I.y):T>0&&(b+=k*T,C+=j*T)}return k=p.x-b,j=p.y-C,k*k+j*j}function n(p,y){for(var I=p[0],b=[I],C,k=1,j=p.length;k<j;k++)C=p[k],e(C,I)>y&&(b.push(C),I=C);return I!==C&&b.push(C),b}function o(p,y,I,b,C){for(var k=b,j,T=y+1;T<I;T++){var B=t(p[T],p[y],p[I]);B>k&&(j=T,k=B)}k>b&&(j-y>1&&o(p,y,j,b,C),C.push(p[j]),I-j>1&&o(p,j,I,b,C))}function r(p,y){var I=p.length-1,b=[p[0]];return o(p,0,I,y,b),b.push(p[I]),b}function l(p,y,I){if(p.length<=2)return p;var b=y!==void 0?y*y:1;return p=I?p:n(p,b),p=r(p,b),p}i.exports=l,i.exports.default=l})()})(qi);var Jo=qi.exports;const Qo=Un(Jo);async function zi(i){const e=await P.scene.items.getItems(o=>o.layer==="MAP"),t={};for(let o=0;o<e.length;o++){let r=i.querySelector("#map-"+e[o].id);r===null&&(r=document.createElement("option"),r.id="map-"+e[o].id,r.value=e[o].id,r.innerText=e[o].name,i.appendChild(r)),t[e[o].id]=e[o].name}let n=i.querySelectorAll("option");for(let o=0;o<n.length;o++)t[n[o].value]===void 0&&i.removeChild(n[o])}async function ea(i,e,t,n,o){if(o.innerText="",Number.isNaN(t)||t<0){o.innerText="Invalid DPI";return}let r=A.gridDpi/t,l,p=[];if(p[0]=0,p[1]=0,n!==""){let y=await P.scene.items.getItems([n]);if(y.length>0)l=y[0],t===0&&(t=l.grid.dpi),r=A.gridDpi/t,p[0]=l.position.x-l.grid.offset.x*r,p[1]=l.position.y-l.grid.offset.y*r;else{o.innerText="Unable to find map";return}}else{o.innerText="No map selected";return}i==="foundry"?na(e,r,p,o):i==="uvtt"&&ta(e,r,p,o)}function Ki(i,e,t,n,o){let r=0,l=0,p=0;const y=[];for(let I=0;I<i.length;I++){let b=[],C=!1;for(let k=0;k<i[I].length-1;k++){let j=i[I][k].x*e,T=i[I][k].y*e,B=i[I][k+1].x*e,N=i[I][k+1].y*e;b.push({x:j*t+n[0],y:T*t+n[1]}),b.push({x:B*t+n[0],y:N*t+n[1]}),l++,!C&&i[I][k].door&&(C=!0)}b.length>128&&(b.length,b=Qo(b,8,!1));for(let k=0;k<b.length;k+=256){const j=b.slice(k>0?k-1:0,k+256),T=Vn().tension(0).points(j).fillColor("#000000").fillOpacity(0).layer("DRAWING").name("Vision Line (Line)").closed(!1).build();if(T.visible=!1,T.metadata[`${m.EXTENSIONID}/isVisionLine`]=!0,C&&(T.metadata[`${m.EXTENSIONID}/isDoor`]=!0),y.push(T),p+=j.length,p>512||y.length>64){r+=y.length,P.scene.items.addItems(y);const B=y.filter(N=>N.metadata[`${m.EXTENSIONID}/isDoor`]===!0);Kt(B),y.length=0,p=0}}}if(y.length>0){r+=y.length,P.scene.items.addItems(y);const I=y.filter(b=>b.metadata[`${m.EXTENSIONID}/isDoor`]===!0);Kt(I)}o.innerText="Finished importing "+r+" walls, "+l+" points."}function ta(i,e,t,n){if(!i.line_of_sight||i.line_of_sight.length===0){n.innerText="No walls / los found";return}if(i.resolution.map_origin!==void 0&&(t[0]-=i.resolution.map_origin.x*i.resolution.pixels_per_grid,t[1]-=i.resolution.map_origin.y*i.resolution.pixels_per_grid),i.portals&&i.portals.length)for(let o=0;o<i.portals.length;o++){let r=i.portals[o].bounds;r[0].door=!0,r[1].door=!0,i.line_of_sight.push(r)}Ki(i.line_of_sight,i.resolution.pixels_per_grid,e,t,n)}function na(i,e,t,n){if(!i.walls||i.walls.length===0){n.innerText="No walls found";return}const o=[];for(var r=0;r<i.walls.length;r++)o.push([{x:i.walls[r].c[0],y:i.walls[r].c[1],door:!!i.walls[r].door},{x:i.walls[r].c[2],y:i.walls[r].c[3],door:!!i.walls[r].door}]);Ki(o,1,e,t,n)}var Je=function(){/*!
* Copyright (c) 2021-2023 Momo Bassit.
* Licensed under the MIT License (MIT)
* https://github.com/mdbassit/Coloris
* Version: 0.21.1
* NPM: https://github.com/melloware/coloris-npm
*/return function(i,e,t,n){var o=e.createElement("canvas").getContext("2d"),r={r:0,g:0,b:0,h:0,s:0,v:0,a:1},l,p,y,I,b,C,k,j,T,B,N,R,D,L,X,Z,O={},v={el:"[data-coloris]",parent:"body",theme:"default",themeMode:"light",rtl:!1,wrap:!0,margin:2,format:"hex",formatToggle:!1,swatches:[],swatchesOnly:!1,alpha:!0,forceAlpha:!1,focusInput:!0,selectInput:!1,inline:!1,defaultColor:"#000000",clearButton:!1,clearLabel:"Clear",closeButton:!1,closeLabel:"Close",onChange:function(){return n},a11y:{open:"Open color picker",close:"Close color picker",clear:"Clear the selected color",marker:"Saturation: {s}. Brightness: {v}.",hueSlider:"Hue slider",alphaSlider:"Opacity slider",input:"Color value field",format:"Color format",swatch:"Color swatch",instruction:"Saturation and brightness selector. Use up, down, left and right arrow keys to select."}},h={},E="",d={},_=!1;function $(S){if(typeof S=="object"){var H=function(){switch(W){case"el":ge(S.el),S.wrap!==!1&&he(S.el);break;case"parent":l=e.querySelector(S.parent),l&&(l.appendChild(p),v.parent=S.parent,l===e.body&&(l=n));break;case"themeMode":v.themeMode=S.themeMode,S.themeMode==="auto"&&i.matchMedia&&i.matchMedia("(prefers-color-scheme: dark)").matches&&(v.themeMode="dark");case"theme":S.theme&&(v.theme=S.theme),p.className="clr-picker clr-"+v.theme+" clr-"+v.themeMode,v.inline&&we();break;case"rtl":v.rtl=!!S.rtl,e.querySelectorAll(".clr-field").forEach(function(Fe){return Fe.classList.toggle("clr-rtl",v.rtl)});break;case"margin":S.margin*=1,v.margin=isNaN(S.margin)?v.margin:S.margin;break;case"wrap":S.el&&S.wrap&&he(S.el);break;case"formatToggle":v.formatToggle=!!S.formatToggle,fe("clr-format").style.display=v.formatToggle?"block":"none",v.formatToggle&&(v.format="auto");break;case"swatches":if(Array.isArray(S.swatches)){var ue=[];S.swatches.forEach(function(Fe,Ee){ue.push('<button type="button" id="clr-swatch-'+Ee+'" aria-labelledby="clr-swatch-label clr-swatch-'+Ee+'" style="color: '+Fe+';">'+Fe+"</button>")}),fe("clr-swatches").innerHTML=ue.length?"<div>"+ue.join("")+"</div>":"",v.swatches=S.swatches.slice()}break;case"swatchesOnly":v.swatchesOnly=!!S.swatchesOnly,p.setAttribute("data-minimal",v.swatchesOnly);break;case"alpha":v.alpha=!!S.alpha,p.setAttribute("data-alpha",v.alpha);break;case"inline":if(v.inline=!!S.inline,p.setAttribute("data-inline",v.inline),v.inline){var pe=S.defaultColor||v.defaultColor;L=$e(pe),we(),Ie(pe)}break;case"clearButton":typeof S.clearButton=="object"&&(S.clearButton.label&&(v.clearLabel=S.clearButton.label,k.innerHTML=v.clearLabel),S.clearButton=S.clearButton.show),v.clearButton=!!S.clearButton,k.style.display=v.clearButton?"block":"none";break;case"clearLabel":v.clearLabel=S.clearLabel,k.innerHTML=v.clearLabel;break;case"closeButton":v.closeButton=!!S.closeButton,v.closeButton?p.insertBefore(j,b):b.appendChild(j);break;case"closeLabel":v.closeLabel=S.closeLabel,j.innerHTML=v.closeLabel;break;case"a11y":var de=S.a11y,Ae=!1;if(typeof de=="object")for(var ve in de)de[ve]&&v.a11y[ve]&&(v.a11y[ve]=de[ve],Ae=!0);if(Ae){var Be=fe("clr-open-label"),Te=fe("clr-swatch-label");Be.innerHTML=v.a11y.open,Te.innerHTML=v.a11y.swatch,j.setAttribute("aria-label",v.a11y.close),k.setAttribute("aria-label",v.a11y.clear),T.setAttribute("aria-label",v.a11y.hueSlider),N.setAttribute("aria-label",v.a11y.alphaSlider),C.setAttribute("aria-label",v.a11y.input),y.setAttribute("aria-label",v.a11y.instruction)}break;default:v[W]=S[W]}};for(var W in S)H()}}function te(S,H){typeof S=="string"&&typeof H=="object"&&(h[S]=H,_=!0)}function re(S){delete h[S],Object.keys(h).length===0&&(_=!1,S===E&&J())}function se(S){if(_){var H=["el","wrap","rtl","inline","defaultColor","a11y"],W=function(){var de=h[ee];if(S.matches(ee)){E=ee,d={},H.forEach(function(ve){return delete de[ve]});for(var Ae in de)d[Ae]=Array.isArray(v[Ae])?v[Ae].slice():v[Ae];return $(de),"break"}};for(var ee in h){var ue=W();if(ue==="break")break}}}function J(){Object.keys(d).length>0&&($(d),E="",d={})}function ge(S){me(e,"click",S,function(H){v.inline||(se(H.target),D=H.target,X=D.value,L=$e(X),p.classList.add("clr-open"),we(),Ie(X),(v.focusInput||v.selectInput)&&(C.focus({preventScroll:!0}),C.setSelectionRange(D.selectionStart,D.selectionEnd)),v.selectInput&&C.select(),(Z||v.swatchesOnly)&&Se().shift().focus(),D.dispatchEvent(new Event("open",{bubbles:!0})))}),me(e,"input",S,function(H){var W=H.target.parentNode;W.classList.contains("clr-field")&&(W.style.color=H.target.value)})}function we(){if(!(!p||!D&&!v.inline)){var S=l,H=i.scrollY,W=p.offsetWidth,ee=p.offsetHeight,ue={left:!1,top:!1},pe,de,Ae,ve={x:0,y:0};if(S&&(pe=i.getComputedStyle(S),de=parseFloat(pe.marginTop),Ae=parseFloat(pe.borderTopWidth),ve=S.getBoundingClientRect(),ve.y+=Ae+H),!v.inline){var Be=D.getBoundingClientRect(),Te=Be.x,Fe=H+Be.y+Be.height+v.margin;S?(Te-=ve.x,Fe-=ve.y,Te+W>S.clientWidth&&(Te+=Be.width-W,ue.left=!0),Fe+ee>S.clientHeight-de&&ee+v.margin<=Be.top-(ve.y-H)&&(Fe-=Be.height+ee+v.margin*2,ue.top=!0),Fe+=S.scrollTop):(Te+W>e.documentElement.clientWidth&&(Te+=Be.width-W,ue.left=!0),Fe+ee-H>e.documentElement.clientHeight&&ee+v.margin<=Be.top&&(Fe=H+Be.y-ee-v.margin,ue.top=!0)),p.classList.toggle("clr-left",ue.left),p.classList.toggle("clr-top",ue.top),p.style.left=Te+"px",p.style.top=Fe+"px",ve.x+=p.offsetLeft,ve.y+=p.offsetTop}O={width:y.offsetWidth,height:y.offsetHeight,x:y.offsetLeft+ve.x,y:y.offsetTop+ve.y}}}function he(S){e.querySelectorAll(S).forEach(function(H){var W=H.parentNode;if(!W.classList.contains("clr-field")){var ee=e.createElement("div"),ue="clr-field";(v.rtl||H.classList.contains("clr-rtl"))&&(ue+=" clr-rtl"),ee.innerHTML='<button type="button" aria-labelledby="clr-open-label"></button>',W.insertBefore(ee,H),ee.setAttribute("class",ue),ee.style.color=H.value,ee.appendChild(H)}})}function ae(S){if(D&&!v.inline){var H=D;S&&(D=n,X!==H.value&&(H.value=X,H.dispatchEvent(new Event("input",{bubbles:!0})))),setTimeout(function(){X!==H.value&&H.dispatchEvent(new Event("change",{bubbles:!0}))}),p.classList.remove("clr-open"),_&&J(),H.dispatchEvent(new Event("close",{bubbles:!0})),v.focusInput&&H.focus({preventScroll:!0}),D=n}}function Ie(S){var H=ce(S),W=oe(H);Ue(W.s,W.v),c(H,W),T.value=W.h,p.style.color="hsl("+W.h+", 100%, 50%)",B.style.left=W.h/360*100+"%",I.style.left=O.width*W.s/100+"px",I.style.top=O.height-O.height*W.v/100+"px",N.value=W.a*100,R.style.left=W.a*100+"%"}function $e(S){var H=S.substring(0,3).toLowerCase();return H==="rgb"||H==="hsl"?H:"hex"}function ye(S){S=S!==n?S:C.value,D&&(D.value=S,D.dispatchEvent(new Event("input",{bubbles:!0}))),v.onChange&&v.onChange.call(i,S,D),e.dispatchEvent(new CustomEvent("coloris:pick",{detail:{color:S,currentEl:D}}))}function Pe(S,H){var W={h:T.value*1,s:S/O.width*100,v:100-H/O.height*100,a:N.value/100},ee=V(W);Ue(W.s,W.v),c(ee,W),ye()}function Ue(S,H){var W=v.a11y.marker;S=S.toFixed(1)*1,H=H.toFixed(1)*1,W=W.replace("{s}",S),W=W.replace("{v}",H),I.setAttribute("aria-label",W)}function Xe(S){return{pageX:S.changedTouches?S.changedTouches[0].pageX:S.pageX,pageY:S.changedTouches?S.changedTouches[0].pageY:S.pageY}}function Re(S){var H=Xe(S),W=H.pageX-O.x,ee=H.pageY-O.y;l&&(ee+=l.scrollTop),f(W,ee),S.preventDefault(),S.stopPropagation()}function K(S,H){var W=I.style.left.replace("px","")*1+S,ee=I.style.top.replace("px","")*1+H;f(W,ee)}function f(S,H){S=S<0?0:S>O.width?O.width:S,H=H<0?0:H>O.height?O.height:H,I.style.left=S+"px",I.style.top=H+"px",Pe(S,H),I.focus()}function c(S,H){S===void 0&&(S={}),H===void 0&&(H={});var W=v.format;for(var ee in S)r[ee]=S[ee];for(var ue in H)r[ue]=H[ue];var pe=le(r),de=pe.substring(0,7);switch(I.style.color=de,R.parentNode.style.color=de,R.style.color=pe,b.style.color=pe,y.style.display="none",y.offsetHeight,y.style.display="",R.nextElementSibling.style.display="none",R.nextElementSibling.offsetHeight,R.nextElementSibling.style.display="",W==="mixed"?W=r.a===1?"hex":"rgb":W==="auto"&&(W=L),W){case"hex":C.value=pe;break;case"rgb":C.value=be(r);break;case"hsl":C.value=Ce(G(r));break}e.querySelector('.clr-format [value="'+W+'"]').checked=!0}function w(){var S=T.value*1,H=I.style.left.replace("px","")*1,W=I.style.top.replace("px","")*1;p.style.color="hsl("+S+", 100%, 50%)",B.style.left=S/360*100+"%",Pe(H,W)}function F(){var S=N.value/100;R.style.left=S*100+"%",c({a:S}),ye()}function V(S){var H=S.s/100,W=S.v/100,ee=H*W,ue=S.h/60,pe=ee*(1-t.abs(ue%2-1)),de=W-ee;ee=ee+de,pe=pe+de;var Ae=t.floor(ue)%6,ve=[ee,pe,de,de,pe,ee][Ae],Be=[pe,ee,ee,pe,de,de][Ae],Te=[de,de,pe,ee,ee,pe][Ae];return{r:t.round(ve*255),g:t.round(Be*255),b:t.round(Te*255),a:S.a}}function G(S){var H=S.v/100,W=H*(1-S.s/100/2),ee;return W>0&&W<1&&(ee=t.round((H-W)/t.min(W,1-W)*100)),{h:S.h,s:ee||0,l:t.round(W*100),a:S.a}}function oe(S){var H=S.r/255,W=S.g/255,ee=S.b/255,ue=t.max(H,W,ee),pe=t.min(H,W,ee),de=ue-pe,Ae=ue,ve=0,Be=0;return de&&(ue===H&&(ve=(W-ee)/de),ue===W&&(ve=2+(ee-H)/de),ue===ee&&(ve=4+(H-W)/de),ue&&(Be=de/ue)),ve=t.floor(ve*60),{h:ve<0?ve+360:ve,s:t.round(Be*100),v:t.round(Ae*100),a:S.a}}function ce(S){var H=/^((rgba)|rgb)[\D]+([\d.]+)[\D]+([\d.]+)[\D]+([\d.]+)[\D]*?([\d.]+|$)/i,W,ee;return o.fillStyle="#000",o.fillStyle=S,W=H.exec(o.fillStyle),W?(ee={r:W[3]*1,g:W[4]*1,b:W[5]*1,a:W[6]*1},ee.a=+ee.a.toFixed(2)):(W=o.fillStyle.replace("#","").match(/.{2}/g).map(function(ue){return parseInt(ue,16)}),ee={r:W[0],g:W[1],b:W[2],a:1}),ee}function le(S){var H=S.r.toString(16),W=S.g.toString(16),ee=S.b.toString(16),ue="";if(S.r<16&&(H="0"+H),S.g<16&&(W="0"+W),S.b<16&&(ee="0"+ee),v.alpha&&(S.a<1||v.forceAlpha)){var pe=S.a*255|0;ue=pe.toString(16),pe<16&&(ue="0"+ue)}return"#"+H+W+ee+ue}function be(S){return!v.alpha||S.a===1&&!v.forceAlpha?"rgb("+S.r+", "+S.g+", "+S.b+")":"rgba("+S.r+", "+S.g+", "+S.b+", "+S.a+")"}function Ce(S){return!v.alpha||S.a===1&&!v.forceAlpha?"hsl("+S.h+", "+S.s+"%, "+S.l+"%)":"hsla("+S.h+", "+S.s+"%, "+S.l+"%, "+S.a+")"}function Me(){e.getElementById("clr-picker")||(l=n,p=e.createElement("div"),p.setAttribute("id","clr-picker"),p.className="clr-picker",p.innerHTML='<input id="clr-color-value" name="clr-color-value" class="clr-color" type="text" value="" spellcheck="false" aria-label="'+v.a11y.input+'">'+('<div id="clr-color-area" class="clr-gradient" role="application" aria-label="'+v.a11y.instruction+'">')+'<div id="clr-color-marker" class="clr-marker" tabindex="0"></div></div><div class="clr-hue">'+('<input id="clr-hue-slider" name="clr-hue-slider" type="range" min="0" max="360" step="1" aria-label="'+v.a11y.hueSlider+'">')+'<div id="clr-hue-marker"></div></div><div class="clr-alpha">'+('<input id="clr-alpha-slider" name="clr-alpha-slider" type="range" min="0" max="100" step="1" aria-label="'+v.a11y.alphaSlider+'">')+'<div id="clr-alpha-marker"></div><span></span></div><div id="clr-format" class="clr-format"><fieldset class="clr-segmented">'+("<legend>"+v.a11y.format+"</legend>")+'<input id="clr-f1" type="radio" name="clr-format" value="hex"><label for="clr-f1">Hex</label><input id="clr-f2" type="radio" name="clr-format" value="rgb"><label for="clr-f2">RGB</label><input id="clr-f3" type="radio" name="clr-format" value="hsl"><label for="clr-f3">HSL</label><span></span></fieldset></div><div id="clr-swatches" class="clr-swatches"></div>'+('<button type="button" id="clr-clear" class="clr-clear" aria-label="'+v.a11y.clear+'">'+v.clearLabel+"</button>")+'<div id="clr-color-preview" class="clr-preview">'+('<button type="button" id="clr-close" class="clr-close" aria-label="'+v.a11y.close+'">'+v.closeLabel+"</button>")+"</div>"+('<span id="clr-open-label" hidden>'+v.a11y.open+"</span>")+('<span id="clr-swatch-label" hidden>'+v.a11y.swatch+"</span>"),e.body.appendChild(p),y=fe("clr-color-area"),I=fe("clr-color-marker"),k=fe("clr-clear"),j=fe("clr-close"),b=fe("clr-color-preview"),C=fe("clr-color-value"),T=fe("clr-hue-slider"),B=fe("clr-hue-marker"),N=fe("clr-alpha-slider"),R=fe("clr-alpha-marker"),ge(v.el),he(v.el),me(p,"mousedown",function(S){p.classList.remove("clr-keyboard-nav"),S.stopPropagation()}),me(y,"mousedown",function(S){me(e,"mousemove",Re)}),me(y,"touchstart",function(S){e.addEventListener("touchmove",Re,{passive:!1})}),me(I,"mousedown",function(S){me(e,"mousemove",Re)}),me(I,"touchstart",function(S){e.addEventListener("touchmove",Re,{passive:!1})}),me(C,"change",function(S){var H=C.value;if(D||v.inline){var W=H===""?H:Ie(H);ye(W)}}),me(k,"click",function(S){ye(""),ae()}),me(j,"click",function(S){ye(),ae()}),me(fe("clr-format"),"click",".clr-format input",function(S){L=S.target.value,c(),ye()}),me(p,"click",".clr-swatches button",function(S){Ie(S.target.textContent),ye(),v.swatchesOnly&&ae()}),me(e,"mouseup",function(S){e.removeEventListener("mousemove",Re)}),me(e,"touchend",function(S){e.removeEventListener("touchmove",Re)}),me(e,"mousedown",function(S){Z=!1,p.classList.remove("clr-keyboard-nav"),ae()}),me(e,"keydown",function(S){var H=S.key,W=S.target,ee=S.shiftKey,ue=["Tab","ArrowUp","ArrowDown","ArrowLeft","ArrowRight"];if(H==="Escape"?ae(!0):ue.includes(H)&&(Z=!0,p.classList.add("clr-keyboard-nav")),H==="Tab"&&W.matches(".clr-picker *")){var pe=Se(),de=pe.shift(),Ae=pe.pop();ee&&W===de?(Ae.focus(),S.preventDefault()):!ee&&W===Ae&&(de.focus(),S.preventDefault())}}),me(e,"click",".clr-field button",function(S){_&&J(),S.target.nextElementSibling.dispatchEvent(new Event("click",{bubbles:!0}))}),me(I,"keydown",function(S){var H={ArrowUp:[0,-1],ArrowDown:[0,1],ArrowLeft:[-1,0],ArrowRight:[1,0]};Object.keys(H).includes(S.key)&&(K.apply(void 0,H[S.key]),S.preventDefault())}),me(y,"click",Re),me(T,"input",w),me(N,"input",F))}function Se(){var S=Array.from(p.querySelectorAll("input, button")),H=S.filter(function(W){return!!W.offsetWidth});return H}function fe(S){return e.getElementById(S)}function me(S,H,W,ee){var ue=Element.prototype.matches||Element.prototype.msMatchesSelector;typeof W=="string"?S.addEventListener(H,function(pe){ue.call(pe.target,W)&&ee.call(pe.target,pe)}):(ee=W,S.addEventListener(H,ee))}function Ze(S,H){H=H!==n?H:[],e.readyState!=="loading"?S.apply(void 0,H):e.addEventListener("DOMContentLoaded",function(){S.apply(void 0,H)})}NodeList!==n&&NodeList.prototype&&!NodeList.prototype.forEach&&(NodeList.prototype.forEach=Array.prototype.forEach);function ct(S,H){D=H,X=D.value,se(H),L=$e(S),we(),Ie(S),ye(),X!==S&&D.dispatchEvent(new Event("change",{bubbles:!0}))}var it=function(){var S={init:Me,set:$,wrap:he,close:ae,setInstance:te,setColor:ct,removeInstance:re,updatePosition:we};function H(ue){Ze(function(){ue&&(typeof ue=="string"?ge(ue):$(ue))})}var W=function(pe){H[pe]=function(){for(var de=arguments.length,Ae=new Array(de),ve=0;ve<de;ve++)Ae[ve]=arguments[ve];Ze(S[pe],Ae)}};for(var ee in S)W(ee);return Ze(function(){i.addEventListener("resize",function(ue){H.updatePosition()}),i.addEventListener("scroll",function(ue){H.updatePosition()})}),H}();return it.coloris=it,it}(window,document,Math)}();Je.coloris;Je.init;Je.set;Je.wrap;Je.close;Je.setInstance;Je.removeInstance;Je.updatePosition;function ia(i){for(const e in i)if(i.hasOwnProperty(e))return!1;return!0}function Ni(){try{localStorage.setItem("STORAGECHECK","test")}catch{const e=document.getElementById("localStorageWarning");e.innerText="Local Storage disabled. Some features will not function."}}function Yi(i,e){const t=window.matchMedia("(prefers-color-scheme: dark)"),n=t.matches?"dark":"light",o=t.matches?"light":"dark";for(var r=0;r<e.styleSheets.length;r++)for(var l=0;l<e.styleSheets[r].cssRules.length;l++){let p=e.styleSheets[r].cssRules[l];p&&p.media&&p.media.mediaText.includes("prefers-color-scheme")&&(i.mode=="LIGHT"?(p.media.appendMedium(`(prefers-color-scheme: ${n})`),p.media.mediaText.includes(o)&&p.media.deleteMedium(`(prefers-color-scheme: ${o})`)):i.mode=="DARK"&&(p.media.appendMedium(`(prefers-color-scheme: ${o})`),p.media.mediaText.includes(n)&&p.media.deleteMedium(`(prefers-color-scheme: ${n})`)))}}async function Wn(){const i=A.items.filter(Ci);if(!A.metadata[`${m.EXTENSIONID}/autodetectEnabled`])if(i.length==0){let e=wt().width(A.gridDpi*30).height(A.gridDpi*30).visible(!1).shapeType("RECTANGLE").visible(!0).locked(!1).strokeColor("pink").fillOpacity(0).strokeDash([200,500]).strokeWidth(50).build();e.metadata[`${m.EXTENSIONID}/isBackgroundImage`]=!0,e.id=m.GRIDID,await P.scene.items.addItems([e])}else A.items.find(e=>e.id===m.GRIDID),await P.scene.items.updateItems([m.GRIDID],e=>{e[0].visible=!1,e[0].style.strokeOpacity=1,e[0].disableHit=!1});A.metadata[`${m.EXTENSIONID}/autodetectEnabled`]===!0&&i.length>0&&await P.scene.items.updateItems([m.GRIDID],e=>{e[0].visible=!1,e[0].style.strokeOpacity=.1,e[0].disableHit=!0})}function ra(i){function e(){document.getElementById("contextMenu").style.display="none"}const t=document.getElementById(`tr-${i.id}`);if(t){const n=t.getElementsByClassName("token-name")[0],o=t.getElementsByClassName("token-vision-range")[0],r=t.getElementsByClassName("unlimited-vision")[0],l=t.getElementsByClassName("no-vision")[0];n&&(n.innerText=i.name),o&&!r.checked&&!l.checked&&(o.value=i.metadata[`${m.EXTENSIONID}/visionRange`]!==void 0?i.metadata[`${m.EXTENSIONID}/visionRange`]:m.VISIONDEFAULT),r&&(r.checked=i.metadata[`${m.EXTENSIONID}/visionRange`]===0),l&&(l.checked=i.metadata[`${m.EXTENSIONID}/visionBlind`]),r.checked||l.checked?o.setAttribute("disabled","disabled"):o.removeAttribute("disabled")}else{const n=A.players.find(b=>i.createdUserId===b.id)?.color,o=A.items.find(b=>b.id===i.id),r=document.createElement("tr");r.id=`tr-${o.id}`,r.className="token-table-entry",r.innerHTML=`<td id="contextLocator" data-color="${n}" class="token-name">${o.name}</td>
                           <td class="token-vision-container" title="The unit of measurement for your grid"><input class="token-vision-range" type="number" value=${m.VISIONDEFAULT}><span class="unit">units</span></td>
                           <td class="token-vision-container-grid">
                            <div class="vision-container-div">
                                <label class="cbutton" title="Unlimited vision range"><input type="checkbox" class="unlimited-vision"><span class="emoji">&infin;</span></label>
                                <label class="cbutton" title="Turn token into a light source"><input type="checkbox" class="torch-vision"><span class="emoji">&#128294;</span></label>
                                <label class="cbutton" title="Disable vision on this token"><input type="checkbox" class="no-vision"><span class="emoji">&#8856;</span></label>
                            </div>
                           </td>`,ie.table.appendChild(r);const l=r.getElementsByClassName("token-vision-range")[0],p=r.getElementsByClassName("unlimited-vision")[0],y=r.getElementsByClassName("torch-vision")[0],I=r.getElementsByClassName("no-vision")[0];r.getElementsByClassName("token-name")[0].style.textShadow=`
        -2px -2px 2px ${n},
        2px -2px 2px ${n},
        -2px 2px 2px ${n},
        2px 2px 2px ${n}`,l&&!p.checked&&!I.checked&&(l.value=i.metadata[`${m.EXTENSIONID}/visionRange`]?i.metadata[`${m.EXTENSIONID}/visionRange`]:m.VISIONDEFAULT),p&&(p.checked=i.metadata[`${m.EXTENSIONID}/visionRange`]===0),y&&(y.checked=i.metadata[`${m.EXTENSIONID}/visionTorch`]),I&&(I.checked=i.metadata[`${m.EXTENSIONID}/visionBlind`]),p.checked||I.checked?l.setAttribute("disabled","disabled"):l.removeAttribute("disabled"),l.onchange=async b=>{if(!b||!b.target)return;const C=A.items.find(T=>T.id===i.id),k=b.target,j=parseInt(k.value);j<0&&(k.value="0"),j>999&&(k.value="999"),await P.scene.items.updateItems([C],T=>{T[0].metadata[`${m.EXTENSIONID}/visionRange`]=j})},p.onclick=async b=>{if(!b||!b.target)return;const C=A.items.find(T=>T.id===i.id);let k=0;b.target.checked?(l.setAttribute("disabled","disabled"),I.checked=!1):(k=parseInt(l.value),l.removeAttribute("disabled")),await P.scene.items.updateItems([C],T=>{T[0].metadata[`${m.EXTENSIONID}/visionRange`]=k})},I.onclick=async b=>{if(!b||!b.target)return;const C=A.items.find(j=>j.id===i.id),k=b.target;k.checked?l.setAttribute("disabled","disabled"):l.removeAttribute("disabled"),await P.scene.items.updateItems([C],j=>{j[0].metadata[`${m.EXTENSIONID}/visionBlind`]=k.checked})},y.onclick=async b=>{if(!b||!b.target)return;const C=A.items.find(j=>j.id===i.id),k=b.target;await P.scene.items.updateItems([C],j=>{j[0].metadata[`${m.EXTENSIONID}/visionTorch`]=k.checked})},l.addEventListener("mousewheel",async()=>{}),r.oncontextmenu=async function(b){b.preventDefault();const C=b.currentTarget,k=document.getElementById("contextMenu"),j=N=>{N.preventDefault()},T=async N=>{const R=N.target,D=k.getAttribute("currentUnit"),L=A.players.find(O=>R.id===O.id)?.color,Z=document.getElementById(`tr-${D}`).getElementsByClassName("token-name")[0];L?Z.style.textShadow=`
                    -2px -2px 2px ${L},
                    2px -2px 2px ${L},
                    -2px 2px 2px ${L},
                    2px 2px 2px ${L}`:Z.style.textShadow="",await P.scene.items.updateItems([D],O=>{for(const v of O)v.createdUserId=R.id}),k.style.display="none",N.stopPropagation(),window.removeEventListener("click",B),k.removeEventListener("click",T),k.removeEventListener("contextmenu",j)};k.setAttribute("currentUnit",C.id.substring(3));const B=()=>{k.style.display="none",window.removeEventListener("click",B),k.removeEventListener("click",T),k.removeEventListener("contextmenu",j)};if(k.addEventListener("click",T),k.addEventListener("contextmenu",j),window.addEventListener("click",B),k.style.display=="block")e();else{const N=Math.min(b.pageX,window.innerWidth-150),R=Math.min(b.pageY,(window.innerHeight>300?window.innerHeight-50:window.innerHeight)-120);k.style.display="block",k.style.left=N+"px",k.style.top=R+"px"}}}}async function oa(){await P.contextMenu.create({id:`${m.EXTENSIONID}/toggle-vision-menu`,icons:[{icon:"/no-vision.svg",label:"Enable Vision",filter:{every:[{key:["metadata",`${m.EXTENSIONID}/hasVision`],operator:"==",value:void 0,coordinator:"&&"},{key:["metadata",`${m.SPECTREID}/spectred`],operator:"==",value:void 0}],some:[{key:"layer",value:"CHARACTER",coordinator:"||"},{key:"layer",value:"ATTACHMENT"}]}},{icon:"/icon.svg",label:"Disable Vision",filter:{every:[{key:["metadata",`${m.SPECTREID}/spectred`],operator:"==",value:void 0}],some:[{key:"layer",value:"CHARACTER",coordinator:"||"},{key:"layer",value:"ATTACHMENT"}]}}],async onClick(i){const e=i.items.every(t=>t.metadata[`${m.EXTENSIONID}/hasVision`]===void 0);await P.scene.items.updateItems(i.items,t=>{for(const n of t)e?(n.metadata[`${m.EXTENSIONID}/hasVision`]=!0,n.metadata[`${m.EXTENSIONID}/visionRange`]===void 0&&(n.metadata[`${m.EXTENSIONID}/visionRange`]=m.VISIONDEFAULT)):delete n.metadata[`${m.EXTENSIONID}/hasVision`]})}}),await P.contextMenu.create({id:`${m.EXTENSIONID}/toggle-groupvision-menu`,icons:[{icon:"/no-vision.svg",label:"Toggle Attachments Vision",filter:{every:[{key:"layer",value:"NOTE"},{key:["metadata",`${m.EXTENSIONID}/hasVision`],value:void 0}]}}],async onClick(i){if(i.items.length>0){const e=i.items.map(n=>n.id),t=await P.scene.items.getItemAttachments(e);await P.scene.items.updateItems(t,n=>{for(const o of n)e.includes(o.attachedTo)&&(o.metadata[`${m.EXTENSIONID}/hasVision`]&&(o.layer=="CHARACTER"||o.layer=="ATTACHMENT")?delete o.metadata[`${m.EXTENSIONID}/hasVision`]:(o.layer=="CHARACTER"||o.layer=="ATTACHMENT")&&(o.metadata[`${m.EXTENSIONID}/hasVision`]=!0,o.metadata[`${m.EXTENSIONID}/visionRange`]===void 0&&(o.metadata[`${m.EXTENSIONID}/visionRange`]=m.VISIONDEFAULT)))})}}}),await P.contextMenu.create({id:`${m.EXTENSIONID}/toggle-vision-line`,icons:[{icon:"/icon.svg",label:"Disable Vision Line",filter:{some:[{key:["metadata",`${m.EXTENSIONID}/isVisionLine`],value:!0,coordinator:"&&"},{key:["metadata",`${m.EXTENSIONID}/disabled`],value:void 0,coordinator:"||"},{key:["metadata",`${m.ARMINDOID}/isVisionLine`],value:!0,coordinator:"&&"},{key:["metadata",`${m.ARMINDOID}/disabled`],value:void 0}]}},{icon:"/no-vision.svg",label:"Enable Vision Line",filter:{some:[{key:["metadata",`${m.EXTENSIONID}/isVisionLine`],value:!0,coordinator:"||"},{key:["metadata",`${m.ARMINDOID}/isVisionLine`],value:!0}]}}],async onClick(i){await P.scene.items.updateItems(i.items,e=>{for(const t of e)t.metadata[`${m.EXTENSIONID}/isVisionLine`]&&t.metadata[`${m.EXTENSIONID}/disabled`]?delete t.metadata[`${m.EXTENSIONID}/disabled`]:t.metadata[`${m.EXTENSIONID}/isVisionLine`]&&(t.metadata[`${m.EXTENSIONID}/disabled`]=!0)})}}),await P.contextMenu.create({id:`${m.EXTENSIONID}/switch-one-sided-type`,icons:[{icon:"/two-sided.svg",label:"Two-sided",filter:{some:[{key:["metadata",`${m.EXTENSIONID}/isVisionLine`],value:!0,coordinator:"&&"},{key:["metadata",`${m.EXTENSIONID}/oneSided`],value:void 0,coordinator:"||"},{key:["metadata",`${m.ARMINDOID}/isVisionLine`],value:!0,coordinator:"&&"},{key:["metadata",`${m.ARMINDOID}/oneSided`],value:void 0}]}},{icon:"/left-sided.svg",label:"One-sided left",filter:{some:[{key:["metadata",`${m.EXTENSIONID}/isVisionLine`],value:!0,coordinator:"&&"},{key:["metadata",`${m.EXTENSIONID}/oneSided`],value:"left",coordinator:"||"},{key:["metadata",`${m.ARMINDOID}/isVisionLine`],value:!0,coordinator:"&&"},{key:["metadata",`${m.ARMINDOID}/oneSided`],value:"left"}]}},{icon:"/right-sided.svg",label:"One-sided right",filter:{some:[{key:["metadata",`${m.EXTENSIONID}/isVisionLine`],value:!0,coordinator:"||"},{key:["metadata",`${m.ARMINDOID}/isVisionLine`],value:!0}]}}],async onClick(i){await P.scene.items.updateItems(i.items,e=>{for(const t of e)(t.metadata[`${m.EXTENSIONID}/isVisionLine`]||t.metadata[`${m.ARMINDOID}/isVisionLine`])&&(t.metadata[`${m.EXTENSIONID}/oneSided`]=="right"||t.metadata[`${m.ARMINDOID}/oneSided`]=="right")?(delete t.metadata[`${m.EXTENSIONID}/oneSided`],delete t.metadata[`${m.ARMINDOID}/oneSided`]):(t.metadata[`${m.EXTENSIONID}/isVisionLine`]||t.metadata[`${m.ARMINDOID}/isVisionLine`])&&(t.metadata[`${m.EXTENSIONID}/oneSided`]=="left"||t.metadata[`${m.ARMINDOID}/oneSided`]=="left")?(t.metadata[`${m.EXTENSIONID}/oneSided`]="right",t.metadata[`${m.ARMINDOID}/oneSided`]="right"):(t.metadata[`${m.EXTENSIONID}/isVisionLine`]||t.metadata[`${m.ARMINDOID}/isVisionLine`])&&(t.metadata[`${m.EXTENSIONID}/oneSided`]="left",t.metadata[`${m.ARMINDOID}/oneSided`]="left")})}}),await P.contextMenu.create({id:`${m.EXTENSIONID}/toggle-fog-background`,icons:[{icon:"/fog-background.svg",label:"Convert To Fog Background",filter:{every:[{key:"layer",value:"MAP"}]}}],async onClick(i){i.items.length>0&&await P.scene.items.updateItems(i.items,e=>{for(let t=0;t<e.length;t++)e[t].zIndex=1,e[t].layer="FOG",e[t].disableHit=!0,e[t].locked=!1,e[t].visible=!1,e[t].metadata[`${m.EXTENSIONID}/isBackgroundMap`]=!0})}}),await P.contextMenu.create({id:`${m.EXTENSIONID}/toggle-door`,icons:[{icon:"/opendoor.svg",label:"Enable Door",filter:{every:[{key:"layer",value:"DRAWING"},{key:["metadata",`${m.EXTENSIONID}/isDoor`],value:void 0},{key:["metadata",`${m.EXTENSIONID}/doorId`],value:void 0}],roles:["GM"]}},{icon:"/closedoor.svg",label:"Disable Door",filter:{every:[{key:"layer",value:"DRAWING"},{key:["metadata",`${m.EXTENSIONID}/doorId`],value:void 0}],roles:["GM"]}}],async onClick(i){const e=i.items.every(t=>t.metadata[`${m.EXTENSIONID}/isDoor`]===void 0);await P.scene.items.updateItems(i.items,t=>{for(const n of t)e?n.metadata[`${m.EXTENSIONID}/isDoor`]=!0:delete n.metadata[`${m.EXTENSIONID}/isDoor`]}),e?await Kt(i.items):await Rr(i.items)}})}async function Gn(i){i?await P.contextMenu.create({id:`${m.EXTENSIONID}/toggle-autohide-menu`,icons:[{icon:"/autohide-off.svg",label:"Enable Autohide",filter:{every:[{key:"layer",value:"CHARACTER"},{key:["metadata",`${m.EXTENSIONID}/hasAutohide`],value:void 0}],roles:["GM"]}},{icon:"/autohide-on.svg",label:"Disable Autohide",filter:{every:[{key:"layer",value:"CHARACTER"}],roles:["GM"]}}],async onClick(e){const t=e.items.every(n=>n.metadata[`${m.EXTENSIONID}/hasAutohide`]===void 0);await P.scene.items.updateItems(e.items,n=>{for(const o of n)t?o.metadata[`${m.EXTENSIONID}/hasAutohide`]=!0:delete o.metadata[`${m.EXTENSIONID}/hasAutohide`]})}}):await P.contextMenu.remove(`${m.EXTENSIONID}/toggle-autohide-menu`)}async function Zi(){let i,e;[A.items,A.metadata,A.gridDpi,A.gridScale,i,e]=await Promise.all([P.scene.items.getItems(),P.scene.getMetadata(),P.scene.grid.getDpi(),P.scene.grid.getScale(),P.scene.fog.getFilled(),P.scene.fog.getColor()]),await P.scene.items.deleteItems(A.items.filter(yt).map(n=>n.id)),A.snap=!0,A.gridScale=A.gridScale?.parsed?.multiplier??5,A.fog={filled:i,style:{color:e,strokeWidth:5}};let t;if(A.items.filter(Tr).length==0){const n=A.items.filter(r=>r.layer=="MAP"&&sn(r)),o=n.map(r=>r.image.width*r.image.height/Math.pow(r.grid.dpi,2));t=n[o.indexOf(Math.max(...o))]}if(A.metadata[`${m.EXTENSIONID}/autodetectEnabled`]===void 0&&(A.role==="GM"&&(ie.autodetectCheckbox.checked=!0),await P.scene.setMetadata({[`${m.EXTENSIONID}/autodetectEnabled`]:!0})),Wn(),Gn(A.metadata[`${m.EXTENSIONID}/fowEnabled`]==!0),A.metadata[`${m.EXTENSIONID}/sceneId`]===void 0)await P.scene.setMetadata({[`${m.EXTENSIONID}/sceneId`]:crypto.randomUUID()});else try{const n=A.metadata[`${m.EXTENSIONID}/sceneId`],o=localStorage.getItem(`${m.EXTENSIONID}/fogCache/${A.userId}/${n}`);if(o!==null&&A.metadata[`${m.EXTENSIONID}/persistenceEnabled`]===!0){const r=JSON.parse(o),l=[];for(let p=0;p<r.length;p++){const y=kt().commands(r[p].commands).fillRule("evenodd").locked(!0).visible(!1).fillColor("#000000").strokeColor("#000000").layer("FOG").name("Fog of War").metadata({[`${m.EXTENSIONID}/isVisionFog`]:!0,[`${m.EXTENSIONID}/digest`]:r[p].digest}).build();y.zIndex=3,l.push(y)}await P.scene.local.addItems(l)}}catch{}A.role=="GM"&&(await Ko(),ie.mapSubmit.onclick=async()=>{await P.scene.items.updateItems([m.GRIDID],n=>{for(const o of n){const r=o;r.width=A.gridDpi*+ie.mapWidth.value,r.height=A.gridDpi*+ie.mapHeight.value,r.scale={x:1,y:1}}})},await ie.UpdateUI(),t!==void 0&&await P.scene.items.updateItems([t],n=>{n[0].metadata[`${m.EXTENSIONID}/isBackgroundImage`]=!0})),A.initialized=!0}function Ji(i){const e=P.scene.fog.onChange(b=>{A.fog=b}),t=P.scene.onReadyChange(async b=>{A.ready=b,b?(I(),await Zi(),await It(),Ji(A.role)):i=="GM"&&(A.initialized=!1,await ie.UpdateUI())}),n=P.scene.grid.onChange(async b=>{A.gridDpi=b.dpi,A.gridScale=parseInt(b.scale),A.ready&&await It()}),o=P.scene.onMetadataChange(async b=>{A.metadata=b;const C=b[`${m.EXTENSIONID}/triggerReset`];if(C!==""&&C!==A.lastReset){A.lastReset=C;const k=await P.scene.local.getItems(Mn);await P.scene.local.deleteItems(k.map(T=>T.id));const j=A.metadata[`${m.EXTENSIONID}/sceneId`];localStorage.removeItem(`${m.EXTENSIONID}/fogCache/${A.userId}/${j}`),await It()}else A.role==="GM"&&await Wn(),A.ready&&await It()}),r=P.scene.items.onChange(async b=>{A.items=b,A.ready&&(i=="GM"?(await ie.UpdateUI(),await zi(ie.mapAlign)):ie.UpdatePlayerVisionList(b),await It())}),l=P.player.onChange(async b=>{const C=document.querySelectorAll(".token-table-entry");for(let k of C){let j=k.id.substring(3);b.selection!==void 0&&b.selection.includes(j)?k.classList.add("token-table-selected"):k.classList.remove("token-table-selected")}b.selection!==void 0&&b.selection.length===1&&Br(b.selection[0])}),p=P.party.onChange(async b=>{if(A.players=b,i==="PLAYER")await qo(b);else{const C=document.getElementById("playerListing");C.innerHTML="",C.appendChild(ie.GetEmptyContextItem());for(const k of b){const j=document.createElement("li");j.id=k.id,j.textContent=k.name,j.style.color=k.color,C.appendChild(j)}zo(),ie.UpdatePlayerProcessUI(b)}}),y=P.theme.onChange(b=>{Yi(b,document)});function I(){y(),p(),l(),r(),o(),n(),t(),e()}}function aa(){ie.processedIndicator.onclick=async()=>{await P.popover.open({id:m.PROCESSEDID,url:"/pages/processed.html",height:300,width:300,disableClickAway:!1})},ie.visionCheckbox.onclick=async t=>{if(!A.ready||!t.target){t.preventDefault();return}const n=t.target;await P.scene.setMetadata({[`${m.EXTENSIONID}/visionEnabled`]:n.checked}),n.checked||await P.scene.fog.setFilled(!1)},ie.snapCheckbox.checked=!0,ie.snapCheckbox.onclick=async t=>{if(!A.ready||!t.target){t.preventDefault();return}const n=t.target;A.snap=n.checked},ie.settingsButton.onclick=async t=>{!t||!t.target||(ie.settingsUIDiv.style.display==="block"?(ie.settingsUIDiv.style.display="none",ie.mainUIDiv.style.display="block"):(ie.settingsUIDiv.style.display="block",ie.mainUIDiv.style.display="none"))},ie.persistenceCheckbox.onclick=async t=>{if(!t||!t.target)return;const n=t.target;await P.scene.setMetadata({[`${m.EXTENSIONID}/persistenceEnabled`]:n.checked})},ie.autodetectCheckbox.onclick=async t=>{if(!t||!t.target)return;const n=t.target;await P.scene.setMetadata({[`${m.EXTENSIONID}/autodetectEnabled`]:n.checked}),ie.boundryOptions.style.display=n.checked?"none":"",await Wn()},ie.fowCheckbox.onclick=async t=>{if(!t||!t.target)return;const n=t.target;await Gn(n.checked),await P.scene.setMetadata({[`${m.EXTENSIONID}/fowEnabled`]:n.checked})},ie.doorCheckbox.onclick=async t=>{if(!t||!t.target)return;const n=t.target;await P.scene.setMetadata({[`${m.EXTENSIONID}/playerDoors`]:n.checked})},ie.qualityOption.onchange=async t=>{if(!t||!t.target)return;const n=t.target;await P.scene.setMetadata({[`${m.EXTENSIONID}/quality`]:n.value})},ie.resetButton.onclick=async t=>{!t||!t.target||await P.scene.setMetadata({[`${m.EXTENSIONID}/triggerReset`]:new Date().toLocaleTimeString()})},ie.debugButton.onclick=async t=>{!t||!t.target||(ie.debugDiv.style.display=="none"?(ie.debugDiv.style.display="grid",ie.debugButton.value="Disable Debugging"):(ie.debugDiv.style.display="none",ie.debugButton.value="Enable Debugging"),await P.scene.setMetadata({[`${m.EXTENSIONID}/debug`]:ie.debugDiv.style.display==="grid"}))},ie.backgroundButton.onclick=async t=>{!t||!t.target||(t.target,await P.scene.items.updateItems(n=>n.layer=="FOG"&&n.metadata[`${m.EXTENSIONID}/isBackgroundMap`]===!0,n=>{for(let o=0;o<n.length;o++)n[o].layer="MAP",n[o].disableHit=!1,n[o].locked=!1,n[o].visible=!0,delete n[o].metadata[`${m.EXTENSIONID}/isBackgroundMap`]}))};let i;ie.fowColor.onclick=()=>{Je({el:`#${ie.fowColor.id}`,alpha:!0,forceAlpha:!0})},ie.fowColor.oninput=async t=>{if(!t||!t.target)return;const n=t.target;clearTimeout(i),i=setTimeout(async()=>{if(/#[a-f0-9]{8}/.test(n.value)){await P.scene.setMetadata({[`${m.EXTENSIONID}/fowColor`]:n.value});const r=await P.scene.local.getItems(Ht);await P.scene.local.deleteItems(r.map(l=>l.id))}},500)},ie.convertButton.onclick=async t=>{if(!(!t||!t.target)&&window.confirm(`WARNING: THIS CANNOT BE UNDONE.

This operation will remove all metadata from the original dynamic fog extension, and will break fog lines and other things if you do not continue using Smoke!.

WARNING: THIS CANNOT BE UNDONE.

Are you REALLY sure?`)){const n=await P.scene.getMetadata();for(const r in n)r.substring(0,r.indexOf("/"))==m.ARMINDOID&&await P.scene.setMetadata({[`${r}`]:void 0});const o=await P.scene.items.getItems();await P.scene.items.updateItems(o,r=>{for(const l of r)l.metadata[`${m.ARMINDOID}/isVisionLine`]!==void 0&&(l.metadata[`${m.EXTENSIONID}/isVisionLine`]=l.metadata[`${m.ARMINDOID}/isVisionLine`],delete l.metadata[`${m.ARMINDOID}/isVisionLine`]),l.metadata[`${m.ARMINDOID}/disabled`]!==void 0&&(l.metadata[`${m.EXTENSIONID}/disabled`]=l.metadata[`${m.ARMINDOID}/disabled`],delete l.metadata[`${m.ARMINDOID}/disabled`])})}};var e;ie.importFile.onchange=t=>{if(ie.importButton.disabled=!0,!t||!t.target)return;const n=t.target;if(!n.files)return;const o=n.files[0];if(o.type!=="text/javascript"&&o.type,o){var r=new FileReader;r.onload=function(l){if(!l||!l.target){ie.importErrors.innerText="Invalid import event";return}const p=l.target;if(!p.result){ie.importErrors.innerText="Unable to read imported file";return}const y=p.result;e=JSON.parse(y),e&&(e.walls&&e.walls.length||e.line_of_sight&&e.line_of_sight.length)?ie.importButton.disabled=!1:ie.importErrors.innerText="Imported file has no walls"},r.readAsText(o)}else ie.importErrors.innerText="Failed to load file"},ie.importButton.onclick=async t=>{!t||!t.target||(t.target,ea(ie.importFormat.value,e,ie.dpiAutodetect.checked?0:Number.parseInt(ie.importDpi.value),ie.mapAlign.value,ie.importErrors))},ie.toolColor.onclick=async t=>{Je({el:`#${ie.toolColor.id}`,alpha:!1,forceAlpha:!1})},ie.toolColor.oninput=async t=>{if(!t||!t.target)return;const n=t.target;clearTimeout(i),i=setTimeout(async()=>{/#[a-f0-9]{6}/.test(n.value)&&await P.scene.setMetadata({[`${m.EXTENSIONID}/toolColor`]:n.value})},400)},ie.toolStyle.onchange=async t=>{const n=t.currentTarget;await P.scene.setMetadata({[`${m.EXTENSIONID}/toolStyle`]:n.value=="solid"?[]:[25,25]})},ie.toolWidth.onchange=t=>{const n=t.currentTarget;clearTimeout(i),i=setTimeout(async()=>{await P.scene.setMetadata({[`${m.EXTENSIONID}/toolWidth`]:n.value})},400)},ie.whatsNewButton.onclick=async function(){ie.whatsNewIcon?.classList.remove("new-shine"),await P.modal.open({id:m.EXTENSIONWHATSNEW,url:"/pages/whatsnew.html",height:500,width:350})},Je({themeMode:"dark",alpha:!0,forceAlpha:!0,el:"#fow_color"}),Je({themeMode:"dark",alpha:!1,forceAlpha:!1,el:"#tool_color"})}let tt=null,Nt="",xt="",en="",tn="";const sa="#000000",la=8,ca=[];async function Qi(){await P.scene.local.deleteItems([tn,Nt,xt,en]),Nt="",xt="",tn="",en="",await P.popover.close(m.LINETOOLID)}async function er(){if(!tt)return;const[i,e]=tt;e(),tt=null,await Qi()}async function tr(){if(!tt)return;const[i,e]=tt,t=i(n=>{n.visible=!1,n.metadata[`${m.EXTENSIONID}/isVisionLine`]=!0,n.points.pop()});t.points.length>=2&&await P.scene.items.addItems([t]),e(),tt=null,await Qi()}async function ua(i,e){if(!e.transformer)if(tt)if(e.target&&(e.target.id===Nt||e.target.id===xt))await tr();else if(e.target&&(e.target.id===tn||e.target.id===en))await er();else{const[t]=tt;t(n=>{n.points.push(e.pointerPosition)}),await P.scene.local.updateItems(n=>n.id==xt||n.id==Nt,n=>{for(const o of n)o.position=e.pointerPosition})}else{const t=zt().plainText("Finish [Enter]").position({x:e.pointerPosition.x,y:e.pointerPosition.y-50}).fillOpacity(.95).backgroundOpacity(.5).layer("POPOVER").build(),n=Vn().tension(0).points([e.pointerPosition,e.pointerPosition]).strokeColor(A.metadata[`${m.EXTENSIONID}/toolColor`]??sa).strokeDash(A.metadata[`${m.EXTENSIONID}/toolStyle`]??ca).strokeWidth(A.metadata[`${m.EXTENSIONID}/toolWidth`]??la).fillOpacity(0).fillColor("#000000").layer("DRAWING").name("Vision Line (Line)").closed(!1).build();tt=await P.interaction.startItemInteraction(n);const o=wt().shapeType("CIRCLE").strokeColor("#FFFFFF").width(8).height(8).strokeWidth(2).position(e.pointerPosition).layer("POPOVER").build(),r=wt().shapeType("CIRCLE").strokeColor("#FFFFFF").width(8).height(8).strokeWidth(2).position(e.pointerPosition).layer("POPOVER").visible(!1).build(),l=zt().plainText("Cancel [Escape]").position(e.pointerPosition).fillOpacity(.95).backgroundOpacity(.5).layer("POPOVER").pointerDirection("UP").build();await P.scene.local.addItems([t,o,r,l]),Nt=t.id,xt=o.id,tn=l.id,en=r.id,await P.popover.open({id:m.LINETOOLID,url:"/pages/line.html",height:40,width:400,disableClickAway:!0})}}function da(i,e){if(!tt||e.transformer)return;const[t]=tt,n=Math.round(A.gridDpi/A.gridSnap),o=Math.round(e.pointerPosition.x/A.gridDpi)*A.gridDpi,r=Math.round(e.pointerPosition.y/A.gridDpi)*A.gridDpi,l=Math.abs(o-e.pointerPosition.x),p=Math.abs(r-e.pointerPosition.y);let y,I;l<=n?y=o:y=e.pointerPosition.x,p<=n?I=r:I=e.pointerPosition.y,t(b=>{b.points[b.points.length-1]=A.snap?{x:y,y:I}:e.pointerPosition})}function fa(i,e){tt&&(e.key=="Escape"?er():e.key=="Enter"&&tr())}const Pn={onToolClick:ua,onToolMove:da,onKeyDown:fa};let nt=null,nn="",rn="",on="",an="";const pa="#000000",ha=8,ma=[];async function nr(){await P.scene.local.deleteItems([an,nn,rn,on]),nn="",rn="",an="",on="",await P.popover.close(m.POLYTOOLID)}async function ir(){if(!nt)return;const[i,e]=nt;e(),nt=null,nr()}async function rr(){if(!nt)return;const[i,e]=nt,t=i(n=>{n.visible=!1,n.metadata[`${m.EXTENSIONID}/isVisionLine`]=!0,n.points.pop(),n.points.push(n.points[0])});t.points.length>=4&&await P.scene.items.addItems([t]),e(),nt=null,nr()}async function ga(i,e){if(!e.transformer)if(nt)if(e.target&&(e.target.id===nn||e.target.id===rn))rr();else if(e.target&&(e.target.id===an||e.target.id===on))ir();else{const[t]=nt;t(n=>{n.points.push(e.pointerPosition)})}else{const t=zt().plainText("Finish [Enter]").position({x:e.pointerPosition.x,y:e.pointerPosition.y-50}).fillOpacity(.95).backgroundOpacity(.5).layer("POPOVER").build(),n=Vn().tension(0).points([e.pointerPosition,e.pointerPosition]).strokeColor(A.metadata[`${m.EXTENSIONID}/toolColor`]??pa).strokeDash(A.metadata[`${m.EXTENSIONID}/toolStyle`]??ma).strokeWidth(A.metadata[`${m.EXTENSIONID}/toolWidth`]??ha).fillOpacity(.5).fillColor("#000000").layer("DRAWING").name("Vision Line (Polygon)").build();nt=await P.interaction.startItemInteraction(n);const o=wt().shapeType("CIRCLE").strokeColor("#FFFFFF").width(8).height(8).strokeWidth(2).position(e.pointerPosition).layer("POPOVER").build(),r=wt().shapeType("CIRCLE").strokeColor("#FFFFFF").width(8).height(8).strokeWidth(2).position(e.pointerPosition).layer("POPOVER").visible(!1).build(),l=zt().plainText("Cancel [Escape]").position(e.pointerPosition).fillOpacity(.95).backgroundOpacity(.5).layer("POPOVER").pointerDirection("UP").build();await P.scene.local.addItems([t,o,r,l]),nn=t.id,rn=o.id,an=l.id,on=r.id,await P.popover.open({id:m.POLYTOOLID,url:"/pages/polygon.html",height:40,width:400,disableClickAway:!0})}}function ya(i,e){if(!nt||e.transformer)return;const[t]=nt,n=Math.round(A.gridDpi/A.gridSnap),o=Math.round(e.pointerPosition.x/A.gridDpi)*A.gridDpi,r=Math.round(e.pointerPosition.y/A.gridDpi)*A.gridDpi,l=Math.abs(o-e.pointerPosition.x),p=Math.abs(r-e.pointerPosition.y);let y,I;l<=n?y=o:y=e.pointerPosition.x,p<=n?I=r:I=e.pointerPosition.y,t(b=>{b.points[b.points.length-1]=A.snap?{x:y,y:I}:e.pointerPosition})}function va(i,e){nt&&(e.key=="Escape"?ir():e.key=="Enter"&&rr())}const $n={onToolClick:ga,onToolMove:ya,onKeyDown:va};async function Ia(){await P.tool.create({id:`${m.EXTENSIONID}/vision-tool`,icons:[{icon:"/icon.svg",label:"Setup Vision"}],async onClick(){await P.tool.activateTool(`${m.EXTENSIONID}/vision-tool`)}}),await P.tool.createMode({id:`${m.EXTENSIONID}/add-vision-polygon-mode`,icons:[{icon:"/object.svg",label:"Add Obstruction Object",filter:{activeTools:[`${m.EXTENSIONID}/vision-tool`]}}],onToolClick:$n.onToolClick,onToolMove:$n.onToolMove,onKeyDown:$n.onKeyDown}),await P.tool.createMode({id:`${m.EXTENSIONID}/add-vision-line-mode`,icons:[{icon:"/line.svg",label:"Add Obstruction Line",filter:{activeTools:[`${m.EXTENSIONID}/vision-tool`]}}],onToolClick:Pn.onToolClick,onToolMove:Pn.onToolMove,onKeyDown:Pn.onKeyDown})}class Ea{mainWindow=document.getElementById("app");mainUIDiv;playerListContainer;settingsUIDiv;visionCheckbox;snapCheckbox;table;message;mapHeight;mapWidth;mapSubmit;whatsNewButton;whatsNewIcon;processedIndicator;persistenceCheckbox;autodetectCheckbox;fowCheckbox;doorCheckbox;fowColor;qualityOption;resetButton;convertButton;settingsButton;boundryOptions;debugDiv;debugButton;backgroundButton;toolWidth;toolColor;toolStyle;importButton;importFile;mapAlign;importErrors;dpiAutodetect;importDpi;importFormat;version;constructor(e){this.version=`SMOKEANDSPECTRE-${e}`}SetupGMElements(){this.mainWindow.innerHTML=`
        <div>
            <div>
                <div id="localStorageWarning"></div>
                <div class="title">
                <button class="circle-button" id="processedIndicator"></button>
                    Smoke!
                    <input type="checkbox" id="vision_checkbox" class="large" title="Enable Dynamic Fog">
                    <div class="tooltip" id="settings_button" title="Settings"><svg class="svgclickable" fill="#fff" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><path d="M.63 11.08zm.21.41v-.1zm.23.38L1 11.68zM1 11.68l-.11-.19zm-.21-.29c-.06-.1-.11-.21-.16-.31.05.1.1.21.16.31zm.32.54v-.06z"/><path d="m11.26 12.63 1.83 1.09a7.34 7.34 0 0 0 1-.94 7.48 7.48 0 0 0 1.56-2.86l-1.74-1A5.29 5.29 0 0 0 14 8a5.29 5.29 0 0 0-.08-.9l1.74-1a7.45 7.45 0 0 0-1.33-2.58 7.54 7.54 0 0 0-1.24-1.22l-1.83 1.04a6 6 0 0 0-1.11-.53v-2A8.55 8.55 0 0 0 7.94.53a8.39 8.39 0 0 0-2.26.3v2a7.23 7.23 0 0 0-1.12.54L2.78 2.28A7.46 7.46 0 0 0 .2 6.06l1.72 1a5.29 5.29 0 0 0-.08.9 5.29 5.29 0 0 0 .08.9l-1.73 1a8 8 0 0 0 .43 1.15c.05.1.1.21.16.31v.1l.11.19.12.19v.06a7.69 7.69 0 0 0 1.64 1.78l1.81-1.08a7.23 7.23 0 0 0 1.12.54v2a8.39 8.39 0 0 0 2.26.31 8.56 8.56 0 0 0 2.22-.3v-2a6 6 0 0 0 1.2-.48zm-2.39 1.52a7.57 7.57 0 0 1-.95.06 7.73 7.73 0 0 1-1-.06v-1.69a4.92 4.92 0 0 1-2.53-1.27l-1.54.92a6.22 6.22 0 0 1-1.08-1.61l1.56-.93a4.27 4.27 0 0 1 0-3.17l-1.56-.92a6.11 6.11 0 0 1 1.12-1.62l1.56.93A5 5 0 0 1 7 3.53V1.82a7.73 7.73 0 0 1 1-.06 7.57 7.57 0 0 1 .95.06v1.72a4.9 4.9 0 0 1 2.4 1.26l1.59-.94a6.31 6.31 0 0 1 1.11 1.62l-1.6.94a4.35 4.35 0 0 1 .3 1.58 4.44 4.44 0 0 1-.29 1.55l1.56.93a6.43 6.43 0 0 1-1.11 1.61l-1.58-.93a5 5 0 0 1-2.49 1.28z"/><path d="M7.92 5.49A2.59 2.59 0 0 0 5.25 8a2.59 2.59 0 0 0 2.67 2.51A2.6 2.6 0 0 0 10.6 8a2.6 2.6 0 0 0-2.68-2.51zM8 9.2A1.35 1.35 0 0 1 6.55 8 1.35 1.35 0 0 1 8 6.7 1.35 1.35 0 0 1 9.39 8 1.35 1.35 0 0 1 8 9.2z"/></svg></div>
                    <div class="tooltip" id="whatsnewbutton" title="Whats New"><svg id="whatsNewIcon" class="svgclickable" fill="#fff" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 3a7 7 0 100 14 7 7 0 000-14zm-9 7a9 9 0 1118 0 9 9 0 01-18 0zm8-4a1 1 0 011-1h.01a1 1 0 110 2H10a1 1 0 01-1-1zm.01 8a1 1 0 102 0V9a1 1 0 10-2 0v5z"/></svg></div>
                </div>
                <hr>
                ${m.SETTINGSPAGE}
                ${m.MAINPAGE}
                ${m.DEBUGPAGE}
            </div>
        </div>
        `,this.mainWindow.parentElement.style.placeItems="start",this.mainUIDiv=document.getElementById("main-ui"),this.settingsUIDiv=document.getElementById("settings-ui"),this.visionCheckbox=document.getElementById("vision_checkbox"),this.snapCheckbox=document.getElementById("snap_checkbox"),this.table=document.getElementById("token_list"),this.message=document.getElementById("no_tokens_message"),this.mapHeight=document.getElementById("mapHeight"),this.mapWidth=document.getElementById("mapWidth"),this.mapSubmit=document.getElementById("mapSubmit"),this.whatsNewButton=document.getElementById("whatsnewbutton"),this.whatsNewIcon=document.getElementById("whatsNewIcon"),this.processedIndicator=document.getElementById("processedIndicator"),this.persistenceCheckbox=document.getElementById("persistence_checkbox"),this.autodetectCheckbox=document.getElementById("autodetect_checkbox"),this.fowCheckbox=document.getElementById("fow_checkbox"),this.doorCheckbox=document.getElementById("door_checkbox"),this.fowColor=document.getElementById("fow_color"),this.qualityOption=document.getElementById("quality"),this.resetButton=document.getElementById("persistence_reset"),this.convertButton=document.getElementById("convert_button"),this.settingsButton=document.getElementById("settings_button"),this.boundryOptions=document.getElementById("boundry_options"),this.debugDiv=document.getElementById("debug_div"),this.debugButton=document.getElementById("debug_button"),this.backgroundButton=document.getElementById("background_button"),this.toolWidth=document.getElementById("tool_width"),this.toolColor=document.getElementById("tool_color"),this.toolStyle=document.getElementById("tool_style"),this.importButton=document.getElementById("import_button"),this.importFile=document.getElementById("import_file"),this.mapAlign=document.getElementById("map_align"),this.importErrors=document.getElementById("import_errors"),this.dpiAutodetect=document.getElementById("dpi_autodetect"),this.importDpi=document.getElementById("import_dpi"),this.importFormat=document.getElementById("import_format");const e=document.getElementById("playerListing");e.appendChild(this.GetEmptyContextItem());for(const t of A.players){const n=document.createElement("li");n.id=t.id,n.textContent=t.name,n.style.color=t.color,e.appendChild(n)}Je.init()}async SetupPlayerElements(){this.mainWindow.innerHTML=`<div class="title">Configuration via GM.
            <div class="tooltip" id="helpButton" title="Need Help?"></div>
            </div>
            <hr><sub>You must have ownership of a token to see it.</sub></br></br>Tokens Owned By You:<div id="playerOwnedTokens"></div><div id="localStorageWarning"></div>`,await P.action.setHeight(300),await P.action.setWidth(350),this.playerListContainer=document.getElementById("playerOwnedTokens");const e=document.getElementById("helpButton"),t=document.createElement("input");t.classList.add("clickable"),t.src="/help.svg",t.height=15,t.width=15,t.type="image",t.title="Need Help?",t.onclick=async function(){await P.modal.open({id:m.EXTENSIONWHATSNEW,url:"/pages/whatsnew.html?gethelp=true",height:500,width:350})},e.appendChild(t)}GetEmptyContextItem(){const e=document.createElement("li");return e.id=A.userId,e.textContent="Self",e}async BuildUserCache(){const[e,t,n]=await Promise.all([P.player.getId(),P.party.getPlayers(),P.scene.isReady()]);A.userId=e,A.players=t,A.ready=n}async UpdateUI(){const e=A.items.filter(y=>xi(y));let t=!1;ia(A.metadata)||(this.visionCheckbox.checked=A.metadata[`${m.EXTENSIONID}/visionEnabled`]==!0,this.autodetectCheckbox.checked=A.metadata[`${m.EXTENSIONID}/autodetectEnabled`]==!0,this.persistenceCheckbox.checked=A.metadata[`${m.EXTENSIONID}/persistenceEnabled`]==!0,this.autodetectCheckbox.checked=A.metadata[`${m.EXTENSIONID}/autodetectEnabled`]==!0,this.fowCheckbox.checked=A.metadata[`${m.EXTENSIONID}/fowEnabled`]==!0,this.doorCheckbox.checked=A.metadata[`${m.EXTENSIONID}/playerDoors`]==!0,this.fowColor.value=A.metadata[`${m.EXTENSIONID}/fowColor`]?A.metadata[`${m.EXTENSIONID}/fowColor`]:"#00000088",this.qualityOption.value=A.metadata[`${m.EXTENSIONID}/quality`]??"accurate",t=A.metadata[`${m.EXTENSIONID}/debug`]==!0),this.debugDiv.style.display=t?"grid":"none",this.boundryOptions.style.display=this.autodetectCheckbox.checked?"none":"",this.message.style.display=e.length>0?"none":"block";const n=A.items.filter(y=>y.layer==="FOG"&&y.metadata[`${m.EXTENSIONID}/isBackgroundMap`]===!0),o=document.querySelectorAll(".fog-background-entry");for(const y of o){const I=y.id.slice(3);n.find(b=>b.id===I)===void 0&&y.remove()}for(const y of n)if(!document.querySelector(`#bg-${y.id}`)){const b=document.createElement("div");b.id=`bg-${y.id}`,b.className="fog-background-entry grid-3 grid-main",b.style.width="300",b.innerHTML=`<div class="token-name grid-2">${y.name}</div>
                    <div><label title="Unlock this fog background and turn it back into a map"><input type="button" value="Unlock"></label></div>`,document.querySelector("#fog_background_list").appendChild(b),b.querySelector("input").addEventListener("click",async k=>{if(!k||!k.target)return;const T=k.target.parentElement.parentElement.parentElement.id.slice(3);await P.scene.items.updateItems(B=>B.id===T&&B.layer=="FOG"&&B.metadata[`${m.EXTENSIONID}/isBackgroundMap`]===!0,B=>{for(let N=0;N<B.length;N++)B[N].layer="MAP",B[N].disableHit=!1,B[N].locked=!1,B[N].visible=!0,delete B[N].metadata[`${m.EXTENSIONID}/isBackgroundMap`]})})}const r=document.querySelector("#fog_backgrounds");n.length==0?r.style.display="none":r.style.display="block";const l=document.getElementsByClassName("token-table-entry"),p=[];for(const y of l){const I=y.id.slice(3);e.find(b=>b.id===I)===void 0&&p.push(y)}for(const y of p)y.remove();for(const y of e)ra(y)}UpdatePlayerProcessUI(e){e.every(n=>n.metadata[`${m.EXTENSIONID}/processed`]===!0)?(this.processedIndicator.style.backgroundColor="green",this.processedIndicator.title="Everything looks good."):(this.processedIndicator.style.backgroundColor="red",this.processedIndicator.title="A player is having trouble processing/seeing.")}UpdatePlayerVisionList(e){const t=[];for(const n of e)if(sn(n)&&n.createdUserId===A.userId){const o=n.metadata[`${m.EXTENSIONID}/hasVision`]!==void 0;t.push(`<li>${n.name}${o?"":": <b>Vision Disabled</b>"}</li>`)}t.length===0&&t.push("<li>None found.</li>"),this.playerListContainer.innerHTML=`<ul>${t.join("")}</ul>`}HighlightWhatsNew(){let e=localStorage.getItem(this.version);(e==="false"||!e)&&(this.whatsNewIcon?.classList.add("new-shine"),localStorage.setItem(this.version,"true"))}async Start(e){await this.BuildUserCache(),e==="GM"?(this.SetupGMElements(),aa(),this.UpdatePlayerProcessUI(A.players),await Promise.all([oa(),Ia(),Yo()]),Ni()):(this.SetupPlayerElements(),Ni()),A.ready?(await Zi(),await It(),e=="GM"&&await zi(this.mapAlign)):e=="GM"&&(Gn(!1),await this.UpdateUI()),Ji(e),this.HighlightWhatsNew()}}const ie=new Ea("2.12");P.onReady(async()=>{const[i,e]=await Promise.all([P.theme.getTheme(),P.player.getRole()]);A.role=e,Yi(i,document),await ie.Start(A.role)});
