import{C as h,O as $,b as St,a as xi,i as Nr,c as en,d as kt}from"./constants-418c54cd.js";/* empty css              */var vn=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function Bn(i){return i&&i.__esModule&&Object.prototype.hasOwnProperty.call(i,"default")?i.default:i}function _r(i){if(i.__esModule)return i;var e=i.default;if(typeof e=="function"){var t=function n(){return this instanceof n?Reflect.construct(e,arguments,this.constructor):e.apply(this,arguments)};t.prototype=e.prototype}else t={};return Object.defineProperty(t,"__esModule",{value:!0}),Object.keys(i).forEach(function(n){var o=Object.getOwnPropertyDescriptor(i,n);Object.defineProperty(t,n,o.get?o:{enumerable:!0,get:function(){return i[n]}})}),t}function Or(i){return i.type==="CURVE"}function tn(i){return i.type==="IMAGE"}function ii(i,e){return Math.round(i/e)*e}function ri(i,e){return Math.floor(i/e)*e}function Dn(i){return i*(Math.PI/180)}function kr(i){return i*(180/Math.PI)}function oi(i,e,t){return i*(1-t)+e*t}class je{static magnitudeSquared(e){return e.x*e.x+e.y*e.y}static magnitude(e){const t=Math.sqrt(this.magnitudeSquared(e));return isNaN(t)?0:t}static normalize(e){const t=this.magnitude(e);return t===0?{x:0,y:0}:this.divide(e,t)}static dot(e,t){return e.x*t.x+e.y*t.y}static subtract(e,t){return typeof t=="number"?{x:e.x-t,y:e.y-t}:{x:e.x-t.x,y:e.y-t.y}}static add(e,t){return typeof t=="number"?{x:e.x+t,y:e.y+t}:{x:e.x+t.x,y:e.y+t.y}}static multiply(e,t){return typeof t=="number"?{x:e.x*t,y:e.y*t}:{x:e.x*t.x,y:e.y*t.y}}static divide(e,t){return typeof t=="number"?{x:e.x/t,y:e.y/t}:{x:e.x/t.x,y:e.y/t.y}}static rotate(e,t,n){const o=Math.cos(Dn(n)),r=Math.sin(Dn(n)),l=this.subtract(e,t);return{x:t.x+o*l.x-r*l.y,y:t.y+r*l.x+o*l.y}}static min(e,t){return typeof t=="number"?{x:Math.min(e.x,t),y:Math.min(e.y,t)}:{x:Math.min(e.x,t.x),y:Math.min(e.y,t.y)}}static componentMin(e){return e.x<e.y?e.x:e.y}static max(e,t){return typeof t=="number"?{x:Math.max(e.x,t),y:Math.max(e.y,t)}:{x:Math.max(e.x,t.x),y:Math.max(e.y,t.y)}}static componentMax(e){return e.x>e.y?e.x:e.y}static roundTo(e,t){return{x:ii(e.x,t.x),y:ii(e.y,t.y)}}static floorTo(e,t){return{x:ri(e.x,t.x),y:ri(e.y,t.y)}}static sign(e){return{x:Math.sign(e.x),y:Math.sign(e.y)}}static abs(e){return{x:Math.abs(e.x),y:Math.abs(e.y)}}static pow(e,t){return typeof t=="number"?{x:Math.pow(e.x,t),y:Math.pow(e.y,t)}:{x:Math.pow(e.x,t.x),y:Math.pow(e.y,t.y)}}static clamp(e,t,n){return{x:Math.min(Math.max(e.x,t),n),y:Math.min(Math.max(e.y,t),n)}}static boundingBox(e){let t=Number.MAX_SAFE_INTEGER,n=Number.MIN_SAFE_INTEGER,o=Number.MAX_SAFE_INTEGER,r=Number.MIN_SAFE_INTEGER;for(let y of e)t=y.x<t?y.x:t,n=y.x>n?y.x:n,o=y.y<o?y.y:o,r=y.y>r?y.y:r;let l=n-t,u=r-o,m={x:(t+n)/2,y:(o+r)/2};return{min:{x:t,y:o},max:{x:n,y:r},width:l,height:u,center:m}}static pointInPolygon(e,t){const n=this.boundingBox(t);if(e.x<n.min.x||e.x>n.max.x||e.y<n.min.y||e.y>n.max.y)return!1;let o=!1;for(let r=0,l=t.length-1;r<t.length;l=r++){const u=t[r].y>e.y,m=t[l].y>e.y;u!==m&&e.x<(t[l].x-t[r].x)*(e.y-t[r].y)/(t[l].y-t[r].y)+t[r].x&&(o=!o)}return o}static compare(e,t,n){return this.magnitudeSquared(this.subtract(e,t))<n*n}static distance(e,t){return this.magnitude(this.subtract(e,t))}static lerp(e,t,n){return{x:oi(e.x,t.x,n),y:oi(e.y,t.y,n)}}static centroid(e){let t={x:0,y:0};for(let n of e)t.x+=n.x,t.y+=n.y;return e.length>0&&(t={x:t.x/e.length,y:t.y/e.length}),t}}class Ve{static inverse(e){const[t,n,o,r,l,u,m,y,N]=e,C=t*(l*N-y*u)-n*(r*N-u*m)+o*(r*y-l*m);if(Math.abs(C)<1e-14)return e;const k=1/C,X=(l*N-y*u)*k,b=(o*y-n*N)*k,P=(n*u-o*l)*k,O=(u*m-r*N)*k,M=(t*N-o*m)*k,A=(r*o-t*u)*k,B=(r*y-m*l)*k,U=(m*n-t*y)*k,Y=(t*l-r*n)*k;return[X,b,P,O,M,A,B,U,Y]}static multiply(e,t){return[e[0]*t[0]+e[1]*t[3]+e[2]*t[6],e[0]*t[1]+e[1]*t[4]+e[2]*t[7],e[0]*t[2]+e[1]*t[5]+e[2]*t[8],e[3]*t[0]+e[4]*t[3]+e[5]*t[6],e[3]*t[1]+e[4]*t[4]+e[5]*t[7],e[3]*t[2]+e[4]*t[5]+e[5]*t[8],e[6]*t[0]+e[7]*t[3]+e[8]*t[6],e[6]*t[1]+e[7]*t[4]+e[8]*t[7],e[6]*t[2]+e[7]*t[5]+e[8]*t[8]]}static fromPosition(e){return[1,0,e.x,0,1,e.y,0,0,1]}static fromRotation(e){const t=Dn(e);return[Math.cos(t),-Math.sin(t),0,Math.sin(t),Math.cos(t),0,0,0,1]}static fromScale(e){return[e.x,0,0,0,e.y,0,0,0,1]}static fromItem(e){const t=Ve.fromPosition(e.position),n=Ve.fromScale(e.scale),o=Ve.fromRotation(e.rotation);return Ve.multiply(Ve.multiply(t,o),n)}static decompose(e){const[t,n,o,r,l,u]=e,m=t*l-r*n,y={position:{x:o,y:u},rotation:0,scale:{x:1,y:1}};if(t!=0||r!=0){var N=Math.sqrt(t*t+r*r);y.rotation=r>0?Math.acos(t/N):-Math.acos(t/N),y.scale={x:N,y:m/N}}else if(n!=0||l!=0){var C=Math.sqrt(n*n+l*l);y.rotation=Math.PI/2-(l>0?Math.acos(-n/C):-Math.acos(n/C)),y.scale={x:m/C,y:C}}return y.rotation=kr(y.rotation),y}}class xr{userId;userName;userColor;role;items;ghosts;players;metadata;gridDpi;gridScale;gridSnap;fog;ready;snap;initialized;torchActive;lastReset;constructor(){this.userId="",this.userName="",this.userColor="",this.role="PLAYER",this.items=[],this.players=[],this.ghosts=[],this.metadata={},this.gridDpi=0,this.gridScale=0,this.gridSnap=10,this.fog={filled:!1,style:{color:"white",strokeWidth:0}},this.ready=!1,this.snap=!0,this.initialized=!1,this.torchActive=!1,this.lastReset=""}}const S=new xr;function Dr(i){return i.layer=="MAP"&&(i.metadata[`${h.EXTENSIONID}/isBackgroundImage`]||i.metadata[`${h.ARMINDOID}/isBackgroundImage`])}function Et(i){return i.metadata[`${h.EXTENSIONID}/isVisionFog`]||i.metadata[`${h.ARMINDOID}/isVisionFog`]}function Cr(i){return i.metadata[`${h.EXTENSIONID}/isIndicatorRing`]||i.metadata[`${h.ARMINDOID}/isIndicatorRing`]}function ai(i){return i.metadata[`${h.EXTENSIONID}/isVisionLine`]||i.metadata[`${h.ARMINDOID}/isVisionLine`]}function Ar(i){return i.metadata[`${h.EXTENSIONID}/isVisionLine`]&&!i.metadata[`${h.EXTENSIONID}/disabled`]||i.metadata[`${h.ARMINDOID}/isVisionLine`]&&!i.metadata[`${h.ARMINDOID}/disabled`]}function Di(i){return(i.layer=="CHARACTER"||i.layer=="ATTACHMENT")&&(i.metadata[`${h.EXTENSIONID}/hasVision`]||i.metadata[`${h.ARMINDOID}/hasVision`])}function $r(i){return(i.layer=="CHARACTER"||i.layer=="ATTACHMENT")&&(i.metadata[`${h.EXTENSIONID}/hasVision`]||i.metadata[`${h.ARMINDOID}/hasVision`])&&!i.metadata[`${h.EXTENSIONID}/visionBlind`]}function Pr(i){return(i.layer=="CHARACTER"||i.layer=="ATTACHMENT")&&i.createdUserId==S.userId&&(i.metadata[`${h.EXTENSIONID}/hasVision`]||i.metadata[`${h.ARMINDOID}/hasVision`])&&!i.metadata[`${h.EXTENSIONID}/visionBlind`]}function Ci(i){return i.layer=="DRAWING"&&(i.metadata[`${h.EXTENSIONID}/isBackgroundImage`]||i.metadata[`${h.ARMINDOID}/isBackgroundImage`])}function Ht(i){return i.metadata[`${h.EXTENSIONID}/isTrailingFog`]}function Cn(i){return i.metadata[`${h.EXTENSIONID}/isTrailingFog`]||i.metadata[`${h.EXTENSIONID}/isVisionFog`]||i.metadata[`${h.ARMINDOID}/isVisionFog`]||i.metadata[`${h.EXTENSIONID}/isIndicatorRing`]}function Lr(i){return i.metadata[`${h.EXTENSIONID}/isBrushSquare`]}function vt(i){return i.metadata[`${h.EXTENSIONID}/visionTorch`]}function Ai(i){return i.layer=="CHARACTER"&&!Di(i)&&i.metadata[`${h.EXTENSIONID}/hasAutohide`]===!0}var $i={exports:{}};const Mr={},Rr=Object.freeze(Object.defineProperty({__proto__:null,default:Mr},Symbol.toStringTag,{value:"Module"})),In=_r(Rr);(function(i,e){var t=(()=>{var n=typeof document<"u"&&document.currentScript?document.currentScript.src:void 0;return typeof __filename<"u"&&(n=n||__filename),function(o){o=o||{};var r;r||(r=typeof o<"u"?o:{});var l=Object.assign,u,m;r.ready=new Promise(function(s,a){u=s,m=a}),function(s){var a={};s.loadCmdsTypedArray=function(V){for(var z=0,Z=0;Z<V.length;Z++)z+=V[Z].length;if(a[z])var J=a[z];else J=new Float32Array(z),a[z]=J;var re=0;for(Z=0;Z<V.length;Z++)for(var Te=0;Te<V[Z].length;Te++){var $e=V[Z][Te];typeof $e=="string"&&($e=s.SkBits2FloatUnsigned(parseInt($e))),J[re]=$e,re++}return V=s._malloc(J.length*J.BYTES_PER_ELEMENT),s.HEAPF32.set(J,V/J.BYTES_PER_ELEMENT),[V,z]},s.FromCmds=function(V){V=s.loadCmdsTypedArray(V);var z=s._FromCmds(V[0],V[1]);return s._free(V[0]),z};var d,v,D,R,G;s.cubicYFromX=function(V,z,Z,J,re){return d&&v===V&&D===z&&R===Z&&G===J||(d&&d.delete(),d=new s._SkCubicMap([V,z],[Z,J]),v=V,D=z,R=Z,G=J),d.computeYFromX(re)},s.cubicPtFromT=function(V,z,Z,J,re){return d&&v===V&&D===z&&R===Z&&G===J||(d&&d.delete(),d=new s._SkCubicMap([V,z],[Z,J]),v=V,D=z,R=Z,G=J),d.computePtFromT(re)}}(r),function(s){s.onRuntimeInitialized=function(){s.SkPath.prototype.addPath=function(){var a=arguments[0];if(arguments.length===1)this._addPath(a,1,0,0,0,1,0,0,0,1);else if(arguments.length===2){var d=arguments[1];this._addPath(a,d.a,d.c,d.e,d.b,d.d,d.f,0,0,1)}else if(arguments.length===7)d=arguments,this._addPath(a,d[1],d[3],d[5],d[2],d[4],d[6],0,0,1);else if(arguments.length===10)d=arguments,this._addPath(a,d[1],d[2],d[3],d[4],d[5],d[6],d[7],d[8],d[9]);else return console.Ma("addPath expected to take 1, 2, 7, or 10 args. Got "+arguments.length),null;return this},s.SkPath.prototype.arc=function(a,d,v,D,R,G){return this._arc(a,d,v,D,R,!!G),this},s.SkPath.prototype.arcTo=function(a,d,v,D,R){return this._arcTo(a,d,v,D,R),this},s.SkPath.prototype.bezierCurveTo=function(a,d,v,D,R,G){return this._cubicTo(a,d,v,D,R,G),this},s.SkPath.prototype.close=function(){return this._close(),this},s.SkPath.prototype.closePath=function(){return this._close(),this},s.SkPath.prototype.conicTo=function(a,d,v,D,R){return this._conicTo(a,d,v,D,R),this},s.SkPath.prototype.cubicTo=function(a,d,v,D,R,G){return this._cubicTo(a,d,v,D,R,G),this},s.SkPath.prototype.dash=function(a,d,v){return this._dash(a,d,v)?this:null},s.SkPath.prototype.ellipse=function(a,d,v,D,R,G,V,z){return this._ellipse(a,d,v,D,R,G,V,!!z),this},s.SkPath.prototype.lineTo=function(a,d){return this._lineTo(a,d),this},s.SkPath.prototype.moveTo=function(a,d){return this._moveTo(a,d),this},s.SkPath.prototype.op=function(a,d){return this._op(a,d)?this:null},s.SkPath.prototype.quadraticCurveTo=function(a,d,v,D){return this._quadTo(a,d,v,D),this},s.SkPath.prototype.quadTo=function(a,d,v,D){return this._quadTo(a,d,v,D),this},s.SkPath.prototype.rect=function(a,d,v,D){return this._rect(a,d,v,D),this},s.SkPath.prototype.simplify=function(){return this._simplify()?this:null},s.SkPath.prototype.stroke=function(a){return a=a||{},a.width=a.width||1,a.miter_limit=a.miter_limit||4,a.cap=a.cap||s.StrokeCap.BUTT,a.join=a.join||s.StrokeJoin.MITER,this._stroke(a)?this:null},s.SkPath.prototype.transform=function(){if(arguments.length===1)this._transform(arguments[0]);else if(arguments.length===9){var a=arguments;this._transform(a[0],a[1],a[2],a[3],a[4],a[5],a[6],a[7],a[8])}else return console.Ma("transform expected to take 1 or 9 arguments. Got "+arguments.length),null;return this},s.SkPath.prototype.trim=function(a,d,v){return this._trim(a,d,!!v)?this:null}}}(r);var y=l({},r),N=typeof window=="object",C=typeof importScripts=="function",k="",X,b,P,O,M,A;typeof process=="object"&&typeof process.versions=="object"&&typeof process.versions.node=="string"?(k=C?In.dirname(k)+"/":__dirname+"/",A=()=>{M||(O=In,M=In)},X=function(s,a){return A(),s=M.normalize(s),O.readFileSync(s,a?null:"utf8")},P=s=>(s=X(s,!0),s.buffer||(s=new Uint8Array(s)),s),b=(s,a,d)=>{A(),s=M.normalize(s),O.readFile(s,function(v,D){v?d(v):a(D.buffer)})},1<process.argv.length&&process.argv[1].replace(/\\/g,"/"),process.argv.slice(2),process.on("uncaughtException",function(s){throw s}),process.on("unhandledRejection",function(s){throw s}),r.inspect=function(){return"[Emscripten Module object]"}):(N||C)&&(C?k=self.location.href:typeof document<"u"&&document.currentScript&&(k=document.currentScript.src),n&&(k=n),k.indexOf("blob:")!==0?k=k.substr(0,k.replace(/[?#].*/,"").lastIndexOf("/")+1):k="",X=s=>{var a=new XMLHttpRequest;return a.open("GET",s,!1),a.send(null),a.responseText},C&&(P=s=>{var a=new XMLHttpRequest;return a.open("GET",s,!1),a.responseType="arraybuffer",a.send(null),new Uint8Array(a.response)}),b=(s,a,d)=>{var v=new XMLHttpRequest;v.open("GET",s,!0),v.responseType="arraybuffer",v.onload=()=>{v.status==200||v.status==0&&v.response?a(v.response):d()},v.onerror=d,v.send(null)});var B=r.print||console.log.bind(console),U=r.printErr||console.warn.bind(console);l(r,y),y=null;var Y;r.wasmBinary&&(Y=r.wasmBinary),r.noExitRuntime,typeof WebAssembly!="object"&&te("no native wasm support detected");var x,I=!1,g=typeof TextDecoder<"u"?new TextDecoder("utf8"):void 0;function E(s,a,d){var v=a+d;for(d=a;s[d]&&!(d>=v);)++d;if(16<d-a&&s.subarray&&g)return g.decode(s.subarray(a,d));for(v="";a<d;){var D=s[a++];if(D&128){var R=s[a++]&63;if((D&224)==192)v+=String.fromCharCode((D&31)<<6|R);else{var G=s[a++]&63;D=(D&240)==224?(D&15)<<12|R<<6|G:(D&7)<<18|R<<12|G<<6|s[a++]&63,65536>D?v+=String.fromCharCode(D):(D-=65536,v+=String.fromCharCode(55296|D>>10,56320|D&1023))}}else v+=String.fromCharCode(D)}return v}function p(s,a,d){var v=le;if(0<d){d=a+d-1;for(var D=0;D<s.length;++D){var R=s.charCodeAt(D);if(55296<=R&&57343>=R){var G=s.charCodeAt(++D);R=65536+((R&1023)<<10)|G&1023}if(127>=R){if(a>=d)break;v[a++]=R}else{if(2047>=R){if(a+1>=d)break;v[a++]=192|R>>6}else{if(65535>=R){if(a+2>=d)break;v[a++]=224|R>>12}else{if(a+3>=d)break;v[a++]=240|R>>18,v[a++]=128|R>>12&63}v[a++]=128|R>>6&63}v[a++]=128|R&63}}v[a]=0}}var _=typeof TextDecoder<"u"?new TextDecoder("utf-16le"):void 0;function L(s,a){for(var d=s>>1,v=d+a/2;!(d>=v)&&Le[d];)++d;if(d<<=1,32<d-s&&_)return _.decode(le.subarray(s,d));for(d="",v=0;!(v>=a/2);++v){var D=ve[s+2*v>>1];if(D==0)break;d+=String.fromCharCode(D)}return d}function ie(s,a,d){if(d===void 0&&(d=2147483647),2>d)return 0;d-=2;var v=a;d=d<2*s.length?d/2:s.length;for(var D=0;D<d;++D)ve[a>>1]=s.charCodeAt(D),a+=2;return ve[a>>1]=0,a-v}function ae(s){return 2*s.length}function oe(s,a){for(var d=0,v="";!(d>=a/4);){var D=ge[s+4*d>>2];if(D==0)break;++d,65536<=D?(D-=65536,v+=String.fromCharCode(55296|D>>10,56320|D&1023)):v+=String.fromCharCode(D)}return v}function Q(s,a,d){if(d===void 0&&(d=2147483647),4>d)return 0;var v=a;d=v+d-4;for(var D=0;D<s.length;++D){var R=s.charCodeAt(D);if(55296<=R&&57343>=R){var G=s.charCodeAt(++D);R=65536+((R&1023)<<10)|G&1023}if(ge[a>>2]=R,a+=4,a+4>d)break}return ge[a>>2]=0,a-v}function he(s){for(var a=0,d=0;d<s.length;++d){var v=s.charCodeAt(d);55296<=v&&57343>=v&&++d,a+=4}return a}var be,me,le,ve,Le,ge,_e,He,Xe;function Re(){var s=x.buffer;be=s,r.HEAP8=me=new Int8Array(s),r.HEAP16=ve=new Int16Array(s),r.HEAP32=ge=new Int32Array(s),r.HEAPU8=le=new Uint8Array(s),r.HEAPU16=Le=new Uint16Array(s),r.HEAPU32=_e=new Uint32Array(s),r.HEAPF32=He=new Float32Array(s),r.HEAPF64=Xe=new Float64Array(s)}var K,c=[],f=[],w=[];function H(){var s=r.preRun.shift();c.unshift(s)}var F=0,q=null;r.preloadedImages={},r.preloadedAudios={};function te(s){throw r.onAbort&&r.onAbort(s),s="Aborted("+s+")",U(s),I=!0,s=new WebAssembly.RuntimeError(s+". Build with -s ASSERTIONS=1 for more info."),m(s),s}function ce(){return se.startsWith("data:application/octet-stream;base64,")}var se;if(se="pathkit.wasm",!ce()){var De=se;se=r.locateFile?r.locateFile(De,k):k+De}function Me(){var s=se;try{if(s==se&&Y)return new Uint8Array(Y);if(P)return P(s);throw"both async and sync fetching of the wasm failed"}catch(a){te(a)}}function Ce(){if(!Y&&(N||C)){if(typeof fetch=="function"&&!se.startsWith("file://"))return fetch(se,{credentials:"same-origin"}).then(function(s){if(!s.ok)throw"failed to load wasm binary file at '"+se+"'";return s.arrayBuffer()}).catch(function(){return Me()});if(b)return new Promise(function(s,a){b(se,function(d){s(new Uint8Array(d))},a)})}return Promise.resolve().then(function(){return Me()})}function xe(s){for(;0<s.length;){var a=s.shift();if(typeof a=="function")a(r);else{var d=a.Wa;typeof d=="number"?a.xa===void 0?K.get(d)():K.get(d)(a.xa):d(a.xa===void 0?null:a.xa)}}}var de={};function Ee(s){for(;s.length;){var a=s.pop();s.pop()(a)}}function Ze(s){return this.fromWireType(_e[s>>2])}var ct={},it={},T={};function j(s){if(s===void 0)return"_unknown";s=s.replace(/[^a-zA-Z0-9_]/g,"$");var a=s.charCodeAt(0);return 48<=a&&57>=a?"_"+s:s}function W(s,a){return s=j(s),function(){return a.apply(this,arguments)}}function ee(s){var a=Error,d=W(s,function(v){this.name=s,this.message=v,v=Error(v).stack,v!==void 0&&(this.stack=this.toString()+`
`+v.replace(/^Error(:[^\n]*)?\n/,""))});return d.prototype=Object.create(a.prototype),d.prototype.constructor=d,d.prototype.toString=function(){return this.message===void 0?this.name:this.name+": "+this.message},d}var ue=void 0;function pe(s){throw new ue(s)}function fe(s,a,d){function v(V){V=d(V),V.length!==s.length&&pe("Mismatched type converter count");for(var z=0;z<s.length;++z)ot(s[z],V[z])}s.forEach(function(V){T[V]=a});var D=Array(a.length),R=[],G=0;a.forEach(function(V,z){it.hasOwnProperty(V)?D[z]=it[V]:(R.push(V),ct.hasOwnProperty(V)||(ct[V]=[]),ct[V].push(function(){D[z]=it[V],++G,G===R.length&&v(D)}))}),R.length===0&&v(D)}var Ae={};function ye(s){switch(s){case 1:return 0;case 2:return 1;case 4:return 2;case 8:return 3;default:throw new TypeError("Unknown type size: "+s)}}var Be=void 0;function Se(s){for(var a="";le[s];)a+=Be[le[s++]];return a}var Fe=void 0;function Ie(s){throw new Fe(s)}function ot(s,a,d={}){if(!("argPackAdvance"in a))throw new TypeError("registerType registeredInstance requires argPackAdvance");var v=a.name;if(s||Ie('type "'+v+'" must have a positive integer typeid pointer'),it.hasOwnProperty(s)){if(d.Qa)return;Ie("Cannot register type '"+v+"' twice")}it[s]=a,delete T[s],ct.hasOwnProperty(s)&&(a=ct[s],delete ct[s],a.forEach(function(D){D()}))}function rn(s){Ie(s.ea.ha.fa.name+" instance already deleted")}var on=!1;function Un(){}function Vn(s){--s.count.value,s.count.value===0&&(s.ka?s.ma.la(s.ka):s.ha.fa.la(s.ga))}function Tt(s){return typeof FinalizationGroup>"u"?(Tt=a=>a,s):(on=new FinalizationGroup(function(a){for(var d=a.next();!d.done;d=a.next())d=d.value,d.ga?Vn(d):console.warn("object already deleted: "+d.ga)}),Tt=a=>(on.register(a,a.ea,a.ea),a),Un=a=>{on.unregister(a.ea)},Tt(s))}var Nt=void 0,_t=[];function an(){for(;_t.length;){var s=_t.pop();s.ea.pa=!1,s.delete()}}function ut(){}var jn={};function Hn(s,a,d){if(s[a].ia===void 0){var v=s[a];s[a]=function(){return s[a].ia.hasOwnProperty(arguments.length)||Ie("Function '"+d+"' called with an invalid number of arguments ("+arguments.length+") - expects one of ("+s[a].ia+")!"),s[a].ia[arguments.length].apply(this,arguments)},s[a].ia=[],s[a].ia[v.ua]=v}}function sn(s,a,d){r.hasOwnProperty(s)?((d===void 0||r[s].ia!==void 0&&r[s].ia[d]!==void 0)&&Ie("Cannot register public name '"+s+"' twice"),Hn(r,s,s),r.hasOwnProperty(d)&&Ie("Cannot register multiple overloads of a function with the same number of arguments ("+d+")!"),r[s].ia[d]=a):(r[s]=a,d!==void 0&&(r[s].Xa=d))}function ur(s,a,d,v,D,R,G,V){this.name=s,this.constructor=a,this.qa=d,this.la=v,this.na=D,this.Oa=R,this.ta=G,this.La=V,this.Ta=[]}function ln(s,a,d){for(;a!==d;)a.ta||Ie("Expected null or instance of "+d.name+", got an instance of "+a.name),s=a.ta(s),a=a.na;return s}function dr(s,a){return a===null?(this.Ba&&Ie("null is not a valid "+this.name),0):(a.ea||Ie('Cannot pass "'+pn(a)+'" as a '+this.name),a.ea.ga||Ie("Cannot pass deleted object as a pointer of type "+this.name),ln(a.ea.ga,a.ea.ha.fa,this.fa))}function fr(s,a){if(a===null){if(this.Ba&&Ie("null is not a valid "+this.name),this.wa){var d=this.sa();return s!==null&&s.push(this.la,d),d}return 0}if(a.ea||Ie('Cannot pass "'+pn(a)+'" as a '+this.name),a.ea.ga||Ie("Cannot pass deleted object as a pointer of type "+this.name),!this.va&&a.ea.ha.va&&Ie("Cannot convert argument of type "+(a.ea.ma?a.ea.ma.name:a.ea.ha.name)+" to parameter type "+this.name),d=ln(a.ea.ga,a.ea.ha.fa,this.fa),this.wa)switch(a.ea.ka===void 0&&Ie("Passing raw pointer to smart pointer is illegal"),this.Va){case 0:a.ea.ma===this?d=a.ea.ka:Ie("Cannot convert argument of type "+(a.ea.ma?a.ea.ma.name:a.ea.ha.name)+" to parameter type "+this.name);break;case 1:d=a.ea.ka;break;case 2:if(a.ea.ma===this)d=a.ea.ka;else{var v=a.clone();d=this.Ua(d,dt(function(){v.delete()})),s!==null&&s.push(this.la,d)}break;default:Ie("Unsupporting sharing policy")}return d}function pr(s,a){return a===null?(this.Ba&&Ie("null is not a valid "+this.name),0):(a.ea||Ie('Cannot pass "'+pn(a)+'" as a '+this.name),a.ea.ga||Ie("Cannot pass deleted object as a pointer of type "+this.name),a.ea.ha.va&&Ie("Cannot convert argument of type "+a.ea.ha.name+" to parameter type "+this.name),ln(a.ea.ga,a.ea.ha.fa,this.fa))}function Wn(s,a,d){return a===d?s:d.na===void 0?null:(s=Wn(s,a,d.na),s===null?null:d.La(s))}var Ot={};function hr(s,a){for(a===void 0&&Ie("ptr should not be undefined");s.na;)a=s.ta(a),s=s.na;return Ot[a]}function Ct(s,a){return a.ha&&a.ga||pe("makeClassHandle requires ptr and ptrType"),!!a.ma!=!!a.ka&&pe("Both smartPtrType and smartPtr must be specified"),a.count={value:1},Tt(Object.create(s,{ea:{value:a}}))}function at(s,a,d,v){this.name=s,this.fa=a,this.Ba=d,this.va=v,this.wa=!1,this.la=this.Ua=this.sa=this.Ia=this.Va=this.Sa=void 0,a.na!==void 0?this.toWireType=fr:(this.toWireType=v?dr:pr,this.ja=null)}function Gn(s,a,d){r.hasOwnProperty(s)||pe("Replacing nonexistant public symbol"),r[s].ia!==void 0&&d!==void 0?r[s].ia[d]=a:(r[s]=a,r[s].ua=d)}function mr(s,a){var d=[];return function(){d.length=arguments.length;for(var v=0;v<arguments.length;v++)d[v]=arguments[v];return s.includes("j")?(v=r["dynCall_"+s],v=d&&d.length?v.apply(null,[a].concat(d)):v.call(null,a)):v=K.get(a).apply(null,d),v}}function We(s,a){s=Se(s);var d=s.includes("j")?mr(s,a):K.get(a);return typeof d!="function"&&Ie("unknown function pointer with signature "+s+": "+a),d}var qn=void 0;function zn(s){s=ei(s);var a=Se(s);return st(s),a}function At(s,a){function d(R){D[R]||it[R]||(T[R]?T[R].forEach(d):(v.push(R),D[R]=!0))}var v=[],D={};throw a.forEach(d),new qn(s+": "+v.map(zn).join([", "]))}function cn(s,a){for(var d=[],v=0;v<s;v++)d.push(ge[(a>>2)+v]);return d}function un(s,a,d,v,D){var R=a.length;2>R&&Ie("argTypes array size mismatch! Must at least get return value and 'this' types!");var G=a[1]!==null&&d!==null,V=!1;for(d=1;d<a.length;++d)if(a[d]!==null&&a[d].ja===void 0){V=!0;break}var z=a[0].name!=="void",Z=R-2,J=Array(Z),re=[],Te=[];return function(){if(arguments.length!==Z&&Ie("function "+s+" called with "+arguments.length+" arguments, expected "+Z+" args!"),Te.length=0,re.length=G?2:1,re[0]=D,G){var $e=a[1].toWireType(Te,this);re[1]=$e}for(var Ne=0;Ne<Z;++Ne)J[Ne]=a[Ne+2].toWireType(Te,arguments[Ne]),re.push(J[Ne]);if(Ne=v.apply(null,re),V)Ee(Te);else for(var Ge=G?1:2;Ge<a.length;Ge++){var qe=Ge===1?$e:J[Ge-2];a[Ge].ja!==null&&a[Ge].ja(qe)}return $e=z?a[0].fromWireType(Ne):void 0,$e}}var dn=[],rt=[{},{value:void 0},{value:null},{value:!0},{value:!1}];function Kn(s){4<s&&--rt[s].Ca===0&&(rt[s]=void 0,dn.push(s))}function fn(s){return s||Ie("Cannot use deleted val. handle = "+s),rt[s].value}function dt(s){switch(s){case void 0:return 1;case null:return 2;case!0:return 3;case!1:return 4;default:var a=dn.length?dn.pop():rt.length;return rt[a]={Ca:1,value:s},a}}function gr(s,a,d){switch(a){case 0:return function(v){return this.fromWireType((d?me:le)[v])};case 1:return function(v){return this.fromWireType((d?ve:Le)[v>>1])};case 2:return function(v){return this.fromWireType((d?ge:_e)[v>>2])};default:throw new TypeError("Unknown integer type: "+s)}}function $t(s,a){var d=it[s];return d===void 0&&Ie(a+" has unknown type "+zn(s)),d}function pn(s){if(s===null)return"null";var a=typeof s;return a==="object"||a==="array"||a==="function"?s.toString():""+s}function yr(s,a){switch(a){case 2:return function(d){return this.fromWireType(He[d>>2])};case 3:return function(d){return this.fromWireType(Xe[d>>3])};default:throw new TypeError("Unknown float type: "+s)}}function vr(s,a,d){switch(a){case 0:return d?function(v){return me[v]}:function(v){return le[v]};case 1:return d?function(v){return ve[v>>1]}:function(v){return Le[v>>1]};case 2:return d?function(v){return ge[v>>2]}:function(v){return _e[v>>2]};default:throw new TypeError("Unknown integer type: "+s)}}var Ir={};function hn(s){var a=Ir[s];return a===void 0?Se(s):a}var mn=[];function Yn(){function s(a){a.$$$embind_global$$$=a;var d=typeof $$$embind_global$$$=="object"&&a.$$$embind_global$$$===a;return d||delete a.$$$embind_global$$$,d}if(typeof globalThis=="object")return globalThis;if(typeof $$$embind_global$$$=="object"||(typeof vn=="object"&&s(vn)?$$$embind_global$$$=vn:typeof self=="object"&&s(self)&&($$$embind_global$$$=self),typeof $$$embind_global$$$=="object"))return $$$embind_global$$$;throw Error("unable to get global object.")}function Er(s){var a=mn.length;return mn.push(s),a}function wr(s,a){for(var d=Array(s),v=0;v<s;++v)d[v]=$t(ge[(a>>2)+v],"parameter "+v);return d}var Zn=[];function br(s){var a=Array(s+1);return function(d,v,D){a[0]=d;for(var R=0;R<s;++R){var G=$t(ge[(v>>2)+R],"parameter "+R);a[R+1]=G.readValueFromPointer(D),D+=G.argPackAdvance}return d=new(d.bind.apply(d,a)),dt(d)}}var Jn={},Sr=[null,[],[]];ue=r.InternalError=ee("InternalError");for(var Qn=Array(256),Pt=0;256>Pt;++Pt)Qn[Pt]=String.fromCharCode(Pt);Be=Qn,Fe=r.BindingError=ee("BindingError"),ut.prototype.isAliasOf=function(s){if(!(this instanceof ut&&s instanceof ut))return!1;var a=this.ea.ha.fa,d=this.ea.ga,v=s.ea.ha.fa;for(s=s.ea.ga;a.na;)d=a.ta(d),a=a.na;for(;v.na;)s=v.ta(s),v=v.na;return a===v&&d===s},ut.prototype.clone=function(){if(this.ea.ga||rn(this),this.ea.ra)return this.ea.count.value+=1,this;var s=Tt,a=Object,d=a.create,v=Object.getPrototypeOf(this),D=this.ea;return s=s(d.call(a,v,{ea:{value:{count:D.count,pa:D.pa,ra:D.ra,ga:D.ga,ha:D.ha,ka:D.ka,ma:D.ma}}})),s.ea.count.value+=1,s.ea.pa=!1,s},ut.prototype.delete=function(){this.ea.ga||rn(this),this.ea.pa&&!this.ea.ra&&Ie("Object already scheduled for deletion"),Un(this),Vn(this.ea),this.ea.ra||(this.ea.ka=void 0,this.ea.ga=void 0)},ut.prototype.isDeleted=function(){return!this.ea.ga},ut.prototype.deleteLater=function(){return this.ea.ga||rn(this),this.ea.pa&&!this.ea.ra&&Ie("Object already scheduled for deletion"),_t.push(this),_t.length===1&&Nt&&Nt(an),this.ea.pa=!0,this},at.prototype.Pa=function(s){return this.Ia&&(s=this.Ia(s)),s},at.prototype.Ga=function(s){this.la&&this.la(s)},at.prototype.argPackAdvance=8,at.prototype.readValueFromPointer=Ze,at.prototype.deleteObject=function(s){s!==null&&s.delete()},at.prototype.fromWireType=function(s){function a(){return this.wa?Ct(this.fa.qa,{ha:this.Sa,ga:d,ma:this,ka:s}):Ct(this.fa.qa,{ha:this,ga:s})}var d=this.Pa(s);if(!d)return this.Ga(s),null;var v=hr(this.fa,d);if(v!==void 0)return v.ea.count.value===0?(v.ea.ga=d,v.ea.ka=s,v.clone()):(v=v.clone(),this.Ga(s),v);if(v=this.fa.Oa(d),v=jn[v],!v)return a.call(this);v=this.va?v.Ja:v.pointerType;var D=Wn(d,this.fa,v.fa);return D===null?a.call(this):this.wa?Ct(v.fa.qa,{ha:v,ga:D,ma:this,ka:s}):Ct(v.fa.qa,{ha:v,ga:D})},r.getInheritedInstanceCount=function(){return Object.keys(Ot).length},r.getLiveInheritedInstances=function(){var s=[],a;for(a in Ot)Ot.hasOwnProperty(a)&&s.push(Ot[a]);return s},r.flushPendingDeletes=an,r.setDelayFunction=function(s){Nt=s,_t.length&&Nt&&Nt(an)},qn=r.UnboundTypeError=ee("UnboundTypeError"),r.count_emval_handles=function(){for(var s=0,a=5;a<rt.length;++a)rt[a]!==void 0&&++s;return s},r.get_first_emval=function(){for(var s=5;s<rt.length;++s)if(rt[s]!==void 0)return rt[s];return null};var Tr={r:function(s){var a=de[s];delete de[s];var d=a.elements,v=d.length,D=d.map(function(V){return V.Aa}).concat(d.map(function(V){return V.Ea})),R=a.sa,G=a.la;fe([s],D,function(V){return d.forEach(function(z,Z){var J=V[Z],re=z.ya,Te=z.za,$e=V[Z+v],Ne=z.Da,Ge=z.Fa;z.read=qe=>J.fromWireType(re(Te,qe)),z.write=(qe,ht)=>{var Qe=[];Ne(Ge,qe,$e.toWireType(Qe,ht)),Ee(Qe)}}),[{name:a.name,fromWireType:function(z){for(var Z=Array(v),J=0;J<v;++J)Z[J]=d[J].read(z);return G(z),Z},toWireType:function(z,Z){if(v!==Z.length)throw new TypeError("Incorrect number of tuple elements for "+a.name+": expected="+v+", actual="+Z.length);for(var J=R(),re=0;re<v;++re)d[re].write(J,Z[re]);return z!==null&&z.push(G,J),J},argPackAdvance:8,readValueFromPointer:Ze,ja:G}]})},u:function(s){var a=Ae[s];delete Ae[s];var d=a.sa,v=a.la,D=a.Ha,R=D.map(function(G){return G.Aa}).concat(D.map(function(G){return G.Ea}));fe([s],R,function(G){var V={};return D.forEach(function(z,Z){var J=G[Z],re=z.ya,Te=z.za,$e=G[Z+D.length],Ne=z.Da,Ge=z.Fa;V[z.Na]={read:function(qe){return J.fromWireType(re(Te,qe))},write:function(qe,ht){var Qe=[];Ne(Ge,qe,$e.toWireType(Qe,ht)),Ee(Qe)}}}),[{name:a.name,fromWireType:function(z){var Z={},J;for(J in V)Z[J]=V[J].read(z);return v(z),Z},toWireType:function(z,Z){for(var J in V)if(!(J in Z))throw new TypeError('Missing field:  "'+J+'"');var re=d();for(J in V)V[J].write(re,Z[J]);return z!==null&&z.push(v,re),re},argPackAdvance:8,readValueFromPointer:Ze,ja:v}]})},z:function(){},F:function(s,a,d,v,D){var R=ye(d);a=Se(a),ot(s,{name:a,fromWireType:function(G){return!!G},toWireType:function(G,V){return V?v:D},argPackAdvance:8,readValueFromPointer:function(G){if(d===1)var V=me;else if(d===2)V=ve;else if(d===4)V=ge;else throw new TypeError("Unknown boolean type size: "+a);return this.fromWireType(V[G>>R])},ja:null})},l:function(s,a,d,v,D,R,G,V,z,Z,J,re,Te){J=Se(J),R=We(D,R),V&&(V=We(G,V)),Z&&(Z=We(z,Z)),Te=We(re,Te);var $e=j(J);sn($e,function(){At("Cannot construct "+J+" due to unbound types",[v])}),fe([s,a,d],v?[v]:[],function(Ne){if(Ne=Ne[0],v)var Ge=Ne.fa,qe=Ge.qa;else qe=ut.prototype;Ne=W($e,function(){if(Object.getPrototypeOf(this)!==ht)throw new Fe("Use 'new' to construct "+J);if(Qe.oa===void 0)throw new Fe(J+" has no accessible constructor");var ni=Qe.oa[arguments.length];if(ni===void 0)throw new Fe("Tried to invoke ctor of "+J+" with invalid number of parameters ("+arguments.length+") - expected ("+Object.keys(Qe.oa).toString()+") parameters instead!");return ni.apply(this,arguments)});var ht=Object.create(qe,{constructor:{value:Ne}});Ne.prototype=ht;var Qe=new ur(J,Ne,ht,Te,Ge,R,V,Z);Ge=new at(J,Qe,!0,!1),qe=new at(J+"*",Qe,!1,!1);var ti=new at(J+" const*",Qe,!1,!0);return jn[s]={pointerType:qe,Ja:ti},Gn($e,Ne),[Ge,qe,ti]})},i:function(s,a,d,v,D,R){0<a||te(void 0);var G=cn(a,d);D=We(v,D),fe([],[s],function(V){V=V[0];var z="constructor "+V.name;if(V.fa.oa===void 0&&(V.fa.oa=[]),V.fa.oa[a-1]!==void 0)throw new Fe("Cannot register multiple constructors with identical number of parameters ("+(a-1)+") for class '"+V.name+"'! Overload resolution is currently only performed using the parameter count, not actual type info!");return V.fa.oa[a-1]=()=>{At("Cannot construct "+V.name+" due to unbound types",G)},fe([],G,function(Z){return Z.splice(1,0,null),V.fa.oa[a-1]=un(z,Z,null,D,R),[]}),[]})},a:function(s,a,d,v,D,R,G,V){var z=cn(d,v);a=Se(a),R=We(D,R),fe([],[s],function(Z){function J(){At("Cannot call "+re+" due to unbound types",z)}Z=Z[0];var re=Z.name+"."+a;a.startsWith("@@")&&(a=Symbol[a.substring(2)]),V&&Z.fa.Ta.push(a);var Te=Z.fa.qa,$e=Te[a];return $e===void 0||$e.ia===void 0&&$e.className!==Z.name&&$e.ua===d-2?(J.ua=d-2,J.className=Z.name,Te[a]=J):(Hn(Te,a,re),Te[a].ia[d-2]=J),fe([],z,function(Ne){return Ne=un(re,Ne,Z,R,G),Te[a].ia===void 0?(Ne.ua=d-2,Te[a]=Ne):Te[a].ia[d-2]=Ne,[]}),[]})},I:function(s,a,d){s=Se(s),fe([],[a],function(v){return v=v[0],r[s]=v.fromWireType(d),[]})},E:function(s,a){a=Se(a),ot(s,{name:a,fromWireType:function(d){var v=fn(d);return Kn(d),v},toWireType:function(d,v){return dt(v)},argPackAdvance:8,readValueFromPointer:Ze,ja:null})},h:function(s,a,d,v){function D(){}d=ye(d),a=Se(a),D.values={},ot(s,{name:a,constructor:D,fromWireType:function(R){return this.constructor.values[R]},toWireType:function(R,G){return G.value},argPackAdvance:8,readValueFromPointer:gr(a,d,v),ja:null}),sn(a,D)},k:function(s,a,d){var v=$t(s,"enum");a=Se(a),s=v.constructor,v=Object.create(v.constructor.prototype,{value:{value:d},constructor:{value:W(v.name+"_"+a,function(){})}}),s.values[d]=v,s[a]=v},q:function(s,a,d){d=ye(d),a=Se(a),ot(s,{name:a,fromWireType:function(v){return v},toWireType:function(v,D){return D},argPackAdvance:8,readValueFromPointer:yr(a,d),ja:null})},f:function(s,a,d,v,D,R){var G=cn(a,d);s=Se(s),D=We(v,D),sn(s,function(){At("Cannot call "+s+" due to unbound types",G)},a-1),fe([],G,function(V){return V=[V[0],null].concat(V.slice(1)),Gn(s,un(s,V,null,D,R),a-1),[]})},e:function(s,a,d,v,D){a=Se(a),D===-1&&(D=4294967295),D=ye(d);var R=V=>V;if(v===0){var G=32-8*d;R=V=>V<<G>>>G}d=a.includes("unsigned")?function(V,z){return z>>>0}:function(V,z){return z},ot(s,{name:a,fromWireType:R,toWireType:d,argPackAdvance:8,readValueFromPointer:vr(a,D,v!==0),ja:null})},b:function(s,a,d){function v(R){R>>=2;var G=_e;return new D(be,G[R+1],G[R])}var D=[Int8Array,Uint8Array,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array][a];d=Se(d),ot(s,{name:d,fromWireType:v,argPackAdvance:8,readValueFromPointer:v},{Qa:!0})},p:function(s,a){a=Se(a);var d=a==="std::string";ot(s,{name:a,fromWireType:function(v){var D=_e[v>>2];if(d)for(var R=v+4,G=0;G<=D;++G){var V=v+4+G;if(G==D||le[V]==0){if(R=R?E(le,R,V-R):"",z===void 0)var z=R;else z+=String.fromCharCode(0),z+=R;R=V+1}}else{for(z=Array(D),G=0;G<D;++G)z[G]=String.fromCharCode(le[v+4+G]);z=z.join("")}return st(v),z},toWireType:function(v,D){D instanceof ArrayBuffer&&(D=new Uint8Array(D));var R=typeof D=="string";R||D instanceof Uint8Array||D instanceof Uint8ClampedArray||D instanceof Int8Array||Ie("Cannot pass non-string to std::string");var G=(d&&R?()=>{for(var Z=0,J=0;J<D.length;++J){var re=D.charCodeAt(J);55296<=re&&57343>=re&&(re=65536+((re&1023)<<10)|D.charCodeAt(++J)&1023),127>=re?++Z:Z=2047>=re?Z+2:65535>=re?Z+3:Z+4}return Z}:()=>D.length)(),V=gn(4+G+1);if(_e[V>>2]=G,d&&R)p(D,V+4,G+1);else if(R)for(R=0;R<G;++R){var z=D.charCodeAt(R);255<z&&(st(V),Ie("String has UTF-16 code units that do not fit in 8 bits")),le[V+4+R]=z}else for(R=0;R<G;++R)le[V+4+R]=D[R];return v!==null&&v.push(st,V),V},argPackAdvance:8,readValueFromPointer:Ze,ja:function(v){st(v)}})},m:function(s,a,d){if(d=Se(d),a===2)var v=L,D=ie,R=ae,G=()=>Le,V=1;else a===4&&(v=oe,D=Q,R=he,G=()=>_e,V=2);ot(s,{name:d,fromWireType:function(z){for(var Z=_e[z>>2],J=G(),re,Te=z+4,$e=0;$e<=Z;++$e){var Ne=z+4+$e*a;($e==Z||J[Ne>>V]==0)&&(Te=v(Te,Ne-Te),re===void 0?re=Te:(re+=String.fromCharCode(0),re+=Te),Te=Ne+a)}return st(z),re},toWireType:function(z,Z){typeof Z!="string"&&Ie("Cannot pass non-string to C++ string type "+d);var J=R(Z),re=gn(4+J+a);return _e[re>>2]=J>>V,D(Z,re+4,J+a),z!==null&&z.push(st,re),re},argPackAdvance:8,readValueFromPointer:Ze,ja:function(z){st(z)}})},t:function(s,a,d,v,D,R){de[s]={name:Se(a),sa:We(d,v),la:We(D,R),elements:[]}},s:function(s,a,d,v,D,R,G,V,z){de[s].elements.push({Aa:a,ya:We(d,v),za:D,Ea:R,Da:We(G,V),Fa:z})},v:function(s,a,d,v,D,R){Ae[s]={name:Se(a),sa:We(d,v),la:We(D,R),Ha:[]}},j:function(s,a,d,v,D,R,G,V,z,Z){Ae[s].Ha.push({Na:Se(a),Aa:d,ya:We(v,D),za:R,Ea:G,Da:We(V,z),Fa:Z})},G:function(s,a){a=Se(a),ot(s,{Ra:!0,name:a,argPackAdvance:0,fromWireType:function(){},toWireType:function(){}})},d:function(s,a,d,v){s=mn[s],a=fn(a),d=hn(d),s(a,d,null,v)},J:Kn,x:function(s){return s===0?dt(Yn()):(s=hn(s),dt(Yn()[s]))},c:function(s,a){var d=wr(s,a),v=d[0];a=v.name+"_$"+d.slice(1).map(function(G){return G.name}).join("_")+"$";var D=Zn[a];if(D!==void 0)return D;var R=Array(s-1);return D=Er((G,V,z,Z)=>{for(var J=0,re=0;re<s-1;++re)R[re]=d[re+1].readValueFromPointer(Z+J),J+=d[re+1].argPackAdvance;for(G=G[V].apply(G,R),re=0;re<s-1;++re)d[re+1].Ka&&d[re+1].Ka(R[re]);if(!v.Ra)return v.toWireType(z,G)}),Zn[a]=D},n:function(s){4<s&&(rt[s].Ca+=1)},w:function(s,a,d,v){s=fn(s);var D=Jn[a];return D||(D=br(a),Jn[a]=D),D(s,d,v)},K:function(){return dt([])},D:function(s){return dt(hn(s))},H:function(s,a){return s=$t(s,"_emval_take_value"),s=s.readValueFromPointer(a),dt(s)},g:function(){te("")},B:function(s){var a=le.length;if(s>>>=0,2147483648<s)return!1;for(var d=1;4>=d;d*=2){var v=a*(1+.2/d);v=Math.min(v,s+100663296),v=Math.max(s,v),0<v%65536&&(v+=65536-v%65536);e:{try{x.grow(Math.min(2147483648,v)-be.byteLength+65535>>>16),Re();var D=1;break e}catch{}D=void 0}if(D)return!0}return!1},C:function(){return 0},y:function(){},o:function(s,a,d,v){for(var D=0,R=0;R<d;R++){var G=ge[a>>2],V=ge[a+4>>2];a+=8;for(var z=0;z<V;z++){var Z=le[G+z],J=Sr[s];Z===0||Z===10?((s===1?B:U)(E(J,0)),J.length=0):J.push(Z)}D+=V}return ge[v>>2]=D,0},A:function(){}};(function(){function s(D){r.asm=D.exports,x=r.asm.L,Re(),K=r.asm._,f.unshift(r.asm.M),F--,r.monitorRunDependencies&&r.monitorRunDependencies(F),F==0&&q&&(D=q,q=null,D())}function a(D){s(D.instance)}function d(D){return Ce().then(function(R){return WebAssembly.instantiate(R,v)}).then(function(R){return R}).then(D,function(R){U("failed to asynchronously prepare wasm: "+R),te(R)})}var v={a:Tr};if(F++,r.monitorRunDependencies&&r.monitorRunDependencies(F),r.instantiateWasm)try{return r.instantiateWasm(v,s)}catch(D){return U("Module.instantiateWasm callback failed with error: "+D),!1}return function(){return Y||typeof WebAssembly.instantiateStreaming!="function"||ce()||se.startsWith("file://")||typeof fetch!="function"?d(a):fetch(se,{credentials:"same-origin"}).then(function(D){return WebAssembly.instantiateStreaming(D,v).then(a,function(R){return U("wasm streaming compile failed: "+R),U("falling back to ArrayBuffer instantiation"),d(a)})})}().catch(m),{}})(),r.___wasm_call_ctors=function(){return(r.___wasm_call_ctors=r.asm.M).apply(null,arguments)},r.__Z6ToCmdsRK6SkPath=function(){return(r.__Z6ToCmdsRK6SkPath=r.asm.N).apply(null,arguments)},r.__Z8FromCmdsmi=function(){return(r.__Z8FromCmdsmi=r.asm.O).apply(null,arguments)},r.__Z7NewPathv=function(){return(r.__Z7NewPathv=r.asm.P).apply(null,arguments)},r.__Z8CopyPathRK6SkPath=function(){return(r.__Z8CopyPathRK6SkPath=r.asm.Q).apply(null,arguments)},r.__Z6EqualsRK6SkPathS1_=function(){return(r.__Z6EqualsRK6SkPathS1_=r.asm.R).apply(null,arguments)},r.__Z11ToSVGStringRK6SkPath=function(){return(r.__Z11ToSVGStringRK6SkPath=r.asm.S).apply(null,arguments)},r.__Z13FromSVGStringNSt3__212basic_stringIcNS_11char_traitsIcEENS_9allocatorIcEEEE=function(){return(r.__Z13FromSVGStringNSt3__212basic_stringIcNS_11char_traitsIcEENS_9allocatorIcEEEE=r.asm.T).apply(null,arguments)},r.__Z13ApplySimplifyR6SkPath=function(){return(r.__Z13ApplySimplifyR6SkPath=r.asm.U).apply(null,arguments)},r.__Z11ApplyPathOpR6SkPathRKS_8SkPathOp=function(){return(r.__Z11ApplyPathOpR6SkPathRKS_8SkPathOp=r.asm.V).apply(null,arguments)},r.__Z10MakeFromOpRK6SkPathS1_8SkPathOp=function(){return(r.__Z10MakeFromOpRK6SkPathS1_8SkPathOp=r.asm.W).apply(null,arguments)},r.__Z14ResolveBuilderR11SkOpBuilder=function(){return(r.__Z14ResolveBuilderR11SkOpBuilder=r.asm.X).apply(null,arguments)},r.__Z8ToCanvasRK6SkPathN10emscripten3valE=function(){return(r.__Z8ToCanvasRK6SkPathN10emscripten3valE=r.asm.Y).apply(null,arguments)},r.__Z8ToPath2DRK6SkPath=function(){return(r.__Z8ToPath2DRK6SkPath=r.asm.Z).apply(null,arguments)};var st=r._free=function(){return(st=r._free=r.asm.$).apply(null,arguments)},gn=r._malloc=function(){return(gn=r._malloc=r.asm.aa).apply(null,arguments)},ei=r.___getTypeName=function(){return(ei=r.___getTypeName=r.asm.ba).apply(null,arguments)};r.___embind_register_native_and_builtin_types=function(){return(r.___embind_register_native_and_builtin_types=r.asm.ca).apply(null,arguments)},r.dynCall_jiji=function(){return(r.dynCall_jiji=r.asm.da).apply(null,arguments)};var Lt;q=function s(){Lt||yn(),Lt||(q=s)};function yn(){function s(){if(!Lt&&(Lt=!0,r.calledRun=!0,!I)){if(xe(f),u(r),r.onRuntimeInitialized&&r.onRuntimeInitialized(),r.postRun)for(typeof r.postRun=="function"&&(r.postRun=[r.postRun]);r.postRun.length;){var a=r.postRun.shift();w.unshift(a)}xe(w)}}if(!(0<F)){if(r.preRun)for(typeof r.preRun=="function"&&(r.preRun=[r.preRun]);r.preRun.length;)H();xe(c),0<F||(r.setStatus?(r.setStatus("Running..."),setTimeout(function(){setTimeout(function(){r.setStatus("")},1),s()},1)):s())}}if(r.run=yn,r.preInit)for(typeof r.preInit=="function"&&(r.preInit=[r.preInit]);0<r.preInit.length;)r.preInit.pop()();return yn(),o.ready}})();i.exports=t})($i);var Br=$i.exports;const Fr=Bn(Br),Xr="/assets/pathkit-1356ccfa.wasm";class An{startTime;accumulatedTime;constructor(){this.startTime=-1,this.accumulatedTime=-1}start(){this.startTime=performance.now(),this.accumulatedTime=0}resume(){this.startTime=performance.now()}pause(){return this.accumulatedTime+=performance.now()-this.startTime,this.startTime=-1,this.accumulatedTime}stop(){if(this.startTime!=-1){const e=performance.now()-this.startTime+this.accumulatedTime;return this.accumulatedTime=0,e}else{const e=this.accumulatedTime;return this.accumulatedTime=0,e}}}function Mt(i){throw new Error('Could not dynamically require "'+i+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var Pi={exports:{}};(function(i,e){(function(t){i.exports=t()})(function(){return function t(n,o,r){function l(y,N){if(!o[y]){if(!n[y]){var C=typeof Mt=="function"&&Mt;if(!N&&C)return C(y,!0);if(u)return u(y,!0);throw new Error("Cannot find module '"+y+"'")}N=o[y]={exports:{}},n[y][0].call(N.exports,function(k){var X=n[y][1][k];return l(X||k)},N,N.exports,t,n,o,r)}return o[y].exports}for(var u=typeof Mt=="function"&&Mt,m=0;m<r.length;m++)l(r[m]);return l}({1:[function(t,n,o){(function(r,l,u,m,y,N,C,k,X){var b=t("crypto");function P(x,I){I=A(x,I);var g;return(g=I.algorithm!=="passthrough"?b.createHash(I.algorithm):new Y).write===void 0&&(g.write=g.update,g.end=g.update),U(I,g).dispatch(x),g.update||g.end(""),g.digest?g.digest(I.encoding==="buffer"?void 0:I.encoding):(x=g.read(),I.encoding!=="buffer"?x.toString(I.encoding):x)}(o=n.exports=P).sha1=function(x){return P(x)},o.keys=function(x){return P(x,{excludeValues:!0,algorithm:"sha1",encoding:"hex"})},o.MD5=function(x){return P(x,{algorithm:"md5",encoding:"hex"})},o.keysMD5=function(x){return P(x,{algorithm:"md5",encoding:"hex",excludeValues:!0})};var O=b.getHashes?b.getHashes().slice():["sha1","md5"],M=(O.push("passthrough"),["buffer","hex","binary","base64"]);function A(x,I){var g={};if(g.algorithm=(I=I||{}).algorithm||"sha1",g.encoding=I.encoding||"hex",g.excludeValues=!!I.excludeValues,g.algorithm=g.algorithm.toLowerCase(),g.encoding=g.encoding.toLowerCase(),g.ignoreUnknown=I.ignoreUnknown===!0,g.respectType=I.respectType!==!1,g.respectFunctionNames=I.respectFunctionNames!==!1,g.respectFunctionProperties=I.respectFunctionProperties!==!1,g.unorderedArrays=I.unorderedArrays===!0,g.unorderedSets=I.unorderedSets!==!1,g.unorderedObjects=I.unorderedObjects!==!1,g.replacer=I.replacer||void 0,g.excludeKeys=I.excludeKeys||void 0,x===void 0)throw new Error("Object argument required.");for(var E=0;E<O.length;++E)O[E].toLowerCase()===g.algorithm.toLowerCase()&&(g.algorithm=O[E]);if(O.indexOf(g.algorithm)===-1)throw new Error('Algorithm "'+g.algorithm+'"  not supported. supported values: '+O.join(", "));if(M.indexOf(g.encoding)===-1&&g.algorithm!=="passthrough")throw new Error('Encoding "'+g.encoding+'"  not supported. supported values: '+M.join(", "));return g}function B(x){if(typeof x=="function")return/^function\s+\w*\s*\(\s*\)\s*{\s+\[native code\]\s+}$/i.exec(Function.prototype.toString.call(x))!=null}function U(x,I,g){g=g||[];function E(p){return I.update?I.update(p,"utf8"):I.write(p,"utf8")}return{dispatch:function(p){return this["_"+((p=x.replacer?x.replacer(p):p)===null?"null":typeof p)](p)},_object:function(p){var _,L=Object.prototype.toString.call(p),ie=/\[object (.*)\]/i.exec(L);if(ie=(ie=ie?ie[1]:"unknown:["+L+"]").toLowerCase(),0<=(L=g.indexOf(p)))return this.dispatch("[CIRCULAR:"+L+"]");if(g.push(p),u!==void 0&&u.isBuffer&&u.isBuffer(p))return E("buffer:"),E(p);if(ie==="object"||ie==="function"||ie==="asyncfunction")return L=Object.keys(p),x.unorderedObjects&&(L=L.sort()),x.respectType===!1||B(p)||L.splice(0,0,"prototype","__proto__","constructor"),x.excludeKeys&&(L=L.filter(function(ae){return!x.excludeKeys(ae)})),E("object:"+L.length+":"),_=this,L.forEach(function(ae){_.dispatch(ae),E(":"),x.excludeValues||_.dispatch(p[ae]),E(",")});if(!this["_"+ie]){if(x.ignoreUnknown)return E("["+ie+"]");throw new Error('Unknown object type "'+ie+'"')}this["_"+ie](p)},_array:function(p,ae){ae=ae!==void 0?ae:x.unorderedArrays!==!1;var L=this;if(E("array:"+p.length+":"),!ae||p.length<=1)return p.forEach(function(oe){return L.dispatch(oe)});var ie=[],ae=p.map(function(oe){var Q=new Y,he=g.slice();return U(x,Q,he).dispatch(oe),ie=ie.concat(he.slice(g.length)),Q.read().toString()});return g=g.concat(ie),ae.sort(),this._array(ae,!1)},_date:function(p){return E("date:"+p.toJSON())},_symbol:function(p){return E("symbol:"+p.toString())},_error:function(p){return E("error:"+p.toString())},_boolean:function(p){return E("bool:"+p.toString())},_string:function(p){E("string:"+p.length+":"),E(p.toString())},_function:function(p){E("fn:"),B(p)?this.dispatch("[native]"):this.dispatch(p.toString()),x.respectFunctionNames!==!1&&this.dispatch("function-name:"+String(p.name)),x.respectFunctionProperties&&this._object(p)},_number:function(p){return E("number:"+p.toString())},_xml:function(p){return E("xml:"+p.toString())},_null:function(){return E("Null")},_undefined:function(){return E("Undefined")},_regexp:function(p){return E("regex:"+p.toString())},_uint8array:function(p){return E("uint8array:"),this.dispatch(Array.prototype.slice.call(p))},_uint8clampedarray:function(p){return E("uint8clampedarray:"),this.dispatch(Array.prototype.slice.call(p))},_int8array:function(p){return E("int8array:"),this.dispatch(Array.prototype.slice.call(p))},_uint16array:function(p){return E("uint16array:"),this.dispatch(Array.prototype.slice.call(p))},_int16array:function(p){return E("int16array:"),this.dispatch(Array.prototype.slice.call(p))},_uint32array:function(p){return E("uint32array:"),this.dispatch(Array.prototype.slice.call(p))},_int32array:function(p){return E("int32array:"),this.dispatch(Array.prototype.slice.call(p))},_float32array:function(p){return E("float32array:"),this.dispatch(Array.prototype.slice.call(p))},_float64array:function(p){return E("float64array:"),this.dispatch(Array.prototype.slice.call(p))},_arraybuffer:function(p){return E("arraybuffer:"),this.dispatch(new Uint8Array(p))},_url:function(p){return E("url:"+p.toString())},_map:function(p){return E("map:"),p=Array.from(p),this._array(p,x.unorderedSets!==!1)},_set:function(p){return E("set:"),p=Array.from(p),this._array(p,x.unorderedSets!==!1)},_file:function(p){return E("file:"),this.dispatch([p.name,p.size,p.type,p.lastModfied])},_blob:function(){if(x.ignoreUnknown)return E("[blob]");throw Error(`Hashing Blob objects is currently not supported
(see https://github.com/puleos/object-hash/issues/26)
Use "options.replacer" or "options.ignoreUnknown"
`)},_domwindow:function(){return E("domwindow")},_bigint:function(p){return E("bigint:"+p.toString())},_process:function(){return E("process")},_timer:function(){return E("timer")},_pipe:function(){return E("pipe")},_tcp:function(){return E("tcp")},_udp:function(){return E("udp")},_tty:function(){return E("tty")},_statwatcher:function(){return E("statwatcher")},_securecontext:function(){return E("securecontext")},_connection:function(){return E("connection")},_zlib:function(){return E("zlib")},_context:function(){return E("context")},_nodescript:function(){return E("nodescript")},_httpparser:function(){return E("httpparser")},_dataview:function(){return E("dataview")},_signal:function(){return E("signal")},_fsevent:function(){return E("fsevent")},_tlswrap:function(){return E("tlswrap")}}}function Y(){return{buf:"",write:function(x){this.buf+=x},end:function(x){this.buf+=x},read:function(){return this.buf}}}o.writeToStream=function(x,I,g){return g===void 0&&(g=I,I={}),U(I=A(x,I),g).dispatch(x)}}).call(this,t("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},t("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/fake_9a5aa49d.js","/")},{buffer:3,crypto:5,lYpoI2:11}],2:[function(t,n,o){(function(r,l,u,m,y,N,C,k,X){(function(b){var P=typeof Uint8Array<"u"?Uint8Array:Array,O="+".charCodeAt(0),M="/".charCodeAt(0),A="0".charCodeAt(0),B="a".charCodeAt(0),U="A".charCodeAt(0),Y="-".charCodeAt(0),x="_".charCodeAt(0);function I(g){return g=g.charCodeAt(0),g===O||g===Y?62:g===M||g===x?63:g<A?-1:g<A+10?g-A+26+26:g<U+26?g-U:g<B+26?g-B+26:void 0}b.toByteArray=function(g){var E,p;if(0<g.length%4)throw new Error("Invalid string. Length must be a multiple of 4");var _=g.length,_=g.charAt(_-2)==="="?2:g.charAt(_-1)==="="?1:0,L=new P(3*g.length/4-_),ie=0<_?g.length-4:g.length,ae=0;function oe(Q){L[ae++]=Q}for(E=0;E<ie;E+=4,0)oe((16711680&(p=I(g.charAt(E))<<18|I(g.charAt(E+1))<<12|I(g.charAt(E+2))<<6|I(g.charAt(E+3))))>>16),oe((65280&p)>>8),oe(255&p);return _==2?oe(255&(p=I(g.charAt(E))<<2|I(g.charAt(E+1))>>4)):_==1&&(oe((p=I(g.charAt(E))<<10|I(g.charAt(E+1))<<4|I(g.charAt(E+2))>>2)>>8&255),oe(255&p)),L},b.fromByteArray=function(g){var E,p,_,L,ie=g.length%3,ae="";function oe(Q){return"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(Q)}for(E=0,_=g.length-ie;E<_;E+=3)p=(g[E]<<16)+(g[E+1]<<8)+g[E+2],ae+=oe((L=p)>>18&63)+oe(L>>12&63)+oe(L>>6&63)+oe(63&L);switch(ie){case 1:ae=(ae+=oe((p=g[g.length-1])>>2))+oe(p<<4&63)+"==";break;case 2:ae=(ae=(ae+=oe((p=(g[g.length-2]<<8)+g[g.length-1])>>10))+oe(p>>4&63))+oe(p<<2&63)+"="}return ae}})(o===void 0?this.base64js={}:o)}).call(this,t("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},t("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/base64-js/lib/b64.js","/node_modules/gulp-browserify/node_modules/base64-js/lib")},{buffer:3,lYpoI2:11}],3:[function(t,n,o){(function(r,l,O,m,y,N,C,k,X){var b=t("base64-js"),P=t("ieee754");function O(c,f,w){if(!(this instanceof O))return new O(c,f,w);var H,F,q,te,ce=typeof c;if(f==="base64"&&ce=="string")for(c=(te=c).trim?te.trim():te.replace(/^\s+|\s+$/g,"");c.length%4!=0;)c+="=";if(ce=="number")H=be(c);else if(ce=="string")H=O.byteLength(c,f);else{if(ce!="object")throw new Error("First argument needs to be a number, array or string.");H=be(c.length)}if(O._useTypedArrays?F=O._augment(new Uint8Array(H)):((F=this).length=H,F._isBuffer=!0),O._useTypedArrays&&typeof c.byteLength=="number")F._set(c);else if(me(te=c)||O.isBuffer(te)||te&&typeof te=="object"&&typeof te.length=="number")for(q=0;q<H;q++)O.isBuffer(c)?F[q]=c.readUInt8(q):F[q]=c[q];else if(ce=="string")F.write(c,0,f);else if(ce=="number"&&!O._useTypedArrays&&!w)for(q=0;q<H;q++)F[q]=0;return F}function M(c,f,w,H){return O._charsWritten=ge(function(F){for(var q=[],te=0;te<F.length;te++)q.push(255&F.charCodeAt(te));return q}(f),c,w,H)}function A(c,f,w,H){return O._charsWritten=ge(function(F){for(var q,te,ce=[],se=0;se<F.length;se++)te=F.charCodeAt(se),q=te>>8,te=te%256,ce.push(te),ce.push(q);return ce}(f),c,w,H)}function B(c,f,w){var H="";w=Math.min(c.length,w);for(var F=f;F<w;F++)H+=String.fromCharCode(c[F]);return H}function U(c,f,w,q){q||(K(typeof w=="boolean","missing or invalid endian"),K(f!=null,"missing offset"),K(f+1<c.length,"Trying to read beyond buffer length"));var F,q=c.length;if(!(q<=f))return w?(F=c[f],f+1<q&&(F|=c[f+1]<<8)):(F=c[f]<<8,f+1<q&&(F|=c[f+1])),F}function Y(c,f,w,q){q||(K(typeof w=="boolean","missing or invalid endian"),K(f!=null,"missing offset"),K(f+3<c.length,"Trying to read beyond buffer length"));var F,q=c.length;if(!(q<=f))return w?(f+2<q&&(F=c[f+2]<<16),f+1<q&&(F|=c[f+1]<<8),F|=c[f],f+3<q&&(F+=c[f+3]<<24>>>0)):(f+1<q&&(F=c[f+1]<<16),f+2<q&&(F|=c[f+2]<<8),f+3<q&&(F|=c[f+3]),F+=c[f]<<24>>>0),F}function x(c,f,w,H){if(H||(K(typeof w=="boolean","missing or invalid endian"),K(f!=null,"missing offset"),K(f+1<c.length,"Trying to read beyond buffer length")),!(c.length<=f))return H=U(c,f,w,!0),32768&H?-1*(65535-H+1):H}function I(c,f,w,H){if(H||(K(typeof w=="boolean","missing or invalid endian"),K(f!=null,"missing offset"),K(f+3<c.length,"Trying to read beyond buffer length")),!(c.length<=f))return H=Y(c,f,w,!0),2147483648&H?-1*(4294967295-H+1):H}function g(c,f,w,H){return H||(K(typeof w=="boolean","missing or invalid endian"),K(f+3<c.length,"Trying to read beyond buffer length")),P.read(c,f,w,23,4)}function E(c,f,w,H){return H||(K(typeof w=="boolean","missing or invalid endian"),K(f+7<c.length,"Trying to read beyond buffer length")),P.read(c,f,w,52,8)}function p(c,f,w,H,F){if(F||(K(f!=null,"missing value"),K(typeof H=="boolean","missing or invalid endian"),K(w!=null,"missing offset"),K(w+1<c.length,"trying to write beyond buffer length"),He(f,65535)),F=c.length,!(F<=w))for(var q=0,te=Math.min(F-w,2);q<te;q++)c[w+q]=(f&255<<8*(H?q:1-q))>>>8*(H?q:1-q)}function _(c,f,w,H,F){if(F||(K(f!=null,"missing value"),K(typeof H=="boolean","missing or invalid endian"),K(w!=null,"missing offset"),K(w+3<c.length,"trying to write beyond buffer length"),He(f,4294967295)),F=c.length,!(F<=w))for(var q=0,te=Math.min(F-w,4);q<te;q++)c[w+q]=f>>>8*(H?q:3-q)&255}function L(c,f,w,H,F){F||(K(f!=null,"missing value"),K(typeof H=="boolean","missing or invalid endian"),K(w!=null,"missing offset"),K(w+1<c.length,"Trying to write beyond buffer length"),Xe(f,32767,-32768)),c.length<=w||p(c,0<=f?f:65535+f+1,w,H,F)}function ie(c,f,w,H,F){F||(K(f!=null,"missing value"),K(typeof H=="boolean","missing or invalid endian"),K(w!=null,"missing offset"),K(w+3<c.length,"Trying to write beyond buffer length"),Xe(f,2147483647,-2147483648)),c.length<=w||_(c,0<=f?f:4294967295+f+1,w,H,F)}function ae(c,f,w,H,F){F||(K(f!=null,"missing value"),K(typeof H=="boolean","missing or invalid endian"),K(w!=null,"missing offset"),K(w+3<c.length,"Trying to write beyond buffer length"),Re(f,34028234663852886e22,-34028234663852886e22)),c.length<=w||P.write(c,f,w,H,23,4)}function oe(c,f,w,H,F){F||(K(f!=null,"missing value"),K(typeof H=="boolean","missing or invalid endian"),K(w!=null,"missing offset"),K(w+7<c.length,"Trying to write beyond buffer length"),Re(f,17976931348623157e292,-17976931348623157e292)),c.length<=w||P.write(c,f,w,H,52,8)}o.Buffer=O,o.SlowBuffer=O,o.INSPECT_MAX_BYTES=50,O.poolSize=8192,O._useTypedArrays=function(){try{var c=new ArrayBuffer(0),f=new Uint8Array(c);return f.foo=function(){return 42},f.foo()===42&&typeof f.subarray=="function"}catch{return!1}}(),O.isEncoding=function(c){switch(String(c).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"binary":case"base64":case"raw":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},O.isBuffer=function(c){return!(c==null||!c._isBuffer)},O.byteLength=function(c,f){var w;switch(c+="",f||"utf8"){case"hex":w=c.length/2;break;case"utf8":case"utf-8":w=ve(c).length;break;case"ascii":case"binary":case"raw":w=c.length;break;case"base64":w=Le(c).length;break;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":w=2*c.length;break;default:throw new Error("Unknown encoding")}return w},O.concat=function(c,f){if(K(me(c),`Usage: Buffer.concat(list, [totalLength])
list should be an Array.`),c.length===0)return new O(0);if(c.length===1)return c[0];if(typeof f!="number")for(F=f=0;F<c.length;F++)f+=c[F].length;for(var w=new O(f),H=0,F=0;F<c.length;F++){var q=c[F];q.copy(w,H),H+=q.length}return w},O.prototype.write=function(c,f,w,H){isFinite(f)?isFinite(w)||(H=w,w=void 0):(se=H,H=f,f=w,w=se),f=Number(f)||0;var F,q,te,ce,se=this.length-f;switch((!w||se<(w=Number(w)))&&(w=se),H=String(H||"utf8").toLowerCase()){case"hex":F=function(De,Me,Ce,xe){Ce=Number(Ce)||0;var de=De.length-Ce;(!xe||de<(xe=Number(xe)))&&(xe=de),K((de=Me.length)%2==0,"Invalid hex string"),de/2<xe&&(xe=de/2);for(var Ee=0;Ee<xe;Ee++){var Ze=parseInt(Me.substr(2*Ee,2),16);K(!isNaN(Ze),"Invalid hex string"),De[Ce+Ee]=Ze}return O._charsWritten=2*Ee,Ee}(this,c,f,w);break;case"utf8":case"utf-8":q=this,te=f,ce=w,F=O._charsWritten=ge(ve(c),q,te,ce);break;case"ascii":case"binary":F=M(this,c,f,w);break;case"base64":q=this,te=f,ce=w,F=O._charsWritten=ge(Le(c),q,te,ce);break;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":F=A(this,c,f,w);break;default:throw new Error("Unknown encoding")}return F},O.prototype.toString=function(c,f,w){var H,F,q,te,ce=this;if(c=String(c||"utf8").toLowerCase(),f=Number(f)||0,(w=w!==void 0?Number(w):ce.length)===f)return"";switch(c){case"hex":H=function(se,De,Me){var Ce=se.length;(!De||De<0)&&(De=0),(!Me||Me<0||Ce<Me)&&(Me=Ce);for(var xe="",de=De;de<Me;de++)xe+=le(se[de]);return xe}(ce,f,w);break;case"utf8":case"utf-8":H=function(se,De,Me){var Ce="",xe="";Me=Math.min(se.length,Me);for(var de=De;de<Me;de++)se[de]<=127?(Ce+=_e(xe)+String.fromCharCode(se[de]),xe=""):xe+="%"+se[de].toString(16);return Ce+_e(xe)}(ce,f,w);break;case"ascii":case"binary":H=B(ce,f,w);break;case"base64":F=ce,te=w,H=(q=f)===0&&te===F.length?b.fromByteArray(F):b.fromByteArray(F.slice(q,te));break;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":H=function(se,De,Me){for(var Ce=se.slice(De,Me),xe="",de=0;de<Ce.length;de+=2)xe+=String.fromCharCode(Ce[de]+256*Ce[de+1]);return xe}(ce,f,w);break;default:throw new Error("Unknown encoding")}return H},O.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}},O.prototype.copy=function(c,f,w,H){if(f=f||0,(H=H||H===0?H:this.length)!==(w=w||0)&&c.length!==0&&this.length!==0){K(w<=H,"sourceEnd < sourceStart"),K(0<=f&&f<c.length,"targetStart out of bounds"),K(0<=w&&w<this.length,"sourceStart out of bounds"),K(0<=H&&H<=this.length,"sourceEnd out of bounds"),H>this.length&&(H=this.length);var F=(H=c.length-f<H-w?c.length-f+w:H)-w;if(F<100||!O._useTypedArrays)for(var q=0;q<F;q++)c[q+f]=this[q+w];else c._set(this.subarray(w,w+F),f)}},O.prototype.slice=function(c,f){var w=this.length;if(c=he(c,w,0),f=he(f,w,w),O._useTypedArrays)return O._augment(this.subarray(c,f));for(var H=f-c,F=new O(H,void 0,!0),q=0;q<H;q++)F[q]=this[q+c];return F},O.prototype.get=function(c){return console.log(".get() is deprecated. Access using array indexes instead."),this.readUInt8(c)},O.prototype.set=function(c,f){return console.log(".set() is deprecated. Access using array indexes instead."),this.writeUInt8(c,f)},O.prototype.readUInt8=function(c,f){if(f||(K(c!=null,"missing offset"),K(c<this.length,"Trying to read beyond buffer length")),!(c>=this.length))return this[c]},O.prototype.readUInt16LE=function(c,f){return U(this,c,!0,f)},O.prototype.readUInt16BE=function(c,f){return U(this,c,!1,f)},O.prototype.readUInt32LE=function(c,f){return Y(this,c,!0,f)},O.prototype.readUInt32BE=function(c,f){return Y(this,c,!1,f)},O.prototype.readInt8=function(c,f){if(f||(K(c!=null,"missing offset"),K(c<this.length,"Trying to read beyond buffer length")),!(c>=this.length))return 128&this[c]?-1*(255-this[c]+1):this[c]},O.prototype.readInt16LE=function(c,f){return x(this,c,!0,f)},O.prototype.readInt16BE=function(c,f){return x(this,c,!1,f)},O.prototype.readInt32LE=function(c,f){return I(this,c,!0,f)},O.prototype.readInt32BE=function(c,f){return I(this,c,!1,f)},O.prototype.readFloatLE=function(c,f){return g(this,c,!0,f)},O.prototype.readFloatBE=function(c,f){return g(this,c,!1,f)},O.prototype.readDoubleLE=function(c,f){return E(this,c,!0,f)},O.prototype.readDoubleBE=function(c,f){return E(this,c,!1,f)},O.prototype.writeUInt8=function(c,f,w){w||(K(c!=null,"missing value"),K(f!=null,"missing offset"),K(f<this.length,"trying to write beyond buffer length"),He(c,255)),f>=this.length||(this[f]=c)},O.prototype.writeUInt16LE=function(c,f,w){p(this,c,f,!0,w)},O.prototype.writeUInt16BE=function(c,f,w){p(this,c,f,!1,w)},O.prototype.writeUInt32LE=function(c,f,w){_(this,c,f,!0,w)},O.prototype.writeUInt32BE=function(c,f,w){_(this,c,f,!1,w)},O.prototype.writeInt8=function(c,f,w){w||(K(c!=null,"missing value"),K(f!=null,"missing offset"),K(f<this.length,"Trying to write beyond buffer length"),Xe(c,127,-128)),f>=this.length||(0<=c?this.writeUInt8(c,f,w):this.writeUInt8(255+c+1,f,w))},O.prototype.writeInt16LE=function(c,f,w){L(this,c,f,!0,w)},O.prototype.writeInt16BE=function(c,f,w){L(this,c,f,!1,w)},O.prototype.writeInt32LE=function(c,f,w){ie(this,c,f,!0,w)},O.prototype.writeInt32BE=function(c,f,w){ie(this,c,f,!1,w)},O.prototype.writeFloatLE=function(c,f,w){ae(this,c,f,!0,w)},O.prototype.writeFloatBE=function(c,f,w){ae(this,c,f,!1,w)},O.prototype.writeDoubleLE=function(c,f,w){oe(this,c,f,!0,w)},O.prototype.writeDoubleBE=function(c,f,w){oe(this,c,f,!1,w)},O.prototype.fill=function(c,f,w){if(f=f||0,w=w||this.length,K(typeof(c=typeof(c=c||0)=="string"?c.charCodeAt(0):c)=="number"&&!isNaN(c),"value is not a number"),K(f<=w,"end < start"),w!==f&&this.length!==0){K(0<=f&&f<this.length,"start out of bounds"),K(0<=w&&w<=this.length,"end out of bounds");for(var H=f;H<w;H++)this[H]=c}},O.prototype.inspect=function(){for(var c=[],f=this.length,w=0;w<f;w++)if(c[w]=le(this[w]),w===o.INSPECT_MAX_BYTES){c[w+1]="...";break}return"<Buffer "+c.join(" ")+">"},O.prototype.toArrayBuffer=function(){if(typeof Uint8Array>"u")throw new Error("Buffer.toArrayBuffer not supported in this browser");if(O._useTypedArrays)return new O(this).buffer;for(var c=new Uint8Array(this.length),f=0,w=c.length;f<w;f+=1)c[f]=this[f];return c.buffer};var Q=O.prototype;function he(c,f,w){return typeof c!="number"?w:f<=(c=~~c)?f:0<=c||0<=(c+=f)?c:0}function be(c){return(c=~~Math.ceil(+c))<0?0:c}function me(c){return(Array.isArray||function(f){return Object.prototype.toString.call(f)==="[object Array]"})(c)}function le(c){return c<16?"0"+c.toString(16):c.toString(16)}function ve(c){for(var f=[],w=0;w<c.length;w++){var H=c.charCodeAt(w);if(H<=127)f.push(c.charCodeAt(w));else for(var F=w,q=(55296<=H&&H<=57343&&w++,encodeURIComponent(c.slice(F,w+1)).substr(1).split("%")),te=0;te<q.length;te++)f.push(parseInt(q[te],16))}return f}function Le(c){return b.toByteArray(c)}function ge(c,f,w,H){for(var F=0;F<H&&!(F+w>=f.length||F>=c.length);F++)f[F+w]=c[F];return F}function _e(c){try{return decodeURIComponent(c)}catch{return String.fromCharCode(65533)}}function He(c,f){K(typeof c=="number","cannot write a non-number as a number"),K(0<=c,"specified a negative value for writing an unsigned value"),K(c<=f,"value is larger than maximum value for type"),K(Math.floor(c)===c,"value has a fractional component")}function Xe(c,f,w){K(typeof c=="number","cannot write a non-number as a number"),K(c<=f,"value larger than maximum allowed value"),K(w<=c,"value smaller than minimum allowed value"),K(Math.floor(c)===c,"value has a fractional component")}function Re(c,f,w){K(typeof c=="number","cannot write a non-number as a number"),K(c<=f,"value larger than maximum allowed value"),K(w<=c,"value smaller than minimum allowed value")}function K(c,f){if(!c)throw new Error(f||"Failed assertion")}O._augment=function(c){return c._isBuffer=!0,c._get=c.get,c._set=c.set,c.get=Q.get,c.set=Q.set,c.write=Q.write,c.toString=Q.toString,c.toLocaleString=Q.toString,c.toJSON=Q.toJSON,c.copy=Q.copy,c.slice=Q.slice,c.readUInt8=Q.readUInt8,c.readUInt16LE=Q.readUInt16LE,c.readUInt16BE=Q.readUInt16BE,c.readUInt32LE=Q.readUInt32LE,c.readUInt32BE=Q.readUInt32BE,c.readInt8=Q.readInt8,c.readInt16LE=Q.readInt16LE,c.readInt16BE=Q.readInt16BE,c.readInt32LE=Q.readInt32LE,c.readInt32BE=Q.readInt32BE,c.readFloatLE=Q.readFloatLE,c.readFloatBE=Q.readFloatBE,c.readDoubleLE=Q.readDoubleLE,c.readDoubleBE=Q.readDoubleBE,c.writeUInt8=Q.writeUInt8,c.writeUInt16LE=Q.writeUInt16LE,c.writeUInt16BE=Q.writeUInt16BE,c.writeUInt32LE=Q.writeUInt32LE,c.writeUInt32BE=Q.writeUInt32BE,c.writeInt8=Q.writeInt8,c.writeInt16LE=Q.writeInt16LE,c.writeInt16BE=Q.writeInt16BE,c.writeInt32LE=Q.writeInt32LE,c.writeInt32BE=Q.writeInt32BE,c.writeFloatLE=Q.writeFloatLE,c.writeFloatBE=Q.writeFloatBE,c.writeDoubleLE=Q.writeDoubleLE,c.writeDoubleBE=Q.writeDoubleBE,c.fill=Q.fill,c.inspect=Q.inspect,c.toArrayBuffer=Q.toArrayBuffer,c}}).call(this,t("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},t("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/buffer/index.js","/node_modules/gulp-browserify/node_modules/buffer")},{"base64-js":2,buffer:3,ieee754:10,lYpoI2:11}],4:[function(t,n,o){(function(r,l,b,m,y,N,C,k,X){var b=t("buffer").Buffer,P=4,O=new b(P);O.fill(0),n.exports={hash:function(M,A,B,U){for(var Y=A(function(p,_){p.length%P!=0&&(L=p.length+(P-p.length%P),p=b.concat([p,O],L));for(var L,ie=[],ae=_?p.readInt32BE:p.readInt32LE,oe=0;oe<p.length;oe+=P)ie.push(ae.call(p,oe));return ie}(M=b.isBuffer(M)?M:new b(M),U),8*M.length),A=U,x=new b(B),I=A?x.writeInt32BE:x.writeInt32LE,g=0;g<Y.length;g++)I.call(x,Y[g],4*g,!0);return x}}}).call(this,t("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},t("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/crypto-browserify/helpers.js","/node_modules/gulp-browserify/node_modules/crypto-browserify")},{buffer:3,lYpoI2:11}],5:[function(t,n,o){(function(r,l,b,m,y,N,C,k,X){var b=t("buffer").Buffer,P=t("./sha"),O=t("./sha256"),M=t("./rng"),A={sha1:P,sha256:O,md5:t("./md5")},B=64,U=new b(B);function Y(p,_){var L=A[p=p||"sha1"],ie=[];return L||x("algorithm:",p,"is not yet supported"),{update:function(ae){return b.isBuffer(ae)||(ae=new b(ae)),ie.push(ae),ae.length,this},digest:function(ae){var oe=b.concat(ie),oe=_?function(Q,he,be){b.isBuffer(he)||(he=new b(he)),b.isBuffer(be)||(be=new b(be)),he.length>B?he=Q(he):he.length<B&&(he=b.concat([he,U],B));for(var me=new b(B),le=new b(B),ve=0;ve<B;ve++)me[ve]=54^he[ve],le[ve]=92^he[ve];return be=Q(b.concat([me,be])),Q(b.concat([le,be]))}(L,_,oe):L(oe);return ie=null,ae?oe.toString(ae):oe}}}function x(){var p=[].slice.call(arguments).join(" ");throw new Error([p,"we accept pull requests","http://github.com/dominictarr/crypto-browserify"].join(`
`))}U.fill(0),o.createHash=function(p){return Y(p)},o.createHmac=Y,o.randomBytes=function(p,_){if(!_||!_.call)return new b(M(p));try{_.call(this,void 0,new b(M(p)))}catch(L){_(L)}};var I,g=["createCredentials","createCipher","createCipheriv","createDecipher","createDecipheriv","createSign","createVerify","createDiffieHellman","pbkdf2"],E=function(p){o[p]=function(){x("sorry,",p,"is not implemented yet")}};for(I in g)E(g[I])}).call(this,t("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},t("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/crypto-browserify/index.js","/node_modules/gulp-browserify/node_modules/crypto-browserify")},{"./md5":6,"./rng":7,"./sha":8,"./sha256":9,buffer:3,lYpoI2:11}],6:[function(t,n,o){(function(r,l,u,m,y,N,C,k,X){var b=t("./helpers");function P(x,I){x[I>>5]|=128<<I%32,x[14+(I+64>>>9<<4)]=I;for(var g=1732584193,E=-271733879,p=-1732584194,_=271733878,L=0;L<x.length;L+=16){var ie=g,ae=E,oe=p,Q=_,g=M(g,E,p,_,x[L+0],7,-680876936),_=M(_,g,E,p,x[L+1],12,-389564586),p=M(p,_,g,E,x[L+2],17,606105819),E=M(E,p,_,g,x[L+3],22,-1044525330);g=M(g,E,p,_,x[L+4],7,-176418897),_=M(_,g,E,p,x[L+5],12,1200080426),p=M(p,_,g,E,x[L+6],17,-1473231341),E=M(E,p,_,g,x[L+7],22,-45705983),g=M(g,E,p,_,x[L+8],7,1770035416),_=M(_,g,E,p,x[L+9],12,-1958414417),p=M(p,_,g,E,x[L+10],17,-42063),E=M(E,p,_,g,x[L+11],22,-1990404162),g=M(g,E,p,_,x[L+12],7,1804603682),_=M(_,g,E,p,x[L+13],12,-40341101),p=M(p,_,g,E,x[L+14],17,-1502002290),g=A(g,E=M(E,p,_,g,x[L+15],22,1236535329),p,_,x[L+1],5,-165796510),_=A(_,g,E,p,x[L+6],9,-1069501632),p=A(p,_,g,E,x[L+11],14,643717713),E=A(E,p,_,g,x[L+0],20,-373897302),g=A(g,E,p,_,x[L+5],5,-701558691),_=A(_,g,E,p,x[L+10],9,38016083),p=A(p,_,g,E,x[L+15],14,-660478335),E=A(E,p,_,g,x[L+4],20,-405537848),g=A(g,E,p,_,x[L+9],5,568446438),_=A(_,g,E,p,x[L+14],9,-1019803690),p=A(p,_,g,E,x[L+3],14,-187363961),E=A(E,p,_,g,x[L+8],20,1163531501),g=A(g,E,p,_,x[L+13],5,-1444681467),_=A(_,g,E,p,x[L+2],9,-51403784),p=A(p,_,g,E,x[L+7],14,1735328473),g=B(g,E=A(E,p,_,g,x[L+12],20,-1926607734),p,_,x[L+5],4,-378558),_=B(_,g,E,p,x[L+8],11,-2022574463),p=B(p,_,g,E,x[L+11],16,1839030562),E=B(E,p,_,g,x[L+14],23,-35309556),g=B(g,E,p,_,x[L+1],4,-1530992060),_=B(_,g,E,p,x[L+4],11,1272893353),p=B(p,_,g,E,x[L+7],16,-155497632),E=B(E,p,_,g,x[L+10],23,-1094730640),g=B(g,E,p,_,x[L+13],4,681279174),_=B(_,g,E,p,x[L+0],11,-358537222),p=B(p,_,g,E,x[L+3],16,-722521979),E=B(E,p,_,g,x[L+6],23,76029189),g=B(g,E,p,_,x[L+9],4,-640364487),_=B(_,g,E,p,x[L+12],11,-421815835),p=B(p,_,g,E,x[L+15],16,530742520),g=U(g,E=B(E,p,_,g,x[L+2],23,-995338651),p,_,x[L+0],6,-198630844),_=U(_,g,E,p,x[L+7],10,1126891415),p=U(p,_,g,E,x[L+14],15,-1416354905),E=U(E,p,_,g,x[L+5],21,-57434055),g=U(g,E,p,_,x[L+12],6,1700485571),_=U(_,g,E,p,x[L+3],10,-1894986606),p=U(p,_,g,E,x[L+10],15,-1051523),E=U(E,p,_,g,x[L+1],21,-2054922799),g=U(g,E,p,_,x[L+8],6,1873313359),_=U(_,g,E,p,x[L+15],10,-30611744),p=U(p,_,g,E,x[L+6],15,-1560198380),E=U(E,p,_,g,x[L+13],21,1309151649),g=U(g,E,p,_,x[L+4],6,-145523070),_=U(_,g,E,p,x[L+11],10,-1120210379),p=U(p,_,g,E,x[L+2],15,718787259),E=U(E,p,_,g,x[L+9],21,-343485551),g=Y(g,ie),E=Y(E,ae),p=Y(p,oe),_=Y(_,Q)}return Array(g,E,p,_)}function O(x,I,g,E,p,_){return Y((I=Y(Y(I,x),Y(E,_)))<<p|I>>>32-p,g)}function M(x,I,g,E,p,_,L){return O(I&g|~I&E,x,I,p,_,L)}function A(x,I,g,E,p,_,L){return O(I&E|g&~E,x,I,p,_,L)}function B(x,I,g,E,p,_,L){return O(I^g^E,x,I,p,_,L)}function U(x,I,g,E,p,_,L){return O(g^(I|~E),x,I,p,_,L)}function Y(x,I){var g=(65535&x)+(65535&I);return(x>>16)+(I>>16)+(g>>16)<<16|65535&g}n.exports=function(x){return b.hash(x,P,16)}}).call(this,t("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},t("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/crypto-browserify/md5.js","/node_modules/gulp-browserify/node_modules/crypto-browserify")},{"./helpers":4,buffer:3,lYpoI2:11}],7:[function(t,n,o){(function(r,l,u,m,y,N,C,k,X){n.exports=function(b){for(var P,O=new Array(b),M=0;M<b;M++)!(3&M)&&(P=4294967296*Math.random()),O[M]=P>>>((3&M)<<3)&255;return O}}).call(this,t("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},t("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/crypto-browserify/rng.js","/node_modules/gulp-browserify/node_modules/crypto-browserify")},{buffer:3,lYpoI2:11}],8:[function(t,n,o){(function(r,l,u,m,y,N,C,k,X){var b=t("./helpers");function P(A,B){A[B>>5]|=128<<24-B%32,A[15+(B+64>>9<<4)]=B;for(var U,Y,x,I=Array(80),g=1732584193,E=-271733879,p=-1732584194,_=271733878,L=-1009589776,ie=0;ie<A.length;ie+=16){for(var ae=g,oe=E,Q=p,he=_,be=L,me=0;me<80;me++){I[me]=me<16?A[ie+me]:M(I[me-3]^I[me-8]^I[me-14]^I[me-16],1);var le=O(O(M(g,5),(le=E,Y=p,x=_,(U=me)<20?le&Y|~le&x:!(U<40)&&U<60?le&Y|le&x|Y&x:le^Y^x)),O(O(L,I[me]),(U=me)<20?1518500249:U<40?1859775393:U<60?-1894007588:-899497514)),L=_,_=p,p=M(E,30),E=g,g=le}g=O(g,ae),E=O(E,oe),p=O(p,Q),_=O(_,he),L=O(L,be)}return Array(g,E,p,_,L)}function O(A,B){var U=(65535&A)+(65535&B);return(A>>16)+(B>>16)+(U>>16)<<16|65535&U}function M(A,B){return A<<B|A>>>32-B}n.exports=function(A){return b.hash(A,P,20,!0)}}).call(this,t("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},t("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/crypto-browserify/sha.js","/node_modules/gulp-browserify/node_modules/crypto-browserify")},{"./helpers":4,buffer:3,lYpoI2:11}],9:[function(t,n,o){(function(r,l,u,m,y,N,C,k,X){function b(B,U){var Y=(65535&B)+(65535&U);return(B>>16)+(U>>16)+(Y>>16)<<16|65535&Y}function P(B,U){var Y,x=new Array(1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298),I=new Array(1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225),g=new Array(64);B[U>>5]|=128<<24-U%32,B[15+(U+64>>9<<4)]=U;for(var E,p,_=0;_<B.length;_+=16){for(var L=I[0],ie=I[1],ae=I[2],oe=I[3],Q=I[4],he=I[5],be=I[6],me=I[7],le=0;le<64;le++)g[le]=le<16?B[le+_]:b(b(b((p=g[le-2],M(p,17)^M(p,19)^A(p,10)),g[le-7]),(p=g[le-15],M(p,7)^M(p,18)^A(p,3))),g[le-16]),Y=b(b(b(b(me,M(p=Q,6)^M(p,11)^M(p,25)),Q&he^~Q&be),x[le]),g[le]),E=b(M(E=L,2)^M(E,13)^M(E,22),L&ie^L&ae^ie&ae),me=be,be=he,he=Q,Q=b(oe,Y),oe=ae,ae=ie,ie=L,L=b(Y,E);I[0]=b(L,I[0]),I[1]=b(ie,I[1]),I[2]=b(ae,I[2]),I[3]=b(oe,I[3]),I[4]=b(Q,I[4]),I[5]=b(he,I[5]),I[6]=b(be,I[6]),I[7]=b(me,I[7])}return I}var O=t("./helpers"),M=function(B,U){return B>>>U|B<<32-U},A=function(B,U){return B>>>U};n.exports=function(B){return O.hash(B,P,32,!0)}}).call(this,t("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},t("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/crypto-browserify/sha256.js","/node_modules/gulp-browserify/node_modules/crypto-browserify")},{"./helpers":4,buffer:3,lYpoI2:11}],10:[function(t,n,o){(function(r,l,u,m,y,N,C,k,X){o.read=function(b,P,O,M,_){var B,U,Y=8*_-M-1,x=(1<<Y)-1,I=x>>1,g=-7,E=O?_-1:0,p=O?-1:1,_=b[P+E];for(E+=p,B=_&(1<<-g)-1,_>>=-g,g+=Y;0<g;B=256*B+b[P+E],E+=p,g-=8);for(U=B&(1<<-g)-1,B>>=-g,g+=M;0<g;U=256*U+b[P+E],E+=p,g-=8);if(B===0)B=1-I;else{if(B===x)return U?NaN:1/0*(_?-1:1);U+=Math.pow(2,M),B-=I}return(_?-1:1)*U*Math.pow(2,B-M)},o.write=function(b,P,O,M,A,L){var U,Y,x=8*L-A-1,I=(1<<x)-1,g=I>>1,E=A===23?Math.pow(2,-24)-Math.pow(2,-77):0,p=M?0:L-1,_=M?1:-1,L=P<0||P===0&&1/P<0?1:0;for(P=Math.abs(P),isNaN(P)||P===1/0?(Y=isNaN(P)?1:0,U=I):(U=Math.floor(Math.log(P)/Math.LN2),P*(M=Math.pow(2,-U))<1&&(U--,M*=2),2<=(P+=1<=U+g?E/M:E*Math.pow(2,1-g))*M&&(U++,M/=2),I<=U+g?(Y=0,U=I):1<=U+g?(Y=(P*M-1)*Math.pow(2,A),U+=g):(Y=P*Math.pow(2,g-1)*Math.pow(2,A),U=0));8<=A;b[O+p]=255&Y,p+=_,Y/=256,A-=8);for(U=U<<A|Y,x+=A;0<x;b[O+p]=255&U,p+=_,U/=256,x-=8);b[O+p-_]|=128*L}}).call(this,t("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},t("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/ieee754/index.js","/node_modules/gulp-browserify/node_modules/ieee754")},{buffer:3,lYpoI2:11}],11:[function(t,n,o){(function(r,l,u,m,y,N,C,k,X){var b,P,O;function M(){}(r=n.exports={}).nextTick=(P=typeof window<"u"&&window.setImmediate,O=typeof window<"u"&&window.postMessage&&window.addEventListener,P?function(A){return window.setImmediate(A)}:O?(b=[],window.addEventListener("message",function(A){var B=A.source;B!==window&&B!==null||A.data!=="process-tick"||(A.stopPropagation(),0<b.length&&b.shift()())},!0),function(A){b.push(A),window.postMessage("process-tick","*")}):function(A){setTimeout(A,0)}),r.title="browser",r.browser=!0,r.env={},r.argv=[],r.on=M,r.addListener=M,r.once=M,r.off=M,r.removeListener=M,r.removeAllListeners=M,r.emit=M,r.binding=function(A){throw new Error("process.binding is not supported")},r.cwd=function(){return"/"},r.chdir=function(A){throw new Error("process.chdir is not supported")}}).call(this,t("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},t("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/process/browser.js","/node_modules/gulp-browserify/node_modules/process")},{buffer:3,lYpoI2:11}]},{},[1])(1)})})(Pi);var Ur=Pi.exports;const Rt=Bn(Ur);class Vr{cache;useHash;constructor(e){this.cache={},this.useHash=e}cacheValue(e,t){this.cache[this.useHash?Rt(e):String(e)]=t}deleteValue(e){delete this.cache[this.useHash?Rt(e):String(e)]}getValue(e){return this.cache[this.useHash?Rt(e):String(e)]}isCached(e){return(this.useHash?Rt(e):String(e))in this.cache}invalidate(e){e&&Object.entries(this.cache).forEach(([t,n])=>e(t,n)),this.cache={}}}function Bt(i,e){return(i.x-e.x)*(i.x-e.x)+(i.y-e.y)*(i.y-e.y)}function Li(i,e){return i.x==e.x&&i.y==e.y}function Ft(i,e,t){return t===void 0&&(t=.01),Math.abs(i-e)<=t}function En(i,e){return(i%e+e)%e}async function jr(i){const e=await $.scene.local.getItems(n=>n.metadata[`${h.EXTENSIONID}/doorId`]!==void 0),t=[];for(let n of e){let o=!1;for(const r of i)n.metadata[`${h.EXTENSIONID}/doorId`]==r.id&&(o=!0);o&&t.push(n.id)}await $.scene.local.deleteItems(t)}async function zt(i){const e=[],t=await $.scene.local.getItems(n=>n.metadata[`${h.EXTENSIONID}/doorId`]!==void 0);for(const n of i){if(!Or(n)||t.some(l=>l.metadata[`${h.EXTENSIONID}/doorId`]===n.id))continue;const o=Ve.fromItem(n),r=[];for(let l=0;l<n.points.length;l++){const u=Ve.fromPosition(n.points[l]);r.push(Ve.decompose(Ve.multiply(o,u)).position)}e.push(St().locked(!0).commands(Mi(n.metadata[`${h.EXTENSIONID}/disabled`]===!0)).scale({x:.2,y:.2}).name("Door").position(je.centroid(r)).metadata({[`${h.EXTENSIONID}/doorId`]:n.id}).build())}e.length>0&&await $.scene.local.addItems(e)}async function Hr(i){const e=await $.scene.local.getItems(t=>t.id===i&&t.metadata[`${h.EXTENSIONID}/doorId`]!==void 0);if(e.length===1){const t=e[0].metadata[`${h.EXTENSIONID}/doorId`],n=S.items.filter(o=>o.id===t);await $.scene.items.updateItems(n,o=>{const r=o[0];r.metadata[`${h.EXTENSIONID}/isVisionLine`]&&r.metadata[`${h.EXTENSIONID}/disabled`]?(delete r.metadata[`${h.EXTENSIONID}/disabled`],delete r.metadata[`${h.EXTENSIONID}/doorOpen`]):r.metadata[`${h.EXTENSIONID}/isVisionLine`]&&(r.metadata[`${h.EXTENSIONID}/disabled`]=!0,r.metadata[`${h.EXTENSIONID}/doorOpen`]=!0)}),await $.player.deselect([i])}}async function Wr(){const i=await $.scene.items.getItems(e=>e.metadata[`${h.EXTENSIONID}/isDoor`]===!0);await zt(i)}function Mi(i){return i?h.DOOROPEN:h.DOORCLOSED}function Gr(i,e){return je.pointInPolygon(i[0],e)||je.pointInPolygon(i[0],e)?!0:Xt(i,[e[0],e[1]])||Xt(i,[e[1],e[2]])||Xt(i,[e[2],e[3]])||Xt(i,[e[3],e[0]])}function Xt(i,e){const t=(i[1].x-i[0].x)*(e[1].y-e[0].y)-(e[1].x-e[0].x)*(i[1].y-i[0].y),n=((e[1].y-e[0].y)*(e[1].x-i[0].x)+(e[0].x-e[1].x)*(e[1].y-i[0].y))/t,o=((i[0].y-i[1].y)*(e[1].x-i[0].x)+(i[1].x-i[0].x)*(e[1].y-i[0].y))/t;return n>=0&&n<=1&&o>=0&&o<=1}function Ut(i,e,t){return{x:i.x+e*Math.cos(t),y:i.y+e*Math.sin(t)}}function qr(i,e,t,n){const o=Math.atan2(i.y-t.y,i.x-t.x);let r=Ut(i,e,o+Math.PI/2),l=Ut(i,e,o-Math.PI/2),u=Ut(t,n,o+Math.PI/2),m=Ut(t,n,o-Math.PI/2);const y=je.normalize(je.subtract(i,t));return r=je.add(r,je.multiply(y,e)),l=je.add(l,je.multiply(y,e)),u=je.add(u,je.multiply(y,0-n)),m=je.add(m,je.multiply(y,0-n)),[r,l,m,u]}function zr(i){return i.filter(e=>e.points&&e.points.length>1).flatMap(e=>{const t=Ve.fromItem(e);return e.points.slice(0,-1).map((n,o)=>{const r=Ve.fromPosition(e.points[o]),l=Ve.fromPosition(e.points[o+1]),u=Ve.decompose(Ve.multiply(t,r)).position,m=Ve.decompose(Ve.multiply(t,l)).position;return{startPosition:u,endPosition:m,originalShape:e,oneSided:e.metadata[`${h.EXTENSIONID}/oneSided`]}})})}function Kr(i,e,t,n,o,r){let l=[],u=[t,n];S.players.filter(A=>A.role==="GM");const m=[{x:(t+o[0])*r[0],y:o[1]*r[1]},{x:(t+o[0])*r[0],y:(n+o[1])*r[1]},{x:o[0]*r[0],y:(n+o[1])*r[1]},{x:o[0]*r[0],y:o[1]*r[1]}],y=S.gridDpi,N=h.EXTENSIONID,C=e.some(vt);if(e.length===0)return l;for(const A of e){const B=S.userId===A.createdUserId,Y=S.metadata[`${h.EXTENSIONID}/USER-${A.createdUserId}`]?.role==="GM";if(!B&&S.role!=="GM"&&!Y)continue;const x=A.metadata[`${N}/visionRange`],I=wt.getValue(A.id);if(l.push([]),I!==void 0&&Li(I.player.position,A.position)&&I.player.metadata[`${N}/visionRange`]===x)continue;let g=y*1e3;x&&(g=y*(x/S.gridScale+.5));const E=[];if(C&&!vt(A)){for(const p of e)if(vt(p)){const _=p.metadata[`${h.EXTENSIONID}/visionRange`];let L=1e3*S.gridDpi;_&&(L=S.gridDpi*(_/S.gridScale+.5));const ie=qr(A.position,g,p.position,L);E.push(ie)}}for(const p of i){const _=(A.position.x-p.startPosition.x)*(p.endPosition.y-p.startPosition.y)-(A.position.y-p.startPosition.y)*(p.endPosition.x-p.startPosition.x);if(p.oneSided!==void 0&&(p.oneSided==="right"&&_>0||p.oneSided==="left"&&_<0))continue;let L=p.startPosition.x,ie=p.startPosition.y,ae=p.endPosition.x,oe=p.endPosition.y;if(L<o[0]||ie<o[1]||L>o[0]+u[0]||ie>o[1]+u[1]||ae<o[0]||oe<o[1]||ae>o[0]+u[0]||oe>o[1]+u[1])continue;const Q=[p.startPosition,p.endPosition],he=je.distance(p.startPosition,p.endPosition),me=Math.floor(he/(g/3));for(let f=1;f<me;f++)Q.push(je.lerp(p.startPosition,p.endPosition,f/me));let le=!0;for(const f of Q)if(je.compare(A.position,f,g*1.05)){le=!1;break}if(le&&C&&!vt(A)){for(const f of E)if(Gr([p.startPosition,p.endPosition],f)){le=!1;break}}if(le)continue;const ve={x:p.startPosition.x-A.position.x,y:p.startPosition.y-A.position.y},Le={x:p.endPosition.x-A.position.x,y:p.endPosition.y-A.position.y};var k={x:0,y:0},X={x:0,y:0},b=0,P=0,O=0,M=0;//! This is probably not required if we later compute the intersection
//! (using PathKit) of these polygons with a base rectangle the size of
//! our background image
ve.x<0?b=o[0]*r[0]:b=(t+o[0])*r[0],ve.y<0?P=o[1]*r[1]:P=(n+o[1])*r[1],Le.x<0?O=o[0]*r[0]:O=(t+o[0])*r[0],Le.y<0?M=o[1]*r[1]:M=(n+o[1])*r[1];const ge=[],_e=[];if(ve.x!=0){const f=ve.y/ve.x,w=p.startPosition.y-f*p.startPosition.x;ge.push({x:b,y:f*b+w})}if(ve.y!=0){const f=ve.x/ve.y,w=f*p.startPosition.y-p.startPosition.x;ge.push({x:f*P-w,y:P})}if(Le.x!=0){const f=Le.y/Le.x,w=p.endPosition.y-f*p.endPosition.x;_e.push({x:O,y:f*O+w})}if(Le.y!=0){const f=Le.x/Le.y,w=f*p.endPosition.y-p.endPosition.x;_e.push({x:f*M-w,y:M})}if(ge.length===0||_e.length===0)continue;ge.length==1||Bt(ge[0],p.startPosition)<Bt(ge[1],p.startPosition)?k=ge[0]:k=ge[1],_e.length==1||Bt(_e[0],p.endPosition)<Bt(_e[1],p.endPosition)?X=_e[0]:X=_e[1];const He=[{x:p.startPosition.x,y:p.startPosition.y},k,X,{x:p.endPosition.x,y:p.endPosition.y}],Xe=[0,0];let Re=0;for(const f of[k,X])Ft(f.y,o[1]*r[1])?Xe[Re]=0:Ft(f.y,(n+o[1])*r[1])?Xe[Re]=2:Ft(f.x,o[0]*r[0])?Xe[Re]=3:Ft(f.x,(t+o[0])*r[0])&&(Xe[Re]=1),Re++;let K=Math.sign(_);K=K==0?1:-K;const c=K==1?Xe[1]:En(Xe[1]-1,4);for(let f=Xe[0]+(K==1?0:-1);En(f,4)!=c;f+=K)He.splice(He.length-2,0,m[En(f,4)]);l[l.length-1].push({pointset:He,fromShape:p.originalShape})}}return l}const wt=new Vr(!1);var we,ft=!1;async function Yr(i){if(await $.action.setBadgeText("Working.."),await $.player.setMetadata({[`${h.EXTENSIONID}/processed`]:!1}),ft=!0,we||(we=await Fr({locateFile:()=>Xr})),!await $.scene.isReady()){wt.invalidate((c,f)=>f.shadowPath.delete()),ft=!1,await $.action.setBadgeText(void 0);return}const e=[];for(let c=0;c<=6;c++)e.push(new An);e[1].start();const{awaitTimer:t,computeTimer:n,visionShapes:o,tokensWithVision:r,invalidateCache:l}=i;let u=i.size,m=i.offset,y=i.scale,[N,C]=u;if(S.metadata[`${h.EXTENSIONID}/autodetectEnabled`]===!0){const c=await $.scene.items.getItems(w=>w.layer==="MAP"&&tn(w));let f=[];for(let w of c){let H=S.gridDpi/w.grid.dpi,F=w.position.x-H*w.grid.offset.x*w.scale.x,q=w.position.y-H*w.grid.offset.y*w.scale.y,te=F+H*w.image.width*w.scale.x,ce=q+H*w.image.height*w.scale.y;if(w.rotation>0){const se=Math.abs(te-F),De=Math.abs(ce-q);switch(w.rotation){case 270:q-=De,ce-=De;break;case 180:q-=De,ce-=De,F-=se,te-=se;break;case 90:F-=se,te-=se;break}}f.length?(F<f[0]&&(f[0]=F),q<f[1]&&(f[1]=q),te>f[2]&&(f[2]=te),ce>f[3]&&(f[3]=ce)):(f[0]=F,f[1]=q,f[2]=te,f[3]=ce)}m=[f[0],f[1]],u=[f[2]-f[0],f[3]-f[1]],y=[1,1],[N,C]=u}let X=0,b=0;if(l&&wt.invalidate((c,f)=>f.shadowPath.delete()),n.resume(),!(S.metadata[`${h.EXTENSIONID}/visionEnabled`]===!0)||r.length==0){const c=await $.scene.local.getItems(Cn);await $.scene.local.deleteItems(c.map(f=>f.id)),ft=!1,await $.action.setBadgeText(void 0);return}const O=zr(o),M=Kr(O,r,N,C,m,y);if(M.length==0){ft=!1,await $.action.setBadgeText(void 0);return}const A=[];e[1].pause(),e[2].start();const B={};for(let c=0;c<M.length;c++){const f=r[c];let w=wt.getValue(f.id);if(w!==void 0&&Li(w.player.position,f.position)&&w.player.metadata[`${h.EXTENSIONID}/visionRange`]===f.metadata[`${h.EXTENSIONID}/visionRange`]){B[c]=w.shadowPath.copy(),X++;continue}b++;const H=M[c],F=new we.SkOpBuilder,q=we.NewPath().rect(m[0],m[1],u[0],u[1]);F.add(q,we.PathOp.UNION),q.delete();for(const ce of H){const se=ce.fromShape,De=[];De.push([we.MOVE_VERB,ce.pointset[0].x,ce.pointset[0].y]);for(let Ce=1;Ce<ce.pointset.length;Ce++)De.push([we.LINE_VERB,ce.pointset[Ce].x,ce.pointset[Ce].y]);const Me=we.FromCmds(De);if(se.style.closed!=!1){const Ce=[];Ce.push([we.MOVE_VERB,se.points[0].x*se.scale.x+se.position.x,se.points[0].y*se.scale.y+se.position.y]);for(let de=1;de<se.points.length-1;de++)Ce.push([we.LINE_VERB,se.points[de].x*se.scale.x+se.position.x,se.points[de].y*se.scale.y+se.position.y]);const xe=we.FromCmds(Ce);Me.op(xe,we.PathOp.DIFFERENCE),xe.delete()}F.add(Me,we.PathOp.DIFFERENCE),Me.delete()}const te=F.resolve();if(!te){console.error("Couldn't compute fog"),ft=!1,await $.action.setBadgeText(void 0);return}if(F.delete(),te!==void 0){te.simplify(),B[c]=te;let ce=wt.getValue(f.id);ce!==void 0&&ce.shadowPath.delete(),wt.cacheValue(f.id,{shadowPath:te.copy(),player:f})}}e[2].pause(),e[3].start();const U=[],Y=we.NewPath();for(let c=0;c<r.length;c++){const f=r[c],w=f.metadata[`${h.EXTENSIONID}/visionRange`],H=S.userId===r[c].createdUserId,q=S.metadata[`${h.EXTENSIONID}/USER-${r[c].createdUserId}`]?.role==="GM";if(vt(f)?U[c]=!0:Y.op(B[c],we.PathOp.UNION),w){if(!H&&S.role!=="GM"&&!q)continue;const te=S.gridDpi*(w/S.gridScale+.5),ce=we.NewPath().ellipse(f.position.x,f.position.y,te,te,0,0,2*Math.PI);B[c]?.op(ce,we.PathOp.INTERSECT),ce.delete();const se=S.metadata[`${h.EXTENSIONID}/USER-${f.createdUserId}`];if(se&&S.role==="GM"&&!vt(f)&&se.role!=="GM"){const De=xi().strokeColor(se.color).fillOpacity(0).position({x:f.position.x,y:f.position.y}).width(te*2).height(te*2).shapeType("CIRCLE").metadata({[`${h.EXTENSIONID}/isIndicatorRing`]:!0}).locked(!0).build();A.push(De)}}}Y.simplify();for(let c=0;c<U.length;c++)U[c]===!0&&(B[c].op(Y,we.PathOp.INTERSECT),B[c].simplify());Y.delete(),e[3].pause(),e[4].start();const x=[],I=[],g=S.metadata[`${h.EXTENSIONID}/persistenceEnabled`]===!0,E=S.metadata[`${h.EXTENSIONID}/fowEnabled`]===!0,p=S.metadata[`${h.EXTENSIONID}/playerDoors`]===!0,_=we.NewPath(),L={},ie=await $.scene.local.getItems(Cn),ae=await $.scene.local.getItems(Cr);E&&_.rect(m[0],m[1],u[0],u[1]);let oe=[],Q,he=null;if(g)if(oe=ie.filter(c=>Et(c)),Q=new we.SkOpBuilder,L.reuse=!0,oe.length===0){const c=St().commands([]).fillRule("evenodd").locked(!0).visible(!1).fillColor("#000000").strokeColor("#000000").layer("FOG").name("Fog of War").metadata({[`${h.EXTENSIONID}/isVisionFog`]:!0,[`${h.EXTENSIONID}/digest`]:"reuse"}).build();c.zIndex=3,await $.scene.local.addItems([c]),oe=await $.scene.local.getItems(Et)}else he=we.FromCmds(oe[0].commands),he.setFillType(we.FillType.EVENODD);const be=new we.SkOpBuilder;let me=!1;for(const c of Object.keys(B)){const f=B[c],H=new TextEncoder().encode(f.toCmds().toString()),F=await crypto.subtle.digest("SHA-1",H).then(te=>[...new Uint8Array(te)].map(ce=>ce.toString(16).padStart(2,"0")).join(""));ie.filter(te=>Et(te)&&te.metadata[`${h.EXTENSIONID}/digest`]===F).length===0?g?Q.add(f,we.PathOp.UNION):x.push({cmds:f.toCmds(),visible:!1,zIndex:3,playerId:r[c].id,digest:F}):L[F]=!0,E&&(_.op(f,we.PathOp.DIFFERENCE),S.role==="GM"&&(me=!0,be.add(f,we.PathOp.UNION))),f.delete()}const le=S.metadata[`${h.EXTENSIONID}/sceneId`];if(g){const c=Q.resolve();c.setFillType(we.FillType.EVENODD),he!==null&&c.op(he,we.PathOp.UNION);const f=c.toCmds();oe.length>0&&await $.scene.local.updateItems([oe[0].id],w=>{w.length>0&&(w[0].commands=f)});try{localStorage.setItem(`${h.EXTENSIONID}/fogCache/${S.userId}/${le}`,JSON.stringify([{digest:"reuse",commands:f}]))}catch{}he!==null&&he.delete(),c.delete(),Q.delete()}else if(g){const c=ie.filter(Et);try{localStorage.setItem(`${h.EXTENSIONID}/fogCache/${S.userId}/${le}`,JSON.stringify(c.map(f=>({digest:f.metadata[`${h.EXTENSIONID}/digest`],commands:f.commands}))))}catch{}}let ve;me&&(ve=be.resolve()),be.delete();const Le=ie.filter(Ht),ge=ie.filter(c=>{const f=c.metadata[`${h.EXTENSIONID}/digest`];return Et(c)&&L[f]===void 0});if(E){let c=S.metadata[`${h.EXTENSIONID}/fowColor`]?S.metadata[`${h.EXTENSIONID}/fowColor`]:"#00000088",f=.5;c.length==9&&(f=Number.parseInt(c.substring(7),16)/255,c=c.substring(0,7));const w=St().commands(_.toCmds()).locked(!0).fillRule("evenodd").visible(!0).fillColor(c).fillOpacity(f).strokeWidth(0).strokeColor("#000000").layer("DRAWING").metadata({[`${h.EXTENSIONID}/isTrailingFog`]:!0}).name("Trailing Fog").build();w.disableHit=!0,Le.length>0?await $.scene.local.updateItems(Ht,H=>{for(const F of H)F.commands=w.commands},!1):I.push($.scene.local.addItems([w]))}else I.push($.scene.local.deleteItems(ie.filter(Ht).map(c=>c.id)));_.delete(),e[4].pause(),e[5].start();const _e=await $.scene.local.getItems(c=>c.metadata[`${h.EXTENSIONID}/doorId`]!==void 0);p||S.role=="GM"?await Wr():_e.length>0&&await $.scene.local.deleteItems(_e.map(c=>c.id));for(const c of _e){const f=c.metadata[`${h.EXTENSIONID}/doorId`],w=S.items.find(H=>H.id===f);if(w){const F=c.commands.length==h.DOOROPEN.length,q=!!w.metadata[`${h.EXTENSIONID}/doorOpen`];if(F===q)continue;I.push($.scene.local.updateItems([c.id],te=>{const ce=te[0];Nr(ce)&&(ce.commands=Mi(q))}))}}n.pause(),t.resume(),I.push($.scene.local.deleteItems(ae.map(c=>c.id))),I.push($.scene.local.addItems(x.map(c=>{const f=St().commands(c.cmds).fillRule("evenodd").locked(!0).visible(c.visible).fillColor("#000000").strokeColor("#000000").layer("FOG").name("Fog of War").metadata({[`${h.EXTENSIONID}/isVisionFog`]:!0,[`${h.EXTENSIONID}/digest`]:c.digest}).build();return f.zIndex=c.zIndex,f}))),g||I.push($.scene.local.deleteItems(ge.map(c=>c.id))),A.length>0&&I.push($.scene.local.addItems(A)),S.fog.filled||I.push($.scene.fog.setFilled(!0)),await Promise.all(I);let He=0;e[5].pause(),e[6].start(),me&&(await Zr(ve),ve.delete()),e[6].pause();const[Xe,Re]=[t.stop(),n.stop()],K={compute_time:`${Re} ms`,communication_time:`${Xe} ms`,cache_hits:X.toString(),cache_misses:b.toString(),item_counter:He.toString()};for(let c=1;c<=6;c++){const f=e[c].stop();K["stage"+c]=`${f} ms`}Qr(K),ft=!1,await $.player.setMetadata({[`${h.EXTENSIONID}/processed`]:!0}),await $.action.setBadgeText(void 0)}async function Zr(i){const e=[],t=S.items.filter(n=>Ai(n)&&tn(n));i.simplify();for(const n of t){const o=new we.SkOpBuilder,r=we.NewPath(),l=S.gridDpi/n.grid.dpi*(n.image.width/2)*n.scale.x;for(let y=0;y<6;y++){const N=y*60*Math.PI/180,C=n.position.x+l*Math.cos(N),k=n.position.y+l*Math.sin(N);y==0?r.moveTo(C,k):r.lineTo(C,k)}r.closePath(),o.add(r,we.PathOp.UNION),o.add(i,we.PathOp.INTERSECT);const u=o.resolve(),m=!u.toCmds().length;n.visible==m&&e.push(n),r.delete(),o.delete(),u.delete()}await $.scene.items.updateItems(e.map(n=>n.id),n=>{for(let o=0;o<n.length;o++)n[o].visible=!n[o].visible})}let wn,Jr,si,xt=[],li,bn,ci,ui,di,fi;async function yt(i){if(ft||!S.ready||!S.initialized)return;const[e,t]=[new An,new An];e.start(),e.pause(),t.start();const n=[],o=S.items.filter(g=>g.layer=="CHARACTER"||g.layer=="ATTACHMENT");for(const g of o)(g.metadata[`${h.EXTENSIONID}/hasVision`]||g.metadata[`${h.ARMINDOID}/hasVision`])&&!g.metadata[`${h.EXTENSIONID}/visionBlind`]&&S.metadata[`${h.EXTENSIONID}/USER-${g.createdUserId}`]?.role==="GM"&&n.push(g);const l=(S.role=="GM"?S.items.filter($r):S.items.filter(Pr).concat(n)).filter(g=>!vt(g)||g.visible===!0),u=S.items.filter(Ar),m=S.items.filter(Ai),y=S.items.filter(Ci)?.[0],N=S.metadata[`${h.EXTENSIONID}/visionEnabled`]===!0,C=S.metadata[`${h.EXTENSIONID}/persistenceEnabled`]===!0,k=S.metadata[`${h.EXTENSIONID}/autodetectEnabled`]===!0,X=S.metadata[`${h.EXTENSIONID}/fowEnabled`]===!0,b=S.metadata[`${h.EXTENSIONID}/fowColor`],P=[],O=[],M=[];if(y===void 0?(P[0]=0,P[1]=0,O[0]=1,O[1]=1,M[0]=0,M[1]=0):(P[0]=y.width*y.scale.x,P[1]=y.height*y.scale.y,O[0]=y.scale.x,O[1]=y.scale.y,M[0]=y.position.x,M[1]=y.position.y),S.role=="GM"){const g=document.getElementById("mapHeight"),E=document.getElementById("mapWidth");E&&(E.value=(Math.round(P[0])/S.gridDpi).toString()),g&&(g.value=(Math.round(P[1])/S.gridDpi).toString())}const A=JSON.stringify(u),B=JSON.stringify(m),U=JSON.stringify(l),Y=JSON.stringify(y);if(Y==bn&&N==li&&fi==b&&ci==k&&ui==X&&di==C&&wn==A&&Jr==B&&si==U&&P[0]==xt[0]&&P[1]==xt[1]&&i!==!0)return;let x=!1;(Y!=bn||wn!=A||P[0]!=xt[0]||P[1]!=xt[1])&&(x=!0),bn=Y,si=U,wn=A,xt=P,li=N,ci=k,ui=X,fi=b,di=C,t.pause();const I={awaitTimer:e,computeTimer:t,allItems:S.items,size:P,offset:M,scale:O,tokensWithVision:l,visionShapes:u,invalidateCache:x};ft||await Yr(I)}function Qr(i){for(const[e,t]of Object.entries(i)){const n=document.getElementById(e);e=="compute_time"||e=="communication_time"||e[0]=="s"?n&&(n.innerText=Number.parseFloat(t).toFixed(1)+"ms"):n&&(n.innerText=t)}}function Sn(i,e){i.split(/\s+/).forEach(t=>{e(t)})}class eo{constructor(){this._events=void 0,this._events={}}on(e,t){Sn(e,n=>{const o=this._events[n]||[];o.push(t),this._events[n]=o})}off(e,t){var n=arguments.length;if(n===0){this._events={};return}Sn(e,o=>{if(n===1){delete this._events[o];return}const r=this._events[o];r!==void 0&&(r.splice(r.indexOf(t),1),this._events[o]=r)})}trigger(e,...t){var n=this;Sn(e,o=>{const r=n._events[o];r!==void 0&&r.forEach(l=>{l.apply(n,t)})})}}function to(i){return i.plugins={},class extends i{constructor(...e){super(...e),this.plugins={names:[],settings:{},requested:{},loaded:{}}}static define(e,t){i.plugins[e]={name:e,fn:t}}initializePlugins(e){var t,n;const o=this,r=[];if(Array.isArray(e))e.forEach(l=>{typeof l=="string"?r.push(l):(o.plugins.settings[l.name]=l.options,r.push(l.name))});else if(e)for(t in e)e.hasOwnProperty(t)&&(o.plugins.settings[t]=e[t],r.push(t));for(;n=r.shift();)o.require(n)}loadPlugin(e){var t=this,n=t.plugins,o=i.plugins[e];if(!i.plugins.hasOwnProperty(e))throw new Error('Unable to find "'+e+'" plugin');n.requested[e]=!0,n.loaded[e]=o.fn.apply(t,[t.plugins.settings[e]||{}]),n.names.push(e)}require(e){var t=this,n=t.plugins;if(!t.plugins.loaded.hasOwnProperty(e)){if(n.requested[e])throw new Error('Plugin has circular dependency ("'+e+'")');t.loadPlugin(e)}return n.loaded[e]}}}/*! @orchidjs/unicode-variants | https://github.com/orchidjs/unicode-variants | Apache License (v2) */const nn=i=>(i=i.filter(Boolean),i.length<2?i[0]||"":io(i)==1?"["+i.join("")+"]":"(?:"+i.join("|")+")"),Ri=i=>{if(!no(i))return i.join("");let e="",t=0;const n=()=>{t>1&&(e+="{"+t+"}")};return i.forEach((o,r)=>{if(o===i[r-1]){t++;return}n(),e+=o,t=1}),n(),e},Bi=i=>{let e=Fn(i);return nn(e)},no=i=>new Set(i).size!==i.length,Dt=i=>(i+"").replace(/([\$\(\)\*\+\.\?\[\]\^\{\|\}\\])/gu,"\\$1"),io=i=>i.reduce((e,t)=>Math.max(e,ro(t)),0),ro=i=>Fn(i).length,Fn=i=>Array.from(i);/*! @orchidjs/unicode-variants | https://github.com/orchidjs/unicode-variants | Apache License (v2) */const Fi=i=>{if(i.length===1)return[[i]];let e=[];const t=i.substring(1);return Fi(t).forEach(function(o){let r=o.slice(0);r[0]=i.charAt(0)+r[0],e.push(r),r=o.slice(0),r.unshift(i.charAt(0)),e.push(r)}),e};/*! @orchidjs/unicode-variants | https://github.com/orchidjs/unicode-variants | Apache License (v2) */const oo=[[0,65535]],ao="[̀-ͯ·ʾʼ]";let Kt,Xi;const so=3,Xn={},pi={"/":"⁄∕",0:"߀",a:"ⱥɐɑ",aa:"ꜳ",ae:"æǽǣ",ao:"ꜵ",au:"ꜷ",av:"ꜹꜻ",ay:"ꜽ",b:"ƀɓƃ",c:"ꜿƈȼↄ",d:"đɗɖᴅƌꮷԁɦ",e:"ɛǝᴇɇ",f:"ꝼƒ",g:"ǥɠꞡᵹꝿɢ",h:"ħⱨⱶɥ",i:"ɨı",j:"ɉȷ",k:"ƙⱪꝁꝃꝅꞣ",l:"łƚɫⱡꝉꝇꞁɭ",m:"ɱɯϻ",n:"ꞥƞɲꞑᴎлԉ",o:"øǿɔɵꝋꝍᴑ",oe:"œ",oi:"ƣ",oo:"ꝏ",ou:"ȣ",p:"ƥᵽꝑꝓꝕρ",q:"ꝗꝙɋ",r:"ɍɽꝛꞧꞃ",s:"ßȿꞩꞅʂ",t:"ŧƭʈⱦꞇ",th:"þ",tz:"ꜩ",u:"ʉ",v:"ʋꝟʌ",vy:"ꝡ",w:"ⱳ",y:"ƴɏỿ",z:"ƶȥɀⱬꝣ",hv:"ƕ"};for(let i in pi){let e=pi[i]||"";for(let t=0;t<e.length;t++){let n=e.substring(t,t+1);Xn[n]=i}}const lo=new RegExp(Object.keys(Xn).join("|")+"|"+ao,"gu"),co=i=>{Kt===void 0&&(Kt=ho(i||oo))},hi=(i,e="NFKD")=>i.normalize(e),Yt=i=>Fn(i).reduce((e,t)=>e+uo(t),""),uo=i=>(i=hi(i).toLowerCase().replace(lo,e=>Xn[e]||""),hi(i,"NFC"));function*fo(i){for(const[e,t]of i)for(let n=e;n<=t;n++){let o=String.fromCharCode(n),r=Yt(o);r!=o.toLowerCase()&&(r.length>so||r.length!=0&&(yield{folded:r,composed:o,code_point:n}))}}const po=i=>{const e={},t=(n,o)=>{const r=e[n]||new Set,l=new RegExp("^"+Bi(r)+"$","iu");o.match(l)||(r.add(Dt(o)),e[n]=r)};for(let n of fo(i))t(n.folded,n.folded),t(n.folded,n.composed);return e},ho=i=>{const e=po(i),t={};let n=[];for(let r in e){let l=e[r];l&&(t[r]=Bi(l)),r.length>1&&n.push(Dt(r))}n.sort((r,l)=>l.length-r.length);const o=nn(n);return Xi=new RegExp("^"+o,"u"),t},mo=(i,e=1)=>{let t=0;return i=i.map(n=>(Kt[n]&&(t+=n.length),Kt[n]||n)),t>=e?Ri(i):""},go=(i,e=1)=>(e=Math.max(e,i.length-1),nn(Fi(i).map(t=>mo(t,e)))),mi=(i,e=!0)=>{let t=i.length>1?1:0;return nn(i.map(n=>{let o=[];const r=e?n.length():n.length()-1;for(let l=0;l<r;l++)o.push(go(n.substrs[l]||"",t));return Ri(o)}))},yo=(i,e)=>{for(const t of e){if(t.start!=i.start||t.end!=i.end||t.substrs.join("")!==i.substrs.join(""))continue;let n=i.parts;const o=l=>{for(const u of n){if(u.start===l.start&&u.substr===l.substr)return!1;if(!(l.length==1||u.length==1)&&(l.start<u.start&&l.end>u.start||u.start<l.start&&u.end>l.start))return!0}return!1};if(!(t.parts.filter(o).length>0))return!0}return!1};class Zt{constructor(){this.parts=[],this.substrs=[],this.start=0,this.end=0}add(e){e&&(this.parts.push(e),this.substrs.push(e.substr),this.start=Math.min(e.start,this.start),this.end=Math.max(e.end,this.end))}last(){return this.parts[this.parts.length-1]}length(){return this.parts.length}clone(e,t){let n=new Zt,o=JSON.parse(JSON.stringify(this.parts)),r=o.pop();for(const m of o)n.add(m);let l=t.substr.substring(0,e-r.start),u=l.length;return n.add({start:r.start,end:r.start+u,length:u,substr:l}),n}}const vo=i=>{co(),i=Yt(i);let e="",t=[new Zt];for(let n=0;n<i.length;n++){let r=i.substring(n).match(Xi);const l=i.substring(n,n+1),u=r?r[0]:null;let m=[],y=new Set;for(const N of t){const C=N.last();if(!C||C.length==1||C.end<=n)if(u){const k=u.length;N.add({start:n,end:n+k,length:k,substr:u}),y.add("1")}else N.add({start:n,end:n+1,length:1,substr:l}),y.add("2");else if(u){let k=N.clone(n,C);const X=u.length;k.add({start:n,end:n+X,length:X,substr:u}),m.push(k)}else y.add("3")}if(m.length>0){m=m.sort((N,C)=>N.length()-C.length());for(let N of m)yo(N,t)||t.push(N);continue}if(n>0&&y.size==1&&!y.has("3")){e+=mi(t,!1);let N=new Zt;const C=t[0];C&&N.add(C.last()),t=[N]}}return e+=mi(t,!0),e};/*! sifter.js | https://github.com/orchidjs/sifter.js | Apache License (v2) */const Io=(i,e)=>{if(i)return i[e]},Eo=(i,e)=>{if(i){for(var t,n=e.split(".");(t=n.shift())&&(i=i[t]););return i}},Tn=(i,e,t)=>{var n,o;return!i||(i=i+"",e.regex==null)||(o=i.search(e.regex),o===-1)?0:(n=e.string.length/i.length,o===0&&(n+=.5),n*t)},Nn=(i,e)=>{var t=i[e];if(typeof t=="function")return t;t&&!Array.isArray(t)&&(i[e]=[t])},Ke=(i,e)=>{if(Array.isArray(i))i.forEach(e);else for(var t in i)i.hasOwnProperty(t)&&e(i[t],t)},wo=(i,e)=>typeof i=="number"&&typeof e=="number"?i>e?1:i<e?-1:0:(i=Yt(i+"").toLowerCase(),e=Yt(e+"").toLowerCase(),i>e?1:e>i?-1:0);/*! sifter.js | https://github.com/orchidjs/sifter.js | Apache License (v2) */class bo{constructor(e,t){this.items=void 0,this.settings=void 0,this.items=e,this.settings=t||{diacritics:!0}}tokenize(e,t,n){if(!e||!e.length)return[];const o=[],r=e.split(/\s+/);var l;return n&&(l=new RegExp("^("+Object.keys(n).map(Dt).join("|")+"):(.*)$")),r.forEach(u=>{let m,y=null,N=null;l&&(m=u.match(l))&&(y=m[1],u=m[2]),u.length>0&&(this.settings.diacritics?N=vo(u)||null:N=Dt(u),N&&t&&(N="\\b"+N)),o.push({string:u,regex:N?new RegExp(N,"iu"):null,field:y})}),o}getScoreFunction(e,t){var n=this.prepareSearch(e,t);return this._getScoreFunction(n)}_getScoreFunction(e){const t=e.tokens,n=t.length;if(!n)return function(){return 0};const o=e.options.fields,r=e.weights,l=o.length,u=e.getAttrFn;if(!l)return function(){return 1};const m=function(){return l===1?function(y,N){const C=o[0].field;return Tn(u(N,C),y,r[C]||1)}:function(y,N){var C=0;if(y.field){const k=u(N,y.field);!y.regex&&k?C+=1/l:C+=Tn(k,y,1)}else Ke(r,(k,X)=>{C+=Tn(u(N,X),y,k)});return C/l}}();return n===1?function(y){return m(t[0],y)}:e.options.conjunction==="and"?function(y){var N,C=0;for(let k of t){if(N=m(k,y),N<=0)return 0;C+=N}return C/n}:function(y){var N=0;return Ke(t,C=>{N+=m(C,y)}),N/n}}getSortFunction(e,t){var n=this.prepareSearch(e,t);return this._getSortFunction(n)}_getSortFunction(e){var t,n=[];const o=this,r=e.options,l=!e.query&&r.sort_empty?r.sort_empty:r.sort;if(typeof l=="function")return l.bind(this);const u=function(N,C){return N==="$score"?C.score:e.getAttrFn(o.items[C.id],N)};if(l)for(let y of l)(e.query||y.field!=="$score")&&n.push(y);if(e.query){t=!0;for(let y of n)if(y.field==="$score"){t=!1;break}t&&n.unshift({field:"$score",direction:"desc"})}else n=n.filter(y=>y.field!=="$score");return n.length?function(y,N){var C,k;for(let X of n)if(k=X.field,C=(X.direction==="desc"?-1:1)*wo(u(k,y),u(k,N)),C)return C;return 0}:null}prepareSearch(e,t){const n={};var o=Object.assign({},t);if(Nn(o,"sort"),Nn(o,"sort_empty"),o.fields){Nn(o,"fields");const r=[];o.fields.forEach(l=>{typeof l=="string"&&(l={field:l,weight:1}),r.push(l),n[l.field]="weight"in l?l.weight:1}),o.fields=r}return{options:o,query:e.toLowerCase().trim(),tokens:this.tokenize(e,o.respect_word_boundaries,n),total:0,items:[],weights:n,getAttrFn:o.nesting?Eo:Io}}search(e,t){var n=this,o,r;r=this.prepareSearch(e,t),t=r.options,e=r.query;const l=t.score||n._getScoreFunction(r);e.length?Ke(n.items,(m,y)=>{o=l(m),(t.filter===!1||o>0)&&r.items.push({score:o,id:y})}):Ke(n.items,(m,y)=>{r.items.push({score:1,id:y})});const u=n._getSortFunction(r);return u&&r.items.sort(u),r.total=r.items.length,typeof t.limit=="number"&&(r.items=r.items.slice(0,t.limit)),r}}const bt=(i,e)=>{if(Array.isArray(i))i.forEach(e);else for(var t in i)i.hasOwnProperty(t)&&e(i[t],t)},Ue=i=>{if(i.jquery)return i[0];if(i instanceof HTMLElement)return i;if(Ui(i)){var e=document.createElement("template");return e.innerHTML=i.trim(),e.content.firstChild}return document.querySelector(i)},Ui=i=>typeof i=="string"&&i.indexOf("<")>-1,So=i=>i.replace(/['"\\]/g,"\\$&"),_n=(i,e)=>{var t=document.createEvent("HTMLEvents");t.initEvent(e,!0,!1),i.dispatchEvent(t)},Vt=(i,e)=>{Object.assign(i.style,e)},ze=(i,...e)=>{var t=Vi(e);i=ji(i),i.map(n=>{t.map(o=>{n.classList.add(o)})})},lt=(i,...e)=>{var t=Vi(e);i=ji(i),i.map(n=>{t.map(o=>{n.classList.remove(o)})})},Vi=i=>{var e=[];return bt(i,t=>{typeof t=="string"&&(t=t.trim().split(/[\11\12\14\15\40]/)),Array.isArray(t)&&(e=e.concat(t))}),e.filter(Boolean)},ji=i=>(Array.isArray(i)||(i=[i]),i),Wt=(i,e,t)=>{if(!(t&&!t.contains(i)))for(;i&&i.matches;){if(i.matches(e))return i;i=i.parentNode}},gi=(i,e=0)=>e>0?i[i.length-1]:i[0],To=i=>Object.keys(i).length===0,Jt=(i,e)=>{if(!i)return-1;e=e||i.nodeName;for(var t=0;i=i.previousElementSibling;)i.matches(e)&&t++;return t},Pe=(i,e)=>{bt(e,(t,n)=>{t==null?i.removeAttribute(n):i.setAttribute(n,""+t)})},$n=(i,e)=>{i.parentNode&&i.parentNode.replaceChild(e,i)},No=(i,e)=>{if(e===null)return;if(typeof e=="string"){if(!e.length)return;e=new RegExp(e,"i")}const t=r=>{var l=r.data.match(e);if(l&&r.data.length>0){var u=document.createElement("span");u.className="highlight";var m=r.splitText(l.index);m.splitText(l[0].length);var y=m.cloneNode(!0);return u.appendChild(y),$n(m,u),1}return 0},n=r=>{r.nodeType===1&&r.childNodes&&!/(script|style)/i.test(r.tagName)&&(r.className!=="highlight"||r.tagName!=="SPAN")&&Array.from(r.childNodes).forEach(l=>{o(l)})},o=r=>r.nodeType===3?t(r):(n(r),0);o(i)},_o=i=>{var e=i.querySelectorAll("span.highlight");Array.prototype.forEach.call(e,function(t){var n=t.parentNode;n.replaceChild(t.firstChild,t),n.normalize()})},Oo=65,ko=13,Hi=27,Pn=37,xo=38,Wi=39,Do=40,yi=8,Co=46,Ln=9,Ao=typeof navigator>"u"?!1:/Mac/.test(navigator.userAgent),jt=Ao?"metaKey":"ctrlKey";var vi={options:[],optgroups:[],plugins:[],delimiter:",",splitOn:null,persist:!0,diacritics:!0,create:null,createOnBlur:!1,createFilter:null,highlight:!0,openOnFocus:!0,shouldOpen:null,maxOptions:50,maxItems:null,hideSelected:null,duplicates:!1,addPrecedence:!1,selectOnTab:!1,preload:null,allowEmptyOption:!1,refreshThrottle:300,loadThrottle:300,loadingClass:"loading",dataAttr:null,optgroupField:"optgroup",valueField:"value",labelField:"text",disabledField:"disabled",optgroupLabelField:"label",optgroupValueField:"value",lockOptgroupOrder:!1,sortField:"$order",searchField:["text"],searchConjunction:"and",mode:null,wrapperClass:"ts-wrapper",controlClass:"ts-control",dropdownClass:"ts-dropdown",dropdownContentClass:"ts-dropdown-content",itemClass:"item",optionClass:"option",dropdownParent:null,controlInput:'<input type="text" autocomplete="off" size="1" />',copyClassesToDropdown:!1,placeholder:null,hidePlaceholder:null,shouldLoad:function(i){return i.length>0},render:{}};const et=i=>typeof i>"u"||i===null?null:Gt(i),Gt=i=>typeof i=="boolean"?i?"1":"0":i+"",qt=i=>(i+"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;"),$o=(i,e)=>e>0?setTimeout(i,e):(i.call(null),null),Po=(i,e)=>{var t;return function(n,o){var r=this;t&&(r.loading=Math.max(r.loading-1,0),clearTimeout(t)),t=setTimeout(function(){t=null,r.loadedSearches[n]=!0,i.call(r,n,o)},e)}},Ii=(i,e,t)=>{var n,o=i.trigger,r={};i.trigger=function(){var l=arguments[0];if(e.indexOf(l)!==-1)r[l]=arguments;else return o.apply(i,arguments)},t.apply(i,[]),i.trigger=o;for(n of e)n in r&&o.apply(i,r[n])},Lo=i=>({start:i.selectionStart||0,length:(i.selectionEnd||0)-(i.selectionStart||0)}),Oe=(i,e=!1)=>{i&&(i.preventDefault(),e&&i.stopPropagation())},ke=(i,e,t,n)=>{i.addEventListener(e,t,n)},mt=(i,e)=>{if(!e||!e[i])return!1;var t=(e.altKey?1:0)+(e.ctrlKey?1:0)+(e.shiftKey?1:0)+(e.metaKey?1:0);return t===1},On=(i,e)=>{const t=i.getAttribute("id");return t||(i.setAttribute("id",e),e)},Ei=i=>i.replace(/[\\"']/g,"\\$&"),gt=(i,e)=>{e&&i.append(e)};function wi(i,e){var t=Object.assign({},vi,e),n=t.dataAttr,o=t.labelField,r=t.valueField,l=t.disabledField,u=t.optgroupField,m=t.optgroupLabelField,y=t.optgroupValueField,N=i.tagName.toLowerCase(),C=i.getAttribute("placeholder")||i.getAttribute("data-placeholder");if(!C&&!t.allowEmptyOption){let P=i.querySelector('option[value=""]');P&&(C=P.textContent)}var k={placeholder:C,options:[],optgroups:[],items:[],maxItems:null},X=()=>{var P,O=k.options,M={},A=1;let B=0;var U=I=>{var g=Object.assign({},I.dataset),E=n&&g[n];return typeof E=="string"&&E.length&&(g=Object.assign(g,JSON.parse(E))),g},Y=(I,g)=>{var E=et(I.value);if(E!=null&&!(!E&&!t.allowEmptyOption)){if(M.hasOwnProperty(E)){if(g){var p=M[E][u];p?Array.isArray(p)?p.push(g):M[E][u]=[p,g]:M[E][u]=g}}else{var _=U(I);_[o]=_[o]||I.textContent,_[r]=_[r]||E,_[l]=_[l]||I.disabled,_[u]=_[u]||g,_.$option=I,_.$order=_.$order||++B,M[E]=_,O.push(_)}I.selected&&k.items.push(E)}},x=I=>{var g,E;E=U(I),E[m]=E[m]||I.getAttribute("label")||"",E[y]=E[y]||A++,E[l]=E[l]||I.disabled,E.$order=E.$order||++B,k.optgroups.push(E),g=E[y],bt(I.children,p=>{Y(p,g)})};k.maxItems=i.hasAttribute("multiple")?null:1,bt(i.children,I=>{P=I.tagName.toLowerCase(),P==="optgroup"?x(I):P==="option"&&Y(I)})},b=()=>{const P=i.getAttribute(n);if(P)k.options=JSON.parse(P),bt(k.options,M=>{k.items.push(M[r])});else{var O=i.value.trim()||"";if(!t.allowEmptyOption&&!O.length)return;const M=O.split(t.delimiter);bt(M,A=>{const B={};B[o]=A,B[r]=A,k.options.push(B)}),k.items=M}};return N==="select"?X():b(),Object.assign({},vi,k,e)}var bi=0;class Ye extends to(eo){constructor(e,t){super(),this.control_input=void 0,this.wrapper=void 0,this.dropdown=void 0,this.control=void 0,this.dropdown_content=void 0,this.focus_node=void 0,this.order=0,this.settings=void 0,this.input=void 0,this.tabIndex=void 0,this.is_select_tag=void 0,this.rtl=void 0,this.inputId=void 0,this._destroy=void 0,this.sifter=void 0,this.isOpen=!1,this.isDisabled=!1,this.isReadOnly=!1,this.isRequired=void 0,this.isInvalid=!1,this.isValid=!0,this.isLocked=!1,this.isFocused=!1,this.isInputHidden=!1,this.isSetup=!1,this.ignoreFocus=!1,this.ignoreHover=!1,this.hasOptions=!1,this.currentResults=void 0,this.lastValue="",this.caretPos=0,this.loading=0,this.loadedSearches={},this.activeOption=null,this.activeItems=[],this.optgroups={},this.options={},this.userOptions={},this.items=[],this.refreshTimeout=null,bi++;var n,o=Ue(e);if(o.tomselect)throw new Error("Tom Select already initialized on this element");o.tomselect=this;var r=window.getComputedStyle&&window.getComputedStyle(o,null);n=r.getPropertyValue("direction");const l=wi(o,t);this.settings=l,this.input=o,this.tabIndex=o.tabIndex||0,this.is_select_tag=o.tagName.toLowerCase()==="select",this.rtl=/rtl/i.test(n),this.inputId=On(o,"tomselect-"+bi),this.isRequired=o.required,this.sifter=new bo(this.options,{diacritics:l.diacritics}),l.mode=l.mode||(l.maxItems===1?"single":"multi"),typeof l.hideSelected!="boolean"&&(l.hideSelected=l.mode==="multi"),typeof l.hidePlaceholder!="boolean"&&(l.hidePlaceholder=l.mode!=="multi");var u=l.createFilter;typeof u!="function"&&(typeof u=="string"&&(u=new RegExp(u)),u instanceof RegExp?l.createFilter=O=>u.test(O):l.createFilter=O=>this.settings.duplicates||!this.options[O]),this.initializePlugins(l.plugins),this.setupCallbacks(),this.setupTemplates();const m=Ue("<div>"),y=Ue("<div>"),N=this._render("dropdown"),C=Ue('<div role="listbox" tabindex="-1">'),k=this.input.getAttribute("class")||"",X=l.mode;var b;if(ze(m,l.wrapperClass,k,X),ze(y,l.controlClass),gt(m,y),ze(N,l.dropdownClass,X),l.copyClassesToDropdown&&ze(N,k),ze(C,l.dropdownContentClass),gt(N,C),Ue(l.dropdownParent||m).appendChild(N),Ui(l.controlInput)){b=Ue(l.controlInput);var P=["autocorrect","autocapitalize","autocomplete","spellcheck"];Ke(P,O=>{o.getAttribute(O)&&Pe(b,{[O]:o.getAttribute(O)})}),b.tabIndex=-1,y.appendChild(b),this.focus_node=b}else l.controlInput?(b=Ue(l.controlInput),this.focus_node=b):(b=Ue("<input/>"),this.focus_node=y);this.wrapper=m,this.dropdown=N,this.dropdown_content=C,this.control=y,this.control_input=b,this.setup()}setup(){const e=this,t=e.settings,n=e.control_input,o=e.dropdown,r=e.dropdown_content,l=e.wrapper,u=e.control,m=e.input,y=e.focus_node,N={passive:!0},C=e.inputId+"-ts-dropdown";Pe(r,{id:C}),Pe(y,{role:"combobox","aria-haspopup":"listbox","aria-expanded":"false","aria-controls":C});const k=On(y,e.inputId+"-ts-control"),X="label[for='"+So(e.inputId)+"']",b=document.querySelector(X),P=e.focus.bind(e);if(b){ke(b,"click",P),Pe(b,{for:k});const A=On(b,e.inputId+"-ts-label");Pe(y,{"aria-labelledby":A}),Pe(r,{"aria-labelledby":A})}if(l.style.width=m.style.width,e.plugins.names.length){const A="plugin-"+e.plugins.names.join(" plugin-");ze([l,o],A)}(t.maxItems===null||t.maxItems>1)&&e.is_select_tag&&Pe(m,{multiple:"multiple"}),t.placeholder&&Pe(n,{placeholder:t.placeholder}),!t.splitOn&&t.delimiter&&(t.splitOn=new RegExp("\\s*"+Dt(t.delimiter)+"+\\s*")),t.load&&t.loadThrottle&&(t.load=Po(t.load,t.loadThrottle)),ke(o,"mousemove",()=>{e.ignoreHover=!1}),ke(o,"mouseenter",A=>{var B=Wt(A.target,"[data-selectable]",o);B&&e.onOptionHover(A,B)},{capture:!0}),ke(o,"click",A=>{const B=Wt(A.target,"[data-selectable]");B&&(e.onOptionSelect(A,B),Oe(A,!0))}),ke(u,"click",A=>{var B=Wt(A.target,"[data-ts-item]",u);if(B&&e.onItemSelect(A,B)){Oe(A,!0);return}n.value==""&&(e.onClick(),Oe(A,!0))}),ke(y,"keydown",A=>e.onKeyDown(A)),ke(n,"keypress",A=>e.onKeyPress(A)),ke(n,"input",A=>e.onInput(A)),ke(y,"blur",A=>e.onBlur(A)),ke(y,"focus",A=>e.onFocus(A)),ke(n,"paste",A=>e.onPaste(A));const O=A=>{const B=A.composedPath()[0];if(!l.contains(B)&&!o.contains(B)){e.isFocused&&e.blur(),e.inputState();return}B==n&&e.isOpen?A.stopPropagation():Oe(A,!0)},M=()=>{e.isOpen&&e.positionDropdown()};ke(document,"mousedown",O),ke(window,"scroll",M,N),ke(window,"resize",M,N),this._destroy=()=>{document.removeEventListener("mousedown",O),window.removeEventListener("scroll",M),window.removeEventListener("resize",M),b&&b.removeEventListener("click",P)},this.revertSettings={innerHTML:m.innerHTML,tabIndex:m.tabIndex},m.tabIndex=-1,m.insertAdjacentElement("afterend",e.wrapper),e.sync(!1),t.items=[],delete t.optgroups,delete t.options,ke(m,"invalid",()=>{e.isValid&&(e.isValid=!1,e.isInvalid=!0,e.refreshState())}),e.updateOriginalInput(),e.refreshItems(),e.close(!1),e.inputState(),e.isSetup=!0,m.disabled?e.disable():m.readOnly?e.setReadOnly(!0):e.enable(),e.on("change",this.onChange),ze(m,"tomselected","ts-hidden-accessible"),e.trigger("initialize"),t.preload===!0&&e.preload()}setupOptions(e=[],t=[]){this.addOptions(e),Ke(t,n=>{this.registerOptionGroup(n)})}setupTemplates(){var e=this,t=e.settings.labelField,n=e.settings.optgroupLabelField,o={optgroup:r=>{let l=document.createElement("div");return l.className="optgroup",l.appendChild(r.options),l},optgroup_header:(r,l)=>'<div class="optgroup-header">'+l(r[n])+"</div>",option:(r,l)=>"<div>"+l(r[t])+"</div>",item:(r,l)=>"<div>"+l(r[t])+"</div>",option_create:(r,l)=>'<div class="create">Add <strong>'+l(r.input)+"</strong>&hellip;</div>",no_results:()=>'<div class="no-results">No results found</div>',loading:()=>'<div class="spinner"></div>',not_loading:()=>{},dropdown:()=>"<div></div>"};e.settings.render=Object.assign({},o,e.settings.render)}setupCallbacks(){var e,t,n={initialize:"onInitialize",change:"onChange",item_add:"onItemAdd",item_remove:"onItemRemove",item_select:"onItemSelect",clear:"onClear",option_add:"onOptionAdd",option_remove:"onOptionRemove",option_clear:"onOptionClear",optgroup_add:"onOptionGroupAdd",optgroup_remove:"onOptionGroupRemove",optgroup_clear:"onOptionGroupClear",dropdown_open:"onDropdownOpen",dropdown_close:"onDropdownClose",type:"onType",load:"onLoad",focus:"onFocus",blur:"onBlur"};for(e in n)t=this.settings[n[e]],t&&this.on(e,t)}sync(e=!0){const t=this,n=e?wi(t.input,{delimiter:t.settings.delimiter}):t.settings;t.setupOptions(n.options,n.optgroups),t.setValue(n.items||[],!0),t.lastQuery=null}onClick(){var e=this;if(e.activeItems.length>0){e.clearActiveItems(),e.focus();return}e.isFocused&&e.isOpen?e.blur():e.focus()}onMouseDown(){}onChange(){_n(this.input,"input"),_n(this.input,"change")}onPaste(e){var t=this;if(t.isInputHidden||t.isLocked){Oe(e);return}t.settings.splitOn&&setTimeout(()=>{var n=t.inputValue();if(n.match(t.settings.splitOn)){var o=n.trim().split(t.settings.splitOn);Ke(o,r=>{et(r)&&(this.options[r]?t.addItem(r):t.createItem(r))})}},0)}onKeyPress(e){var t=this;if(t.isLocked){Oe(e);return}var n=String.fromCharCode(e.keyCode||e.which);if(t.settings.create&&t.settings.mode==="multi"&&n===t.settings.delimiter){t.createItem(),Oe(e);return}}onKeyDown(e){var t=this;if(t.ignoreHover=!0,t.isLocked){e.keyCode!==Ln&&Oe(e);return}switch(e.keyCode){case Oo:if(mt(jt,e)&&t.control_input.value==""){Oe(e),t.selectAll();return}break;case Hi:t.isOpen&&(Oe(e,!0),t.close()),t.clearActiveItems();return;case Do:if(!t.isOpen&&t.hasOptions)t.open();else if(t.activeOption){let n=t.getAdjacent(t.activeOption,1);n&&t.setActiveOption(n)}Oe(e);return;case xo:if(t.activeOption){let n=t.getAdjacent(t.activeOption,-1);n&&t.setActiveOption(n)}Oe(e);return;case ko:t.canSelect(t.activeOption)?(t.onOptionSelect(e,t.activeOption),Oe(e)):(t.settings.create&&t.createItem()||document.activeElement==t.control_input&&t.isOpen)&&Oe(e);return;case Pn:t.advanceSelection(-1,e);return;case Wi:t.advanceSelection(1,e);return;case Ln:t.settings.selectOnTab&&(t.canSelect(t.activeOption)&&(t.onOptionSelect(e,t.activeOption),Oe(e)),t.settings.create&&t.createItem()&&Oe(e));return;case yi:case Co:t.deleteSelection(e);return}t.isInputHidden&&!mt(jt,e)&&Oe(e)}onInput(e){if(this.isLocked)return;const t=this.inputValue();if(this.lastValue!==t){if(this.lastValue=t,t==""){this._onInput();return}this.refreshTimeout&&clearTimeout(this.refreshTimeout),this.refreshTimeout=$o(()=>{this.refreshTimeout=null,this._onInput()},this.settings.refreshThrottle)}}_onInput(){const e=this.lastValue;this.settings.shouldLoad.call(this,e)&&this.load(e),this.refreshOptions(),this.trigger("type",e)}onOptionHover(e,t){this.ignoreHover||this.setActiveOption(t,!1)}onFocus(e){var t=this,n=t.isFocused;if(t.isDisabled||t.isReadOnly){t.blur(),Oe(e);return}t.ignoreFocus||(t.isFocused=!0,t.settings.preload==="focus"&&t.preload(),n||t.trigger("focus"),t.activeItems.length||(t.inputState(),t.refreshOptions(!!t.settings.openOnFocus)),t.refreshState())}onBlur(e){if(document.hasFocus()!==!1){var t=this;if(t.isFocused){t.isFocused=!1,t.ignoreFocus=!1;var n=()=>{t.close(),t.setActiveItem(),t.setCaret(t.items.length),t.trigger("blur")};t.settings.create&&t.settings.createOnBlur?t.createItem(null,n):n()}}}onOptionSelect(e,t){var n,o=this;t.parentElement&&t.parentElement.matches("[data-disabled]")||(t.classList.contains("create")?o.createItem(null,()=>{o.settings.closeAfterSelect&&o.close()}):(n=t.dataset.value,typeof n<"u"&&(o.lastQuery=null,o.addItem(n),o.settings.closeAfterSelect&&o.close(),!o.settings.hideSelected&&e.type&&/click/.test(e.type)&&o.setActiveOption(t))))}canSelect(e){return!!(this.isOpen&&e&&this.dropdown_content.contains(e))}onItemSelect(e,t){var n=this;return!n.isLocked&&n.settings.mode==="multi"?(Oe(e),n.setActiveItem(t,e),!0):!1}canLoad(e){return!(!this.settings.load||this.loadedSearches.hasOwnProperty(e))}load(e){const t=this;if(!t.canLoad(e))return;ze(t.wrapper,t.settings.loadingClass),t.loading++;const n=t.loadCallback.bind(t);t.settings.load.call(t,e,n)}loadCallback(e,t){const n=this;n.loading=Math.max(n.loading-1,0),n.lastQuery=null,n.clearActiveOption(),n.setupOptions(e,t),n.refreshOptions(n.isFocused&&!n.isInputHidden),n.loading||lt(n.wrapper,n.settings.loadingClass),n.trigger("load",e,t)}preload(){var e=this.wrapper.classList;e.contains("preloaded")||(e.add("preloaded"),this.load(""))}setTextboxValue(e=""){var t=this.control_input,n=t.value!==e;n&&(t.value=e,_n(t,"update"),this.lastValue=e)}getValue(){return this.is_select_tag&&this.input.hasAttribute("multiple")?this.items:this.items.join(this.settings.delimiter)}setValue(e,t){var n=t?[]:["change"];Ii(this,n,()=>{this.clear(t),this.addItems(e,t)})}setMaxItems(e){e===0&&(e=null),this.settings.maxItems=e,this.refreshState()}setActiveItem(e,t){var n=this,o,r,l,u,m,y;if(n.settings.mode!=="single"){if(!e){n.clearActiveItems(),n.isFocused&&n.inputState();return}if(o=t&&t.type.toLowerCase(),o==="click"&&mt("shiftKey",t)&&n.activeItems.length){for(y=n.getLastActive(),l=Array.prototype.indexOf.call(n.control.children,y),u=Array.prototype.indexOf.call(n.control.children,e),l>u&&(m=l,l=u,u=m),r=l;r<=u;r++)e=n.control.children[r],n.activeItems.indexOf(e)===-1&&n.setActiveItemClass(e);Oe(t)}else o==="click"&&mt(jt,t)||o==="keydown"&&mt("shiftKey",t)?e.classList.contains("active")?n.removeActiveItem(e):n.setActiveItemClass(e):(n.clearActiveItems(),n.setActiveItemClass(e));n.inputState(),n.isFocused||n.focus()}}setActiveItemClass(e){const t=this,n=t.control.querySelector(".last-active");n&&lt(n,"last-active"),ze(e,"active last-active"),t.trigger("item_select",e),t.activeItems.indexOf(e)==-1&&t.activeItems.push(e)}removeActiveItem(e){var t=this.activeItems.indexOf(e);this.activeItems.splice(t,1),lt(e,"active")}clearActiveItems(){lt(this.activeItems,"active"),this.activeItems=[]}setActiveOption(e,t=!0){e!==this.activeOption&&(this.clearActiveOption(),e&&(this.activeOption=e,Pe(this.focus_node,{"aria-activedescendant":e.getAttribute("id")}),Pe(e,{"aria-selected":"true"}),ze(e,"active"),t&&this.scrollToOption(e)))}scrollToOption(e,t){if(!e)return;const n=this.dropdown_content,o=n.clientHeight,r=n.scrollTop||0,l=e.offsetHeight,u=e.getBoundingClientRect().top-n.getBoundingClientRect().top+r;u+l>o+r?this.scroll(u-o+l,t):u<r&&this.scroll(u,t)}scroll(e,t){const n=this.dropdown_content;t&&(n.style.scrollBehavior=t),n.scrollTop=e,n.style.scrollBehavior=""}clearActiveOption(){this.activeOption&&(lt(this.activeOption,"active"),Pe(this.activeOption,{"aria-selected":null})),this.activeOption=null,Pe(this.focus_node,{"aria-activedescendant":null})}selectAll(){const e=this;if(e.settings.mode==="single")return;const t=e.controlChildren();t.length&&(e.inputState(),e.close(),e.activeItems=t,Ke(t,n=>{e.setActiveItemClass(n)}))}inputState(){var e=this;e.control.contains(e.control_input)&&(Pe(e.control_input,{placeholder:e.settings.placeholder}),e.activeItems.length>0||!e.isFocused&&e.settings.hidePlaceholder&&e.items.length>0?(e.setTextboxValue(),e.isInputHidden=!0):(e.settings.hidePlaceholder&&e.items.length>0&&Pe(e.control_input,{placeholder:""}),e.isInputHidden=!1),e.wrapper.classList.toggle("input-hidden",e.isInputHidden))}inputValue(){return this.control_input.value.trim()}focus(){var e=this;e.isDisabled||e.isReadOnly||(e.ignoreFocus=!0,e.control_input.offsetWidth?e.control_input.focus():e.focus_node.focus(),setTimeout(()=>{e.ignoreFocus=!1,e.onFocus()},0))}blur(){this.focus_node.blur(),this.onBlur()}getScoreFunction(e){return this.sifter.getScoreFunction(e,this.getSearchOptions())}getSearchOptions(){var e=this.settings,t=e.sortField;return typeof e.sortField=="string"&&(t=[{field:e.sortField}]),{fields:e.searchField,conjunction:e.searchConjunction,sort:t,nesting:e.nesting}}search(e){var t,n,o=this,r=this.getSearchOptions();if(o.settings.score&&(n=o.settings.score.call(o,e),typeof n!="function"))throw new Error('Tom Select "score" setting must be a function that returns a function');return e!==o.lastQuery?(o.lastQuery=e,t=o.sifter.search(e,Object.assign(r,{score:n})),o.currentResults=t):t=Object.assign({},o.currentResults),o.settings.hideSelected&&(t.items=t.items.filter(l=>{let u=et(l.id);return!(u&&o.items.indexOf(u)!==-1)})),t}refreshOptions(e=!0){var t,n,o,r,l,u,m,y,N,C;const k={},X=[];var b=this,P=b.inputValue();const O=P===b.lastQuery||P==""&&b.lastQuery==null;var M=b.search(P),A=null,B=b.settings.shouldOpen||!1,U=b.dropdown_content;O&&(A=b.activeOption,A&&(N=A.closest("[data-group]"))),r=M.items.length,typeof b.settings.maxOptions=="number"&&(r=Math.min(r,b.settings.maxOptions)),r>0&&(B=!0);const Y=(I,g)=>{let E=k[I];if(E!==void 0){let _=X[E];if(_!==void 0)return[E,_.fragment]}let p=document.createDocumentFragment();return E=X.length,X.push({fragment:p,order:g,optgroup:I}),[E,p]};for(t=0;t<r;t++){let I=M.items[t];if(!I)continue;let g=I.id,E=b.options[g];if(E===void 0)continue;let p=Gt(g),_=b.getOption(p,!0);for(b.settings.hideSelected||_.classList.toggle("selected",b.items.includes(p)),l=E[b.settings.optgroupField]||"",u=Array.isArray(l)?l:[l],n=0,o=u&&u.length;n<o;n++){l=u[n];let L=E.$order,ie=b.optgroups[l];ie===void 0?l="":L=ie.$order;const[ae,oe]=Y(l,L);n>0&&(_=_.cloneNode(!0),Pe(_,{id:E.$id+"-clone-"+n,"aria-selected":null}),_.classList.add("ts-cloned"),lt(_,"active"),b.activeOption&&b.activeOption.dataset.value==g&&N&&N.dataset.group===l.toString()&&(A=_)),oe.appendChild(_),l!=""&&(k[l]=ae)}}b.settings.lockOptgroupOrder&&X.sort((I,g)=>I.order-g.order),m=document.createDocumentFragment(),Ke(X,I=>{let g=I.fragment,E=I.optgroup;if(!g||!g.children.length)return;let p=b.optgroups[E];if(p!==void 0){let _=document.createDocumentFragment(),L=b.render("optgroup_header",p);gt(_,L),gt(_,g);let ie=b.render("optgroup",{group:p,options:_});gt(m,ie)}else gt(m,g)}),U.innerHTML="",gt(U,m),b.settings.highlight&&(_o(U),M.query.length&&M.tokens.length&&Ke(M.tokens,I=>{No(U,I.regex)}));var x=I=>{let g=b.render(I,{input:P});return g&&(B=!0,U.insertBefore(g,U.firstChild)),g};if(b.loading?x("loading"):b.settings.shouldLoad.call(b,P)?M.items.length===0&&x("no_results"):x("not_loading"),y=b.canCreate(P),y&&(C=x("option_create")),b.hasOptions=M.items.length>0||y,B){if(M.items.length>0){if(!A&&b.settings.mode==="single"&&b.items[0]!=null&&(A=b.getOption(b.items[0])),!U.contains(A)){let I=0;C&&!b.settings.addPrecedence&&(I=1),A=b.selectable()[I]}}else C&&(A=C);e&&!b.isOpen&&(b.open(),b.scrollToOption(A,"auto")),b.setActiveOption(A)}else b.clearActiveOption(),e&&b.isOpen&&b.close(!1)}selectable(){return this.dropdown_content.querySelectorAll("[data-selectable]")}addOption(e,t=!1){const n=this;if(Array.isArray(e))return n.addOptions(e,t),!1;const o=et(e[n.settings.valueField]);return o===null||n.options.hasOwnProperty(o)?!1:(e.$order=e.$order||++n.order,e.$id=n.inputId+"-opt-"+e.$order,n.options[o]=e,n.lastQuery=null,t&&(n.userOptions[o]=t,n.trigger("option_add",o,e)),o)}addOptions(e,t=!1){Ke(e,n=>{this.addOption(n,t)})}registerOption(e){return this.addOption(e)}registerOptionGroup(e){var t=et(e[this.settings.optgroupValueField]);return t===null?!1:(e.$order=e.$order||++this.order,this.optgroups[t]=e,t)}addOptionGroup(e,t){var n;t[this.settings.optgroupValueField]=e,(n=this.registerOptionGroup(t))&&this.trigger("optgroup_add",n,t)}removeOptionGroup(e){this.optgroups.hasOwnProperty(e)&&(delete this.optgroups[e],this.clearCache(),this.trigger("optgroup_remove",e))}clearOptionGroups(){this.optgroups={},this.clearCache(),this.trigger("optgroup_clear")}updateOption(e,t){const n=this;var o,r;const l=et(e),u=et(t[n.settings.valueField]);if(l===null)return;const m=n.options[l];if(m==null)return;if(typeof u!="string")throw new Error("Value must be set in option data");const y=n.getOption(l),N=n.getItem(l);if(t.$order=t.$order||m.$order,delete n.options[l],n.uncacheValue(u),n.options[u]=t,y){if(n.dropdown_content.contains(y)){const C=n._render("option",t);$n(y,C),n.activeOption===y&&n.setActiveOption(C)}y.remove()}N&&(r=n.items.indexOf(l),r!==-1&&n.items.splice(r,1,u),o=n._render("item",t),N.classList.contains("active")&&ze(o,"active"),$n(N,o)),n.lastQuery=null}removeOption(e,t){const n=this;e=Gt(e),n.uncacheValue(e),delete n.userOptions[e],delete n.options[e],n.lastQuery=null,n.trigger("option_remove",e),n.removeItem(e,t)}clearOptions(e){const t=(e||this.clearFilter).bind(this);this.loadedSearches={},this.userOptions={},this.clearCache();const n={};Ke(this.options,(o,r)=>{t(o,r)&&(n[r]=o)}),this.options=this.sifter.items=n,this.lastQuery=null,this.trigger("option_clear")}clearFilter(e,t){return this.items.indexOf(t)>=0}getOption(e,t=!1){const n=et(e);if(n===null)return null;const o=this.options[n];if(o!=null){if(o.$div)return o.$div;if(t)return this._render("option",o)}return null}getAdjacent(e,t,n="option"){var o=this,r;if(!e)return null;n=="item"?r=o.controlChildren():r=o.dropdown_content.querySelectorAll("[data-selectable]");for(let l=0;l<r.length;l++)if(r[l]==e)return t>0?r[l+1]:r[l-1];return null}getItem(e){if(typeof e=="object")return e;var t=et(e);return t!==null?this.control.querySelector(`[data-value="${Ei(t)}"]`):null}addItems(e,t){var n=this,o=Array.isArray(e)?e:[e];o=o.filter(l=>n.items.indexOf(l)===-1);const r=o[o.length-1];o.forEach(l=>{n.isPending=l!==r,n.addItem(l,t)})}addItem(e,t){var n=t?[]:["change","dropdown_close"];Ii(this,n,()=>{var o,r;const l=this,u=l.settings.mode,m=et(e);if(!(m&&l.items.indexOf(m)!==-1&&(u==="single"&&l.close(),u==="single"||!l.settings.duplicates))&&!(m===null||!l.options.hasOwnProperty(m))&&(u==="single"&&l.clear(t),!(u==="multi"&&l.isFull()))){if(o=l._render("item",l.options[m]),l.control.contains(o)&&(o=o.cloneNode(!0)),r=l.isFull(),l.items.splice(l.caretPos,0,m),l.insertAtCaret(o),l.isSetup){if(!l.isPending&&l.settings.hideSelected){let y=l.getOption(m),N=l.getAdjacent(y,1);N&&l.setActiveOption(N)}!l.isPending&&!l.settings.closeAfterSelect&&l.refreshOptions(l.isFocused&&u!=="single"),l.settings.closeAfterSelect!=!1&&l.isFull()?l.close():l.isPending||l.positionDropdown(),l.trigger("item_add",m,o),l.isPending||l.updateOriginalInput({silent:t})}(!l.isPending||!r&&l.isFull())&&(l.inputState(),l.refreshState())}})}removeItem(e=null,t){const n=this;if(e=n.getItem(e),!e)return;var o,r;const l=e.dataset.value;o=Jt(e),e.remove(),e.classList.contains("active")&&(r=n.activeItems.indexOf(e),n.activeItems.splice(r,1),lt(e,"active")),n.items.splice(o,1),n.lastQuery=null,!n.settings.persist&&n.userOptions.hasOwnProperty(l)&&n.removeOption(l,t),o<n.caretPos&&n.setCaret(n.caretPos-1),n.updateOriginalInput({silent:t}),n.refreshState(),n.positionDropdown(),n.trigger("item_remove",l,e)}createItem(e=null,t=()=>{}){arguments.length===3&&(t=arguments[2]),typeof t!="function"&&(t=()=>{});var n=this,o=n.caretPos,r;if(e=e||n.inputValue(),!n.canCreate(e))return t(),!1;n.lock();var l=!1,u=m=>{if(n.unlock(),!m||typeof m!="object")return t();var y=et(m[n.settings.valueField]);if(typeof y!="string")return t();n.setTextboxValue(),n.addOption(m,!0),n.setCaret(o),n.addItem(y),t(m),l=!0};return typeof n.settings.create=="function"?r=n.settings.create.call(this,e,u):r={[n.settings.labelField]:e,[n.settings.valueField]:e},l||u(r),!0}refreshItems(){var e=this;e.lastQuery=null,e.isSetup&&e.addItems(e.items),e.updateOriginalInput(),e.refreshState()}refreshState(){const e=this;e.refreshValidityState();const t=e.isFull(),n=e.isLocked;e.wrapper.classList.toggle("rtl",e.rtl);const o=e.wrapper.classList;o.toggle("focus",e.isFocused),o.toggle("disabled",e.isDisabled),o.toggle("readonly",e.isReadOnly),o.toggle("required",e.isRequired),o.toggle("invalid",!e.isValid),o.toggle("locked",n),o.toggle("full",t),o.toggle("input-active",e.isFocused&&!e.isInputHidden),o.toggle("dropdown-active",e.isOpen),o.toggle("has-options",To(e.options)),o.toggle("has-items",e.items.length>0)}refreshValidityState(){var e=this;e.input.validity&&(e.isValid=e.input.validity.valid,e.isInvalid=!e.isValid)}isFull(){return this.settings.maxItems!==null&&this.items.length>=this.settings.maxItems}updateOriginalInput(e={}){const t=this;var n,o;const r=t.input.querySelector('option[value=""]');if(t.is_select_tag){let m=function(y,N,C){return y||(y=Ue('<option value="'+qt(N)+'">'+qt(C)+"</option>")),y!=r&&t.input.append(y),l.push(y),(y!=r||u>0)&&(y.selected=!0),y};const l=[],u=t.input.querySelectorAll("option:checked").length;t.input.querySelectorAll("option:checked").forEach(y=>{y.selected=!1}),t.items.length==0&&t.settings.mode=="single"?m(r,"",""):t.items.forEach(y=>{if(n=t.options[y],o=n[t.settings.labelField]||"",l.includes(n.$option)){const N=t.input.querySelector(`option[value="${Ei(y)}"]:not(:checked)`);m(N,y,o)}else n.$option=m(n.$option,y,o)})}else t.input.value=t.getValue();t.isSetup&&(e.silent||t.trigger("change",t.getValue()))}open(){var e=this;e.isLocked||e.isOpen||e.settings.mode==="multi"&&e.isFull()||(e.isOpen=!0,Pe(e.focus_node,{"aria-expanded":"true"}),e.refreshState(),Vt(e.dropdown,{visibility:"hidden",display:"block"}),e.positionDropdown(),Vt(e.dropdown,{visibility:"visible",display:"block"}),e.focus(),e.trigger("dropdown_open",e.dropdown))}close(e=!0){var t=this,n=t.isOpen;e&&(t.setTextboxValue(),t.settings.mode==="single"&&t.items.length&&t.inputState()),t.isOpen=!1,Pe(t.focus_node,{"aria-expanded":"false"}),Vt(t.dropdown,{display:"none"}),t.settings.hideSelected&&t.clearActiveOption(),t.refreshState(),n&&t.trigger("dropdown_close",t.dropdown)}positionDropdown(){if(this.settings.dropdownParent==="body"){var e=this.control,t=e.getBoundingClientRect(),n=e.offsetHeight+t.top+window.scrollY,o=t.left+window.scrollX;Vt(this.dropdown,{width:t.width+"px",top:n+"px",left:o+"px"})}}clear(e){var t=this;if(t.items.length){var n=t.controlChildren();Ke(n,o=>{t.removeItem(o,!0)}),t.inputState(),e||t.updateOriginalInput(),t.trigger("clear")}}insertAtCaret(e){const t=this,n=t.caretPos,o=t.control;o.insertBefore(e,o.children[n]||null),t.setCaret(n+1)}deleteSelection(e){var t,n,o,r,l=this;t=e&&e.keyCode===yi?-1:1,n=Lo(l.control_input);const u=[];if(l.activeItems.length)r=gi(l.activeItems,t),o=Jt(r),t>0&&o++,Ke(l.activeItems,m=>u.push(m));else if((l.isFocused||l.settings.mode==="single")&&l.items.length){const m=l.controlChildren();let y;t<0&&n.start===0&&n.length===0?y=m[l.caretPos-1]:t>0&&n.start===l.inputValue().length&&(y=m[l.caretPos]),y!==void 0&&u.push(y)}if(!l.shouldDelete(u,e))return!1;for(Oe(e,!0),typeof o<"u"&&l.setCaret(o);u.length;)l.removeItem(u.pop());return l.inputState(),l.positionDropdown(),l.refreshOptions(!1),!0}shouldDelete(e,t){const n=e.map(o=>o.dataset.value);return!(!n.length||typeof this.settings.onDelete=="function"&&this.settings.onDelete(n,t)===!1)}advanceSelection(e,t){var n,o,r=this;r.rtl&&(e*=-1),!r.inputValue().length&&(mt(jt,t)||mt("shiftKey",t)?(n=r.getLastActive(e),n?n.classList.contains("active")?o=r.getAdjacent(n,e,"item"):o=n:e>0?o=r.control_input.nextElementSibling:o=r.control_input.previousElementSibling,o&&(o.classList.contains("active")&&r.removeActiveItem(n),r.setActiveItemClass(o))):r.moveCaret(e))}moveCaret(e){}getLastActive(e){let t=this.control.querySelector(".last-active");if(t)return t;var n=this.control.querySelectorAll(".active");if(n)return gi(n,e)}setCaret(e){this.caretPos=this.items.length}controlChildren(){return Array.from(this.control.querySelectorAll("[data-ts-item]"))}lock(){this.setLocked(!0)}unlock(){this.setLocked(!1)}setLocked(e=this.isReadOnly||this.isDisabled){this.isLocked=e,this.refreshState()}disable(){this.setDisabled(!0),this.close()}enable(){this.setDisabled(!1)}setDisabled(e){this.focus_node.tabIndex=e?-1:this.tabIndex,this.isDisabled=e,this.input.disabled=e,this.control_input.disabled=e,this.setLocked()}setReadOnly(e){this.isReadOnly=e,this.input.readOnly=e,this.control_input.readOnly=e,this.setLocked()}destroy(){var e=this,t=e.revertSettings;e.trigger("destroy"),e.off(),e.wrapper.remove(),e.dropdown.remove(),e.input.innerHTML=t.innerHTML,e.input.tabIndex=t.tabIndex,lt(e.input,"tomselected","ts-hidden-accessible"),e._destroy(),delete e.input.tomselect}render(e,t){var n,o;const r=this;if(typeof this.settings.render[e]!="function"||(o=r.settings.render[e].call(this,t,qt),!o))return null;if(o=Ue(o),e==="option"||e==="option_create"?t[r.settings.disabledField]?Pe(o,{"aria-disabled":"true"}):Pe(o,{"data-selectable":""}):e==="optgroup"&&(n=t.group[r.settings.optgroupValueField],Pe(o,{"data-group":n}),t.group[r.settings.disabledField]&&Pe(o,{"data-disabled":""})),e==="option"||e==="item"){const l=Gt(t[r.settings.valueField]);Pe(o,{"data-value":l}),e==="item"?(ze(o,r.settings.itemClass),Pe(o,{"data-ts-item":""})):(ze(o,r.settings.optionClass),Pe(o,{role:"option",id:t.$id}),t.$div=o,r.options[l]=t)}return o}_render(e,t){const n=this.render(e,t);if(n==null)throw"HTMLElement expected";return n}clearCache(){Ke(this.options,e=>{e.$div&&(e.$div.remove(),delete e.$div)})}uncacheValue(e){const t=this.getOption(e);t&&t.remove()}canCreate(e){return this.settings.create&&e.length>0&&this.settings.createFilter.call(this,e)}hook(e,t,n){var o=this,r=o[t];o[t]=function(){var l,u;return e==="after"&&(l=r.apply(o,arguments)),u=n.apply(o,arguments),e==="instead"?u:(e==="before"&&(l=r.apply(o,arguments)),l)}}}function Mo(){ke(this.input,"change",()=>{this.sync()})}function Ro(i){var e=this,t=e.onOptionSelect;e.settings.hideSelected=!1;const n=Object.assign({className:"tomselect-checkbox",checkedClassNames:void 0,uncheckedClassNames:void 0},i);var o=function(u,m){m?(u.checked=!0,n.uncheckedClassNames&&u.classList.remove(...n.uncheckedClassNames),n.checkedClassNames&&u.classList.add(...n.checkedClassNames)):(u.checked=!1,n.checkedClassNames&&u.classList.remove(...n.checkedClassNames),n.uncheckedClassNames&&u.classList.add(...n.uncheckedClassNames))},r=function(u){setTimeout(()=>{var m=u.querySelector("input."+n.className);m instanceof HTMLInputElement&&o(m,u.classList.contains("selected"))},1)};e.hook("after","setupTemplates",()=>{var l=e.settings.render.option;e.settings.render.option=(u,m)=>{var y=Ue(l.call(e,u,m)),N=document.createElement("input");n.className&&N.classList.add(n.className),N.addEventListener("click",function(k){Oe(k)}),N.type="checkbox";const C=et(u[e.settings.valueField]);return o(N,!!(C&&e.items.indexOf(C)>-1)),y.prepend(N),y}}),e.on("item_remove",l=>{var u=e.getOption(l);u&&(u.classList.remove("selected"),r(u))}),e.on("item_add",l=>{var u=e.getOption(l);u&&r(u)}),e.hook("instead","onOptionSelect",(l,u)=>{if(u.classList.contains("selected")){u.classList.remove("selected"),e.removeItem(u.dataset.value),e.refreshOptions(),Oe(l,!0);return}t.call(e,l,u),r(u)})}function Bo(i){const e=this,t=Object.assign({className:"clear-button",title:"Clear All",html:n=>`<div class="${n.className}" title="${n.title}">&#10799;</div>`},i);e.on("initialize",()=>{var n=Ue(t.html(t));n.addEventListener("click",o=>{e.isLocked||(e.clear(),e.settings.mode==="single"&&e.settings.allowEmptyOption&&e.addItem(""),o.preventDefault(),o.stopPropagation())}),e.control.appendChild(n)})}const Fo=(i,e)=>{var t;(t=i.parentNode)==null||t.insertBefore(e,i.nextSibling)},Xo=(i,e)=>{var t;(t=i.parentNode)==null||t.insertBefore(e,i)},Uo=(i,e)=>{do{var t;if(e=(t=e)==null?void 0:t.previousElementSibling,i==e)return!0}while(e&&e.previousElementSibling);return!1};function Vo(){var i=this;if(i.settings.mode!=="multi")return;var e=i.lock,t=i.unlock;let n=!0,o;i.hook("after","setupTemplates",()=>{var r=i.settings.render.item;i.settings.render.item=(l,u)=>{const m=Ue(r.call(i,l,u));Pe(m,{draggable:"true"});const y=P=>{n||Oe(P),P.stopPropagation()},N=P=>{o=m,setTimeout(()=>{m.classList.add("ts-dragging")},0)},C=P=>{P.preventDefault(),m.classList.add("ts-drag-over"),X(m,o)},k=()=>{m.classList.remove("ts-drag-over")},X=(P,O)=>{O!==void 0&&(Uo(O,m)?Fo(P,O):Xo(P,O))},b=()=>{var P;document.querySelectorAll(".ts-drag-over").forEach(M=>M.classList.remove("ts-drag-over")),(P=o)==null||P.classList.remove("ts-dragging"),o=void 0;var O=[];i.control.querySelectorAll("[data-value]").forEach(M=>{if(M.dataset.value){let A=M.dataset.value;A&&O.push(A)}}),i.setValue(O)};return ke(m,"mousedown",y),ke(m,"dragstart",N),ke(m,"dragenter",C),ke(m,"dragover",C),ke(m,"dragleave",k),ke(m,"dragend",b),m}}),i.hook("instead","lock",()=>(n=!1,e.call(i))),i.hook("instead","unlock",()=>(n=!0,t.call(i)))}function jo(i){const e=this,t=Object.assign({title:"Untitled",headerClass:"dropdown-header",titleRowClass:"dropdown-header-title",labelClass:"dropdown-header-label",closeClass:"dropdown-header-close",html:n=>'<div class="'+n.headerClass+'"><div class="'+n.titleRowClass+'"><span class="'+n.labelClass+'">'+n.title+'</span><a class="'+n.closeClass+'">&times;</a></div></div>'},i);e.on("initialize",()=>{var n=Ue(t.html(t)),o=n.querySelector("."+t.closeClass);o&&o.addEventListener("click",r=>{Oe(r,!0),e.close()}),e.dropdown.insertBefore(n,e.dropdown.firstChild)})}function Ho(){var i=this;i.hook("instead","setCaret",e=>{i.settings.mode==="single"||!i.control.contains(i.control_input)?e=i.items.length:(e=Math.max(0,Math.min(i.items.length,e)),e!=i.caretPos&&!i.isPending&&i.controlChildren().forEach((t,n)=>{n<e?i.control_input.insertAdjacentElement("beforebegin",t):i.control.appendChild(t)})),i.caretPos=e}),i.hook("instead","moveCaret",e=>{if(!i.isFocused)return;const t=i.getLastActive(e);if(t){const n=Jt(t);i.setCaret(e>0?n+1:n),i.setActiveItem(),lt(t,"last-active")}else i.setCaret(i.caretPos+e)})}function Wo(){const i=this;i.settings.shouldOpen=!0,i.hook("before","setup",()=>{i.focus_node=i.control,ze(i.control_input,"dropdown-input");const e=Ue('<div class="dropdown-input-wrap">');e.append(i.control_input),i.dropdown.insertBefore(e,i.dropdown.firstChild);const t=Ue('<input class="items-placeholder" tabindex="-1" />');t.placeholder=i.settings.placeholder||"",i.control.append(t)}),i.on("initialize",()=>{i.control_input.addEventListener("keydown",t=>{switch(t.keyCode){case Hi:i.isOpen&&(Oe(t,!0),i.close()),i.clearActiveItems();return;case Ln:i.focus_node.tabIndex=-1;break}return i.onKeyDown.call(i,t)}),i.on("blur",()=>{i.focus_node.tabIndex=i.isDisabled?-1:i.tabIndex}),i.on("dropdown_open",()=>{i.control_input.focus()});const e=i.onBlur;i.hook("instead","onBlur",t=>{if(!(t&&t.relatedTarget==i.control_input))return e.call(i)}),ke(i.control_input,"blur",()=>i.onBlur()),i.hook("before","close",()=>{i.isOpen&&i.focus_node.focus({preventScroll:!0})})})}function Go(){var i=this;i.on("initialize",()=>{var e=document.createElement("span"),t=i.control_input;e.style.cssText="position:absolute; top:-99999px; left:-99999px; width:auto; padding:0; white-space:pre; ",i.wrapper.appendChild(e);var n=["letterSpacing","fontSize","fontFamily","fontWeight","textTransform"];for(const r of n)e.style[r]=t.style[r];var o=()=>{e.textContent=t.value,t.style.width=e.clientWidth+"px"};o(),i.on("update item_add item_remove",o),ke(t,"input",o),ke(t,"keyup",o),ke(t,"blur",o),ke(t,"update",o)})}function qo(){var i=this,e=i.deleteSelection;this.hook("instead","deleteSelection",t=>i.activeItems.length?e.call(i,t):!1)}function zo(){this.hook("instead","setActiveItem",()=>{}),this.hook("instead","selectAll",()=>{})}function Ko(){var i=this,e=i.onKeyDown;i.hook("instead","onKeyDown",t=>{var n,o,r,l;if(!i.isOpen||!(t.keyCode===Pn||t.keyCode===Wi))return e.call(i,t);i.ignoreHover=!0,l=Wt(i.activeOption,"[data-group]"),n=Jt(i.activeOption,"[data-selectable]"),l&&(t.keyCode===Pn?l=l.previousSibling:l=l.nextSibling,l&&(r=l.querySelectorAll("[data-selectable]"),o=r[Math.min(r.length-1,n)],o&&i.setActiveOption(o)))})}function Yo(i){const e=Object.assign({label:"&times;",title:"Remove",className:"remove",append:!0},i);var t=this;if(e.append){var n='<a href="javascript:void(0)" class="'+e.className+'" tabindex="-1" title="'+qt(e.title)+'">'+e.label+"</a>";t.hook("after","setupTemplates",()=>{var o=t.settings.render.item;t.settings.render.item=(r,l)=>{var u=Ue(o.call(t,r,l)),m=Ue(n);return u.appendChild(m),ke(m,"mousedown",y=>{Oe(y,!0)}),ke(m,"click",y=>{t.isLocked||(Oe(y,!0),!t.isLocked&&t.shouldDelete([u],y)&&(t.removeItem(u),t.refreshOptions(!1),t.inputState()))}),u}})}}function Zo(i){const e=this,t=Object.assign({text:n=>n[e.settings.labelField]},i);e.on("item_remove",function(n){if(e.isFocused&&e.control_input.value.trim()===""){var o=e.options[n];o&&e.setTextboxValue(t.text.call(e,o))}})}function Jo(){const i=this,e=i.canLoad,t=i.clearActiveOption,n=i.loadCallback;var o={},r,l=!1,u,m=[];if(i.settings.shouldLoadMore||(i.settings.shouldLoadMore=()=>{if(r.clientHeight/(r.scrollHeight-r.scrollTop)>.9)return!0;if(i.activeOption){var k=i.selectable(),X=Array.from(k).indexOf(i.activeOption);if(X>=k.length-2)return!0}return!1}),!i.settings.firstUrl)throw"virtual_scroll plugin requires a firstUrl() method";i.settings.sortField=[{field:"$order"},{field:"$score"}];const y=C=>typeof i.settings.maxOptions=="number"&&r.children.length>=i.settings.maxOptions?!1:!!(C in o&&o[C]),N=(C,k)=>i.items.indexOf(k)>=0||m.indexOf(k)>=0;i.setNextUrl=(C,k)=>{o[C]=k},i.getUrl=C=>{if(C in o){const k=o[C];return o[C]=!1,k}return i.clearPagination(),i.settings.firstUrl.call(i,C)},i.clearPagination=()=>{o={}},i.hook("instead","clearActiveOption",()=>{if(!l)return t.call(i)}),i.hook("instead","canLoad",C=>C in o?y(C):e.call(i,C)),i.hook("instead","loadCallback",(C,k)=>{if(!l)i.clearOptions(N);else if(u){const X=C[0];X!==void 0&&(u.dataset.value=X[i.settings.valueField])}n.call(i,C,k),l=!1}),i.hook("after","refreshOptions",()=>{const C=i.lastValue;var k;y(C)?(k=i.render("loading_more",{query:C}),k&&(k.setAttribute("data-selectable",""),u=k)):C in o&&!r.querySelector(".no-results")&&(k=i.render("no_more_results",{query:C})),k&&(ze(k,i.settings.optionClass),r.append(k))}),i.on("initialize",()=>{m=Object.keys(i.options),r=i.dropdown_content,i.settings.render=Object.assign({},{loading_more:()=>'<div class="loading-more-results">Loading more results ... </div>',no_more_results:()=>'<div class="no-more-results">No more results</div>'},i.settings.render),r.addEventListener("scroll",()=>{i.settings.shouldLoadMore.call(i)&&y(i.lastValue)&&(l||(l=!0,i.load.call(i,i.lastValue)))})})}Ye.define("change_listener",Mo);Ye.define("checkbox_options",Ro);Ye.define("clear_button",Bo);Ye.define("drag_drop",Vo);Ye.define("dropdown_header",jo);Ye.define("caret_position",Ho);Ye.define("dropdown_input",Wo);Ye.define("input_autogrow",Go);Ye.define("no_backspace_delete",qo);Ye.define("no_active_items",zo);Ye.define("optgroup_columns",Ko);Ye.define("remove_button",Yo);Ye.define("restore_on_backspace",Zo);Ye.define("virtual_scroll",Jo);async function Qo(i){if(!S.ready)return;const t=(await $.scene.local.getItems(o=>o.layer==="CHARACTER"))?.map(o=>o.id);let n=!1;for(const o of i){const r=o.metadata[`${h.SPECTREID}/metadata_ghosts`];if(r?.length>0){n=!0;const l=r.map(m=>m.id);for(const m of r){const y=m.metadata[`${h.SPECTREID}/viewers`];y&&(y.includes(S.userId)?await $.scene.local.addItems([m]):t.includes(m.id)&&await $.scene.local.deleteItems([m.id]))}const u=t.filter(m=>!l.includes(m));u?.length>0&&await $.scene.local.deleteItems(u)}}n||await $.scene.local.deleteItems(t)}function ea(){const i=document.querySelectorAll(".tSelects");for(const e of i)if(e&&e.tomselect){const t=e.tomselect,n=[];for(const o of S.players)n.push({value:o.id,text:o.name});t.clearOptions(),t.addOption(n),n.length===0?(t.settings.placeholder="No Players",t.inputState()):(t.settings.placeholder="Choose..",t.inputState())}}async function ta(){let i=S.metadata[`${h.SPECTREID}/stored`];i&&(await $.scene.local.addItems(i),i.forEach(e=>{qi(e)}))}async function Si(){$.scene.local.onChange(async i=>{const e=i.filter(n=>n.layer=="CHARACTER");if(e.length===0)return;const t={};t[`${h.SPECTREID}/metadata_ghosts`]=e,await $.player.setMetadata(t)}),await $.contextMenu.create({id:`${h.SPECTREID}/context-menu`,icons:[{icon:"/ghost.svg",label:"Spectre",filter:{every:[{key:"layer",value:"CHARACTER"},{key:["metadata",`${h.SPECTREID}/spectred`],value:void 0,operator:"==",coordinator:"&&"}]}},{icon:"/ghost.svg",label:"Un-Spectre",filter:{every:[{key:"layer",value:"CHARACTER"},{key:["metadata",`${h.SPECTREID}/spectred`],value:void 0,operator:"!=",coordinator:"&&"}]}}],async onClick(i){if(i.items.every(t=>t.metadata[`${h.SPECTREID}/spectred`]===void 0)){document.getElementById("spectreWarning").style.display="none";for(const t of i.items)qi(t)}else for(const t of i.items){const n=t;n.metadata[`${h.SPECTREID}/spectred`]=void 0;const o=S.ghosts.findIndex(l=>l.id===n.id);S.ghosts.splice(o,1),document.getElementById(`tr-${n.id}`)?.remove(),await Gi(n),n.metadata[`${h.SPECTREID}/viewers`]=[],await $.scene.items.addItems([n])}}})}async function Gi(i){const t=S.metadata[`${h.SPECTREID}/stored`].filter(n=>n.id!==i.id);await $.scene.setMetadata({[`${h.SPECTREID}/stored`]:t}),await $.scene.local.deleteItems([i.id])}async function na(i){let e=S.metadata[`${h.SPECTREID}/stored`];if(!e)e=[i];else{if(e.find(n=>n.id===i.id))return;e.push(i)}await $.scene.setMetadata({[`${h.SPECTREID}/stored`]:e})}async function qi(i){const e=i.text?.plainText||i.name;i.metadata[`${h.SPECTREID}/spectred`]=!0,await $.scene.items.deleteItems([i.id]),await $.scene.local.addItems([i]),await na(i),S.ghosts.push(i);const t=document.getElementById("ghostList"),n=document.createElement("tr");n.id=`tr-${i.id}`,n.className="ghost-table-entry",n.innerHTML=`<td class="token-name">${e}</td>
        <td><select id="select-${i.id}" class="tSelects" multiple autocomplete="off" /></td>
        <td><input type="button" class="mysteryButton" id="deleteGhost-${i.id}" value="Delete"/></td>`,t.appendChild(n);const o=document.getElementById(`select-${i.id}`);for(const u of S.players){const m=document.createElement("option");m.value=u.id,m.text=u.name,o.appendChild(m)}const r={plugins:{remove_button:{title:"Remove this item"}},allowEmptyOption:!0,placeholder:S.players.length==0?"No Players":"Choose..",maxItems:null,create:!1,onDelete:async function(u,m){const y=m.currentTarget.parentElement.parentElement.parentElement.parentElement.parentElement.id.slice(3);await $.scene.local.updateItems([y],N=>{const C=N[0].metadata[`${h.SPECTREID}/viewers`],k=C.findIndex(X=>X==u);C.splice(k,1),N[0].metadata[`${h.SPECTREID}/viewers`]=C})},onItemAdd:async function(u,m){const y=m.parentElement.parentElement.parentElement.parentElement.id.slice(3);await $.scene.local.updateItems([y],N=>{const C=N[0].metadata[`${h.SPECTREID}/viewers`];C?(C.push(u),N[0].metadata[`${h.SPECTREID}/viewers`]=C):N[0].metadata[`${h.SPECTREID}/viewers`]=[u]})}};new Ye(`#select-${i.id}`,r);const l=document.getElementById(`deleteGhost-${i.id}`);l.onclick=async()=>{const u=S.ghosts.findIndex(m=>m.id===i.id);S.ghosts.splice(u,1),n.remove(),await $.scene.local.updateItems([i.id],m=>{m[0].metadata[`${h.SPECTREID}/viewers`]=[]}),await Gi(i)}}var zi={exports:{}};(function(i){(function(){function e(u,m){var y=u.x-m.x,N=u.y-m.y;return y*y+N*N}function t(u,m,y){var N=m.x,C=m.y,k=y.x-N,X=y.y-C;if(k!==0||X!==0){var b=((u.x-N)*k+(u.y-C)*X)/(k*k+X*X);b>1?(N=y.x,C=y.y):b>0&&(N+=k*b,C+=X*b)}return k=u.x-N,X=u.y-C,k*k+X*X}function n(u,m){for(var y=u[0],N=[y],C,k=1,X=u.length;k<X;k++)C=u[k],e(C,y)>m&&(N.push(C),y=C);return y!==C&&N.push(C),N}function o(u,m,y,N,C){for(var k=N,X,b=m+1;b<y;b++){var P=t(u[b],u[m],u[y]);P>k&&(X=b,k=P)}k>N&&(X-m>1&&o(u,m,X,N,C),C.push(u[X]),y-X>1&&o(u,X,y,N,C))}function r(u,m){var y=u.length-1,N=[u[0]];return o(u,0,y,m,N),N.push(u[y]),N}function l(u,m,y){if(u.length<=2)return u;var N=m!==void 0?m*m:1;return u=y?u:n(u,N),u=r(u,N),u}i.exports=l,i.exports.default=l})()})(zi);var ia=zi.exports;const ra=Bn(ia);async function Mn(i){const e=await $.scene.items.getItems(o=>o.layer==="MAP"),t={};for(let o=0;o<e.length;o++){let r=i.querySelector("#map-"+e[o].id);r===null&&(r=document.createElement("option"),r.id="map-"+e[o].id,r.value=e[o].id,r.innerText=e[o].name,i.appendChild(r)),t[e[o].id]=e[o].name}let n=i.querySelectorAll("option");for(let o=0;o<n.length;o++)t[n[o].value]===void 0&&i.removeChild(n[o])}async function oa(i,e,t,n,o){if(o.innerText="",Number.isNaN(t)||t<0){o.innerText="Invalid DPI";return}let r=S.gridDpi/t,l,u=[];if(u[0]=0,u[1]=0,n!==""){let m=await $.scene.items.getItems([n]);if(m.length>0)l=m[0],t===0&&(t=l.grid.dpi),r=S.gridDpi/t,u[0]=l.position.x-l.grid.offset.x*r,u[1]=l.position.y-l.grid.offset.y*r;else{o.innerText="Unable to find map";return}}else{o.innerText="No map selected";return}i==="foundry"?sa(e,r,u,o):i==="uvtt"&&aa(e,r,u,o)}function Ki(i,e,t,n,o){let r=0,l=0,u=0;const m=[];for(let y=0;y<i.length;y++){let N=[],C=!1;for(let k=0;k<i[y].length-1;k++){let X=i[y][k].x*e,b=i[y][k].y*e,P=i[y][k+1].x*e,O=i[y][k+1].y*e;N.push({x:X*t+n[0],y:b*t+n[1]}),N.push({x:P*t+n[0],y:O*t+n[1]}),l++,!C&&i[y][k].door&&(C=!0)}N.length>128&&(N.length,N=ra(N,8,!1));for(let k=0;k<N.length;k+=256){const X=N.slice(k>0?k-1:0,k+256),b=en().tension(0).points(X).fillColor("#000000").fillOpacity(0).layer("DRAWING").name("Vision Line (Import)").closed(!1).locked(!0).build();if(b.visible=!1,b.metadata[`${h.EXTENSIONID}/isVisionLine`]=!0,C&&(b.metadata[`${h.EXTENSIONID}/isDoor`]=!0),m.push(b),u+=X.length,u>512||m.length>64){r+=m.length,$.scene.items.addItems(m);const P=m.filter(O=>O.metadata[`${h.EXTENSIONID}/isDoor`]===!0);zt(P),m.length=0,u=0}}}if(m.length>0){r+=m.length,$.scene.items.addItems(m);const y=m.filter(N=>N.metadata[`${h.EXTENSIONID}/isDoor`]===!0);zt(y)}o.innerText="Finished importing "+r+" walls, "+l+" points."}function aa(i,e,t,n){if(!i.line_of_sight||i.line_of_sight.length===0){n.innerText="No walls / los found";return}if(i.resolution.map_origin!==void 0&&(t[0]-=i.resolution.map_origin.x*i.resolution.pixels_per_grid,t[1]-=i.resolution.map_origin.y*i.resolution.pixels_per_grid),i.portals&&i.portals.length)for(let o=0;o<i.portals.length;o++){let r=i.portals[o].bounds;r[0].door=!0,r[1].door=!0,i.line_of_sight.push(r)}Ki(i.line_of_sight,i.resolution.pixels_per_grid,e,t,n)}function sa(i,e,t,n){if(!i.walls||i.walls.length===0){n.innerText="No walls found";return}const o=[];for(var r=0;r<i.walls.length;r++)o.push([{x:i.walls[r].c[0],y:i.walls[r].c[1],door:!!i.walls[r].door},{x:i.walls[r].c[2],y:i.walls[r].c[3],door:!!i.walls[r].door}]);Ki(o,1,e,t,n)}var Je=function(){/*!
* Copyright (c) 2021-2023 Momo Bassit.
* Licensed under the MIT License (MIT)
* https://github.com/mdbassit/Coloris
* Version: 0.21.1
* NPM: https://github.com/melloware/coloris-npm
*/return function(i,e,t,n){var o=e.createElement("canvas").getContext("2d"),r={r:0,g:0,b:0,h:0,s:0,v:0,a:1},l,u,m,y,N,C,k,X,b,P,O,M,A,B,U,Y,x={},I={el:"[data-coloris]",parent:"body",theme:"default",themeMode:"light",rtl:!1,wrap:!0,margin:2,format:"hex",formatToggle:!1,swatches:[],swatchesOnly:!1,alpha:!0,forceAlpha:!1,focusInput:!0,selectInput:!1,inline:!1,defaultColor:"#000000",clearButton:!1,clearLabel:"Clear",closeButton:!1,closeLabel:"Close",onChange:function(){return n},a11y:{open:"Open color picker",close:"Close color picker",clear:"Clear the selected color",marker:"Saturation: {s}. Brightness: {v}.",hueSlider:"Hue slider",alphaSlider:"Opacity slider",input:"Color value field",format:"Color format",swatch:"Color swatch",instruction:"Saturation and brightness selector. Use up, down, left and right arrow keys to select."}},g={},E="",p={},_=!1;function L(T){if(typeof T=="object"){var j=function(){switch(W){case"el":he(T.el),T.wrap!==!1&&me(T.el);break;case"parent":l=e.querySelector(T.parent),l&&(l.appendChild(u),I.parent=T.parent,l===e.body&&(l=n));break;case"themeMode":I.themeMode=T.themeMode,T.themeMode==="auto"&&i.matchMedia&&i.matchMedia("(prefers-color-scheme: dark)").matches&&(I.themeMode="dark");case"theme":T.theme&&(I.theme=T.theme),u.className="clr-picker clr-"+I.theme+" clr-"+I.themeMode,I.inline&&be();break;case"rtl":I.rtl=!!T.rtl,e.querySelectorAll(".clr-field").forEach(function(Fe){return Fe.classList.toggle("clr-rtl",I.rtl)});break;case"margin":T.margin*=1,I.margin=isNaN(T.margin)?I.margin:T.margin;break;case"wrap":T.el&&T.wrap&&me(T.el);break;case"formatToggle":I.formatToggle=!!T.formatToggle,de("clr-format").style.display=I.formatToggle?"block":"none",I.formatToggle&&(I.format="auto");break;case"swatches":if(Array.isArray(T.swatches)){var ue=[];T.swatches.forEach(function(Fe,Ie){ue.push('<button type="button" id="clr-swatch-'+Ie+'" aria-labelledby="clr-swatch-label clr-swatch-'+Ie+'" style="color: '+Fe+';">'+Fe+"</button>")}),de("clr-swatches").innerHTML=ue.length?"<div>"+ue.join("")+"</div>":"",I.swatches=T.swatches.slice()}break;case"swatchesOnly":I.swatchesOnly=!!T.swatchesOnly,u.setAttribute("data-minimal",I.swatchesOnly);break;case"alpha":I.alpha=!!T.alpha,u.setAttribute("data-alpha",I.alpha);break;case"inline":if(I.inline=!!T.inline,u.setAttribute("data-inline",I.inline),I.inline){var pe=T.defaultColor||I.defaultColor;B=Le(pe),be(),ve(pe)}break;case"clearButton":typeof T.clearButton=="object"&&(T.clearButton.label&&(I.clearLabel=T.clearButton.label,k.innerHTML=I.clearLabel),T.clearButton=T.clearButton.show),I.clearButton=!!T.clearButton,k.style.display=I.clearButton?"block":"none";break;case"clearLabel":I.clearLabel=T.clearLabel,k.innerHTML=I.clearLabel;break;case"closeButton":I.closeButton=!!T.closeButton,I.closeButton?u.insertBefore(X,N):N.appendChild(X);break;case"closeLabel":I.closeLabel=T.closeLabel,X.innerHTML=I.closeLabel;break;case"a11y":var fe=T.a11y,Ae=!1;if(typeof fe=="object")for(var ye in fe)fe[ye]&&I.a11y[ye]&&(I.a11y[ye]=fe[ye],Ae=!0);if(Ae){var Be=de("clr-open-label"),Se=de("clr-swatch-label");Be.innerHTML=I.a11y.open,Se.innerHTML=I.a11y.swatch,X.setAttribute("aria-label",I.a11y.close),k.setAttribute("aria-label",I.a11y.clear),b.setAttribute("aria-label",I.a11y.hueSlider),O.setAttribute("aria-label",I.a11y.alphaSlider),C.setAttribute("aria-label",I.a11y.input),m.setAttribute("aria-label",I.a11y.instruction)}break;default:I[W]=T[W]}};for(var W in T)j()}}function ie(T,j){typeof T=="string"&&typeof j=="object"&&(g[T]=j,_=!0)}function ae(T){delete g[T],Object.keys(g).length===0&&(_=!1,T===E&&Q())}function oe(T){if(_){var j=["el","wrap","rtl","inline","defaultColor","a11y"],W=function(){var fe=g[ee];if(T.matches(ee)){E=ee,p={},j.forEach(function(ye){return delete fe[ye]});for(var Ae in fe)p[Ae]=Array.isArray(I[Ae])?I[Ae].slice():I[Ae];return L(fe),"break"}};for(var ee in g){var ue=W();if(ue==="break")break}}}function Q(){Object.keys(p).length>0&&(L(p),E="",p={})}function he(T){Ee(e,"click",T,function(j){I.inline||(oe(j.target),A=j.target,U=A.value,B=Le(U),u.classList.add("clr-open"),be(),ve(U),(I.focusInput||I.selectInput)&&(C.focus({preventScroll:!0}),C.setSelectionRange(A.selectionStart,A.selectionEnd)),I.selectInput&&C.select(),(Y||I.swatchesOnly)&&xe().shift().focus(),A.dispatchEvent(new Event("open",{bubbles:!0})))}),Ee(e,"input",T,function(j){var W=j.target.parentNode;W.classList.contains("clr-field")&&(W.style.color=j.target.value)})}function be(){if(!(!u||!A&&!I.inline)){var T=l,j=i.scrollY,W=u.offsetWidth,ee=u.offsetHeight,ue={left:!1,top:!1},pe,fe,Ae,ye={x:0,y:0};if(T&&(pe=i.getComputedStyle(T),fe=parseFloat(pe.marginTop),Ae=parseFloat(pe.borderTopWidth),ye=T.getBoundingClientRect(),ye.y+=Ae+j),!I.inline){var Be=A.getBoundingClientRect(),Se=Be.x,Fe=j+Be.y+Be.height+I.margin;T?(Se-=ye.x,Fe-=ye.y,Se+W>T.clientWidth&&(Se+=Be.width-W,ue.left=!0),Fe+ee>T.clientHeight-fe&&ee+I.margin<=Be.top-(ye.y-j)&&(Fe-=Be.height+ee+I.margin*2,ue.top=!0),Fe+=T.scrollTop):(Se+W>e.documentElement.clientWidth&&(Se+=Be.width-W,ue.left=!0),Fe+ee-j>e.documentElement.clientHeight&&ee+I.margin<=Be.top&&(Fe=j+Be.y-ee-I.margin,ue.top=!0)),u.classList.toggle("clr-left",ue.left),u.classList.toggle("clr-top",ue.top),u.style.left=Se+"px",u.style.top=Fe+"px",ye.x+=u.offsetLeft,ye.y+=u.offsetTop}x={width:m.offsetWidth,height:m.offsetHeight,x:m.offsetLeft+ye.x,y:m.offsetTop+ye.y}}}function me(T){e.querySelectorAll(T).forEach(function(j){var W=j.parentNode;if(!W.classList.contains("clr-field")){var ee=e.createElement("div"),ue="clr-field";(I.rtl||j.classList.contains("clr-rtl"))&&(ue+=" clr-rtl"),ee.innerHTML='<button type="button" aria-labelledby="clr-open-label"></button>',W.insertBefore(ee,j),ee.setAttribute("class",ue),ee.style.color=j.value,ee.appendChild(j)}})}function le(T){if(A&&!I.inline){var j=A;T&&(A=n,U!==j.value&&(j.value=U,j.dispatchEvent(new Event("input",{bubbles:!0})))),setTimeout(function(){U!==j.value&&j.dispatchEvent(new Event("change",{bubbles:!0}))}),u.classList.remove("clr-open"),_&&Q(),j.dispatchEvent(new Event("close",{bubbles:!0})),I.focusInput&&j.focus({preventScroll:!0}),A=n}}function ve(T){var j=ce(T),W=te(j);He(W.s,W.v),f(j,W),b.value=W.h,u.style.color="hsl("+W.h+", 100%, 50%)",P.style.left=W.h/360*100+"%",y.style.left=x.width*W.s/100+"px",y.style.top=x.height-x.height*W.v/100+"px",O.value=W.a*100,M.style.left=W.a*100+"%"}function Le(T){var j=T.substring(0,3).toLowerCase();return j==="rgb"||j==="hsl"?j:"hex"}function ge(T){T=T!==n?T:C.value,A&&(A.value=T,A.dispatchEvent(new Event("input",{bubbles:!0}))),I.onChange&&I.onChange.call(i,T,A),e.dispatchEvent(new CustomEvent("coloris:pick",{detail:{color:T,currentEl:A}}))}function _e(T,j){var W={h:b.value*1,s:T/x.width*100,v:100-j/x.height*100,a:O.value/100},ee=F(W);He(W.s,W.v),f(ee,W),ge()}function He(T,j){var W=I.a11y.marker;T=T.toFixed(1)*1,j=j.toFixed(1)*1,W=W.replace("{s}",T),W=W.replace("{v}",j),y.setAttribute("aria-label",W)}function Xe(T){return{pageX:T.changedTouches?T.changedTouches[0].pageX:T.pageX,pageY:T.changedTouches?T.changedTouches[0].pageY:T.pageY}}function Re(T){var j=Xe(T),W=j.pageX-x.x,ee=j.pageY-x.y;l&&(ee+=l.scrollTop),c(W,ee),T.preventDefault(),T.stopPropagation()}function K(T,j){var W=y.style.left.replace("px","")*1+T,ee=y.style.top.replace("px","")*1+j;c(W,ee)}function c(T,j){T=T<0?0:T>x.width?x.width:T,j=j<0?0:j>x.height?x.height:j,y.style.left=T+"px",y.style.top=j+"px",_e(T,j),y.focus()}function f(T,j){T===void 0&&(T={}),j===void 0&&(j={});var W=I.format;for(var ee in T)r[ee]=T[ee];for(var ue in j)r[ue]=j[ue];var pe=se(r),fe=pe.substring(0,7);switch(y.style.color=fe,M.parentNode.style.color=fe,M.style.color=pe,N.style.color=pe,m.style.display="none",m.offsetHeight,m.style.display="",M.nextElementSibling.style.display="none",M.nextElementSibling.offsetHeight,M.nextElementSibling.style.display="",W==="mixed"?W=r.a===1?"hex":"rgb":W==="auto"&&(W=B),W){case"hex":C.value=pe;break;case"rgb":C.value=De(r);break;case"hsl":C.value=Me(q(r));break}e.querySelector('.clr-format [value="'+W+'"]').checked=!0}function w(){var T=b.value*1,j=y.style.left.replace("px","")*1,W=y.style.top.replace("px","")*1;u.style.color="hsl("+T+", 100%, 50%)",P.style.left=T/360*100+"%",_e(j,W)}function H(){var T=O.value/100;M.style.left=T*100+"%",f({a:T}),ge()}function F(T){var j=T.s/100,W=T.v/100,ee=j*W,ue=T.h/60,pe=ee*(1-t.abs(ue%2-1)),fe=W-ee;ee=ee+fe,pe=pe+fe;var Ae=t.floor(ue)%6,ye=[ee,pe,fe,fe,pe,ee][Ae],Be=[pe,ee,ee,pe,fe,fe][Ae],Se=[fe,fe,pe,ee,ee,pe][Ae];return{r:t.round(ye*255),g:t.round(Be*255),b:t.round(Se*255),a:T.a}}function q(T){var j=T.v/100,W=j*(1-T.s/100/2),ee;return W>0&&W<1&&(ee=t.round((j-W)/t.min(W,1-W)*100)),{h:T.h,s:ee||0,l:t.round(W*100),a:T.a}}function te(T){var j=T.r/255,W=T.g/255,ee=T.b/255,ue=t.max(j,W,ee),pe=t.min(j,W,ee),fe=ue-pe,Ae=ue,ye=0,Be=0;return fe&&(ue===j&&(ye=(W-ee)/fe),ue===W&&(ye=2+(ee-j)/fe),ue===ee&&(ye=4+(j-W)/fe),ue&&(Be=fe/ue)),ye=t.floor(ye*60),{h:ye<0?ye+360:ye,s:t.round(Be*100),v:t.round(Ae*100),a:T.a}}function ce(T){var j=/^((rgba)|rgb)[\D]+([\d.]+)[\D]+([\d.]+)[\D]+([\d.]+)[\D]*?([\d.]+|$)/i,W,ee;return o.fillStyle="#000",o.fillStyle=T,W=j.exec(o.fillStyle),W?(ee={r:W[3]*1,g:W[4]*1,b:W[5]*1,a:W[6]*1},ee.a=+ee.a.toFixed(2)):(W=o.fillStyle.replace("#","").match(/.{2}/g).map(function(ue){return parseInt(ue,16)}),ee={r:W[0],g:W[1],b:W[2],a:1}),ee}function se(T){var j=T.r.toString(16),W=T.g.toString(16),ee=T.b.toString(16),ue="";if(T.r<16&&(j="0"+j),T.g<16&&(W="0"+W),T.b<16&&(ee="0"+ee),I.alpha&&(T.a<1||I.forceAlpha)){var pe=T.a*255|0;ue=pe.toString(16),pe<16&&(ue="0"+ue)}return"#"+j+W+ee+ue}function De(T){return!I.alpha||T.a===1&&!I.forceAlpha?"rgb("+T.r+", "+T.g+", "+T.b+")":"rgba("+T.r+", "+T.g+", "+T.b+", "+T.a+")"}function Me(T){return!I.alpha||T.a===1&&!I.forceAlpha?"hsl("+T.h+", "+T.s+"%, "+T.l+"%)":"hsla("+T.h+", "+T.s+"%, "+T.l+"%, "+T.a+")"}function Ce(){e.getElementById("clr-picker")||(l=n,u=e.createElement("div"),u.setAttribute("id","clr-picker"),u.className="clr-picker",u.innerHTML='<input id="clr-color-value" name="clr-color-value" class="clr-color" type="text" value="" spellcheck="false" aria-label="'+I.a11y.input+'">'+('<div id="clr-color-area" class="clr-gradient" role="application" aria-label="'+I.a11y.instruction+'">')+'<div id="clr-color-marker" class="clr-marker" tabindex="0"></div></div><div class="clr-hue">'+('<input id="clr-hue-slider" name="clr-hue-slider" type="range" min="0" max="360" step="1" aria-label="'+I.a11y.hueSlider+'">')+'<div id="clr-hue-marker"></div></div><div class="clr-alpha">'+('<input id="clr-alpha-slider" name="clr-alpha-slider" type="range" min="0" max="100" step="1" aria-label="'+I.a11y.alphaSlider+'">')+'<div id="clr-alpha-marker"></div><span></span></div><div id="clr-format" class="clr-format"><fieldset class="clr-segmented">'+("<legend>"+I.a11y.format+"</legend>")+'<input id="clr-f1" type="radio" name="clr-format" value="hex"><label for="clr-f1">Hex</label><input id="clr-f2" type="radio" name="clr-format" value="rgb"><label for="clr-f2">RGB</label><input id="clr-f3" type="radio" name="clr-format" value="hsl"><label for="clr-f3">HSL</label><span></span></fieldset></div><div id="clr-swatches" class="clr-swatches"></div>'+('<button type="button" id="clr-clear" class="clr-clear" aria-label="'+I.a11y.clear+'">'+I.clearLabel+"</button>")+'<div id="clr-color-preview" class="clr-preview">'+('<button type="button" id="clr-close" class="clr-close" aria-label="'+I.a11y.close+'">'+I.closeLabel+"</button>")+"</div>"+('<span id="clr-open-label" hidden>'+I.a11y.open+"</span>")+('<span id="clr-swatch-label" hidden>'+I.a11y.swatch+"</span>"),e.body.appendChild(u),m=de("clr-color-area"),y=de("clr-color-marker"),k=de("clr-clear"),X=de("clr-close"),N=de("clr-color-preview"),C=de("clr-color-value"),b=de("clr-hue-slider"),P=de("clr-hue-marker"),O=de("clr-alpha-slider"),M=de("clr-alpha-marker"),he(I.el),me(I.el),Ee(u,"mousedown",function(T){u.classList.remove("clr-keyboard-nav"),T.stopPropagation()}),Ee(m,"mousedown",function(T){Ee(e,"mousemove",Re)}),Ee(m,"touchstart",function(T){e.addEventListener("touchmove",Re,{passive:!1})}),Ee(y,"mousedown",function(T){Ee(e,"mousemove",Re)}),Ee(y,"touchstart",function(T){e.addEventListener("touchmove",Re,{passive:!1})}),Ee(C,"change",function(T){var j=C.value;if(A||I.inline){var W=j===""?j:ve(j);ge(W)}}),Ee(k,"click",function(T){ge(""),le()}),Ee(X,"click",function(T){ge(),le()}),Ee(de("clr-format"),"click",".clr-format input",function(T){B=T.target.value,f(),ge()}),Ee(u,"click",".clr-swatches button",function(T){ve(T.target.textContent),ge(),I.swatchesOnly&&le()}),Ee(e,"mouseup",function(T){e.removeEventListener("mousemove",Re)}),Ee(e,"touchend",function(T){e.removeEventListener("touchmove",Re)}),Ee(e,"mousedown",function(T){Y=!1,u.classList.remove("clr-keyboard-nav"),le()}),Ee(e,"keydown",function(T){var j=T.key,W=T.target,ee=T.shiftKey,ue=["Tab","ArrowUp","ArrowDown","ArrowLeft","ArrowRight"];if(j==="Escape"?le(!0):ue.includes(j)&&(Y=!0,u.classList.add("clr-keyboard-nav")),j==="Tab"&&W.matches(".clr-picker *")){var pe=xe(),fe=pe.shift(),Ae=pe.pop();ee&&W===fe?(Ae.focus(),T.preventDefault()):!ee&&W===Ae&&(fe.focus(),T.preventDefault())}}),Ee(e,"click",".clr-field button",function(T){_&&Q(),T.target.nextElementSibling.dispatchEvent(new Event("click",{bubbles:!0}))}),Ee(y,"keydown",function(T){var j={ArrowUp:[0,-1],ArrowDown:[0,1],ArrowLeft:[-1,0],ArrowRight:[1,0]};Object.keys(j).includes(T.key)&&(K.apply(void 0,j[T.key]),T.preventDefault())}),Ee(m,"click",Re),Ee(b,"input",w),Ee(O,"input",H))}function xe(){var T=Array.from(u.querySelectorAll("input, button")),j=T.filter(function(W){return!!W.offsetWidth});return j}function de(T){return e.getElementById(T)}function Ee(T,j,W,ee){var ue=Element.prototype.matches||Element.prototype.msMatchesSelector;typeof W=="string"?T.addEventListener(j,function(pe){ue.call(pe.target,W)&&ee.call(pe.target,pe)}):(ee=W,T.addEventListener(j,ee))}function Ze(T,j){j=j!==n?j:[],e.readyState!=="loading"?T.apply(void 0,j):e.addEventListener("DOMContentLoaded",function(){T.apply(void 0,j)})}NodeList!==n&&NodeList.prototype&&!NodeList.prototype.forEach&&(NodeList.prototype.forEach=Array.prototype.forEach);function ct(T,j){A=j,U=A.value,oe(j),B=Le(T),be(),ve(T),ge(),U!==T&&A.dispatchEvent(new Event("change",{bubbles:!0}))}var it=function(){var T={init:Ce,set:L,wrap:me,close:le,setInstance:ie,setColor:ct,removeInstance:ae,updatePosition:be};function j(ue){Ze(function(){ue&&(typeof ue=="string"?he(ue):L(ue))})}var W=function(pe){j[pe]=function(){for(var fe=arguments.length,Ae=new Array(fe),ye=0;ye<fe;ye++)Ae[ye]=arguments[ye];Ze(T[pe],Ae)}};for(var ee in T)W(ee);return Ze(function(){i.addEventListener("resize",function(ue){j.updatePosition()}),i.addEventListener("scroll",function(ue){j.updatePosition()})}),j}();return it.coloris=it,it}(window,document,Math)}();Je.coloris;Je.init;Je.set;Je.wrap;Je.close;Je.setInstance;Je.removeInstance;Je.updatePosition;function la(i){for(const e in i)if(i.hasOwnProperty(e))return!1;return!0}function Ti(){try{localStorage.setItem("STORAGECHECK","test")}catch{const e=document.getElementById("localStorageWarning");e.innerText="Local Storage disabled. Some features will not function."}}function Yi(i,e){const t=window.matchMedia("(prefers-color-scheme: dark)"),n=t.matches?"dark":"light",o=t.matches?"light":"dark";for(var r=0;r<e.styleSheets.length;r++)for(var l=0;l<e.styleSheets[r].cssRules.length;l++){let u=e.styleSheets[r].cssRules[l];u&&u.media&&u.media.mediaText.includes("prefers-color-scheme")&&(i.mode=="LIGHT"?(u.media.appendMedium(`(prefers-color-scheme: ${n})`),u.media.mediaText.includes(o)&&u.media.deleteMedium(`(prefers-color-scheme: ${o})`)):i.mode=="DARK"&&(u.media.appendMedium(`(prefers-color-scheme: ${o})`),u.media.mediaText.includes(n)&&u.media.deleteMedium(`(prefers-color-scheme: ${n})`)))}}async function Ni(){await $.contextMenu.create({id:`${h.EXTENSIONID}/toggle-vision-menu`,icons:[{icon:"/no-vision.svg",label:"Enable Vision",filter:{every:[{key:["metadata",`${h.EXTENSIONID}/hasVision`],operator:"==",value:void 0,coordinator:"&&"},{key:["metadata",`${h.SPECTREID}/spectred`],operator:"==",value:void 0}],some:[{key:"layer",value:"CHARACTER",coordinator:"||"},{key:"layer",value:"ATTACHMENT"}]}},{icon:"/icon.svg",label:"Disable Vision",filter:{every:[{key:["metadata",`${h.SPECTREID}/spectred`],operator:"==",value:void 0}],some:[{key:"layer",value:"CHARACTER",coordinator:"||"},{key:"layer",value:"ATTACHMENT"}]}}],async onClick(i){const e=i.items.every(t=>t.metadata[`${h.EXTENSIONID}/hasVision`]===void 0);await $.scene.items.updateItems(i.items,t=>{for(const n of t)e?(n.metadata[`${h.EXTENSIONID}/hasVision`]=!0,n.metadata[`${h.EXTENSIONID}/visionRange`]===void 0&&(n.metadata[`${h.EXTENSIONID}/visionRange`]=h.VISIONDEFAULT)):delete n.metadata[`${h.EXTENSIONID}/hasVision`]})}}),await $.contextMenu.create({id:`${h.EXTENSIONID}/toggle-groupvision-menu`,icons:[{icon:"/no-vision.svg",label:"Toggle Attachments Vision",filter:{every:[{key:"layer",value:"NOTE"},{key:["metadata",`${h.EXTENSIONID}/hasVision`],value:void 0}]}}],async onClick(i){if(i.items.length>0){const e=i.items.map(n=>n.id),t=await $.scene.items.getItemAttachments(e);await $.scene.items.updateItems(t,n=>{for(const o of n)e.includes(o.attachedTo)&&(o.metadata[`${h.EXTENSIONID}/hasVision`]&&(o.layer=="CHARACTER"||o.layer=="ATTACHMENT")?delete o.metadata[`${h.EXTENSIONID}/hasVision`]:(o.layer=="CHARACTER"||o.layer=="ATTACHMENT")&&(o.metadata[`${h.EXTENSIONID}/hasVision`]=!0,o.metadata[`${h.EXTENSIONID}/visionRange`]===void 0&&(o.metadata[`${h.EXTENSIONID}/visionRange`]=h.VISIONDEFAULT)))})}}}),await $.contextMenu.create({id:`${h.EXTENSIONID}/toggle-vision-line`,icons:[{icon:"/icon.svg",label:"Disable Vision Line",filter:{some:[{key:["metadata",`${h.EXTENSIONID}/isVisionLine`],value:!0,coordinator:"&&"},{key:["metadata",`${h.EXTENSIONID}/disabled`],value:void 0,coordinator:"||"},{key:["metadata",`${h.ARMINDOID}/isVisionLine`],value:!0,coordinator:"&&"},{key:["metadata",`${h.ARMINDOID}/disabled`],value:void 0}]}},{icon:"/no-vision.svg",label:"Enable Vision Line",filter:{some:[{key:["metadata",`${h.EXTENSIONID}/isVisionLine`],value:!0,coordinator:"||"},{key:["metadata",`${h.ARMINDOID}/isVisionLine`],value:!0}]}}],async onClick(i){await $.scene.items.updateItems(i.items,e=>{for(const t of e)t.metadata[`${h.EXTENSIONID}/isVisionLine`]&&t.metadata[`${h.EXTENSIONID}/disabled`]?delete t.metadata[`${h.EXTENSIONID}/disabled`]:t.metadata[`${h.EXTENSIONID}/isVisionLine`]&&(t.metadata[`${h.EXTENSIONID}/disabled`]=!0)})}}),await $.contextMenu.create({id:`${h.EXTENSIONID}/switch-one-sided-type`,icons:[{icon:"/two-sided.svg",label:"Two-sided",filter:{some:[{key:["metadata",`${h.EXTENSIONID}/isVisionLine`],value:!0,coordinator:"&&"},{key:["metadata",`${h.EXTENSIONID}/oneSided`],value:void 0,coordinator:"||"},{key:["metadata",`${h.ARMINDOID}/isVisionLine`],value:!0,coordinator:"&&"},{key:["metadata",`${h.ARMINDOID}/oneSided`],value:void 0}]}},{icon:"/left-sided.svg",label:"One-sided left",filter:{some:[{key:["metadata",`${h.EXTENSIONID}/isVisionLine`],value:!0,coordinator:"&&"},{key:["metadata",`${h.EXTENSIONID}/oneSided`],value:"left",coordinator:"||"},{key:["metadata",`${h.ARMINDOID}/isVisionLine`],value:!0,coordinator:"&&"},{key:["metadata",`${h.ARMINDOID}/oneSided`],value:"left"}]}},{icon:"/right-sided.svg",label:"One-sided right",filter:{some:[{key:["metadata",`${h.EXTENSIONID}/isVisionLine`],value:!0,coordinator:"||"},{key:["metadata",`${h.ARMINDOID}/isVisionLine`],value:!0}]}}],async onClick(i){await $.scene.items.updateItems(i.items,e=>{for(const t of e)(t.metadata[`${h.EXTENSIONID}/isVisionLine`]||t.metadata[`${h.ARMINDOID}/isVisionLine`])&&(t.metadata[`${h.EXTENSIONID}/oneSided`]=="right"||t.metadata[`${h.ARMINDOID}/oneSided`]=="right")?(delete t.metadata[`${h.EXTENSIONID}/oneSided`],delete t.metadata[`${h.ARMINDOID}/oneSided`]):(t.metadata[`${h.EXTENSIONID}/isVisionLine`]||t.metadata[`${h.ARMINDOID}/isVisionLine`])&&(t.metadata[`${h.EXTENSIONID}/oneSided`]=="left"||t.metadata[`${h.ARMINDOID}/oneSided`]=="left")?(t.metadata[`${h.EXTENSIONID}/oneSided`]="right",t.metadata[`${h.ARMINDOID}/oneSided`]="right"):(t.metadata[`${h.EXTENSIONID}/isVisionLine`]||t.metadata[`${h.ARMINDOID}/isVisionLine`])&&(t.metadata[`${h.EXTENSIONID}/oneSided`]="left",t.metadata[`${h.ARMINDOID}/oneSided`]="left")})}}),await $.contextMenu.create({id:`${h.EXTENSIONID}/toggle-fog-background`,icons:[{icon:"/fog-background.svg",label:"Convert To Fog Background",filter:{every:[{key:"layer",value:"MAP"}]}}],async onClick(i){i.items.length>0&&await $.scene.items.updateItems(i.items,e=>{for(let t=0;t<e.length;t++)e[t].zIndex=1,e[t].layer="FOG",e[t].disableHit=!0,e[t].locked=!1,e[t].visible=!1,e[t].metadata[`${h.EXTENSIONID}/isBackgroundMap`]=!0})}}),await $.contextMenu.create({id:`${h.EXTENSIONID}/bounding-grid`,icons:[{icon:"/icon.svg",label:"Smoke Bounding Grid",filter:{every:[{key:["metadata",`${h.EXTENSIONID}/grid`],value:!0}]}}],async onClick(i){await $.notification.show("This is the Smoke&Spectre Bounding Grid. It contains the area your fog can be drawn in. To remove this and have fog contained dynamically by the size of your map(s), turn on AutoDetect Maps in Settings.","INFO")}}),await $.contextMenu.create({id:`${h.EXTENSIONID}/toggle-door`,icons:[{icon:"/opendoor.svg",label:"Enable Door",filter:{every:[{key:"layer",value:"DRAWING"},{key:["metadata",`${h.EXTENSIONID}/isDoor`],value:void 0},{key:["metadata",`${h.EXTENSIONID}/doorId`],value:void 0},{key:["metadata",`${h.EXTENSIONID}/grid`],value:void 0}],roles:["GM"]}},{icon:"/closedoor.svg",label:"Disable Door",filter:{every:[{key:"layer",value:"DRAWING"},{key:["metadata",`${h.EXTENSIONID}/doorId`],value:void 0},{key:["metadata",`${h.EXTENSIONID}/grid`],value:void 0}],roles:["GM"]}}],async onClick(i){const e=i.items.every(t=>t.metadata[`${h.EXTENSIONID}/isDoor`]===void 0);await $.scene.items.updateItems(i.items,t=>{for(const n of t)e?n.metadata[`${h.EXTENSIONID}/isDoor`]=!0:delete n.metadata[`${h.EXTENSIONID}/isDoor`]}),e?await zt(i.items):await jr(i.items)}})}async function Qt(i){i?await $.contextMenu.create({id:`${h.EXTENSIONID}/toggle-autohide-menu`,icons:[{icon:"/autohide-off.svg",label:"Enable Autohide",filter:{every:[{key:"layer",value:"CHARACTER"},{key:["metadata",`${h.EXTENSIONID}/hasAutohide`],value:void 0}],roles:["GM"]}},{icon:"/autohide-on.svg",label:"Disable Autohide",filter:{every:[{key:"layer",value:"CHARACTER"}],roles:["GM"]}}],async onClick(e){const t=e.items.every(n=>n.metadata[`${h.EXTENSIONID}/hasAutohide`]===void 0);await $.scene.items.updateItems(e.items,n=>{for(const o of n)t?o.metadata[`${h.EXTENSIONID}/hasAutohide`]=!0:delete o.metadata[`${h.EXTENSIONID}/hasAutohide`]})}}):await $.contextMenu.remove(`${h.EXTENSIONID}/toggle-autohide-menu`)}async function Rn(){let i,e;[S.items,S.metadata,S.gridDpi,S.gridScale,i,e]=await Promise.all([$.scene.items.getItems(),$.scene.getMetadata(),$.scene.grid.getDpi(),$.scene.grid.getScale(),$.scene.fog.getFilled(),$.scene.fog.getColor()]),await $.scene.items.deleteItems(S.items.filter(Et).map(n=>n.id)),S.snap=!0,S.gridScale=S.gridScale?.parsed?.multiplier??5,S.fog={filled:i,style:{color:e,strokeWidth:5}};let t;if(S.items.filter(Dr).length==0){const n=S.items.filter(r=>r.layer=="MAP"&&tn(r)),o=n.map(r=>r.image.width*r.image.height/Math.pow(r.grid.dpi,2));t=n[o.indexOf(Math.max(...o))]}if(S.metadata[`${h.EXTENSIONID}/autodetectEnabled`]===void 0&&(S.role==="GM"&&(ne.autodetectCheckbox.checked=!0),await $.scene.setMetadata({[`${h.EXTENSIONID}/autodetectEnabled`]:!0})),Qt(S.metadata[`${h.EXTENSIONID}/fowEnabled`]==!0),S.metadata[`${h.EXTENSIONID}/sceneId`]===void 0)await $.scene.setMetadata({[`${h.EXTENSIONID}/sceneId`]:crypto.randomUUID()});else try{const n=S.metadata[`${h.EXTENSIONID}/sceneId`],o=localStorage.getItem(`${h.EXTENSIONID}/fogCache/${S.userId}/${n}`);if(o!==null&&S.metadata[`${h.EXTENSIONID}/persistenceEnabled`]===!0){const r=JSON.parse(o),l=[];for(let u=0;u<r.length;u++){const m=St().commands(r[u].commands).fillRule("evenodd").locked(!0).visible(!1).fillColor("#000000").strokeColor("#000000").layer("FOG").name("Fog of War").metadata({[`${h.EXTENSIONID}/isVisionFog`]:!0,[`${h.EXTENSIONID}/digest`]:r[u].digest}).build();m.zIndex=3,l.push(m)}await $.scene.local.addItems(l)}}catch{}S.role=="GM"&&(await ta(),ne.mapSubmit.onclick=async()=>{await $.scene.items.updateItems([h.GRIDID],n=>{for(const o of n){const r=o;r.width=S.gridDpi*+ne.mapWidth.value,r.height=S.gridDpi*+ne.mapHeight.value,r.scale={x:1,y:1}}})},await ne.UpdateUI(),t!==void 0&&await $.scene.items.updateItems([t],n=>{n[0].metadata[`${h.EXTENSIONID}/isBackgroundImage`]=!0})),S.initialized=!0}async function Zi(){const i=S.items.filter(Ci);if(!S.metadata[`${h.EXTENSIONID}/autodetectEnabled`]&&i.length==0){let e=xi().width(S.gridDpi*30).height(S.gridDpi*30).visible(!1).shapeType("RECTANGLE").visible(!0).locked(!1).strokeColor("pink").strokeOpacity(.5).fillOpacity(0).strokeDash([200,500]).strokeWidth(50).build();e.metadata[`${h.EXTENSIONID}/isBackgroundImage`]=!0,e.metadata[`${h.EXTENSIONID}/grid`]=!0,e.id=h.GRIDID,await $.scene.items.addItems([e])}S.metadata[`${h.EXTENSIONID}/autodetectEnabled`]===!0&&i.length>0&&await $.scene.items.deleteItems([h.GRIDID])}function ca(i){function e(){document.getElementById("contextMenu").style.display="none"}const t=document.getElementById(`tr-${i.id}`);if(t){const n=t.getElementsByClassName("token-name")[0],o=t.getElementsByClassName("token-vision-range")[0],r=t.getElementsByClassName("unlimited-vision")[0],l=t.getElementsByClassName("no-vision")[0];n&&(n.innerText=i.name),o&&!r.checked&&!l.checked&&(o.value=i.metadata[`${h.EXTENSIONID}/visionRange`]!==void 0?i.metadata[`${h.EXTENSIONID}/visionRange`]:h.VISIONDEFAULT),r&&(r.checked=i.metadata[`${h.EXTENSIONID}/visionRange`]===0),l&&(l.checked=i.metadata[`${h.EXTENSIONID}/visionBlind`]),r.checked||l.checked?o.setAttribute("disabled","disabled"):o.removeAttribute("disabled")}else{const n=S.metadata[`${h.EXTENSIONID}/USER-${i.createdUserId}`];let o=n?.color,r=n?.name?`This token is owned by ${n.name}.`:"This token is owned by you.";!o&&i.createdUserId!==S.userId&&(o="#aeb0af",r="This tokens owner is not in the room currently.");const l=S.items.find(k=>k.id===i.id),u=document.createElement("tr");u.id=`tr-${l.id}`,u.className="token-table-entry",u.innerHTML=`<td id="contextLocator" title="${r}" ${o==="#aeb0af"?'style="color:black !important; font-style: italic;" ':""}data-color="${o}" class="token-name">${l.name}</td>
                           <td class="token-vision-container" title="The unit of measurement for your grid"><input class="token-vision-range" type="number" value=${h.VISIONDEFAULT}><span class="unit">units</span></td>
                           <td class="token-vision-container-grid">
                            <div class="vision-container-div">
                                <label class="cbutton" title="Unlimited vision range"><input type="checkbox" class="unlimited-vision"><span class="emoji">&infin;</span></label>
                                <label class="cbutton" title="Turn token into a light source"><input type="checkbox" class="torch-vision"><span class="emoji">&#128294;</span></label>
                                <label class="cbutton" title="Disable vision on this token"><input type="checkbox" class="no-vision"><span class="emoji">&#8856;</span></label>
                            </div>
                           </td>`,ne.table.appendChild(u);const m=u.getElementsByClassName("token-vision-range")[0],y=u.getElementsByClassName("unlimited-vision")[0],N=u.getElementsByClassName("torch-vision")[0],C=u.getElementsByClassName("no-vision")[0];u.getElementsByClassName("token-name")[0].style.textShadow=`
        -2px -2px 2px ${o},
        2px -2px 2px ${o},
        -2px 2px 2px ${o},
        2px 2px 2px ${o}`,m&&!y.checked&&!C.checked&&(m.value=i.metadata[`${h.EXTENSIONID}/visionRange`]?i.metadata[`${h.EXTENSIONID}/visionRange`]:h.VISIONDEFAULT),y&&(y.checked=i.metadata[`${h.EXTENSIONID}/visionRange`]===0),N&&(N.checked=i.metadata[`${h.EXTENSIONID}/visionTorch`]),C&&(C.checked=i.metadata[`${h.EXTENSIONID}/visionBlind`]),y.checked||C.checked?m.setAttribute("disabled","disabled"):m.removeAttribute("disabled"),m.onchange=async k=>{if(!k||!k.target)return;const X=S.items.find(O=>O.id===i.id),b=k.target,P=parseInt(b.value);P<0&&(b.value="0"),P>999&&(b.value="999"),await $.scene.items.updateItems([X],O=>{O[0].metadata[`${h.EXTENSIONID}/visionRange`]=P})},y.onclick=async k=>{if(!k||!k.target)return;const X=S.items.find(O=>O.id===i.id);let b=0;k.target.checked?(m.setAttribute("disabled","disabled"),C.checked=!1):(b=parseInt(m.value),m.removeAttribute("disabled")),await $.scene.items.updateItems([X],O=>{O[0].metadata[`${h.EXTENSIONID}/visionRange`]=b})},C.onclick=async k=>{if(!k||!k.target)return;const X=S.items.find(P=>P.id===i.id),b=k.target;b.checked?m.setAttribute("disabled","disabled"):m.removeAttribute("disabled"),await $.scene.items.updateItems([X],P=>{P[0].metadata[`${h.EXTENSIONID}/visionBlind`]=b.checked})},N.onclick=async k=>{if(!k||!k.target)return;const X=S.items.find(P=>P.id===i.id),b=k.target;await $.scene.items.updateItems([X],P=>{P[0].metadata[`${h.EXTENSIONID}/visionTorch`]=b.checked})},m.addEventListener("mousewheel",async()=>{}),u.oncontextmenu=async function(k){k.preventDefault();const X=k.currentTarget,b=document.getElementById("contextMenu"),P=A=>{A.preventDefault()},O=async A=>{const B=A.target,U=b.getAttribute("currentUnit"),Y=S.players.find(g=>B.id===g.id)?.color,I=document.getElementById(`tr-${U}`).getElementsByClassName("token-name")[0];Y?I.style.textShadow=`
                    -2px -2px 2px ${Y},
                    2px -2px 2px ${Y},
                    -2px 2px 2px ${Y},
                    2px 2px 2px ${Y}`:I.style.textShadow="",await $.scene.items.updateItems([U],g=>{for(const E of g)E.createdUserId=B.id}),b.style.display="none",A.stopPropagation(),window.removeEventListener("click",M),b.removeEventListener("click",O),b.removeEventListener("contextmenu",P)};b.setAttribute("currentUnit",X.id.substring(3));const M=()=>{b.style.display="none",window.removeEventListener("click",M),b.removeEventListener("click",O),b.removeEventListener("contextmenu",P)};if(b.addEventListener("click",O),b.addEventListener("contextmenu",P),window.addEventListener("click",M),b.style.display=="block")e();else{const A=Math.min(k.pageX,window.innerWidth-150),B=Math.min(k.pageY,(window.innerHeight>300?window.innerHeight-50:window.innerHeight)-120);b.style.display="block",b.style.left=A+"px",b.style.top=B+"px"}}}}let tt=null;const ua="#000000",da=8,fa=[];async function Ji(){await $.popover.close(h.LINETOOLID),await $.player.setMetadata({[`${h.EXTENSIONID}/finishLine`]:!1})}async function Qi(){if(!tt)return;const[i,e]=tt;e(),tt=null,await Ji(),await $.player.setMetadata({[`${h.EXTENSIONID}/cancelLine`]:!1})}async function er(){if(!tt)return;const[i,e]=tt,t=i(n=>{n.visible=!1,n.metadata[`${h.EXTENSIONID}/isVisionLine`]=!0,n.points.pop()});t.points.length>=2&&await $.scene.items.addItems([t]),e(),tt=null,await Ji(),await $.player.setMetadata({[`${h.EXTENSIONID}/finishLine`]:!1})}async function pa(i,e){if(!e.transformer)if(tt){const[t]=tt;t(n=>{n.points.push(e.pointerPosition)})}else{const t=en().tension(0).points([e.pointerPosition,e.pointerPosition]).strokeColor(S.metadata[`${h.EXTENSIONID}/toolColor`]??ua).strokeDash(S.metadata[`${h.EXTENSIONID}/toolStyle`]??fa).strokeWidth(S.metadata[`${h.EXTENSIONID}/toolWidth`]??da).fillOpacity(0).fillColor("#000000").layer("DRAWING").name("Vision Line (Line)").closed(!1).locked(!0).build();tt=await $.interaction.startItemInteraction(t),await $.popover.open({id:h.LINETOOLID,url:"/pages/line.html",height:70,width:350,disableClickAway:!0})}}function ha(i,e){if(!tt||e.transformer)return;const[t]=tt,n=Math.round(S.gridDpi/S.gridSnap),o=Math.round(e.pointerPosition.x/S.gridDpi)*S.gridDpi,r=Math.round(e.pointerPosition.y/S.gridDpi)*S.gridDpi,l=Math.abs(o-e.pointerPosition.x),u=Math.abs(r-e.pointerPosition.y);let m,y;l<=n?m=o:m=e.pointerPosition.x,u<=n?y=r:y=e.pointerPosition.y,t(N=>{N.points[N.points.length-1]=S.snap?{x:m,y}:e.pointerPosition})}function ma(i,e){tt&&(e.key=="Escape"?Qi():e.key=="Enter"&&er())}const kn={onToolClick:pa,onToolMove:ha,onKeyDown:ma};let nt=null;const ga="#000000",ya=8,va=[];async function tr(){await $.popover.close(h.POLYTOOLID)}async function nr(){if(!nt)return;const[i,e]=nt;e(),nt=null,tr(),await $.player.setMetadata({[`${h.EXTENSIONID}/cancelPoly`]:!1})}async function ir(){if(!nt)return;const[i,e]=nt,t=i(n=>{n.visible=!1,n.metadata[`${h.EXTENSIONID}/isVisionLine`]=!0,n.points.pop(),n.points.push(n.points[0])});t.points.length>=4&&await $.scene.items.addItems([t]),e(),nt=null,tr(),await $.player.setMetadata({[`${h.EXTENSIONID}/finishPoly`]:!1})}async function Ia(i,e){if(!e.transformer)if(nt){const[t]=nt;t(n=>{n.points.push(e.pointerPosition)})}else{const t=en().tension(0).points([e.pointerPosition,e.pointerPosition]).strokeColor(S.metadata[`${h.EXTENSIONID}/toolColor`]??ga).strokeDash(S.metadata[`${h.EXTENSIONID}/toolStyle`]??va).strokeWidth(S.metadata[`${h.EXTENSIONID}/toolWidth`]??ya).fillOpacity(.5).fillColor("#000000").layer("DRAWING").name("Vision Line (Polygon)").locked(!0).build();nt=await $.interaction.startItemInteraction(t),await $.popover.open({id:h.POLYTOOLID,url:"/pages/polygon.html",height:70,width:350,disableClickAway:!0})}}function Ea(i,e){if(!nt||e.transformer)return;const[t]=nt,n=Math.round(S.gridDpi/S.gridSnap),o=Math.round(e.pointerPosition.x/S.gridDpi)*S.gridDpi,r=Math.round(e.pointerPosition.y/S.gridDpi)*S.gridDpi,l=Math.abs(o-e.pointerPosition.x),u=Math.abs(r-e.pointerPosition.y);let m,y;l<=n?m=o:m=e.pointerPosition.x,u<=n?y=r:y=e.pointerPosition.y,t(N=>{N.points[N.points.length-1]=S.snap?{x:m,y}:e.pointerPosition})}function wa(i,e){nt&&(e.key=="Escape"?nr():e.key=="Enter"&&ir())}const xn={onToolClick:Ia,onToolMove:Ea,onKeyDown:wa};function rr(){const i=$.scene.fog.onChange(y=>{S.fog=y}),e=$.scene.onReadyChange(async y=>{S.ready=y,y?(m(),await Rn(),await yt(),rr()):S.role=="GM"&&(S.initialized=!1,await ne.UpdateUI())}),t=$.scene.grid.onChange(async y=>{S.gridDpi=y.dpi,S.gridScale=parseInt(y.scale),S.ready&&await yt()}),n=$.scene.onMetadataChange(async y=>{S.metadata=y;const N=y[`${h.EXTENSIONID}/triggerReset`];if(N!==""&&N!==S.lastReset){S.lastReset=N;const C=await $.scene.local.getItems(Cn);await $.scene.local.deleteItems(C.map(X=>X.id));const k=S.metadata[`${h.EXTENSIONID}/sceneId`];localStorage.removeItem(`${h.EXTENSIONID}/fogCache/${S.userId}/${k}`),await yt()}else S.role==="GM"&&await Zi(),S.ready&&await yt()}),o=$.scene.items.onChange(async y=>{S.items=y,S.ready&&(S.role=="GM"?(await ne.UpdateUI(),await Mn(ne.mapAlign)):ne.UpdatePlayerVisionList(y),await yt())}),r=$.player.onChange(async y=>{S.userColor!==y.color&&(S.userColor=y.color),S.role!==y.role&&(S.role=y.role,S.role==="GM"&&(await $.action.setHeight(510),await $.action.setWidth(420)),await $.scene.setMetadata({[`${h.EXTENSIONID}/USER-${S.userId}`]:{role:S.role,name:S.userName,color:S.userColor}}),await ne.SoftReset(S.role),S.role==="PLAYER"&&ne.UpdatePlayerVisionList(S.items));const N=document.querySelectorAll(".token-table-entry");for(let O of N){let M=O.id.substring(3);y.selection!==void 0&&y.selection.includes(M)?O.classList.add("token-table-selected"):O.classList.remove("token-table-selected")}y.selection!==void 0&&y.selection.length===1&&Hr(y.selection[0]);const C=y.metadata;(C[`${h.EXTENSIONID}/finishLine`]??!1)===!0&&er(),(C[`${h.EXTENSIONID}/cancelLine`]??!1)===!0&&Qi(),(C[`${h.EXTENSIONID}/finishPoly`]??!1)===!0&&ir(),(C[`${h.EXTENSIONID}/cancelPoly`]??!1)===!0&&nr()}),l=$.party.onChange(async y=>{if(S.players=y,S.role==="PLAYER")await Qo(y);else{const N=document.getElementById("playerListing");N.innerHTML="",N.appendChild(ne.GetEmptyContextItem());for(const C of y){const k=document.createElement("li");k.id=C.id,k.textContent=C.name,k.style.color=C.color,N.appendChild(k)}ea(),ne.UpdatePlayerProcessUI(y)}}),u=$.theme.onChange(y=>{Yi(y,document)});function m(){u(),l(),r(),o(),n(),t(),e(),i()}}function _i(){ne.processedIndicator.onclick=async()=>{await $.popover.open({id:h.PROCESSEDID,url:"/pages/processed.html",height:300,width:300,disableClickAway:!1})},ne.visionCheckbox.onclick=async t=>{if(!S.ready||!t.target){t.preventDefault();return}const n=t.target;await $.scene.setMetadata({[`${h.EXTENSIONID}/visionEnabled`]:n.checked}),await $.scene.fog.setFilled(n.checked)},ne.snapCheckbox.checked=!0,ne.snapCheckbox.onclick=async t=>{if(!S.ready||!t.target){t.preventDefault();return}const n=t.target;S.snap=n.checked},ne.settingsButton.onclick=async t=>{!t||!t.target||(ne.settingsUIDiv.style.display==="block"?(ne.settingsUIDiv.style.display="none",ne.mainUIDiv.style.display="block"):(ne.settingsUIDiv.style.display="block",ne.mainUIDiv.style.display="none"))},ne.persistenceCheckbox.onclick=async t=>{if(!t||!t.target)return;const n=t.target;await $.scene.setMetadata({[`${h.EXTENSIONID}/persistenceEnabled`]:n.checked})},ne.autodetectCheckbox.onclick=async t=>{if(!t||!t.target)return;const n=t.target;await $.scene.setMetadata({[`${h.EXTENSIONID}/autodetectEnabled`]:n.checked}),ne.boundryOptions.style.display=n.checked?"none":"",await Zi()},ne.fowCheckbox.onclick=async t=>{if(!t||!t.target)return;const n=t.target;await Qt(n.checked),await $.scene.setMetadata({[`${h.EXTENSIONID}/fowEnabled`]:n.checked})},ne.doorCheckbox.onclick=async t=>{if(!t||!t.target)return;const n=t.target;await $.scene.setMetadata({[`${h.EXTENSIONID}/playerDoors`]:n.checked})},ne.resetButton.onclick=async t=>{!t||!t.target||await $.scene.setMetadata({[`${h.EXTENSIONID}/triggerReset`]:new Date().toLocaleTimeString()})},ne.debugButton.onclick=async t=>{!t||!t.target||(ne.debugDiv.style.display=="none"?(ne.debugDiv.style.display="grid",ne.debugButton.value="Disable Debugging"):(ne.debugDiv.style.display="none",ne.debugButton.value="Enable Debugging"),await $.scene.setMetadata({[`${h.EXTENSIONID}/debug`]:ne.debugDiv.style.display==="grid"}))},ne.unlockFogButton.onclick=async t=>{!t||!t.target||await $.scene.items.updateItems(ai,n=>{for(let o of n)o.locked=!1})},ne.lockFogButton.onclick=async t=>{!t||!t.target||await $.scene.items.updateItems(ai,n=>{for(let o of n)o.locked=!0})},ne.backgroundButton.onclick=async t=>{!t||!t.target||(t.target,await $.scene.items.updateItems(n=>n.layer=="FOG"&&n.metadata[`${h.EXTENSIONID}/isBackgroundMap`]===!0,n=>{for(let o=0;o<n.length;o++)n[o].layer="MAP",n[o].disableHit=!1,n[o].locked=!1,n[o].visible=!0,delete n[o].metadata[`${h.EXTENSIONID}/isBackgroundMap`]}))};let i;ne.fowColor.onclick=()=>{Je({el:`#${ne.fowColor.id}`,alpha:!0,forceAlpha:!0})},ne.fowColor.oninput=async t=>{if(!t||!t.target)return;const n=t.target;clearTimeout(i),i=setTimeout(async()=>{if(/#[a-f0-9]{8}/.test(n.value)){await $.scene.setMetadata({[`${h.EXTENSIONID}/fowColor`]:n.value});const r=await $.scene.local.getItems(Ht);await $.scene.local.deleteItems(r.map(l=>l.id))}},500)},ne.convertButton.onclick=async t=>{if(!(!t||!t.target)&&window.confirm(`WARNING: THIS CANNOT BE UNDONE.

This operation will remove all metadata from the original dynamic fog extension, and will break fog lines and other things if you do not continue using Smoke!.

WARNING: THIS CANNOT BE UNDONE.

Are you REALLY sure?`)){const n=await $.scene.getMetadata();for(const r in n)r.substring(0,r.indexOf("/"))==h.ARMINDOID&&await $.scene.setMetadata({[`${r}`]:void 0});const o=await $.scene.items.getItems();await $.scene.items.updateItems(o,r=>{for(const l of r)l.metadata[`${h.ARMINDOID}/isVisionLine`]!==void 0&&(l.metadata[`${h.EXTENSIONID}/isVisionLine`]=l.metadata[`${h.ARMINDOID}/isVisionLine`],delete l.metadata[`${h.ARMINDOID}/isVisionLine`]),l.metadata[`${h.ARMINDOID}/disabled`]!==void 0&&(l.metadata[`${h.EXTENSIONID}/disabled`]=l.metadata[`${h.ARMINDOID}/disabled`],delete l.metadata[`${h.ARMINDOID}/disabled`])})}};var e;ne.importFile.onchange=t=>{if(ne.importButton.disabled=!0,!t||!t.target)return;const n=t.target;if(!n.files)return;const o=n.files[0];if(o.type!=="text/javascript"&&o.type,o){var r=new FileReader;r.onload=function(l){if(!l||!l.target){ne.importErrors.innerText="Invalid import event";return}const u=l.target;if(!u.result){ne.importErrors.innerText="Unable to read imported file";return}const m=u.result;e=JSON.parse(m),e&&(e.walls&&e.walls.length||e.line_of_sight&&e.line_of_sight.length)?ne.importButton.disabled=!1:ne.importErrors.innerText="Imported file has no walls"},r.readAsText(o)}else ne.importErrors.innerText="Failed to load file"},ne.importButton.onclick=async t=>{!t||!t.target||(t.target,oa(ne.importFormat.value,e,ne.dpiAutodetect.checked?0:Number.parseInt(ne.importDpi.value),ne.mapAlign.value,ne.importErrors))},ne.toolColor.onclick=async t=>{Je({el:`#${ne.toolColor.id}`,alpha:!1,forceAlpha:!1})},ne.toolColor.oninput=async t=>{if(!t||!t.target)return;const n=t.target;clearTimeout(i),i=setTimeout(async()=>{/#[a-f0-9]{6}/.test(n.value)&&await $.scene.setMetadata({[`${h.EXTENSIONID}/toolColor`]:n.value})},400)},ne.toolStyle.onchange=async t=>{const n=t.currentTarget;await $.scene.setMetadata({[`${h.EXTENSIONID}/toolStyle`]:n.value=="solid"?[]:[25,25]})},ne.toolWidth.onchange=t=>{const n=t.currentTarget;clearTimeout(i),i=setTimeout(async()=>{await $.scene.setMetadata({[`${h.EXTENSIONID}/toolWidth`]:n.value})},400)},ne.whatsNewButton.onclick=async function(){ne.whatsNewIcon?.classList.remove("new-shine"),await $.modal.open({id:h.EXTENSIONWHATSNEW,url:"/pages/whatsnew.html",height:500,width:400})},Je({themeMode:"dark",alpha:!0,forceAlpha:!0,el:"#fow_color"}),Je({themeMode:"dark",alpha:!1,forceAlpha:!1,el:"#tool_color"})}const or="#000000",ba=8,Sa=[];let pt=[];async function ar(){pt=[];const i=await $.scene.local.getItems(Lr);await $.scene.local.deleteItems(i.map(e=>e.id)),await $.popover.close(h.BRUSHTOOLID)}async function Ta(i,e){await sr(e.pointerPosition)}async function Na(){await $.popover.open({id:h.BRUSHTOOLID,url:"/pages/brush.html",height:70,width:350,disableClickAway:!0})}async function _a(){await $.popover.close(h.BRUSHTOOLID)}async function Oa(i,e){await sr(e.pointerPosition)}async function ka(i,e){await Da(),await ar()}async function xa(i,e){await ar()}async function sr(i){const e={x:Math.floor(i.x/S.gridDpi),y:Math.floor(i.y/S.gridDpi)};if(!pt.some(n=>n.x===e.x&&n.y===e.y)){const n={x:e.x*S.gridDpi,y:e.y*S.gridDpi},o={x:(e.x+1)*S.gridDpi,y:e.y*S.gridDpi},r={x:e.x*S.gridDpi,y:(e.y+1)*S.gridDpi},l={x:(e.x+1)*S.gridDpi,y:(e.y+1)*S.gridDpi},u=[[kt.MOVE,n.x,n.y],[kt.LINE,o.x,o.y],[kt.LINE,l.x,l.y],[kt.LINE,r.x,r.y],[kt.CLOSE]],m=St().commands(u).strokeOpacity(0).fillOpacity(.5).fillColor(S.metadata[`${h.EXTENSIONID}/toolColor`]??or).build();m.metadata[`${h.EXTENSIONID}/isBrushSquare`]=!0,pt.push(e),await $.scene.local.addItems([m])}}async function Da(){const i=[];for(const l of pt){const{x:u,y:m}=l,y={x:u*S.gridDpi,y:m*S.gridDpi},N={x:(u+1)*S.gridDpi,y:m*S.gridDpi},C={x:u*S.gridDpi,y:(m+1)*S.gridDpi},k={x:(u+1)*S.gridDpi,y:(m+1)*S.gridDpi};if(!pt.some(X=>X.x===u&&X.y===m-1)){const X=y,b=N;i.push({Start:X,End:b})}if(!pt.some(X=>X.x===u&&X.y===m+1)){const X=C,b=k;i.push({Start:X,End:b})}if(!pt.some(X=>X.x===u-1&&X.y===m)){const X=y,b=C;i.push({Start:X,End:b})}if(!pt.some(X=>X.x===u+1&&X.y===m)){const X=N,b=k;i.push({Start:X,End:b})}}const e=cr(i),t=lr(e),n=$a(t),o=25,r=n.length;for(let l=0;l<r;l+=o){const u=n.slice(l,l+o);await $.scene.items.addItems(u)}}function lr(i){let e=[],t=[],n=!1;for(const o of i){const r=o.Start.x===o.End.x?i.filter(m=>m.Start.x===m.End.x):i.filter(m=>m.Start.y===m.End.y),l=o.Start.x===o.End.x?r.filter(m=>m.Start.x===o.Start.x&&m.End.x===o.End.x):r.filter(m=>m.Start.y===o.Start.y&&m.End.y===o.End.y),u=o.Start.x!==o.End.x?l.find(m=>m.Start.x>o.Start.x&&m.Start.x<o.End.x):l.find(m=>m.Start.y>o.Start.y&&m.Start.y<o.End.y);if(u){const m=Aa(o,u);t.push(m),e.push(o),e.push(u),t=t.filter(y=>y!==o&&y!==u),n=!0}else e.includes(o)||t.push(o)}return n?lr(t):t}function cr(i){let e=[],t=[],n=!1;for(const o of i){const l=(o.Start.x===o.End.x?i.filter(u=>u.Start.x===u.End.x):i.filter(u=>u.Start.y===u.End.y)).find(u=>u.Start.x===o.End.x&&u.Start.y===o.End.y);if(l){const u=Ca(o,l);t.push(u),e.push(o),e.push(l),t=t.filter(m=>m!==o&&m!==l),n=!0}else e.includes(o)||t.push(o)}return n?cr(t):t}function Ca(i,e){return{Start:i.Start,End:e.End}}function Aa(i,e){const t=Math.min(i.Start.x,e.Start.x),n=Math.min(i.Start.y,e.Start.y),o=Math.max(i.End.x,e.End.x),r=Math.max(i.End.y,e.End.y);return{Start:{x:t,y:n},End:{x:o,y:r}}}function $a(i){const e=[];for(const t of i){const n=en().tension(0).points([t.Start,t.End]).strokeColor(S.metadata[`${h.EXTENSIONID}/toolColor`]??or).strokeDash(S.metadata[`${h.EXTENSIONID}/toolStyle`]??Sa).strokeWidth(S.metadata[`${h.EXTENSIONID}/toolWidth`]??ba).fillOpacity(0).fillColor("#000000").layer("DRAWING").name("Vision Line (Brushed)").closed(!1).locked(!0).build();n.visible=!1,n.metadata[`${h.EXTENSIONID}/isVisionLine`]=!0,e.push(n)}return e}const It={onActivate:Na,onDeactivate:_a,onDragStart:Ta,onDragMove:Oa,onDragEnd:ka,onDragCancel:xa};async function Oi(){await $.tool.create({id:`${h.EXTENSIONID}/vision-tool`,icons:[{icon:"/icon.svg",label:"Setup Vision"}],async onClick(){await $.tool.activateTool(`${h.EXTENSIONID}/vision-tool`)}}),await $.tool.createMode({id:`${h.EXTENSIONID}/add-vision-polygon-mode`,icons:[{icon:"/object.svg",label:"Add Obstruction Object",filter:{activeTools:[`${h.EXTENSIONID}/vision-tool`]}}],onToolDown:xn.onToolClick,onToolMove:xn.onToolMove,onKeyDown:xn.onKeyDown,preventDrag:{dragging:!1}}),await $.tool.createMode({id:`${h.EXTENSIONID}/add-vision-line-mode`,icons:[{icon:"/line.svg",label:"Add Obstruction Line",filter:{activeTools:[`${h.EXTENSIONID}/vision-tool`]}}],onToolDown:kn.onToolClick,onToolMove:kn.onToolMove,onKeyDown:kn.onKeyDown,preventDrag:{dragging:!1}}),await $.tool.createMode({id:`${h.EXTENSIONID}/add-vision-brush-mode`,icons:[{icon:"/brush.svg",label:"Paint Obstructions by Grid",filter:{activeTools:[`${h.EXTENSIONID}/vision-tool`]}}],onToolDown:It.onActivate,onToolUp:It.onDeactivate,onToolDragStart:It.onDragStart,onToolDragMove:It.onDragMove,onToolDragEnd:It.onDragEnd,onToolDragCancel:It.onDragCancel})}class Pa{mainWindow=document.getElementById("app");mainUIDiv;playerListContainer;settingsUIDiv;visionCheckbox;snapCheckbox;table;message;mapHeight;mapWidth;mapSubmit;whatsNewButton;whatsNewIcon;processedIndicator;persistenceCheckbox;autodetectCheckbox;fowCheckbox;doorCheckbox;fowColor;resetButton;convertButton;settingsButton;boundryOptions;debugDiv;debugButton;backgroundButton;lockFogButton;unlockFogButton;toolWidth;toolColor;toolStyle;importButton;importFile;mapAlign;importErrors;dpiAutodetect;importDpi;importFormat;version;constructor(e){this.version=`SMOKEANDSPECTRE-${e}`}SetupGMElements(){this.mainWindow.innerHTML=`
        <div>
            <div>
                <div id="localStorageWarning"></div>
                <div class="title">
                <button class="circle-button" id="processedIndicator"></button>
                    Smoke!
                    <input type="checkbox" id="vision_checkbox" class="large" title="Enable Dynamic Fog">
                    <div class="tooltip" id="settings_button" title="Settings"><svg class="svgclickable" fill="#fff" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><path d="M.63 11.08zm.21.41v-.1zm.23.38L1 11.68zM1 11.68l-.11-.19zm-.21-.29c-.06-.1-.11-.21-.16-.31.05.1.1.21.16.31zm.32.54v-.06z"/><path d="m11.26 12.63 1.83 1.09a7.34 7.34 0 0 0 1-.94 7.48 7.48 0 0 0 1.56-2.86l-1.74-1A5.29 5.29 0 0 0 14 8a5.29 5.29 0 0 0-.08-.9l1.74-1a7.45 7.45 0 0 0-1.33-2.58 7.54 7.54 0 0 0-1.24-1.22l-1.83 1.04a6 6 0 0 0-1.11-.53v-2A8.55 8.55 0 0 0 7.94.53a8.39 8.39 0 0 0-2.26.3v2a7.23 7.23 0 0 0-1.12.54L2.78 2.28A7.46 7.46 0 0 0 .2 6.06l1.72 1a5.29 5.29 0 0 0-.08.9 5.29 5.29 0 0 0 .08.9l-1.73 1a8 8 0 0 0 .43 1.15c.05.1.1.21.16.31v.1l.11.19.12.19v.06a7.69 7.69 0 0 0 1.64 1.78l1.81-1.08a7.23 7.23 0 0 0 1.12.54v2a8.39 8.39 0 0 0 2.26.31 8.56 8.56 0 0 0 2.22-.3v-2a6 6 0 0 0 1.2-.48zm-2.39 1.52a7.57 7.57 0 0 1-.95.06 7.73 7.73 0 0 1-1-.06v-1.69a4.92 4.92 0 0 1-2.53-1.27l-1.54.92a6.22 6.22 0 0 1-1.08-1.61l1.56-.93a4.27 4.27 0 0 1 0-3.17l-1.56-.92a6.11 6.11 0 0 1 1.12-1.62l1.56.93A5 5 0 0 1 7 3.53V1.82a7.73 7.73 0 0 1 1-.06 7.57 7.57 0 0 1 .95.06v1.72a4.9 4.9 0 0 1 2.4 1.26l1.59-.94a6.31 6.31 0 0 1 1.11 1.62l-1.6.94a4.35 4.35 0 0 1 .3 1.58 4.44 4.44 0 0 1-.29 1.55l1.56.93a6.43 6.43 0 0 1-1.11 1.61l-1.58-.93a5 5 0 0 1-2.49 1.28z"/><path d="M7.92 5.49A2.59 2.59 0 0 0 5.25 8a2.59 2.59 0 0 0 2.67 2.51A2.6 2.6 0 0 0 10.6 8a2.6 2.6 0 0 0-2.68-2.51zM8 9.2A1.35 1.35 0 0 1 6.55 8 1.35 1.35 0 0 1 8 6.7 1.35 1.35 0 0 1 9.39 8 1.35 1.35 0 0 1 8 9.2z"/></svg></div>
                    <div class="tooltip" id="whatsnewbutton" title="Whats New"><svg id="whatsNewIcon" class="svgclickable" fill="#fff" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 3a7 7 0 100 14 7 7 0 000-14zm-9 7a9 9 0 1118 0 9 9 0 01-18 0zm8-4a1 1 0 011-1h.01a1 1 0 110 2H10a1 1 0 01-1-1zm.01 8a1 1 0 102 0V9a1 1 0 10-2 0v5z"/></svg></div>
                </div>
                <hr>
                ${h.SETTINGSPAGE}
                ${h.MAINPAGE}
                ${h.DEBUGPAGE}
            </div>
        </div>
        `,this.mainWindow.parentElement.style.placeItems="start",this.mainUIDiv=document.getElementById("main-ui"),this.settingsUIDiv=document.getElementById("settings-ui"),this.visionCheckbox=document.getElementById("vision_checkbox"),this.snapCheckbox=document.getElementById("snap_checkbox"),this.table=document.getElementById("token_list"),this.message=document.getElementById("no_tokens_message"),this.mapHeight=document.getElementById("mapHeight"),this.mapWidth=document.getElementById("mapWidth"),this.mapSubmit=document.getElementById("mapSubmit"),this.whatsNewButton=document.getElementById("whatsnewbutton"),this.whatsNewIcon=document.getElementById("whatsNewIcon"),this.processedIndicator=document.getElementById("processedIndicator"),this.persistenceCheckbox=document.getElementById("persistence_checkbox"),this.autodetectCheckbox=document.getElementById("autodetect_checkbox"),this.fowCheckbox=document.getElementById("fow_checkbox"),this.doorCheckbox=document.getElementById("door_checkbox"),this.fowColor=document.getElementById("fow_color"),this.resetButton=document.getElementById("persistence_reset"),this.convertButton=document.getElementById("convert_button"),this.settingsButton=document.getElementById("settings_button"),this.boundryOptions=document.getElementById("boundry_options"),this.debugDiv=document.getElementById("debug_div"),this.debugButton=document.getElementById("debug_button"),this.backgroundButton=document.getElementById("background_button"),this.lockFogButton=document.getElementById("lock_button"),this.unlockFogButton=document.getElementById("unlock_button"),this.toolWidth=document.getElementById("tool_width"),this.toolColor=document.getElementById("tool_color"),this.toolStyle=document.getElementById("tool_style"),this.importButton=document.getElementById("import_button"),this.importFile=document.getElementById("import_file"),this.mapAlign=document.getElementById("map_align"),this.importErrors=document.getElementById("import_errors"),this.dpiAutodetect=document.getElementById("dpi_autodetect"),this.importDpi=document.getElementById("import_dpi"),this.importFormat=document.getElementById("import_format");const e=document.getElementById("playerListing");e.appendChild(this.GetEmptyContextItem());for(const t of S.players){const n=document.createElement("li");n.id=t.id,n.textContent=t.name,n.style.color=t.color,e.appendChild(n)}Je.init()}async SetupPlayerElements(){this.mainWindow.innerHTML=`<div class="title">Configuration via GM.
            <div class="tooltip" id="helpButton" title="Need Help?"></div>
            </div>
            <hr><sub>You must have ownership of a token to see it.</sub></br></br>Tokens Owned By You:<div id="playerOwnedTokens"></div><div id="localStorageWarning"></div>`,await $.action.setHeight(300),await $.action.setWidth(350),this.playerListContainer=document.getElementById("playerOwnedTokens");const e=document.getElementById("helpButton"),t=document.createElement("input");t.classList.add("clickable"),t.src="/help.svg",t.height=15,t.width=15,t.type="image",t.title="Need Help?",t.onclick=async function(){await $.modal.open({id:h.EXTENSIONWHATSNEW,url:"/pages/whatsnew.html?gethelp=true",height:500,width:350})},e.appendChild(t)}GetEmptyContextItem(){const e=document.createElement("li");return e.id=S.userId,e.textContent="Self",e}async BuildUserCache(){const[e,t,n,o,r]=await Promise.all([$.player.getId(),$.player.getName(),$.player.getColor(),$.party.getPlayers(),$.scene.isReady()]);S.userId=e,S.userName=t,S.userColor=n,S.players=o,S.ready=r,await $.scene.setMetadata({[`${h.EXTENSIONID}/USER-${S.userId}`]:{role:S.role,name:S.userName,color:S.userColor}})}async UpdateUI(){const e=S.items.filter(m=>Di(m));let t=!1;la(S.metadata)||(this.visionCheckbox.checked=S.metadata[`${h.EXTENSIONID}/visionEnabled`]==!0,this.autodetectCheckbox.checked=S.metadata[`${h.EXTENSIONID}/autodetectEnabled`]==!0,this.persistenceCheckbox.checked=S.metadata[`${h.EXTENSIONID}/persistenceEnabled`]==!0,this.autodetectCheckbox.checked=S.metadata[`${h.EXTENSIONID}/autodetectEnabled`]==!0,this.fowCheckbox.checked=S.metadata[`${h.EXTENSIONID}/fowEnabled`]==!0,this.doorCheckbox.checked=S.metadata[`${h.EXTENSIONID}/playerDoors`]==!0,this.fowColor.value=S.metadata[`${h.EXTENSIONID}/fowColor`]?S.metadata[`${h.EXTENSIONID}/fowColor`]:"#00000088",t=S.metadata[`${h.EXTENSIONID}/debug`]==!0),this.debugDiv.style.display=t?"grid":"none",this.boundryOptions.style.display=this.autodetectCheckbox.checked?"none":"",this.message.style.display=e.length>0?"none":"block";const n=S.items.filter(m=>m.layer==="FOG"&&m.metadata[`${h.EXTENSIONID}/isBackgroundMap`]===!0),o=document.querySelectorAll(".fog-background-entry");for(const m of o){const y=m.id.slice(3);n.find(N=>N.id===y)===void 0&&m.remove()}for(const m of n)if(!document.querySelector(`#bg-${m.id}`)){const N=document.createElement("div");N.id=`bg-${m.id}`,N.className="fog-background-entry grid-3 grid-main",N.style.width="300",N.innerHTML=`<div class="token-name grid-2">${m.name}</div>
                    <div><label title="Unlock this fog background and turn it back into a map"><input type="button" value="Unlock"></label></div>`,document.querySelector("#fog_background_list").appendChild(N),N.querySelector("input").addEventListener("click",async k=>{if(!k||!k.target)return;const b=k.target.parentElement.parentElement.parentElement.id.slice(3);await $.scene.items.updateItems(P=>P.id===b&&P.layer=="FOG"&&P.metadata[`${h.EXTENSIONID}/isBackgroundMap`]===!0,P=>{for(let O=0;O<P.length;O++)P[O].layer="MAP",P[O].disableHit=!1,P[O].locked=!1,P[O].visible=!0,delete P[O].metadata[`${h.EXTENSIONID}/isBackgroundMap`]})})}const r=document.querySelector("#fog_backgrounds");n.length==0?r.style.display="none":r.style.display="block";const l=document.getElementsByClassName("token-table-entry"),u=[];for(const m of l){const y=m.id.slice(3);e.find(N=>N.id===y)===void 0&&u.push(m)}for(const m of u)m.remove();for(const m of e)ca(m)}UpdatePlayerProcessUI(e){e.every(n=>n.metadata[`${h.EXTENSIONID}/processed`]===!0)?(this.processedIndicator.style.backgroundColor="green",this.processedIndicator.title="Everything looks good."):(this.processedIndicator.style.backgroundColor="red",this.processedIndicator.title="A player is having trouble processing/seeing.")}UpdatePlayerVisionList(e){const t=[];for(const n of e)if(tn(n)&&n.createdUserId===S.userId){const o=n.metadata[`${h.EXTENSIONID}/hasVision`]!==void 0;t.push(`<li>${n.name}${o?"":": <b>Vision Disabled</b>"}</li>`)}t.length===0&&t.push("<li>None found.</li>"),this.playerListContainer.innerHTML=`<ul>${t.join("")}</ul>`}HighlightWhatsNew(){let e=localStorage.getItem(this.version);(e==="false"||!e)&&(this.whatsNewIcon?.classList.add("new-shine"),localStorage.setItem(this.version,"true"))}async SoftReset(e){e==="GM"?(this.SetupGMElements(),_i(),this.UpdatePlayerProcessUI(S.players),await Promise.all([Ni(),Oi(),Si()])):this.SetupPlayerElements(),S.ready&&(await Rn(),await yt(),e=="GM"&&await Mn(this.mapAlign)),e=="GM"&&(Qt(!1),await this.UpdateUI())}async Start(e){await this.BuildUserCache(),e==="GM"?(this.SetupGMElements(),_i(),this.UpdatePlayerProcessUI(S.players),await Promise.all([Ni(),Oi(),Si()]),Ti()):(await this.SetupPlayerElements(),Ti()),S.ready?(await Rn(),await yt(),e=="GM"?await Mn(this.mapAlign):this.UpdatePlayerVisionList(S.items)):e=="GM"&&(Qt(!1),await this.UpdateUI()),rr(),this.HighlightWhatsNew()}}const ne=new Pa("2.3");$.onReady(async()=>{await $.scene.isReady()===!1?setTimeout(async()=>{await ki()},1e3):await ki()});async function ki(){const[i,e]=await Promise.all([$.theme.getTheme(),$.player.getRole()]);S.role=e,Yi(i,document),await ne.Start(S.role)}
